name: TX Engine Autopilot (方案2-安全版·定稿)

on:
  workflow_dispatch:
  push:
    paths:
      - "K線西遊記/kline-taifex/master/台指近全.xlsx"
      - "K線西遊記/kline-engine-public/**"
      - ".github/workflows/engine_autopilot.yml"

permissions:
  contents: write

jobs:
  run-engine:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps
        run: |
          set -e
          python -m pip install -U pip
          if [ -f "K線西遊記/kline-engine-public/requirements.txt" ]; then
            pip install -r "K線西遊記/kline-engine-public/requirements.txt"
          fi

      - name: Restore private engine zip from secret
        env:
          ENGINE_ZIP_B64: ${{ secrets.ENGINE_ZIP_B64 }}
        run: |
          set -euo pipefail
          mkdir -p engine_bin

          if [ -z "${ENGINE_ZIP_B64}" ]; then
            echo "ERROR: secrets.ENGINE_ZIP_B64 is empty"
            exit 1
          fi

          # 去掉所有換行/空白（最常見的 invalid input 原因）
          CLEAN_B64="$(printf '%s' "${ENGINE_ZIP_B64}" | tr -d '\n\r\t ' )"

          # 解碼成 zip
          printf '%s' "${CLEAN_B64}" | base64 --decode > engine_private.zip

          # 解壓縮
          unzip -q engine_private.zip -d engine_bin

          echo "[OK] engine_bin contents:"
          ls -la engine_bin | head -n 200

      - name: Write secret model json (optional)
        env:
          ENGINE_MODEL_B64: ${{ secrets.ENGINE_MODEL_B64 }}
        run: |
          set -euo pipefail
          if [ -n "${ENGINE_MODEL_B64:-}" ]; then
            CLEAN_MODEL="$(printf '%s' "${ENGINE_MODEL_B64}" | tr -d '\n\r\t ' )"
            printf '%s' "${CLEAN_MODEL}" | base64 --decode > engine_bin/_secret_model.json
            echo "[OK] wrote engine_bin/_secret_model.json"
          else
            echo "[SKIP] ENGINE_MODEL_B64 not set"
          fi

      - name: Run engine (public entry)
        run: |
          set -euo pipefail
          python "K線西遊記/kline-engine-public/run_public.py" \
            --master "K線西遊記/kline-taifex/master/台指近全.xlsx" \
            --engine_dir "engine_bin" \
            --outdir "output"

      - name: Commit outputs
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A output || true
          if git diff --cached --quiet; then
            echo "[INFO] No output changes to commit."
            exit 0
          fi

          git commit -m "engine: update outputs"
          git push
