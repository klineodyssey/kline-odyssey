name: TX Engine Autopilot (Release-Asset版・最穩)

on:
  workflow_dispatch:
  push:
    paths:
      - "K線西遊記/kline-taifex/master/台指近全.xlsx"
      - "K線西遊記/kline-engine-public/**"
      - ".github/workflows/engine_autopilot.yml"

permissions:
  contents: write

jobs:
  sanity-check:
    runs-on: ubuntu-latest
    steps:
      - run: echo "Hello"

  run-engine:
    runs-on: ubuntu-latest
    needs: sanity-check

    env:
      # 你 Release 的 tag（你截圖是 engine-v1.0）
      ENGINE_RELEASE_TAG: "engine-v1.0"
      # 你 Release asset 檔名（你截圖就是這個）
      ENGINE_ASSET_NAME: "ENGINE_ZIP_B64.zip"

      MASTER_XLSX: "K線西遊記/kline-taifex/master/台指近全.xlsx"
      ENGINE_DIR: "engine_bin"
      OUTDIR: "output"

      # 可選：模型（建議用「純 JSON」secret，別再用 base64）
      # Settings → Secrets and variables → Actions → New repository secret
      # Name: ENGINE_MODEL_JSON
      ENGINE_MODEL_JSON: ${{ secrets.ENGINE_MODEL_JSON }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps
        run: |
          set -e
          python -m pip install -U pip
          python -m pip install pandas openpyxl

      - name: Download engine zip from GitHub Release asset
        shell: bash
        run: |
          set -euo pipefail

          echo "[info] repo=${GITHUB_REPOSITORY}"
          echo "[info] release tag=${ENGINE_RELEASE_TAG}"
          echo "[info] asset name=${ENGINE_ASSET_NAME}"

          python - <<'PY'
          import json, os, sys, urllib.request

          repo = os.environ["GITHUB_REPOSITORY"]
          tag  = os.environ["ENGINE_RELEASE_TAG"]
          want = os.environ["ENGINE_ASSET_NAME"]

          url = f"https://api.github.com/repos/{repo}/releases/tags/{tag}"
          req = urllib.request.Request(url, headers={
              "Authorization": f"Bearer {os.environ.get('GITHUB_TOKEN','')}",
              "Accept": "application/vnd.github+json",
              "User-Agent": "kline-odyssey-engine-autopilot",
          })
          with urllib.request.urlopen(req) as r:
              data = json.loads(r.read().decode("utf-8"))

          assets = data.get("assets", [])
          hit = None
          for a in assets:
              if a.get("name") == want:
                  hit = a
                  break

          if not hit:
              names = [a.get("name") for a in assets]
              raise SystemExit(f"Asset not found: {want}. Assets={names}")

          # 用 API 的 asset url 才能配合 Accept: application/octet-stream 下載（私有 repo 也穩）
          print(hit["url"])
          PY
          ASSET_API_URL="$(python - <<'PY'
          import json, os, sys, urllib.request
          repo = os.environ["GITHUB_REPOSITORY"]
          tag  = os.environ["ENGINE_RELEASE_TAG"]
          want = os.environ["ENGINE_ASSET_NAME"]
          url = f"https://api.github.com/repos/{repo}/releases/tags/{tag}"
          req = urllib.request.Request(url, headers={
              "Authorization": f"Bearer {os.environ.get('GITHUB_TOKEN','')}",
              "Accept": "application/vnd.github+json",
              "User-Agent": "kline-odyssey-engine-autopilot",
          })
          with urllib.request.urlopen(req) as r:
              data = json.loads(r.read().decode("utf-8"))
          for a in data.get("assets", []):
              if a.get("name") == want:
                  print(a["url"]); sys.exit(0)
          raise SystemExit(1)
          PY
          )"

          echo "[info] asset_api_url=${ASSET_API_URL}"

          curl -L \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/octet-stream" \
            "${ASSET_API_URL}" \
            -o engine.zip

          echo "[info] engine.zip size:"
          ls -lh engine.zip

          rm -rf "${ENGINE_DIR}"
          mkdir -p "${ENGINE_DIR}"
          unzip -q engine.zip -d "${ENGINE_DIR}"

          echo "[info] engine files:"
          find "${ENGINE_DIR}" -maxdepth 3 -type f | sed -n '1,120p'

      - name: Write model json from secret (optional)
        if: ${{ env.ENGINE_MODEL_JSON != '' }}
        shell: bash
        run: |
          set -euo pipefail
          # 寫入引擎資料夾，讓 run_public.py 自己帶入
          echo "${ENGINE_MODEL_JSON}" > "${ENGINE_DIR}/_secret_model.json"
          echo "[info] wrote ${ENGINE_DIR}/_secret_model.json"

      - name: Run engine (public entry)
        shell: bash
        run: |
          set -euo pipefail
          test -f "${MASTER_XLSX}" || (echo "MASTER not found: ${MASTER_XLSX}" && exit 1)

          mkdir -p "${OUTDIR}"

          # 你 repo 內的公開入口 run_public.py（你之前貼的那支）
          python "K線西遊記/kline-engine-public/run_public.py" \
            --master "${MASTER_XLSX}" \
            --engine_dir "${ENGINE_DIR}" \
            --outdir "${OUTDIR}"

      - name: Commit outputs
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "$(git status --porcelain)" ]; then
            echo "[info] no changes"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "engine: update outputs"
          git push
