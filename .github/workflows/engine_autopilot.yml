name: TX Engine Autopilot (方案2-安全版)

on:
  workflow_dispatch:
  push:
    paths:
      - "K線西遊記/kline-taifex/master/台指近全.xlsx"
      - "K線西遊記/kline-engine-public/**"
      - ".github/workflows/engine_autopilot.yml"

permissions:
  contents: write

jobs:
  run-engine:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (on branch, not detached)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps
        run: |
          set -e
          python -m pip install -U pip
          pip install -r "K線西遊記/kline-engine-public/requirements.txt"

      - name: Restore private engine zip from Release (asset)
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          mkdir -p engine_bin

          # 下載 Release 的 asset（檔名要完全一致）
          # 這裡用 GitHub API 找最新 release 的 asset download url
          api="https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/latest"
          asset_url=$(curl -s -H "Authorization: Bearer ${GITHUB_TOKEN}" \
                           -H "Accept: application/vnd.github+json" \
                           "$api" | \
                     python - <<'PY'
          import json,sys
          j=json.load(sys.stdin)
          name="ENGINE_ZIP_B64.zip"
          for a in j.get("assets",[]):
          if a.get("name")==name:
          print(a.get("url",""))
          sys.exit(0)
          print("")
          sys.exit(0)
          PY
          )

          if [ -z "$asset_url" ]; then
            echo "ERROR: cannot find asset ENGINE_ZIP_B64.zip in latest release"
            exit 1
          fi

          echo "asset_url=$asset_url"

          # GitHub asset download needs Accept: application/octet-stream
          curl -L -H "Authorization: Bearer ${GITHUB_TOKEN}" \
                 -H "Accept: application/octet-stream" \
                 "$asset_url" -o engine_bin/engine.zip

          unzip -o engine_bin/engine.zip -d engine_bin

          echo "=== engine_bin ==="
          ls -al engine_bin   

      - name: Run engine (public entry)
        shell: bash
        env:
          KLINE_ENGINE_KEY: ${{ secrets.KLINE_ENGINE_KEY }}
          ENGINE_MODEL_B64: ${{ secrets.ENGINE_MODEL_B64 }}
        run: |
          set -e
          MASTER="K線西遊記/kline-taifex/master/台指近全.xlsx"
          if [ ! -f "$MASTER" ]; then
            echo "MASTER not found: $MASTER"
            exit 1
          fi

          python "K線西遊記/kline-engine-public/run_public.py" \
            --master "$MASTER" \
            --engine_dir "engine_bin" \
            --outdir "K線西遊記/kline-engine-public/output"

      - name: Commit outputs (fix detached HEAD push)
        shell: bash
        run: |
          set -e
          BRANCH="${GITHUB_REF_NAME}"

          git config user.name "kline-bot"
          git config user.email "bot@kline.odyssey"

          git add "K線西遊記/kline-engine-public/output" || true

          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi

          git commit -m "auto: engine output update"
          git push origin "HEAD:${BRANCH}"
