name: TX Engine Autopilot

on:
  push:
    paths:
      - "Kç·šè¥¿éŠè¨˜/kline-taifex/master/å°æŒ‡è¿‘å…¨.xlsx"
      - ".github/workflows/engine_autopilot.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-engine:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy openpyxl

      - name: Download engine zip from GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p engine_bin
          gh release download --repo ${{ github.repository }} \
            --pattern "ENGINE_ZIP_B64.zip" \
            --output engine_bin/ENGINE_ZIP_B64.zip

      - name: Unzip engine
        run: |
          cd engine_bin
          unzip -o ENGINE_ZIP_B64.zip

      # ğŸ”¥ é—œéµä¿®å¾©ï¼šå¼·åˆ¶ç§»é™¤ UTF-8 BOM
      - name: Force remove all UTF-8 BOM
  run: |
    python - << 'EOF'
    from pathlib import Path

    p = Path("engine_bin/Kç·šè¥¿éŠè¨˜_Tplus1_pm500_step1_å¤šç©ºé‹ç®—_V3.4.3_UTF8_NO_BOM.py")
    data = p.read_bytes()

    # ç§»é™¤æ‰€æœ‰ UTF-8 BOM (EF BB BF)
    cleaned = data.replace(b'\xef\xbb\xbf', b'')

    p.write_bytes(cleaned)
    print("BOM fully removed")
    EOF

      - name: Run engine (public entry)
        run: |
          python engine_bin/Kç·šè¥¿éŠè¨˜_Tplus1_pm500_step1_å¤šç©ºé‹ç®—_V3.4.3_UTF8_NO_BOM.py \
            --input Kç·šè¥¿éŠè¨˜/kline-taifex/master/å°æŒ‡è¿‘å…¨.xlsx \
            --outdir Kç·šè¥¿éŠè¨˜/kline-engine-public/output

      - name: Commit outputs
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add Kç·šè¥¿éŠè¨˜/kline-engine-public/output || true
          git commit -m "engine: auto run result" || true
          git push
