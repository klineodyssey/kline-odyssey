name: TX Engine Autopilot (Release Latest - Stable)

on:
  workflow_dispatch:
  push:
    paths:
      - "K線西遊記/kline-taifex/master/台指近全.xlsx"
      - "K線西遊記/kline-engine-public/**"
      - ".github/workflows/engine_autopilot.yml"

permissions:
  contents: write

jobs:
  run-engine:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps
        run: |
          set -e
          python -m pip install -U pip
          pip install -r "K線西遊記/kline-engine-public/requirements.txt"

      - name: Prepare engine_bin from latest release asset
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: klineodyssey
          REPO: kline-odyssey
          ASSET_NAME: ENGINE_ZIP_B64.zip
        run: |
          set -euo pipefail
          rm -rf engine_bin
          mkdir -p engine_bin

          python - <<'PY'
          import os, json, urllib.request

          owner=os.environ["OWNER"]
          repo=os.environ["REPO"]
          asset_name=os.environ["ASSET_NAME"]
          token=os.environ.get("GITHUB_TOKEN","")

          api=f"https://api.github.com/repos/{owner}/{repo}/releases/latest"
          req=urllib.request.Request(api, headers={
              "Accept":"application/vnd.github+json",
              **({"Authorization": f"Bearer {token}"} if token else {})
          })
          with urllib.request.urlopen(req) as r:
              data=json.load(r)

          assets=data.get("assets",[])
          url=None
          for a in assets:
              if a.get("name")==asset_name:
                  url=a.get("url")
                  break

          if not url:
              raise SystemExit(f"asset not found in latest release: {asset_name}")

          open("asset_api_url.txt","w",encoding="utf-8").write(url)
          print("[prep] ok: asset_api_url.txt written")
          PY

          ASSET_API_URL="$(cat asset_api_url.txt)"
          curl -L \
            -H "Accept: application/octet-stream" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            "${ASSET_API_URL}" \
            -o engine_asset.zip

          unzip -o engine_asset.zip -d engine_bin

      - name: Debug list (make sure engine exists)
        shell: bash
        run: |
          set -e
          echo "[debug] engine_bin tree:"
          find engine_bin -maxdepth 3 -type f | sed 's/^/ - /'

      # ✅ 最終穩定：清 BOM / 清 U+FEFF / 轉 CRLF->LF / 修「前導縮排」Tab & NBSP
      - name: Sanitize engine .py (BOM/U+FEFF/CRLF/TAB/NBSP)
        shell: bash
        run: |
          set -e
          python - <<'PY'
          from pathlib import Path

          root = Path("engine_bin")
          total = 0
          changed = 0

          def fix_leading_ws(line: str) -> str:
              # 只修「前導空白」：TAB->4空白、NBSP->空白
              i = 0
              while i < len(line) and line[i] in (" ", "\t", "\u00a0", "\ufeff"):
                  i += 1
              lead = line[:i]
              rest = line[i:]
              lead = lead.replace("\ufeff", "")
              lead = lead.replace("\u00a0", " ")
              lead = lead.replace("\t", "    ")
              return lead + rest

          for f in root.rglob("*.py"):
              total += 1
              b = f.read_bytes()

              # 1) 去檔頭 BOM
              if b          git add "K線西遊記/kline-engine-public/output" || true

          if git diff --cached
