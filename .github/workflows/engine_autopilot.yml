name: TX Engine Autopilot (Release Latest - Stable)

on:
  workflow_dispatch:
  push:
    paths:
      - "K線西遊記/kline-taifex/master/台指近全.xlsx"
      - "K線西遊記/kline-engine-public/**"
      - ".github/workflows/engine_autopilot.yml"

permissions:
  contents: write

jobs:
  run-engine:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip
          pip install -r "K線西遊記/kline-engine-public/requirements.txt"
          pip install matplotlib

      - name: Prepare engine_bin from ENGINE_ZIP_B64
        shell: bash
        env:
          ENGINE_ZIP_B64: ${{ secrets.ENGINE_ZIP_B64 }}
        run: |
          set -euo pipefail
          test -n "${ENGINE_ZIP_B64}" || (echo "Missing secret: ENGINE_ZIP_B64" && exit 1)
          echo "${ENGINE_ZIP_B64}" | base64 -d > engine.zip
          unzip -o engine.zip -d .
          test -d "engine_bin" || (echo "engine_bin not found after unzip" && ls -la && exit 1)
          ls -la engine_bin

      - name: Debug list (make sure master exists)
        shell: bash
        run: |
          set -euo pipefail
          ls -la "K線西遊記/kline-taifex/master" || true
          test -f "K線西遊記/kline-taifex/master/台指近全.xlsx" || (echo "MASTER missing" && exit 1)

      - name: Run public entry
        shell: bash
        env:
          MASTER_XLSX: "K線西遊記/kline-taifex/master/台指近全.xlsx"
          ENGINE_DIR: "engine_bin"
          OUTDIR: "K線西遊記/kline-engine-public/output"
        run: |
          set -euo pipefail
          mkdir -p "${OUTDIR}"
          python "K線西遊記/kline-engine-public/run_public.py" \
            --master "${MASTER_XLSX}" \
            --engine_dir "${ENGINE_DIR}" \
            --outdir "${OUTDIR}"

      - name: Commit outputs
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "K線西遊記/kline-engine-public/output" || true

          if git diff --cached --quiet; then
            echo "No output changes to commit."
            exit 0
          fi

          git commit -m "chore(engine): update outputs"
          git push
