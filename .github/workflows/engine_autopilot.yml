name: TX Engine Autopilot (方案2-安全版)

on:
  workflow_dispatch:
  push:
    paths:
      - "K線西遊記/kline-taifex/master/台指近全.xlsx"
      - "K線西遊記/kline-engine-public/**"
      - ".github/workflows/engine_autopilot.yml"

permissions:
  contents: write

jobs:
  run-engine:
    runs-on: ubuntu-latest

    # 防呆 1：避免 bot 自己 commit output 後又觸發（或你未來把 output 加進 paths）
    # 防呆 2：避免同一個 commit message 循環
    if: |
      github.actor != 'github-actions[bot]' &&
      !contains(github.event.head_commit.message, 'auto: engine output update')

    steps:
      - name: Checkout (on branch, not detached)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps
        run: |
          set -e
          python -m pip install -U pip
          pip install -r "K線西遊記/kline-engine-public/requirements.txt"

      # 方案2：核心引擎不進 repo，放在 Secrets（Base64）
      - name: Restore private engine zip from secret
        shell: bash
        env:
          ENGINE_ZIP_B64: ${{ secrets.ENGINE_ZIP_B64 }}
        run: |
          set -e
          if [ -z "$ENGINE_ZIP_B64" ]; then
            echo "ENGINE_ZIP_B64 is empty. Please set repo secret ENGINE_ZIP_B64."
            exit 1
          fi
          mkdir -p engine_bin
          echo "$ENGINE_ZIP_B64" | base64 -d > engine_bin/engine.zip
          unzip -o engine_bin/engine.zip -d engine_bin
          echo "=== engine_bin ==="
          ls -al engine_bin

      - name: Run engine (public entry)
        shell: bash
        env:
          KLINE_ENGINE_KEY: ${{ secrets.KLINE_ENGINE_KEY }}
          ENGINE_MODEL_B64: ${{ secrets.ENGINE_MODEL_B64 }}
        run: |
          set -e
          MASTER="K線西遊記/kline-taifex/master/台指近全.xlsx"
          OUTDIR="K線西遊記/kline-engine-public/output"

          if [ ! -f "$MASTER" ]; then
            echo "MASTER not found: $MASTER"
            exit 1
          fi

          mkdir -p "$OUTDIR"

          python "K線西遊記/kline-engine-public/run_public.py" \
            --master "$MASTER" \
            --engine_dir "engine_bin" \
            --outdir "$OUTDIR"

      - name: Commit outputs
        shell: bash
        run: |
          set -e
          BRANCH="${GITHUB_REF_NAME}"

          git config user.name "kline-bot"
          git config user.email "bot@kline.odyssey"

          # 只 add output，避免把不該 commit 的東西推上去
          git add "K線西遊記/kline-engine-public/output" || true

          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi

          git commit -m "auto: engine output update"
          git push origin "HEAD:${BRANCH}"
