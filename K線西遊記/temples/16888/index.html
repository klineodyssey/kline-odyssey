<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>å»£å¯’å®® 16888ï½œä¸ƒä»™å¥³é£›ç¢Ÿé§•é§›è‰™ V1.5ï¼ˆå³æ™‚ç©å®¶è§¸ç™¼ï¼‰</title>

  <!-- å»ºè­°ï¼šæŠŠ ethers-5.7.2.umd.min.js æ”¾åœ¨åŒè³‡æ–™å¤¾ /assets çš†å¯ã€‚ -->
  <script src="../../assets/ethers-5.7.2.umd.min.js"></script>

  <style>
    :root{
      --bg:#06070b;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --line: rgba(255,255,255,.14);
      --gold: rgba(255,215,120,.95);
      --pink: rgba(255,170,220,.95);
      --cyan: rgba(120,255,220,.95);
      --shadow: 0 16px 70px rgba(0,0,0,.60);
      --r: 18px;
      --r2: 999px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Heiti TC", Arial, sans-serif;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(1200px 800px at 30% 20%, rgba(120,170,255,.10), transparent 60%),
        radial-gradient(1000px 700px at 70% 60%, rgba(255,160,220,.08), transparent 55%),
        var(--bg);
      color: var(--text);
      min-height:100vh;
      overflow-x:hidden;
    }
    a{color:inherit}

    /* ===== Top Right Quick ===== */
    .topRight{
      position:fixed; right:12px; top:calc(12px + var(--safe-top)); z-index:90;
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 12px; border:1px solid var(--line);
      border-radius: var(--r2);
      background: rgba(0,0,0,.38);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      font-size:12px; color: var(--text);
      text-decoration:none; font-weight:850;
      user-select:none; cursor:pointer;
    }
    .pill:hover{ background: rgba(255,255,255,.10); }
    .pill b{font-family:var(--mono); font-weight:900}
    .pill.gold{ border-color: rgba(255,215,120,.32); }
    .pill.cyan{ border-color: rgba(120,255,220,.30); }

    .wrap{ max-width:1100px; margin:0 auto; padding:16px 14px calc(120px + var(--safe-bottom)); }
    header{
      padding-top: 54px;
      display:flex; gap:14px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap;
    }
    .brand .h{ font-weight:950; letter-spacing:.6px; font-size:18px; }
    .brand .s{ font-size:12px; color: var(--muted); line-height:1.55; margin-top:6px; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .badge.ok{ border-color: rgba(120,255,220,.30); color: rgba(170,255,230,.95); }
    .badge.warn{ border-color: rgba(255,210,120,.30); color: rgba(255,230,170,.95); }
    .badge.bad{ border-color: rgba(255,120,120,.30); color: rgba(255,180,190,.95); }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:12px;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      border:1px solid var(--line);
      border-radius: 24px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .cardHead .t{ font-weight:950; letter-spacing:.35px; }
    .cardHead .sub{ color: var(--muted); font-size:12px; }
    .cardBody{ padding:14px; }

    /* ===== Cockpit Core ===== */
    .cockpit{
      position:relative;
      min-height: 520px;
      background: radial-gradient(900px 600px at 50% 25%, rgba(255,170,220,.11), transparent 65%),
                  radial-gradient(900px 600px at 65% 60%, rgba(120,255,220,.08), transparent 60%);
    }
    canvas#fx{
      position:absolute; inset:0;
      width:100%; height:100%;
      pointer-events:none;
      opacity:.95;
    }
    .cockpitGrid{
      position:relative;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width:760px){ .cockpitGrid{ grid-template-columns:1fr; } }

    /* ===== Fairy Wheel ===== */
    .fairyWrap{
      position:relative;
      width: 280px;
      height: 280px;
      margin: 4px auto 0;
      border-radius: 50%;
      overflow:hidden;
      border:1px solid rgba(255,215,120,.25);
      box-shadow:
        0 0 42px rgba(255,170,220,.22),
        0 0 70px rgba(120,255,220,.12);
      background: rgba(0,0,0,.25);
      transform: translateZ(0);
    }
    .fairyWrap::before{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,215,120,.55), transparent 45%),
                  radial-gradient(circle at 70% 70%, rgba(255,170,220,.45), transparent 45%),
                  radial-gradient(circle at 50% 50%, rgba(120,255,220,.20), transparent 55%);
      filter: blur(10px);
      opacity: .55;
      animation: auraSpin 10s linear infinite;
      pointer-events:none;
    }
    @keyframes auraSpin{ from{ transform: rotate(0deg);} to{ transform: rotate(360deg);} }

    img#fairy{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      transform-origin: 50% 50%;
      will-change: transform, filter;
      transition: transform .45s ease, filter .45s ease;
      filter: saturate(1.05) contrast(1.02);
    }

    /* Sleep overlay */
    .sleepMask{
      position:absolute; inset:0;
      display:grid; place-items:center;
      pointer-events:none;
      opacity:0;
      transition: opacity .35s ease;
      background: radial-gradient(circle at 50% 55%, rgba(0,0,0,.08), rgba(0,0,0,.55));
      backdrop-filter: blur(2px);
    }
    .sleepMask.on{ opacity:1; }
    .sleepText{
      text-align:center;
      font-weight:950;
      letter-spacing:.8px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 0 30px rgba(255,215,120,.18);
    }
    .sleepText .z{
      font-family: var(--mono);
      color: rgba(255,215,120,.95);
      font-size: 16px;
      margin-bottom:6px;
    }
    .sleepText .s{
      font-size: 12px;
      color: var(--muted);
      margin-top:6px;
      line-height:1.55;
    }

    /* ===== Controls ===== */
    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
      margin-top:12px;
    }
    @media (max-width:520px){ .kpiGrid{ grid-template-columns:1fr; } }

    .kpi{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      padding:12px;
    }
    .kpi .k{ font-size:12px; color: var(--muted); }
    .kpi .v{ font-size:18px; font-weight:950; letter-spacing:.4px; margin-top:6px; }
    .kpi .v .mono{ font-family: var(--mono); }
    .kpi .hint{ font-size:12px; color: var(--muted); margin-top:6px; line-height:1.45; }

    .rangeRow{ margin-top:12px; }
    .rangeRow label{ display:flex; justify-content:space-between; gap:10px; align-items:center; font-size:12px; color: var(--muted); }
    input[type="range"]{ width:100%; margin-top:8px; }
    input[type="number"], input[type="text"], textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color: var(--text);
      padding:10px 12px;
      outline:none;
    }
    textarea{ min-height:84px; resize:vertical; }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.13); }
    .btn.gold{ border-color: rgba(255,215,120,.28); }
    .btn.cyan{ border-color: rgba(120,255,220,.26); }
    .btn.bad{ border-color: rgba(255,120,120,.26); }

    /* ===== Camera / Photo ===== */
    .cameraBox{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      padding:12px;
      overflow:hidden;
    }
    video#cam{
      width:100%;
      border-radius: 14px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
    }
    canvas#snap{
      width:100%;
      border-radius: 14px;
      display:none;
      border:1px solid rgba(255,255,255,.10);
    }

    /* ===== Log ===== */
    .log{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      background: rgba(0,0,0,.22);
      padding:10px 12px;
      font-family: var(--mono);
      font-size: 11px;
      line-height: 1.55;
      max-height: 220px;
      overflow:auto;
      white-space: pre-wrap;
    }

    /* ===== Sticky bottom ===== */
    .sticky{
      position:fixed; left:0; right:0; bottom:0; z-index:95;
      padding:10px 12px calc(10px + var(--safe-bottom));
      background: linear-gradient(to top, rgba(6,7,11,.96), rgba(6,7,11,.55));
      border-top:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
    }
    .sticky .row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:center; }
    .sticky .row .left{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .sticky .row .right{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .toast{
      position:fixed; left:12px; bottom: calc(72px + var(--safe-bottom)); z-index:999;
      background: rgba(0,0,0,.78);
      border:1px solid rgba(255,255,255,.16);
      border-radius: 14px;
      padding:10px 12px;
      box-shadow: var(--shadow);
      font-size: 12px;
      display:none;
      max-width: min(520px, calc(100vw - 24px));
      backdrop-filter: blur(10px);
    }

    /* subtle breathing for whole cockpit when rest */
    .breath{
      animation: breath 3.4s ease-in-out infinite;
    }
    @keyframes breath{
      0%{ transform: scale(1.000); }
      50%{ transform: scale(1.012); }
      100%{ transform: scale(1.000); }
    }
  </style>
</head>

<body>
  <div class="topRight">
    <a class="pill gold" href="https://klineodyssey.github.io/kline-odyssey/" target="_blank" rel="noreferrer">ğŸŒ å®˜ç¶²</a>
    <a class="pill cyan" href="../../index.html" rel="noreferrer">ğŸ—ºï¸ å®‡å®™å…¥å£</a>
    <div class="pill">ç‰ˆæœ¬ï¼š<b>16888 V1.5</b></div>
  </div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="h">å»£å¯’å®® 16888ï½œä¸ƒä»™å¥³é£›ç¢Ÿé§•é§›è‰™</div>
        <div class="s">
          è§’åº¦å€é–“ï¼š<b>350â€“10 ä¼‘æ¯</b>ï½œ<b>10â€“170 å¤š</b>ï½œ<b>170â€“190 ä¼‘æ¯</b>ï½œ<b>190â€“350 ç©º</b><br/>
          æ›²é€Ÿï¼š<b>1â€“150</b>ï¼ˆ1 = å…‰é€Ÿä¸€å€ï¼Œ150 = æ›²é€Ÿä¸€ç™¾äº”åå€ï¼‰ï½œå³æ™‚ç©å®¶è§¸ç™¼ï¼šæœ‰äººç©å°±æœ‰ç¯€å¾‹ã€‚
        </div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end">
        <span class="badge" id="modeBadge">ç‹€æ…‹ï¼šåµæ¸¬ä¸­</span>
        <span class="badge">éŒ¢åŒ…ï¼š<span class="mono" id="wallet">æœªé€£ç·š</span></span>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Cockpit -->
      <section class="card">
        <div class="cardHead">
          <div>
            <div class="t">é£›ç¢Ÿé§•é§›è‰™ï¼ˆV1.5 ç‰¹æ•ˆï¼‰</div>
            <div class="sub">å¤šï¼šé‡‘å…‰ç²’å­æµï½œç©ºï¼šæ˜Ÿå¡µå€’æµï½œä¼‘æ¯ï¼šå‘¼å¸ + ç¡çœ ç½©</div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <span class="badge">æ–¹å‘ç›¤ï¼š<b class="mono" id="degText">120</b>Â°</span>
            <span class="badge">æ›²é€Ÿï¼š<b class="mono" id="warpText">10</b>x</span>
          </div>
        </div>

        <div class="cardBody cockpit" id="cockpit">
          <canvas id="fx"></canvas>

          <div class="cockpitGrid">
            <div>
              <div class="fairyWrap" id="fairyWrap">
                <img id="fairy" src="./assets/fairy.png" alt="fairy" />
                <div class="sleepMask" id="sleepMask">
                  <div class="sleepText">
                    <div class="z">Z Z Z</div>
                    <div>ä¼‘æ¯ä¸­</div>
                    <div class="s">è§€æœ›ï½œç¡è¦ºï½œç­‰ä¸‹ä¸€ä½ç©å®¶è§¸ç™¼</div>
                  </div>
                </div>
              </div>

              <div class="kpiGrid">
                <div class="kpi">
                  <div class="k">å§¿æ…‹</div>
                  <div class="v" id="stance">â€”</div>
                  <div class="hint">å¤šï¼šé¢æœå‰ï½œç©ºï¼šè½‰å‘é§•é§›åº§ï½œä¼‘æ¯ï¼šç¡è¦º</div>
                </div>
                <div class="kpi">
                  <div class="k">å¼•æ“äº®åº¦ï¼ˆç”±æ›²é€Ÿæ±ºå®šï¼‰</div>
                  <div class="v"><span class="mono" id="glow">â€”</span></div>
                  <div class="hint">æ›²é€Ÿè¶Šé«˜ï¼Œä»™å¥³å…‰æšˆè¶Šå¼·ï¼ˆä¸é™ç´šï¼‰</div>
                </div>
              </div>
            </div>

            <div>
              <div class="rangeRow">
                <label>
                  <span>æ–¹å‘ç›¤ï¼ˆ0â€“360ï¼‰</span>
                  <span class="mono" id="degLabel">120Â°</span>
                </label>
                <input id="degRange" type="range" min="0" max="360" value="120" />
              </div>

              <div class="rangeRow">
                <label>
                  <span>æ›²é€Ÿå¼•æ“ï¼ˆ1â€“150ï¼‰</span>
                  <span class="mono" id="warpLabel">10x</span>
                </label>
                <input id="warpRange" type="range" min="1" max="150" value="10" />
              </div>

              <div class="kpiGrid">
                <div class="kpi">
                  <div class="k">è³ªé‡ mï¼ˆKGENï¼‰</div>
                  <div class="v"><span class="mono" id="massText">100</span></div>
                  <div class="hint">1 KGEN = 1 é» = 1 æ–¤ = 1 å£ï¼ˆè·¨å¸‚å ´é€šç”¨ï¼‰</div>
                </div>
                <div class="kpi">
                  <div class="k">èƒ½é‡ E = m cÂ²ï¼ˆè¦–è¦ºåŒ–ï¼‰</div>
                  <div class="v"><span class="mono" id="energyText">â€”</span></div>
                  <div class="hint">æ›²é€Ÿè¦–ç‚º c å€ç‡ï¼ˆéŠæˆ²èƒ½é‡è¡¨å¾µï¼‰</div>
                </div>
              </div>

              <div style="margin-top:12px;">
                <label class="badge">ç©å®¶ç•™è¨€ï¼ˆè¨±é¡˜å£ä»¤ / å®¢æœå‚™è¨»ï¼‰</label>
                <textarea id="wish" placeholder="ä¾‹å¦‚ï¼šå·§ä»™ãƒ»äº‹æ¥­é‹é€šãƒ»æˆ‘é¡˜ç”¨ 100 KGEN è§¸ç™¼å®‡å®™â€¦"></textarea>
              </div>

              <div class="btnRow">
                <button class="btn gold" id="btnTrigger">å³æ™‚è§¸ç™¼ï¼ˆç©å®¶é»ç«ï¼‰</button>
                <button class="btn cyan" id="btnConnect">é€£æ¥éŒ¢åŒ…</button>
                <button class="btn" id="btnSpeak">èªéŸ³å°è¦½</button>
                <button class="btn bad" id="btnClear">æ¸…ç©ºç‹€æ…‹</button>
              </div>

              <div class="log" id="log" style="margin-top:12px;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: Camera + Guide -->
      <section class="card">
        <div class="cardHead">
          <div>
            <div class="t">æ‹ç…§ï½œå½±åƒï½œç•™å¿µï¼ˆå…ˆåšæœ¬æ©Ÿï¼‰</div>
            <div class="sub">ç›¸æ©Ÿå¯ç”¨å°±è®“ç©å®¶çœ‹åˆ°è‡ªå·±ï¼ˆç¥æ®¿é…å‚™ï¼‰</div>
          </div>
          <div class="badge">AI å®¢æœï¼š<span class="mono" id="aiState">READY</span></div>
        </div>

        <div class="cardBody">
          <div class="cameraBox">
            <video id="cam" autoplay playsinline muted></video>
            <canvas id="snap"></canvas>
            <div class="btnRow" style="margin-top:10px;">
              <button class="btn" id="btnCam">é–‹å•Ÿç›¸æ©Ÿ</button>
              <button class="btn" id="btnShot">æ‹ç…§</button>
              <button class="btn cyan" id="btnDownload">ä¸‹è¼‰ç…§ç‰‡</button>
            </div>
            <div class="small" style="margin-top:8px;color:var(--muted);font-size:12px;line-height:1.55;">
              è‹¥ç€è¦½å™¨é™åˆ¶ç›¸æ©Ÿ/èªéŸ³ï¼Œç³»çµ±æœƒè‡ªå‹•æ”¹æˆæ–‡å­—å®¢æœï¼Œä¸æœƒç•¶æ©Ÿã€‚
            </div>
          </div>

          <div style="margin-top:12px;">
            <div class="badge warn">æ–°æ‰‹å®¢æœï¼ˆç„¡éŒ¢åŒ…æ™‚ï¼‰</div>
            <div class="small" style="margin-top:8px;">
              1) å…ˆå®‰è£ MetaMaskï¼ˆBSC / chainId 56ï¼‰ã€‚<br/>
              2) éŒ¢åŒ…æº–å‚™å°‘é‡ BNB ç•¶ gasã€‚<br/>
              3) æŒ‰ã€Œé€£æ¥éŒ¢åŒ…ã€ã€‚<br/>
              4) å†æŒ‰ã€Œå³æ™‚è§¸ç™¼ã€é€²å…¥éŠæˆ²ç¯€å¾‹ã€‚<br/>
              5) ä¹‹å¾Œæ‰æœƒæ¥ä¸Šéˆä¸Šè¨±é¡˜æ± èˆ‡çµç®—åˆç´„ã€‚
            </div>
          </div>

          <div style="margin-top:12px;">
            <div class="badge">å®‡å®™å…¬å¼ï¼ˆéŠæˆ²è¦å‰‡ï¼‰</div>
            <div class="small" style="margin-top:8px;">
              m = KGENï½œE = m cÂ²ï½œW = m g hï¼ˆh = CT ç¾åƒ¹é«˜åº¦ï¼‰<br/>
              é»‘æ´èƒ½é‡å®ˆæ†ï¼šm å°ï¼Œh å¤§ï¼ˆé«˜åƒ¹ä½é«˜èƒ½é‡ï¼‰ã€‚
            </div>
          </div>

          <div style="margin-top:14px;color:var(--muted);font-size:12px;line-height:1.6;">
            PrimeForge ä»¥æ¯æ©Ÿä¹‹åï¼Œé–‹å•Ÿé‡‘èç”Ÿå‘½ã€‚<br/>
            èŠ±æœå±±å°ç£ãƒ»ä¿¡å¿µä¸æ»…ãƒ»å¸‚å ´ç„¡ç•Œã€‚<br/>
            Where the Market Becomes the Myth.<br/>
            â€”â€” æ¨‚å¤©å¸ âŒ–
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="sticky">
    <div class="row">
      <div class="left">
        <span class="badge">å³æ™‚ç©å®¶ï¼š<b class="mono" id="players">0</b></span>
        <span class="badge">æœ¬æ©Ÿç¯€å¾‹ï¼š<b class="mono" id="clock">--:--:--</b></span>
      </div>
      <div class="right">
        <input id="massInput" type="number" min="1" step="1" value="100" style="width:140px" />
        <span class="badge">mï¼ˆKGENï¼‰</span>
      </div>
    </div>
  </div>

<script>
/* =========================================
   16888 Fairy UFO Cockpit V1.5
   - Particle engine: long = forward gold stream, short = backward stardust
   - Rest: breathing + sleep mask
   - Warp affects glow + particle speed/intensity
   - Player-trigger: local instant mode (can later be wired to on-chain events)
   ========================================= */

const CFG = {
  stanceRanges: {
    rest1: [350, 360],
    rest1b: [0, 10],
    long: [10, 170],
    rest2: [170, 190],
    short: [190, 350]
  },
  voice: {
    enabled: true,
    lang: "zh-TW"
  }
};

const $ = (id)=>document.getElementById(id);
const logEl = $("log");
const toastEl = $("toast");

function nowStr(){
  const d=new Date();
  const pad=(n)=>String(n).padStart(2,"0");
  return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
setInterval(()=>{ $("clock").textContent = nowStr(); }, 250);

function log(msg){
  const line = `[${nowStr()}] ${msg}\n`;
  logEl.textContent = (line + logEl.textContent).slice(0, 5000);
}

function toast(msg){
  toastEl.textContent = msg;
  toastEl.style.display = "block";
  clearTimeout(window.__t);
  window.__t = setTimeout(()=>toastEl.style.display="none", 2400);
}

function inRange(angle, a, b){
  // inclusive, a<=angle<=b, angle already normalized 0..360
  return angle >= a && angle <= b;
}

function stanceOf(angle){
  if(inRange(angle, CFG.stanceRanges.rest1[0], CFG.stanceRanges.rest1[1]) || inRange(angle, CFG.stanceRanges.rest1b[0], CFG.stanceRanges.rest1b[1])) return "REST";
  if(inRange(angle, CFG.stanceRanges.long[0], CFG.stanceRanges.long[1])) return "LONG";
  if(inRange(angle, CFG.stanceRanges.rest2[0], CFG.stanceRanges.rest2[1])) return "REST";
  if(inRange(angle, CFG.stanceRanges.short[0], CFG.stanceRanges.short[1])) return "SHORT";
  return "REST";
}

function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function normAngle(a){
  let x = a % 360;
  if(x < 0) x += 360;
  return x;
}

let STATE = {
  deg: 120,
  warp: 10,
  players: 0,
  wallet: "",
  lastTriggerAt: 0
};

function computeEnergy(m, warp){
  // visual model: E = m * (warp^2)
  const E = m * (warp*warp);
  return E;
}

function applyUI(){
  const a = normAngle(STATE.deg);
  const warp = clamp(STATE.warp, 1, 150);
  const s = stanceOf(a);

  $("degText").textContent = String(a);
  $("degLabel").textContent = `${a}Â°`;
  $("warpText").textContent = String(warp);
  $("warpLabel").textContent = `${warp}x`;

  const m = clamp(Number($("massInput").value || 100), 1, 999999999);
  $("massText").textContent = String(m);
  $("energyText").textContent = String(computeEnergy(m, warp));

  // stance label
  let stanceText = "è§€æœ›";
  if(s==="LONG") stanceText = "å¤šï½œä»™å¥³é¢æœå‰ï¼ˆå¾€å‰é£›ï¼‰";
  else if(s==="SHORT") stanceText = "ç©ºï½œä»™å¥³è½‰å‘é§•é§›åº§ï¼ˆå›é ­é£›ï¼‰";
  else stanceText = "ä¼‘æ¯ï½œç¡è¦ºï¼ˆå·¦å³çš†è§€æœ›ï¼‰";
  $("stance").textContent = stanceText;

  // mode badge
  if(s==="LONG") $("modeBadge").className="badge ok";
  else if(s==="SHORT") $("modeBadge").className="badge bad";
  else $("modeBadge").className="badge warn";
  $("modeBadge").textContent = `ç‹€æ…‹ï¼š${s}`;

  // fairy rotation + glow
  const img = $("fairy");
  const sleep = $("sleepMask");
  const cockpit = $("cockpit");
  const glow = (warp/150);
  const glowText = `${Math.round(glow*100)}%`;
  $("glow").textContent = glowText;

  // Brightness is warp-driven, plus stance tint
  const baseSat = 1.02 + glow*0.18;
  const baseBright = 1.00 + glow*0.30;
  const baseContrast = 1.02 + glow*0.08;

  // rotate factor subtle
  const k = 0.35;
  if(s==="LONG"){
    sleep.classList.remove("on");
    cockpit.classList.remove("breath");
    img.style.transform = `rotate(${a*k}deg) scale(1.02)`;
    img.style.filter = `saturate(${baseSat}) brightness(${baseBright}) contrast(${baseContrast}) drop-shadow(0 0 ${18+glow*26}px rgba(255,215,120,.35))`;
  }else if(s==="SHORT"){
    sleep.classList.remove("on");
    cockpit.classList.remove("breath");
    img.style.transform = `rotate(${-(a-180)*k}deg) scale(1.02)`;
    img.style.filter = `saturate(${baseSat}) brightness(${baseBright}) contrast(${baseContrast}) drop-shadow(0 0 ${18+glow*26}px rgba(120,255,220,.30))`;
  }else{
    sleep.classList.add("on");
    cockpit.classList.add("breath");
    img.style.transform = `rotate(0deg) scale(1.00)`;
    img.style.filter = `saturate(${baseSat}) brightness(${1.00+glow*0.12}) contrast(${baseContrast}) drop-shadow(0 0 ${14+glow*18}px rgba(255,170,220,.18))`;
  }

  // drive particle engine
  FX.setMode(s, warp);
}

/* ===== Voice (auto speak on enter) ===== */
function canSpeak(){
  return !!window.speechSynthesis && typeof SpeechSynthesisUtterance !== "undefined";
}
function speak(text){
  if(!CFG.voice.enabled) return;
  if(!canSpeak()) return;
  try{
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = CFG.voice.lang;
    u.rate = 1.02;
    u.pitch = 1.02;
    window.speechSynthesis.speak(u);
  }catch(e){}
}

/* ===== Wallet connect (optional now) ===== */
async function connectWallet(){
  if(!window.ethereum) throw new Error("æœªåµæ¸¬åˆ°éŒ¢åŒ…ï¼ˆè«‹å®‰è£ MetaMaskï¼‰");
  const p = new ethers.providers.Web3Provider(window.ethereum);
  await p.send("eth_requestAccounts", []);
  const s = p.getSigner();
  const addr = await s.getAddress();
  STATE.wallet = addr;
  $("wallet").textContent = addr;
  toast("éŒ¢åŒ…å·²é€£ç·š");
  log("Wallet connected: " + addr);
}

/* ===== Player trigger (local realtime) ===== */
function playerTrigger(){
  STATE.players += 1;
  $("players").textContent = String(STATE.players);
  STATE.lastTriggerAt = Date.now();

  // A trigger nudges warp/angle for "live rhythm"
  const a = normAngle(STATE.deg + (Math.random()*18 - 9));
  STATE.deg = a;

  const warp = clamp(STATE.warp + (Math.random()*6 - 3), 1, 150);
  STATE.warp = warp;

  $("degRange").value = String(STATE.deg);
  $("warpRange").value = String(STATE.warp);

  applyUI();
  log("ç©å®¶è§¸ç™¼ï¼šç¯€å¾‹å·²æ›´æ–°ï¼ˆæœ¬æ©Ÿå³æ™‚æ¨¡å¼ï¼‰");
  toast("å·²è§¸ç™¼ï¼šå®‡å®™é–‹å§‹å‘¼å¸");

  // optional: speak short
  speak("å·²è§¸ç™¼ã€‚è«‹èª¿æ•´æ–¹å‘ç›¤èˆ‡æ›²é€Ÿã€‚å¤šç©ºç”±è§’åº¦æ±ºå®šã€‚");
}

/* ===== Camera ===== */
let camStream = null;
async function openCam(){
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    throw new Error("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿ");
  }
  camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
  $("cam").srcObject = camStream;
  toast("ç›¸æ©Ÿå·²é–‹å•Ÿ");
  log("Camera started");
}
function shot(){
  const v = $("cam");
  if(!v.videoWidth) throw new Error("ç›¸æ©Ÿå°šæœªå°±ç·’");
  const c = $("snap");
  c.width = v.videoWidth;
  c.height = v.videoHeight;
  const ctx = c.getContext("2d");
  ctx.drawImage(v, 0, 0, c.width, c.height);

  // stamp
  ctx.fillStyle = "rgba(0,0,0,.45)";
  ctx.fillRect(12, 12, 320, 54);
  ctx.fillStyle = "rgba(255,255,255,.92)";
  ctx.font = "16px ui-monospace, Menlo, Consolas, monospace";
  ctx.fillText("GUANGHAN 16888 Â· UFO COCKPIT", 22, 34);
  ctx.font = "13px ui-monospace, Menlo, Consolas, monospace";
  ctx.fillText("TIME: " + nowStr(), 22, 56);

  $("snap").style.display = "block";
  toast("å·²æ‹ç…§");
  log("Snapshot captured");
}
function downloadSnap(){
  const c = $("snap");
  if(c.style.display === "none") throw new Error("å°šæœªæ‹ç…§");
  const a = document.createElement("a");
  a.download = "KLINE_16888_SNAPSHOT.png";
  a.href = c.toDataURL("image/png");
  a.click();
  toast("ä¸‹è¼‰ä¸­");
}

/* ===== FX Particle Engine (canvas) ===== */
const FX = (function(){
  const canvas = $("fx");
  const ctx = canvas.getContext("2d");
  let W=0, H=0, DPR=1;
  let mode="REST"; // LONG / SHORT / REST
  let warp=10;

  const particles = [];
  const MAX = 520;

  function resize(){
    DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
    const rect = canvas.getBoundingClientRect();
    W = Math.floor(rect.width);
    H = Math.floor(rect.height);
    canvas.width = Math.floor(W*DPR);
    canvas.height = Math.floor(H*DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  window.addEventListener("resize", resize);

  function rand(a,b){ return a + Math.random()*(b-a); }

  function spawn(){
    const intensity = clamp(warp/150, 0.06, 1.0);
    const count = Math.floor(2 + intensity*6);

    for(let i=0;i<count;i++){
      if(particles.length > MAX) particles.shift();

      const p = {
        x: rand(0, W),
        y: rand(0, H),
        vx: 0,
        vy: 0,
        r: rand(0.6, 2.2) + intensity*1.6,
        life: rand(0.6, 1.35),
        age: 0,
        a: rand(0.25, 0.95),
        kind: mode
      };

      // stream direction based on mode
      if(mode==="LONG"){
        p.x = rand(0.10*W, 0.90*W);
        p.y = rand(0.15*H, 0.80*H);
        p.vx = rand(1.6, 3.3) + intensity*6.5; // forward
        p.vy = rand(-0.3, 0.3);
      }else if(mode==="SHORT"){
        p.x = rand(0.10*W, 0.90*W);
        p.y = rand(0.15*H, 0.80*H);
        p.vx = - (rand(1.2, 2.8) + intensity*5.6); // backward
        p.vy = rand(-0.3, 0.3);
      }else{
        // rest: float softly
        p.x = rand(0.10*W, 0.90*W);
        p.y = rand(0.15*H, 0.80*H);
        p.vx = rand(-0.35, 0.35);
        p.vy = rand(-0.18, 0.18);
        p.r *= 0.85;
        p.a *= 0.65;
      }

      particles.push(p);
    }
  }

  function draw(dt){
    // clear
    ctx.clearRect(0,0,W,H);

    // subtle vignette
    ctx.fillStyle = "rgba(0,0,0,.12)";
    ctx.fillRect(0,0,W,H);

    // spawn
    spawn();

    // draw particles
    const intensity = clamp(warp/150, 0.06, 1.0);

    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i];
      p.age += dt;
      p.x += p.vx * dt * 60;
      p.y += p.vy * dt * 60;

      const t = 1 - (p.age / p.life);
      if(t<=0 || p.x<-80 || p.x>W+80 || p.y<-80 || p.y>H+80){
        particles.splice(i,1);
        continue;
      }

      // color by mode
      let col = "rgba(255,255,255,";
      if(mode==="LONG"){
        col = `rgba(255,215,120,${p.a*t})`;
      }else if(mode==="SHORT"){
        col = `rgba(120,255,220,${p.a*t})`;
      }else{
        col = `rgba(255,170,220,${p.a*t})`;
      }

      ctx.beginPath();
      ctx.fillStyle = col;
      ctx.arc(p.x, p.y, p.r * (0.6 + intensity*0.65), 0, Math.PI*2);
      ctx.fill();

      // streaks for higher warp
      if(intensity > 0.35 && mode!=="REST"){
        ctx.strokeStyle = col;
        ctx.lineWidth = 1.2;
        ctx.beginPath();
        ctx.moveTo(p.x, p.y);
        ctx.lineTo(p.x - p.vx*0.38, p.y - p.vy*0.38);
        ctx.stroke();
      }
    }

    // center glow
    const cx=W*0.32, cy=H*0.36;
    const g=ctx.createRadialGradient(cx,cy,10,cx,cy, 220+intensity*180);
    if(mode==="LONG"){
      g.addColorStop(0, `rgba(255,215,120,${0.18+intensity*0.22})`);
      g.addColorStop(1, "rgba(255,215,120,0)");
    }else if(mode==="SHORT"){
      g.addColorStop(0, `rgba(120,255,220,${0.16+intensity*0.20})`);
      g.addColorStop(1, "rgba(120,255,220,0)");
    }else{
      g.addColorStop(0, `rgba(255,170,220,${0.12+intensity*0.12})`);
      g.addColorStop(1, "rgba(255,170,220,0)");
    }
    ctx.fillStyle=g;
    ctx.fillRect(0,0,W,H);
  }

  let last = performance.now();
  function loop(){
    const now = performance.now();
    const dt = Math.min(0.033, (now-last)/1000);
    last = now;
    draw(dt);
    requestAnimationFrame(loop);
  }

  function setMode(m, w){
    mode = m;
    warp = w;
  }

  resize();
  requestAnimationFrame(loop);

  return { setMode };
})();

/* ===== Events ===== */
$("degRange").addEventListener("input", (e)=>{
  STATE.deg = Number(e.target.value||0);
  applyUI();
});
$("warpRange").addEventListener("input", (e)=>{
  STATE.warp = Number(e.target.value||10);
  applyUI();
});
$("massInput").addEventListener("input", ()=>{
  applyUI();
});

$("btnConnect").addEventListener("click", async ()=>{
  try{ await connectWallet(); }catch(e){ toast(e.message || String(e)); log("Wallet connect error: " + (e.message||e)); }
});

$("btnTrigger").addEventListener("click", ()=>{
  playerTrigger();
});

$("btnSpeak").addEventListener("click", ()=>{
  const msg = "å»£å¯’å®®ä¸€å…­å…«å…«å…«ã€‚æ–¹å‘ç›¤ååˆ°ä¸€ä¸ƒé›¶ç‚ºå¤šã€‚ä¸€ä¹é›¶åˆ°ä¸‰äº”é›¶ç‚ºç©ºã€‚ä¸‰äº”é›¶åˆ°ä¸€é›¶èˆ‡ä¸€ä¸ƒé›¶åˆ°ä¸€ä¹é›¶ç‚ºä¼‘æ¯ã€‚æ›²é€Ÿä¸€åˆ°ä¸€äº”é›¶ã€‚æŒ‰å³æ™‚è§¸ç™¼é–‹å§‹ç¯€å¾‹ã€‚";
  speak(msg);
  toast("èªéŸ³å°è¦½å·²æ’­æ”¾");
  log("Voice guide played");
});

$("btnClear").addEventListener("click", ()=>{
  STATE.players = 0;
  $("players").textContent = "0";
  $("wish").value = "";
  toast("å·²æ¸…ç©º");
  log("State cleared");
});

$("btnCam").addEventListener("click", async ()=>{
  try{ await openCam(); }catch(e){ toast(e.message||String(e)); log("Camera error: "+(e.message||e)); }
});
$("btnShot").addEventListener("click", ()=>{
  try{ shot(); }catch(e){ toast(e.message||String(e)); log("Shot error: "+(e.message||e)); }
});
$("btnDownload").addEventListener("click", ()=>{
  try{ downloadSnap(); }catch(e){ toast(e.message||String(e)); log("Download error: "+(e.message||e)); }
});

/* ===== Boot ===== */
(function boot(){
  $("players").textContent = "0";
  $("wallet").textContent = "æœªé€£ç·š";
  $("modeBadge").className = "badge warn";
  $("modeBadge").textContent = "ç‹€æ…‹ï¼šREADY";

  applyUI();

  // auto voice once
  setTimeout(()=>{
    speak("å»£å¯’å®®ä¸€å…­å…«å…«å…«ã€‚ä¸ƒä»™å¥³é£›ç¢Ÿé§•é§›è‰™å·²å•Ÿå‹•ã€‚è‹¥å°šæœªæœ‰éŒ¢åŒ…ï¼Œè«‹å…ˆé€£æ¥éŒ¢åŒ…ã€‚æŒ‰å³æ™‚è§¸ç™¼é–‹å§‹ç¯€å¾‹ã€‚");
  }, 650);

  log("Boot OK: 16888 V1.5");
  toast("16888 V1.5 å·²å•Ÿå‹•");
})();
</script>

</body>
</html>
