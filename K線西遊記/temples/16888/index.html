<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>å»£å¯’å®® 16888ï½œä¸ƒä»™å¥³ãƒ»é£›ç¢Ÿé§•é§›è‰™ V1.4ï¼ˆå³æ™‚ç©å®¶è§¸ç™¼ï¼‰</title>

  <!-- ä¾ä½ çš„è·¯å¾‘ï¼šKç·šè¥¿éŠè¨˜/assets/ethers-5.7.2.umd.min.js -->
  <script src="../../assets/ethers-5.7.2.umd.min.js"></script>

  <style>
    :root{
      --bg:#070810;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.10);
      --line: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --gold: #ffd56a;
      --cyan: #7cf6ff;
      --pink: #ff9fd2;
      --good: #9fffd9;
      --warn: #ffd28c;
      --bad:  #ff9fb2;
      --shadow: 0 16px 70px rgba(0,0,0,.55);
      --r: 18px;
      --r2: 999px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Heiti TC", Arial, sans-serif;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(1100px 780px at 22% 15%, rgba(120,170,255,.10), transparent 60%),
        radial-gradient(980px 720px at 78% 66%, rgba(255,160,220,.08), transparent 55%),
        var(--bg);
      color: var(--text);
      min-height:100vh;
      overflow-x:hidden;
      padding-bottom: calc(88px + var(--safe-bottom));
    }
    a{color:inherit}
    .wrap{max-width:1120px;margin:0 auto;padding:16px 14px 20px;}
    .topbar{
      position:sticky; top:0; z-index:60;
      background: linear-gradient(to bottom, rgba(7,8,16,.92), rgba(7,8,16,.65));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.10);
      padding: 10px 10px;
      margin: -16px -14px 14px;
    }
    .topbarIn{
      max-width:1120px;margin:0 auto;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      padding: 0 4px;
    }
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand .h{font-weight:950;letter-spacing:.6px}
    .brand .s{font-size:12px;color:var(--muted)}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    .pill{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:9px 12px;border-radius:var(--r2);
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      box-shadow: var(--shadow);
      text-decoration:none;
      font-size:12px;
      font-weight:900;
      user-select:none;
      cursor:pointer;
      white-space:nowrap;
    }
    .pill:hover{background: rgba(255,255,255,.10)}
    .pill.gold{border-color: rgba(255,213,106,.40)}
    .pill.cyan{border-color: rgba(124,246,255,.40)}
    .pill.pink{border-color: rgba(255,159,210,.40)}
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
    }
    @media (max-width: 960px){ .grid{grid-template-columns:1fr} }
    .card{
      border:1px solid var(--line);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardH{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .cardH .t{font-weight:950;letter-spacing:.5px}
    .cardH .sub{font-size:12px;color:var(--muted);line-height:1.4}
    .cardB{padding:14px}
    .kpiRow{display:grid;grid-template-columns: repeat(4, 1fr); gap:10px}
    @media (max-width: 960px){ .kpiRow{grid-template-columns: repeat(2, 1fr)} }
    .kpi{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      border-radius: 16px;
      padding: 12px;
    }
    .kpi .k{font-size:12px;color:var(--muted);margin-bottom:6px}
    .kpi .v{font-size:18px;font-weight:950;letter-spacing:.3px}
    .kpi .v.mono{font-family:var(--mono);font-size:14px}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.20);
      font-size:12px;color: var(--muted);
      user-select:none;
      white-space:nowrap;
    }
    .badge b{color:var(--text)}
    .badge.ok{border-color: rgba(120,255,200,.25); color: rgba(120,255,200,.90)}
    .badge.warn{border-color: rgba(255,210,120,.25); color: rgba(255,210,120,.95)}
    .badge.bad{border-color: rgba(255,120,120,.25); color: rgba(255,160,180,.95)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1}
    .mini{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      border-radius: 16px;
      padding: 12px;
      min-width: 220px;
    }
    .mini h3{margin:0 0 8px;font-size:12px;color:var(--muted);font-weight:900;letter-spacing:.3px}
    .mini .hint{font-size:12px;color:var(--muted);line-height:1.45}
    input[type="range"]{width:100%}
    input[type="number"], input[type="text"], textarea, select{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.26);
      color: var(--text);
      padding: 10px 12px;
      outline:none;
    }
    textarea{min-height:90px;resize:vertical}
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight:950;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.12)}
    .btn.primary{background: rgba(255,255,255,.92); color:#111; border-color:#fff}
    .btn.primary:hover{background: rgba(255,255,255,.86)}
    .btn.gold{border-color: rgba(255,213,106,.35)}
    .btn.cyan{border-color: rgba(124,246,255,.35)}
    .btn.pink{border-color: rgba(255,159,210,.35)}
    .btn.danger{border-color: rgba(255,120,120,.35); background: rgba(255,120,120,.12)}
    .btn.danger:hover{background: rgba(255,120,120,.18)}
    .sep{height:1px;background: rgba(255,255,255,.10); margin:12px 0}
    .log{
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      padding: 10px 12px;
      font-family: var(--mono);
      font-size: 11px;
      line-height: 1.55;
      max-height: 220px;
      overflow:auto;
      white-space: pre-wrap;
    }

    /* ===== Cockpit Visual ===== */
    .visualWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .ufoFrame{
      position:relative;
      width:min(460px, 100%);
      margin: 0 auto;
      aspect-ratio: 1/1;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      box-shadow: 0 18px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    canvas#beauty{
      width:100%;
      height:100%;
      display:block;
      filter: saturate(1.06) contrast(1.02);
      transform: translateZ(0);
    }
    canvas#stars{
      position:absolute; inset:0;
      width:100%; height:100%;
      opacity:.9;
      pointer-events:none;
      mix-blend-mode: screen;
      transform: translateZ(0);
    }
    canvas#warp{
      position:absolute; inset:0;
      width:100%; height:100%;
      opacity:.85;
      pointer-events:none;
      mix-blend-mode: lighten;
      transform: translateZ(0);
    }
    .hud{
      position:absolute; left:12px; right:12px; bottom:12px;
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      pointer-events:none;
    }
    .hud .chip{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      font-size:12px;
      color: rgba(255,255,255,.88);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
      font-family: var(--mono);
    }
    .stancePill{
      position:absolute; top:12px; left:12px;
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      font-weight:950;
      letter-spacing:.4px;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    .stanceDot{
      width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.35);
      box-shadow: 0 0 18px rgba(255,255,255,.20);
    }
    .stanceDot.long{background: rgba(120,255,200,.95); box-shadow:0 0 18px rgba(120,255,200,.40)}
    .stanceDot.short{background: rgba(255,120,120,.95); box-shadow:0 0 18px rgba(255,120,120,.40)}
    .stanceDot.rest{background: rgba(255,210,120,.95); box-shadow:0 0 18px rgba(255,210,120,.40)}

    /* sticky bottom actions */
    .bottomBar{
      position:fixed; left:0; right:0; bottom:0; z-index:80;
      padding: 10px 12px calc(10px + var(--safe-bottom));
      background: linear-gradient(to top, rgba(7,8,16,.96), rgba(7,8,16,.60));
      border-top:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
    }
    .bottomIn{
      max-width:1120px;margin:0 auto;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    }
    .bottomIn .left{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .bottomIn .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .mono{font-family:var(--mono)}
    .foot{
      margin-top:14px;
      color: var(--muted);
      font-size:12px;
      line-height:1.6;
      text-align:center;
      padding: 10px 10px 4px;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbarIn">
      <div class="brand">
        <div class="h">å»£å¯’å®® 16888ï½œä¸ƒä»™å¥³ãƒ»é£›ç¢Ÿé§•é§›è‰™ <span class="mono">V1.4</span></div>
        <div class="s">å³æ™‚ç©å®¶è§¸ç™¼æ¨¡å¼ï½œ0â€“360Â° æ–¹å‘ç›¤ï½œ1â€“150 å€æ›²é€Ÿï½œæ‹ç…§ç•™å¿µï½œèªéŸ³ AI å®¢æœ</div>
      </div>
      <div class="btnRow">
        <a class="pill gold" id="btnPortal" href="../../index.html">ğŸ—ºï¸ å®‡å®™å…¥å£</a>
        <a class="pill cyan" id="btnHome" href="https://klineodyssey.github.io/kline-odyssey/" target="_blank" rel="noopener">ğŸŒ å®˜ç¶²</a>
        <a class="pill pink" id="btnTemple12345" href="../12345/index.html">ğŸ§¿ äº”æŒ‡å±± 12345</a>
        <button class="pill cyan" id="btnConnect">ğŸª é€£æ¥éŒ¢åŒ…</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">

      <!-- LEFT: Cockpit -->
      <section class="card">
        <div class="cardH">
          <div>
            <div class="t">ä»™å¥³é£›ç¢Ÿè¦–çª—ï¼ˆåœ“å½¢ï¼‰</div>
            <div class="sub">å¤šï¼š10â€“170ï½œä¼‘æ¯ï¼š170â€“190ï½œç©ºï¼š190â€“350ï½œä¼‘æ¯ï¼š350â€“10</div>
          </div>
          <div class="row" style="flex:0 0 auto; gap:8px;">
            <span class="badge" id="badgeMode"><b>MODE</b> PLAYER-TRIGGER</span>
            <span class="badge" id="badgeVoice"><b>VOICE</b> READY</span>
          </div>
        </div>

        <div class="cardB">
          <div class="visualWrap">
            <div class="ufoFrame" aria-label="ä»™å¥³é£›ç¢Ÿåœ“å½¢è¦–çª—">
              <canvas id="beauty"></canvas>
              <canvas id="stars"></canvas>
              <canvas id="warp"></canvas>

              <div class="stancePill">
                <span class="stanceDot" id="stanceDot"></span>
                <span id="stanceText">ä¼‘æ¯</span>
              </div>

              <div class="hud">
                <div class="chip">DEG <span id="hudDeg">0</span>Â°</div>
                <div class="chip">WARP <span id="hudWarp">1</span>x</div>
                <div class="chip">FAIRY <span id="hudFairy">å·§ä»™</span></div>
              </div>
            </div>

            <div class="kpiRow">
              <div class="kpi">
                <div class="k">æ–¹å‘ç›¤ï¼ˆ0â€“360ï¼‰</div>
                <div class="v"><span id="deg">0</span>Â°</div>
                <div class="sub" style="margin-top:6px;color:var(--muted);font-size:12px;">å¤šï¼š10â€“170ï½œç©ºï¼š190â€“350</div>
              </div>
              <div class="kpi">
                <div class="k">æ›²é€Ÿå¼•æ“ï¼ˆ1â€“150ï¼‰</div>
                <div class="v"><span id="warpMul">1</span>x</div>
                <div class="sub" style="margin-top:6px;color:var(--muted);font-size:12px;">1=å…‰é€Ÿï½œ150=è¶…å…‰é€Ÿ</div>
              </div>
              <div class="kpi">
                <div class="k">å³æ™‚è¡Œæƒ…ï¼ˆå®‡å®™ç”Ÿæˆï¼‰</div>
                <div class="v mono">CT=<span id="ctNow">16888</span></div>
                <div class="sub" style="margin-top:6px;color:var(--muted);font-size:12px;">æœ‰äººç© â†’ å°±æœ‰è¡Œæƒ…</div>
              </div>
              <div class="kpi">
                <div class="k">ç©å®¶è§¸ç™¼</div>
                <div class="v"><span id="triggers">0</span></div>
                <div class="sub" style="margin-top:6px;color:var(--muted);font-size:12px;">æ¯æ¬¡æ“ä½œéƒ½è¨˜éŒ„åœ¨æœ¬æ©Ÿ</div>
              </div>
            </div>

            <div class="sep"></div>

            <div class="row">
              <div class="mini">
                <h3>æ–¹å‘ç›¤æ»‘æ¡¿</h3>
                <input id="degRange" type="range" min="0" max="360" value="0" />
                <div class="hint">0â€“360Â°ï½œä¼‘æ¯å€ï¼š350â€“10ã€170â€“190</div>
              </div>
              <div class="mini">
                <h3>æ›²é€Ÿæ»‘æ¡¿</h3>
                <input id="warpRange" type="range" min="1" max="150" value="1" />
                <div class="hint">Warp x1â€“x150ï¼ˆè¶Šé«˜è¶Šäº®ã€è¶Šå¤šå…‰é€Ÿç·šï¼‰</div>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="mini">
                <h3>ä¸ƒä»™å¥³é¸æ“‡</h3>
                <select id="fairySel"></select>
                <div class="hint">ä»™å¥³éš¨è§’åº¦é¡¯è‰²ï¼ˆå¤š/ç©º/ä¼‘æ¯ï¼‰</div>
              </div>
              <div class="mini">
                <h3>è¨±é¡˜å–®ï¼ˆå³æ™‚ç©å®¶è§¸ç™¼ï¼‰</h3>
                <div class="hint">ä¸‹æ³¨ 1â€“1000 KGENï½œæ–¹å‘ï¼šå¤š/ç©ºï½œçµç®—ï¼šä¸‹ä¸€æ ¹å®‡å®™ Kï¼ˆCT+1ï¼‰</div>
                <div class="row" style="margin-top:10px">
                  <div style="flex:1">
                    <select id="sideSel">
                      <option value="LONG">å¤šï¼ˆ10â€“170ï¼‰</option>
                      <option value="SHORT">ç©ºï¼ˆ190â€“350ï¼‰</option>
                    </select>
                  </div>
                  <div style="flex:1">
                    <input id="betAmt" type="number" min="1" max="1000" step="1" value="10" />
                  </div>
                </div>
                <div class="row" style="margin-top:10px">
                  <button class="btn primary" id="btnWish">é€å‡ºè¨±é¡˜ï¼ˆè§¸ç™¼ï¼‰</button>
                  <button class="btn" id="btnSimTick">ç”Ÿæˆä¸‹ä¸€æ ¹ Kï¼ˆæœ¬æ©Ÿï¼‰</button>
                </div>
                <div class="hint" style="margin-top:8px">
                  è¨­è¨ˆï¼šçŒœå° â†’ 0.8ï½1.5 å€ï¼ˆéš¨æ›²é€Ÿå€ç‡æé«˜ä¸Šé™ï¼‰ï½œçŒœéŒ¯ â†’ é€²çæ± ã€‚æ»¿æ±  16888 â†’ æŠ½ä¸€å 60%ã€‚
                </div>
              </div>
            </div>

            <div class="sep"></div>

            <div class="row">
              <button class="btn gold" id="btnSpeak">èªéŸ³è§£èªª</button>
              <button class="btn cyan" id="btnPhoto">æ‹ç…§ç•™å¿µ</button>
              <button class="btn" id="btnSaveNote">ä¿å­˜ç•™è¨€</button>
              <button class="btn danger" id="btnResetLocal">é‡ç½®æœ¬æ©Ÿè³‡æ–™</button>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="mini" style="flex:1.3">
                <h3>ç•™è¨€ï¼ˆæœƒå­˜æœ¬æ©Ÿï¼‰</h3>
                <textarea id="note" placeholder="è¨±é¡˜å…§å®¹/ç•™è¨€â€¦ï¼ˆå¯å¯«ï¼šå¤š/ç©º/æ›²é€Ÿ/å¿ƒæƒ…/æ•…äº‹ï¼‰"></textarea>
              </div>
              <div class="mini" style="flex:.7">
                <h3>æ‹ç…§é è¦½</h3>
                <div style="border:1px solid rgba(255,255,255,.12); border-radius:16px; overflow:hidden; background:rgba(0,0,0,.25);">
                  <video id="cam" autoplay playsinline muted style="width:100%; display:none;"></video>
                  <img id="photoPrev" alt="photo" style="width:100%; display:block;" />
                </div>
                <div class="hint" style="margin-top:8px">ç¬¬ä¸€æ¬¡æœƒè«‹æ±‚ç›¸æ©Ÿæ¬Šé™</div>
              </div>
            </div>

            <div class="sep"></div>
            <div class="log" id="log"></div>
          </div>
        </div>
      </section>

      <!-- RIGHT: Wallet + Help -->
      <section class="card">
        <div class="cardH">
          <div>
            <div class="t">éŒ¢åŒ…èˆ‡å®¢æœ</div>
            <div class="sub">æ²’éŒ¢åŒ…ä¹Ÿèƒ½ç©æœ¬æ©Ÿæ¨¡å¼ï¼›é€£éŒ¢åŒ…æ‰å¯å‘¼å«éˆä¸Šäº¤æ˜“ï¼ˆä¹‹å¾Œæ¥åˆç´„ï¼‰</div>
          </div>
          <span class="badge" id="netBadge"><b>CHAIN</b> æœªé€£ç·š</span>
        </div>

        <div class="cardB">
          <div class="mini">
            <h3>éŒ¢åŒ…ç‹€æ…‹</h3>
            <div class="row" style="gap:8px">
              <span class="badge"><b>ADDR</b> <span class="mono" id="walletAddr">--</span></span>
              <span class="badge"><b>BNB</b> <span class="mono" id="bnbBal">--</span></span>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="btnConnect2">é€£æ¥ MetaMask</button>
              <button class="btn" id="btnAddBSC">æ–°å¢ BSC ç¶²è·¯</button>
            </div>
            <div class="sep"></div>
            <div class="hint" style="font-size:12px;color:var(--muted);line-height:1.55">
              è‹¥ä½ é‚„æ²’æœ‰éŒ¢åŒ…ï¼š<br/>
              1) å®‰è£ MetaMask â†’ å»ºéŒ¢åŒ…<br/>
              2) åˆ‡åˆ° BNB Chainï¼ˆchainId 56ï¼‰<br/>
              3) æº–å‚™å°‘é‡ BNB ç•¶ Gas<br/>
              4) å›ä¾†æŒ‰ã€Œé€£æ¥ã€å³å¯é–‹å§‹éˆä¸Šäº’å‹•
            </div>
          </div>

          <div class="sep"></div>

          <div class="mini">
            <h3>AI å®¢æœï¼ˆèªéŸ³ + æ–‡å­—ï¼‰</h3>
            <div class="row">
              <button class="btn cyan" id="btnCSQuick">ä¸€éµæ•™å­¸</button>
              <button class="btn" id="btnCSExplain">è§£é‡‹è¦å‰‡</button>
              <button class="btn" id="btnCSWallet">æ•™æˆ‘è£éŒ¢åŒ…</button>
            </div>
            <div class="sep"></div>
            <textarea id="csBox" placeholder="å®¢æœè¨Šæ¯æœƒé¡¯ç¤ºåœ¨é€™è£¡â€¦ï¼ˆä¹Ÿæœƒç”¨èªéŸ³æ’­å ±ï¼‰"></textarea>
          </div>

          <div class="sep"></div>

          <div class="mini">
            <h3>ä¸ƒä»™å¥³è¨­å®šï¼ˆé»ä½/ç¥è·ï¼‰</h3>
            <div class="hint" style="line-height:1.65">
              14520 å·§é›²ï½œå¤©æ¨ï½œåšç©ºï½œé¢¨èª¿é›¨é †<br/>
              14866 å·§è™¹ï½œå¤©ç’‡ï½œåšå¤šï½œå®¶åº­ç¾æ»¿<br/>
              16184 å·§èŠï½œå¤©ç’£ï½œåšç©ºï½œè‚²å­æ”¶é©š<br/>
              16888 å·§ä»™ï½œå¤©æ¬Šï½œåšå¤šï½œäº‹æ¥­é‹é€š<br/>
              17347 å·§è˜­ï½œå¤©è¡¡ï½œåšç©ºï½œé•·å‘½ç™¾æ­²<br/>
              18056 å·§æ¢…ï½œé—“é™½ï½œåšå¤šï½œèº«é«”å¥åº·<br/>
              18459 å·§éˆï½œç‘¤å…‰ï½œå¤šé€€ï½œæ„Ÿæƒ…åœ“æ»¿
            </div>
          </div>

          <div class="foot">
            PrimeForge ä»¥æ¯æ©Ÿä¹‹åï¼Œé–‹å•Ÿé‡‘èç”Ÿå‘½ã€‚<br/>
            èŠ±æœå±±å°ç£ãƒ»ä¿¡å¿µä¸æ»…ãƒ»å¸‚å ´ç„¡ç•Œã€‚<br/>
            Where the Market Becomes the Myth.<br/>
            â€”â€” æ¨‚å¤©å¸ âŒ–
          </div>
        </div>
      </section>

    </div>
  </div>

  <div class="bottomBar">
    <div class="bottomIn">
      <div class="left">
        <span class="badge ok"><b>RANGE</b> 10â€“170 å¤š</span>
        <span class="badge bad"><b>RANGE</b> 190â€“350 ç©º</span>
        <span class="badge warn"><b>REST</b> 350â€“10 / 170â€“190</span>
      </div>
      <div class="right">
        <button class="btn primary" id="btnAutoVoice">é€²é è‡ªå‹•èªéŸ³ï¼šON</button>
        <span class="badge"><b>LOCAL</b> <span class="mono" id="localKey">KLINE_16888_V1_4</span></span>
      </div>
    </div>
  </div>

<script>
/* =========================
   16888 Fairy UFO Cockpit V1.4
   - Player-trigger real-time mode (local)
   - Visual: circular portrait + star parallax + warp streaks
   - Voice: auto on enter (if allowed), and on actions
   - Wallet: connect + add BSC helper
   ========================= */

const LS_KEY = "KLINE_16888_V1_4";
const CFG = {
  ranges: {
    restA: [350, 360],
    restB: [0, 10],
    long:  [10, 170],
    restC: [170, 190],
    short: [190, 350]
  },
  wish: {
    poolCap: 16888,
    betMin: 1,
    betMax: 1000,
    // payout multiplier ranges; max increases with warp
    baseWinMin: 0.8,
    baseWinMax: 1.0,
    warpWinMax: 1.5
  },
  chain: {
    bscChainIdHex: "0x38",
    bscChainIdDec: 56,
    bscParams: {
      chainId: "0x38",
      chainName: "BNB Smart Chain (BSC)",
      nativeCurrency: { name: "BNB", symbol: "BNB", decimals: 18 },
      rpcUrls: ["https://bsc-dataseed.binance.org/"],
      blockExplorerUrls: ["https://bscscan.com/"]
    }
  }
};

const FAIRIES = [
  { id:14520, name:"å·§é›²", star:"å¤©æ¨", side:"ç©º", role:"é¢¨èª¿é›¨é †åšç©º", theme:"cyan" },
  { id:14866, name:"å·§è™¹", star:"å¤©ç’‡", side:"å¤š", role:"å®¶åº­ç¾æ»¿åšå¤š", theme:"pink" },
  { id:16184, name:"å·§èŠ", star:"å¤©ç’£", side:"ç©º", role:"è‚²å­æ”¶é©šåšç©º", theme:"cyan" },
  { id:16888, name:"å·§ä»™", star:"å¤©æ¬Š", side:"å¤š", role:"äº‹æ¥­é‹é€šåšå¤š", theme:"gold" },
  { id:17347, name:"å·§è˜­", star:"å¤©è¡¡", side:"ç©º", role:"é•·å‘½ç™¾æ­²åšç©º", theme:"cyan" },
  { id:18056, name:"å·§æ¢…", star:"é—“é™½", side:"å¤š", role:"èº«é«”å¥åº·åšå¤š", theme:"pink" },
  { id:18459, name:"å·§éˆ", star:"ç‘¤å…‰", side:"å¤šé€€", role:"æ„Ÿæƒ…åœ“æ»¿å¤šå–®é€€", theme:"gold" }
];

function $(id){ return document.getElementById(id); }
function now(){ return new Date().toISOString(); }
function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
function rnd(a,b){ return a + Math.random()*(b-a); }

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function saveState(s){
  localStorage.setItem(LS_KEY, JSON.stringify(s));
}
function defaultState(){
  return {
    version: "1.4",
    deg: 0,
    warp: 1,
    ct: 16888,
    triggers: 0,
    wishPool: 0,
    orders: [],
    notes: "",
    fairyId: 16888,
    autoVoice: true
  };
}

let S = loadState() || defaultState();

/* ===== Voice ===== */
let voiceOk = false;
function canSpeak(){ return !!window.speechSynthesis && S.autoVoice; }
function speak(text){
  // Always write to CS box too
  $("csBox").value = text;
  if(!canSpeak()) return;
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "zh-TW";
    u.rate = 1.0;
    u.pitch = 1.0;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
    voiceOk = true;
    $("badgeVoice").className = "badge ok";
    $("badgeVoice").innerHTML = "<b>VOICE</b> ON";
  }catch(e){
    $("badgeVoice").className = "badge warn";
    $("badgeVoice").innerHTML = "<b>VOICE</b> BLOCKED";
  }
}

/* ===== Stance logic (new ranges) ===== */
function stanceByDeg(d){
  d = (d%360+360)%360;
  const inR = (x, a, b)=> x>=a && x<=b;
  const r = CFG.ranges;
  if(inR(d, r.long[0], r.long[1])) return "LONG";
  if(inR(d, r.short[0], r.short[1])) return "SHORT";
  // rest zones: 350-360, 0-10, 170-190
  return "REST";
}

/* ===== Fairy selection ===== */
function currentFairy(){
  return FAIRIES.find(f=>f.id===S.fairyId) || FAIRIES[3];
}

/* ===== Visual engine ===== */
const cvsBeauty = $("beauty");
const ctxB = cvsBeauty.getContext("2d");
const cvsStars = $("stars");
const ctxS = cvsStars.getContext("2d");
const cvsWarp = $("warp");
const ctxW = cvsWarp.getContext("2d");

let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
function resizeCanvases(){
  const rect = cvsBeauty.getBoundingClientRect();
  const w = Math.floor(rect.width * DPR);
  const h = Math.floor(rect.height * DPR);
  [cvsBeauty, cvsStars, cvsWarp].forEach(c=>{
    c.width = w; c.height = h;
  });
}
window.addEventListener("resize", ()=>{ resizeCanvases(); initStars(); });

let stars = [];
function initStars(){
  const w = cvsStars.width, h = cvsStars.height;
  stars = [];
  const n = Math.floor((w*h)/22000); // density
  for(let i=0;i<n;i++){
    stars.push({
      x: Math.random()*w,
      y: Math.random()*h,
      z: Math.random()*1 + 0.2,
      r: Math.random()*1.6 + 0.3
    });
  }
}

function drawStars(parallaxX, parallaxY){
  const w = cvsStars.width, h = cvsStars.height;
  ctxS.clearRect(0,0,w,h);
  ctxS.save();
  // vignette
  const vg = ctxS.createRadialGradient(w/2,h/2, w*0.05, w/2,h/2, w*0.62);
  vg.addColorStop(0, "rgba(255,255,255,0.08)");
  vg.addColorStop(1, "rgba(0,0,0,0.55)");
  ctxS.fillStyle = vg;
  ctxS.fillRect(0,0,w,h);

  for(const s of stars){
    const x = (s.x + parallaxX * 18 * s.z + w) % w;
    const y = (s.y + parallaxY * 18 * s.z + h) % h;
    ctxS.beginPath();
    ctxS.fillStyle = `rgba(255,255,255,${0.35*s.z})`;
    ctxS.arc(x,y,s.r,0,Math.PI*2);
    ctxS.fill();
  }
  ctxS.restore();
}

function drawWarp(deg, warp){
  const w = cvsWarp.width, h = cvsWarp.height;
  ctxW.clearRect(0,0,w,h);
  const stance = stanceByDeg(deg);

  // warp intensity
  const t = (warp-1)/149; // 0..1
  const streaks = Math.floor(20 + t*160);
  const alpha = 0.08 + t*0.42;

  if(stance==="REST" && warp<8) return; // rest calm

  ctxW.save();
  ctxW.globalAlpha = alpha;
  ctxW.translate(w/2, h/2);

  // direction: long => forward, short => backward
  const dir = stance==="SHORT" ? -1 : 1;
  const ang = (deg*Math.PI/180) * dir;

  ctxW.rotate(ang);

  for(let i=0;i<streaks;i++){
    const len = rnd(w*0.06, w*0.55) * (0.35 + t);
    const y = rnd(-h/2, h/2);
    const x0 = rnd(-w*0.15, w*0.15);
    const x1 = x0 + len;
    const width = rnd(0.6, 1.8) * DPR * (0.9 + t*1.1);

    const g = ctxW.createLinearGradient(x0,y, x1,y);
    g.addColorStop(0, "rgba(255,255,255,0.00)");
    g.addColorStop(0.5, "rgba(255,220,120,0.55)");
    g.addColorStop(1, "rgba(255,255,255,0.00)");
    ctxW.strokeStyle = g;
    ctxW.lineWidth = width;
    ctxW.beginPath();
    ctxW.moveTo(x0,y);
    ctxW.lineTo(x1,y);
    ctxW.stroke();
  }

  ctxW.restore();
}

function drawBeauty(deg, warp){
  const w = cvsBeauty.width, h = cvsBeauty.height;
  ctxB.clearRect(0,0,w,h);

  const stance = stanceByDeg(deg);
  const t = (warp-1)/149;

  // background
  const bg = ctxB.createRadialGradient(w*0.35,h*0.30, w*0.08, w/2,h/2, w*0.72);
  bg.addColorStop(0, "rgba(255,160,220,0.16)");
  bg.addColorStop(0.35, "rgba(124,246,255,0.10)");
  bg.addColorStop(1, "rgba(0,0,0,0.70)");
  ctxB.fillStyle = bg;
  ctxB.fillRect(0,0,w,h);

  // portrait transform: rotate slowly with deg
  const rot = (deg*Math.PI/180) * 0.55;
  ctxB.save();
  ctxB.translate(w/2, h/2);
  ctxB.rotate(rot);
  ctxB.translate(-w/2, -h/2);

  // brightness by stance
  let bright = 1.0;
  let sat = 1.0;
  if(stance==="LONG"){ bright = 1.06 + t*0.12; sat = 1.10; }
  if(stance==="SHORT"){ bright = 0.92 - t*0.10; sat = 0.95; }
  if(stance==="REST"){ bright = 0.80; sat = 0.25; }

  // face (stylized vector)
  const fx = w*0.50, fy = h*0.48;
  const faceR = Math.min(w,h)*0.22;

  // hair gradient
  const hairG = ctxB.createRadialGradient(fx-faceR*0.5, fy-faceR*0.8, faceR*0.1, fx, fy, faceR*1.6);
  hairG.addColorStop(0, `rgba(30,20,60,${0.95})`);
  hairG.addColorStop(1, `rgba(5,5,12,${0.95})`);

  // glow halo (warp)
  const halo = ctxB.createRadialGradient(fx, fy-faceR*0.7, faceR*0.1, fx, fy, faceR*2.2);
  halo.addColorStop(0, `rgba(255,213,106,${0.10 + t*0.22})`);
  halo.addColorStop(1, "rgba(0,0,0,0)");
  ctxB.fillStyle = halo;
  ctxB.beginPath();
  ctxB.arc(fx, fy, faceR*2.0, 0, Math.PI*2);
  ctxB.fill();

  // hair
  ctxB.fillStyle = hairG;
  ctxB.beginPath();
  ctxB.ellipse(fx, fy-faceR*0.35, faceR*1.05, faceR*1.10, 0, 0, Math.PI*2);
  ctxB.fill();

  // face gradient
  const faceG = ctxB.createRadialGradient(fx-faceR*0.3, fy-faceR*0.2, faceR*0.2, fx, fy, faceR*1.3);
  faceG.addColorStop(0, "rgba(255,235,225,0.98)");
  faceG.addColorStop(1, "rgba(245,205,205,0.92)");

  ctxB.fillStyle = faceG;
  ctxB.beginPath();
  ctxB.ellipse(fx, fy, faceR*0.95, faceR*1.08, 0, 0, Math.PI*2);
  ctxB.fill();

  // cheeks
  ctxB.fillStyle = `rgba(255,120,170,${0.10 + (stance==="LONG"?0.08:0.02)})`;
  ctxB.beginPath();
  ctxB.ellipse(fx-faceR*0.45, fy+faceR*0.10, faceR*0.28, faceR*0.20, 0, 0, Math.PI*2); ctxB.fill();
  ctxB.beginPath();
  ctxB.ellipse(fx+faceR*0.45, fy+faceR*0.10, faceR*0.28, faceR*0.20, 0, 0, Math.PI*2); ctxB.fill();

  // eyes (stance influences)
  const eyeOpen = stance==="REST" ? 0.08 : (stance==="SHORT" ? 0.18 : 0.26);
  const eyeTilt = stance==="SHORT" ? -0.12 : (stance==="LONG" ? 0.06 : 0.0);
  ctxB.fillStyle = "rgba(15,18,30,0.92)";
  function eye(cx){
    ctxB.save();
    ctxB.translate(cx, fy-faceR*0.08);
    ctxB.rotate(eyeTilt);
    ctxB.beginPath();
    ctxB.ellipse(0, 0, faceR*0.22, faceR*eyeOpen, 0, 0, Math.PI*2);
    ctxB.fill();
    // highlight
    ctxB.fillStyle = `rgba(255,255,255,${stance==="REST"?0.18:0.35})`;
    ctxB.beginPath();
    ctxB.arc(faceR*0.08, -faceR*0.03, faceR*0.05, 0, Math.PI*2);
    ctxB.fill();
    ctxB.restore();
    ctxB.fillStyle = "rgba(15,18,30,0.92)";
  }
  eye(fx-faceR*0.33);
  eye(fx+faceR*0.33);

  // mouth (rest => sleep)
  ctxB.strokeStyle = "rgba(120,40,70,0.65)";
  ctxB.lineWidth = Math.max(2, DPR*1.6);
  ctxB.beginPath();
  if(stance==="REST"){
    ctxB.moveTo(fx-faceR*0.18, fy+faceR*0.48);
    ctxB.quadraticCurveTo(fx, fy+faceR*0.54, fx+faceR*0.18, fy+faceR*0.48);
  }else if(stance==="LONG"){
    ctxB.moveTo(fx-faceR*0.20, fy+faceR*0.46);
    ctxB.quadraticCurveTo(fx, fy+faceR*0.58, fx+faceR*0.20, fy+faceR*0.46);
  }else{ // short
    ctxB.moveTo(fx-faceR*0.20, fy+faceR*0.50);
    ctxB.quadraticCurveTo(fx, fy+faceR*0.44, fx+faceR*0.20, fy+faceR*0.50);
  }
  ctxB.stroke();

  // frame gloss
  const gloss = ctxB.createLinearGradient(0,0,w,h);
  gloss.addColorStop(0, "rgba(255,255,255,0.16)");
  gloss.addColorStop(0.3, "rgba(255,255,255,0.03)");
  gloss.addColorStop(1, "rgba(0,0,0,0.20)");
  ctxB.fillStyle = gloss;
  ctxB.fillRect(0,0,w,h);

  // apply stance brightness/sat by overlay
  ctxB.restore();

  // post color adjustments using globalCompositeOperation
  ctxB.save();
  // saturation/brightness approximations
  if(stance==="REST"){
    ctxB.globalAlpha = 0.55;
    ctxB.fillStyle = "rgba(0,0,0,0.25)";
    ctxB.fillRect(0,0,w,h);
  }else if(stance==="SHORT"){
    ctxB.globalAlpha = 0.35;
    ctxB.fillStyle = "rgba(0,0,0,0.18)";
    ctxB.fillRect(0,0,w,h);
  }else{
    ctxB.globalAlpha = 0.18;
    ctxB.fillStyle = "rgba(255,255,255,0.10)";
    ctxB.fillRect(0,0,w,h);
  }
  ctxB.restore();

  // vignette
  ctxB.save();
  const vg = ctxB.createRadialGradient(w/2,h/2, w*0.10, w/2,h/2, w*0.62);
  vg.addColorStop(0, "rgba(0,0,0,0)");
  vg.addColorStop(1, "rgba(0,0,0,0.55)");
  ctxB.fillStyle = vg;
  ctxB.fillRect(0,0,w,h);
  ctxB.restore();
}

function renderAll(){
  const d = Number(S.deg)||0;
  const w = Number(S.warp)||1;

  const stance = stanceByDeg(d);
  const fairy = currentFairy();

  $("deg").textContent = String(d);
  $("hudDeg").textContent = String(d);
  $("warpMul").textContent = String(w);
  $("hudWarp").textContent = String(w);
  $("ctNow").textContent = String(S.ct);
  $("triggers").textContent = String(S.triggers);
  $("hudFairy").textContent = fairy.name;

  // stance UI
  let stanceText = "ä¼‘æ¯";
  $("stanceDot").className = "stanceDot rest";
  if(stance==="LONG"){ stanceText="å¤š"; $("stanceDot").className="stanceDot long"; }
  if(stance==="SHORT"){ stanceText="ç©º"; $("stanceDot").className="stanceDot short"; }
  $("stanceText").textContent = stanceText;

  // parallax based on angle
  const rad = d*Math.PI/180;
  const px = Math.cos(rad);
  const py = Math.sin(rad);
  drawStars(px, py);
  drawWarp(d, w);
  drawBeauty(d, w);

  // log hint line
  const pool = S.wishPool || 0;
  const poolLine = `WishPool=${pool.toFixed(2)} / ${CFG.wish.poolCap} KGEN`;
  const modeLine = `Stance=${stance} | Fairy=${fairy.id} ${fairy.name}ï½œ${fairy.star}ï½œ${fairy.role}`;
  $("badgeMode").className = "badge ok";
  $("badgeMode").innerHTML = `<b>MODE</b> PLAYER-TRIGGER`;
  addLog(`Render | DEG=${d} WARP=${w} | ${poolLine} | ${modeLine}`, true);
}

/* ===== Real-time player trigger mode =====
   Rule: actions generate "ticks" (universe candles). CT updates on each trigger.
*/
function nextCT(){
  // Make CT drift based on aggregate bias: deg stance + last 10 orders.
  const stance = stanceByDeg(S.deg);
  let bias = 0;
  if(stance==="LONG") bias += 0.6;
  if(stance==="SHORT") bias -= 0.6;

  const last = (S.orders || []).slice(-10);
  for(const o of last){
    bias += (o.side==="LONG" ? 0.15 : -0.15) * clamp(o.warp/150, 0.1, 1.0);
  }

  // volatility from warp (higher warp => more movement)
  const vol = 1 + (S.warp-1)/149 * 8; // 1..9
  const step = Math.round((rnd(-2.2, 2.2) + bias) * vol);
  // Keep within a friendly range around 16888 for now
  S.ct = clamp((S.ct || 16888) + step, 14520, 18459);
  return S.ct;
}

/* ===== Wish engine ===== */
function calcWinMultiplier(warp){
  // win multiplier max scales from 1.0 to 1.5
  const t = (warp-1)/149;
  const max = CFG.wish.baseWinMax + t*(CFG.wish.warpWinMax - CFG.wish.baseWinMax);
  const min = CFG.wish.baseWinMin;
  return rnd(min, max);
}

function placeWish(){
  const side = $("sideSel").value;
  const amt = Number($("betAmt").value || 0);
  if(!Number.isFinite(amt) || amt < CFG.wish.betMin || amt > CFG.wish.betMax){
    speak(`ä¸‹æ³¨é‡‘é¡éœ€åœ¨ ${CFG.wish.betMin} åˆ° ${CFG.wish.betMax} ä¹‹é–“ã€‚`);
    return;
  }

  // Trigger
  S.triggers += 1;

  // Generate next candle (CT+1 concept)
  const prev = S.ct;
  const next = nextCT();
  const correct = (side==="LONG" && next>prev) || (side==="SHORT" && next<prev);

  let outcome = "LOSE";
  let payout = 0;
  if(next===prev){
    // tie -> treat as rest, partial refund
    outcome = "TIE";
    payout = amt * 0.95;
  }else if(correct){
    outcome = "WIN";
    const mul = calcWinMultiplier(S.warp);
    payout = amt * mul;
  }else{
    outcome = "LOSE";
    payout = 0;
  }

  // pool accounting
  if(outcome==="LOSE"){
    S.wishPool = (S.wishPool||0) + amt;
  }else{
    // payout is virtual (local)
    // keep pool unchanged on win; this is "house edge = 0" fantasy mode
  }

  const fairy = currentFairy();
  const stance = stanceByDeg(S.deg);

  const order = {
    at: Date.now(),
    iso: now(),
    fairyId: fairy.id,
    fairyName: fairy.name,
    side,
    amt,
    deg: S.deg,
    warp: S.warp,
    ct0: prev,
    ct1: next,
    stance,
    outcome,
    payout: Number(payout.toFixed(4))
  };
  S.orders = S.orders || [];
  S.orders.push(order);

  // jackpot when pool reaches cap
  if((S.wishPool||0) >= CFG.wish.poolCap){
    // pick a winner from last 30 orders
    const cand = (S.orders||[]).slice(-30);
    const winPick = cand.length ? cand[Math.floor(Math.random()*cand.length)] : order;
    const total = S.wishPool||0;
    const winner = total * 0.60;
    const good = total * 0.30;
    const remain = total - winner - good;

    addLog(`JACKPOT! Pool=${total.toFixed(2)} æŠ½ä¸­ï¼š${winPick.fairyName} çš„ç©å®¶ï¼ˆ${winPick.side} ${winPick.amt}ï¼‰ï½œå¾— ${winner.toFixed(2)}ï½œå…¬ç›Š ${good.toFixed(2)}ï½œç•™æ±  ${remain.toFixed(2)}`);
    speak(`æ»¿æ± è§¸ç™¼ã€‚æŠ½ä¸­ä¸€ä½ç©å®¶ç²å¾—çæ± å…­æˆã€‚å…¬ç›Šä¸‰æˆã€‚å…¶é¤˜ç•™åœ¨çæ± ã€‚`);

    // reset pool to remain (carry)
    S.wishPool = Number(remain.toFixed(4));
  }

  saveState(S);

  const msg = `è¨±é¡˜ï¼š${fairy.name}ï½œ${side==="LONG"?"å¤š":"ç©º"} ${amt}ï½œCT ${prev}â†’${next}ï½œçµæœï¼š${outcome}${outcome==="WIN" ? `ï½œçå‹µâ‰ˆ${payout.toFixed(2)}` : outcome==="TIE" ? `ï½œé€€å›â‰ˆ${payout.toFixed(2)}` : ""}ï½œçæ± =${(S.wishPool||0).toFixed(2)}`;
  addLog(msg);
  speak(msg);
  renderAll();
}

function manualTick(){
  S.triggers += 1;
  const prev = S.ct;
  const next = nextCT();
  saveState(S);
  const msg = `ç”Ÿæˆä¸‹ä¸€æ ¹å®‡å®™Kï¼šCT ${prev}â†’${next}ï½œï¼ˆç©å®¶è§¸ç™¼ï¼‰`;
  addLog(msg);
  speak(msg);
  renderAll();
}

/* ===== Logging ===== */
let lastLog = "";
function addLog(line, quiet=false){
  // avoid spamming repeated render logs
  if(quiet){
    if(line===lastLog) return;
    lastLog = line;
  }
  const el = $("log");
  const ts = new Date().toLocaleTimeString("zh-TW",{hour12:false});
  el.textContent = `[${ts}] ${line}\n` + el.textContent;
}

/* ===== Notes ===== */
function saveNote(){
  S.notes = $("note").value || "";
  saveState(S);
  speak("ç•™è¨€å·²ä¿å­˜åœ¨æœ¬æ©Ÿã€‚");
  addLog("Note saved.");
}

/* ===== Camera ===== */
let camStream = null;
async function ensureCamera(){
  const v = $("cam");
  if(camStream) return camStream;
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    speak("ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿã€‚");
    return null;
  }
  try{
    camStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}, audio:false});
    v.srcObject = camStream;
    v.style.display = "block";
    return camStream;
  }catch(e){
    speak("ç›¸æ©Ÿæ¬Šé™è¢«æ‹’çµ•æˆ–ä¸å¯ç”¨ã€‚");
    return null;
  }
}
async function takePhoto(){
  const s = await ensureCamera();
  if(!s) return;
  const v = $("cam");
  // draw video frame into canvas then export
  const c = document.createElement("canvas");
  const w = v.videoWidth || 720;
  const h = v.videoHeight || 720;
  c.width = w; c.height = h;
  const cx = c.getContext("2d");
  cx.drawImage(v,0,0,w,h);
  const data = c.toDataURL("image/jpeg", 0.86);
  $("photoPrev").src = data;
  addLog("Photo captured (local).");
  speak("æ‹ç…§å®Œæˆã€‚ç…§ç‰‡å·²é¡¯ç¤ºåœ¨å³å´ã€‚");
}

/* ===== Wallet ===== */
let provider=null, signer=null, wallet="";
async function connectWallet(){
  if(!window.ethereum){
    speak("æœªåµæ¸¬åˆ° MetaMaskã€‚è«‹å…ˆå®‰è£éŒ¢åŒ…ã€‚");
    $("netBadge").className = "badge bad"; $("netBadge").innerHTML = "<b>CHAIN</b> NO WALLET";
    return;
  }
  try{
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    wallet = await signer.getAddress();
    $("walletAddr").textContent = shortAddr(wallet);

    const net = await provider.getNetwork();
    if(net.chainId !== CFG.chain.bscChainIdDec){
      $("netBadge").className = "badge warn";
      $("netBadge").innerHTML = `<b>CHAIN</b> chainId=${net.chainId}ï¼ˆè«‹åˆ‡ BSCï¼‰`;
      speak("éŒ¢åŒ…å·²é€£ç·šï¼Œä½†ä¸æ˜¯ BSCã€‚è«‹åˆ‡æ›åˆ° BNB Chainã€‚");
    }else{
      $("netBadge").className = "badge ok";
      $("netBadge").innerHTML = `<b>CHAIN</b> BSC OK`;
      speak("éŒ¢åŒ…å·²é€£ç·šã€‚ä½ å·²åœ¨ BSCã€‚");
    }

    const bal = await provider.getBalance(wallet);
    $("bnbBal").textContent = Number(ethers.utils.formatEther(bal)).toFixed(4);

    addLog(`Wallet connected: ${wallet}`);
  }catch(e){
    speak("é€£æ¥éŒ¢åŒ…å¤±æ•—ã€‚");
  }
}
function shortAddr(a){
  if(!a || a.length<10) return a||"--";
  return a.slice(0,6)+"â€¦"+a.slice(-4);
}
async function addBSC(){
  if(!window.ethereum){
    speak("æœªåµæ¸¬åˆ° MetaMaskã€‚");
    return;
  }
  try{
    await window.ethereum.request({ method:"wallet_addEthereumChain", params:[CFG.chain.bscParams] });
    speak("å·²é€å‡ºæ–°å¢ BSC ç¶²è·¯è«‹æ±‚ã€‚");
  }catch(e){
    speak("æ–°å¢ BSC å¤±æ•—æˆ–è¢«å–æ¶ˆã€‚");
  }
}

/* ===== AI Customer Service ===== */
function csTeach(){
  const t = [
    "ä½ ç¾åœ¨åœ¨å»£å¯’å®® 16888 ä¸ƒä»™å¥³é£›ç¢Ÿé§•é§›è‰™ã€‚",
    "å…ˆç”¨æ–¹å‘ç›¤é¸è§’åº¦ï¼šååˆ°ä¸€ç™¾ä¸ƒåæ˜¯å¤šï¼Œ ä¸€ç™¾ä¹ååˆ°ä¸‰ç™¾äº”åæ˜¯ç©ºã€‚",
    "æ›²é€Ÿä¸€åˆ°ä¸€ç™¾äº”åï¼Œè¶Šé«˜è¶Šåˆºæ¿€ã€‚",
    "æ²’éŒ¢åŒ…ä¹Ÿèƒ½ç©æœ¬æ©Ÿè¨±é¡˜ã€‚è¦éˆä¸Šäº’å‹•å†é€£æ¥ MetaMaskã€‚"
  ].join(" ");
  speak(t);
  addLog("CS teach played.");
}
function csRules(){
  const t = [
    "è¨±é¡˜ç©æ³•ï¼šä¸‹æ³¨ä¸€åˆ°ä¸€åƒ KGENï¼Œé¸å¤šæˆ–ç©ºã€‚",
    "ä½ æŒ‰ä¸‹è¨±é¡˜ï¼Œå°±æœƒè§¸ç™¼ä¸‹ä¸€æ ¹å®‡å®™Kï¼Œä¹Ÿå°±æ˜¯ CT çš„ä¸‹ä¸€æ­¥ã€‚",
    "çŒœå°æœƒå¾—åˆ°é›¶é»å…«åˆ°ä¸€é»äº”å€çš„çå‹µä¸Šé™ï¼Œè·Ÿæ›²é€Ÿæœ‰é—œã€‚",
    "çŒœéŒ¯æœƒé€²çæ± ï¼Œçæ± æ»¿ä¸€è¬å…­åƒå…«ç™¾å…«åå…«æœƒæŠ½ä¸­ä¸€åç©å®¶é ˜å…­æˆï¼Œå…¬ç›Šä¸‰æˆï¼Œå…¶é¤˜ç•™æ± ã€‚"
  ].join(" ");
  speak(t);
}
function csWallet(){
  const t = [
    "éŒ¢åŒ…æ•™å­¸ï¼šä¸‹è¼‰ MetaMaskï¼Œå»ºç«‹éŒ¢åŒ…ï¼Œåˆ‡æ›åˆ° BNB Chainã€‚",
    "æº–å‚™å°‘é‡ BNB ç•¶ Gasã€‚",
    "å›åˆ°é€™é æŒ‰é€£æ¥éŒ¢åŒ…ã€‚",
    "å¦‚æœä¸æ˜¯ BSCï¼ŒæŒ‰æ–°å¢ BSC æˆ–åˆ°éŒ¢åŒ…åˆ‡æ›ç¶²è·¯ã€‚"
  ].join(" ");
  speak(t);
}

/* ===== UI bind ===== */
function initFairySelect(){
  const sel = $("fairySel");
  sel.innerHTML = "";
  for(const f of FAIRIES){
    const o = document.createElement("option");
    o.value = String(f.id);
    o.textContent = `${f.id}ï½œ${f.name}ï½œ${f.star}ï½œ${f.role}`;
    sel.appendChild(o);
  }
  sel.value = String(S.fairyId);
  sel.addEventListener("change", ()=>{
    S.fairyId = Number(sel.value);
    saveState(S);
    addLog(`Fairy set: ${S.fairyId}`);
    renderAll();
  });
}

function initSliders(){
  $("degRange").value = String(S.deg);
  $("warpRange").value = String(S.warp);

  $("degRange").addEventListener("input", (e)=>{
    S.deg = Number(e.target.value);
    S.triggers += 1;
    saveState(S);
    renderAll();
  });
  $("warpRange").addEventListener("input", (e)=>{
    S.warp = Number(e.target.value);
    S.triggers += 1;
    saveState(S);
    renderAll();
  });
}

/* ===== Auto voice toggle ===== */
function syncAutoVoiceBtn(){
  $("btnAutoVoice").textContent = `é€²é è‡ªå‹•èªéŸ³ï¼š${S.autoVoice ? "ON" : "OFF"}`;
}
$("btnAutoVoice").addEventListener("click", ()=>{
  S.autoVoice = !S.autoVoice;
  saveState(S);
  syncAutoVoiceBtn();
  speak(S.autoVoice ? "è‡ªå‹•èªéŸ³å·²é–‹å•Ÿã€‚" : "è‡ªå‹•èªéŸ³å·²é—œé–‰ã€‚");
});

/* ===== Buttons ===== */
$("btnSpeak").addEventListener("click", csTeach);
$("btnCSQuick").addEventListener("click", csTeach);
$("btnCSExplain").addEventListener("click", csRules);
$("btnCSWallet").addEventListener("click", csWallet);

$("btnWish").addEventListener("click", placeWish);
$("btnSimTick").addEventListener("click", manualTick);
$("btnSaveNote").addEventListener("click", saveNote);
$("btnPhoto").addEventListener("click", takePhoto);

$("btnConnect").addEventListener("click", connectWallet);
$("btnConnect2").addEventListener("click", connectWallet);
$("btnAddBSC").addEventListener("click", addBSC);

$("btnResetLocal").addEventListener("click", ()=>{
  localStorage.removeItem(LS_KEY);
  S = defaultState();
  $("note").value = "";
  $("fairySel").value = String(S.fairyId);
  $("degRange").value = "0";
  $("warpRange").value = "1";
  $("photoPrev").src = "";
  addLog("Local state reset.");
  speak("æœ¬æ©Ÿè³‡æ–™å·²é‡ç½®ã€‚");
  saveState(S);
  renderAll();
});

/* ===== init ===== */
(function init(){
  resizeCanvases();
  initStars();
  initFairySelect();
  initSliders();
  $("note").value = S.notes || "";
  syncAutoVoiceBtn();

  // initial render
  renderAll();

  // auto voice on enter (must be user gesture in some browsers; we also show CTA)
  if(S.autoVoice){
    // attempt soft speak; may be blocked until user clicks something
    speak("å»£å¯’å®®ä¸€å…­å…«å…«å…«ï¼Œä¸ƒä»™å¥³é£›ç¢Ÿé§•é§›è‰™å·²é–‹å•Ÿã€‚è«‹å…ˆé¸è§’åº¦èˆ‡æ›²é€Ÿã€‚éœ€è¦éŒ¢åŒ…å¯æŒ‰å³ä¸Šé€£æ¥ã€‚");
  }else{
    $("badgeVoice").className = "badge warn";
    $("badgeVoice").innerHTML = "<b>VOICE</b> OFF";
  }

  // gentle loop for visual drift (stars/warp) without changing state
  let t0 = performance.now();
  function anim(t){
    const dt = (t - t0) / 1000;
    t0 = t;
    // small parallax drift by time + angle
    const d = Number(S.deg)||0;
    const rad = d*Math.PI/180;
    const px = Math.cos(rad) + Math.cos(t/1200)*0.06;
    const py = Math.sin(rad) + Math.sin(t/1200)*0.06;
    drawStars(px, py);
    drawWarp(d, Number(S.warp)||1);
    drawBeauty(d, Number(S.warp)||1);
    requestAnimationFrame(anim);
  }
  requestAnimationFrame(anim);

  addLog("Boot OK | 16888 V1.4 loaded.");
})();
</script>

</body>
</html>
