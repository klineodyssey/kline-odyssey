<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>äº”æŒ‡å±±12345æ‚Ÿç©ºè²¡ç¥æ®¿ Â· V6.4 Cosmic Living Temple</title>

<!--
  äº”æŒ‡å±± 12345 æ‚Ÿç©ºè²¡ç¥æ®¿ï¼ˆå‰ç«¯å–®æª”ï¼‰
  V6.4 Cosmic Living Temple (LIVE)
  - åªå¢ä¸æ¸›ï¼šä¿ç•™ã€Œæ‹ç…§/ä¸‹è¼‰ã€è¨±é¡˜/ç•™è¨€ä¸‹è¼‰ã€å®‡å®™å‹•ç•«ã€ç›£å·¥æª¢æŸ¥ã€å·¥ç¨‹é€²åº¦ã€ç‰ˆæœ¬+æ™‚é–“å¸¸é§ã€
  - å°æ¥ Heart åˆç´„ï¼ˆKGEN_TempleHeart_V3_2_2ï¼‰ï¼šheartBalanceWhole/effectiveCapWhole/effectiveFloorWhole/heartbeatClaim/igniteAndClaim/fortuneClaim/vowTo/lightLamp/makeWish
  - æ³¨æ„ï¼šéˆä¸Šäº‹ä»¶ä¸€å®šè¦é€å‡ºäº¤æ˜“ã€‚åˆç´„ä¸æœƒè‡ªå·±ã€Œæ¯å°æ™‚è‡ªå‹•ã€ï¼›è¦ç”¨å®ˆé–€äººè…³æœ¬æˆ–äººå·¥æŒ‰éˆ•é€äº¤æ˜“ã€‚
-->

<style>
  :root{
    --gold:#ffd36a;
    --gold2:#ffb300;
    --bg0:#05060a;
    --bg1:#0a0d16;
    --panel: rgba(8,10,18,0.68);
    --panel2: rgba(10,12,20,0.78);
    --line: rgba(255,211,106,0.42);
    --ok:#7CFF9A;
    --warn:#FFD36A;
    --bad:#FF6B6B;
    --muted:#9aa3b2;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Microsoft JhengHei",system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;
    color:var(--gold);
    background: radial-gradient(1200px 700px at 50% 30%, #141a33 0%, #070812 50%, #000 100%);
    overflow-x:hidden;
  }
  canvas#cosmos{
    position:fixed; inset:0;
    z-index:-2;
  }
  .nebula{
    position:fixed; inset:-20%;
    z-index:-1;
    background:
      radial-gradient(800px 500px at 15% 25%, rgba(123,63,255,0.22), transparent 60%),
      radial-gradient(900px 600px at 85% 35%, rgba(255,160,80,0.18), transparent 62%),
      radial-gradient(700px 500px at 55% 80%, rgba(80,180,255,0.14), transparent 60%);
    filter: blur(16px);
    animation: drift 18s ease-in-out infinite alternate;
    pointer-events:none;
  }
  @keyframes drift{
    from{ transform: translate3d(-1%, -1%, 0) scale(1.02); opacity:.85;}
    to{ transform: translate3d(1%, 1%, 0) scale(1.06); opacity:1;}
  }

  header{
    position:sticky; top:0;
    backdrop-filter: blur(10px);
    background: linear-gradient(180deg, rgba(0,0,0,0.72), rgba(0,0,0,0.2));
    border-bottom: 1px solid rgba(255,211,106,0.22);
    z-index:10;
  }
  .topbar{
    max-width:1100px;
    margin:0 auto;
    padding:14px 14px 10px;
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
  }
  .brand{
    display:flex; gap:12px; align-items:center;
  }
  .seal{
    width:44px; height:44px; border-radius:14px;
    background: radial-gradient(circle at 30% 30%, rgba(255,211,106,1), rgba(255,140,0,0.35) 55%, rgba(0,0,0,0.2) 75%);
    box-shadow: 0 0 28px rgba(255,211,106,0.35);
    border: 1px solid rgba(255,211,106,0.45);
  }
  h1{
    font-size:18px;
    margin:0;
    letter-spacing:.5px;
    text-shadow: 0 0 14px rgba(255,211,106,0.25);
  }
  .sub{
    font-size:12px;
    color:var(--muted);
    margin-top:2px;
  }
  .pill{
    display:inline-flex; gap:8px; align-items:center;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,211,106,0.25);
    background: rgba(0,0,0,0.45);
    color: #e8e8ea;
    font-size:12px;
    white-space:nowrap;
  }
  .pill b{ color:var(--gold); font-weight:800;}
  .wrap{
    max-width:1100px;
    margin: 14px auto 60px;
    padding: 0 14px;
  }

  .grid{
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap:14px;
  }
  @media (max-width: 980px){
    .grid{ grid-template-columns: 1fr; }
  }

  .card{
    background: var(--panel);
    border: 1px solid rgba(255,211,106,0.22);
    border-radius: 18px;
    padding: 14px;
    box-shadow: 0 14px 40px rgba(0,0,0,0.35);
  }
  .card h2{
    margin:0 0 10px;
    font-size:14px;
    letter-spacing:.4px;
    display:flex; align-items:center; justify-content:space-between;
  }
  .card h2 small{ color:var(--muted); font-weight:600; }
  .hr{
    height:1px; background: rgba(255,211,106,0.18); margin:10px 0;
  }

  .btnrow{ display:flex; flex-wrap:wrap; gap:8px; }
  button{
    border-radius: 12px;
    padding: 10px 12px;
    border: 1px solid rgba(255,211,106,0.35);
    background: rgba(0,0,0,0.55);
    color: var(--gold);
    cursor:pointer;
    transition: transform .08s ease, background .2s ease, border-color .2s ease;
    font-weight:800;
  }
  button:hover{ background: rgba(255,211,106,0.12); border-color: rgba(255,211,106,0.55); }
  button:active{ transform: scale(.98); }
  button.primary{
    background: linear-gradient(135deg, rgba(255,211,106,0.25), rgba(255,140,0,0.12));
    border-color: rgba(255,211,106,0.65);
  }
  button.danger{
    border-color: rgba(255,90,90,0.55);
    color:#ffd0d0;
  }
  button.ghost{
    background: transparent;
    border-color: rgba(255,211,106,0.18);
    color: rgba(255,211,106,0.85);
  }
  button:disabled{
    opacity:.5; cursor:not-allowed;
  }

  input, textarea, select{
    width:100%;
    border-radius: 12px;
    border: 1px solid rgba(255,211,106,0.22);
    background: rgba(0,0,0,0.45);
    color: var(--gold);
    padding: 10px 12px;
    outline:none;
  }
  textarea{ min-height: 86px; resize: vertical; }
  label{ display:block; font-size:12px; color:var(--muted); margin: 10px 0 6px; }

  .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  @media (max-width:680px){ .row{ grid-template-columns:1fr; } }

  .status{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  @media (max-width:720px){ .status{ grid-template-columns:1fr; } }
  .stat{
    background: var(--panel2);
    border: 1px solid rgba(255,211,106,0.18);
    border-radius: 14px;
    padding: 10px 12px;
  }
  .stat .k{ font-size:12px; color:var(--muted); }
  .stat .v{ font-size:14px; font-weight:900; margin-top:4px; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  .bar{
    width:100%;
    height: 14px;
    background: rgba(255,255,255,0.08);
    border-radius: 999px;
    overflow:hidden;
    border:1px solid rgba(255,211,106,0.18);
  }
  .bar > div{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, rgba(255,211,106,0.85), rgba(255,140,0,0.75));
    transition: width .8s ease;
  }

  .badge{
    display:inline-flex; align-items:center; gap:8px;
    padding: 6px 10px;
    border-radius: 999px;
    border:1px solid rgba(255,211,106,0.22);
    background: rgba(0,0,0,0.35);
    font-size:12px;
    color:#e8e8ea;
  }
  .dot{
    width:10px; height:10px; border-radius:99px;
    background: rgba(255,255,255,0.25);
    box-shadow: 0 0 14px rgba(255,255,255,0.18);
  }
  .dot.ok{ background: var(--ok); box-shadow: 0 0 14px rgba(124,255,154,.35); }
  .dot.warn{ background: var(--warn); box-shadow: 0 0 14px rgba(255,211,106,.35); }
  .dot.bad{ background: var(--bad); box-shadow: 0 0 14px rgba(255,107,107,.35); }

  .supervisor{
    margin-top:10px;
    border-radius: 16px;
    border:1px dashed rgba(255,211,106,0.25);
    background: rgba(0,0,0,0.35);
    padding: 10px 12px;
    display:none;
  }
  .supervisor.show{ display:block; }
  .checklist{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px;
    margin-top: 8px;
  }
  @media (max-width:820px){ .checklist{ grid-template-columns:1fr; } }
  .item{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px;
    padding: 8px 10px;
    border-radius: 12px;
    border: 1px solid rgba(255,211,106,0.16);
    background: rgba(0,0,0,0.28);
  }
  .item .name{ font-size:12px; color:#d7d7db; }
  .item .value{ font-size:12px; color: var(--muted); }

  .log{
    margin-top:10px;
    padding:10px 12px;
    border-radius: 14px;
    background: rgba(0,0,0,0.5);
    border:1px solid rgba(255,211,106,0.18);
    color:#d9d9df;
    font-size:12px;
    max-height: 220px;
    overflow:auto;
  }

  .media{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    align-items:start;
  }
  @media (max-width:980px){ .media{ grid-template-columns:1fr; } }
  video, canvas{
    width:100%;
    border-radius: 16px;
    border:1px solid rgba(255,211,106,0.22);
    background: rgba(0,0,0,0.55);
  }

  .footer{
    max-width:1100px;
    margin: 18px auto 38px;
    padding: 0 14px;
    color: rgba(230,230,236,0.7);
    font-size:12px;
    text-align:center;
  }
  .footer .sig{
    margin-top:10px;
    color: rgba(255,211,106,0.9);
    white-space: pre-line;
  }

.steps{margin:0;padding-left:18px}
.steps li{margin:8px 0;line-height:1.45}
button.disabled{opacity:.5;cursor:not-allowed;filter:saturate(.6)}

/* V6.4: header alignment */
.brandTitle{display:flex;flex-direction:column;gap:6px;align-items:flex-start;line-height:1}
.brandTitle .t1,.brandTitle .t2,.brandTitle .t3{font-size:28px;font-weight:900;letter-spacing:.6px}
.brandSub{max-width:300px}
/* V6.4: force-show key sections */
#cardTutorial{display:block !important}
#cupHint{display:block}

  /* V6.4 mobile hero fix: keep title block single-column earlier */
  @media (max-width:1100px){
    .hero{ grid-template-columns:1fr !important; }
    .heroRight{ justify-self:start !important; }
  }
  /* V6.4 camera sizing: captured photo matches preview */
  #video, #photo, #wishCanvas{ width:100%; height:auto; }

</style>
</head>

<body>
<canvas id="cosmos"></canvas>
<div class="nebula"></div>

<header>
  <div class="topbar">
    <div class="brand">
  <div class="brandTitle">
    <div class="t1">äº”æŒ‡å±±</div>
    <div class="t2"><span class="mono">12345</span> Â·</div>
    <div class="t3">æ‚Ÿç©ºè²¡ç¥æ®¿</div>
  </div>
  <div class="brandSub">å¿ƒè·³/é»ç«/ç™¼è²¡é‡‘/é»ç‡ˆ/é‚„é¡˜/è¨±é¡˜ï½œä¸ŠéˆÂ·æ‹ç…§/ç•™è¨€/è¨±é¡˜å¯ä¸‹è¼‰</div>
</div>
      <div>
        <h1>äº”æŒ‡å±± 12345 Â· æ‚Ÿç©ºè²¡ç¥æ®¿</h1>
        <div class="sub">V6.1 Cosmic Living Temple Â· å¿ƒè·³/é»ç«/ç™¼è²¡é‡‘/é»ç‡ˆ/é‚„é¡˜/è¨±é¡˜ ä¸Šéˆ Â· æ‹ç…§/ç•™è¨€/è¨±é¡˜å¯ä¸‹è¼‰</div>
      </div>
    </div>
    <div class="pill">
      <span>ç‰ˆæœ¬ <b id="uiVer">V6.4</b></span>
      <span class="mono" id="clock"></span>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <section class="card">
      <h2>ç¥æ®¿æ ¸å¿ƒç‹€æ…‹ <small id="netHint">æœªé€£ç·š</small></h2>

      <div class="btnrow">
        <button class="primary" id="btnConnect">é€£æ¥éŒ¢åŒ…</button>
        <button id="btnSwitch">åˆ‡æ›åˆ° BSC (0x38)</button>
        <button id="btnRefresh">åˆ·æ–°ç‹€æ…‹</button>
        <button class="ghost" id="btnSupervisor">ç›£å·¥æª¢æŸ¥</button>
      </div>

      <div class="hr"></div>

      <div class="row" style="margin-top:10px;">
        <div class="stat">
          <div class="k">å¿ƒè·³å€’æ•¸ï¼ˆä¸‹ä¸€æ¬¡å¯é ˜ï¼‰</div>
          <div class="v mono" id="hbCountdown">â€”</div>
          <div class="k" style="margin-top:8px;">é»ç«å€’æ•¸ï¼ˆUTC 00:00â€“00:10ï¼‰</div>
          <div class="v mono" id="igCountdown">â€”</div>
        </div>
        <div class="stat">
          <div class="k">ä¸‰æ¬¡è–ç›ƒï¼ˆé˜² Botï¼‰</div>
          <div class="v"><span id="cupState" class="mono">0 / 3</span>ã€€<span id="cupHint" class="muted">é€£çºŒæˆåŠŸä¸‰æ¬¡æ‰å¯é ˜ç™¼è²¡é‡‘</span></div>
          <div class="btnrow" style="margin-top:8px;">
            <button id="btnCup">ææ¯ä¸€æ¬¡</button>
            <button class="ghost" id="btnCupReset">é‡ç½®</button>
          </div>
          <div class="k" style="margin-top:8px;">çµæœ</div>
          <div class="v" id="cupLog">â€”</div>
        </div>
      </div>

      <details style="margin-top:10px;">
        <summary class="muted">æ–°æ‰‹å°è¦½ï¼ˆå¾æ²’éŒ¢åŒ…åˆ°é ˜åˆ°ç™¼è²¡é‡‘ï¼‰</summary>
        <div style="margin-top:10px; line-height:1.7;">
          <ol class="muted" style="padding-left:18px;">
            <li>å…ˆå®‰è£éŒ¢åŒ…ï¼šæ‰‹æ©Ÿå»ºè­° MetaMaskã€‚</li>
            <li>é»ã€Œé€£æ¥éŒ¢åŒ…ã€â†’ å…è¨±é€£ç·šã€‚</li>
            <li>é»ã€Œåˆ‡æ›åˆ° BSC (0x38)ã€ã€‚å¦‚æœéŒ¢åŒ…æç¤ºæ–°å¢ç¶²è·¯ï¼Œç…§è‘—åŒæ„ã€‚</li>
            <li>æŠŠ Heart åˆç´„åœ°å€è²¼åˆ°ä¸‹é¢æ¬„ä½ï¼ŒæŒ‰ã€Œä¿å­˜åœ°å€ã€ã€‚</li>
            <li>å…ˆæŒ‰ã€Œææ¯ä¸€æ¬¡ã€ï¼Œé€£çºŒæˆåŠŸä¸‰æ¬¡ï¼ˆ0/3 â†’ 3/3ï¼‰ã€‚</li>
            <li>å›åˆ°ã€Œç™¼è²¡é‡‘ã€å€ï¼Œè¼¸å…¥è¦é ˜çš„æ•¸é‡ï¼ˆ1â€“888ï¼‰ï¼Œå†æŒ‰ã€Œé ˜ç™¼è²¡é‡‘ã€ã€‚</li>
            <li>å¦‚æœè¦é‚„é¡˜è£œè¡€ï¼šåˆ°ã€Œé‚„é¡˜ã€å€è¼¸å…¥æ•¸é‡â†’ å…ˆæŒ‰ã€ŒApproveã€â†’ å†æŒ‰ã€Œé‚„é¡˜ã€ã€‚</li>
            <li>æ‹ç…§ï¼šé»ã€Œé–‹å•Ÿç›¸æ©Ÿã€â†’ã€Œæ‹ç…§ï¼ˆæµ®å°ï¼‰ã€â†’ã€Œä¸‹è¼‰ç…§ç‰‡ã€ã€‚</li>
          </ol>
        </div>
      </details>


      <div class="row">
        <div>
          <label>Heart åˆç´„åœ°å€ï¼ˆéƒ¨ç½²å¾Œè²¼ä¸Šï¼‰</label>
          <input id="heartAddr" class="mono" placeholder="0x..." />
        </div>
        <div>
          <label>å…¬ç›Šè¡€åº« orphanPoolï¼ˆé¡¯ç¤ºç”¨ï¼Œå¯ä¸å¡«ï¼‰</label>
          <input id="orphanAddr" class="mono" placeholder="0xB73D...ï¼ˆå¯ç•™ç©ºï¼‰" />
        </div>
      </div>

      <div class="btnrow" style="margin-top:10px;">
        <button id="btnSave">ä¿å­˜åœ°å€</button>
        <button class="danger" id="btnClear">æ¸…é™¤æœ¬æ©Ÿè¨­å®š</button>
      </div>

      <div class="hr"></div>

      <div class="status">
        <div class="stat">
          <div class="k">éŒ¢åŒ…</div>
          <div class="v mono" id="stWallet">æœªé€£ç·š</div>
        </div>
        <div class="stat">
          <div class="k">éˆ / chainId</div>
          <div class="v mono" id="stChain">â€”</div>
        </div>
        <div class="stat">
          <div class="k">Heart è¡€é‡ï¼ˆheartBalanceWholeï¼‰</div>
          <div class="v mono" id="stHeartBal">â€”</div>
          <div class="bar" style="margin-top:8px;"><div id="barHeart"></div></div>
          <div class="k" style="margin-top:8px;">cap / floor</div>
          <div class="v mono" id="stCapFloor">â€”</div>
        </div>
        <div class="stat">
          <div class="k">å€’æ•¸</div>
          <div class="v" id="stCountdown">â€”</div>
          <div class="k" style="margin-top:8px;">å¯æ“ä½œç‹€æ…‹</div>
          <div class="v" id="stEligibility">â€”</div>
        </div>
      </div>

      <div class="supervisor" id="supervisorBox">
        <div class="badge"><span class="dot" id="dotOverall"></span><span>ç›£å·¥ç¸½æª¢æŸ¥</span><span class="mono" id="supScore">0%</span></div>
        <div style="margin-top:10px;" class="bar"><div id="barSup"></div></div>

        <div class="checklist" id="checklist"></div>

        <div class="log mono" id="log"></div>
      </div>
    </section>

    <section class="card">
      <h2>å„€å¼èˆ‡äº¤æ˜“ <small>æŒ‰ä¸‹å³ä¸Šéˆï¼ˆæœƒç”¢ç”Ÿ tx / eventï¼‰</small></h2>

      <div class="row">
        <div>
          <label>ç™¼è²¡é‡‘ï¼ˆ1ï½888ï¼‰</label>
          <input id="inFortune" type="number" min="1" max="888" value="108" />
          <button class="primary" id="btnFortune" style="margin-top:8px; width:100%;">é ˜ç™¼è²¡é‡‘ï¼ˆä¸Šéˆï¼‰</button>
        </div>
        <div>
          <label>é»ç‡ˆï¼ˆå¤©æ•¸ï¼‰</label>
          <input id="inLampDays" type="number" min="1" max="365" value="7" />
          <button id="btnLamp" style="margin-top:8px; width:100%;">é»ç‡ˆï¼ˆä¸Šéˆï¼‰</button>
        </div>
      </div>

      <div class="row">
        <div>
          <label>å¿ƒè·³ï¼ˆæ¯å°æ™‚ä¸€æ¬¡ï¼‰</label>
          <button class="primary" id="btnHeartbeat" style="width:100%;">å¿ƒè·³ï¼ˆä¸Šéˆ -1/+1 è¦å‰‡ç”±åˆç´„æ±ºå®šï¼‰</button>
        </div>
        <div>
          <label>é»ç«ï¼ˆæ¯æ—¥çª—å£ UTC 00:00â€“00:10ï¼‰</label>
          <button class="primary" id="btnIgnite" style="width:100%;">é»ç«ï¼ˆä¸Šéˆï¼‰</button>
        </div>
      </div>

      <label style="margin-top:12px;">é‚„é¡˜è£œè¡€ï¼ˆvowToï¼šéœ€è¦å…ˆ approve KGENï¼‰</label>
      <div class="row">
        <div>
          <select id="inVowOpt">
            <option value="0">é‚„é¡˜ option=0ï¼ˆå–®æ± ï¼šä¸åˆ†æµï¼‰</option>
            <option value="1">option=1ï¼ˆé ç•™ï¼‰</option>
            <option value="2">option=2ï¼ˆé ç•™ï¼‰</option>
          </select>
        </div>
        <div>
          <input id="inVowAmt" type="number" min="1" value="8" />
        </div>
      </div>
      <div class="btnrow" style="margin-top:8px;">
        <button id="btnApprove">å…ˆæ‰¹å‡†ï¼ˆapprove Heartï¼‰</button>
        <button class="primary" id="btnVow">é‚„é¡˜å…¥é‡‘ï¼ˆä¸Šéˆï¼‰</button>
      </div>

      <div class="hr"></div>

      <h2 style="margin-top:0;">è¨±é¡˜ã€ç•™è¨€ã€ç•™å½± <small>å¯ä¸‹è¼‰ä¿å­˜</small></h2>

      <label>è¨±é¡˜å…§å®¹ï¼ˆæœƒ keccak256 å¾Œä¸Šéˆ makeWish(hash)ï¼‰</label>
      <textarea id="wishText" placeholder="å¯«ä¸‹ä½ çš„é¡˜æœ›â€¦ï¼ˆä¸ç›´æ¥ä¸Šéˆæ–‡å­—ï¼Œåªä¸Šéˆ hashï¼‰"></textarea>
      <div class="btnrow" style="margin-top:8px;">
        <button class="primary" id="btnWish">è¨±é¡˜ä¸Šéˆ</button>
        <button id="btnWishCert">ç”Ÿæˆé¡˜æœ›è­‰æ›¸</button>
        <button id="btnWishDownload">ä¸‹è¼‰é¡˜æœ›è­‰æ›¸</button>
      </div>

      <label style="margin-top:12px;">ç•™è¨€ï¼ˆæœ¬æ©Ÿå­˜æª”ï¼Œå¯ä¸‹è¼‰ï¼‰</label>
      <textarea id="msgText" placeholder="å¯«ä¸‹ç•™è¨€â€¦ï¼ˆæœ¬æ©Ÿä¿å­˜ï¼‰"></textarea>
      <div class="btnrow" style="margin-top:8px;">
        <button id="btnMsgSave">å„²å­˜ç•™è¨€</button>
        <button id="btnMsgDownload">ä¸‹è¼‰ç•™è¨€ TXT</button>
        <button class="danger" id="btnMsgClear">æ¸…ç©ºç•™è¨€</button>
      </div>

      <div class="hr"></div>

      <div class="media">
        <div>
          <label>ç›¸æ©Ÿï¼ˆä¿¡çœ¾å¯è‡ªçœ‹ï¼‰</label>
          <video id="video" autoplay playsinline muted></video>
          <div class="btnrow" style="margin-top:8px;">
            <button id="btnCam">é–‹å•Ÿç›¸æ©Ÿ</button>
            <button class="primary" id="btnShot">æ‹ç…§ï¼ˆæµ®å°ï¼‰</button>
            <button id="btnShotDownload">ä¸‹è¼‰ç…§ç‰‡</button>
          </div>
          <canvas id="photo" width="800" height="450" style="margin-top:10px;"></canvas>
        </div>
        <div>
          <label>é¡˜æœ›è­‰æ›¸ç•«å¸ƒ</label>
          <canvas id="wishCanvas" width="800" height="450"></canvas>
          <div class="k" style="margin-top:8px; color:var(--muted);">
            è­‰æ›¸æœƒåŒ…å«ï¼šé¡˜æœ›æ‘˜è¦ã€æ™‚é–“æˆ³ã€éŒ¢åŒ…åœ°å€ï¼ˆè‹¥å·²é€£ç·šï¼‰
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="badge">
        <span class="dot" id="dotEthers"></span><span>ethers.js</span><span class="mono" id="ethersVer">â€”</span>
      </div>

      <div class="hr"></div>
      <h2 style="margin-top:0;">AI å®¢æœä»™å¥³ï¼ˆæœ¬æ©ŸèªéŸ³ï¼‹ç•™è¨€å­˜æª”ï¼‰ <small>ä¸Šéˆäº¤æ˜“ç”±ä½ æŒ‰å„€å¼æŒ‰éˆ•</small></h2>
      <label>å®¢æœå°è©±ï¼ˆæœ¬æ©Ÿä¿å­˜ï¼Œå¯ä¸‹è¼‰ï¼‰</label>
      <textarea id="chatText" placeholder="è¼¸å…¥ä½ æƒ³å°ä»™å¥³èªªçš„è©±â€¦ï¼ˆæœ¬æ©Ÿä¿å­˜ï¼‰"></textarea>
      <div class="btnrow" style="margin-top:8px;">
        <button id="btnChatSave">å„²å­˜å®¢æœå°è©±</button>
        <button class="primary" id="btnChatSpeak">ä»™å¥³èªéŸ³å›è¦†</button>
        <button id="btnChatDownload">ä¸‹è¼‰å®¢æœå°è©± TXT</button>
        <button class="danger" id="btnChatClear">æ¸…ç©ºå®¢æœå°è©±</button>
      </div>

      <div class="hr"></div>
      <div class="btnrow">
        <button class="ghost" id="btnDownloadAll">ä¸‹è¼‰ç¥æ®¿å…¨éƒ¨ç´€éŒ„ï¼ˆJSONï¼‰</button>
      </div>


    </section>
  </div>
</div>

<div class="footer">
  <div>æé†’ï¼šéˆä¸Šäº‹ä»¶ä¸€å®šè¦é€å‡ºäº¤æ˜“ã€‚è‹¥ä½ è¦ã€Œæ¯å°æ™‚è‡ªå‹•å¿ƒè·³ / æ¯æ—¥è‡ªå‹•é»ç«ã€ï¼Œè«‹ç”¨å®ˆé–€äººè…³æœ¬æˆ–æ’ç¨‹é€äº¤æ˜“ã€‚</div>
  <div class="sig">PrimeForge ä»¥æ¯æ©Ÿä¹‹åï¼Œé–‹å•Ÿé‡‘èç”Ÿå‘½ã€‚
èŠ±æœå±±å°ç£ãƒ»ä¿¡å¿µä¸æ»…ãƒ»å¸‚å ´ç„¡ç•Œã€‚
Where the Market Becomes the Myth.
â€”â€” æ¨‚å¤©å¸

#KLINE #KlineAppGame #KGEN
#AIä¿®è¡Œ #å¸‚å ´å®‡å®™ #é‡‘èç”Ÿå‘½é«”
#WhereTheMarketBecomesTheMyth</div>
</div>

<script src="../../assets/js/ethers-5.7.2.umd.min.js"></script>

<script>
const UI_VERSION = "V6.4";
const UI_BUILD = "COSMIC_CHAINREADY";
const BSC_CHAIN_ID_HEX = "0x38";
const BSC_CHAIN_ID_DEC = 56;

const $ = (id)=>document.getElementById(id);

const state = {
  provider: null,
  signer: null,
  account: null,
  chainId: null,
  heart: null,
  cfg: { heartAddr: "", orphanAddr: "" },
  log: []
};

function linkifyTx(s){
  return String(s || "").replace(/(0x[a-fA-F0-9]{64})/g, (m)=>`${m} (BscScan: https://bscscan.com/tx/${m})`);
}
function logLine(msg){
  const t = new Date().toLocaleString();
  const line = `[${t}] ${linkifyTx(msg)}`;
  state.log.unshift(line);
  const el = $("log");
  if(el) el.textContent = state.log.slice(0,120).join("\n");
}

(function hookConsole(){
  const origErr = console.error;
  console.error = function(...args){
    try{ logLine("console.error: " + args.map(a=>String(a)).join(" ")); }catch(e){}
    origErr.apply(console, args);
  }
  window.addEventListener("error", (e)=> logLine("window.error: " + (e?.message || "unknown")));
  window.addEventListener("unhandledrejection", (e)=> logLine("unhandledrejection: " + (e?.reason?.message || e?.reason || "unknown")));
})();

function setNetHint(){
  const hint = $("netHint");
  if(!hint) return;
  hint.textContent = state.account ? "å·²é€£ç·š" : "æœªé€£ç·š";
}

function setDot(el, level){
  el.classList.remove("ok","warn","bad");
  if(level==="ok") el.classList.add("ok");
  else if(level==="warn") el.classList.add("warn");
  else if(level==="bad") el.classList.add("bad");
}

function shortAddr(a){
  if(!a) return "â€”";
  return a.slice(0,6) + "â€¦" + a.slice(-4);
}


function applyQueryConfig(){
  try{
    const u = new URL(location.href);
    const h = (u.searchParams.get("heart") || "").trim();
    const o = (u.searchParams.get("orphan") || "").trim();
    let changed = false;
    if(h && $("heartAddr") && $("heartAddr").value !== h){ $("heartAddr").value = h; changed = true; }
    if(o && $("orphanAddr") && $("orphanAddr").value !== o){ $("orphanAddr").value = o; changed = true; }
    if(changed){
      saveCfg();
      logLine("å·²å¥—ç”¨ç¶²å€åƒæ•¸ï¼ˆheart/orphanï¼‰");
    }
  }catch(e){}
}

function chatKey(){ return "KLINE_TEMPLE_12345_CHAT_V6_1"; }
function loadChat(){ const v = localStorage.getItem(chatKey()) || ""; const el = $("chatText"); if(el) el.value = v; }
function saveChat(){ localStorage.setItem(chatKey(), $("chatText").value || ""); logLine("å®¢æœå°è©±å·²å„²å­˜ï¼ˆæœ¬æ©Ÿï¼‰"); }
function clearChat(){ localStorage.removeItem(chatKey()); $("chatText").value=""; logLine("å®¢æœå°è©±å·²æ¸…ç©º"); }
function downloadChat(){
  const content = $("chatText").value || "";
  const header = `äº”æŒ‡å±±12345æ‚Ÿç©ºè²¡ç¥æ®¿ï½œAIå®¢æœå°è©±\næ™‚é–“: ${new Date().toLocaleString()}\néŒ¢åŒ…: ${state.account||"æœªé€£ç·š"}\nUI: ${UI_VERSION} (${UI_BUILD})\n\n`;
  downloadText("wuzhishan_12345_ai_service_chat.txt", header + content);
}
function speakGoddess(){
  const text = ($("chatText").value || "").trim();
  const base = text ? `æˆ‘è½è¦‹äº†ã€‚${text}` : "æ­¡è¿å›åˆ°äº”æŒ‡å±±æ‚Ÿç©ºè²¡ç¥æ®¿ã€‚è«‹å…ˆé€£æ¥éŒ¢åŒ…ï¼Œå†é€²è¡Œå¿ƒè·³èˆ‡é»ç«ã€‚";
  if(!("speechSynthesis" in window)){ alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³"); return; }
  const u = new SpeechSynthesisUtterance(base);
  u.lang = "zh-TW";
  u.rate = 1.0;
  u.pitch = 1.1;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
  logLine("ä»™å¥³èªéŸ³å·²æ’­æ”¾ï¼ˆæœ¬æ©Ÿï¼‰");
}

function downloadAll(){
  const payload = {
    temple: "wuzhishan_12345",
    uiVersion: UI_VERSION,
    uiBuild: UI_BUILD,
    exportedAt: new Date().toISOString(),
    wallet: state.account || null,
    chainId: state.chainId || null,
    config: { heartAddr: ($("heartAddr").value||"").trim(), orphanAddr: ($("orphanAddr").value||"").trim() },
    message: $("msgText")?.value || "",
    chat: $("chatText")?.value || "",
    wishText: $("wishText")?.value || "",
    logs: state.log.slice(0,400)
  };
  downloadText("wuzhishan_12345_export.json", JSON.stringify(payload, null, 2));
  logLine("å·²ä¸‹è¼‰å…¨éƒ¨ç´€éŒ„ï¼ˆJSONï¼‰");
}

// ===== ä¸‰æ¬¡è–ç›ƒï¼ˆå‰ç«¯è§£é–ï¼‰=====
function cupKey(){ return "KLINE_TEMPLE_12345_CUP_V6_3"; }
function todayKey(){ return Math.floor(Date.now()/86400000); } // local day index
function loadCup(){
  const raw = localStorage.getItem(cupKey());
  let st = {day: todayKey(), streak:0, unlocked:false};
  try{ if(raw){ st = Object.assign(st, JSON.parse(raw)); } }catch(e){}
  if(st.day !== todayKey()){ st.day = todayKey(); st.streak = 0; st.unlocked = false; }
  state.cup = st;
  renderCup();
  enforceFortuneGate();
}
function saveCup(){
  localStorage.setItem(cupKey(), JSON.stringify(state.cup||{}));
  renderCup();
  enforceFortuneGate();
}
function renderCup(){
  const st = state.cup || {streak:0, unlocked:false};
  $("cupStreak") && ($("cupStreak").textContent = `${st.streak||0} / 3`);
  $("cupUnlocked") && ($("cupUnlocked").textContent = st.unlocked ? "æ˜¯" : "å¦");
}
function enforceFortuneGate(){
  const btn = $("btnFortune");
  if(!btn) return;
  const ok = !!(state.cup && state.cup.unlocked);
  btn.disabled = !ok;
  btn.classList.toggle("disabled", !ok);
  btn.title = ok ? "" : "éœ€å…ˆå®Œæˆä¸‰æ¬¡è–ç›ƒè§£é–";
}
function tossCup(){
  const p = 0.5; // è–ç›ƒæ©Ÿç‡ï¼ˆå…¬å¹³ç‰ˆï¼‰
  const win = Math.random() < p;
  const st = state.cup || {day: todayKey(), streak:0, unlocked:false};
  if(st.unlocked){
    $("cupResult") && ($("cupResult").textContent = "å·²è§£é–ï¼ˆä»Šæ—¥ï¼‰");
    return;
  }
  if(win){
    st.streak = (st.streak||0) + 1;
    $("cupResult") && ($("cupResult").textContent = "è–ç›ƒ âœ…");
    if(st.streak >= 3){
      st.unlocked = true;
      $("cupResult") && ($("cupResult").textContent = "ä¸‰è–ç›ƒé”æˆ Â· å·²è§£é– ğŸ‰");
      logLine("ä¸‰æ¬¡è–ç›ƒå®Œæˆï¼šå·²è§£é–ä»Šæ—¥ç™¼è²¡é‡‘");
    }
  }else{
    st.streak = 0;
    $("cupResult") && ($("cupResult").textContent = "ç¬‘æ¯ âŒï¼ˆé€£å‹æ­¸é›¶ï¼‰");
  }
  state.cup = st;
  saveCup();
}
function resetCup(){
  state.cup = {day: todayKey(), streak:0, unlocked:false};
  $("cupResult") && ($("cupResult").textContent = "â€”");
  saveCup();
}

// ===== æ–°æ‰‹å°è¦½å·¥å…· =====
function tutorialCheck(){
  const parts = [];
  parts.push(`éŒ¢åŒ…ï¼š${state.account ? "å·²é€£ç·š" : "æœªé€£ç·š"}`);
  parts.push(`éˆï¼š${state.chainId===56 ? "BSC 56 âœ…" : (state.chainId?("chainId="+state.chainId+" âŒ"):"æœªåµæ¸¬")}`);
  parts.push(`Heartï¼š${($("heartAddr").value||"").trim() ? "å·²å¡«" : "æœªå¡«"}`);
  parts.push(`ethersï¼š${state.ethersOk ? "OK" : "æœªè¼‰å…¥"}`);
  const gate = (state.cup && state.cup.unlocked) ? "å·²è§£é– âœ…" : "æœªè§£é–ï¼ˆéœ€ä¸‰è–ç›ƒï¼‰";
  parts.push(`ç™¼è²¡é‡‘è§£é–ï¼š${gate}`);
  const s = parts.join(" Â· ");
  $("tutorialStatus") && ($("tutorialStatus").textContent = s);
  logLine("æ–°æ‰‹æª¢æŸ¥ï¼š" + s);
}
function tutorialCopy(){
  const txt = [
    "äº”æŒ‡å±±12345æ‚Ÿç©ºè²¡ç¥æ®¿ï½œæ–°æ‰‹æ•™å­¸ï¼ˆç…§åšå°±æœƒï¼‰",
    "1) å®‰è£ MetaMask å»ºç«‹éŒ¢åŒ…ä¸¦å‚™ä»½åŠ©è¨˜è©ï¼ˆä¸è¦çµ¦ä»»ä½•äººï¼‰",
    "2) åˆ‡åˆ° BSC ä¸»ç¶²ï¼ˆchainId 56 / 0x38ï¼‰",
    "3) æº–å‚™å°‘é‡ BNB ç•¶ Gas",
    "4) é€£æ¥éŒ¢åŒ…",
    "5) è²¼ä¸Š Heart åˆç´„åœ°å€ä¸¦åˆ·æ–°ç‹€æ…‹",
    "6) å…ˆå®Œæˆä¸‰æ¬¡è–ç›ƒè§£é–ï¼ˆæ“²ç­Šé€£çºŒ 3 æ¬¡è–ç›ƒï¼‰",
    "7) è¼¸å…¥ 1ï½888 è‡ªå¡«é‡‘é¡ â†’ é ˜ç™¼è²¡é‡‘ï¼ˆä¸Šéˆäº¤æ˜“ï¼‰",
    "8) æ‹ç…§ç•™å¿µä¸¦ä¸‹è¼‰ï¼ˆæœ‰ç‰ˆæœ¬/æ™‚é–“/éŒ¢åŒ…çŸ­ç¢¼æµ®å°ï¼‰"
  ].join("\n");
  navigator.clipboard.writeText(txt).then(()=>{
    logLine("å·²è¤‡è£½æ–°æ‰‹æ•™å­¸");
    $("tutorialStatus") && ($("tutorialStatus").textContent = "å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿");
  }).catch(()=>{
    alert("ç„¡æ³•å¯«å…¥å‰ªè²¼ç°¿ï¼Œè«‹æ‰‹å‹•è¤‡è£½");
  });
}


function loadCfg(){
  try{
    const raw = localStorage.getItem("KLINE_TEMPLE_12345_CFG_V6_1");
    if(raw){
      const obj = JSON.parse(raw);
      state.cfg.heartAddr = obj.heartAddr || "";
      state.cfg.orphanAddr = obj.orphanAddr || "";
    }
  }catch(e){}
  $("heartAddr").value = state.cfg.heartAddr || "";
  $("orphanAddr").value = state.cfg.orphanAddr || "";
}
function saveCfg(){
  state.cfg.heartAddr = ($("heartAddr").value || "").trim();
  state.cfg.orphanAddr = ($("orphanAddr").value || "").trim();
  localStorage.setItem("KLINE_TEMPLE_12345_CFG_V6_1", JSON.stringify(state.cfg));
  logLine("å·²ä¿å­˜æœ¬æ©Ÿè¨­å®š");
}
function clearCfg(){
  localStorage.removeItem("KLINE_TEMPLE_12345_CFG_V6_1");
  state.cfg.heartAddr = ""; state.cfg.orphanAddr="";
  $("heartAddr").value = ""; $("orphanAddr").value = "";
  logLine("å·²æ¸…é™¤æœ¬æ©Ÿè¨­å®š");
}

/* Cosmos */
const c = $("cosmos");
const ctx = c.getContext("2d");
let W=0,H=0;
function resize(){ W = c.width = window.innerWidth; H = c.height = window.innerHeight; }
window.addEventListener("resize", resize); resize();

const stars = Array.from({length: 260}).map(()=>({
  x: Math.random()*W,
  y: Math.random()*H,
  r: Math.random()*1.8 + 0.2,
  v: Math.random()*0.25 + 0.05,
  a: Math.random()*0.6 + 0.2
}));
let pulses = [];
function pulse(){ pulses.push({t:0, x: W*0.5, y: H*0.35}); }
function draw(){
  ctx.clearRect(0,0,W,H);
  for(const s of stars){
    s.y += s.v;
    if(s.y>H){ s.y=0; s.x=Math.random()*W; }
    ctx.globalAlpha = s.a;
    ctx.fillStyle = "#ffffff";
    ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
  }
  ctx.globalAlpha = 1;
  pulses = pulses.filter(p=>p.t<1.0);
  for(const p of pulses){
    p.t += 0.012;
    const radius = 40 + p.t*520;
    const alpha = Math.max(0, 0.18 - p.t*0.18);
    const grd = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,radius);
    grd.addColorStop(0, `rgba(255,211,106,${alpha})`);
    grd.addColorStop(1, `rgba(255,211,106,0)`);
    ctx.fillStyle = grd;
    ctx.beginPath(); ctx.arc(p.x,p.y,radius,0,Math.PI*2); ctx.fill();
  }
  requestAnimationFrame(draw);
}
draw();

setInterval(()=>{ $("clock").textContent = new Date().toLocaleString(); }, 500);

function initEthersBadge(){
  const ok = (typeof ethers !== "undefined");
  setDot($("dotEthers"), ok ? "ok" : "bad");
  $("ethersVer").textContent = ok ? (ethers.version || "v5") : "missing";
  if(!ok) logLine("ethers.js æœªè¼‰å…¥ï¼šè«‹ç¢ºèª ../../assets/js/ethers-5.7.2.umd.min.js å­˜åœ¨");
}
initEthersBadge();

const HEART_ABI = [
  "function kgen() view returns (address)",
  "function orphanPool() view returns (address)",
  "function heartBalanceWhole() view returns (uint256)",
  "function effectiveCapWhole() view returns (uint256)",
  "function effectiveFloorWhole() view returns (uint256)",
  "function igniteWindowStart() view returns (uint256)",
  "function igniteWindowEnd() view returns (uint256)",
  "function heartbeatCooldownSeconds() view returns (uint256)",
  "function fortuneCooldownSeconds() view returns (uint256)",
  "function lampPricePerDay() view returns (uint256)",
  "function lastHeartbeatAt(address) view returns (uint256)",
  "function lastFortuneAt(address) view returns (uint256)",
  "function lastIgniteDay(address) view returns (uint256)",
  "function lampExpireAt(address) view returns (uint256)",
  "function currentDayIndex() view returns (uint256)",
  "function timeOfDaySeconds() view returns (uint256)",
  "function fortuneClaim(uint256 amountWhole)",
  "function heartbeatClaim()",
  "function igniteAndClaim()",
  "function vowTo(uint8 option, uint256 amountWhole)",
  "function lightLamp(uint256 daysAdded)",
  "function makeWish(bytes32 wishHash)",
  "event FortuneClaimed(address indexed user, uint256 amount, uint256 indexed epochIndex)",
  "event HeartbeatClaimed(address indexed user, uint256 reward)",
  "event IgniteClaimed(address indexed user, uint256 reward, uint256 indexed dayIndex)",
  "event Vowed(address indexed user, uint8 option, uint256 amount)",
  "event LampLit(address indexed user, uint256 daysAdded, uint256 paid, uint256 newExpireAt)",
  "event WishMade(address indexed user, bytes32 wishHash)"
];

const ERC20_ABI = [
  "function decimals() view returns (uint8)",
  "function balanceOf(address) view returns (uint256)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function approve(address spender, uint256 amount) returns (bool)"
];

function isAddr(a){ try{ return ethers.utils.isAddress(a); }catch(e){ return false; } }

async function connect(){
  if(typeof ethers === "undefined") return;
  if(!window.ethereum){ alert("æ‰¾ä¸åˆ°éŒ¢åŒ…ï¼ˆwindow.ethereumï¼‰ã€‚è«‹ç”¨æ‰‹æ©Ÿ/ç€è¦½å™¨éŒ¢åŒ…æ‰“é–‹ã€‚"); return; }
  state.ethersOk = true;
  state.provider = new ethers.providers.Web3Provider(window.ethereum, "any");
  await state.provider.send("eth_requestAccounts", []);
  state.signer = state.provider.getSigner();
  state.account = await state.signer.getAddress();
  const net = await state.provider.getNetwork();
  state.chainId = net.chainId;

  $("stWallet").textContent = state.account;
  $("stChain").textContent = `${net.chainId} (${net.chainId===56?"BSC":"éBSC"})`;
  setNetHint();
  logLine("éŒ¢åŒ…å·²é€£ç·šï¼š" + state.account);

  window.ethereum.on?.("chainChanged", ()=> setTimeout(()=>location.reload(), 300));
  window.ethereum.on?.("accountsChanged", ()=> setTimeout(()=>location.reload(), 300));

  await refreshAll();
}

async function switchToBSC(){
  if(!window.ethereum) return;
  try{
    await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId: BSC_CHAIN_ID_HEX }]});
  }catch(e){
    alert("åˆ‡éˆå¤±æ•—ï¼šè«‹åœ¨éŒ¢åŒ…æ‰‹å‹•åˆ‡åˆ° BNB Chain (BSC) ä¸»ç¶²");
    logLine("åˆ‡éˆå¤±æ•—ï¼š" + (e?.message || e));
  }
}

function getHeartAddr(){ return ($("heartAddr").value || "").trim(); }

async function buildContracts(){
  const heartAddr = getHeartAddr();
  if(!isAddr(heartAddr)){ state.heart = null; return; }
  state.heart = new ethers.Contract(heartAddr, HEART_ABI, state.signer || state.provider);
}

function fmtWhole(n){ try{ return n.toString(); }catch(e){ return String(n); } }

function secondsToHMS(sec){
  sec = Math.max(0, Math.floor(sec));
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  const pad = (v)=> String(v).padStart(2,"0");
  if(h>0) return `${pad(h)}:${pad(m)}:${pad(s)}`;
  return `${pad(m)}:${pad(s)}`;
}

async function refreshAll(){
  await buildContracts();
  await refreshStatus();
  await updateSupervisor();
}

async function refreshStatus(){
  const heartAddr = getHeartAddr();
  if(state.account) $("stWallet").textContent = state.account;
  if(state.chainId!=null) $("stChain").textContent = `${state.chainId} (${state.chainId===56?"BSC":"éBSC"})`;

  if(!state.provider || !state.account){
    $("stCountdown").textContent = "è«‹å…ˆé€£æ¥éŒ¢åŒ…";
    $("stEligibility").textContent = "â€”";
    return;
  }
  if(state.chainId !== 56){
    $("stCountdown").textContent = "è«‹åˆ‡æ›åˆ° BSC (0x38)";
    $("stEligibility").textContent = "â€”";
    return;
  }
  if(!isAddr(heartAddr)){
    $("stCountdown").textContent = "è«‹å¡«å…¥ Heart åˆç´„åœ°å€";
    $("stEligibility").textContent = "â€”";
    return;
  }
  if(!state.heart){
    $("stCountdown").textContent = "Heart æœªå°±ç·’";
    $("stEligibility").textContent = "â€”";
    return;
  }

  try{
    const [
      balWhole, capWhole, floorWhole,
      igniteStart, igniteEnd,
      hbCd, fcCd,
      lastHbAt, lastFcAt, lastIgnDay,
      lampExp,
      dayIdx, tod
    ] = await Promise.all([
      state.heart.heartBalanceWhole(),
      state.heart.effectiveCapWhole(),
      state.heart.effectiveFloorWhole(),
      state.heart.igniteWindowStart(),
      state.heart.igniteWindowEnd(),
      state.heart.heartbeatCooldownSeconds(),
      state.heart.fortuneCooldownSeconds(),
      state.heart.lastHeartbeatAt(state.account),
      state.heart.lastFortuneAt(state.account),
      state.heart.lastIgniteDay(state.account),
      state.heart.lampExpireAt(state.account),
      state.heart.currentDayIndex(),
      state.heart.timeOfDaySeconds()
    ]);

    $("stHeartBal").textContent = fmtWhole(balWhole);
    $("stCapFloor").textContent = `${fmtWhole(capWhole)} / ${fmtWhole(floorWhole)}`;

    const bal = Number(balWhole.toString());
    const cap = Number(capWhole.toString());
    const pct = cap>0 ? Math.min(100, Math.max(0, bal/cap*100)) : 0;
    $("barHeart").style.width = pct.toFixed(2) + "%";

    const now = Math.floor(Date.now()/1000);

    const hbNext = Number(lastHbAt.toString()) + Number(hbCd.toString());
    const hbRemain = Math.max(0, hbNext - now);

    const fcNext = Number(lastFcAt.toString()) + Number(fcCd.toString());
    const fcRemain = Math.max(0, fcNext - now);

    const curDay = Number(dayIdx.toString());
    const ignDay = Number(lastIgnDay.toString());
    const ignUsed = (ignDay === curDay);

    const todSec = Number(tod.toString());
    const inWindow = (todSec >= Number(igniteStart.toString()) && todSec <= Number(igniteEnd.toString()));
    const ignRemain = inWindow ? 0 : calcIgniteWindowRemainUTC(Number(igniteStart.toString()), now);

    const lampExpAt = Number(lampExp.toString());
    const lampRemain = Math.max(0, lampExpAt - now);

    $("stCountdown").innerHTML =
      `å¿ƒè·³å€’æ•¸ï¼š<span class="mono">${secondsToHMS(hbRemain)}</span><br/>`+
      `é»ç«å€’æ•¸ï¼š<span class="mono">${inWindow ? "çª—å£å·²é–‹" : secondsToHMS(ignRemain)}</span><br/>`+
      `é»ç‡ˆåˆ°æœŸï¼š<span class="mono">${lampRemain>0 ? secondsToHMS(lampRemain) : "æœªé»ç‡ˆ/å·²åˆ°æœŸ"}</span>`;

    $("stEligibility").innerHTML =
      `å¿ƒè·³ï¼š${hbRemain===0 ? "å¯é ˜" : "å†·å»ä¸­"}<br/>`+
      `é»ç«ï¼š${(!ignUsed && inWindow) ? "å¯é»ç«" : (ignUsed ? "ä»Šæ—¥å·²é»ç«" : "çª—å£æœªé–‹")}<br/>`+
      `ç™¼è²¡é‡‘ï¼š${fcRemain===0 ? "å¯é ˜" : "å†·å»ä¸­"}`;

    $("btnHeartbeat").disabled = hbRemain!==0;
    $("btnIgnite").disabled = !(inWindow && !ignUsed);
    $("btnFortune").disabled = fcRemain!==0;

    if(hbRemain===0) pulse();

  }catch(e){
    logLine("åˆ·æ–°ç‹€æ…‹å¤±æ•—ï¼š" + (e?.message || e));
    $("stCountdown").textContent = "è®€å–å¤±æ•—ï¼ˆè«‹é–‹ç›£å·¥æª¢æŸ¥çœ‹åŸå› ï¼‰";
  }
}

function calcIgniteWindowRemainUTC(windowStartSec, nowEpochSec){
  const now = new Date(nowEpochSec*1000);
  const utcY = now.getUTCFullYear(), utcM = now.getUTCMonth(), utcD = now.getUTCDate();
  const dayStart = Date.UTC(utcY, utcM, utcD, 0,0,0)/1000;
  const nextStart = dayStart + windowStartSec;
  if(nowEpochSec <= nextStart) return nextStart - nowEpochSec;
  const nextDayStart = dayStart + 86400;
  return (nextDayStart + windowStartSec) - nowEpochSec;
}

async function ensureReady(){
  if(!state.provider || !state.account) throw new Error("æœªé€£æ¥éŒ¢åŒ…");
  if(state.chainId !== 56) throw new Error("è«‹åˆ‡åˆ° BSC (0x38)");
  const heartAddr = getHeartAddr();
  if(!isAddr(heartAddr)) throw new Error("Heart åœ°å€ä¸åˆæ³•");
  if(!state.heart) await buildContracts();
  if(!state.heart) throw new Error("Heart æœªå°±ç·’");
  if(!state.signer) state.signer = state.provider.getSigner();
}

async function sendTx(label, fn){
  try{
    await ensureReady();
    logLine(`${label}ï¼šé€å‡ºäº¤æ˜“ä¸­â€¦`);
    const tx = await fn();
    logLine(`${label}ï¼štx=${tx.hash}`);
    const r = await tx.wait(1);
    logLine(`${label}ï¼šconfirmed block=${r.blockNumber}`);
    pulse();
    await refreshAll();
  }catch(e){
    logLine(`${label}ï¼šå¤±æ•— -> ${e?.reason || e?.message || e}`);
    alert(`${label} å¤±æ•—ï¼š\n${e?.reason || e?.message || e}`);
  }
}

async function doHeartbeat(){ await sendTx("å¿ƒè·³", ()=> state.heart.connect(state.signer).heartbeatClaim()); }
async function doIgnite(){ await sendTx("é»ç«", ()=> state.heart.connect(state.signer).igniteAndClaim()); }
async function doFortune(){
  const v = Number($("inFortune").value || "0");
  if(!(v>=1 && v<=888)) { alert("ç™¼è²¡é‡‘è«‹å¡« 1ï½888"); return; }
  await sendTx("é ˜ç™¼è²¡é‡‘", ()=> state.heart.connect(state.signer).fortuneClaim(v));
}
async function doLamp(){
  const d = Number($("inLampDays").value || "0");
  if(!(d>=1 && d<=365)) { alert("é»ç‡ˆå¤©æ•¸ 1ï½365"); return; }
  await sendTx("é»ç‡ˆ", ()=> state.heart.connect(state.signer).lightLamp(d));
}
async function doWish(){
  const text = ($("wishText").value || "").trim();
  if(!text){ alert("è«‹è¼¸å…¥é¡˜æœ›"); return; }
  await ensureReady();
  const hash = ethers.utils.keccak256(ethers.utils.toUtf8Bytes(text));
  await sendTx("è¨±é¡˜ä¸Šéˆ", ()=> state.heart.connect(state.signer).makeWish(hash));
}
async function doApprove(){
  await ensureReady();
  try{
    const tokenAddr = await state.heart.kgen();
    if(!isAddr(tokenAddr)) throw new Error("è®€å– token å¤±æ•—");
    const token = new ethers.Contract(tokenAddr, ERC20_ABI, state.signer);
    const amtWhole = Number($("inVowAmt").value || "0");
    if(!(amtWhole>0)) { alert("é‚„é¡˜é‡‘é¡éœ€ > 0"); return; }
    const dec = await token.decimals();
    const amt = ethers.utils.parseUnits(String(amtWhole), dec);
    await sendTx("Approve", ()=> token.approve(getHeartAddr(), amt));
  }catch(e){
    logLine("Approve å¤±æ•—ï¼š" + (e?.message || e));
    alert("Approve å¤±æ•—ï¼š" + (e?.message || e));
  }
}
async function doVow(){
  const opt = Number($("inVowOpt").value || "0");
  const amt = Number($("inVowAmt").value || "0");
  if(!(amt>0)) { alert("é‚„é¡˜é‡‘é¡éœ€ > 0"); return; }
  await sendTx("é‚„é¡˜å…¥é‡‘", ()=> state.heart.connect(state.signer).vowTo(opt, amt));
}

function checklistItem(name, level, value){
  const div = document.createElement("div");
  div.className = "item";
  const left = document.createElement("div");
  left.className = "name";
  left.textContent = name;
  const right = document.createElement("div");
  right.className = "value mono";
  right.textContent = value || "";
  const badge = document.createElement("span");
  badge.className = "badge";
  const dot = document.createElement("span");
  dot.className = "dot";
  setDot(dot, level);
  badge.appendChild(dot);
  badge.appendChild(document.createTextNode(level==="ok"?"OK":(level==="warn"?"WARN":"BAD")));
  div.appendChild(left);
  div.appendChild(right);
  div.appendChild(badge);
  return div;
}

async function updateSupervisor(){
  const list = $("checklist");
  if(!list) return;
  list.innerHTML = "";

  const checks = [];
  const ethersOk = (typeof ethers !== "undefined");
  checks.push({name:"ethers.js å·²è¼‰å…¥", ok: ethersOk, value: ethersOk ? (ethers.version||"v5") : "missing"});
  const hasEth = !!window.ethereum;
  checks.push({name:"window.ethereum å­˜åœ¨", ok: hasEth, value: hasEth ? "yes" : "no"});

  const connected = !!state.account;
  checks.push({name:"éŒ¢åŒ…å·²é€£ç·š", ok: connected, value: connected ? shortAddr(state.account) : "â€”"});

  const onBSC = state.chainId === 56;
  checks.push({name:"éˆç‚º BSC ä¸»ç¶²", ok: onBSC, value: state.chainId!=null ? String(state.chainId) : "â€”"});

  const heartAddr = getHeartAddr();
  const heartOk = isAddr(heartAddr);
  checks.push({name:"Heart åœ°å€æ ¼å¼", ok: heartOk, value: heartOk ? shortAddr(heartAddr) : "invalid"});

  let heartReadable = false;
  let capStr="â€”";
  if(connected && onBSC && heartOk && state.heart){
    try{
      const cap = await state.heart.effectiveCapWhole();
      capStr = cap.toString();
      heartReadable = true;
    }catch(e){}
  }
  checks.push({name:"Heart å¯è®€å–ï¼ˆcapï¼‰", ok: heartReadable, value: capStr});

  const camSupport = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
  checks.push({name:"ç›¸æ©Ÿ API æ”¯æ´", ok: camSupport, value: camSupport ? "ok" : "no"});

  let storageOk = true;
  try{ localStorage.setItem("_t","1"); localStorage.removeItem("_t"); }catch(e){ storageOk=false; }
  checks.push({name:"localStorage å¯ç”¨", ok: storageOk, value: storageOk ? "ok" : "blocked"});

  const okCount = checks.filter(c=>c.ok).length;
  const score = Math.round(okCount / checks.length * 100);
  $("supScore").textContent = score + "%";
  $("barSup").style.width = score + "%";
  setDot($("dotOverall"), score>=85 ? "ok" : (score>=55 ? "warn" : "bad"));

  for(const c of checks){
    list.appendChild(checklistItem(c.name, c.ok ? "ok" : "warn", c.value));
  }
}

function msgKey(){ return "KLINE_TEMPLE_12345_MSG_V6_3"; }
function loadMsg(){ $("msgText").value = localStorage.getItem(msgKey()) || ""; }
function saveMsg(){ localStorage.setItem(msgKey(), $("msgText").value || ""); logLine("ç•™è¨€å·²å„²å­˜ï¼ˆæœ¬æ©Ÿï¼‰"); }
function clearMsg(){ localStorage.removeItem(msgKey()); $("msgText").value = ""; logLine("ç•™è¨€å·²æ¸…ç©º"); }
function downloadText(filename, content){
  const blob = new Blob([content], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  setTimeout(()=> URL.revokeObjectURL(url), 800);
}
function downloadMsg(){
  const content = $("msgText").value || "";
  const header = `äº”æŒ‡å±±12345æ‚Ÿç©ºè²¡ç¥æ®¿ ç•™è¨€\næ™‚é–“: ${new Date().toLocaleString()}\néŒ¢åŒ…: ${state.account||"æœªé€£ç·š"}\n\n`;
  downloadText("wuzhishan_12345_message.txt", header + content);
}

let camStream = null;
async function openCam(){
  try{
    if(!navigator.mediaDevices?.getUserMedia) throw new Error("ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿ");
    camStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}, audio:false});
    $("video").srcObject = camStream;
    logLine("ç›¸æ©Ÿå·²é–‹å•Ÿ");
  }catch(e){
    logLine("ç›¸æ©Ÿå¤±æ•—ï¼š" + (e?.message || e));
    alert("ç›¸æ©Ÿå¤±æ•—ï¼š" + (e?.message || e));
  }
}

function drawStamp(ctx, w, h, title, subtitle){
  ctx.save();
  const g = ctx.createRadialGradient(w*0.5,h*0.4, w*0.1, w*0.5,h*0.4, w*0.8);
  g.addColorStop(0, "rgba(0,0,0,0)");
  g.addColorStop(1, "rgba(0,0,0,0.45)");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,w,h);

  ctx.globalAlpha = 0.9;
  ctx.strokeStyle = "rgba(255,211,106,0.85)";
  ctx.lineWidth = Math.max(3, w*0.006);
  ctx.beginPath();
  ctx.arc(w*0.12, h*0.18, Math.min(w,h)*0.06, 0, Math.PI*2);
  ctx.stroke();

  ctx.globalAlpha = 0.95;
  ctx.fillStyle = "rgba(255,211,106,0.92)";
  ctx.font = `800 ${Math.max(18, w*0.035)}px Microsoft JhengHei`;
  ctx.fillText(title, w*0.22, h*0.15);

  ctx.fillStyle = "rgba(230,230,236,0.78)";
  ctx.font = `600 ${Math.max(12, w*0.022)}px ui-monospace, Menlo, Consolas`;
  ctx.fillText(subtitle, w*0.22, h*0.21);

  ctx.fillStyle = "rgba(255,211,106,0.55)";
  ctx.font = `700 ${Math.max(12, w*0.020)}px Microsoft JhengHei`;
  ctx.fillText("èŠ±æœå±±å°ç£ãƒ»ä¿¡å¿µä¸æ»…ãƒ»å¸‚å ´ç„¡ç•Œ", w*0.06, h*0.93);

  ctx.restore();
}

function takeShot(){
  const v = $("video");
  if(!v.srcObject){ alert("è«‹å…ˆé–‹å•Ÿç›¸æ©Ÿ"); return; }
  const canvas = $("photo");
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;

  const vw = v.videoWidth || 1280;
  const vh = v.videoHeight || 720;
  const scale = Math.max(w/vw, h/vh);
  const dw = vw*scale, dh = vh*scale;
  const dx = (w-dw)/2, dy = (h-dh)/2;
  ctx.drawImage(v, dx, dy, dw, dh);

  drawStamp(ctx, w, h, "äº”æŒ‡å±± 12345 æ‚Ÿç©ºè²¡ç¥æ®¿", `V6.4 Â· ${new Date().toLocaleString()} Â· ${state.account?shortAddr(state.account):"no-wallet"}`);
  pulse();
  logLine("æ‹ç…§å®Œæˆï¼ˆå·²åŠ æµ®å°ï¼‰");
}

function downloadCanvas(canvasId, filename){
  const canvas = $(canvasId);
  const url = canvas.toDataURL("image/png");
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
}
function downloadShot(){ downloadCanvas("photo","wuzhishan_12345_photo.png"); }

function roundRect(ctx, x, y, w, h, r){
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  ctx.closePath();
}
function wrapText(ctx, text, x, y, maxWidth, lineHeight){
  const words = text.split("");
  let line = "";
  for(let n=0;n<words.length;n++){
    const testLine = line + words[n];
    const metrics = ctx.measureText(testLine);
    if(metrics.width > maxWidth && n>0){
      ctx.fillText(line, x, y);
      line = words[n];
      y += lineHeight;
    }else{
      line = testLine;
    }
  }
  ctx.fillText(line, x, y);
}

function makeWishCert(){
  const text = ($("wishText").value || "").trim();
  if(!text){ alert("è«‹è¼¸å…¥é¡˜æœ›"); return; }
  const canvas = $("wishCanvas");
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;

  const bg = ctx.createLinearGradient(0,0,w,h);
  bg.addColorStop(0, "rgba(6,8,14,1)");
  bg.addColorStop(1, "rgba(16,10,24,1)");
  ctx.fillStyle = bg;
  ctx.fillRect(0,0,w,h);

  for(let i=0;i<140;i++){
    const x=Math.random()*w, y=Math.random()*h, r=Math.random()*1.8;
    ctx.fillStyle = `rgba(255,255,255,${Math.random()*0.7})`;
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  }

  ctx.fillStyle = "rgba(255,211,106,0.95)";
  ctx.font = `900 ${Math.max(26, w*0.04)}px Microsoft JhengHei`;
  ctx.fillText("äº”æŒ‡å±± Â· é¡˜æœ›è­‰æ›¸", w*0.06, h*0.18);

  ctx.fillStyle = "rgba(230,230,236,0.82)";
  ctx.font = `700 ${Math.max(14, w*0.022)}px ui-monospace, Menlo, Consolas`;
  ctx.fillText(`Temple 12345  |  UI ${UI_VERSION}`, w*0.06, h*0.24);

  ctx.strokeStyle = "rgba(255,211,106,0.55)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  roundRect(ctx, w*0.06, h*0.30, w*0.88, h*0.46, 18);
  ctx.stroke();

  ctx.fillStyle = "rgba(255,211,106,0.92)";
  ctx.font = `800 ${Math.max(16, w*0.026)}px Microsoft JhengHei`;
  ctx.fillText("é¡˜æœ›ï¼š", w*0.09, h*0.38);

  ctx.fillStyle = "rgba(230,230,236,0.88)";
  ctx.font = `700 ${Math.max(15, w*0.024)}px Microsoft JhengHei`;
  wrapText(ctx, text, w*0.09, h*0.44, w*0.82, Math.max(24, w*0.032));

  if(typeof ethers !== "undefined"){
    const hash = ethers.utils.keccak256(ethers.utils.toUtf8Bytes(text));
    ctx.fillStyle = "rgba(230,230,236,0.70)";
    ctx.font = `700 ${Math.max(12, w*0.018)}px ui-monospace, Menlo, Consolas`;
    ctx.fillText(`wishHash: ${hash.slice(0,12)}â€¦${hash.slice(-10)}`, w*0.09, h*0.78);
  }

  ctx.fillStyle = "rgba(230,230,236,0.78)";
  ctx.font = `700 ${Math.max(12, w*0.018)}px ui-monospace, Menlo, Consolas`;
  ctx.fillText(`time: ${new Date().toLocaleString()}`, w*0.09, h*0.84);
  ctx.fillText(`wallet: ${state.account || "not-connected"}`, w*0.09, h*0.89);

  ctx.strokeStyle = "rgba(255,211,106,0.25)";
  ctx.beginPath(); ctx.moveTo(w*0.06, h*0.93); ctx.lineTo(w*0.94, h*0.93); ctx.stroke();

  ctx.fillStyle = "rgba(255,211,106,0.55)";
  ctx.font = `800 ${Math.max(12, w*0.018)}px Microsoft JhengHei`;
  ctx.fillText("èŠ±æœå±±å°ç£ãƒ»ä¿¡å¿µä¸æ»…ãƒ»å¸‚å ´ç„¡ç•Œ  Where the Market Becomes the Myth.", w*0.06, h*0.965);

  pulse();
  logLine("é¡˜æœ›è­‰æ›¸å·²ç”Ÿæˆ");
}
function downloadWishCert(){ downloadCanvas("wishCanvas","wuzhishan_12345_wish_certificate.png"); }

$("btnConnect").addEventListener("click", connect);
$("btnSwitch").addEventListener("click", switchToBSC);
$("btnRefresh").addEventListener("click", refreshAll);
$("btnSave").addEventListener("click", saveCfg);
$("btnClear").addEventListener("click", clearCfg);

$("btnHeartbeat").addEventListener("click", doHeartbeat);
$("btnIgnite").addEventListener("click", doIgnite);
$("btnFortune").addEventListener("click", doFortune);
$("btnLamp").addEventListener("click", doLamp);
$("btnWish").addEventListener("click", doWish);
$("btnApprove").addEventListener("click", doApprove);
$("btnVow").addEventListener("click", doVow);

$("btnWishCert").addEventListener("click", makeWishCert);
$("btnWishDownload").addEventListener("click", downloadWishCert);

$("btnMsgSave").addEventListener("click", saveMsg);
$("btnMsgDownload").addEventListener("click", downloadMsg);
$("btnMsgClear").addEventListener("click", clearMsg);

$("btnChatSave").addEventListener("click", saveChat);
$("btnChatSpeak").addEventListener("click", speakGoddess);
$("btnChatDownload").addEventListener("click", downloadChat);
$("btnChatClear").addEventListener("click", clearChat);
$("btnDownloadAll").addEventListener("click", downloadAll);
$("btnCup") && $("btnCup").addEventListener("click", tossCup);
$("btnCupReset") && $("btnCupReset").addEventListener("click", resetCup);
$("btnTutorialCheck") && $("btnTutorialCheck").addEventListener("click", tutorialCheck);
$("btnTutorialCopy") && $("btnTutorialCopy").addEventListener("click", tutorialCopy);


$("btnCam").addEventListener("click", openCam);
$("btnShot").addEventListener("click", takeShot);
$("btnShotDownload").addEventListener("click", downloadShot);

$("btnSupervisor").addEventListener("click", ()=>{
  $("supervisorBox").classList.toggle("show");
  updateSupervisor();
});

$("uiVer").textContent = UI_VERSION;
loadCfg();
loadMsg();
loadChat();
loadCup();
startCountdowns();
applyQueryConfig();
setNetHint();
logLine("UI å•Ÿå‹•ï¼š" + UI_VERSION + " Â· " + UI_BUILD);

setInterval(()=>{ if(state.account && $("supervisorBox").classList.contains("show")) updateSupervisor(); }, 2000);
setInterval(()=>{ if(state.account) refreshStatus(); }, 3500);

// ===== å€’æ•¸ï¼ˆUIï¼‰=====
function pad2(n){ return String(n).padStart(2,"0"); }
function fmtHMS(sec){
  sec = Math.max(0, Math.floor(sec));
  const h = Math.floor(sec/3600); sec%=3600;
  const m = Math.floor(sec/60); const s = sec%60;
  return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
}
function nextTopOfHourMs(){
  const d = new Date();
  d.setMinutes(59,59,999);
  return d.getTime()+1;
}
function utcSecondsOfDayNow(){
  const d = new Date();
  return d.getUTCHours()*3600 + d.getUTCMinutes()*60 + d.getUTCSeconds();
}
function startCountdowns(){
  function tick(){
    const t = Date.now();
    const hb = Math.max(0, (nextTopOfHourMs() - t)/1000);
    const hbEl = $("heartbeatCountdown");
    if(hbEl) hbEl.textContent = fmtHMS(hb);

    const sod = utcSecondsOfDayNow();
    const winStart = 0, winEnd = 600;
    let msg = "";
    if(sod>=winStart && sod<=winEnd){
      msg = `çª—å£ä¸­ âœ…  å‰©é¤˜ ${fmtHMS(winEnd - sod)}`;
    }else{
      msg = `è·é›¢çª—å£ ${fmtHMS(86400 - sod + winStart)}`;
    }
    const igEl = $("igniteCountdown");
    if(igEl) igEl.textContent = msg;
  }
  tick();
  setInterval(tick, 1000);
}

// ===== V6.4: countdown + cup gate + better photo capture =====
let cupStreak = 0;
function renderCup(){
  const el = document.getElementById('cupState');
  if(el) el.textContent = `${cupStreak} / 3`;
  const ok = cupStreak >= 3;
  const fbtn = document.getElementById('btnFortuneClaim');
  if(fbtn){ fbtn.disabled = !ok; fbtn.classList.toggle('disabled', !ok); }
  const elig = document.getElementById('stEligibility');
  if(elig) elig.textContent = ok ? 'å¯é ˜ç™¼è²¡é‡‘ï¼ˆè–ç›ƒé€šéï¼‰' : 'éœ€ä¸‰æ¬¡è–ç›ƒï¼ˆé˜²Botï¼‰';
}
function cupOnce(){
  // 50/50 æ­£åï¼ˆå¯æ—¥å¾Œä¸Šéˆæ”¹æˆå¯é©—è­‰äº‚æ•¸ï¼‰
  const ok = Math.random() < 0.5;
  const log = document.getElementById('cupLog');
  if(ok){
    cupStreak = Math.min(3, cupStreak + 1);
    if(log) log.textContent = `è–ç›ƒï¼šæ­£ï¼ˆæˆåŠŸï¼‰â†’ streak ${cupStreak}/3`;
  }else{
    cupStreak = 0;
    if(log) log.textContent = 'è–ç›ƒï¼šåï¼ˆå¤±æ•—ï¼‰â†’ streak é‡ç½® 0/3';
  }
  renderCup();
}
function cupReset(){
  cupStreak = 0;
  const log = document.getElementById('cupLog');
  if(log) log.textContent = 'å·²é‡ç½®ï¼ˆ0/3ï¼‰';
  renderCup();
}
document.getElementById('btnCup')?.addEventListener('click', cupOnce);
document.getElementById('btnCupReset')?.addEventListener('click', cupReset);

// countdowns (UI-only; éˆä¸Šä»ä»¥ cooldown + window åˆ¤å®š)
function pad2(n){ return String(n).padStart(2,'0'); }
function fmt(sec){
  sec = Math.max(0, Math.floor(sec));
  const h = Math.floor(sec/3600); sec%=3600;
  const m = Math.floor(sec/60); const s = sec%60;
  return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
}
function tickCountdowns(){
  const now = new Date();
  // next local hour boundary (for UI heartbeat)
  const next = new Date(now);
  next.setMinutes(60,0,0);
  const hbSec = (next.getTime() - now.getTime())/1000;
  const hb = document.getElementById('hbCountdown');
  if(hb) hb.textContent = fmt(hbSec);

  // ignite: UTC 00:00 window start
  const nowUtc = new Date(now.getTime() + now.getTimezoneOffset()*60000);
  const startUtc = new Date(Date.UTC(nowUtc.getUTCFullYear(), nowUtc.getUTCMonth(), nowUtc.getUTCDate(), 0,0,0));
  let igSec = (startUtc.getTime() - nowUtc.getTime())/1000;
  if(igSec < 0) igSec += 86400; // to next day
  const ig = document.getElementById('igCountdown');
  if(ig) ig.textContent = `${fmt(igSec)}ï¼ˆåˆ°UTC 00:00ï¼‰`;
}
setInterval(tickCountdowns, 1000);
tickCountdowns();

// photo capture: make canvas same size as video frame to avoid "small" look
(function(){
  const v = document.getElementById('video');
  const c = document.getElementById('photo');
  const btn = document.getElementById('btnShot');
  if(!v || !c || !btn) return;
  btn.addEventListener('click', ()=>{
    const w = v.videoWidth || 1280;
    const h = v.videoHeight || 720;
    c.width = w; c.height = h;
    const ctx = c.getContext('2d');
    ctx.drawImage(v, 0, 0, w, h);
    // watermark
    ctx.save();
    ctx.globalAlpha = 0.85;
    ctx.fillStyle = "#ffd36a";
    ctx.font = "bold 28px ui-sans-serif, system-ui, -apple-system, 'Microsoft JhengHei'";
    ctx.fillText("äº”æŒ‡å±± 12345 æ‚Ÿç©ºè²¡ç¥æ®¿", 22, 42);
    ctx.font = "16px ui-monospace, SFMono-Regular, Menlo, monospace";
    ctx.fillText(`V6.4 Â· ${new Date().toLocaleString('zh-TW')}`, 22, 70);
    ctx.restore();
  }, {capture:true});
})();

// init
renderCup();

</script>
</body>
</html>
