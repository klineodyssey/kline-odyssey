<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>äº”æŒ‡å±± 12345ãƒ»æ‚Ÿç©ºè²¡ç¥æ®¿ï½œV6.6p17p1</title>

  <!-- Ethers v5 (lightweight, CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    :root{
      --bg0:#05060a;
      --bg1:#0b0d14;
      --gold:#f3d27a;
      --gold2:#ffd27d;
      --gold3:#ffb84d;
      --ink:#0b0b12;
      --panel:rgba(18,18,28,.58);
      --panel2:rgba(255,255,255,.06);
      --line:rgba(243,210,122,.22);
      --line2:rgba(243,210,122,.35);
      --muted:rgba(255,255,255,.68);
      --muted2:rgba(255,255,255,.50);
      --danger:#ff5c5c;
      --ok:#58ff9a;
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --r1:18px;
      --r2:999px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Heiti TC", "Microsoft JhengHei", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:rgba(255,255,255,.92);
      background: radial-gradient(1200px 700px at 20% 20%, rgba(243,210,122,.10) 0%, transparent 55%),
                  radial-gradient(900px 600px at 85% 35%, rgba(255,184,77,.09) 0%, transparent 55%),
                  radial-gradient(900px 650px at 45% 100%, rgba(120,160,255,.06) 0%, transparent 60%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    /* Starfield canvas sits behind everything */
    #stars{
      position:fixed; inset:0;
      width:100%; height:100%;
      z-index:0;
      pointer-events:none;
      opacity:.95;
    }

    .wrap{
      position:relative;
      z-index:1;
      max-width:1100px;
      margin:0 auto;
      padding:18px 14px 54px;
    }

    /* Official entry button (user provided snippet, adapted to cosmic style) */
    .topbar{
      position:sticky;
      top:10px;
      z-index:9999;
      display:flex;
      justify-content:flex-end;
      margin:6px 0 12px;
    }
    .topbar a{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      text-decoration:none;
      border:1px solid rgba(243,210,122,.35);
      background:rgba(10,10,16,.82);
      color:rgba(255,255,255,.92);
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .topbar a:active{transform:translateY(1px)}
    .topbar .dot{
      width:10px;height:10px;border-radius:99px;
      background:radial-gradient(circle, var(--gold2), rgba(243,210,122,.25));
      box-shadow:0 0 18px rgba(243,210,122,.55);
    }

    .hero{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:12px;
      align-items:stretch;
    }
    @media (max-width:860px){
      .hero{grid-template-columns:1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.035));
      border:1px solid var(--line);
      border-radius: var(--r1);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(8px);
    }
    .card .inner{padding:16px 16px 14px}
    .card h2{
      margin:0 0 10px;
      font-size:16px;
      letter-spacing:.5px;
      color:var(--gold2);
      text-shadow: 0 0 20px rgba(243,210,122,.22);
    }
    .sub{
      color:var(--muted2);
      font-size:13px;
      line-height:1.55;
    }

    /* Title block - single (no duplication) */
    .title{
      display:flex;
      gap:14px;flex-wrap:nowrap;
      align-items:flex-start;
    }
    .pillar{
      width:8px;
      border-radius:99px;
      background: linear-gradient(180deg, rgba(243,210,122,.95), rgba(243,210,122,.15));
      box-shadow: 0 0 28px rgba(243,210,122,.35);
      flex:0 0 8px;
      margin-top:6px;
    }
    .ttext h1{
      margin:0;
      font-size:44px;
      line-height:1.02;
      letter-spacing:1px;
      color:var(--gold2);
      text-shadow: 0 0 24px rgba(243,210,122,.25);
    }
    .ttext h1 small{
      display:block;
      font-size:34px;
      margin-top:6px;
      letter-spacing:1px;
    }
    .ttext .tagline{
      margin-top:10px;
      font-size:14px;
      color:var(--muted);
      line-height:1.5;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
    }
    .chip{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      color:rgba(255,255,255,.9);
      font-weight:800;
      display:inline-flex;
      gap:10px;
      align-items:center;
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
    }
    .chip b{color:var(--gold2)}
    .mono{font-family:var(--mono)}
    .rightInfo{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:16px;
    }
    .badge{
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      padding:12px 14px;
    }
    .badge .row{display:flex; justify-content:space-between; gap:10px; align-items:center}
    .badge .k{color:var(--muted2); font-size:12px}
    .badge .v{font-weight:900}
    .badge .v b{color:var(--gold2)}
    .badge .tiny{margin-top:6px; color:var(--muted2); font-size:12px}
    .statusPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      font-weight:900;
    }
    .led{
      width:10px;height:10px;border-radius:99px;
      background: rgba(255,255,255,.25);
      box-shadow:none;
    }
    .led.ok{background: radial-gradient(circle, var(--ok), rgba(88,255,154,.18)); box-shadow:0 0 18px rgba(88,255,154,.45)}
    .led.bad{background: radial-gradient(circle, var(--danger), rgba(255,92,92,.2)); box-shadow:0 0 18px rgba(255,92,92,.35)}
    .btns{display:flex; flex-wrap:wrap; gap:10px; margin-top:12px}
    button{
      appearance:none;
      border:none;
      background: linear-gradient(180deg, rgba(243,210,122,.16), rgba(243,210,122,.06));
      color:rgba(255,255,255,.94);
      border:1px solid var(--line2);
      padding:12px 14px;
      border-radius: 14px;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 12px 26px rgba(0,0,0,.22);
      transition: transform .06s ease, border-color .2s ease, background .2s ease;
    }
    button:hover{border-color: rgba(243,210,122,.55)}
    button:active{transform: translateY(1px)}
    button.ghost{
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.14);
      color: rgba(255,255,255,.82);
    }
    button.danger{
      background: rgba(255,92,92,.12);
      border-color: rgba(255,92,92,.35);
    }
    button.primary{
      background: linear-gradient(180deg, rgba(255,210,125,.28), rgba(243,210,122,.10));
      border-color: rgba(243,210,122,.65);
    }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none!important;
    }

    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }

    .field{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    label{
      font-size:12px;
      color:var(--muted2);
    }
    input, textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(243,210,122,.18);
      background: rgba(0,0,0,.28);
      color: rgba(255,255,255,.92);
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.2);
      font-family: var(--sans);
    }
    textarea{min-height:92px; resize:vertical}
    input::placeholder, textarea::placeholder{color:rgba(255,255,255,.38)}
    .help{
      font-size:12px;
      color:var(--muted2);
      line-height:1.55;
    }
    .sep{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(243,210,122,.20), transparent);
      margin:12px 0;
    }

    .progressWrap{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .bar{
      position:relative;
      height:14px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.09);
      overflow:hidden;
      flex:1;
    }
    .bar > i{
      display:block;
      height:100%;
      width:65%;
      background: linear-gradient(90deg, rgba(243,210,122,.15), rgba(243,210,122,.55), rgba(255,184,77,.45));
      box-shadow: 0 0 24px rgba(243,210,122,.25);
      border-radius:999px;
      transition: width .8s ease;
    }
    .pct{
      font-weight:900;
      color: var(--gold2);
      min-width:62px;
      text-align:right;
    }

    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      margin-top:10px;
    }
    .kv .k{color:var(--muted2); font-size:12px}
    .kv .v{font-weight:900}
    .kv .v b{color:var(--gold2)}
    .warn{color:#ffb0b0}
    .ok{color:#a7ffd0}
    .mini{
      font-size:12px;
      color:var(--muted2);
      line-height:1.55;
    }

    /* Media (camera/photo/video) */
    .mediaGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width:860px){ .mediaGrid{grid-template-columns:1fr} }
    .mediaBox{
      border-radius: var(--r1);
      border:1px solid rgba(243,210,122,.18);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      position:relative;
    }
    .mediaBox .cap{
      padding:10px 12px;
      border-bottom:1px solid rgba(243,210,122,.10);
      color:var(--muted2);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .mediaBox .cap b{color:var(--gold2)}
    .mediaBox .body{padding:10px 10px 12px}
    video, canvas, img{
      width:100%;
      height:auto;
      display:block;
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
    }
    .rowBtns{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
    .note{
      font-size:12px; color:var(--muted2); margin-top:8px; line-height:1.55;
    }

    /* Cupoe */
    .cupRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .cupBox{
      display:flex;
      gap:8px;
      align-items:center;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(243,210,122,.18);
      background: rgba(0,0,0,.18);
      font-weight:900;
    }
    .cupIcon{
      width:24px; height:24px; border-radius:8px;
      background: radial-gradient(circle, rgba(243,210,122,.70), rgba(243,210,122,.10));
      box-shadow:0 0 18px rgba(243,210,122,.22);
      display:grid; place-items:center;
      font-size:14px;
    }

    /* Guided overlay */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      z-index:10000;
      padding:18px 14px;
    }
    .overlay.show{display:block}
    .modal{
      max-width:760px;
      margin:0 auto;
      background: rgba(12,12,18,.90);
      border:1px solid rgba(243,210,122,.25);
      border-radius: 22px;
      box-shadow: 0 22px 70px rgba(0,0,0,.65);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .modalHead{
      padding:14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid rgba(243,210,122,.12);
    }
    .modalHead b{color:var(--gold2)}
    .modalBody{padding:14px 16px 16px}
    .steps{
      display:grid;
      gap:10px;
    }
    .step{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(255,255,255,.04);
      padding:12px 12px;
    }
    .step .t{font-weight:900; color:rgba(255,255,255,.92)}
    .step .d{margin-top:6px; color:var(--muted2); font-size:13px; line-height:1.55}
    .footer{
      margin-top:14px;
      color:var(--muted2);
      font-size:12px;
      text-align:center;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      background: rgba(0,0,0,.72);
      border:1px solid rgba(243,210,122,.25);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius: 999px;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      z-index:20000;
      display:none;
      max-width:92vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{display:block}
  
.caishenIcon{width:76px;height:76px;border-radius:16px;display:inline-block;flex:0 0 auto;box-shadow:0 10px 22px rgba(0,0,0,.35);}
@media (max-width:420px){ .caishenIcon{width:56px;height:56px;border-radius:14px;} }


    .title{display:flex;align-items:flex-start;gap:12px}
    .title .pillar{order:1}
    .title .ttext{order:2;flex:1;min-width:0}
    .title .caishenIcon{order:3;margin-left:auto}

</style>
</head>

<body>
  <canvas id="stars"></canvas>

  <div class="wrap">

    <!-- Official Entry (Top-Right) -->
    <div class="topbar">
      <a href="https://klineodyssey.github.io/kline-odyssey/" target="_blank" rel="noopener">
        <span class="dot"></span>
        <span>ğŸŒ Official Website</span>
      </a>
    </div>

    <div class="hero">
      <div class="card">
        <div class="inner">
          <div class="title">
            <div class="pillar"></div>
            <img class="caishenIcon" src="/kline-odyssey/assets/wukong_caishen.png?v=1" alt="Wukong Caishen" onerror="this.style.display=\'none\'"/>
<div class="ttext">
              <h1>äº”æŒ‡å±± 12345<small>æ‚Ÿç©ºè²¡ç¥æ®¿</small></h1>
              <div class="tagline">
                V6.6p17 Cosmic Living Temple Â· ChainReady UI<br/>
                å¿ƒè·³ / é»ç« / ä¸‰æ¬¡è–ç›ƒç™¼è²¡é‡‘ / é»ç‡ˆ / é‚„é¡˜ / è¨±é¡˜ç•™è¨€ä¸Šéˆ / æ‹ç…§éŒ„å½±éŒ„éŸ³ / ä¸‹è¼‰å­˜è­‰
              </div>
              <div class="chips">
                <div class="chip"><span>ç‰ˆæœ¬</span><b id="ver">V6.6p17p1</b></div>
                <div class="chip"><span>æ™‚é–“</span><b id="nowTxt" class="mono">--</b></div>
                <div class="chip"><span>ç‹€æ…‹</span><b id="modeTxt">æ–½å·¥ä¸­ï¼ˆå¯ä¸Šç·šæ¸¬ï¼‰</b></div>
              </div>
              <div class="sep"></div>
              <div class="progressWrap">
                <div class="bar"><i id="progFill" style="width:72%"></i></div>
                <div class="pct" id="progTxt">72%</div>
              </div>
              <div class="mini" style="margin-top:8px">
                ç›£å·¥æç¤ºï¼šç•¶ä½ åœ¨ <span class="mono">/Kç·šè¥¿éŠè¨˜/temples/12345/index.html</span> æ›´æ–°æœ¬æª”ï¼ŒGitHub Pages æœƒè‡ªå‹•åˆ·æ–°ã€‚è‹¥çœ‹åˆ°ç‰ˆæœ¬è·³å›èˆŠç‰ˆï¼Œé€šå¸¸æ˜¯ç€è¦½å™¨å¿«å–ï¼ˆè«‹å¼·åˆ¶é‡æ–°æ•´ç†ï¼‰ã€‚
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="rightInfo">
          <div class="badge">
            <div class="row">
              <div>
                <div class="k">éŒ¢åŒ…</div>
                <div class="v"><span class="statusPill"><span id="led" class="led bad"></span><span id="walletState">æœªé€£ç·š</span></span></div>
              </div>
              <div style="text-align:right">
                <div class="k">éˆ</div>
                <div class="v"><b id="chainState">æœªåµæ¸¬</b></div>
              </div>
            </div>
            <div class="tiny">ç›®æ¨™ï¼šBSC Mainnet / chainId 56ï¼ˆ0x38ï¼‰</div>
            <div class="btns">
              <button class="primary" id="btnConnect">é€£æ¥éŒ¢åŒ…</button>
              <button id="btnSwitch">åˆ‡æ›åˆ° BSC (0x38)</button>
              <button class="ghost" id="btnRefresh">åˆ·æ–°ç‹€æ…‹</button>
              <button class="ghost" id="btnGuide">æ–°æ‰‹å°è¦½</button>
            </div>
          </div>

          <div class="badge">
            <div class="k">Heart åˆç´„åœ°å€ï¼ˆéƒ¨ç½²å¾Œè²¼ä¸Šï¼‰</div>
            <div class="field">
              <input id="heartAddr" class="mono" placeholder="0x..." />
              <div class="help">è²¼ä¸Šéƒ¨ç½²å¾Œçš„ Heart åˆç´„åœ°å€ï¼ˆKGEN_TempleHeart_V3_2_2ï¼‰ã€‚æœ¬æ©Ÿæœƒè¨˜ä½ï¼ˆlocalStorageï¼‰ã€‚</div>
            </div>
            <div class="grid">
              <div class="field">
                <label>å…¬ç›Šè¡€åº« orphanPoolï¼ˆé¡¯ç¤ºç”¨ï¼Œå¯ç•™ç©ºï¼‰</label>
                <input id="orphanAddr" class="mono" placeholder="0xB73D...ï¼ˆå¯ç•™ç©ºï¼‰" />
              </div>
              <div class="field">
                <label>KGEN Tokenï¼ˆå·²ä¸Šéˆï¼‰</label>
                <input id="kgenAddr" class="mono" value="0xBA3d3810e58735cb6813bC1CDc5458C0d71432Be" />
              </div>
            </div>
            <div class="btns">
              <button class="primary" id="btnSave">ä¿å­˜åœ°å€</button>
              <button class="danger" id="btnClear">æ¸…é™¤æœ¬æ©Ÿè¨­å®š</button>
              <button class="ghost" id="btnInspector">ç›£å·¥æª¢æŸ¥</button>
            </div>
            <div id="inspectOut" class="mini" style="margin-top:8px"></div>
          </div>

        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="card">
        <div class="inner">
          <h2>å¿ƒè·³ / é»ç« å€’æ•¸ï¼ˆéˆä¸Šäº‹ä»¶ï¼‰</h2>
          <div class="kv">
            <div>
              <div class="k">å¿ƒè·³å€’æ•¸ï¼ˆä¸‹ä¸€æ¬¡å¯é ˜ï¼‰</div>
              <div class="v"><b id="hbCountdown">--:--:--</b></div>
              <div class="mini">è¦å‰‡ï¼šæ¯å°æ™‚ä¸€æ¬¡ï¼ˆåˆç´„ heartbeatCooldownSecondsï¼‰ã€‚</div>
            </div>
            <div style="text-align:right">
              <div class="k">å¿ƒè·³çå‹µ</div>
              <div class="v"><b id="hbReward">1</b> KGEN</div>
              <div class="mini mono" id="hbNextAt">--</div>
            </div>
          </div>

          <div class="kv">
            <div>
              <div class="k">é»ç«å€’æ•¸ï¼ˆUTC 00:00â€“00:10ï¼‰</div>
              <div class="v"><b id="igCountdown">--:--:--</b></div>
              <div class="mini">è¦å‰‡ï¼šæ¯æ—¥ä¸€æ¬¡ï¼Œä¸”åªèƒ½åœ¨è¦–çª—å…§ igniteAndClaimã€‚</div>
            </div>
            <div style="text-align:right">
              <div class="k">é»ç«çå‹µ</div>
              <div class="v"><b id="igReward">8</b> KGEN</div>
              <div class="mini mono" id="igWindowTxt">UTC 00:00â€“00:10</div>
            </div>
          </div>

          <div class="btns">
            <button class="primary" id="btnHeartbeat">é ˜å¿ƒè·³ï¼ˆä¸Šéˆï¼‰</button>
            <button class="primary" id="btnIgnite">è½‰æ—¥é»ç«ï¼ˆä¸Šéˆï¼‰</button>
          </div>
          <div class="mini" id="hbIgOut" style="margin-top:8px"></div>
        </div>
      </div>

      <div class="card">
        <div class="inner">
          <h2>ä¸‰æ¬¡è–ç›ƒï¼ˆé˜² Botï¼‰â†’ æ‰èƒ½é ˜ç™¼è²¡é‡‘</h2>

          <div class="cupRow">
            <div class="cupBox"><span class="cupIcon">ğŸ¥¢</span> è–ç›ƒé€²åº¦ï¼š<span class="mono" id="cupProg">0 / 3</span></div>
            <div class="cupBox"><span class="cupIcon">â›©ï¸</span> é€£çºŒæˆåŠŸï¼š<span class="mono" id="cupStreak">0</span></div>
            <div class="cupBox"><span class="cupIcon">ğŸ²</span> æœ¬æ¬¡çµæœï¼š<span class="mono" id="cupLast">--</span></div>
          </div>

          <div class="btns" style="margin-top:10px">
            <button id="btnCup" class="primary">ææ¯ä¸€æ¬¡</button>
            <button id="btnCupReset" class="ghost">é‡ç½®è–ç›ƒ</button>
          </div>

          <div class="sep"></div>

          <div class="grid">
            <div class="field">
              <label>è¦é ˜å¤šå°‘ç™¼è²¡é‡‘ï¼ˆKGENï¼‰</label>
              <input id="fortuneAmt" type="number" min="1" max="888" value="8" />
              <div class="help">è¦å‰‡ï¼š1â€“888ï¼Œè‡ªå¡«æ¯”è¼ƒæœ‰è¨˜æ†¶é»ï¼ˆä½ ä¹‹å‰çš„è¨­å®šï¼‰ã€‚</div>
            </div>
            <div class="field">
              <label>ç™¼è²¡é‡‘ç‹€æ…‹</label>
              <div class="help">
                <div>éœ€è¦ï¼š<b>ä¸‰æ¬¡è–ç›ƒæˆåŠŸ</b> æ‰æœƒè§£é–ã€Œé ˜ç™¼è²¡é‡‘ã€ã€‚</div>
                <div>å†·å»ï¼šé è¨­ <span class="mono">30 days</span>ï¼ˆåˆç´„ fortuneCooldownSecondsï¼‰ã€‚</div>
                <div>æ¯æœŸåé¡ï¼šé è¨­ <span class="mono">500 / 30 days</span>ï¼ˆfortuneEpochMaxClaims / fortuneEpochSecondsï¼‰ã€‚</div>
              </div>
            </div>
          </div>

          <div class="btns">
            <button class="primary" id="btnFortune" disabled>é ˜ç™¼è²¡é‡‘ï¼ˆä¸Šéˆï¼‰</button>
            <button class="ghost" id="btnFortuneCheck">æŸ¥æˆ‘çš„å†·å» / åé¡</button>
          </div>

          <div class="mini" id="fortuneOut" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="inner">
          <h2>è¨±é¡˜ / ç•™è¨€ï¼ˆå¯ä¸Šéˆ hashï¼‰ï¼‹ ä¸‹è¼‰å­˜è­‰</h2>
          <div class="grid">
            <div class="field">
              <label>è¨±é¡˜å…§å®¹ï¼ˆæœ¬æ©Ÿä¿å­˜ï¼Œå¯ä¸Šéˆ hashï¼‰</label>
              <textarea id="wishText" placeholder="å¯«ä¸‹ä½ çš„é¡˜æœ›ï¼ˆä¾‹å¦‚ï¼šé¡˜æˆ‘å¿ƒä¸äº‚ã€é¡˜æ‚Ÿç©ºå›è¡€ã€é¡˜æˆ‘èƒ½å®ˆä½ç¯€å¥â€¦ï¼‰"></textarea>
              <div class="btns">
                <button class="primary" id="btnSaveWish">ä¿å­˜</button>
                <button class="ghost" id="btnWishHash">ç”¢ç”Ÿ hash / ä¸Šéˆ</button>
              </div>
              <div class="mini" id="wishOut"></div>
            </div>
            <div class="field">
              <label>ç•™è¨€ï¼ˆæœƒä¸€èµ·çƒ™å°åˆ°ç…§ç‰‡/å½±ç‰‡æµ®å°ï¼‰</label>
              <textarea id="noteText" placeholder="ç•™ä¸‹ä¸€å¥è©±ï¼ˆä¾‹å¦‚ï¼šæˆ‘å·²é»ç«ã€æˆ‘å·²é‚„é¡˜ã€æˆ‘å·²é ˜åˆ°ç™¼è²¡é‡‘â€¦ï¼‰"></textarea>
              <div class="btns">
                <button class="primary" id="btnSaveNote">ä¿å­˜</button>
                <button class="ghost" id="btnClearNote">æ¸…ç©º</button>
              </div>
              <div class="mini">æç¤ºï¼šç•™è¨€/è¨±é¡˜æœƒåœ¨ä½ æ‹ç…§æˆ–éŒ„å½±æ™‚ï¼Œå¯«åˆ°æµ®å°è£¡é¢ã€‚</div>
            </div>
          </div>

          <div class="sep"></div>

          <h2 style="margin-top:0">é‚„é¡˜ / é»ç‡ˆï¼ˆè£œè¡€ï¼‰</h2>
          <div class="grid">
            <div class="field">
              <label>é‚„é¡˜é‡‘é¡ï¼ˆKGENï¼‰</label>
              <input id="vowAmt" type="number" min="1" value="8" />
              <div class="help">é‚„é¡˜æ˜¯è£œè¡€ï¼šæœƒç”¨ <span class="mono">transferFrom</span> è½‰å…¥ Heartï¼ˆéœ€å…ˆ approveï¼‰ã€‚</div>
            </div>
            <div class="field">
              <label>é»ç‡ˆå¤©æ•¸ï¼ˆæ¯ä¸€å¤© 1 KGENï¼Œé è¨­ï¼‰</label>
              <input id="lampDays" type="number" min="1" value="7" />
              <div class="help">é»ç‡ˆä¹Ÿæ˜¯è£œè¡€ï¼Œæœƒå»¶é•·ä½ çš„ç‡ˆç«åˆ°æœŸæ™‚é–“ï¼ˆéˆä¸Šè¨˜éŒ„ï¼‰ã€‚</div>
            </div>
          </div>
          <div class="btns">
            <button class="primary" id="btnApprove">å…ˆ Approveï¼ˆKGEN â†’ Heartï¼‰</button>
            <button class="primary" id="btnVow">é‚„é¡˜ï¼ˆä¸Šéˆï¼‰</button>
            <button class="primary" id="btnLamp">é»ç‡ˆï¼ˆä¸Šéˆï¼‰</button>
          </div>
          <div class="mini" id="vowOut" style="margin-top:8px"></div>
        </div>
      </div>

      <div class="card">
        <div class="inner">
          <h2>æ‹ç…§ / éŒ„å½±ï¼ˆå«è²éŸ³ï¼‰/ ç…§ç‰‡ï¼‹èªéŸ³ åˆæˆå½±ç‰‡ï¼ˆå¯ä¸‹è¼‰ï¼‰</h2>
          <div class="sub">
            ä½ è¦çš„ã€Œç…§ç‰‡ä¸ç¸®å°ã€ï¼šæ­¤ç‰ˆç”¨åŒä¸€å¼µ Canvas åšæµ®å°ï¼Œè¼¸å‡ºç¶­æŒåŸè§£æåº¦æ¯”ä¾‹ã€‚<br/>
            ä½ è¦çš„ã€Œåˆåœ¨ä¸€èµ·ã€ï¼šæŒ‰ã€Œç…§ç‰‡ï¼‹èªéŸ³ã€æœƒæŠŠç…§ç‰‡ç•¶èƒŒæ™¯ï¼ŒéŒ„ä¸€æ®µèªéŸ³ä¸¦è¼¸å‡ºæˆå½±ç‰‡æª”ï¼ˆWebMï¼‰ã€‚
          </div>

          <div class="mediaGrid">
            <div class="mediaBox">
              <div class="cap"><span>é è¦½ç›¸æ©Ÿ</span><span class="mono" id="camState">off</span></div>
              <div class="body">
                <video id="cam" playsinline autoplay muted></video>
                <div class="rowBtns">
                  <button class="primary" id="btnCamOn">é–‹å•Ÿç›¸æ©Ÿ</button>
                  <button class="ghost" id="btnCamOff">é—œé–‰ç›¸æ©Ÿ</button>
                </div>
                <div class="note">è‹¥æ‰‹æ©Ÿè·³å‡ºæ¬Šé™ï¼Œè«‹å…è¨±ç›¸æ©Ÿèˆ‡éº¥å…‹é¢¨ï¼ˆéŒ„å½±/éŒ„éŸ³éœ€è¦ï¼‰ã€‚</div>
              </div>
            </div>

            <div class="mediaBox">
              <div class="cap"><span>æˆå“é è¦½ï¼ˆå«æµ®å°ï¼‰</span><span class="mono" id="exportState">ready</span></div>
              <div class="body">
                <canvas id="canvas" width="1280" height="720"></canvas>
                <div class="rowBtns">
                  <button class="primary" id="btnShot">æ‹ç…§ï¼ˆæµ®å°ï¼‰</button>
                  <button class="ghost" id="btnDlPhoto">ä¸‹è¼‰ç…§ç‰‡</button>
                </div>
                <div class="rowBtns">
                  <button class="primary" id="btnRecVideo">é–‹å§‹éŒ„å½±ï¼ˆå«è²éŸ³ï¼‰</button>
                  <button class="ghost" id="btnStopVideo" disabled>åœæ­¢éŒ„å½±</button>
                  <button class="ghost" id="btnDlVideo" disabled>ä¸‹è¼‰å½±ç‰‡</button>
                </div>
                <div class="rowBtns">
                  <button class="primary" id="btnPhotoVoice" disabled>ç…§ç‰‡ï¼‹èªéŸ³ï¼ˆåˆæˆå½±ç‰‡ï¼‰</button>
                  <button class="ghost" id="btnStopPV" disabled>åœæ­¢åˆæˆ</button>
                  <button class="ghost" id="btnDlPV" disabled>ä¸‹è¼‰åˆæˆå½±ç‰‡</button>
                </div>
                <div class="note">
                  å°æé†’ï¼šiOS Safari å°éŒ„å½±æ”¯æ´è¼ƒä¿å®ˆï¼›Android Chrome / Edge é€šå¸¸æœ€ç©©ã€‚è‹¥éŒ„å½±æŒ‰äº†æ²’åæ‡‰ï¼Œå…ˆç¢ºèªå…è¨±ã€Œéº¥å…‹é¢¨ã€æ¬Šé™ã€‚
                </div>
              </div>
            </div>
          </div>

          <div class="sep"></div>

          <h2 style="margin-top:0">AI å®¢æœï¼ˆæ•™åˆ°æœƒï¼šå¾æ²’éŒ¢åŒ… â†’ é ˜åˆ°ç™¼è²¡é‡‘ï¼‰</h2>
          <div class="grid">
            <div class="field">
              <label>å¿«é€Ÿå•é¡Œï¼ˆé»ä¸€ä¸‹å°±æ•™ä½ ï¼‰</label>
              <select id="faq">
                <option value="">é¸ä¸€å€‹å•é¡Œâ€¦</option>
                <option value="nowallet">æˆ‘æ²’æœ‰éŒ¢åŒ…ï¼Œè¦æ€éº¼é–‹å§‹ï¼Ÿ</option>
                <option value="connect">æˆ‘è£äº†éŒ¢åŒ…ï¼Œè¦æ€éº¼é€£ç·šï¼Ÿ</option>
                <option value="bsc">æ€éº¼åˆ‡åˆ° BSCï¼ˆ0x38ï¼‰ï¼Ÿ</option>
                <option value="heart">Heart åˆç´„åœ°å€åœ¨å“ªè£¡è²¼ï¼Ÿ</option>
                <option value="cup">ä¸‰æ¬¡è–ç›ƒæ€éº¼ç©ï¼Ÿ</option>
                <option value="fortune">æ€éº¼é ˜ç™¼è²¡é‡‘ï¼Ÿéœ€è¦ä»€éº¼æ¢ä»¶ï¼Ÿ</option>
                <option value="approve">ç‚ºä»€éº¼é‚„é¡˜/é»ç‡ˆè¦å…ˆ approveï¼Ÿ</option>
                <option value="fail">äº¤æ˜“å¤±æ•—æ€éº¼è¾¦ï¼Ÿ</option>
              </select>
              <div class="btns">
                <button class="primary" id="btnAsk">ä»™å¥³è§£èªª</button>
                <button class="ghost" id="btnSpeak">èªéŸ³å”¸å‡ºä¾†</button>
              </div>
            </div>
            <div class="field">
              <label>å®¢æœå°è©±ï¼ˆæœ¬æ©Ÿä¿å­˜ï¼‰</label>
              <textarea id="chatBox" placeholder="ä»™å¥³æœƒåœ¨é€™è£¡ä¸€æ­¥ä¸€æ­¥æ•™ä½ â€¦"></textarea>
              
          <div class="row" style="display:flex; gap:10px; margin-top:10px; align-items:stretch;">
            <input id="chatInput" type="text" placeholder="è¼¸å…¥ä½ çš„å•é¡Œï¼ˆä¸€æ¬¡ä¸€é¡Œï¼‰â€¦" style="flex:1; padding:12px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25); color:#f5f5f5; outline:none;">
            <button class="btn" id="btnAskChat" style="min-width:110px;">é€å‡º</button>
            <button class="btn btnGhost" id="btnMic" style="min-width:110px;">ğŸ¤ èªéŸ³</button>
            <button class="btn btnGhost" id="btnStopChat" style="min-width:110px;">åœæ­¢</button>
          </div>
<div id="micStatus" style="margin-top:8px; font-size:12px; color:#b9c2ff; opacity:.9;"></div>
<div class="btns">
                <button class="ghost" id="btnCopyChat">è¤‡è£½</button>
                <button class="ghost" id="btnClearChat">æ¸…ç©º</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="footer">
      PrimeForge ä»¥æ¯æ©Ÿä¹‹åï¼Œé–‹å•Ÿé‡‘èç”Ÿå‘½ã€‚èŠ±æœå±±å°ç£ãƒ»ä¿¡å¿µä¸æ»…ãƒ»å¸‚å ´ç„¡ç•Œã€‚Where the Market Becomes the Myth.â€”â€” æ¨‚å¤©å¸ âŒ–
    </div>
  </div>

  <!-- Guided modal -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="modalHead">
        <div><b>æ–°æ‰‹å°è¦½</b>ï½œå¾ 0 åˆ°é ˜åˆ°ç™¼è²¡é‡‘</div>
        <button class="ghost" id="btnCloseGuide">é—œé–‰</button>
      </div>
      <div class="modalBody">
        <div class="steps">
          <div class="step">
            <div class="t">Step 1ï½œè£éŒ¢åŒ…ï¼ˆæ‰‹æ©Ÿå»ºè­° MetaMask æˆ– Trust Walletï¼‰</div>
            <div class="d">
              å®‰è£å¾Œå»ºç«‹éŒ¢åŒ…ï¼Œå‹™å¿…ä¿å­˜åŠ©è¨˜è©ï¼ˆä¸è¦æˆªåœ–ã€ä¸è¦å‚³çµ¦ä»»ä½•äººï¼‰ã€‚
            </div>
          </div>
          <div class="step">
            <div class="t">Step 2ï½œå›åˆ°ç¥æ®¿ â†’ æŒ‰ã€Œé€£æ¥éŒ¢åŒ…ã€</div>
            <div class="d">
              é€£ä¸Šå¾Œï¼Œå³ä¸Šè§’æœƒé¡¯ç¤ºä½ çš„åœ°å€èˆ‡éˆè³‡è¨Šã€‚è‹¥é¡¯ç¤ºä¸æ˜¯ BSCï¼ŒæŒ‰ã€Œåˆ‡æ›åˆ° BSC (0x38)ã€ã€‚
            </div>
          </div>
          <div class="step">
            <div class="t">Step 3ï½œè²¼ä¸Š Heart åˆç´„åœ°å€</div>
            <div class="d">
              é€™å€‹åœ°å€æ˜¯éƒ¨ç½²å®Œå¿ƒè‡Ÿåˆç´„å¾Œå¾—åˆ°çš„ <span class="mono">0x...</span>ã€‚è²¼å¥½å¾ŒæŒ‰ã€Œä¿å­˜åœ°å€ã€ã€‚
            </div>
          </div>
          <div class="step">
            <div class="t">Step 4ï½œå…ˆç©ä¸‰æ¬¡è–ç›ƒï¼ˆé˜² Botï¼‰</div>
            <div class="d">
              æŒ‰ã€Œææ¯ä¸€æ¬¡ã€ç›´åˆ°é¡¯ç¤º <b>3/3</b>ã€‚å®Œæˆå¾Œã€Œé ˜ç™¼è²¡é‡‘ã€æŒ‰éˆ•æœƒè§£é–ã€‚
            </div>
          </div>
          <div class="step">
            <div class="t">Step 5ï½œé ˜ç™¼è²¡é‡‘ï¼ˆä¸Šéˆï¼‰</div>
            <div class="d">
              è‡ªå¡« 1â€“888 KGEN â†’ æŒ‰ã€Œé ˜ç™¼è²¡é‡‘ã€ã€‚è‹¥è·³å‡ºäº¤æ˜“ç¢ºèªï¼ŒæŒ‰ç¢ºèªå³å¯ã€‚æˆåŠŸå¾Œæœƒåœ¨éˆä¸Šç•™ä¸‹äº‹ä»¶ç´€éŒ„ã€‚
            </div>
          </div>
          <div class="step">
            <div class="t">Step 6ï½œæ‹ç…§/éŒ„å½±å­˜è­‰ï¼ˆå¯ä¸‹è¼‰ï¼‰</div>
            <div class="d">
              å…ˆå¯«ã€Œç•™è¨€/è¨±é¡˜ã€ï¼Œå†æ‹ç…§æˆ–éŒ„å½±ï¼›æµ®å°æœƒæŠŠä½ çš„æ–‡å­—çƒ™å°åˆ°æˆå“ä¸Šï¼Œå¯ä¸‹è¼‰ä¿å­˜ã€‚
            </div>
          </div>
        </div>
        <div class="footer">æé†’ï¼šæœ¬é æ˜¯ç¥æ®¿ä»‹é¢ï¼Œä¸æ˜¯æŠ•è³‡å»ºè­°ã€‚éˆä¸Šäº¤æ˜“ä¸å¯é€†ï¼Œè«‹ç¢ºèªéˆèˆ‡åœ°å€ã€‚</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ===============================
   V6.6 â€” Wukong Temple UI
   - Single title (no duplication)
   - Sticky official website button
   - Countdown: heartbeat + ignite window
   - 3-cupoe gate to claim fortune (anti-bot)
   - Photo: not shrinking + watermark
   - Video: record with audio
   - Photo+Voice: canvas stream + mic audio -> webm
   - Guided onboarding + voice speak
================================ */

const UI = {
  ver: "V6.6p17p1",
  // IMPORTANT: these are UI defaults; on-chain values are read from contract when connected.
  defaults: {
    hbReward: 1,
    igReward: 8,
    hbCooldownSec: 3600,
    igStart: 0,
    igEnd: 600,
    fortuneMin: 1,
    fortuneMax: 888,
  }
};

const $ = (id)=>document.getElementById(id);
const toast = (msg)=>{
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>t.classList.remove("show"), 2600);
};

$("ver").textContent = UI.ver;

function pad2(n){ return String(n).padStart(2,"0"); }
function fmtHMS(ms){
  if (ms < 0) ms = 0;
  const s = Math.floor(ms/1000);
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const ss = s%60;
  return `${pad2(h)}:${pad2(m)}:${pad2(ss)}`;
}
function fmtDateTime(d){
  const y=d.getFullYear(), mo=pad2(d.getMonth()+1), da=pad2(d.getDate());
  const hh=pad2(d.getHours()), mm=pad2(d.getMinutes()), ss=pad2(d.getSeconds());
  return `${y}/${mo}/${da} ${hh}:${mm}:${ss}`;
}
function fmtUTCWindow(startSec,endSec){
  const sh = pad2(Math.floor(startSec/3600));
  const sm = pad2(Math.floor((startSec%3600)/60));
  const eh = pad2(Math.floor(endSec/3600));
  const em = pad2(Math.floor((endSec%3600)/60));
  return `UTC ${sh}:${sm}â€“${eh}:${em}`;
}

/* ====== Starfield ====== */
(function starfield(){
  const c = $("stars");
  const ctx = c.getContext("2d");
  let w=0,h=0,stars=[];
  function resize(){
    w = c.width = window.innerWidth * devicePixelRatio;
    h = c.height = window.innerHeight * devicePixelRatio;
    stars = Array.from({length: Math.min(260, Math.floor((window.innerWidth*window.innerHeight)/6500))}, ()=>({
      x: Math.random()*w,
      y: Math.random()*h,
      r: (Math.random()*1.6+0.2)*devicePixelRatio,
      a: Math.random()*0.8+0.15,
      v: (Math.random()*0.12+0.02)*devicePixelRatio,
    }));
  }
  window.addEventListener("resize", resize, {passive:true});
  resize();
  let t=0;
  function draw(){
    t+=1;
    ctx.clearRect(0,0,w,h);
    // subtle nebula
    const g = ctx.createRadialGradient(w*0.2,h*0.25,0,w*0.2,h*0.25,Math.max(w,h)*0.55);
    g.addColorStop(0, "rgba(243,210,122,.08)");
    g.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);

    for(const s of stars){
      s.y += s.v;
      if (s.y > h+10) { s.y=-10; s.x=Math.random()*w; }
      ctx.beginPath();
      ctx.fillStyle = `rgba(255,255,255,${s.a})`;
      ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      ctx.fill();
    }
    requestAnimationFrame(draw);
  }
  draw();
})();

/* ====== Local storage ====== */
const LS = {
  get(k, d=""){ try{ return localStorage.getItem(k) ?? d; }catch(_){ return d; } },
  set(k, v){ try{ localStorage.setItem(k, v); }catch(_){ } },
  del(k){ try{ localStorage.removeItem(k); }catch(_){ } },
};

function loadLocal(){
  $("heartAddr").value = LS.get("kgen_heart_addr","");
  $("orphanAddr").value = LS.get("kgen_orphan_addr","");
  $("wishText").value = LS.get("kgen_wish_text","");
  $("noteText").value = LS.get("kgen_note_text","");
  $("chatBox").value = LS.get("kgen_chat","");
}
loadLocal();

$("btnSave").onclick = ()=>{
  LS.set("kgen_heart_addr", $("heartAddr").value.trim());
  LS.set("kgen_orphan_addr", $("orphanAddr").value.trim());
  toast("å·²ä¿å­˜åœ°å€ï¼ˆæœ¬æ©Ÿï¼‰");
};
$("btnClear").onclick = ()=>{
  ["kgen_heart_addr","kgen_orphan_addr","kgen_wish_text","kgen_note_text","kgen_chat","kgen_cup_prog","kgen_cup_streak","kgen_cup_unlocked"]
    .forEach(LS.del);
  loadLocal();
  resetCup(true);
  toast("å·²æ¸…é™¤æœ¬æ©Ÿè¨­å®š");
};
$("btnSaveWish").onclick = ()=>{
  LS.set("kgen_wish_text", $("wishText").value);
  toast("é¡˜æœ›å·²ä¿å­˜ï¼ˆæœ¬æ©Ÿï¼‰");
};
$("btnSaveNote").onclick = ()=>{
  LS.set("kgen_note_text", $("noteText").value);
  toast("ç•™è¨€å·²ä¿å­˜ï¼ˆæœ¬æ©Ÿï¼‰");
};
$("btnClearNote").onclick = ()=>{
  $("noteText").value = "";
  LS.set("kgen_note_text","");
  toast("ç•™è¨€å·²æ¸…ç©º");
};

/* ====== Guided ====== */
const overlay = $("overlay");
$("btnGuide").onclick = ()=> overlay.classList.add("show");
$("btnCloseGuide").onclick = ()=> overlay.classList.remove("show");
overlay.addEventListener("click", (e)=>{
  if (e.target === overlay) overlay.classList.remove("show");
});

/* ====== Web3 / Contract ====== */
let provider=null, signer=null, account=null, chainId=null;
let heart=null, kgen=null;

const HEART_ABI = [
  "function heartbeatCooldownSeconds() view returns(uint256)",
  "function igniteWindowStart() view returns(uint256)",
  "function igniteWindowEnd() view returns(uint256)",
  "function heartbeatReward() view returns(uint256)",
  "function igniteReward() view returns(uint256)",
  "function fortuneMin() view returns(uint256)",
  "function fortuneMax() view returns(uint256)",
  "function fortuneCooldownSeconds() view returns(uint256)",
  "function fortuneEpochSeconds() view returns(uint256)",
  "function fortuneEpochMaxClaims() view returns(uint256)",
  "function fortuneEpochClaims(uint256) view returns(uint256)",
  "function lastFortuneAt(address) view returns(uint256)",
  "function lastHeartbeatAt(address) view returns(uint256)",
  "function lastIgniteDay(address) view returns(uint256)",
  "function currentDayIndex() view returns(uint256)",
  "function currentFortuneEpochIndex() view returns(uint256)",
  "function orphanPool() view returns(address)",
  "function heartBalance() view returns(uint256)",
  "function heartBalanceWhole() view returns(uint256)",
  "function effectiveCapWhole() view returns(uint256)",
  "function effectiveFloorWhole() view returns(uint256)",
  "function fortuneClaim(uint256 amountWhole)",
  "function heartbeatClaim()",
  "function igniteAndClaim()",
  "function vowTo(uint8 option,uint256 amountWhole)",
  "function lightLamp(uint256 daysToAdd)",
  "function makeWish(bytes32 wishHash)"
];

const ERC20_ABI = [
  "function decimals() view returns(uint8)",
  "function balanceOf(address) view returns(uint256)",
  "function allowance(address owner,address spender) view returns(uint256)",
  "function approve(address spender,uint256 amount) returns(bool)"
];

function setWalletUI(ok){
  const led = $("led");
  led.classList.remove("ok","bad");
  led.classList.add(ok ? "ok" : "bad");
  $("walletState").textContent = ok ? (account ? (account.slice(0,6)+"â€¦"+account.slice(-4)) : "å·²é€£ç·š") : "æœªé€£ç·š";
  $("chainState").textContent = chainId ? (chainId===56 ? "BSC (0x38)" : ("chainId "+chainId)) : "æœªåµæ¸¬";
}

async function ensureProvider(){
  if (!window.ethereum) return false;
  provider = new ethers.providers.Web3Provider(window.ethereum, "any");
  return true;
}

async function connectWallet(){
  const ok = await ensureProvider();
  if(!ok){ toast("æœªåµæ¸¬åˆ°éŒ¢åŒ…ï¼ˆMetaMask/Trust Walletï¼‰"); return; }
  try{
    const accs = await provider.send("eth_requestAccounts",[]);
    account = accs?.[0] ?? null;
    signer = provider.getSigner();
    const net = await provider.getNetwork();
    chainId = net.chainId;
    setWalletUI(true);
    toast("éŒ¢åŒ…å·²é€£ç·š");
    // react to chain/account changes
    if (window.ethereum && !connectWallet._bound){
      connectWallet._bound = true;
      window.ethereum.on("accountsChanged", async (a)=>{
        account = a?.[0] ?? null;
        setWalletUI(!!account);
        await hydrateContracts();
      });
      window.ethereum.on("chainChanged", async (_hex)=>{
        try{
          const net2 = await provider.getNetwork();
          chainId = net2.chainId;
        }catch(_){}
        setWalletUI(!!account);
        await hydrateContracts();
      });
    }
    await hydrateContracts();
  }catch(e){
    toast("é€£ç·šå–æ¶ˆæˆ–å¤±æ•—");
  }
}

async function switchToBSC(){
  const ok = await ensureProvider();
  if(!ok){ toast("æœªåµæ¸¬åˆ°éŒ¢åŒ…"); return; }
  try{
    await window.ethereum.request({
      method:"wallet_switchEthereumChain",
      params:[{chainId:"0x38"}]
    });
    toast("å·²åˆ‡åˆ° BSC");
  }catch(e){
    // If chain not added, try add
    try{
      await window.ethereum.request({
        method:"wallet_addEthereumChain",
        params:[{
          chainId:"0x38",
          chainName:"BNB Smart Chain",
          nativeCurrency:{name:"BNB", symbol:"BNB", decimals:18},
          rpcUrls:["https://bsc-dataseed.binance.org/"],
          blockExplorerUrls:["https://bscscan.com/"]
        }]
      });
      toast("å·²æ–°å¢ä¸¦åˆ‡åˆ° BSC");
    }catch(_){
      toast("åˆ‡éˆå¤±æ•—ï¼šè«‹åœ¨éŒ¢åŒ…æ‰‹å‹•åˆ‡åˆ° BSC");
    }
  }
}

$("btnConnect").onclick = connectWallet;
$("btnSwitch").onclick = switchToBSC;
$("btnRefresh").onclick = async ()=>{ await hydrateContracts(); toast("å·²åˆ·æ–°"); };

async function hydrateContracts(){
  // wallet info
  if (!provider){
    setWalletUI(false);
    $("hbIgOut").textContent = "æœªé€£ç·šï¼šå¯å…ˆé€›ç¥æ®¿ä»‹é¢ï¼›è¦ä¸Šéˆè«‹å…ˆé€£æ¥éŒ¢åŒ…ã€‚";
    return;
  }
  try{
    const net = await provider.getNetwork();
    chainId = net.chainId;
  }catch(_){}
  setWalletUI(!!account);

  // instantiate contracts if address present
  const heartAddr = $("heartAddr").value.trim();
  const kgenAddr = $("kgenAddr").value.trim();

  heart = null; kgen = null;
  if (ethers.utils.isAddress(kgenAddr)){
    kgen = new ethers.Contract(kgenAddr, ERC20_ABI, signer || provider);
  }
  if (ethers.utils.isAddress(heartAddr)){
    heart = new ethers.Contract(heartAddr, HEART_ABI, signer || provider);
  }

  await refreshOnChainState();
}

async function refreshOnChainState(){
  // default UI values
  $("hbReward").textContent = UI.defaults.hbReward;
  $("igReward").textContent = UI.defaults.igReward;
  $("igWindowTxt").textContent = fmtUTCWindow(UI.defaults.igStart, UI.defaults.igEnd);

  if (!heart){
    $("hbIgOut").textContent = "å°šæœªè²¼ Heart åˆç´„åœ°å€ï¼ˆéƒ¨ç½²å¾Œè²¼ä¸Šï¼‰ã€‚å€’æ•¸æœƒä»¥é è¨­è¦å‰‡é¡¯ç¤ºï¼›ä¸ŠéˆåŠŸèƒ½éœ€ Heartã€‚";
    return;
  }
  try{
    const [hbCd, igS, igE, hbR, igR] = await Promise.all([
      heart.heartbeatCooldownSeconds(),
      heart.igniteWindowStart(),
      heart.igniteWindowEnd(),
      heart.heartbeatReward(),
      heart.igniteReward(),
    ]);
    UI.defaults.hbCooldownSec = hbCd.toNumber();
    UI.defaults.igStart = igS.toNumber();
    UI.defaults.igEnd = igE.toNumber();
    UI.defaults.hbReward = hbR.toString();
    UI.defaults.igReward = igR.toString();

    $("hbReward").textContent = UI.defaults.hbReward;
    $("igReward").textContent = UI.defaults.igReward;
    $("igWindowTxt").textContent = fmtUTCWindow(UI.defaults.igStart, UI.defaults.igEnd);

    // optionally read orphanPool into UI if empty
    try{
      const op = await heart.orphanPool();
      if ($("orphanAddr").value.trim()==="" && ethers.utils.isAddress(op)){
        $("orphanAddr").value = op;
      }
    }catch(_){}

    // show heart balance/cap
    let extra = "";
    try{
      const [hbWhole, capWhole, floorWhole] = await Promise.all([
        heart.heartBalanceWhole(),
        heart.effectiveCapWhole(),
        heart.effectiveFloorWhole()
      ]);
      extra = `ï½œå¿ƒè‡Ÿè¡€é‡ ${hbWhole.toString()} / cap ${capWhole.toString()}ï¼ˆfloor ${floorWhole.toString()}ï¼‰`;
    }catch(_){}
    $("hbIgOut").textContent = "å·²åµæ¸¬ Heart åˆç´„" + extra;

  }catch(e){
    $("hbIgOut").textContent = "è®€å–åˆç´„åƒæ•¸å¤±æ•—ï¼šè«‹ç¢ºèªéˆ= BSCã€åˆç´„åœ°å€æ­£ç¢ºã€ä¸”å·²é©—è­‰éƒ¨ç½²ã€‚";
  }
}

$("btnInspector").onclick = async ()=>{
  const out = $("inspectOut");
  out.textContent = "";
  const heartAddr = $("heartAddr").value.trim();
  const kgenAddr = $("kgenAddr").value.trim();

  const checks = [];
  checks.push(["åµæ¸¬éŒ¢åŒ…", !!window.ethereum]);
  checks.push(["å·²é€£ç·šå¸³æˆ¶", !!account]);
  checks.push(["éˆæ˜¯å¦ BSC(56)", chainId===56]);
  checks.push(["KGEN åœ°å€æ ¼å¼", ethers.utils.isAddress(kgenAddr)]);
  checks.push(["Heart åœ°å€æ ¼å¼", ethers.utils.isAddress(heartAddr)]);

  let lines = checks.map(([k,v])=>`- ${k}ï¼š${v ? "OK" : "NOT OK"}`).join("\n");

  // read balances if possible
  try{
    if (kgen && account){
      const bal = await kgen.balanceOf(account);
      const dec = await kgen.decimals();
      const fmt = ethers.utils.formatUnits(bal, dec);
      lines += `\n- æˆ‘çš„ KGENï¼š${fmt}`;
    }
  }catch(_){}
  try{
    if (heart){
      const hb = await heart.heartBalanceWhole();
      lines += `\n- Heart è¡€é‡ï¼ˆwholeï¼‰ï¼š${hb.toString()}`;
    }
  }catch(_){}

  out.textContent = lines;
  toast("ç›£å·¥æª¢æŸ¥å·²æ›´æ–°");
};

/* ====== Countdown (heartbeat & ignite) ====== */
let lastHB = 0;   // seconds
let lastFT = 0;
let lastIGDay = -1;

async function refreshUserTimers(){
  if (heart && account){
    try{
      const [lhb, lft, ligDay] = await Promise.all([
        heart.lastHeartbeatAt(account),
        heart.lastFortuneAt(account),
        heart.lastIgniteDay(account),
      ]);
      lastHB = lhb.toNumber();
      lastFT = lft.toNumber();
      lastIGDay = ligDay.toNumber();
    }catch(_){}
  }else{
    // local fallbacks
    lastHB = parseInt(LS.get("local_last_hb","0"),10) || 0;
    lastFT = parseInt(LS.get("local_last_ft","0"),10) || 0;
    lastIGDay = parseInt(LS.get("local_last_ig","-1"),10) || -1;
  }
}

function currentUTCSecondsOfDay(){
  const d = new Date();
  return (d.getUTCHours()*3600 + d.getUTCMinutes()*60 + d.getUTCSeconds());
}
function currentUTCDayIndex(){
  const now = Date.now();
  return Math.floor(now/86400000); // epoch days; matches solidity block.timestamp/1 days in UTC
}

function tickCountdown(){
  const now = Date.now();
  $("nowTxt").textContent = fmtDateTime(new Date());

  // Heartbeatï¼ˆæ•´é»å€’æ•¸ï¼‰ï¼šå›ºå®šå°é½Šã€Œæ¯å°æ™‚æ•´é»ã€é¡¯ç¤ºå€’æ•¸ï¼ˆèˆ‡éˆä¸Š cooldown ç„¡é—œï¼‰
  // ä½¿ç”¨ã€Œæœ¬æ©Ÿæ™‚é–“ã€çš„æ•´é»ï¼Œä½¿ç”¨è€…é«”æ„Ÿæœ€ç›´è¦ºã€‚
  let hbNext = 0;
  const dNow = new Date(now);
  const atTop = (dNow.getMinutes()===0 && dNow.getSeconds()===0);
  const dNext = new Date(dNow);
  dNext.setMilliseconds(0);
  if (atTop){
    hbNext = now; // å·²åœ¨æ•´é»
  }else{
    dNext.setMinutes(0,0,0);
    dNext.setHours(dNext.getHours()+1);
    hbNext = dNext.getTime();
  }

  const hbLeft = Math.max(0, hbNext - now);
  $("hbCountdown").textContent = fmtHMS(hbLeft);
  $("hbNextAt").textContent = (hbLeft===0) ? "æ•´é»åˆ°ï¼Œå¯é ˜" : ("æ•´é» @ " + new Date(hbNext).toLocaleTimeString());

  // Ignite window (UTC)
  const tod = currentUTCSecondsOfDay();
  const start = UI.defaults.igStart;
  const end = UI.defaults.igEnd;
  const inWindow = (tod>=start && tod<=end);

  // next window start time
  const nowUTC = new Date();
  const nextStart = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate(), 0,0,0,0) + start*1000);
  let target = nextStart.getTime();
  if (now > target + end*1000) {
    // already passed today window end -> tomorrow start
    target += 86400000;
  }
  // if we're before today's start, target is today's start; if inside window, countdown shows time to end
  if (inWindow){
    const winEnd = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate(), 0,0,0,0) + end*1000).getTime();
    $("igCountdown").textContent = "è¦–çª—ä¸­ " + fmtHMS(winEnd-now);
  }else{
    $("igCountdown").textContent = fmtHMS(target-now);
  }

  // Buttons enable
  $("btnHeartbeat").disabled = (hbNext!==0 && hbLeft>0) || (!account || !heart);
  // ignite allowed only in window & once per day
  const dayIdx = currentUTCDayIndex();
  const alreadyToday = (lastIGDay === dayIdx);
  $("btnIgnite").disabled = (!account) || (!inWindow) || alreadyToday;

  requestAnimationFrame(()=>{});
}

setInterval(tickCountdown, 350);
setInterval(refreshUserTimers, 8000);
refreshUserTimers();

/* ====== Cupoe gate ====== */
let cupProg = parseInt(LS.get("kgen_cup_prog","0"),10) || 0;
let cupStreak = parseInt(LS.get("kgen_cup_streak","0"),10) || 0;
let cupUnlocked = (LS.get("kgen_cup_unlocked","0")==="1");

function syncCupUI(){
  $("cupProg").textContent = `${cupProg} / 3`;
  $("cupStreak").textContent = String(cupStreak);
  $("btnFortune").disabled = !(cupUnlocked && heart && account);
  if (cupUnlocked && (!heart || !account)){
    $("fortuneOut").textContent = "å·²å®Œæˆä¸‰æ¬¡è–ç›ƒï¼šæ¥ä¸‹ä¾†é€£æ¥éŒ¢åŒ…ä¸¦è²¼ä¸Š Heart åœ°å€å°±èƒ½ä¸Šéˆé ˜ç™¼è²¡é‡‘ã€‚";
  }
}
function resetCup(silent=false){
  cupProg=0; cupStreak=0; cupUnlocked=false;
  LS.set("kgen_cup_prog","0"); LS.set("kgen_cup_streak","0"); LS.set("kgen_cup_unlocked","0");
  $("cupLast").textContent = "--";
  syncCupUI();
  if(!silent) toast("è–ç›ƒå·²é‡ç½®");
}
$("btnCupReset").onclick = ()=>resetCup();

$("btnCup").onclick = ()=>{
  // Simulate holy cupoe: 50% success. Need 3 consecutive successes to unlock.
  const success = Math.random() < 0.5;
  $("cupLast").textContent = success ? "è–ç›ƒ" : "ç¬‘æ¯";
  if (success){
    cupStreak += 1;
    cupProg = Math.min(3, cupProg+1);
  }else{
    cupStreak = 0;
    cupProg = 0;
  }
  if (cupProg>=3){
    cupUnlocked = true;
    LS.set("kgen_cup_unlocked","1");
    toast("ä¸‰æ¬¡è–ç›ƒå®Œæˆï¼šå·²è§£é–é ˜ç™¼è²¡é‡‘");
  }
  LS.set("kgen_cup_prog", String(cupProg));
  LS.set("kgen_cup_streak", String(cupStreak));
  syncCupUI();
};
syncCupUI();

/* ====== Fortune / Heartbeat / Ignite actions ====== */
async function requireChainReady(){
  if (!account || !provider || !signer) { toast("è«‹å…ˆé€£æ¥éŒ¢åŒ…"); return false; }
  if (chainId !== 56) { toast("è«‹å…ˆåˆ‡åˆ° BSC (0x38)"); return false; }
  if (!heart) { toast("è«‹å…ˆè²¼ Heart åˆç´„åœ°å€"); return false; }
  return true;
}

$("btnHeartbeat").onclick = async ()=>{
  if (!(await requireChainReady())) return;
  try{
    const tx = await heart.connect(signer).heartbeatClaim();
    $("hbIgOut").textContent = "å¿ƒè·³å·²é€å‡ºäº¤æ˜“ï¼š" + tx.hash;
    toast("å¿ƒè·³ä¸Šéˆä¸­â€¦");
    await tx.wait();
    $("hbIgOut").textContent = "å¿ƒè·³æˆåŠŸï¼ˆéˆä¸Šå·²è¨˜éŒ„äº‹ä»¶ï¼‰";
    toast("å¿ƒè·³æˆåŠŸ");
    await refreshUserTimers();
  }catch(e){
    $("hbIgOut").textContent = "å¿ƒè·³å¤±æ•—ï¼š" + (e?.reason || e?.message || "unknown");
    toast("å¿ƒè·³å¤±æ•—");
  }
};

$("btnIgnite").onclick = async ()=>{
  if (!(await requireChainReady())) return;
  try{
    const tx = await heart.connect(signer).igniteAndClaim();
    $("hbIgOut").textContent = "é»ç«å·²é€å‡ºäº¤æ˜“ï¼š" + tx.hash;
    toast("é»ç«ä¸Šéˆä¸­â€¦");
    await tx.wait();
    $("hbIgOut").textContent = "é»ç«æˆåŠŸï¼ˆéˆä¸Šå·²è¨˜éŒ„äº‹ä»¶ï¼‰";
    toast("é»ç«æˆåŠŸ");
    await refreshUserTimers();
  }catch(e){
    $("hbIgOut").textContent = "é»ç«å¤±æ•—ï¼š" + (e?.reason || e?.message || "unknown");
    toast("é»ç«å¤±æ•—");
  }
};

$("btnFortune").onclick = async ()=>{
  if (!(await requireChainReady())) return;
  if (!cupUnlocked){ toast("å…ˆå®Œæˆä¸‰æ¬¡è–ç›ƒ"); return; }
  const amt = parseInt($("fortuneAmt").value, 10);
  if (!Number.isFinite(amt) || amt<1 || amt>888){ toast("é‡‘é¡éœ€åœ¨ 1â€“888"); return; }
  try{
    const tx = await heart.connect(signer).fortuneClaim(amt);
    $("fortuneOut").textContent = "ç™¼è²¡é‡‘å·²é€å‡ºäº¤æ˜“ï¼š" + tx.hash;
    toast("ç™¼è²¡é‡‘ä¸Šéˆä¸­â€¦");
    await tx.wait();
    $("fortuneOut").textContent = "ç™¼è²¡é‡‘æˆåŠŸï¼šä½ å·²é ˜åˆ° " + amt + " KGENï¼ˆäº‹ä»¶å·²è¨˜éŒ„ï¼‰";
    toast("é ˜å–æˆåŠŸ");
    await refreshUserTimers();
  }catch(e){
    $("fortuneOut").textContent = "é ˜å–å¤±æ•—ï¼š" + (e?.reason || e?.message || "unknown");
    toast("é ˜å–å¤±æ•—");
  }
};

$("btnFortuneCheck").onclick = async ()=>{
  if (!heart || !account){ $("fortuneOut").textContent = "è«‹å…ˆé€£æ¥éŒ¢åŒ…ä¸¦è²¼ Heart åœ°å€ã€‚"; return; }
  try{
    const [min,max,cool,es,em,epoch] = await Promise.all([
      heart.fortuneMin(), heart.fortuneMax(), heart.fortuneCooldownSeconds(),
      heart.fortuneEpochSeconds(), heart.fortuneEpochMaxClaims(),
      heart.currentFortuneEpochIndex()
    ]);
    const used = await heart.fortuneEpochClaims(epoch);
    const last = await heart.lastFortuneAt(account);
    const next = last.toNumber()*1000 + cool.toNumber()*1000;
    const left = next - Date.now();
    $("fortuneOut").textContent =
      `ç¯„åœ ${min.toString()}â€“${max.toString()}ï½œå†·å» ${cool.toString()}sï½œæœ¬æœŸ ${used.toString()}/${em.toString()}ï¼ˆæœŸé•· ${es.toString()}sï¼‰ï½œä¸‹æ¬¡å¯é ˜ï¼š` +
      (left<=0 ? "ç¾åœ¨" : fmtHMS(left));
  }catch(e){
    $("fortuneOut").textContent = "æŸ¥è©¢å¤±æ•—ï¼šè«‹ç¢ºèªéˆèˆ‡åˆç´„ã€‚";
  }
};

/* ====== Wish hash / on-chain ====== */
async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  const arr = Array.from(new Uint8Array(buf));
  return "0x" + arr.map(b=>b.toString(16).padStart(2,"0")).join("");
}
$("btnWishHash").onclick = async ()=>{
  const w = $("wishText").value.trim();
  if (!w){ toast("è«‹å…ˆè¼¸å…¥é¡˜æœ›"); return; }
  LS.set("kgen_wish_text", w);
  const h = await sha256Hex(w);
  $("wishOut").textContent = "wishHash = " + h;
  toast("å·²ç”¢ç”Ÿ hash");
  // if chain ready, send on-chain
  if (await requireChainReady()){
    try{
      const tx = await heart.connect(signer).makeWish(h);
      $("wishOut").textContent = "ä¸Šéˆé€å‡ºï¼š" + tx.hash;
      toast("è¨±é¡˜ä¸Šéˆä¸­â€¦");
      await tx.wait();
      $("wishOut").textContent = "è¨±é¡˜å·²ä¸Šéˆï¼ˆhash ç•™å­˜ï¼‰ï¼š" + h;
      toast("è¨±é¡˜æˆåŠŸ");
    }catch(e){
      $("wishOut").textContent = "ä¸Šéˆå¤±æ•—ï¼ˆä½† hash å·²ç”¢ç”Ÿï¼‰ï¼š" + h;
      toast("ä¸Šéˆå¤±æ•—");
    }
  }
};

/* ====== Approve / Vow / Lamp ====== */
$("btnApprove").onclick = async ()=>{
  if (!account || !provider || !signer){ toast("è«‹å…ˆé€£æ¥éŒ¢åŒ…"); return; }
  if (chainId !== 56){ toast("è«‹å…ˆåˆ‡åˆ° BSC"); return; }
  const heartAddr = $("heartAddr").value.trim();
  const kgenAddr = $("kgenAddr").value.trim();
  if (!ethers.utils.isAddress(heartAddr) || !ethers.utils.isAddress(kgenAddr)){ toast("åœ°å€ä¸æ­£ç¢º"); return; }
  try{
    const token = new ethers.Contract(kgenAddr, ERC20_ABI, signer);
    const dec = await token.decimals();
    // approve a generous amount (e.g. 1,000,000 KGEN) to avoid repeated approvals
    const amount = ethers.utils.parseUnits("1000000", dec);
    const tx = await token.approve(heartAddr, amount);
    $("vowOut").textContent = "Approve é€å‡ºï¼š" + tx.hash;
    toast("Approve ä¸Šéˆä¸­â€¦");
    await tx.wait();
    $("vowOut").textContent = "Approve å®Œæˆï¼šå¯é‚„é¡˜/é»ç‡ˆ";
    toast("Approve å®Œæˆ");
  }catch(e){
    $("vowOut").textContent = "Approve å¤±æ•—ï¼š" + (e?.reason || e?.message || "unknown");
    toast("Approve å¤±æ•—");
  }
};

$("btnVow").onclick = async ()=>{
  if (!(await requireChainReady())) return;
  const amt = parseInt($("vowAmt").value,10);
  if (!Number.isFinite(amt) || amt<=0){ toast("é‡‘é¡éœ€ > 0"); return; }
  try{
    const tx = await heart.connect(signer).vowTo(0, amt);
    $("vowOut").textContent = "é‚„é¡˜é€å‡ºï¼š" + tx.hash;
    toast("é‚„é¡˜ä¸Šéˆä¸­â€¦");
    await tx.wait();
    $("vowOut").textContent = "é‚„é¡˜å®Œæˆï¼šæ‚Ÿç©ºè£œè¡€æˆåŠŸ";
    toast("é‚„é¡˜å®Œæˆ");
  }catch(e){
    $("vowOut").textContent = "é‚„é¡˜å¤±æ•—ï¼š" + (e?.reason || e?.message || "unknown");
    toast("é‚„é¡˜å¤±æ•—");
  }
};

$("btnLamp").onclick = async ()=>{
  if (!(await requireChainReady())) return;
  const days = parseInt($("lampDays").value,10);
  if (!Number.isFinite(days) || days<=0){ toast("å¤©æ•¸éœ€ > 0"); return; }
  try{
    const tx = await heart.connect(signer).lightLamp(days);
    $("vowOut").textContent = "é»ç‡ˆé€å‡ºï¼š" + tx.hash;
    toast("é»ç‡ˆä¸Šéˆä¸­â€¦");
    await tx.wait();
    $("vowOut").textContent = "é»ç‡ˆå®Œæˆï¼šä½ çš„ç‡ˆç«å·²å»¶é•·";
    toast("é»ç‡ˆå®Œæˆ");
  }catch(e){
    $("vowOut").textContent = "é»ç‡ˆå¤±æ•—ï¼š" + (e?.reason || e?.message || "unknown");
    toast("é»ç‡ˆå¤±æ•—");
  }
};

/* ====== AIå®¢æœï¼ˆFAQ + speechï¼‰ ====== */
function setChat(text){
  $("chatBox").value = text;
  LS.set("kgen_chat", text);
}
function appendChat(text){
  const cur = $("chatBox").value.trim();
  const next = (cur ? cur + "\n\n" : "") + text;
  setChat(next);
}
function answerFAQ(key){
  const base = `ã€äº”æŒ‡å±± 12345ãƒ»æ‚Ÿç©ºè²¡ç¥æ®¿ï½œå®¢æœä»™å¥³ã€‘\n`;
  const heartAddr = $("heartAddr").value.trim();
  const hasHeart = ethers.utils.isAddress(heartAddr);
  const lines = [];
  if (key==="nowallet"){
    lines.push("ä½ ç¾åœ¨æ²’æœ‰éŒ¢åŒ…ï¼šè«‹å…ˆåœ¨æ‰‹æ©Ÿå®‰è£ MetaMask æˆ– Trust Walletã€‚");
    lines.push("å®‰è£å¾Œå»ºç«‹éŒ¢åŒ…ï¼ŒåŠ©è¨˜è©è¦æ‰‹æŠ„ä¿å­˜ï¼Œçµ•å°ä¸è¦æˆªåœ–æˆ–å‚³çµ¦ä»»ä½•äººã€‚");
    lines.push("å›åˆ°ç¥æ®¿é é¢ï¼ŒæŒ‰ã€é€£æ¥éŒ¢åŒ…ã€ã€‚");
  } else if (key==="connect"){
    lines.push("æŒ‰å³ä¸Šã€é€£æ¥éŒ¢åŒ…ã€ï¼Œåœ¨éŒ¢åŒ…è·³å‡ºçš„è¦–çª—æŒ‰ã€é€£ç·š/ç¢ºèªã€ã€‚");
    lines.push("é€£ç·šå¾Œä½ æœƒçœ‹åˆ°ã€éŒ¢åŒ…å·²é€£ç·šã€èˆ‡åœ°å€ç¸®å¯«ã€‚");
  } else if (key==="bsc"){
    lines.push("æœ¬ç¥æ®¿è¦ç”¨ BSC ä¸»ç¶²ï¼šchainId 56ï¼ˆ0x38ï¼‰ã€‚");
    lines.push("æŒ‰ã€åˆ‡æ›åˆ° BSC (0x38)ã€ï¼Œè‹¥éŒ¢åŒ…å•ä½ è¦ä¸è¦æ–°å¢éˆï¼ŒæŒ‰åŒæ„ã€‚");
  } else if (key==="heart"){
    lines.push("Heart åˆç´„åœ°å€ï¼šæ˜¯ä½ éƒ¨ç½²å¿ƒè‡Ÿåˆç´„å¾Œå¾—åˆ°çš„ 0x...ã€‚");
    lines.push("è²¼åˆ°ã€Heart åˆç´„åœ°å€ã€æ¬„ä½ â†’ æŒ‰ã€ä¿å­˜åœ°å€ã€ã€‚");
    lines.push("ä½ ç¾åœ¨" + (hasHeart ? "å·²è²¼ä¸Šï¼Œä¸‹ä¸€æ­¥å¯ä»¥ä¸Šéˆäº’å‹•ã€‚" : "å°šæœªè²¼ä¸Šï¼Œå…ˆå®Œæˆéƒ¨ç½²å†è²¼ã€‚"));
  } else if (key==="cup"){
    lines.push("ä¸‰æ¬¡è–ç›ƒæ˜¯é˜² Bot çš„é–€æª»ï¼šé€£çºŒæˆåŠŸ 3 æ¬¡æ‰è§£é–ã€é ˜ç™¼è²¡é‡‘ã€ã€‚");
    lines.push("æŒ‰ã€ææ¯ä¸€æ¬¡ã€ç›´åˆ°é€²åº¦é¡¯ç¤º 3/3ã€‚è‹¥ç¬‘æ¯æœƒé‡ç½®ã€‚");
  } else if (key==="fortune"){
    lines.push("é ˜ç™¼è²¡é‡‘æ¢ä»¶ï¼šâ‘  éŒ¢åŒ…é€£ç·š â‘¡ éˆåœ¨ BSC â‘¢ å·²è²¼ Heart åˆç´„åœ°å€ â‘£ ä¸‰æ¬¡è–ç›ƒå®Œæˆã€‚");
    lines.push("åœ¨ã€è¦é ˜å¤šå°‘ç™¼è²¡é‡‘ã€è¼¸å…¥ 1â€“888ï¼ŒæŒ‰ã€é ˜ç™¼è²¡é‡‘ï¼ˆä¸Šéˆï¼‰ã€ã€‚");
    lines.push("æˆåŠŸå¾Œéˆä¸Šæœƒæœ‰äº‹ä»¶ç´€éŒ„ï¼Œä½ ä¹Ÿæœƒæ”¶åˆ° KGENã€‚");
  } else if (key==="approve"){
    lines.push("é‚„é¡˜/é»ç‡ˆæœƒæŠŠ KGEN å¾ä½ éŒ¢åŒ…è½‰å…¥ Heartï¼ˆtransferFromï¼‰ï¼Œæ‰€ä»¥è¦å…ˆ approve æˆæ¬Šã€‚");
    lines.push("æŒ‰ã€å…ˆ Approveã€ï¼ŒæˆåŠŸå¾Œå†æŒ‰ã€é‚„é¡˜ã€æˆ–ã€é»ç‡ˆã€ã€‚");
  } else if (key==="fail"){
    lines.push("äº¤æ˜“å¤±æ•—å¸¸è¦‹åŸå› ï¼š");
    lines.push("1) éˆä¸å°ï¼šè«‹åˆ‡åˆ° BSCã€‚");
    lines.push("2) Heart åœ°å€è²¼éŒ¯ï¼šè«‹ç¢ºèªæ˜¯å¿ƒè‡Ÿåˆç´„åœ°å€ã€‚");
    lines.push("3) æ²’æœ‰è¶³å¤  BNB æ”¯ä»˜ gasã€‚");
    lines.push("4) å†·å»æ™‚é–“æœªåˆ°æˆ–ä¸åœ¨é»ç«è¦–çª—ã€‚");
    lines.push("å¦‚æœä½ æŠŠéŒ¯èª¤è¨Šæ¯è²¼ä¸Šä¾†ï¼Œæˆ‘å¯ä»¥å¹«ä½ åˆ¤æ–·æ˜¯å“ªä¸€ç¨®ã€‚");
  } else {
    lines.push("è«‹å…ˆé¸ä¸€å€‹å•é¡Œï¼Œæˆ‘æœƒä¸€æ­¥ä¸€æ­¥æ•™ä½ åšåˆ°ã€é ˜åˆ°ç™¼è²¡é‡‘ã€ã€‚");
  }
  return base + lines.join("\n");
}
$("btnAsk").onclick = ()=>{
  const key = $("faq").value;
  const ans = answerFAQ(key);
  appendChat(ans);
  toast("å·²è¼¸å‡ºå®¢æœè§£èªª");
};
$("btnSpeak").onclick = ()=>{
  const text = $("chatBox").value.trim();
  if (!text){ toast("æ²’æœ‰å…§å®¹å¯ä»¥å”¸"); return; }
  try{
    const u = new SpeechSynthesisUtterance(text.slice(-500)); // speak last part
    u.lang = "zh-TW";
    speechSynthesis.speak(u);
    toast("èªéŸ³å·²æ’­æ”¾");
  }catch(_){
    toast("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³");
  }
};
$("btnCopyChat").onclick = async ()=>{
  try{
    await navigator.clipboard.writeText($("chatBox").value);
    toast("å·²è¤‡è£½");
  }catch(_){ toast("è¤‡è£½å¤±æ•—"); }
};
$("btnClearChat").onclick = ()=>{
  setChat("");
  toast("å·²æ¸…ç©ºå®¢æœå°è©±");
};

/* ====== Media: Camera / Photo / Video / Photo+Voice ====== */
let camStream=null;
let micStream=null;

const camEl = $("cam");
const canvas = $("canvas");
const ctx = canvas.getContext("2d");

function getOverlayText(){
  const note = ($("noteText").value || "").trim();
  const wish = ($("wishText").value || "").trim();
  const wallet = account ? (account.slice(0,6)+"â€¦"+account.slice(-4)) : "no-wallet";
  const ts = new Date().toLocaleString();
  return {
    top: `äº”æŒ‡å±± 12345 æ‚Ÿç©ºè²¡ç¥æ®¿  ${UI.ver}`,
    mid: note ? `ç•™è¨€ï¼š${note}` : "",
    bot: wish ? `è¨±é¡˜ï¼š${wish}` : "",
    foot: `${ts}  Â·  ${wallet}`
  };
}

// fit cover from video to canvas, no shrinking
function drawFrameToCanvas(video){
  const vw = video.videoWidth || 1280;
  const vh = video.videoHeight || 720;

  // set canvas to match camera aspect (keep good detail)
  const targetW = vw;
  const targetH = vh;
  if (canvas.width !== targetW || canvas.height !== targetH){
    canvas.width = targetW;
    canvas.height = targetH;
  }

  // draw
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  drawWatermark();
}

function drawWatermark(){
  const t = getOverlayText();
  // dark gradient at bottom for readability
  const g = ctx.createLinearGradient(0, canvas.height*0.72, 0, canvas.height);
  g.addColorStop(0, "rgba(0,0,0,0)");
  g.addColorStop(1, "rgba(0,0,0,.55)");
  ctx.fillStyle = g;
  ctx.fillRect(0, canvas.height*0.70, canvas.width, canvas.height*0.30);

  const pad = Math.max(16, Math.round(canvas.width*0.02));
  ctx.font = `bold ${Math.max(22, Math.round(canvas.width*0.028))}px system-ui`;
  ctx.fillStyle = "rgba(255,210,125,.95)";
  ctx.shadowColor = "rgba(0,0,0,.55)";
  ctx.shadowBlur = 10;
  ctx.fillText(t.top, pad, pad + Math.max(28, Math.round(canvas.width*0.03)));

  ctx.shadowBlur = 0;
  ctx.font = `${Math.max(16, Math.round(canvas.width*0.020))}px system-ui`;
  ctx.fillStyle = "rgba(255,255,255,.92)";
  const lineH = Math.max(22, Math.round(canvas.width*0.028));
  const footY = canvas.height - pad;

  // Start the bottom block ABOVE the footer line to avoid overlap on mobile
  const lines = (t.mid ? 1 : 0) + (t.bot ? 1 : 0);
  let y = footY - (lines * lineH) - Math.round(lineH * 0.6);

  if (t.mid){
    wrapText(t.mid, pad, y, canvas.width - pad*2, lineH);
    y += lineH * 1.2;
  }
  if (t.bot){
    wrapText(t.bot, pad, y, canvas.width - pad*2, lineH);
    y += lineH * 1.2;
  }

  ctx.fillStyle = "rgba(255,255,255,.70)";
  ctx.font = `${Math.max(14, Math.round(canvas.width*0.018))}px ui-monospace`;
  ctx.fillText(t.foot, pad, footY);
}

function wrapText(text, x, y, maxW, lineH){
  const words = text.split("");
  let line = "";
  for (let i=0;i<words.length;i++){
    const test = line + words[i];
    const w = ctx.measureText(test).width;
    if (w > maxW && i>0){
      ctx.fillText(line, x, y);
      line = words[i];
      y += lineH;
    }else{
      line = test;
    }
  }
  ctx.fillText(line, x, y);
}

async function camOn(){
  try{
    camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio:false });
    camEl.srcObject = camStream;
    $("camState").textContent = "on";
    toast("ç›¸æ©Ÿå·²é–‹å•Ÿ");
    // enable photo+voice once a photo exists
  }catch(e){
    toast("ç›¸æ©Ÿæ¬Šé™è¢«æ‹’æˆ–ä¸å¯ç”¨");
  }
}
function camOff(){
  if (camStream){
    camStream.getTracks().forEach(t=>t.stop());
    camStream=null;
  }
  camEl.srcObject = null;
  $("camState").textContent = "off";
  toast("ç›¸æ©Ÿå·²é—œé–‰");
}

$("btnCamOn").onclick = camOn;
$("btnCamOff").onclick = camOff;

let lastPhotoBlob=null;
$("btnShot").onclick = ()=>{
  if (!camStream || !camEl.videoWidth){ toast("è«‹å…ˆé–‹å•Ÿç›¸æ©Ÿ"); return; }
  drawFrameToCanvas(camEl);
  canvas.toBlob((b)=>{
    lastPhotoBlob = b;
    $("btnDlPhoto").disabled = !b;
    $("btnPhotoVoice").disabled = !b;
    toast("æ‹ç…§å®Œæˆï¼ˆå¯ä¸‹è¼‰ï¼‰");
  }, "image/png", 0.95);
};

$("btnDlPhoto").onclick = ()=>{
  if (!lastPhotoBlob){ toast("å°šæœªæ‹ç…§"); return; }
  const url = URL.createObjectURL(lastPhotoBlob);
  downloadURL(url, `WUKONG_TEMPLE_12345_${UI.ver}_${Date.now()}.png`);
  setTimeout(()=>URL.revokeObjectURL(url), 10000);
};

/* ---- Video recording with audio ---- */
let rec=null, recChunks=[], recBlob=null;
$("btnRecVideo").onclick = async ()=>{
  if (!camStream){ toast("è«‹å…ˆé–‹å•Ÿç›¸æ©Ÿ"); return; }
  try{
    // Get mic + merge tracks
    micStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
    const mix = new MediaStream([
      ...camStream.getVideoTracks(),
      ...micStream.getAudioTracks()
    ]);
    recChunks = [];
    recBlob = null;
    rec = new MediaRecorder(mix, { mimeType: pickMime() });
    rec.ondataavailable = (e)=>{ if (e.data && e.data.size>0) recChunks.push(e.data); };
    rec.onstop = ()=>{
      recBlob = new Blob(recChunks, { type: rec.mimeType });
      $("btnDlVideo").disabled = false;
      $("exportState").textContent = "video-ready";
      toast("éŒ„å½±å®Œæˆï¼ˆå¯ä¸‹è¼‰ï¼‰");
      // stop mic
      if (micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream=null; }
    };
    rec.start(250);
    $("btnStopVideo").disabled = false;
    $("btnRecVideo").disabled = true;
    $("exportState").textContent = "recording";
    toast("é–‹å§‹éŒ„å½±ï¼ˆå«è²éŸ³ï¼‰");
  }catch(e){
    toast("éŒ„å½±å¤±æ•—ï¼šè«‹å…è¨±éº¥å…‹é¢¨");
  }
};

$("btnStopVideo").onclick = ()=>{
  try{
    if (rec && rec.state !== "inactive") rec.stop();
  }catch(_){}
  $("btnStopVideo").disabled = true;
  $("btnRecVideo").disabled = false;
};

$("btnDlVideo").onclick = ()=>{
  if (!recBlob){ toast("å°šç„¡å½±ç‰‡"); return; }
  const url = URL.createObjectURL(recBlob);
  downloadURL(url, `WUKONG_TEMPLE_12345_VIDEO_${UI.ver}_${Date.now()}.webm`);
  setTimeout(()=>URL.revokeObjectURL(url), 10000);
};

/* ---- Photo + Voice => video (canvas stream + mic audio) ---- */
let pvRec=null, pvChunks=[], pvBlob=null;
let pvAnim=null;
$("btnPhotoVoice").onclick = async ()=>{
  if (!lastPhotoBlob){ toast("è«‹å…ˆæ‹ç…§"); return; }
  try{
    // ensure mic
    micStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
    // canvas stream at 30fps
    const cvsStream = canvas.captureStream(30);
    const mix = new MediaStream([
      ...cvsStream.getVideoTracks(),
      ...micStream.getAudioTracks()
    ]);

    pvChunks = [];
    pvBlob = null;

    // Keep drawing watermark time ticking while recording (small animation)
    const img = await blobToImage(lastPhotoBlob);
    let start = performance.now();
    const loop = (t)=>{
      // draw still image
      if (canvas.width !== img.naturalWidth || canvas.height !== img.naturalHeight){
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
      }
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      // tiny pulse dot
      const dt = (t-start)/1000;
      const pulse = 0.55 + 0.45*Math.sin(dt*6.0);
      ctx.fillStyle = `rgba(255,210,125,${pulse})`;
      ctx.beginPath();
      ctx.arc(canvas.width-28, 28, 8, 0, Math.PI*2);
      ctx.fill();
      drawWatermark();
      pvAnim = requestAnimationFrame(loop);
    };
    pvAnim = requestAnimationFrame(loop);

    pvRec = new MediaRecorder(mix, { mimeType: pickMime() });
    pvRec.ondataavailable = (e)=>{ if (e.data && e.data.size>0) pvChunks.push(e.data); };
    pvRec.onstop = ()=>{
      if (pvAnim) cancelAnimationFrame(pvAnim);
      pvAnim = null;
      pvBlob = new Blob(pvChunks, { type: pvRec.mimeType });
      $("btnDlPV").disabled = false;
      $("exportState").textContent = "photo-voice-ready";
      toast("ç…§ç‰‡ï¼‹èªéŸ³å®Œæˆï¼ˆå¯ä¸‹è¼‰ï¼‰");
      if (micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream=null; }
    };
    pvRec.start(250);
    $("btnStopPV").disabled = false;
    $("btnPhotoVoice").disabled = true;
    $("exportState").textContent = "photo-voice-recording";
    toast("é–‹å§‹éŒ„ï¼šç…§ç‰‡ï¼‹èªéŸ³ï¼ˆå†æŒ‰åœæ­¢ï¼‰");
  }catch(e){
    toast("ç…§ç‰‡ï¼‹èªéŸ³å¤±æ•—ï¼šè«‹å…è¨±éº¥å…‹é¢¨");
  }
};

$("btnStopPV").onclick = ()=>{
  try{
    if (pvRec && pvRec.state !== "inactive") pvRec.stop();
  }catch(_){}
  $("btnStopPV").disabled = true;
  $("btnPhotoVoice").disabled = false;
};

$("btnDlPV").onclick = ()=>{
  if (!pvBlob){ toast("å°šç„¡åˆæˆå½±ç‰‡"); return; }
  const url = URL.createObjectURL(pvBlob);
  downloadURL(url, `WUKONG_TEMPLE_12345_PHOTO_VOICE_${UI.ver}_${Date.now()}.webm`);
  setTimeout(()=>URL.revokeObjectURL(url), 10000);
};

function pickMime(){
  const cands = [
    "video/webm;codecs=vp9,opus",
    "video/webm;codecs=vp8,opus",
    "video/webm"
  ];
  for (const m of cands){
    if (MediaRecorder.isTypeSupported(m)) return m;
  }
  return "";
}
function downloadURL(url, filename){
  const a=document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}
function blobToImage(blob){
  return new Promise((res, rej)=>{
    const url = URL.createObjectURL(blob);
    const img = new Image();
    img.onload = ()=>{ URL.revokeObjectURL(url); res(img); };
    img.onerror = (e)=>{ URL.revokeObjectURL(url); rej(e); };
    img.src = url;
  });
}

/* ====== Boot ====== */
$("igWindowTxt").textContent = fmtUTCWindow(UI.defaults.igStart, UI.defaults.igEnd);
setWalletUI(false);

  // Always run local clock + countdown (works even without wallet)
  try {
    tickCountdowns();
    setInterval(tickCountdowns, 1000);
  } catch (e) {
    console.warn("countdown init failed", e);
  }

// Auto-bind refresh when heartAddr changes
$("heartAddr").addEventListener("change", async ()=>{
  LS.set("kgen_heart_addr", $("heartAddr").value.trim());
  await hydrateContracts();
});
$("orphanAddr").addEventListener("change", ()=>LS.set("kgen_orphan_addr", $("orphanAddr").value.trim()));
$("wishText").addEventListener("change", ()=>LS.set("kgen_wish_text", $("wishText").value));
$("noteText").addEventListener("change", ()=>LS.set("kgen_note_text", $("noteText").value));

// keep fortune button state synced with wallet/heart/cup
setInterval(()=>{ syncCupUI(); }, 900);

// initial hydration if wallet already authorized
(async ()=>{
  if (window.ethereum){
    await ensureProvider();
    try{
      const accs = await provider.listAccounts();
      if (accs && accs.length){
        account = accs[0];
        signer = provider.getSigner();
        const net = await provider.getNetwork();
        chainId = net.chainId;
        setWalletUI(true);
        await hydrateContracts();
      }
    }catch(_){}
  }
})();

// ---- Countdown bootstrap (must work even if wallet/boot fails) ----
(function(){
  if (window.__TEMPLE_COUNTDOWN_STARTED__) return;
  window.__TEMPLE_COUNTDOWN_STARTED__ = true;
  const start = () => {
    try{
      tickCountdown();
      if(!window.__TEMPLE_COUNTDOWN_INTERVAL__){ window.__TEMPLE_COUNTDOWN_INTERVAL__ = setInterval(tickCountdown, 1000); }
    }catch(e){
      console.warn('countdown start failed', e);
    }
  };
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', start);
  } else {
    start();
  }
})();

</script>

<script>
/* =========================================================
   V6.6p17 HOTFIX
   - Heartbeat countdown aligned to top-of-hour (local time)
   - Ignite countdown kept to UTC 00:00-00:10 window
   - Support chat: one-question-one-answer + stop button
   ========================================================= */
(function(){
  const $id = (id)=>document.getElementById(id);

  // -------- Countdown (always available, even if chain read fails) --------
  function pad2(n){ n=Math.max(0, Math.floor(n)); return (n<10?'0':'')+n; }
  function fmtHMS(sec){
    if (!isFinite(sec)) return '--:--:--';
    sec = Math.max(0, Math.floor(sec));
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    const s = sec%60;
    return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
  }
  function secondsToNextTopOfHourLocal(now){
    const next = new Date(now);
    next.setMinutes(0,0,0);
    next.setHours(next.getHours()+1);
    return (next.getTime() - now.getTime())/1000;
  }
  function secondsToIgniteWindowUTC(now){
    // ignite window: UTC 00:00:00 ~ 00:10:00
    const y = now.getUTCFullYear(), mo = now.getUTCMonth(), d = now.getUTCDate();
    const start = Date.UTC(y, mo, d, 0, 0, 0);
    const end   = Date.UTC(y, mo, d, 0,10, 0);
    const t = now.getTime();
    if (t < start) return (start - t)/1000;          // countdown to today's window
    if (t >= start && t < end) return 0;             // in-window (can claim now)
    // after window: countdown to tomorrow start
    const tomorrow = Date.UTC(y, mo, d+1, 0,0,0);
    return (tomorrow - t)/1000;
  }

  window.tickCountdowns = function tickCountdowns(){
    try{
      const now = new Date();
      const hb = $id('hbCountdown');
      const ig = $id('igCountdown');

      if (hb) hb.textContent = fmtHMS(secondsToNextTopOfHourLocal(now));
      if (ig){
        const s = secondsToIgniteWindowUTC(now);
        ig.textContent = (s===0) ? '00:00:00' : fmtHMS(s);
      }
    }catch(e){ /* silent */ }
  }

  // -------- Support Chat (one Q one A) --------
  let typingTimer = null;
  let typingAbort = false;

  // -------- Voice Input (SpeechRecognition) --------
  let speechRec = null;
  let speechListening = false;
  function setMicStatus(msg){
    const el = $id('micStatus');
    if (el) el.textContent = msg || '';
  }

  function appendLine(text){
    const box = $id('chatBox');
    if (!box) return;
    box.value += (box.value ? '\n' : '') + text;
    box.scrollTop = box.scrollHeight;
  }

  function genReply(q){
    const s = String(q||'').trim();
    const low = s.toLowerCase();

    // quick keyword routing (offlineå®¢æœï¼Œä¸é€£ç¶²)
    if (!s) return 'è«‹å…ˆè¼¸å…¥å•é¡Œã€‚';
    if (low.includes('å€’æ•¸') || s.includes('å¿ƒè·³') || s.includes('é»ç«')) {
      return 'å·²ç¢ºèªï¼šå¿ƒè·³å€’æ•¸ä»¥ã€Œæœ¬åœ°æ™‚é–“æ•´é»ã€è¨ˆç®—ï¼›é»ç«å€’æ•¸ä»¥ã€ŒUTC 00:00-00:10ã€è¨ˆç®—ã€‚è‹¥ä»é¡¯ç¤º --:--:--ï¼Œè«‹å…ˆå¼·åˆ¶é‡æ–°æ•´ç†æˆ–æ¸…é™¤å¿«å–å†æ¸¬ã€‚';
    }
    if (low.includes('æ‹ç…§') || s.includes('ç…§ç‰‡') || s.includes('è¨±é¡˜') || s.includes('ç•™è¨€')) {
      return 'æ‹ç…§æµç¨‹ï¼š1) å…è¨±ç›¸æ©Ÿæ¬Šé™ 2) æ‹ç…§å¾ŒæŒ‰ã€Œä¸‹è¼‰å­˜è­‰ã€ 3) è‹¥ä¸‹æ–¹æ–‡å­—é‡ç–Šï¼Œè«‹å›å ±ä½ ä½¿ç”¨çš„ç€è¦½å™¨/æ‰‹æ©Ÿå‹è™Ÿï¼Œæˆ‘æœƒèª¿æ•´ç‰ˆé¢è¡Œè·èˆ‡é®ç½©é«˜åº¦ã€‚';
    }
    if (low.includes('æŒ‰éµ') || s.includes('ä¸èƒ½æŒ‰') || s.includes('æ²’åŠŸèƒ½')) {
      return 'æŒ‰éµç„¡åæ‡‰é€šå¸¸æ˜¯ï¼šæœªé€£éŒ¢åŒ…/æœªåˆ‡åˆ° BSC/åˆç´„åƒæ•¸è®€å–å¤±æ•—ã€‚è«‹å…ˆæŒ‰ã€Œç›£å·¥æª¢æŸ¥ã€çœ‹éŒ¯èª¤è¨Šæ¯ï¼Œå†æŠŠç•«é¢æˆªåœ–è²¼çµ¦æˆ‘ã€‚';
    }
    if (low.includes('ç‰ˆæœ¬') || s.includes('ç‰ˆè™Ÿ')) {
      return 'ç‰ˆæœ¬è™Ÿä»¥é é¢æ¨™é¡Œèˆ‡å…§éƒ¨æ¨™è¨˜åŒæ­¥ï¼›è‹¥ GitHub Pages ä»é¡¯ç¤ºèˆŠç‰ˆï¼Œè«‹æ¸…é™¤ç€è¦½å™¨å¿«å–æˆ–æ”¹ç”¨ç„¡ç—•æ¨¡å¼æ¸¬è©¦ã€‚';
    }
    return 'æ”¶åˆ°ã€‚è«‹ç”¨ä¸€å¥è©±æè¿°ä½ è¦é”æˆçš„çµæœï¼ˆä¾‹å¦‚ï¼šæŒ‰å“ªå€‹éµ â†’ æƒ³çœ‹åˆ°ä»€éº¼ï¼‰ï¼Œæˆ‘æœƒç”¨ã€Œä¸€å•ä¸€ç­”ã€æ–¹å¼å¸¶ä½ æ’æŸ¥ã€‚';
  }

  function startTyping(reply){
    // stop previous
    if (typingTimer) { clearInterval(typingTimer); typingTimer = null; }
    typingAbort = false;

    const prefix = 'å®¢æœï¼š';
    let i = 0;
    // we print the prefix first as a line, then type the message after it
    appendLine(prefix);

    const box = $id('chatBox');
    if (!box) return;

    // remove the last line prefix (we will rewrite it as we type)
    const lines = box.value.split('\n');
    lines[lines.length-1] = prefix + ' ';
    box.value = lines.join('\n');

    typingTimer = setInterval(()=>{
      if (typingAbort){
        clearInterval(typingTimer); typingTimer=null;
        // dump the rest immediately
        const l = box.value.split('\n');
        l[l.length-1] = prefix + ' ' + reply;
        box.value = l.join('\n');
        box.scrollTop = box.scrollHeight;
        enableAsk(true);
        return;
      }
      i++;
      const part = reply.slice(0, i);
      const l = box.value.split('\n');
      l[l.length-1] = prefix + ' ' + part;
      box.value = l.join('\n');
      box.scrollTop = box.scrollHeight;
      if (i >= reply.length){
        clearInterval(typingTimer); typingTimer=null;
        enableAsk(true);
      }
    }, 18);
  }

  function enableAsk(on){
    const btnAsk = $id('btnAskChat');
    const inp = $id('chatInput');
    if (btnAsk) btnAsk.disabled = !on;
    if (inp) inp.disabled = !on;
  }

  function ask(){
    const inp = $id('chatInput');
    if (!inp) return;
    const q = inp.value.trim();
    if (!q) return;
    inp.value = '';
    appendLine('ä½ ï¼š' + q);
    enableAsk(false);
    startTyping(genReply(q));
  }

  function stop(){
    typingAbort = true;
    try{ if (typingTimer){ clearInterval(typingTimer); typingTimer=null; } }catch(e){}
    try{ if ('speechSynthesis' in window) window.speechSynthesis.cancel(); }catch(e){}
    try{ if (speechRec && speechListening){ speechRec.stop(); } }catch(e){}
    speechListening = false;
    try{ const bm=$id('btnMic'); if (bm) bm.textContent='ğŸ¤ èªéŸ³'; }catch(e){}
    setMicStatus('');
    try{ enableAsk(true); }catch(e){}
  }

  function bind(){
    // countdown tick (safe)
    const safeTick = ()=>{ try{ if (typeof window.tickCountdowns==='function') window.tickCountdowns(); }catch(e){} };
    safeTick();
    setInterval(safeTick, 250);

    // chat bind
    const btnAsk = $id('btnAskChat');
    const btnStop = $id('btnStopChat');
    const inp = $id('chatInput');
    if (btnAsk) btnAsk.addEventListener('click', ask);
    if (btnStop) btnStop.addEventListener('click', stop);
    if (inp){
      inp.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter'){
          e.preventDefault();
          ask();
        }
      });
    }
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bind);
  }else{
    bind();
  }
})();
</script>

</body>
</html>

<script>

  // -------------------------
  // Countdown Engine (fix for missing tickCountdowns in p13)
  // - Works even when wallet not connected.
  // - Heartbeat: 1 per hour (default 3600s) from lastHB (ms epoch) in localStorage.
  // - Ignite: UTC 00:00-00:10 window, 1 per UTC day from lastIGDay (YYYYMMDD) in localStorage.
  // -------------------------
  const pad2 = (n) => String(n).padStart(2, "0");
  const fmtHHMMSS = (sec) => {
    sec = Math.max(0, Math.floor(sec));
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
  };
  const utcYMD = (d) => {
    const y = d.getUTCFullYear();
    const m = d.getUTCMonth() + 1;
    const day = d.getUTCDate();
    return `${y}${pad2(m)}${pad2(day)}`;
  };
  const nextUtcWindowStart = (now, startMin=0, windowMin=10) => {
    // returns Date for next window start (UTC)
    const d = new Date(now.getTime());
    const curMin = d.getUTCMinutes();
    const curH = d.getUTCHours();
    // window is at 00:00 - 00:10 UTC
    // If before 00:00 => today 00:00 (not possible since minutes/hours in UTC),
    // If within day but past window => tomorrow 00:00
    const inWindow = (curH === 0) && (curMin >= startMin) && (curMin < windowMin);
    if (curH === 0 && curMin < startMin) {
      d.setUTCHours(0, startMin, 0, 0);
      return d;
    }
    if (inWindow) {
      d.setUTCHours(0, startMin, 0, 0);
      return d;
    }
    // tomorrow
    d.setUTCDate(d.getUTCDate() + 1);
    d.setUTCHours(0, startMin, 0, 0);
    return d;
  };

  function tickCountdowns(){
    try{
      const now = new Date();

      // Update top clock
      const nowEl = $("nowTxt");
      if (nowEl) nowEl.textContent = `${now.getFullYear()}/${pad2(now.getMonth()+1)}/${pad2(now.getDate())} ${pad2(now.getHours())}:${pad2(now.getMinutes())}:${pad2(now.getSeconds())}`;

      // ---------- Heartbeat countdownï¼ˆæ¯å°æ™‚æ•´é»ï¼‰ ----------
      // ä¾ç…§ä½¿ç”¨è€…éœ€æ±‚ï¼šå¿ƒè·³ä»¥ã€Œæ•´é»ã€ç‚ºç¯€å¥ï¼Œå€’æ•¸åˆ°ä¸‹ä¸€å€‹æ•´é»ï¼ˆæœ¬æ©Ÿæ™‚é–“ï¼‰ã€‚
      const hbEl = $("hbCountdown");
      let hbRemainSec = 0;
      const m = now.getMinutes();
      const s = now.getSeconds();
      if (m===0 && s===0){
        hbRemainSec = 0;
      } else {
        hbRemainSec = (59 - m) * 60 + (60 - s);
      }
      if (hbEl) hbEl.textContent = fmtHHMMSS(hbRemainSec);

      // ---------- Ignite countdown ----------
      const igEl = $("igCountdown");
      const lastIGDay = String(LS.get("lastIGDay", "")) || "";
      const todayUTC = utcYMD(now);

      const utcH = now.getUTCHours();
      const utcM = now.getUTCMinutes();
      const inIgniteWindow = (utcH === 0) && (utcM >= 0) && (utcM < 10);

      let igRemainSec = 0;
      const alreadyClaimedToday = (lastIGDay === todayUTC);

      if (inIgniteWindow && !alreadyClaimedToday){
        // ready now inside window
        igRemainSec = 0;
      } else {
        // count down to next eligible window start
        const nextStart = nextUtcWindowStart(now, 0, 10);
        // if we are before nextStart but tomorrow start and already claimed today doesn't matter, still tomorrow
        igRemainSec = Math.max(0, (nextStart.getTime() - now.getTime())/1000);
      }
      if (igEl) igEl.textContent = fmtHHMMSS(igRemainSec);

    }catch(e){
      // Never crash the page for timers
      console.warn("tickCountdowns error:", e);
    }
  }

</script>
