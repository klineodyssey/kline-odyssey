<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>五指山12345悟空財神殿 · V6.0 Cosmic Living Temple</title>

<!--
  五指山 12345 悟空財神殿（前端單檔）
  V6.0 Cosmic Living Temple (LIVE)
  - 只增不減：保留「拍照/下載、許願/留言下載、宇宙動畫、監工檢查、工程進度、版本+時間常駐」
  - 對接 Heart 合約（KGEN_TempleHeart_V3_2_2）：heartBalanceWhole/effectiveCapWhole/effectiveFloorWhole/heartbeatClaim/igniteAndClaim/fortuneClaim/vowTo/lightLamp/makeWish
  - 注意：鏈上事件一定要送出交易。合約不會自己「每小時自動」；要用守門人腳本或人工按鈕送交易。
-->

<style>
  :root{
    --gold:#ffd36a;
    --gold2:#ffb300;
    --bg0:#05060a;
    --bg1:#0a0d16;
    --panel: rgba(8,10,18,0.68);
    --panel2: rgba(10,12,20,0.78);
    --line: rgba(255,211,106,0.42);
    --ok:#7CFF9A;
    --warn:#FFD36A;
    --bad:#FF6B6B;
    --muted:#9aa3b2;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Microsoft JhengHei",system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;
    color:var(--gold);
    background: radial-gradient(1200px 700px at 50% 30%, #141a33 0%, #070812 50%, #000 100%);
    overflow-x:hidden;
  }
  canvas#cosmos{
    position:fixed; inset:0;
    z-index:-2;
  }
  .nebula{
    position:fixed; inset:-20%;
    z-index:-1;
    background:
      radial-gradient(800px 500px at 15% 25%, rgba(123,63,255,0.22), transparent 60%),
      radial-gradient(900px 600px at 85% 35%, rgba(255,160,80,0.18), transparent 62%),
      radial-gradient(700px 500px at 55% 80%, rgba(80,180,255,0.14), transparent 60%);
    filter: blur(16px);
    animation: drift 18s ease-in-out infinite alternate;
    pointer-events:none;
  }
  @keyframes drift{
    from{ transform: translate3d(-1%, -1%, 0) scale(1.02); opacity:.85;}
    to{ transform: translate3d(1%, 1%, 0) scale(1.06); opacity:1;}
  }

  header{
    position:sticky; top:0;
    backdrop-filter: blur(10px);
    background: linear-gradient(180deg, rgba(0,0,0,0.72), rgba(0,0,0,0.2));
    border-bottom: 1px solid rgba(255,211,106,0.22);
    z-index:10;
  }
  .topbar{
    max-width:1100px;
    margin:0 auto;
    padding:14px 14px 10px;
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
  }
  .brand{
    display:flex; gap:12px; align-items:center;
  }
  .seal{
    width:44px; height:44px; border-radius:14px;
    background: radial-gradient(circle at 30% 30%, rgba(255,211,106,1), rgba(255,140,0,0.35) 55%, rgba(0,0,0,0.2) 75%);
    box-shadow: 0 0 28px rgba(255,211,106,0.35);
    border: 1px solid rgba(255,211,106,0.45);
  }
  h1{
    font-size:18px;
    margin:0;
    letter-spacing:.5px;
    text-shadow: 0 0 14px rgba(255,211,106,0.25);
  }
  .sub{
    font-size:12px;
    color:var(--muted);
    margin-top:2px;
  }
  .pill{
    display:inline-flex; gap:8px; align-items:center;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,211,106,0.25);
    background: rgba(0,0,0,0.45);
    color: #e8e8ea;
    font-size:12px;
    white-space:nowrap;
  }
  .pill b{ color:var(--gold); font-weight:800;}
  .wrap{
    max-width:1100px;
    margin: 14px auto 60px;
    padding: 0 14px;
  }

  .grid{
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap:14px;
  }
  @media (max-width: 980px){
    .grid{ grid-template-columns: 1fr; }
  }

  .card{
    background: var(--panel);
    border: 1px solid rgba(255,211,106,0.22);
    border-radius: 18px;
    padding: 14px;
    box-shadow: 0 14px 40px rgba(0,0,0,0.35);
  }
  .card h2{
    margin:0 0 10px;
    font-size:14px;
    letter-spacing:.4px;
    display:flex; align-items:center; justify-content:space-between;
  }
  .card h2 small{ color:var(--muted); font-weight:600; }
  .hr{
    height:1px; background: rgba(255,211,106,0.18); margin:10px 0;
  }

  .btnrow{ display:flex; flex-wrap:wrap; gap:8px; }
  button{
    border-radius: 12px;
    padding: 10px 12px;
    border: 1px solid rgba(255,211,106,0.35);
    background: rgba(0,0,0,0.55);
    color: var(--gold);
    cursor:pointer;
    transition: transform .08s ease, background .2s ease, border-color .2s ease;
    font-weight:800;
  }
  button:hover{ background: rgba(255,211,106,0.12); border-color: rgba(255,211,106,0.55); }
  button:active{ transform: scale(.98); }
  button.primary{
    background: linear-gradient(135deg, rgba(255,211,106,0.25), rgba(255,140,0,0.12));
    border-color: rgba(255,211,106,0.65);
  }
  button.danger{
    border-color: rgba(255,90,90,0.55);
    color:#ffd0d0;
  }
  button.ghost{
    background: transparent;
    border-color: rgba(255,211,106,0.18);
    color: rgba(255,211,106,0.85);
  }
  button:disabled{
    opacity:.5; cursor:not-allowed;
  }

  input, textarea, select{
    width:100%;
    border-radius: 12px;
    border: 1px solid rgba(255,211,106,0.22);
    background: rgba(0,0,0,0.45);
    color: var(--gold);
    padding: 10px 12px;
    outline:none;
  }
  textarea{ min-height: 86px; resize: vertical; }
  label{ display:block; font-size:12px; color:var(--muted); margin: 10px 0 6px; }

  .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  @media (max-width:680px){ .row{ grid-template-columns:1fr; } }

  .status{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  @media (max-width:720px){ .status{ grid-template-columns:1fr; } }
  .stat{
    background: var(--panel2);
    border: 1px solid rgba(255,211,106,0.18);
    border-radius: 14px;
    padding: 10px 12px;
  }
  .stat .k{ font-size:12px; color:var(--muted); }
  .stat .v{ font-size:14px; font-weight:900; margin-top:4px; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  .bar{
    width:100%;
    height: 14px;
    background: rgba(255,255,255,0.08);
    border-radius: 999px;
    overflow:hidden;
    border:1px solid rgba(255,211,106,0.18);
  }
  .bar > div{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, rgba(255,211,106,0.85), rgba(255,140,0,0.75));
    transition: width .8s ease;
  }

  .badge{
    display:inline-flex; align-items:center; gap:8px;
    padding: 6px 10px;
    border-radius: 999px;
    border:1px solid rgba(255,211,106,0.22);
    background: rgba(0,0,0,0.35);
    font-size:12px;
    color:#e8e8ea;
  }
  .dot{
    width:10px; height:10px; border-radius:99px;
    background: rgba(255,255,255,0.25);
    box-shadow: 0 0 14px rgba(255,255,255,0.18);
  }
  .dot.ok{ background: var(--ok); box-shadow: 0 0 14px rgba(124,255,154,.35); }
  .dot.warn{ background: var(--warn); box-shadow: 0 0 14px rgba(255,211,106,.35); }
  .dot.bad{ background: var(--bad); box-shadow: 0 0 14px rgba(255,107,107,.35); }

  .supervisor{
    margin-top:10px;
    border-radius: 16px;
    border:1px dashed rgba(255,211,106,0.25);
    background: rgba(0,0,0,0.35);
    padding: 10px 12px;
    display:none;
  }
  .supervisor.show{ display:block; }
  .checklist{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px;
    margin-top: 8px;
  }
  @media (max-width:820px){ .checklist{ grid-template-columns:1fr; } }
  .item{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px;
    padding: 8px 10px;
    border-radius: 12px;
    border: 1px solid rgba(255,211,106,0.16);
    background: rgba(0,0,0,0.28);
  }
  .item .name{ font-size:12px; color:#d7d7db; }
  .item .value{ font-size:12px; color: var(--muted); }

  .log{
    margin-top:10px;
    padding:10px 12px;
    border-radius: 14px;
    background: rgba(0,0,0,0.5);
    border:1px solid rgba(255,211,106,0.18);
    color:#d9d9df;
    font-size:12px;
    max-height: 220px;
    overflow:auto;
  }

  .media{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    align-items:start;
  }
  @media (max-width:980px){ .media{ grid-template-columns:1fr; } }
  video, canvas{
    width:100%;
    border-radius: 16px;
    border:1px solid rgba(255,211,106,0.22);
    background: rgba(0,0,0,0.55);
  }

  .footer{
    max-width:1100px;
    margin: 18px auto 38px;
    padding: 0 14px;
    color: rgba(230,230,236,0.7);
    font-size:12px;
    text-align:center;
  }
  .footer .sig{
    margin-top:10px;
    color: rgba(255,211,106,0.9);
    white-space: pre-line;
  }
</style>
</head>

<body>
<canvas id="cosmos"></canvas>
<div class="nebula"></div>

<header>
  <div class="topbar">
    <div class="brand">
      <div class="seal" aria-hidden="true"></div>
      <div>
        <h1>五指山 12345 · 悟空財神殿</h1>
        <div class="sub">V6.0 Cosmic Living Temple · 心跳與點火上鏈 · 拍照與願望可下載</div>
      </div>
    </div>
    <div class="pill">
      <span>版本 <b id="uiVer">V6.0</b></span>
      <span class="mono" id="clock"></span>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <section class="card">
      <h2>神殿核心狀態 <small id="netHint">未連線</small></h2>

      <div class="btnrow">
        <button class="primary" id="btnConnect">連接錢包</button>
        <button id="btnSwitch">切換到 BSC (0x38)</button>
        <button id="btnRefresh">刷新狀態</button>
        <button class="ghost" id="btnSupervisor">監工檢查</button>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div>
          <label>Heart 合約地址（部署後貼上）</label>
          <input id="heartAddr" class="mono" placeholder="0x..." />
        </div>
        <div>
          <label>公益血庫 orphanPool（顯示用，可不填）</label>
          <input id="orphanAddr" class="mono" placeholder="0xB73D...（可留空）" />
        </div>
      </div>

      <div class="btnrow" style="margin-top:10px;">
        <button id="btnSave">保存地址</button>
        <button class="danger" id="btnClear">清除本機設定</button>
      </div>

      <div class="hr"></div>

      <div class="status">
        <div class="stat">
          <div class="k">錢包</div>
          <div class="v mono" id="stWallet">未連線</div>
        </div>
        <div class="stat">
          <div class="k">鏈 / chainId</div>
          <div class="v mono" id="stChain">—</div>
        </div>
        <div class="stat">
          <div class="k">Heart 血量（heartBalanceWhole）</div>
          <div class="v mono" id="stHeartBal">—</div>
          <div class="bar" style="margin-top:8px;"><div id="barHeart"></div></div>
          <div class="k" style="margin-top:8px;">cap / floor</div>
          <div class="v mono" id="stCapFloor">—</div>
        </div>
        <div class="stat">
          <div class="k">倒數</div>
          <div class="v" id="stCountdown">—</div>
          <div class="k" style="margin-top:8px;">可操作狀態</div>
          <div class="v" id="stEligibility">—</div>
        </div>
      </div>

      <div class="supervisor" id="supervisorBox">
        <div class="badge"><span class="dot" id="dotOverall"></span><span>監工總檢查</span><span class="mono" id="supScore">0%</span></div>
        <div style="margin-top:10px;" class="bar"><div id="barSup"></div></div>

        <div class="checklist" id="checklist"></div>

        <div class="log mono" id="log"></div>
      </div>
    </section>

    <section class="card">
      <h2>儀式與交易 <small>按下即上鏈（會產生 tx / event）</small></h2>

      <div class="row">
        <div>
          <label>發財金（1～888）</label>
          <input id="inFortune" type="number" min="1" max="888" value="108" />
          <button class="primary" id="btnFortune" style="margin-top:8px; width:100%;">領發財金（上鏈）</button>
        </div>
        <div>
          <label>點燈（天數）</label>
          <input id="inLampDays" type="number" min="1" max="365" value="7" />
          <button id="btnLamp" style="margin-top:8px; width:100%;">點燈（上鏈）</button>
        </div>
      </div>

      <div class="row">
        <div>
          <label>心跳（每小時一次）</label>
          <button class="primary" id="btnHeartbeat" style="width:100%;">心跳（上鏈 -1/+1 規則由合約決定）</button>
        </div>
        <div>
          <label>點火（每日窗口 UTC 00:00–00:10）</label>
          <button class="primary" id="btnIgnite" style="width:100%;">點火（上鏈）</button>
        </div>
      </div>

      <label style="margin-top:12px;">還願補血（vowTo：需要先 approve KGEN）</label>
      <div class="row">
        <div>
          <select id="inVowOpt">
            <option value="0">還願 option=0（單池：不分流）</option>
            <option value="1">option=1（預留）</option>
            <option value="2">option=2（預留）</option>
          </select>
        </div>
        <div>
          <input id="inVowAmt" type="number" min="1" value="8" />
        </div>
      </div>
      <div class="btnrow" style="margin-top:8px;">
        <button id="btnApprove">先批准（approve Heart）</button>
        <button class="primary" id="btnVow">還願入金（上鏈）</button>
      </div>

      <div class="hr"></div>

      <h2 style="margin-top:0;">許願、留言、留影 <small>可下載保存</small></h2>

      <label>許願內容（會 keccak256 後上鏈 makeWish(hash)）</label>
      <textarea id="wishText" placeholder="寫下你的願望…（不直接上鏈文字，只上鏈 hash）"></textarea>
      <div class="btnrow" style="margin-top:8px;">
        <button class="primary" id="btnWish">許願上鏈</button>
        <button id="btnWishCert">生成願望證書</button>
        <button id="btnWishDownload">下載願望證書</button>
      </div>

      <label style="margin-top:12px;">留言（本機存檔，可下載）</label>
      <textarea id="msgText" placeholder="寫下留言…（本機保存）"></textarea>
      <div class="btnrow" style="margin-top:8px;">
        <button id="btnMsgSave">儲存留言</button>
        <button id="btnMsgDownload">下載留言 TXT</button>
        <button class="danger" id="btnMsgClear">清空留言</button>
      </div>

      <div class="hr"></div>

      <div class="media">
        <div>
          <label>相機（信眾可自看）</label>
          <video id="video" autoplay playsinline muted></video>
          <div class="btnrow" style="margin-top:8px;">
            <button id="btnCam">開啟相機</button>
            <button class="primary" id="btnShot">拍照（浮印）</button>
            <button id="btnShotDownload">下載照片</button>
          </div>
          <canvas id="photo" width="800" height="450" style="margin-top:10px;"></canvas>
        </div>
        <div>
          <label>願望證書畫布</label>
          <canvas id="wishCanvas" width="800" height="450"></canvas>
          <div class="k" style="margin-top:8px; color:var(--muted);">
            證書會包含：願望摘要、時間戳、錢包地址（若已連線）
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="badge">
        <span class="dot" id="dotEthers"></span><span>ethers.js</span><span class="mono" id="ethersVer">—</span>
      </div>

    </section>
  </div>
</div>

<div class="footer">
  <div>提醒：鏈上事件一定要送出交易。若你要「每小時自動心跳 / 每日自動點火」，請用守門人腳本或排程送交易。</div>
  <div class="sig">PrimeForge 以母機之名，開啟金融生命。
花果山台灣・信念不滅・市場無界。
Where the Market Becomes the Myth.
—— 樂天帝

#KLINE #KlineAppGame #KGEN
#AI修行 #市場宇宙 #金融生命體
#WhereTheMarketBecomesTheMyth</div>
</div>

<script src="../../assets/js/ethers-5.7.2.umd.min.js"></script>

<script>
const UI_VERSION = "V6.0";
const BSC_CHAIN_ID_HEX = "0x38";
const BSC_CHAIN_ID_DEC = 56;

const $ = (id)=>document.getElementById(id);

const state = {
  provider: null,
  signer: null,
  account: null,
  chainId: null,
  heart: null,
  cfg: { heartAddr: "", orphanAddr: "" },
  log: []
};

function logLine(msg){
  const t = new Date().toLocaleString();
  state.log.unshift(`[${t}] ${msg}`);
  const el = $("log");
  if(el) el.textContent = state.log.slice(0,80).join("\n");
}

(function hookConsole(){
  const origErr = console.error;
  console.error = function(...args){
    try{ logLine("console.error: " + args.map(a=>String(a)).join(" ")); }catch(e){}
    origErr.apply(console, args);
  }
  window.addEventListener("error", (e)=> logLine("window.error: " + (e?.message || "unknown")));
  window.addEventListener("unhandledrejection", (e)=> logLine("unhandledrejection: " + (e?.reason?.message || e?.reason || "unknown")));
})();

function setNetHint(){
  const hint = $("netHint");
  if(!hint) return;
  hint.textContent = state.account ? "已連線" : "未連線";
}

function setDot(el, level){
  el.classList.remove("ok","warn","bad");
  if(level==="ok") el.classList.add("ok");
  else if(level==="warn") el.classList.add("warn");
  else if(level==="bad") el.classList.add("bad");
}

function shortAddr(a){
  if(!a) return "—";
  return a.slice(0,6) + "…" + a.slice(-4);
}

function loadCfg(){
  try{
    const raw = localStorage.getItem("KLINE_TEMPLE_12345_CFG_V6");
    if(raw){
      const obj = JSON.parse(raw);
      state.cfg.heartAddr = obj.heartAddr || "";
      state.cfg.orphanAddr = obj.orphanAddr || "";
    }
  }catch(e){}
  $("heartAddr").value = state.cfg.heartAddr || "";
  $("orphanAddr").value = state.cfg.orphanAddr || "";
}
function saveCfg(){
  state.cfg.heartAddr = ($("heartAddr").value || "").trim();
  state.cfg.orphanAddr = ($("orphanAddr").value || "").trim();
  localStorage.setItem("KLINE_TEMPLE_12345_CFG_V6", JSON.stringify(state.cfg));
  logLine("已保存本機設定");
}
function clearCfg(){
  localStorage.removeItem("KLINE_TEMPLE_12345_CFG_V6");
  state.cfg.heartAddr = ""; state.cfg.orphanAddr="";
  $("heartAddr").value = ""; $("orphanAddr").value = "";
  logLine("已清除本機設定");
}

/* Cosmos */
const c = $("cosmos");
const ctx = c.getContext("2d");
let W=0,H=0;
function resize(){ W = c.width = window.innerWidth; H = c.height = window.innerHeight; }
window.addEventListener("resize", resize); resize();

const stars = Array.from({length: 260}).map(()=>({
  x: Math.random()*W,
  y: Math.random()*H,
  r: Math.random()*1.8 + 0.2,
  v: Math.random()*0.25 + 0.05,
  a: Math.random()*0.6 + 0.2
}));
let pulses = [];
function pulse(){ pulses.push({t:0, x: W*0.5, y: H*0.35}); }
function draw(){
  ctx.clearRect(0,0,W,H);
  for(const s of stars){
    s.y += s.v;
    if(s.y>H){ s.y=0; s.x=Math.random()*W; }
    ctx.globalAlpha = s.a;
    ctx.fillStyle = "#ffffff";
    ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
  }
  ctx.globalAlpha = 1;
  pulses = pulses.filter(p=>p.t<1.0);
  for(const p of pulses){
    p.t += 0.012;
    const radius = 40 + p.t*520;
    const alpha = Math.max(0, 0.18 - p.t*0.18);
    const grd = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,radius);
    grd.addColorStop(0, `rgba(255,211,106,${alpha})`);
    grd.addColorStop(1, `rgba(255,211,106,0)`);
    ctx.fillStyle = grd;
    ctx.beginPath(); ctx.arc(p.x,p.y,radius,0,Math.PI*2); ctx.fill();
  }
  requestAnimationFrame(draw);
}
draw();

setInterval(()=>{ $("clock").textContent = new Date().toLocaleString(); }, 500);

function initEthersBadge(){
  const ok = (typeof ethers !== "undefined");
  setDot($("dotEthers"), ok ? "ok" : "bad");
  $("ethersVer").textContent = ok ? (ethers.version || "v5") : "missing";
  if(!ok) logLine("ethers.js 未載入：請確認 ../../assets/js/ethers-5.7.2.umd.min.js 存在");
}
initEthersBadge();

const HEART_ABI = [
  "function kgen() view returns (address)",
  "function orphanPool() view returns (address)",
  "function heartBalanceWhole() view returns (uint256)",
  "function effectiveCapWhole() view returns (uint256)",
  "function effectiveFloorWhole() view returns (uint256)",
  "function igniteWindowStart() view returns (uint256)",
  "function igniteWindowEnd() view returns (uint256)",
  "function heartbeatCooldownSeconds() view returns (uint256)",
  "function fortuneCooldownSeconds() view returns (uint256)",
  "function lampPricePerDay() view returns (uint256)",
  "function lastHeartbeatAt(address) view returns (uint256)",
  "function lastFortuneAt(address) view returns (uint256)",
  "function lastIgniteDay(address) view returns (uint256)",
  "function lampExpireAt(address) view returns (uint256)",
  "function currentDayIndex() view returns (uint256)",
  "function timeOfDaySeconds() view returns (uint256)",
  "function fortuneClaim(uint256 amountWhole)",
  "function heartbeatClaim()",
  "function igniteAndClaim()",
  "function vowTo(uint8 option, uint256 amountWhole)",
  "function lightLamp(uint256 daysAdded)",
  "function makeWish(bytes32 wishHash)",
  "event FortuneClaimed(address indexed user, uint256 amount, uint256 indexed epochIndex)",
  "event HeartbeatClaimed(address indexed user, uint256 reward)",
  "event IgniteClaimed(address indexed user, uint256 reward, uint256 indexed dayIndex)",
  "event Vowed(address indexed user, uint8 option, uint256 amount)",
  "event LampLit(address indexed user, uint256 daysAdded, uint256 paid, uint256 newExpireAt)",
  "event WishMade(address indexed user, bytes32 wishHash)"
];

const ERC20_ABI = [
  "function decimals() view returns (uint8)",
  "function balanceOf(address) view returns (uint256)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function approve(address spender, uint256 amount) returns (bool)"
];

function isAddr(a){ try{ return ethers.utils.isAddress(a); }catch(e){ return false; } }

async function connect(){
  if(typeof ethers === "undefined") return;
  if(!window.ethereum){ alert("找不到錢包（window.ethereum）。請用手機/瀏覽器錢包打開。"); return; }
  state.provider = new ethers.providers.Web3Provider(window.ethereum, "any");
  await state.provider.send("eth_requestAccounts", []);
  state.signer = state.provider.getSigner();
  state.account = await state.signer.getAddress();
  const net = await state.provider.getNetwork();
  state.chainId = net.chainId;

  $("stWallet").textContent = state.account;
  $("stChain").textContent = `${net.chainId} (${net.chainId===56?"BSC":"非BSC"})`;
  setNetHint();
  logLine("錢包已連線：" + state.account);

  window.ethereum.on?.("chainChanged", ()=> setTimeout(()=>location.reload(), 300));
  window.ethereum.on?.("accountsChanged", ()=> setTimeout(()=>location.reload(), 300));

  await refreshAll();
}

async function switchToBSC(){
  if(!window.ethereum) return;
  try{
    await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId: BSC_CHAIN_ID_HEX }]});
  }catch(e){
    alert("切鏈失敗：請在錢包手動切到 BNB Chain (BSC) 主網");
    logLine("切鏈失敗：" + (e?.message || e));
  }
}

function getHeartAddr(){ return ($("heartAddr").value || "").trim(); }

async function buildContracts(){
  const heartAddr = getHeartAddr();
  if(!isAddr(heartAddr)){ state.heart = null; return; }
  state.heart = new ethers.Contract(heartAddr, HEART_ABI, state.signer || state.provider);
}

function fmtWhole(n){ try{ return n.toString(); }catch(e){ return String(n); } }

function secondsToHMS(sec){
  sec = Math.max(0, Math.floor(sec));
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  const pad = (v)=> String(v).padStart(2,"0");
  if(h>0) return `${pad(h)}:${pad(m)}:${pad(s)}`;
  return `${pad(m)}:${pad(s)}`;
}

async function refreshAll(){
  await buildContracts();
  await refreshStatus();
  await updateSupervisor();
}

async function refreshStatus(){
  const heartAddr = getHeartAddr();
  if(state.account) $("stWallet").textContent = state.account;
  if(state.chainId!=null) $("stChain").textContent = `${state.chainId} (${state.chainId===56?"BSC":"非BSC"})`;

  if(!state.provider || !state.account){
    $("stCountdown").textContent = "請先連接錢包";
    $("stEligibility").textContent = "—";
    return;
  }
  if(state.chainId !== 56){
    $("stCountdown").textContent = "請切換到 BSC (0x38)";
    $("stEligibility").textContent = "—";
    return;
  }
  if(!isAddr(heartAddr)){
    $("stCountdown").textContent = "請填入 Heart 合約地址";
    $("stEligibility").textContent = "—";
    return;
  }
  if(!state.heart){
    $("stCountdown").textContent = "Heart 未就緒";
    $("stEligibility").textContent = "—";
    return;
  }

  try{
    const [
      balWhole, capWhole, floorWhole,
      igniteStart, igniteEnd,
      hbCd, fcCd,
      lastHbAt, lastFcAt, lastIgnDay,
      lampExp,
      dayIdx, tod
    ] = await Promise.all([
      state.heart.heartBalanceWhole(),
      state.heart.effectiveCapWhole(),
      state.heart.effectiveFloorWhole(),
      state.heart.igniteWindowStart(),
      state.heart.igniteWindowEnd(),
      state.heart.heartbeatCooldownSeconds(),
      state.heart.fortuneCooldownSeconds(),
      state.heart.lastHeartbeatAt(state.account),
      state.heart.lastFortuneAt(state.account),
      state.heart.lastIgniteDay(state.account),
      state.heart.lampExpireAt(state.account),
      state.heart.currentDayIndex(),
      state.heart.timeOfDaySeconds()
    ]);

    $("stHeartBal").textContent = fmtWhole(balWhole);
    $("stCapFloor").textContent = `${fmtWhole(capWhole)} / ${fmtWhole(floorWhole)}`;

    const bal = Number(balWhole.toString());
    const cap = Number(capWhole.toString());
    const pct = cap>0 ? Math.min(100, Math.max(0, bal/cap*100)) : 0;
    $("barHeart").style.width = pct.toFixed(2) + "%";

    const now = Math.floor(Date.now()/1000);

    const hbNext = Number(lastHbAt.toString()) + Number(hbCd.toString());
    const hbRemain = Math.max(0, hbNext - now);

    const fcNext = Number(lastFcAt.toString()) + Number(fcCd.toString());
    const fcRemain = Math.max(0, fcNext - now);

    const curDay = Number(dayIdx.toString());
    const ignDay = Number(lastIgnDay.toString());
    const ignUsed = (ignDay === curDay);

    const todSec = Number(tod.toString());
    const inWindow = (todSec >= Number(igniteStart.toString()) && todSec <= Number(igniteEnd.toString()));
    const ignRemain = inWindow ? 0 : calcIgniteWindowRemainUTC(Number(igniteStart.toString()), now);

    const lampExpAt = Number(lampExp.toString());
    const lampRemain = Math.max(0, lampExpAt - now);

    $("stCountdown").innerHTML =
      `心跳倒數：<span class="mono">${secondsToHMS(hbRemain)}</span><br/>`+
      `點火倒數：<span class="mono">${inWindow ? "窗口已開" : secondsToHMS(ignRemain)}</span><br/>`+
      `點燈到期：<span class="mono">${lampRemain>0 ? secondsToHMS(lampRemain) : "未點燈/已到期"}</span>`;

    $("stEligibility").innerHTML =
      `心跳：${hbRemain===0 ? "可領" : "冷卻中"}<br/>`+
      `點火：${(!ignUsed && inWindow) ? "可點火" : (ignUsed ? "今日已點火" : "窗口未開")}<br/>`+
      `發財金：${fcRemain===0 ? "可領" : "冷卻中"}`;

    $("btnHeartbeat").disabled = hbRemain!==0;
    $("btnIgnite").disabled = !(inWindow && !ignUsed);
    $("btnFortune").disabled = fcRemain!==0;

    if(hbRemain===0) pulse();

  }catch(e){
    logLine("刷新狀態失敗：" + (e?.message || e));
    $("stCountdown").textContent = "讀取失敗（請開監工檢查看原因）";
  }
}

function calcIgniteWindowRemainUTC(windowStartSec, nowEpochSec){
  const now = new Date(nowEpochSec*1000);
  const utcY = now.getUTCFullYear(), utcM = now.getUTCMonth(), utcD = now.getUTCDate();
  const dayStart = Date.UTC(utcY, utcM, utcD, 0,0,0)/1000;
  const nextStart = dayStart + windowStartSec;
  if(nowEpochSec <= nextStart) return nextStart - nowEpochSec;
  const nextDayStart = dayStart + 86400;
  return (nextDayStart + windowStartSec) - nowEpochSec;
}

async function ensureReady(){
  if(!state.provider || !state.account) throw new Error("未連接錢包");
  if(state.chainId !== 56) throw new Error("請切到 BSC (0x38)");
  const heartAddr = getHeartAddr();
  if(!isAddr(heartAddr)) throw new Error("Heart 地址不合法");
  if(!state.heart) await buildContracts();
  if(!state.heart) throw new Error("Heart 未就緒");
  if(!state.signer) state.signer = state.provider.getSigner();
}

async function sendTx(label, fn){
  try{
    await ensureReady();
    logLine(`${label}：送出交易中…`);
    const tx = await fn();
    logLine(`${label}：tx=${tx.hash}`);
    const r = await tx.wait(1);
    logLine(`${label}：confirmed block=${r.blockNumber}`);
    pulse();
    await refreshAll();
  }catch(e){
    logLine(`${label}：失敗 -> ${e?.reason || e?.message || e}`);
    alert(`${label} 失敗：\n${e?.reason || e?.message || e}`);
  }
}

async function doHeartbeat(){ await sendTx("心跳", ()=> state.heart.connect(state.signer).heartbeatClaim()); }
async function doIgnite(){ await sendTx("點火", ()=> state.heart.connect(state.signer).igniteAndClaim()); }
async function doFortune(){
  const v = Number($("inFortune").value || "0");
  if(!(v>=1 && v<=888)) { alert("發財金請填 1～888"); return; }
  await sendTx("領發財金", ()=> state.heart.connect(state.signer).fortuneClaim(v));
}
async function doLamp(){
  const d = Number($("inLampDays").value || "0");
  if(!(d>=1 && d<=365)) { alert("點燈天數 1～365"); return; }
  await sendTx("點燈", ()=> state.heart.connect(state.signer).lightLamp(d));
}
async function doWish(){
  const text = ($("wishText").value || "").trim();
  if(!text){ alert("請輸入願望"); return; }
  await ensureReady();
  const hash = ethers.utils.keccak256(ethers.utils.toUtf8Bytes(text));
  await sendTx("許願上鏈", ()=> state.heart.connect(state.signer).makeWish(hash));
}
async function doApprove(){
  await ensureReady();
  try{
    const tokenAddr = await state.heart.kgen();
    if(!isAddr(tokenAddr)) throw new Error("讀取 token 失敗");
    const token = new ethers.Contract(tokenAddr, ERC20_ABI, state.signer);
    const amtWhole = Number($("inVowAmt").value || "0");
    if(!(amtWhole>0)) { alert("還願金額需 > 0"); return; }
    const dec = await token.decimals();
    const amt = ethers.utils.parseUnits(String(amtWhole), dec);
    await sendTx("Approve", ()=> token.approve(getHeartAddr(), amt));
  }catch(e){
    logLine("Approve 失敗：" + (e?.message || e));
    alert("Approve 失敗：" + (e?.message || e));
  }
}
async function doVow(){
  const opt = Number($("inVowOpt").value || "0");
  const amt = Number($("inVowAmt").value || "0");
  if(!(amt>0)) { alert("還願金額需 > 0"); return; }
  await sendTx("還願入金", ()=> state.heart.connect(state.signer).vowTo(opt, amt));
}

function checklistItem(name, level, value){
  const div = document.createElement("div");
  div.className = "item";
  const left = document.createElement("div");
  left.className = "name";
  left.textContent = name;
  const right = document.createElement("div");
  right.className = "value mono";
  right.textContent = value || "";
  const badge = document.createElement("span");
  badge.className = "badge";
  const dot = document.createElement("span");
  dot.className = "dot";
  setDot(dot, level);
  badge.appendChild(dot);
  badge.appendChild(document.createTextNode(level==="ok"?"OK":(level==="warn"?"WARN":"BAD")));
  div.appendChild(left);
  div.appendChild(right);
  div.appendChild(badge);
  return div;
}

async function updateSupervisor(){
  const list = $("checklist");
  if(!list) return;
  list.innerHTML = "";

  const checks = [];
  const ethersOk = (typeof ethers !== "undefined");
  checks.push({name:"ethers.js 已載入", ok: ethersOk, value: ethersOk ? (ethers.version||"v5") : "missing"});
  const hasEth = !!window.ethereum;
  checks.push({name:"window.ethereum 存在", ok: hasEth, value: hasEth ? "yes" : "no"});

  const connected = !!state.account;
  checks.push({name:"錢包已連線", ok: connected, value: connected ? shortAddr(state.account) : "—"});

  const onBSC = state.chainId === 56;
  checks.push({name:"鏈為 BSC 主網", ok: onBSC, value: state.chainId!=null ? String(state.chainId) : "—"});

  const heartAddr = getHeartAddr();
  const heartOk = isAddr(heartAddr);
  checks.push({name:"Heart 地址格式", ok: heartOk, value: heartOk ? shortAddr(heartAddr) : "invalid"});

  let heartReadable = false;
  let capStr="—";
  if(connected && onBSC && heartOk && state.heart){
    try{
      const cap = await state.heart.effectiveCapWhole();
      capStr = cap.toString();
      heartReadable = true;
    }catch(e){}
  }
  checks.push({name:"Heart 可讀取（cap）", ok: heartReadable, value: capStr});

  const camSupport = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
  checks.push({name:"相機 API 支援", ok: camSupport, value: camSupport ? "ok" : "no"});

  let storageOk = true;
  try{ localStorage.setItem("_t","1"); localStorage.removeItem("_t"); }catch(e){ storageOk=false; }
  checks.push({name:"localStorage 可用", ok: storageOk, value: storageOk ? "ok" : "blocked"});

  const okCount = checks.filter(c=>c.ok).length;
  const score = Math.round(okCount / checks.length * 100);
  $("supScore").textContent = score + "%";
  $("barSup").style.width = score + "%";
  setDot($("dotOverall"), score>=85 ? "ok" : (score>=55 ? "warn" : "bad"));

  for(const c of checks){
    list.appendChild(checklistItem(c.name, c.ok ? "ok" : "warn", c.value));
  }
}

function msgKey(){ return "KLINE_TEMPLE_12345_MSG_V6"; }
function loadMsg(){ $("msgText").value = localStorage.getItem(msgKey()) || ""; }
function saveMsg(){ localStorage.setItem(msgKey(), $("msgText").value || ""); logLine("留言已儲存（本機）"); }
function clearMsg(){ localStorage.removeItem(msgKey()); $("msgText").value = ""; logLine("留言已清空"); }
function downloadText(filename, content){
  const blob = new Blob([content], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  setTimeout(()=> URL.revokeObjectURL(url), 800);
}
function downloadMsg(){
  const content = $("msgText").value || "";
  const header = `五指山12345悟空財神殿 留言\n時間: ${new Date().toLocaleString()}\n錢包: ${state.account||"未連線"}\n\n`;
  downloadText("wuzhishan_12345_message.txt", header + content);
}

let camStream = null;
async function openCam(){
  try{
    if(!navigator.mediaDevices?.getUserMedia) throw new Error("瀏覽器不支援相機");
    camStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}, audio:false});
    $("video").srcObject = camStream;
    logLine("相機已開啟");
  }catch(e){
    logLine("相機失敗：" + (e?.message || e));
    alert("相機失敗：" + (e?.message || e));
  }
}

function drawStamp(ctx, w, h, title, subtitle){
  ctx.save();
  const g = ctx.createRadialGradient(w*0.5,h*0.4, w*0.1, w*0.5,h*0.4, w*0.8);
  g.addColorStop(0, "rgba(0,0,0,0)");
  g.addColorStop(1, "rgba(0,0,0,0.45)");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,w,h);

  ctx.globalAlpha = 0.9;
  ctx.strokeStyle = "rgba(255,211,106,0.85)";
  ctx.lineWidth = Math.max(3, w*0.006);
  ctx.beginPath();
  ctx.arc(w*0.12, h*0.18, Math.min(w,h)*0.06, 0, Math.PI*2);
  ctx.stroke();

  ctx.globalAlpha = 0.95;
  ctx.fillStyle = "rgba(255,211,106,0.92)";
  ctx.font = `800 ${Math.max(18, w*0.035)}px Microsoft JhengHei`;
  ctx.fillText(title, w*0.22, h*0.15);

  ctx.fillStyle = "rgba(230,230,236,0.78)";
  ctx.font = `600 ${Math.max(12, w*0.022)}px ui-monospace, Menlo, Consolas`;
  ctx.fillText(subtitle, w*0.22, h*0.21);

  ctx.fillStyle = "rgba(255,211,106,0.55)";
  ctx.font = `700 ${Math.max(12, w*0.020)}px Microsoft JhengHei`;
  ctx.fillText("花果山台灣・信念不滅・市場無界", w*0.06, h*0.93);

  ctx.restore();
}

function takeShot(){
  const v = $("video");
  if(!v.srcObject){ alert("請先開啟相機"); return; }
  const canvas = $("photo");
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;

  const vw = v.videoWidth || 1280;
  const vh = v.videoHeight || 720;
  const scale = Math.max(w/vw, h/vh);
  const dw = vw*scale, dh = vh*scale;
  const dx = (w-dw)/2, dy = (h-dh)/2;
  ctx.drawImage(v, dx, dy, dw, dh);

  drawStamp(ctx, w, h, "五指山 12345 悟空財神殿", `V6.0 · ${new Date().toLocaleString()} · ${state.account?shortAddr(state.account):"no-wallet"}`);
  pulse();
  logLine("拍照完成（已加浮印）");
}

function downloadCanvas(canvasId, filename){
  const canvas = $(canvasId);
  const url = canvas.toDataURL("image/png");
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
}
function downloadShot(){ downloadCanvas("photo","wuzhishan_12345_photo.png"); }

function roundRect(ctx, x, y, w, h, r){
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  ctx.closePath();
}
function wrapText(ctx, text, x, y, maxWidth, lineHeight){
  const words = text.split("");
  let line = "";
  for(let n=0;n<words.length;n++){
    const testLine = line + words[n];
    const metrics = ctx.measureText(testLine);
    if(metrics.width > maxWidth && n>0){
      ctx.fillText(line, x, y);
      line = words[n];
      y += lineHeight;
    }else{
      line = testLine;
    }
  }
  ctx.fillText(line, x, y);
}

function makeWishCert(){
  const text = ($("wishText").value || "").trim();
  if(!text){ alert("請輸入願望"); return; }
  const canvas = $("wishCanvas");
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;

  const bg = ctx.createLinearGradient(0,0,w,h);
  bg.addColorStop(0, "rgba(6,8,14,1)");
  bg.addColorStop(1, "rgba(16,10,24,1)");
  ctx.fillStyle = bg;
  ctx.fillRect(0,0,w,h);

  for(let i=0;i<140;i++){
    const x=Math.random()*w, y=Math.random()*h, r=Math.random()*1.8;
    ctx.fillStyle = `rgba(255,255,255,${Math.random()*0.7})`;
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  }

  ctx.fillStyle = "rgba(255,211,106,0.95)";
  ctx.font = `900 ${Math.max(26, w*0.04)}px Microsoft JhengHei`;
  ctx.fillText("五指山 · 願望證書", w*0.06, h*0.18);

  ctx.fillStyle = "rgba(230,230,236,0.82)";
  ctx.font = `700 ${Math.max(14, w*0.022)}px ui-monospace, Menlo, Consolas`;
  ctx.fillText(`Temple 12345  |  UI ${UI_VERSION}`, w*0.06, h*0.24);

  ctx.strokeStyle = "rgba(255,211,106,0.55)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  roundRect(ctx, w*0.06, h*0.30, w*0.88, h*0.46, 18);
  ctx.stroke();

  ctx.fillStyle = "rgba(255,211,106,0.92)";
  ctx.font = `800 ${Math.max(16, w*0.026)}px Microsoft JhengHei`;
  ctx.fillText("願望：", w*0.09, h*0.38);

  ctx.fillStyle = "rgba(230,230,236,0.88)";
  ctx.font = `700 ${Math.max(15, w*0.024)}px Microsoft JhengHei`;
  wrapText(ctx, text, w*0.09, h*0.44, w*0.82, Math.max(24, w*0.032));

  if(typeof ethers !== "undefined"){
    const hash = ethers.utils.keccak256(ethers.utils.toUtf8Bytes(text));
    ctx.fillStyle = "rgba(230,230,236,0.70)";
    ctx.font = `700 ${Math.max(12, w*0.018)}px ui-monospace, Menlo, Consolas`;
    ctx.fillText(`wishHash: ${hash.slice(0,12)}…${hash.slice(-10)}`, w*0.09, h*0.78);
  }

  ctx.fillStyle = "rgba(230,230,236,0.78)";
  ctx.font = `700 ${Math.max(12, w*0.018)}px ui-monospace, Menlo, Consolas`;
  ctx.fillText(`time: ${new Date().toLocaleString()}`, w*0.09, h*0.84);
  ctx.fillText(`wallet: ${state.account || "not-connected"}`, w*0.09, h*0.89);

  ctx.strokeStyle = "rgba(255,211,106,0.25)";
  ctx.beginPath(); ctx.moveTo(w*0.06, h*0.93); ctx.lineTo(w*0.94, h*0.93); ctx.stroke();

  ctx.fillStyle = "rgba(255,211,106,0.55)";
  ctx.font = `800 ${Math.max(12, w*0.018)}px Microsoft JhengHei`;
  ctx.fillText("花果山台灣・信念不滅・市場無界  Where the Market Becomes the Myth.", w*0.06, h*0.965);

  pulse();
  logLine("願望證書已生成");
}
function downloadWishCert(){ downloadCanvas("wishCanvas","wuzhishan_12345_wish_certificate.png"); }

$("btnConnect").addEventListener("click", connect);
$("btnSwitch").addEventListener("click", switchToBSC);
$("btnRefresh").addEventListener("click", refreshAll);
$("btnSave").addEventListener("click", saveCfg);
$("btnClear").addEventListener("click", clearCfg);

$("btnHeartbeat").addEventListener("click", doHeartbeat);
$("btnIgnite").addEventListener("click", doIgnite);
$("btnFortune").addEventListener("click", doFortune);
$("btnLamp").addEventListener("click", doLamp);
$("btnWish").addEventListener("click", doWish);
$("btnApprove").addEventListener("click", doApprove);
$("btnVow").addEventListener("click", doVow);

$("btnWishCert").addEventListener("click", makeWishCert);
$("btnWishDownload").addEventListener("click", downloadWishCert);

$("btnMsgSave").addEventListener("click", saveMsg);
$("btnMsgDownload").addEventListener("click", downloadMsg);
$("btnMsgClear").addEventListener("click", clearMsg);

$("btnCam").addEventListener("click", openCam);
$("btnShot").addEventListener("click", takeShot);
$("btnShotDownload").addEventListener("click", downloadShot);

$("btnSupervisor").addEventListener("click", ()=>{
  $("supervisorBox").classList.toggle("show");
  updateSupervisor();
});

$("uiVer").textContent = UI_VERSION;
loadCfg();
loadMsg();
setNetHint();
logLine("UI 啟動：" + UI_VERSION);

setInterval(()=>{ if(state.account && $("supervisorBox").classList.contains("show")) updateSupervisor(); }, 2000);
setInterval(()=>{ if(state.account) refreshStatus(); }, 3500);
</script>
</body>
</html>
