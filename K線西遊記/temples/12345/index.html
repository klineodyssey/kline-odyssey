<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>五指山12345・悟空財神殿｜V6.5 Cosmic ChainReady</title>
<style>
:root{
  --bg:#05060a;
  --panel:rgba(255,255,255,.06);
  --panel2:rgba(255,255,255,.04);
  --text:rgba(255,215,140,.92);
  --muted:rgba(255,255,255,.65);
  --line:rgba(255,215,0,.25);
  --gold:#f6d37b;
  --gold2:#ffcf44;
  --warn:#ff5a5a;
  --ok:#6cffb3;
  --shadow:0 18px 60px rgba(0,0,0,.55);
  --r:18px;
  --r2:999px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --sans: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "Microsoft JhengHei", Arial, sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:var(--sans);
  color:var(--text);
  background:
    radial-gradient(1200px 800px at 20% 10%, rgba(255,210,90,.12), transparent 60%),
    radial-gradient(900px 700px at 80% 30%, rgba(120,160,255,.10), transparent 55%),
    radial-gradient(1200px 900px at 40% 90%, rgba(255,120,200,.06), transparent 60%),
    linear-gradient(180deg, #06070b 0%, #03040a 40%, #020208 100%);
  overflow-x:hidden;
}
#stars, #stars2{
  position:fixed; inset:0; pointer-events:none; z-index:0;
  background-image:
    radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.35), transparent 60%),
    radial-gradient(1px 1px at 30% 80%, rgba(255,255,255,.30), transparent 60%),
    radial-gradient(1px 1px at 70% 40%, rgba(255,255,255,.28), transparent 60%),
    radial-gradient(1px 1px at 90% 10%, rgba(255,255,255,.20), transparent 60%),
    radial-gradient(2px 2px at 20% 60%, rgba(255,255,255,.22), transparent 60%),
    radial-gradient(2px 2px at 80% 70%, rgba(255,255,255,.18), transparent 60%);
  animation: drift 22s linear infinite;
  opacity:.9;
}
#stars2{
  filter: blur(.2px);
  opacity:.55;
  animation-duration: 36s;
  transform: scale(1.2);
}
@keyframes drift{
  from{transform:translateY(0)}
  to{transform:translateY(60px)}
}
.container{
  position:relative; z-index:1;
  max-width:1040px;
  margin:0 auto;
  padding:16px 14px 60px;
}
.top{
  display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
  padding:10px 0 6px;
}
.brand{
  display:flex; gap:14px; align-items:flex-start;
}
.pillar{
  width:10px; height:72px; border-radius:var(--r2);
  background:linear-gradient(180deg, rgba(255,215,0,.95), rgba(255,215,0,.10));
  box-shadow:0 0 20px rgba(255,210,80,.22);
  margin-top:8px;
}
.titleStack{
  display:flex; flex-direction:column;
}
.bigTitle{
  font-weight:900;
  letter-spacing:.6px;
  line-height:1.02;
  text-shadow:0 0 28px rgba(255,210,80,.12);
}
.bigTitle .l1{font-size:40px; color:var(--gold)}
.bigTitle .l2{font-size:40px; color:var(--gold)}
.bigTitle .dot{opacity:.7}
.bigTitle .l3{font-size:40px; color:var(--gold)}
.subTitle{
  margin-top:10px;
  color:rgba(255,255,255,.72);
  font-weight:700;
}
.subTitle .zh{font-size:20px; color:rgba(255,215,140,.92)}
.subTitle .en{font-size:14px; opacity:.78; margin-top:4px}
.subTitle .hint{font-size:13px; opacity:.7; margin-top:6px; line-height:1.55}
.chips{
  display:flex; flex-wrap:wrap; gap:10px; justify-content:flex-end;
}
.chip{
  padding:10px 14px;
  border-radius:var(--r2);
  border:1px solid var(--line);
  background:rgba(0,0,0,.35);
  box-shadow:var(--shadow);
  display:flex; gap:10px; align-items:center;
}
.chip b{color:var(--gold2)}
.chip small{color:rgba(255,255,255,.65)}
.grid{
  display:grid;
  grid-template-columns: 1fr;
  gap:14px;
  margin-top:10px;
}
.card{
  border:1px solid var(--line);
  background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
  border-radius:var(--r);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.card .hd{
  padding:14px 14px 10px;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.card .hd h2{
  margin:0;
  font-size:16px;
  letter-spacing:.5px;
  color:rgba(255,215,140,.95);
}
.badge{
  font-family:var(--mono);
  font-size:12px;
  padding:8px 10px;
  border-radius:var(--r2);
  border:1px solid var(--line);
  background:rgba(0,0,0,.35);
  color:rgba(255,255,255,.75);
}
.card .bd{padding:0 14px 14px}
.row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
.btn{
  appearance:none;
  border:1px solid rgba(255,215,0,.35);
  background:linear-gradient(180deg, rgba(255,215,0,.14), rgba(0,0,0,.20));
  color:rgba(255,235,180,.95);
  padding:12px 14px;
  border-radius:14px;
  font-weight:800;
  cursor:pointer;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.btn:hover{filter:brightness(1.05)}
.btn:active{transform:translateY(1px)}
.btn.secondary{
  border-color:rgba(255,255,255,.18);
  background:rgba(0,0,0,.25);
  color:rgba(255,255,255,.80);
  font-weight:700;
}
.btn.danger{
  border-color:rgba(255,80,80,.50);
  background:rgba(255,80,80,.06);
}
.input, textarea{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.30);
  color:rgba(255,255,255,.90);
  outline:none;
}
textarea{min-height:94px; resize:vertical}
.kv{
  display:grid; grid-template-columns: 1fr; gap:10px;
}
.kv .box{
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22);
  border-radius:14px;
  padding:12px 12px;
}
.kv .box .k{font-size:12px; color:rgba(255,255,255,.60); margin-bottom:6px}
.kv .box .v{font-family:var(--mono); font-size:13px; color:rgba(255,255,255,.84); word-break:break-all}
.mini{
  font-size:12px; color:rgba(255,255,255,.65); line-height:1.55;
}
.sep{height:1px; background:rgba(255,255,255,.10); margin:12px 0}
.ok{color:var(--ok)}
.warn{color:var(--warn)}
.progress{
  height:12px; border-radius:999px; background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.10); overflow:hidden;
}
.progress > i{
  display:block; height:100%;
  width:0%;
  background:linear-gradient(90deg, rgba(255,215,0,.95), rgba(255,140,70,.85));
  box-shadow:0 0 18px rgba(255,210,80,.18);
  transition:width .8s ease;
}
.flex2{display:grid; grid-template-columns:1fr; gap:12px}
@media(min-width:920px){
  .grid{grid-template-columns: 1.05fr .95fr}
  .kv{grid-template-columns: 1fr 1fr}
  .flex2{grid-template-columns: 1.2fr .8fr}
}
.cameraWrap{
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.25);
  border-radius:16px;
  overflow:hidden;
}
video{width:100%; height:auto; display:block; background:#000}
.photo{
  width:100%;
  display:block;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.2);
}
.pill{
  display:inline-flex; gap:8px; align-items:center;
  padding:8px 10px; border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.20);
  font-size:12px;
}
.pill b{color:var(--gold2)}
.hidden{display:none !important}
</style>
</head>
<body>
<div id="stars"></div><div id="stars2"></div>

<div class="container">
  <div class="top">
    <div class="brand">
      <div class="pillar" aria-hidden="true"></div>
      <div class="titleStack">
        <div class="bigTitle" aria-label="五指山12345悟空財神殿">
          <div class="l1">五指山</div>
          <div class="l2">12345 <span class="dot">·</span> <span style="display:inline-block; transform:translateY(6px)">悟</span></div>
          <div class="l3">空財神殿</div>
        </div>
        <div class="subTitle">
          <div class="zh">五指山 12345 · 悟空財神殿</div>
          <div class="en">V6.5 Cosmic Living Temple · ChainReady UI</div>
          <div class="hint">心跳/點火/發財金/點燈/還願/許願｜上鏈・拍照/錄音/留言/下載</div>
        </div>
      </div>
    </div>

    <div class="chips">
      <div class="chip"><b>版本 V6.5</b><small id="nowText">—</small></div>
      <div class="chip"><b id="netTag">未連線</b><small id="addrTag">no-wallet</small></div>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="hd">
        <h2>神殿核心狀態</h2>
        <span class="badge" id="statusBadge">準備中</span>
      </div>
      <div class="bd">
        <div class="row">
          <button class="btn" id="btnConnect">連接錢包</button>
          <button class="btn" id="btnSwitch">切換到 BSC (0x38)</button>
          <button class="btn secondary" id="btnRefresh">刷新狀態</button>
          <button class="btn secondary" id="btnInspect">監工檢查</button>
        </div>

        <div class="sep"></div>

        <div class="kv">
          <div class="box">
            <div class="k">Heart 合約地址（部署後貼上）</div>
            <input class="input" id="heartAddr" placeholder="0x..."/>
            <div class="mini">填好按「保存地址」，前端會記住並嘗試讀取狀態。</div>
          </div>
          <div class="box">
            <div class="k">公益血庫 orphanPool（顯示用，可留空）</div>
            <input class="input" id="orphanAddr" placeholder="0xB73D...（可留空）"/>
            <div class="mini">你的規劃：以「花果山孤兒自由民主震災公益社會責任」作為血庫。</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnSave">保存地址</button>
          <button class="btn danger" id="btnReset">清除本機設定</button>
        </div>

        <div class="sep"></div>

        <div class="kv">
          <div class="box">
            <div class="k">心跳倒數（下一次可領）</div>
            <div class="v" id="heartbeatCountdown">—</div>
            <div class="mini">合約規則：每小時一次（1 KGEN）。</div>
          </div>
          <div class="box">
            <div class="k">點火倒數（UTC 00:00–00:10）</div>
            <div class="v" id="igniteCountdown">—</div>
            <div class="mini">合約規則：每日點火一次（8 KGEN）。</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="kv">
          <div class="box">
            <div class="k">三次聖盃（防 Bot）</div>
            <div class="v"><span id="cupState">0</span> / 3</div>
            <div class="mini">連續 3 次「聖」才解鎖發財金按鈕（純前端遊戲門）。</div>
            <div class="row" style="margin-top:10px">
              <button class="btn" id="btnCup">搏杯一次</button>
              <button class="btn secondary" id="btnCupReset">重置</button>
            </div>
            <div class="mini" id="cupLog" style="margin-top:8px">等待第一杯。</div>
          </div>
          <div class="box">
            <div class="k">工程進度</div>
            <div class="progress"><i id="progBar"></i></div>
            <div class="mini" id="progText">0%｜偵測施工狀態中</div>
            <div class="mini">規則：若偵測到上鏈/設備完成項目，進度會自動提高。</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="flex2">
          <div class="box">
            <div class="k">發財金（Fortune）</div>
            <div class="row">
              <input class="input" id="fortuneAmount" style="max-width:240px" placeholder="1–888（整數）"/>
              <button class="btn" id="btnFortune" disabled>領發財金（需三聖盃）</button>
            </div>
            <div class="mini" id="fortuneHint">提示：先搏杯連 3 聖，再按領取。上鏈後會呼叫合約 fortuneClaim(amount)。</div>
          </div>
          <div class="box">
            <div class="k">心跳 / 點火</div>
            <div class="row">
              <button class="btn" id="btnHeartbeat">領心跳 1 KGEN</button>
              <button class="btn" id="btnIgnite">轉日點火 8 KGEN</button>
            </div>
            <div class="mini">上鏈後分別呼叫：heartbeatClaim()、igniteAndClaim()。</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="box">
          <div class="k">新手導覽（從沒錢包到領到發財金）</div>
          <div class="mini" id="guide">
            1) 安裝錢包：手機用 MetaMask 或 Trust Wallet（支援 EVM）。<br/>
            2) 加入 BSC 主網（ChainId 56 / 0x38），並準備少量 BNB 當 Gas。<br/>
            3) 進入本頁 → 按「連接錢包」→ 按「切換到 BSC」。<br/>
            4) 貼上 Heart 合約地址 → 按「保存地址」→ 按「刷新狀態」。<br/>
            5) 先「搏杯」連續三聖 → 發財金按鈕解鎖。<br/>
            6) 輸入 1–888 → 按「領發財金」。若提示餘額不足，代表心臟需要補血（還願/公益補血）。<br/>
            7) 想留下足跡：拍照/錄音/留言/許願，最後用「下載」存證。<br/>
          </div>
          <div class="row" style="margin-top:10px">
            <span class="pill"><b>提醒</b><span class="mini">BSC mainnet = ChainId 56（0x38）。選錯鏈轉帳會永久消失。</span></span>
          </div>
        </div>

        <div class="sep"></div>

        <div class="box">
          <div class="k">系統事件紀錄（本機）</div>
          <div class="mini" id="eventLog">等待事件…</div>
          <div class="row" style="margin-top:10px">
            <button class="btn secondary" id="btnDownloadLog">下載紀錄 JSON</button>
          </div>
        </div>

      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="hd">
        <h2>拍照・錄音・留言・許願（可下載存證）</h2>
        <span class="badge">Cosmic Media Vault</span>
      </div>
      <div class="bd">

        <div class="box">
          <div class="k">留言（將可印在照片）</div>
          <textarea id="msgText" placeholder="留言：我在五指山12345，見證悟空心跳…"></textarea>
        </div>
        <div class="box" style="margin-top:10px">
          <div class="k">許願（將可印在照片）</div>
          <textarea id="wishText" placeholder="許願：願悟空回血盆滿缽滿…"></textarea>
          <div class="row" style="margin-top:10px">
            <label class="pill"><input type="checkbox" id="chkStamp" checked style="accent-color:var(--gold2)"/> <b>把留言/許願印在照片</b></label>
            <button class="btn secondary" id="btnSaveLocal">儲存到石碑（本機）</button>
            <button class="btn secondary" id="btnDownloadWish">下載許願/留言</button>
          </div>
          <div class="mini" id="wishHint">上鏈時：可把許願 hash 送到合約 makeWish(bytes32)。本頁先提供存證與下載。</div>
        </div>

        <div class="sep"></div>

        <div class="box">
          <div class="k">相機（預覽與成品同尺寸）</div>
          <div class="cameraWrap" style="margin-top:10px">
            <video id="video" playsinline autoplay muted></video>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnCam">開啟相機</button>
            <button class="btn" id="btnShot">拍照（浮印）</button>
            <button class="btn secondary" id="btnShotDownload">下載照片</button>
          </div>

          <canvas id="wishCanvas" class="hidden"></canvas>
          <img id="photo" class="photo" alt="拍照成品（可下載）" style="margin-top:10px"/>
          <div class="mini">如果拍照後看起來變小：V6.5 已修正成品採原尺寸，再用自適應寬度顯示。</div>
        </div>

        <div class="sep"></div>

        <div class="box">
          <div class="k">錄音（可下載）</div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnRec">開始錄音</button>
            <button class="btn danger" id="btnRecStop" disabled>停止</button>
            <button class="btn secondary" id="btnRecDownload" disabled>下載錄音</button>
          </div>
          <audio id="audio" controls class="photo" style="margin-top:10px; padding:8px"></audio>
          <div class="mini" id="recHint">錄音會存成 webm（多數手機可播）。若瀏覽器禁止麥克風，請在網址列允許權限。</div>
        </div>

      </div>
    </div>
  </div>

  <div class="mini" style="margin-top:16px; opacity:.75">
    PrimeForge 以母機之名，開啟金融生命。<br/>
    花果山台灣・信念不滅・市場無界。<br/>
    Where the Market Becomes the Myth.<br/>
    —— 樂天帝 ⌖
  </div>

</div>

<!-- Ethers (optional). If local assets path exists, it will load; otherwise the UI still works in "未上鏈" mode -->
<script src="../../assets/js/ethers-5.7.2.umd.min.js"></script>

<script>
(() => {
  'use strict';

  // ====== constants ======
  const UI_VERSION = "V6.5";
  const BSC = {
    chainIdHex: "0x38",
    chainIdDec: 56,
    chainName: "BNB Smart Chain (BSC)",
    nativeCurrency: { name: "BNB", symbol: "BNB", decimals: 18 },
    rpcUrls: ["https://bsc-dataseed.binance.org/"],
    blockExplorerUrls: ["https://bscscan.com/"]
  };

  // ====== DOM ======
  const $ = (id) => document.getElementById(id);
  const nowText = $("nowText");
  const netTag = $("netTag");
  const addrTag = $("addrTag");
  const statusBadge = $("statusBadge");
  const heartAddr = $("heartAddr");
  const orphanAddr = $("orphanAddr");
  const heartbeatCountdown = $("heartbeatCountdown");
  const igniteCountdown = $("igniteCountdown");
  const cupState = $("cupState");
  const cupLog = $("cupLog");
  const btnFortune = $("btnFortune");
  const fortuneAmount = $("fortuneAmount");
  const fortuneHint = $("fortuneHint");
  const eventLog = $("eventLog");
  const progBar = $("progBar");
  const progText = $("progText");

  const msgText = $("msgText");
  const wishText = $("wishText");
  const chkStamp = $("chkStamp");

  const video = $("video");
  const photo = $("photo");
  const canvas = $("wishCanvas");

  const audioEl = $("audio");

  // ====== state ======
  const LS_KEY = "kline_temple_12345_v6";
  const st = {
    provider: null,
    signer: null,
    account: null,
    chainId: null,
    heart: null,
    cupStreak: 0,
    cupUnlocked: false,
    log: [],
    camStream: null,
    rec: { stream:null, recorder:null, chunks:[], blob:null }
  };

  // ====== helpers ======
  const pad2 = (n) => String(n).padStart(2,'0');
  const ts = () => {
    const d = new Date();
    return `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  };
  const logEvent = (type, detail) => {
    const item = { t: Date.now(), ts: ts(), type, detail };
    st.log.unshift(item);
    st.log = st.log.slice(0, 200);
    eventLog.textContent = `[${item.ts}] ${type}｜${detail}`;
  };

  const saveLocal = () => {
    const payload = {
      ui: UI_VERSION,
      savedAt: ts(),
      heartAddr: heartAddr.value.trim(),
      orphanAddr: orphanAddr.value.trim(),
      cupStreak: st.cupStreak,
      cupUnlocked: st.cupUnlocked,
      msg: msgText.value,
      wish: wishText.value
    };
    localStorage.setItem(LS_KEY, JSON.stringify(payload));
    logEvent("SAVE_LOCAL", "已保存地址與石碑內容（本機）");
  };

  const loadLocal = () => {
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      const j = JSON.parse(raw);
      if(j.heartAddr) heartAddr.value = j.heartAddr;
      if(j.orphanAddr) orphanAddr.value = j.orphanAddr;
      if(typeof j.cupStreak === 'number') st.cupStreak = j.cupStreak;
      if(typeof j.cupUnlocked === 'boolean') st.cupUnlocked = j.cupUnlocked;
      if(typeof j.msg === 'string') msgText.value = j.msg;
      if(typeof j.wish === 'string') wishText.value = j.wish;
    }catch(_){}
  };

  const shortAddr = (a) => a ? (a.slice(0,6)+"…"+a.slice(-4)) : "no-wallet";

  function setStatus(text, tone="muted"){
    statusBadge.textContent = text;
    statusBadge.style.color = tone==="ok" ? "rgba(108,255,179,.95)" :
                              tone==="warn"? "rgba(255,90,90,.95)" :
                              "rgba(255,255,255,.75)";
  }

  // ====== countdowns ======
  function fmtCountdown(ms){
    if(ms <= 0) return "00:00:00";
    const s = Math.floor(ms/1000);
    const hh = Math.floor(s/3600);
    const mm = Math.floor((s%3600)/60);
    const ss = s%60;
    return `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;
  }

  function nextHeartbeatMs(){
    // purely UI: next top-of-hour
    const d = new Date();
    const next = new Date(d);
    next.setMinutes(0,0,0);
    next.setHours(d.getHours()+1);
    return next - d;
  }

  function igniteWindowMs(){
    // UTC 00:00 - 00:10
    const now = new Date();
    const utc = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), now.getUTCHours(), now.getUTCMinutes(), now.getUTCSeconds());
    const secOfDay = Math.floor((utc/1000) % 86400);
    const start = 0, end = 600;
    if(secOfDay <= end){
      return (end - secOfDay) * 1000; // time left in today's window (if already started)
    }
    // time until tomorrow's start
    return (86400 - secOfDay + start) * 1000;
  }

  function startCountdowns(){
    const tick = () => {
      nowText.textContent = ts();
      heartbeatCountdown.textContent = fmtCountdown(nextHeartbeatMs());
      const ig = igniteWindowMs();
      // If within window, show "在窗口內（剩餘）" else show "距離窗口"
      const now = new Date();
      const secUTC = now.getUTCHours()*3600 + now.getUTCMinutes()*60 + now.getUTCSeconds();
      if(secUTC <= 600){
        igniteCountdown.textContent = `在窗口內｜剩餘 ${fmtCountdown(ig)}`;
      }else{
        igniteCountdown.textContent = `距離窗口｜${fmtCountdown(ig)}`;
      }
    };
    tick();
    setInterval(tick, 1000);
  }

  // ====== cup (聖盃) ======
  function renderCup(){
    cupState.textContent = String(st.cupStreak);
    if(st.cupUnlocked){
      btnFortune.disabled = false;
      fortuneHint.textContent = "三聖盃已完成：可以領發財金（上鏈後會呼叫合約）。";
    }else{
      btnFortune.disabled = true;
      fortuneHint.textContent = "提示：先搏杯連 3 聖，才可按領取（防 Bot 的遊戲門）。";
    }
  }

  function tossCup(){
    // 50% 聖, 50% 笑（你要改機率可在這裡調）
    const holy = (crypto?.getRandomValues ? crypto.getRandomValues(new Uint32Array(1))[0] : Math.floor(Math.random()*1e9)) % 2 === 0;
    if(holy){
      st.cupStreak += 1;
      cupLog.textContent = `第 ${st.cupStreak} 杯：聖 ✅（連續）`;
      logEvent("CUP", `聖｜streak=${st.cupStreak}`);
      if(st.cupStreak >= 3){
        st.cupUnlocked = true;
        cupLog.textContent = "三聖盃完成。發財金已解鎖。";
        logEvent("CUP_UNLOCK", "三聖盃完成");
      }
    }else{
      st.cupStreak = 0;
      st.cupUnlocked = false;
      cupLog.textContent = "笑筊 ❌（重置，重新來）";
      logEvent("CUP", "笑｜reset");
    }
    renderCup();
    saveLocal();
  }

  function resetCup(){
    st.cupStreak = 0;
    st.cupUnlocked = false;
    cupLog.textContent = "已重置。等待第一杯。";
    logEvent("CUP_RESET", "reset");
    renderCup();
    saveLocal();
  }

  // ====== progress ======
  function computeProgress(){
    let p = 20; // base UI built
    const hasHeart = /^0x[a-fA-F0-9]{40}$/.test(heartAddr.value.trim());
    const hasWallet = !!st.account;
    if(hasHeart) p += 20;
    if(hasWallet) p += 15;
    if(st.cupUnlocked) p += 10;
    const hasMedia = (photo.src && photo.src.startsWith("data:image")) ? 10 : 0;
    const hasWish = (wishText.value.trim().length >= 2) ? 10 : 0;
    const hasMsg = (msgText.value.trim().length >= 2) ? 5 : 0;
    p += hasMedia + hasWish + hasMsg;
    if(p>100) p=100;
    progBar.style.width = p + "%";
    progText.textContent = `${p}%｜${hasHeart ? "已貼合約" : "等待合約"}｜${hasWallet ? "錢包已連線" : "尚未連線"}｜${st.cupUnlocked ? "三聖盃OK" : "需搏杯"}`;
  }

  // ====== wallet / chain ======
  async function ensureProvider(){
    if(!window.ethereum) throw new Error("NO_WALLET");
    // ethers optional: if missing, still allow connect + chain switch via ethereum API
    return window.ethereum;
  }

  async function connectWallet(){
    const eth = await ensureProvider();
    const accounts = await eth.request({ method: "eth_requestAccounts" });
    st.account = accounts && accounts[0] ? accounts[0] : null;
    const chainIdHex = await eth.request({ method: "eth_chainId" });
    st.chainId = parseInt(chainIdHex, 16);
    addrTag.textContent = st.account ? shortAddr(st.account) : "no-wallet";
    netTag.textContent = (st.chainId === BSC.chainIdDec) ? "BSC 已連線" : `Chain ${st.chainId}`;
    setStatus(st.account ? "錢包已連線" : "未連線", st.account ? "ok" : "warn");
    logEvent("WALLET", st.account ? `connected ${shortAddr(st.account)}` : "no account");
    computeProgress();
  }

  async function switchToBSC(){
    const eth = await ensureProvider();
    try{
      await eth.request({ method: "wallet_switchEthereumChain", params: [{ chainId: BSC.chainIdHex }] });
    }catch(err){
      // 4902: unknown chain, add it
      if(err && (err.code === 4902 || /Unrecognized chain/i.test(err.message||""))){
        await eth.request({ method: "wallet_addEthereumChain", params: [BSC] });
      }else{
        throw err;
      }
    }
    const chainIdHex = await eth.request({ method: "eth_chainId" });
    st.chainId = parseInt(chainIdHex, 16);
    netTag.textContent = (st.chainId === BSC.chainIdDec) ? "BSC 已連線" : `Chain ${st.chainId}`;
    logEvent("CHAIN", `switched to ${netTag.textContent}`);
    computeProgress();
  }

  // ====== chain calls (optional) ======
  const HEART_ABI = [
    "function fortuneClaim(uint256 amountWhole)",
    "function heartbeatClaim()",
    "function igniteAndClaim()",
    "function makeWish(bytes32 wishHash)",
    "function heartBalanceWhole() view returns (uint256)",
    "function effectiveCapWhole() view returns (uint256)",
    "function effectiveFloorWhole() view returns (uint256)"
  ];

  function ethersReady(){
    return typeof window.ethers !== "undefined" && window.ethers && window.ethers.providers;
  }

  async function getHeartContract(){
    const addr = heartAddr.value.trim();
    if(!/^0x[a-fA-F0-9]{40}$/.test(addr)) throw new Error("HEART_ADDR_BAD");
    if(!ethersReady()) throw new Error("ETHERS_NOT_LOADED");
    if(!window.ethereum) throw new Error("NO_WALLET");
    const provider = new window.ethers.providers.Web3Provider(window.ethereum);
    const signer = provider.getSigner();
    return new window.ethers.Contract(addr, HEART_ABI, signer);
  }

  async function refreshStatus(){
    try{
      if(window.ethereum){
        const chainIdHex = await window.ethereum.request({ method: "eth_chainId" });
        st.chainId = parseInt(chainIdHex, 16);
        netTag.textContent = (st.chainId === BSC.chainIdDec) ? "BSC 已連線" : `Chain ${st.chainId}`;
      }
      if(st.account){
        addrTag.textContent = shortAddr(st.account);
      }
      // chain reads if possible
      if(ethersReady() && /^0x[a-fA-F0-9]{40}$/.test(heartAddr.value.trim())){
        const heart = await getHeartContract();
        const bal = await heart.heartBalanceWhole();
        const cap = await heart.effectiveCapWhole();
        const floor = await heart.effectiveFloorWhole();
        setStatus("已連線・可讀取合約", "ok");
        statusBadge.textContent = `Heart ${bal.toString()} / cap ${cap.toString()}（floor ${floor.toString()}）`;
        logEvent("STATUS", `heartBalanceWhole=${bal.toString()}`);
      }else{
        setStatus(window.ethereum ? "錢包可用（未讀取合約）" : "未安裝錢包", window.ethereum ? "muted" : "warn");
      }
    }catch(e){
      setStatus("狀態讀取失敗", "warn");
      logEvent("ERROR", e.message || String(e));
    }
    computeProgress();
  }

  // ====== temple actions ======
  async function callFortune(){
    try{
      if(!st.cupUnlocked) throw new Error("NEED_3_CUPS");
      const amt = parseInt((fortuneAmount.value||"").trim(), 10);
      if(!Number.isFinite(amt) || amt < 1 || amt > 888) throw new Error("AMOUNT_1_888");
      // chain call
      if(ethersReady() && /^0x[a-fA-F0-9]{40}$/.test(heartAddr.value.trim())){
        const heart = await getHeartContract();
        const tx = await heart.fortuneClaim(amt);
        logEvent("TX", `fortuneClaim(${amt}) sent`);
        fortuneHint.textContent = "已送出交易，等待鏈上確認…";
        await tx.wait?.();
        logEvent("TX_OK", "fortuneClaim confirmed");
      }else{
        logEvent("SIM", `未上鏈：模擬領發財金 ${amt} KGEN`);
        fortuneHint.textContent = "未上鏈模式：已模擬領取。部署後貼上合約地址即可上鏈。";
      }
    }catch(e){
      logEvent("FORTUNE_FAIL", e.message || String(e));
      fortuneHint.textContent = `失敗：${e.message || e}`;
    }
  }

  async function callHeartbeat(){
    try{
      if(ethersReady() && /^0x[a-fA-F0-9]{40}$/.test(heartAddr.value.trim())){
        const heart = await getHeartContract();
        const tx = await heart.heartbeatClaim();
        logEvent("TX", "heartbeatClaim() sent");
        await tx.wait?.();
        logEvent("TX_OK", "heartbeatClaim confirmed");
      }else{
        logEvent("SIM", "未上鏈：模擬領心跳 1 KGEN");
      }
    }catch(e){
      logEvent("HEARTBEAT_FAIL", e.message || String(e));
    }
  }

  async function callIgnite(){
    try{
      if(ethersReady() && /^0x[a-fA-F0-9]{40}$/.test(heartAddr.value.trim())){
        const heart = await getHeartContract();
        const tx = await heart.igniteAndClaim();
        logEvent("TX", "igniteAndClaim() sent");
        await tx.wait?.();
        logEvent("TX_OK", "igniteAndClaim confirmed");
      }else{
        logEvent("SIM", "未上鏈：模擬轉日點火 8 KGEN（需 UTC 00:00–00:10）");
      }
    }catch(e){
      logEvent("IGNITE_FAIL", e.message || String(e));
    }
  }

  async function callMakeWish(){
    try{
      const w = wishText.value.trim();
      if(!w) throw new Error("WISH_EMPTY");
      // simple keccak256 if ethers available, else use sha256
      let hashHex = "";
      if(ethersReady()){
        hashHex = window.ethers.utils.keccak256(window.ethers.utils.toUtf8Bytes(w));
      }else if(window.crypto?.subtle){
        const buf = await window.crypto.subtle.digest("SHA-256", new TextEncoder().encode(w));
        hashHex = "0x" + [...new Uint8Array(buf)].map(x=>x.toString(16).padStart(2,'0')).join('');
      }else{
        hashHex = "0x" + btoa(unescape(encodeURIComponent(w))).slice(0,64).padEnd(64,'0');
      }

      if(ethersReady() && /^0x[a-fA-F0-9]{40}$/.test(heartAddr.value.trim())){
        const heart = await getHeartContract();
        const tx = await heart.makeWish(hashHex);
        logEvent("TX", "makeWish(hash) sent");
        await tx.wait?.();
        logEvent("TX_OK", "makeWish confirmed");
        $("wishHint").textContent = `許願已上鏈（hash：${hashHex.slice(0,10)}…）`;
      }else{
        logEvent("SIM", `未上鏈：許願 hash=${hashHex.slice(0,12)}…`);
        $("wishHint").textContent = `未上鏈模式：已生成 hash（${hashHex.slice(0,10)}…）。部署後可上鏈記錄。`;
      }
    }catch(e){
      logEvent("WISH_FAIL", e.message || String(e));
      $("wishHint").textContent = `失敗：${e.message || e}`;
    }
  }

  // ====== camera ======
  async function openCamera(){
    try{
      if(st.camStream) return;
      st.camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
      video.srcObject = st.camStream;
      logEvent("CAM", "camera started");
    }catch(e){
      logEvent("CAM_FAIL", e.message || String(e));
    }
  }

  function drawStamp(ctx, w, h){
    const stampOn = chkStamp.checked;
    const msg = msgText.value.trim();
    const wish = wishText.value.trim();
    const lines = [];
    if(stampOn && msg) lines.push("留言：" + msg);
    if(stampOn && wish) lines.push("許願：" + wish);
    const meta = `五指山12345｜${UI_VERSION}｜${ts()}｜${st.account ? shortAddr(st.account) : "no-wallet"}`;

    ctx.save();
    // footer bar
    const pad = Math.max(14, Math.floor(w * 0.02));
    const font = Math.max(16, Math.floor(w * 0.035));
    const small = Math.max(14, Math.floor(w * 0.028));
    const barH = pad*2 + (lines.length ? (lines.length* (small+6)) : 0) + (small+8);
    ctx.fillStyle = "rgba(0,0,0,0.45)";
    ctx.fillRect(0, h-barH, w, barH);

    ctx.fillStyle = "rgba(255,215,140,0.95)";
    ctx.font = `700 ${small}px ${getComputedStyle(document.body).fontFamily}`;
    ctx.fillText(meta, pad, h - pad - (lines.length? (lines.length*(small+6)) : 0));

    if(lines.length){
      ctx.fillStyle = "rgba(255,235,200,0.92)";
      ctx.font = `600 ${small}px ${getComputedStyle(document.body).fontFamily}`;
      let y = h - pad - (small+8);
      for(const line of lines){
        ctx.fillText(line, pad, y);
        y -= (small+6);
      }
    }
    ctx.restore();
  }

  function snapPhoto(){
    try{
      const vw = video.videoWidth;
      const vh = video.videoHeight;
      if(!vw || !vh) throw new Error("VIDEO_NOT_READY");
      canvas.width = vw;
      canvas.height = vh;
      const ctx = canvas.getContext("2d", { willReadFrequently: false });
      ctx.drawImage(video, 0, 0, vw, vh);
      drawStamp(ctx, vw, vh);
      const url = canvas.toDataURL("image/png", 1.0);
      photo.src = url;
      logEvent("PHOTO", "captured");
      computeProgress();
    }catch(e){
      logEvent("PHOTO_FAIL", e.message || String(e));
    }
  }

  function downloadDataURL(dataUrl, filename){
    const a = document.createElement("a");
    a.href = dataUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function downloadPhoto(){
    if(!photo.src || !photo.src.startsWith("data:image")) return logEvent("DOWNLOAD_FAIL", "尚未拍照");
    downloadDataURL(photo.src, `Wuzhishan12345_${UI_VERSION}_${Date.now()}.png`);
    logEvent("DOWNLOAD", "photo png");
  }

  // ====== audio record ======
  async function startRecord(){
    try{
      if(st.rec.recorder) return;
      st.rec.stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
      st.rec.chunks = [];
      const rec = new MediaRecorder(st.rec.stream);
      st.rec.recorder = rec;
      rec.ondataavailable = (e) => { if(e.data && e.data.size) st.rec.chunks.push(e.data); };
      rec.onstop = () => {
        const blob = new Blob(st.rec.chunks, { type: rec.mimeType || "audio/webm" });
        st.rec.blob = blob;
        audioEl.src = URL.createObjectURL(blob);
        $("btnRecDownload").disabled = false;
        logEvent("REC", "ready");
      };
      rec.start();
      $("btnRec").disabled = true;
      $("btnRecStop").disabled = false;
      logEvent("REC", "start");
    }catch(e){
      logEvent("REC_FAIL", e.message || String(e));
    }
  }

  function stopRecord(){
    try{
      const rec = st.rec.recorder;
      if(!rec) return;
      rec.stop();
      st.rec.stream?.getTracks()?.forEach(t=>t.stop());
      st.rec.stream = null;
      st.rec.recorder = null;
      $("btnRec").disabled = false;
      $("btnRecStop").disabled = true;
      logEvent("REC", "stop");
    }catch(e){
      logEvent("REC_FAIL", e.message || String(e));
    }
  }

  function downloadRecord(){
    const blob = st.rec.blob;
    if(!blob) return;
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `Wuzhishan12345_${UI_VERSION}_${Date.now()}.webm`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 8000);
    logEvent("DOWNLOAD", "audio webm");
  }

  // ====== downloads ======
  function downloadJSON(obj, filename){
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 8000);
  }

  function downloadWish(){
    const payload = {
      ui: UI_VERSION,
      savedAt: ts(),
      msg: msgText.value,
      wish: wishText.value
    };
    downloadJSON(payload, `Wuzhishan12345_Wish_${UI_VERSION}_${Date.now()}.json`);
    logEvent("DOWNLOAD", "wish json");
  }

  function downloadLog(){
    downloadJSON({ ui: UI_VERSION, exportedAt: ts(), log: st.log }, `Wuzhishan12345_Log_${UI_VERSION}_${Date.now()}.json`);
    logEvent("DOWNLOAD", "log json");
  }

  // ====== wiring ======
  function wire(){
    $("btnConnect").addEventListener("click", connectWallet);
    $("btnSwitch").addEventListener("click", switchToBSC);
    $("btnRefresh").addEventListener("click", refreshStatus);
    $("btnInspect").addEventListener("click", () => { computeProgress(); logEvent("INSPECT", "監工檢查完成"); });

    $("btnSave").addEventListener("click", () => { saveLocal(); refreshStatus(); computeProgress(); });
    $("btnReset").addEventListener("click", () => {
      localStorage.removeItem(LS_KEY);
      st.cupStreak=0; st.cupUnlocked=false;
      heartAddr.value=""; orphanAddr.value="";
      msgText.value=""; wishText.value="";
      photo.src="";
      logEvent("RESET", "已清除本機設定");
      renderCup(); computeProgress();
    });

    $("btnCup").addEventListener("click", tossCup);
    $("btnCupReset").addEventListener("click", resetCup);

    $("btnFortune").addEventListener("click", callFortune);
    $("btnHeartbeat").addEventListener("click", callHeartbeat);
    $("btnIgnite").addEventListener("click", callIgnite);

    $("btnSaveLocal").addEventListener("click", () => { saveLocal(); callMakeWish(); computeProgress(); });
    $("btnDownloadWish").addEventListener("click", downloadWish);
    $("btnDownloadLog").addEventListener("click", downloadLog);

    $("btnCam").addEventListener("click", openCamera);
    $("btnShot").addEventListener("click", snapPhoto);
    $("btnShotDownload").addEventListener("click", downloadPhoto);

    $("btnRec").addEventListener("click", startRecord);
    $("btnRecStop").addEventListener("click", stopRecord);
    $("btnRecDownload").addEventListener("click", downloadRecord);

    // live progress updates
    [heartAddr, orphanAddr, fortuneAmount, msgText, wishText, chkStamp].forEach(el=>{
      el.addEventListener("input", computeProgress);
      el.addEventListener("change", computeProgress);
    });

    if(window.ethereum){
      window.ethereum.on?.("chainChanged", () => refreshStatus());
      window.ethereum.on?.("accountsChanged", (accs) => { st.account = accs?.[0] || null; refreshStatus(); });
    }
  }

  // ====== init ======
  loadLocal();
  renderCup();
  startCountdowns();
  wire();
  computeProgress();
  refreshStatus();

})();
</script>
</body>
</html>
