<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kç·šè¥¿éŠè¨˜ï½œéŠ€æ²³å®‡å®™å…¥å£ï¼ˆPortal V1.6 Multi-Nodesï¼‰</title>
  <style>
    :root{
      --bg:#06070b;
      --panel: rgba(255,255,255,.06);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --line: rgba(255,255,255,.14);
      --btn: rgba(255,255,255,.12);
      --btnh: rgba(255,255,255,.18);
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --r: 18px;
      --r2: 999px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Heiti TC", Arial, sans-serif;
      --ok:#9fffd9;
      --warn:#ffd28c;
      --bad:#ff9fb2;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 800px at 30% 20%, rgba(120,170,255,.10), transparent 60%),
                  radial-gradient(1000px 700px at 70% 60%, rgba(255,160,220,.08), transparent 55%),
                  var(--bg);
      color: var(--text);
      min-height:100vh;
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 40px;}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 0 14px;}
    .brand{display:flex;flex-direction:column;gap:4px;}
    .brand .h{font-weight:900;letter-spacing:.5px;font-size:18px;}
    .brand .s{font-size:12px;color:var(--muted);}
    .pillrow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .pill{
      display:flex;gap:8px;align-items:center;
      padding:9px 12px;border:1px solid var(--line);border-radius:var(--r2);
      background:rgba(255,255,255,.05);backdrop-filter:blur(8px);box-shadow:var(--shadow);
      font-size:12px;color:var(--muted);white-space:nowrap;
    }
    .pill b{color:var(--text);font-weight:800}
    .mono{font-family:var(--mono)}
    .hero{
      position:relative;border:1px solid var(--line);border-radius:24px;
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow:var(--shadow);overflow:hidden;padding:18px;
    }
    canvas#stars{position:absolute;inset:0;width:100%;height:100%;opacity:.85;pointer-events:none;}
    .heroGrid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;}
    @media (max-width:900px){.heroGrid{grid-template-columns:1fr}}
    .title{font-size:26px;font-weight:950;letter-spacing:.8px;margin:4px 0 8px;}
    .subtitle{color:var(--muted);line-height:1.55;margin:0 0 14px;font-size:13px;}
    .ctaRow{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 14px;border-radius:var(--r2);border:1px solid var(--line);
      background:var(--btn);text-decoration:none;font-weight:850;font-size:13px;transition:.15s;user-select:none;
      cursor:pointer;
    }
    .btn:hover{background:var(--btnh)}
    .btn.small{padding:8px 12px;font-weight:800}
    .grid{display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;margin-top:14px;}
    @media (max-width:900px){.grid{grid-template-columns:1fr 1fr}}
    @media (max-width:520px){.grid{grid-template-columns:1fr}}
    .card{
      border:1px solid var(--line);border-radius:var(--r);background:var(--panel);
      box-shadow:var(--shadow);padding:14px;min-height:110px;position:relative;overflow:hidden;
    }
    .card .k{font-size:12px;color:var(--muted);margin-bottom:6px;letter-spacing:.2px}
    .card .v{font-size:18px;font-weight:950;letter-spacing:.6px}
    .card .t{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .smallText{font-size:12px;color:var(--muted);line-height:1.35}
    .map{
      margin-top:14px;border:1px solid var(--line);border-radius:24px;background:rgba(0,0,0,.20);
      box-shadow:var(--shadow);padding:16px;position:relative;overflow:hidden;
    }
    .mapHead{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .mapHead .h{font-weight:950;letter-spacing:.6px;font-size:16px;}
    .mapHead .s{color:var(--muted);font-size:12px;}
    .nodes{display:grid;grid-template-columns:repeat(4, 1fr);gap:10px;margin-top:10px;}
    @media (max-width:900px){.nodes{grid-template-columns:repeat(2, 1fr)}}
    @media (max-width:520px){.nodes{grid-template-columns:1fr}}
    .node{
      border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.06);
      padding:12px;text-decoration:none;display:flex;flex-direction:column;gap:6px;transition:.15s;min-height:110px;
    }
    .node:hover{background:rgba(255,255,255,.10)}
    .node .n{font-weight:950;letter-spacing:.5px}
    .node .p{color:var(--muted);font-size:12px;line-height:1.35}
    .node .id{color:rgba(255,255,255,.75);font-size:12px;font-family:var(--mono)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.18);font-size:12px;color:var(--muted)}
    .badge.ok{color:var(--ok)}
    .badge.warn{color:var(--warn)}
    .badge.bad{color:var(--bad)}
    .footer{color:var(--muted);font-size:12px;margin-top:14px;line-height:1.55;padding-bottom:6px;}
    .hr{height:1px;background:var(--line);margin:10px 0}

    .topRight{
      position:fixed; right:14px; top:14px; z-index:50;
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    .miniPill{
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.18);
      padding:8px 10px;
      border-radius:999px;
      box-shadow: var(--shadow);
      font-size:12px;
      color: var(--text);
      backdrop-filter: blur(8px);
    }
    .miniPill b{ font-family: var(--mono); }
    .supervisorBtn{
      cursor:pointer; user-select:none;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      padding:8px 12px; border-radius:999px;
      box-shadow: var(--shadow);
      font-weight:800;
    }
    .overlay{
      position:fixed; inset:0; z-index:80;
      background: rgba(0,0,0,.72);
      display:none;
    }
    .overlay.on{ display:block; }
    .overlayCard{
      position:absolute; right:14px; top:64px;
      width:min(560px, calc(100vw - 28px));
      background: rgba(10,10,16,.85);
      border:1px solid rgba(255,215,0,.30);
      border-radius: var(--r);
      box-shadow: 0 18px 70px rgba(0,0,0,.65);
      padding:14px;
      backdrop-filter: blur(10px);
      color: var(--text);
    }
    .progressWrap{ margin-top:10px; }
    .progressBar{
      width:100%; height:14px; border-radius:999px;
      background: rgba(255,255,255,.10);
      overflow:hidden; border:1px solid rgba(255,255,255,.14);
    }
    .progressFill{
      height:100%; width:0%;
      background: linear-gradient(90deg, rgba(255,215,0,.95), rgba(255,160,0,.95));
      transition: width .6s ease;
    }
    .chkGrid{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px 10px;
      margin-top:10px;
      font-size:13px;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.25);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 0 10px rgba(255,255,255,.10);
      justify-self:end;
      margin-top:4px;
    }
    .dot.ok{ background: rgba(120,255,200,.95); box-shadow:0 0 14px rgba(120,255,200,.45); }
    .dot.warn{ background: rgba(255,210,120,.95); box-shadow:0 0 14px rgba(255,210,120,.45); }
    .dot.bad{ background: rgba(255,120,120,.95); box-shadow:0 0 14px rgba(255,120,120,.45); }

    .drawerScrim{
      position:fixed; inset:0; z-index:90;
      background: rgba(0,0,0,.55);
      display:none;
    }
    .drawerScrim.on{ display:block; }
    .drawer{
      position:fixed; right:14px; bottom:14px; top:14px; z-index:91;
      width:min(560px, calc(100vw - 28px));
      border:1px solid rgba(255,255,255,.16);
      background: rgba(10,10,16,.86);
      border-radius: 20px;
      box-shadow: 0 18px 70px rgba(0,0,0,.65);
      backdrop-filter: blur(12px);
      padding:14px;
      display:none;
      overflow:auto;
    }
    .drawer.on{ display:block; }
    .drawer h3{ margin:0 0 8px; font-size:14px; letter-spacing:.35px; }
    .drawer .muted{ color: var(--muted); font-size:12px; line-height:1.55; }
    .field{ margin-top:10px; }
    .field label{ display:block; font-size:12px; color: var(--muted); margin-bottom:6px; }
    .field input, .field textarea{
      width:100%; border-radius:14px; border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35); color: var(--text);
      padding:10px 12px; outline:none; font-family: var(--mono); font-size:12px;
    }
    .rowBtns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .rowBtns .btn{ padding:9px 12px; }
    .sectionLine{ height:1px; background: rgba(255,255,255,.12); margin:12px 0; }
    .table{ width:100%; border-collapse:separate; border-spacing:0 8px; }
    .table td{ font-size:12px; color: var(--muted); padding:8px 10px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); }
    .table td:first-child{ border-radius:12px 0 0 12px; }
    .table td:last-child{ border-radius:0 12px 12px 0; }
    .kTag{ color: var(--text); font-weight:850; }
    .warnText{ color: var(--warn); }
    .okText{ color: var(--ok); }
  </style>

  <script src="./assets/ethers-5.7.2.umd.min.js"></script>
</head>

<body>
  <div class="topRight">
    <div class="miniPill">ç‰ˆæœ¬ï¼š<b id="uiVersion" class="mono">Portal V1.6</b></div>
    <div class="miniPill">æ™‚é–“ï¼š<b id="nowClock" class="mono">--</b></div>
    <div class="supervisorBtn" id="btnSupervisor">ç›£å·¥æª¢æŸ¥</div>
    <div class="supervisorBtn" id="btnSettings">è¨­å®š</div>
  </div>

  <div class="overlay" id="supervisorOverlay" aria-hidden="true">
    <div class="overlayCard">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div style="font-weight:950;letter-spacing:.35px;">ç›£å·¥æª¢æŸ¥ï½œPortal V1.6</div>
        <div class="badge" id="supClose" style="cursor:pointer;">é—œé–‰</div>
      </div>
      <div class="progressWrap">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div style="color:var(--muted);font-size:12px;">å·¥ç¨‹é€²åº¦ï¼ˆè‡ªå‹•æª¢æŸ¥ï¼‰</div>
          <div class="badge" id="supPct">0%</div>
        </div>
        <div class="progressBar"><div class="progressFill" id="supFill"></div></div>
      </div>

      <div class="chkGrid" id="supChecks">
        <div>é é¢è¼‰å…¥</div><div class="dot" id="chkLoaded"></div>
        <div>æ˜Ÿç©ºå¼•æ“ï¼ˆCanvasï¼‰</div><div class="dot" id="chkStars"></div>
        <div>ç¯€é»åµæ¸¬ï¼ˆå„æ®¿ index.htmlï¼‰</div><div class="dot" id="chkNodes"></div>
        <div>å…¨åŸŸé»ç«ï¼ˆMulti-Heartï¼‰</div><div class="dot" id="chkGlobalIgnite"></div>
        <div>11520 Brain é¢æ¿</div><div class="dot" id="chkBrainPanel"></div>
        <div>éŒ¯èª¤ç›£çœ‹ï¼ˆConsole æ•æ‰ï¼‰</div><div class="dot" id="chkErrors"></div>
      </div>

      <div style="margin-top:12px;color:var(--muted);font-size:12px;line-height:1.6;">
        èªªæ˜ï¼šPortal åªåšã€Œå°èˆªï¼‹è®€éˆã€ã€‚åœ°å€æœªè¨­å®šæˆ–åˆç´„æœªéƒ¨ç½²æ™‚ï¼Œé¢æ¿æœƒé¡¯ç¤ºã€Œæœªéƒ¨ç½²/æœªè¨­å®šã€ä½†ä¸æœƒå£ã€‚
      </div>
    </div>
  </div>

  <div class="drawerScrim" id="drawerScrim"></div>
  <div class="drawer" id="drawer">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;">
      <div>
        <h3>Portal è¨­å®šï¼ˆå¤šæ®¿ / å¤š Heart / 11520 / 16888ï¼‰</h3>
        <div class="muted">
          é€™è£¡åªæ”¹ã€Œè®€éˆ/å°èˆªã€ç”¨çš„åœ°å€ï¼Œä¸æœƒå‹•åˆ°åˆç´„ã€‚<br/>
          ä½ éƒ¨ç½²å¾ŒæŠŠåœ°å€è²¼ä¸Šï¼ŒPortal å°±æœƒè‡ªå‹•äº®ç‡ˆèˆ‡è®€éˆã€‚
        </div>
      </div>
      <div class="badge" id="btnCloseDrawer" style="cursor:pointer;">é—œé–‰</div>
    </div>

    <div class="sectionLine"></div>

    <div class="field">
      <label>KGEN Tokenï¼ˆå·²éƒ¨ç½²ï¼‰</label>
      <input id="inKgenToken" placeholder="0x..." />
    </div>

    <div class="field">
      <label>Heart åˆ—è¡¨ï¼ˆæ¯è¡Œï¼šåº§æ¨™,0xåœ°å€ï¼‰</label>
      <textarea id="inHearts" placeholder="12345,0x...\n23456,0x..."></textarea>
      <div class="muted">ä½ ç¾åœ¨å¯å…ˆæ”¾ 12345ï¼›æœªä¾†æ–°å¢æ®¿å°±åŠ ä¸€è¡Œã€‚</div>
    </div>

    <div class="field">
      <label>11520 BrainExchangeï¼ˆå¤§è…¦äº¤æ˜“æ‰€ï¼‰</label>
      <input id="inBrain11520" placeholder="0x..." />
      <div class="muted">å®¹é‡é¡¯ç¤ºå›ºå®š 50,000,000 KGENï¼ˆæ‚Ÿç©ºè…¦å®¹é‡ï¼‰ã€‚</div>
    </div>

    <div class="field">
      <label>108000 MarsSeatsï¼ˆè±ªå®…ï¼‰</label>
      <input id="inMars108000" placeholder="0x..." />
    </div>

    <div class="field">
      <label>18888 éˆéœ„å¯¶æ®¿ï¼ˆDeityBankï¼‰</label>
      <input id="inBank18888" placeholder="0x..." />
    </div>

    <div class="field">
      <label>18921 æ–¬å¦–å°ï¼ˆTaxSplitter / AutoLP åˆ†æµï¼‰</label>
      <input id="inZhanyao18921" placeholder="0x..." />
    </div>

    <div class="field">
      <label>16888 å»£å¯’å®®ï¼ˆä¸ƒä»™å¥³è¨±é¡˜æ± ï¼‰</label>
      <input id="inWish16888" placeholder="0x..." />
      <div class="muted">å…ˆå»ºé»ä½ï¼›ç­‰ä½ éƒ¨ç½²è¨±é¡˜æ± åˆç´„å†é»äº®ã€‚</div>
    </div>

    <div class="field">
      <label>ä¸ƒä»™å¥³åœ°å€ï¼ˆæ¯è¡Œä¸€å€‹ 0x åœ°å€ï¼Œå…± 7 è¡Œï¼‰</label>
      <textarea id="inFairies7" placeholder="0x...\n0x...\n..."></textarea>
      <div class="muted">Portal æœƒé¡¯ç¤ºã€Œå·²ç™»è¨˜å¹¾ä½ã€ã€‚</div>
    </div>

    <div class="rowBtns">
      <div class="btn" id="btnSaveCfg">å„²å­˜è¨­å®š</div>
      <div class="btn" id="btnResetCfg">é‡ç½®</div>
      <div class="btn" id="btnApplyAndRefresh">å¥—ç”¨ä¸¦åˆ·æ–°</div>
    </div>

    <div class="sectionLine"></div>

    <div class="muted">
      GitHub è·¯å¾‘ï¼š<span class="mono">Kç·šè¥¿éŠè¨˜/index.html</span><br/>
      ethers è·¯å¾‘ï¼š<span class="mono">Kç·šè¥¿éŠè¨˜/assets/ethers-5.7.2.umd.min.js</span><br/>
      è¨­å®šå­˜åœ¨ localStorageï¼ˆä¸æœƒä¸Šéˆï¼‰ã€‚
    </div>
  </div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="h">Kç·šè¥¿éŠè¨˜ï½œéŠ€æ²³å®‡å®™å…¥å£</div>
        <div class="s">KLINE Odyssey Â· Map Portal Â· Portal V1.6ï¼ˆMulti-Heart + 11520ï¼‰</div>
      </div>

      <div class="pillrow">
        <div class="pill">KGEN Tokenï¼š<b class="mono" id="kgenAddrTop">--</b></div>
        <div class="pill">ä»Šæ—¥åƒè¨ªï¼š<b class="mono" id="today">0</b></div>
        <div class="pill">ç¸½åƒè¨ªï¼š<b class="mono" id="total">0</b></div>
      </div>
    </header>

    <section class="hero">
      <canvas id="stars"></canvas>

      <div class="heroGrid">
        <div>
          <div class="title">å®‡å®™ä¸éœ€è¦è§£é‡‹ï¼Œåªéœ€è¦å…¥å£ã€‚</div>
          <p class="subtitle">
            Portal V1.6ï¼šæ–°å¢ã€Œå…¨åŸŸé»ç« Multiâ€‘Heartã€ï¼‹ã€Œ11520 æ‚Ÿç©ºå¤§è…¦ï¼ˆ5000è¬å®¹é‡ï¼‰ã€ã€‚<br/>
            æœªéƒ¨ç½²é»ä½å…ˆä¿ç•™åº§æ¨™ã€å…ˆä¸Šåœ°åœ–ï¼Œç­‰åˆç´„ä¸Šéˆè‡ªå‹•äº®ç‡ˆã€‚
          </p>

          <div class="ctaRow">
            <a class="btn" href="#map">ğŸ—ºï¸ é€²å…¥å®‡å®™åœ°åœ–</a>
            <a class="btn" href="./README.md">ğŸ“˜ æŸ¥çœ‹è³‡æ–™èªªæ˜</a>
            <a class="btn small" href="https://t.me/klineodyssey" target="_blank" rel="noreferrer">Telegram</a>
            <a class="btn small" href="https://lin.ee/b8X18F7" target="_blank" rel="noreferrer">LINE å®˜æ–¹</a>
          </div>

          <div class="hr"></div>

          <div class="smallText">
            RPC æ¨¡å¼ï¼šå…¬é–‹ RPC è®€éˆï¼ˆä¸éœ€è¦éŒ¢åŒ…ï¼‰ã€‚<br/>
            é€£éŒ¢åŒ…åªåœ¨æœªä¾†ã€Œä¸€éµé»ç« / ä¸€éµå‘¼å¸ã€æ‰éœ€è¦ï¼›æœ¬ç‰ˆå…ˆæŠŠè®€éˆç©©å®šåšå¥½ã€‚
          </div>
        </div>

        <div class="grid">
          <div class="card">
            <div class="k">ç•¶å‰ç¯€å¾‹ï¼ˆæœ¬æ©Ÿï¼‰</div>
            <div class="v mono" id="clock">--:--:--</div>
            <div class="t">
              <span class="btn small" id="pingBtn">ğŸ”” å¿ƒè·³æ‰“é»</span>
              <span class="btn small" id="resetBtn">â™»ï¸ é‡ç½®çµ±è¨ˆ</span>
            </div>
          </div>

          <div class="card">
            <div class="k">éˆä¸Šé€£ç·š</div>
            <div class="v" style="font-size:14px;font-weight:900;" id="rpcStatus">å°šæœªæª¢æ¸¬</div>
            <div class="t">
              <span class="badge">CHAIN: <b class="mono" id="chainId">--</b></span>
              <span class="badge">BLOCK: <b class="mono" id="blockNum">--</b></span>
            </div>
          </div>

          <div class="card">
            <div class="k">å…¨åŸŸé»ç«ï¼ˆMultiâ€‘Heartï¼‰</div>
            <div class="v" style="font-size:14px;font-weight:900;" id="globalIgniteStatus">å°šæœªè®€å–</div>
            <div class="t">
              <span class="badge">HEARTS: <b class="mono" id="heartCount">0</b></span>
              <span class="badge">IN WINDOW: <b class="mono" id="inWindowCount">0</b></span>
              <span class="badge">IGNITED TODAY: <b class="mono" id="ignitedCount">0</b></span>
            </div>
            <div class="smallText" style="margin-top:10px;">
              <span class="mono" id="globalIgniteHint">â€”</span>
            </div>

          <div class="card">
            <div class="k">å³æ™‚ç©å®¶è§¸ç™¼æ¨¡å¼</div>
            <div class="v" style="font-size:14px;font-weight:900;" id="playerStatus">ç­‰å¾…ç©å®¶å•Ÿå‹•</div>
            <div class="t">
              <span class="btn small" id="btnWallet">ğŸª é€£æ¥éŒ¢åŒ…</span>
              <span class="btn small" id="btnLiveTick">âš¡ è§¸ç™¼è¡Œæƒ…</span>
              <a class="btn small" id="btnGoWish" href="./temples/16888/index.html">ğŸŒ™ é€²å…¥ä»™å¥³é§•é§›è‰™</a>
            </div>
            <div class="smallText" style="margin-top:10px;">
              Wallet: <span class="mono" id="walletAddr">æœªé€£ç·š</span><br/>
              CT: <span class="mono" id="ctPrice">--</span> ï½œTick: <span class="mono" id="ctTick">0</span> ï½œç©å®¶: <span class="mono" id="ctPlayers">0</span>
            </div>
            <div class="smallText" style="margin-top:8px;">
              å®¢æœæç¤ºï¼šæœªå®‰è£éŒ¢åŒ…ä¹Ÿå¯ä»¥å…ˆé€›åœ°åœ–ï¼›è¦ä¸‹å–®ç©ï¼Œè«‹å…ˆè£ MetaMask ä¸¦åˆ‡åˆ° BNB Chainã€‚
            </div>
          </div>


          </div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <div style="font-weight:950;letter-spacing:.35px;">å…¨åŸŸé»ç«æ¸…å–®ï¼ˆHeart ç‹€æ…‹ï¼‰</div>
        <div class="badge" id="igniteTableStatus">åµæ¸¬ä¸­â€¦</div>
      </div>
      <div class="smallText" style="margin-top:8px;">
        é¡¯ç¤ºæ¯å€‹ Heartï¼šè¡€é‡ï¼ˆKGENï¼‰ã€æ˜¯å¦åœ¨é»ç«çª—å£ã€ä»Šæ—¥æ˜¯å¦é»ç«ã€‚
      </div>
      <div style="margin-top:12px; overflow:auto;">
        <table class="table" style="min-width:720px">
          <thead>
            <tr>
              <td class="kTag">åº§æ¨™</td>
              <td class="kTag">åœ°å€</td>
              <td class="kTag">è¡€é‡ï¼ˆKGENï¼‰</td>
              <td class="kTag">çª—å£</td>
              <td class="kTag">ä»Šæ—¥é»ç«</td>
            </tr>
          </thead>
          <tbody id="igniteRows">
            <tr><td colspan="5">â€”</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="card" style="margin-top:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <div style="font-weight:950;letter-spacing:.35px;">11520ï½œèŠ±æœå±±å°ç£ãƒ»æ‚Ÿç©ºå¤§è…¦äº¤æ˜“æ‰€ï¼ˆBrainExchangeï¼‰</div>
        <div class="badge" id="brainStatusBadge">å°šæœªè®€å–</div>
      </div>

      <div class="smallText" style="margin-top:8px;">
        è…¦å®¹é‡é¡¯ç¤ºå›ºå®š <span class="mono">50,000,000 KGEN</span>ï¼ˆæ‚Ÿç©ºè…¦å®¹é‡ï¼‰ã€‚
      </div>

      <div style="display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:12px; margin-top:12px;">
        <div class="card" style="min-height:auto;">
          <div class="k">Brain åœ°å€</div>
          <div class="v" style="font-size:13px;" id="brainAddr">æœªè¨­å®š</div>
          <div class="smallText" style="margin-top:8px;">åº§æ¨™ï¼š<span class="mono">11520</span></div>
        </div>

        <div class="card" style="min-height:auto;">
          <div class="k">è…¦å…§ KGENï¼ˆé¤˜é¡ï¼‰</div>
          <div class="v mono" id="brainBal">--</div>
          <div class="smallText" style="margin-top:8px;">è®€å–ï¼š<span class="mono">KGEN.balanceOf(Brain)</span></div>
        </div>

        <div class="card" style="min-height:auto;">
          <div class="k">å®¹é‡ï¼ˆVaultCapï¼‰</div>
          <div class="v mono" id="brainCap">50,000,000</div>
          <div class="smallText" style="margin-top:8px;">å¡«å……ç‡ï¼š<span class="mono" id="brainFill">--</span></div>
        </div>
      </div>

      <div class="smallText" style="margin-top:12px;">
        Brain å°šæœªéƒ¨ç½²æ™‚ï¼Œé€™å€é¡¯ç¤ºã€Œæœªéƒ¨ç½²ã€ï¼Œä¸å½±éŸ¿ Portal å…¶ä»–åŠŸèƒ½ã€‚
      </div>
    </section>

    <section class="card" style="margin-top:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <div style="font-weight:950;letter-spacing:.35px;">æ™‚å…‰éš§é“ï½œå®‡å®™å…¥å£åˆ—è¡¨</div>
        <div class="badge warn" id="nodesStatus">åµæ¸¬ä¸­â€¦</div>
      </div>
      <div class="smallText" style="margin-top:8px;">
        12345 æœƒç”¨ <span class="mono">fetch</span> åµæ¸¬æ˜¯å¦å­˜åœ¨ index.htmlï¼›å…¶ä»–æ®¿ç›®å‰å…ˆç”¨ã€Œåœ°å€æ˜¯å¦å·²å¡«ã€é¡¯ç¤ºç‹€æ…‹ã€‚
      </div>

      <div id="nodesGrid" style="margin-top:12px; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px;"></div>
    </section>

    <section class="map" id="map">
      <div class="mapHead">
        <div>
          <div class="h">å®‡å®™ç¯€é»å°èˆª</div>
          <div class="s">æ¯å€‹æ®¿å„è‡ª index.htmlï¼›å…¥å£åªåšå°èˆªï¼‹è®€éˆç‹€æ…‹</div>
        </div>
        <div class="s mono" id="pathHint">/Kç·šè¥¿éŠè¨˜/index.html</div>
      </div>

      <div class="nodes">

        <a class="node" href="./temples/12345/index.html" data-node="12345" id="nodeLink12345">
          <div class="n">äº”æŒ‡å±±ãƒ»æ‚Ÿç©ºè²¡ç¥æ®¿</div>
          <div class="id">12345</div>
          <div class="p">Heart / ç™¼è²¡é‡‘ / å‘¼å¸å¿ƒè·³ / é‚„é¡˜ / è¨±é¡˜ / å…‰æ˜ç‡ˆ / å½±åƒè‡ªçœ‹</div>
          <div class="p mono" id="node12345Hint">Heart æœªè¨­å®š</div>
        </a>

        <a class="node" href="javascript:void(0)" data-node="11520" id="nodeLink11520">
          <div class="n">èŠ±æœå±±å°ç£ãƒ»æ‚Ÿç©ºå¤§è…¦äº¤æ˜“æ‰€</div>
          <div class="id">11520</div>
          <div class="p">Reward 0.05% ç¨…æµ / ä¿è­‰é‡‘æ±  / æœˆçµç®—</div>
          <div class="p mono" id="node11520Hint">Brain æœªè¨­å®š</div>
        </a>

        <a class="node" href="javascript:void(0)" data-node="16888" id="nodeLink16888">
          <div class="n">å»£å¯’å®®ãƒ»ä¸ƒä»™å¥³è¨±é¡˜æ± </div>
          <div class="id">16888</div>
          <div class="p">è¨±é¡˜ / é»ç‡ˆå½±åƒç•™è¨€ / ä¸ƒä»™å¥³åˆ†æ½¤</div>
          <div class="p mono" id="node16888Hint">æœªéƒ¨ç½²</div>
        </a>

        <a class="node" href="javascript:void(0)" data-node="18888" id="nodeLink18888">
          <div class="n">éˆéœ„å¯¶æ®¿ãƒ»ç‰å¸é‡‘åº«</div>
          <div class="id">18888</div>
          <div class="p">Deity Bank / 0.1% ç¨…æ”¶æ¥æ”¶</div>
          <div class="p mono" id="node18888Hint">æœªéƒ¨ç½²</div>
        </a>

        <a class="node" href="javascript:void(0)" data-node="18921" id="nodeLink18921">
          <div class="n">æ–¬å¦–å°ãƒ»AutoLP/åˆ†æµå¼•æ“</div>
          <div class="id">18921</div>
          <div class="p">0.05% AutoLP ç¨… / åˆ†æµå¼•æ“</div>
          <div class="p mono" id="node18921Hint">æœªéƒ¨ç½²</div>
        </a>

        <a class="node" href="javascript:void(0)" data-node="108000" id="nodeLink108000">
          <div class="n">èŠ±æœå±±ç«æ˜Ÿï¼ˆMARSï¼‰</div>
          <div class="id">108000</div>
          <div class="p">è±ªå®… 500 å¸­ / 5000 KGEN å…¥ä½ / æœˆåˆ†æ½¤è‡ªé ˜</div>
          <div class="p mono" id="node108000Hint">æœªéƒ¨ç½²</div>
        </a>

      </div>

      <div class="footer">
        Portal V1.6ï¼šMultiâ€‘Heart å…¨åŸŸé»ç« + 11520 Brainï¼ˆè…¦å®¹é‡ 5000è¬ï¼‰å·²åŠ ä¸Šã€‚<br/>
        16888 å»£å¯’å®®å…ˆç´å…¥åº§æ¨™èˆ‡å…¥å£ï¼ˆå¾…ä½ éƒ¨ç½²è¨±é¡˜æ± åˆç´„å¾Œå†é»äº®ï¼‰ã€‚<br/>
      </div>
    </section>

    <div class="footer" style="margin-top:14px;">
      PrimeForge ä»¥æ¯æ©Ÿä¹‹åï¼Œé–‹å•Ÿé‡‘èç”Ÿå‘½ã€‚<br/>
      èŠ±æœå±±å°ç£ãƒ»ä¿¡å¿µä¸æ»…ãƒ»å¸‚å ´ç„¡ç•Œã€‚<br/>
      Where the Market Becomes the Myth.<br/>
      â€”â€” æ¨‚å¤©å¸ âŒ–
    </div>
  </div>

<script>
const LS_KEY = "KLINE_PORTAL_V1_4_CFG";
const DEFAULT_CFG = {
  chain: {
    name: "BSC",
    chainIdExpected: 56,
    rpcUrls: [
      "https://bsc-dataseed.binance.org/",
      "https://bsc-dataseed1.binance.org/",
      "https://bsc-dataseed2.binance.org/"
    ]
  },
  addresses: {
    kgenToken: "0xBA3d3810e58735cb6813bC1CDc5458C0d71432Be",
    hearts: [
      { id: "12345", addr: "0x0000000000000000000000000000000000000000" }
    ],
    brain11520: "0x0000000000000000000000000000000000000000",
    wish16888: "0x0000000000000000000000000000000000000000",
    bank18888: "0x0000000000000000000000000000000000000000",
    zhanyao18921: "0x0000000000000000000000000000000000000000",
    mars108000: "0x0000000000000000000000000000000000000000",
    fairies7: []
  },
  brain: { capWhole: 50000000 }
};
function loadCfg(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return structuredClone(DEFAULT_CFG);
    const parsed = JSON.parse(raw);
    const cfg = structuredClone(DEFAULT_CFG);
    cfg.chain = Object.assign({}, cfg.chain, parsed.chain || {});
    cfg.addresses = Object.assign({}, cfg.addresses, parsed.addresses || {});
    if(Array.isArray(parsed.addresses?.hearts)) cfg.addresses.hearts = parsed.addresses.hearts;
    if(Array.isArray(parsed.addresses?.fairies7)) cfg.addresses.fairies7 = parsed.addresses.fairies7;
    cfg.brain = Object.assign({}, cfg.brain, parsed.brain || {});
    return cfg;
  }catch(e){
    return structuredClone(DEFAULT_CFG);
  }
}
function saveCfg(cfg){ localStorage.setItem(LS_KEY, JSON.stringify(cfg)); }
function $(id){ return document.getElementById(id); }
function setText(id, v){ $(id).textContent = v; }
function fmtNum(n){ try{ return new Intl.NumberFormat("en-US").format(n); }catch(e){ return String(n); } }
function shortAddr(a){ if(!a||a.length<10) return a||""; return a.slice(0,6)+"â€¦"+a.slice(-4); }
function isZeroAddr(a){ return !a || a.toLowerCase()==="0x0000000000000000000000000000000000000000"; }
function isAddr(a){ try{ return ethers.utils.isAddress(a); }catch(e){ return false; } }
function badgeSet(el, kind, text){
  el.className = "badge " + (kind==="ok"?"ok":kind==="warn"?"warn":"bad");
  el.textContent = text;
}
let __errors = [];
window.addEventListener("error", (e)=>{ __errors.push(String(e.message||e.error||e)); });
window.addEventListener("unhandledrejection", (e)=>{ __errors.push(String(e.reason||e)); });

function startStars(){
  const c = document.getElementById("stars");
  const ctx = c.getContext("2d");
  const resize = ()=>{
    const dpr = Math.min(2, window.devicePixelRatio||1);
    c.width = Math.floor(c.clientWidth*dpr);
    c.height = Math.floor(c.clientHeight*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  };
  const rand = (a,b)=> a + Math.random()*(b-a);
  let stars = [];
  const init = ()=>{
    const w = c.clientWidth, h=c.clientHeight;
    stars = Array.from({length: 120}, ()=>({x:rand(0,w), y:rand(0,h), r:rand(.3,1.4), v:rand(.08,.32)}));
  };
  const loop = ()=>{
    const w = c.clientWidth, h=c.clientHeight;
    ctx.clearRect(0,0,w,h);
    ctx.globalAlpha = .9;
    for(const s of stars){
      s.y += s.v;
      if(s.y > h+10){ s.y=-10; s.x=rand(0,w); }
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
      ctx.fillStyle = "rgba(255,255,255,.85)";
      ctx.fill();
    }
    requestAnimationFrame(loop);
  };
  resize(); init(); loop();
  window.addEventListener("resize", ()=>{ resize(); init(); });
}

async function makeProvider(cfg){
  if(!window.ethers) throw new Error("ethers not loaded. Put ethers-5.7.2.umd.min.js into /Kç·šè¥¿éŠè¨˜/assets/");
  let lastErr = null;
  for(const url of cfg.chain.rpcUrls){
    try{
      const p = new ethers.providers.JsonRpcProvider(url);
      await p.getBlockNumber();
      return p;
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error("No RPC works");
}

const ERC20_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)"
];
const HEART_ABI = [
  "function token() view returns (address)",
  "function windowStartSec() view returns (uint32)",
  "function windowEndSec() view returns (uint32)",
  "function inIgniteWindow() view returns (bool)",
  "function localDayIdNow() view returns (uint256)",
  "function dayIgnited(uint256) view returns (bool)",
  "function igniteReward() view returns (uint256)",
  "function heartbeatReward() view returns (uint256)"
];

function initCounters(){
  const kToday = "KLINE_PORTAL_TODAY_" + new Date().toISOString().slice(0,10);
  const kTotal = "KLINE_PORTAL_TOTAL";
  const today = Number(localStorage.getItem(kToday)||"0") + 1;
  localStorage.setItem(kToday, String(today));
  const total = Number(localStorage.getItem(kTotal)||"0") + 1;
  localStorage.setItem(kTotal, String(total));
  setText("today", String(today));
  setText("total", String(total));
  $("resetBtn").onclick = ()=>{
    localStorage.removeItem(kToday);
    localStorage.removeItem(kTotal);
    setText("today", "0");
    setText("total", "0");
  };
  $("pingBtn").onclick = ()=>{
    try{ navigator.vibrate?.(30); }catch(e){}
    const now = new Date();
    setText("clock", now.toLocaleTimeString());
  };
}
function startClock(){
  const tick = ()=>{
    const now = new Date();
    setText("clock", now.toLocaleTimeString());
    setText("nowClock", now.toLocaleTimeString());
  };
  tick();
  setInterval(tick, 1000);
}

async function detectNodeFile(path){
  try{
    const res = await fetch(path, { method:"GET", cache:"no-store" });
    return res.ok;
  }catch(e){ return false; }
}
function nodeCardHTML(n){
  return `
    <div class="card" style="min-height:auto;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div>
          <div style="font-weight:950;letter-spacing:.35px;">${n.name}</div>
          <div class="smallText" style="margin-top:6px;">${n.desc}</div>
        </div>
        <div class="badge" id="nodeStatus_${n.id}">åµæ¸¬ä¸­â€¦</div>
      </div>
      <div class="smallText" style="margin-top:10px;">åº§æ¨™ï¼š<span class="mono">${n.id}</span></div>
      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn small" href="${n.href}" ${n.href.startsWith("http")?'target="_blank" rel="noreferrer"':''}>é–‹å•Ÿ</a>
        <span class="badge" id="nodeHint_${n.id}">â€”</span>
      </div>
    </div>
  `;
}

async function refreshChain(provider, cfg){
  const net = await provider.getNetwork();
  setText("chainId", String(net.chainId));
  const bn = await provider.getBlockNumber();
  setText("blockNum", String(bn));
  $("rpcStatus").textContent = (net.chainId === cfg.chain.chainIdExpected) ? "RPC OKï¼ˆè®€éˆæ­£å¸¸ï¼‰" : `RPC OKï¼ˆchainId=${net.chainId}ï¼‰`;
}

async function readTokenMeta(provider, tokenAddr){
  const token = new ethers.Contract(tokenAddr, ERC20_ABI, provider);
  const [dec, sym] = await Promise.all([
    token.decimals().catch(()=>18),
    token.symbol().catch(()=> "KGEN"),
  ]);
  return { token, dec, sym };
}
function hhmm(sec){
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
}

async function refreshGlobalIgnite(provider, cfg){
  const hearts = Array.isArray(cfg.addresses.hearts) ? cfg.addresses.hearts : [];
  setText("heartCount", String(hearts.length));
  $("igniteRows").innerHTML = "";

  if(!hearts.length){
    $("igniteTableStatus").textContent = "æ²’æœ‰ Heartï¼ˆè«‹åœ¨è¨­å®šåŠ å…¥ï¼‰";
    $("globalIgniteStatus").textContent = "æ²’æœ‰ Heart";
    $("globalIgniteHint").textContent = "è«‹æŒ‰å³ä¸Šè§’ã€è¨­å®šã€‘åŠ å…¥ Heart åœ°å€ã€‚";
    return { ok:false, inWindow:0, ignited:0, total:0 };
  }

  const tokenAddr = cfg.addresses.kgenToken;
  if(!isAddr(tokenAddr) || isZeroAddr(tokenAddr)){
    $("igniteTableStatus").textContent = "KGEN æœªè¨­å®š";
    $("globalIgniteStatus").textContent = "KGEN æœªè¨­å®š";
    $("globalIgniteHint").textContent = "è«‹åœ¨è¨­å®šå¡« KGEN Token åœ°å€ã€‚";
    return { ok:false, inWindow:0, ignited:0, total:hearts.length };
  }

  const meta = await readTokenMeta(provider, tokenAddr);

  let inWin = 0, ignited = 0, okCount = 0;

  for(const h of hearts){
    const id = String(h.id || "").trim() || "????";
    const addr = String(h.addr || "").trim();
    const tr = document.createElement("tr");

    if(!isAddr(addr) || isZeroAddr(addr)){
      tr.innerHTML = `
        <td>${id}</td>
        <td class="mono">${addr ? shortAddr(addr) : "æœªè¨­å®š"}</td>
        <td>--</td>
        <td class="warnText">æœªéƒ¨ç½²/æœªè¨­å®š</td>
        <td class="warnText">--</td>
      `;
      $("igniteRows").appendChild(tr);
      continue;
    }

    try{
      const heartC = new ethers.Contract(addr, HEART_ABI, provider);
      const [bal, ws, we, inWindow, dayId] = await Promise.all([
        meta.token.balanceOf(addr).catch(()=> ethers.BigNumber.from(0)),
        heartC.windowStartSec(),
        heartC.windowEndSec(),
        heartC.inIgniteWindow(),
        heartC.localDayIdNow()
      ]);
      const ign = await heartC.dayIgnited(dayId).catch(()=>false);

      const balFmt = Number(ethers.utils.formatUnits(bal, meta.dec));
      const balTxt = Number.isFinite(balFmt) ? fmtNum(balFmt.toFixed(2)) : "--";

      if(inWindow) inWin++;
      if(ign) ignited++;
      okCount++;

      tr.innerHTML = `
        <td>${id}</td>
        <td class="mono" title="${addr}">${shortAddr(addr)}</td>
        <td class="mono">${balTxt}</td>
        <td class="${inWindow ? "okText" : "warnText"}">${hhmm(ws)}â€“${hhmm(we)} ${inWindow ? "(IN)" : ""}</td>
        <td class="${ign ? "okText" : "warnText"}">${ign ? "YES" : "NO"}</td>
      `;
      $("igniteRows").appendChild(tr);

    }catch(e){
      tr.innerHTML = `
        <td>${id}</td>
        <td class="mono" title="${addr}">${shortAddr(addr)}</td>
        <td>--</td>
        <td class="warnText">è®€å–å¤±æ•—</td>
        <td class="warnText">--</td>
      `;
      $("igniteRows").appendChild(tr);
    }
  }

  setText("inWindowCount", String(inWin));
  setText("ignitedCount", String(ignited));

  if(okCount > 0){
    $("igniteTableStatus").textContent = "è®€å–å®Œæˆ";
    $("globalIgniteStatus").textContent = `OKï¼ˆ${okCount}/${hearts.length} å¯è®€ï¼‰`;
    $("globalIgniteHint").textContent = `å¤šæ®¿å…¨åŸŸç›£çœ‹ï¼šå…± ${hearts.length} æ®¿ã€‚`;
  }else{
    $("igniteTableStatus").textContent = "æœªå¯è®€ï¼ˆåœ°å€æœªè¨­å®šæˆ–æœªéƒ¨ç½²ï¼‰";
    $("globalIgniteStatus").textContent = "æœªå¯è®€";
    $("globalIgniteHint").textContent = "è«‹åœ¨è¨­å®šå¡«å…¥ Heart åˆç´„åœ°å€ã€‚";
  }
  return { ok: okCount>0, inWindow: inWin, ignited: ignited, total: hearts.length };
}

async function refreshBrain(provider, cfg){
  const brain = String(cfg.addresses.brain11520||"").trim();
  setText("brainAddr", brain && !isZeroAddr(brain) ? brain : "æœªè¨­å®š");
  setText("node11520Hint", brain && !isZeroAddr(brain) ? `Brain: ${shortAddr(brain)}` : "Brain æœªè¨­å®š");

  const cap = Number(cfg.brain?.capWhole || 50000000);
  setText("brainCap", fmtNum(cap));

  if(!isAddr(brain) || isZeroAddr(brain)){
    badgeSet($("brainStatusBadge"), "warn", "æœªéƒ¨ç½²/æœªè¨­å®š");
    setText("brainBal", "--");
    setText("brainFill", "--");
    return false;
  }

  const tokenAddr = String(cfg.addresses.kgenToken||"").trim();
  if(!isAddr(tokenAddr) || isZeroAddr(tokenAddr)){
    badgeSet($("brainStatusBadge"), "warn", "KGEN æœªè¨­å®š");
    setText("brainBal", "--");
    setText("brainFill", "--");
    return false;
  }

  try{
    const meta = await readTokenMeta(provider, tokenAddr);
    const bal = await meta.token.balanceOf(brain);
    const balFmt = Number(ethers.utils.formatUnits(bal, meta.dec));
    const balTxt = Number.isFinite(balFmt) ? fmtNum(balFmt.toFixed(2)) : "--";
    setText("brainBal", balTxt);

    const fill = (Number.isFinite(balFmt) && cap>0) ? (balFmt / cap * 100) : NaN;
    setText("brainFill", Number.isFinite(fill) ? (fill.toFixed(2) + "%") : "--");

    badgeSet($("brainStatusBadge"), "ok", "è®€å–å®Œæˆ");
    return true;
  }catch(e){
    badgeSet($("brainStatusBadge"), "warn", "è®€å–å¤±æ•—");
    setText("brainBal", "--");
    setText("brainFill", "--");
    return false;
  }
}

function applyNodeHints(cfg){
  const a = cfg.addresses;
  const heart0 = (a.hearts||[]).find(x=>String(x.id||"")==="12345");
  setText("node12345Hint", (heart0?.addr && !isZeroAddr(heart0.addr) && isAddr(heart0.addr)) ? `Heart: ${shortAddr(heart0.addr)}` : "Heart æœªè¨­å®š");
  setText("node16888Hint", (!isZeroAddr(a.wish16888) && isAddr(a.wish16888)) ? `Wish: ${shortAddr(a.wish16888)}` : `æœªéƒ¨ç½²ï¼ˆä»™å¥³ ${String((a.fairies7||[]).length)}/7ï¼‰`);
  setText("node18888Hint", (!isZeroAddr(a.bank18888) && isAddr(a.bank18888)) ? `Bank: ${shortAddr(a.bank18888)}` : "æœªéƒ¨ç½²");
  setText("node18921Hint", (!isZeroAddr(a.zhanyao18921) && isAddr(a.zhanyao18921)) ? `Zhanyao: ${shortAddr(a.zhanyao18921)}` : "æœªéƒ¨ç½²");
  setText("node108000Hint", (!isZeroAddr(a.mars108000) && isAddr(a.mars108000)) ? `Mars: ${shortAddr(a.mars108000)}` : "æœªéƒ¨ç½²");
}

function cfgToTextHearts(hearts){ return (hearts||[]).map(h=>`${String(h.id||"").trim()},${String(h.addr||"").trim()}`).join("\n"); }
function textToHearts(text){
  const lines = String(text||"").split("\n").map(s=>s.trim()).filter(Boolean);
  const out = [];
  for(const line of lines){
    const parts = line.split(",").map(s=>s.trim()).filter(Boolean);
    if(parts.length<2) continue;
    out.push({ id: parts[0], addr: parts[1] });
  }
  return out;
}
function openDrawer(){ $("drawerScrim").classList.add("on"); $("drawer").classList.add("on"); }
function closeDrawer(){ $("drawerScrim").classList.remove("on"); $("drawer").classList.remove("on"); }
function renderDrawer(cfg){
  $("inKgenToken").value = cfg.addresses.kgenToken || "";
  $("inHearts").value = cfgToTextHearts(cfg.addresses.hearts||[]);
  $("inBrain11520").value = cfg.addresses.brain11520 || "";
  $("inMars108000").value = cfg.addresses.mars108000 || "";
  $("inBank18888").value = cfg.addresses.bank18888 || "";
  $("inZhanyao18921").value = cfg.addresses.zhanyao18921 || "";
  $("inWish16888").value = cfg.addresses.wish16888 || "";
  $("inFairies7").value = (cfg.addresses.fairies7||[]).join("\n");
}
function readDrawerToCfg(cfg){
  const next = structuredClone(cfg);
  const kgen = $("inKgenToken").value.trim();
  const heartsText = $("inHearts").value;
  const brain = $("inBrain11520").value.trim();
  const mars = $("inMars108000").value.trim();
  const bank = $("inBank18888").value.trim();
  const zh = $("inZhanyao18921").value.trim();
  const wish = $("inWish16888").value.trim();
  const fairiesText = $("inFairies7").value;

  if(kgen) next.addresses.kgenToken = kgen;
  const hearts = textToHearts(heartsText);
  if(hearts.length) next.addresses.hearts = hearts;
  if(brain) next.addresses.brain11520 = brain;
  if(mars) next.addresses.mars108000 = mars;
  if(bank) next.addresses.bank18888 = bank;
  if(zh) next.addresses.zhanyao18921 = zh;
  if(wish) next.addresses.wish16888 = wish;

  const fairies = String(fairiesText||"").split("\n").map(s=>s.trim()).filter(Boolean);
  next.addresses.fairies7 = fairies.slice(0,7);
  return next;
}

function setDot(id, state){
  const el = $(id);
  el.classList.remove("ok","warn","bad");
  el.classList.add(state);
}
function setProgress(pct){
  setText("supPct", pct + "%");
  $("supFill").style.width = pct + "%";
}
function openSupervisor(){ $("supervisorOverlay").classList.add("on"); }
function closeSupervisor(){ $("supervisorOverlay").classList.remove("on"); }
function runSupervisor(result){
  setDot("chkLoaded", result.loaded ? "ok" : "bad");
  setDot("chkStars", result.stars ? "ok" : "warn");
  setDot("chkNodes", result.nodes ? "ok" : "warn");
  setDot("chkGlobalIgnite", result.globalIgnite ? "ok" : "warn");
  setDot("chkBrainPanel", result.brain ? "ok" : "warn");
  setDot("chkErrors", result.errors ? "ok" : "warn");
  const score = [result.loaded,result.stars,result.nodes,result.globalIgnite,result.brain,result.errors].filter(Boolean).length;
  setProgress(Math.round(score/6*100));
}

(async function main(){
  initCounters();
  startClock();
  startStars();

  $("btnSupervisor").onclick = ()=> openSupervisor();
  $("supClose").onclick = ()=> closeSupervisor();
  $("supervisorOverlay").onclick = (e)=>{ if(e.target === $("supervisorOverlay")) closeSupervisor(); };

  $("btnSettings").onclick = ()=>{
    const cfg = loadCfg();
    renderDrawer(cfg);
    openDrawer();
  };
  $("btnCloseDrawer").onclick = closeDrawer;
  $("drawerScrim").onclick = closeDrawer;

  $("btnSaveCfg").onclick = ()=>{
    const cfg = loadCfg();
    const next = readDrawerToCfg(cfg);
    saveCfg(next);
    renderDrawer(next);
    alert("å·²å„²å­˜è¨­å®š");
  };
  $("btnResetCfg").onclick = ()=>{
    localStorage.removeItem(LS_KEY);
    renderDrawer(loadCfg());
    alert("å·²é‡ç½®");
  };
  $("btnApplyAndRefresh").onclick = async ()=>{
    const cfg = loadCfg();
    const next = readDrawerToCfg(cfg);
    saveCfg(next);
    closeDrawer();
    await boot();
  };

  await boot();
})();

async function boot(){
  const cfg = loadCfg();
  setText("kgenAddrTop", shortAddr(cfg.addresses.kgenToken));
  applyNodeHints(cfg);

  let provider=null, chainOk=false;
  try{
    provider = await makeProvider(cfg);
    await refreshChain(provider, cfg);
    chainOk=true;
  }catch(e){
    $("rpcStatus").textContent = "RPC å¤±æ•—ï¼ˆç„¡æ³•è®€éˆï¼‰";
  }

  const nodes = [
    { id:"12345", name:"äº”æŒ‡å±±ãƒ»æ‚Ÿç©ºè²¡ç¥æ®¿", desc:"å·²ä¸Šç·šï¼štemples/12345/index.html", href:"./temples/12345/index.html", detect:"./temples/12345/index.html" },
    { id:"11520", name:"èŠ±æœå±±å°ç£ãƒ»æ‚Ÿç©ºå¤§è…¦äº¤æ˜“æ‰€", desc:"åˆç´„å¾…éƒ¨ç½²ï¼›å…¥å£é å¾…æ–½å·¥ï¼ˆæœ¬ Portal å·²æœ‰è®€éˆé¢æ¿ï¼‰", href:"javascript:void(0)", detect:null },
    { id:"16888", name:"å»£å¯’å®®ãƒ»ä¸ƒä»™å¥³è¨±é¡˜æ± ", desc:"åº§æ¨™å·²é ç•™ï¼›è¨±é¡˜æ± åˆç´„å¾…éƒ¨ç½²", href:"javascript:void(0)", detect:null },
    { id:"18888", name:"éˆéœ„å¯¶æ®¿ãƒ»ç‰å¸é‡‘åº«", desc:"DeityBank åˆç´„å¾…éƒ¨ç½²", href:"javascript:void(0)", detect:null },
    { id:"18921", name:"æ–¬å¦–å°ãƒ»åˆ†æµå¼•æ“", desc:"TaxSplitter åˆç´„å¾…éƒ¨ç½²", href:"javascript:void(0)", detect:null },
    { id:"108000", name:"èŠ±æœå±±ç«æ˜Ÿï¼ˆMARSï¼‰", desc:"ä½ å·²æœ‰ Mars Seats UIï¼ˆå¦æª”ï¼‰", href:"javascript:void(0)", detect:null },
  ];
  $("nodesGrid").innerHTML = nodes.map(nodeCardHTML).join("");

  let nodeOkAny=false;
  for(const n of nodes){
    const badge = $("nodeStatus_"+n.id);
    const hint = $("nodeHint_"+n.id);

    if(n.id==="11520"){
      const a = cfg.addresses.brain11520;
      hint.textContent = (!isZeroAddr(a) && isAddr(a)) ? ("Brain: "+shortAddr(a)) : "æœªéƒ¨ç½²";
    }else if(n.id==="16888"){
      const a = cfg.addresses.wish16888;
      hint.textContent = (!isZeroAddr(a) && isAddr(a)) ? ("Wish: "+shortAddr(a)) : ("ä»™å¥³ "+String((cfg.addresses.fairies7||[]).length)+"/7");
    }else if(n.id==="18888"){
      const a = cfg.addresses.bank18888;
      hint.textContent = (!isZeroAddr(a) && isAddr(a)) ? ("Bank: "+shortAddr(a)) : "æœªéƒ¨ç½²";
    }else if(n.id==="18921"){
      const a = cfg.addresses.zhanyao18921;
      hint.textContent = (!isZeroAddr(a) && isAddr(a)) ? ("Zhanyao: "+shortAddr(a)) : "æœªéƒ¨ç½²";
    }else if(n.id==="108000"){
      const a = cfg.addresses.mars108000;
      hint.textContent = (!isZeroAddr(a) && isAddr(a)) ? ("Mars: "+shortAddr(a)) : "æœªéƒ¨ç½²";
    }else{
      hint.textContent = "â€”";
    }

    if(n.detect){
      const ok = await detectNodeFile(n.detect);
      if(ok){ badgeSet(badge,"ok","å·²å®Œå·¥"); nodeOkAny=true; }
      else { badgeSet(badge,"warn","æ–½å·¥æº–å‚™ä¸­"); }
    }else{
      badgeSet(badge,"warn","å¾…æ–½å·¥");
    }
  }
  badgeSet($("nodesStatus"), nodeOkAny ? "ok" : "warn", nodeOkAny ? "éƒ¨åˆ†å®Œå·¥" : "åµæ¸¬å®Œæˆ");

  let globalIgniteOk=false, brainOk=false;
  if(chainOk && provider){
    try{ globalIgniteOk = (await refreshGlobalIgnite(provider, cfg)).ok; }catch(e){
      $("globalIgniteStatus").textContent="è®€å–å¤±æ•—";
      $("igniteTableStatus").textContent="è®€å–å¤±æ•—";
    }
    try{ brainOk = await refreshBrain(provider, cfg); }catch(e){}
  }else{
    $("globalIgniteStatus").textContent="RPC å¤±æ•—ï¼ˆç„¡æ³•è®€éˆï¼‰";
    $("igniteTableStatus").textContent="RPC å¤±æ•—";
    badgeSet($("brainStatusBadge"),"warn","RPC å¤±æ•—");
  }

  runSupervisor({
    loaded:true, stars:true, nodes:nodeOkAny, globalIgnite:globalIgniteOk, brain:brainOk, errors:__errors.length===0
  });
}

/* =========================
   Player Trigger + Voice + Wallet (Portal V1.6)
   ========================= */

const LIVE_KEY = "KLINE_PORTAL_LIVE_V1";
const Live = {
  load(){
    try{
      const raw = localStorage.getItem(LIVE_KEY);
      if(raw) return Object.assign({tick:0, ct:16888, players:{}}, JSON.parse(raw));
    }catch(e){}
    return {tick:0, ct:16888, players:{}};
  },
  save(s){ localStorage.setItem(LIVE_KEY, JSON.stringify(s)); }
};

let web3Provider=null, signer=null, wallet="";

function canSpeak(){
  try{ return !!window.speechSynthesis && typeof SpeechSynthesisUtterance !== "undefined"; }catch(e){ return false; }
}
function speak(text){
  try{
    if(!canSpeak()) return;
    // avoid piling up
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "zh-TW";
    u.rate = 1.02;
    window.speechSynthesis.speak(u);
  }catch(e){}
}

function setPlayerStatus(t){
  const el = document.getElementById("playerStatus");
  if(el) el.textContent = t;
}
function setWalletAddr(t){
  const el = document.getElementById("walletAddr");
  if(el) el.textContent = t;
}
function updateLiveUI(){
  const s = Live.load();
  const ct = document.getElementById("ctPrice");
  const tk = document.getElementById("ctTick");
  const pl = document.getElementById("ctPlayers");
  if(ct) ct.textContent = (Number(s.ct)||0).toFixed(2);
  if(tk) tk.textContent = String(s.tick||0);
  if(pl) pl.textContent = String(Object.keys(s.players||{}).length);
}

function walletHelp(){
  const msg = "å°šæœªåµæ¸¬åˆ°éŒ¢åŒ…ã€‚è«‹å…ˆå®‰è£ MetaMaskï¼Œåˆ‡æ›åˆ° BNB Chainï¼ˆBSCï¼‰ï¼Œå†å›ä¾†é»ã€é€£æ¥éŒ¢åŒ…ã€å³å¯ä¸‹å–®ç©ã€‚";
  setPlayerStatus("æœªåµæ¸¬åˆ°éŒ¢åŒ…ï¼ˆè«‹å®‰è£ MetaMaskï¼‰");
  speak(msg);
  alert(msg);
}

async function connectWallet(){
  if(!window.ethereum) return walletHelp();
  web3Provider = new ethers.providers.Web3Provider(window.ethereum);
  await web3Provider.send("eth_requestAccounts", []);
  signer = web3Provider.getSigner();
  wallet = await signer.getAddress();
  setWalletAddr(wallet);
  setPlayerStatus("ç©å®¶å·²å•Ÿå‹•ï¼ˆéŒ¢åŒ…å·²é€£ç·šï¼‰");
  const s = Live.load();
  s.players = s.players || {};
  s.players[wallet.toLowerCase()] = Date.now();
  Live.save(s);
  updateLiveUI();
  speak("éŒ¢åŒ…å·²é€£ç·šã€‚ä½ å·²é€²å…¥å³æ™‚ç©å®¶è§¸ç™¼æ¨¡å¼ã€‚ç¾åœ¨å¯è§¸ç™¼è¡Œæƒ…ï¼Œæˆ–é€²å…¥å»£å¯’å®®ä»™å¥³é§•é§›è‰™é–‹å§‹è¨±é¡˜ã€‚");
}

function stanceFromDeg(deg){
  if(deg < 170) return "LONG";
  if(deg <= 190) return "REST";
  return "SHORT";
}

function nextCT(){
  const s = Live.load();
  const n = Object.keys(s.players||{}).length || 1;

  let deg = 180;
  try{
    const dg = document.getElementById("degRangeLabel") || document.getElementById("deg");
    if(dg && dg.textContent) deg = Number(dg.textContent.replace("Â°","")) || 180;
  }catch(e){}
  const stance = stanceFromDeg(deg);

  let bias = 0;
  if(stance === "LONG") bias = 0.35;
  else if(stance === "SHORT") bias = -0.35;

  const amp = Math.min(60, 8 + n*2);
  const rnd = (Math.random() - 0.5) * 2;
  const delta = (rnd + bias) * amp;

  s.tick = (s.tick||0) + 1;
  s.ct = Number(s.ct||16888) + delta;
  if(s.ct < 1) s.ct = 1;
  if(s.ct > 999999) s.ct = 999999;
  Live.save(s);

  return {ct:s.ct, tick:s.tick, players:n, stance};
}

function liveTick(){
  const r = nextCT();
  updateLiveUI();
  setPlayerStatus(`è¡Œæƒ…å·²è§¸ç™¼ï½œ${r.stance}ï½œCT=${r.ct.toFixed(2)}ï¼ˆTick ${r.tick}ï¼‰`);
  // keep it short
  speak(`è¡Œæƒ…æ›´æ–°ã€‚${r.stance==="LONG"?"å¤š":"ç©º"}ã€‚CT ${Math.round(r.ct)}ã€‚`);
}

document.addEventListener("DOMContentLoaded", ()=>{
  updateLiveUI();

  const btnWallet = document.getElementById("btnWallet");
  if(btnWallet) btnWallet.addEventListener("click", ()=> connectWallet().catch(e=>{
    setPlayerStatus("é€£ç·šå¤±æ•—");
    speak("éŒ¢åŒ…é€£ç·šå¤±æ•—ã€‚è«‹ç¢ºèª MetaMask å·²é–‹å•Ÿä¸¦åœ¨ BNB Chainã€‚");
    alert(e && e.message ? e.message : String(e));
  }));

  const btnLive = document.getElementById("btnLiveTick");
  if(btnLive) btnLive.addEventListener("click", ()=> liveTick());

  speak("æ­¡è¿é€²å…¥ Kç·šè¥¿éŠè¨˜éŠ€æ²³å®‡å®™å…¥å£ã€‚è«‹å…ˆé€£æ¥éŒ¢åŒ…å•Ÿå‹•ç©å®¶æ¨¡å¼ã€‚");
  setPlayerStatus("è«‹é€£æ¥éŒ¢åŒ…ï¼ˆé€²å…¥ç©å®¶è§¸ç™¼æ¨¡å¼ï¼‰");
});

</script>

</body>
</html>
