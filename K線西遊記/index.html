<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kç·šè¥¿éŠè¨˜ï½œéŠ€æ²³å®‡å®™å…¥å£ï¼ˆPortal V1.2ï¼‰</title>
  <style>
    :root{
      --bg:#06070b;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --line: rgba(255,255,255,.14);
      --btn: rgba(255,255,255,.12);
      --btnh: rgba(255,255,255,.18);
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --r: 18px;
      --r2: 999px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Heiti TC", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 800px at 30% 20%, rgba(120,170,255,.10), transparent 60%),
                  radial-gradient(1000px 700px at 70% 60%, rgba(255,160,220,.08), transparent 55%),
                  var(--bg);
      color: var(--text);
      min-height:100vh;
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 40px;}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 0 14px;}
    .brand{display:flex;flex-direction:column;gap:4px;}
    .brand .h{font-weight:900;letter-spacing:.5px;font-size:18px;}
    .brand .s{font-size:12px;color:var(--muted);}
    .pillrow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .pill{
      display:flex;gap:8px;align-items:center;
      padding:9px 12px;border:1px solid var(--line);border-radius:var(--r2);
      background:rgba(255,255,255,.05);backdrop-filter:blur(8px);box-shadow:var(--shadow);
      font-size:12px;color:var(--muted);white-space:nowrap;
    }
    .pill b{color:var(--text);font-weight:800}
    .mono{font-family:var(--mono)}
    .hero{
      position:relative;border:1px solid var(--line);border-radius:24px;
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow:var(--shadow);overflow:hidden;padding:18px;
    }
    canvas#stars{position:absolute;inset:0;width:100%;height:100%;opacity:.85;pointer-events:none;}
    .heroGrid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;}
    @media (max-width:900px){.heroGrid{grid-template-columns:1fr}}
    .title{font-size:26px;font-weight:950;letter-spacing:.8px;margin:4px 0 8px;}
    .subtitle{color:var(--muted);line-height:1.55;margin:0 0 14px;font-size:13px;}
    .ctaRow{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 14px;border-radius:var(--r2);border:1px solid var(--line);
      background:var(--btn);text-decoration:none;font-weight:850;font-size:13px;transition:.15s;user-select:none;
      cursor:pointer;
    }
    .btn:hover{background:var(--btnh)}
    .btn.small{padding:8px 12px;font-weight:800}
    .grid{display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;margin-top:14px;}
    @media (max-width:900px){.grid{grid-template-columns:1fr 1fr}}
    @media (max-width:520px){.grid{grid-template-columns:1fr}}
    .card{
      border:1px solid var(--line);border-radius:var(--r);background:var(--panel);
      box-shadow:var(--shadow);padding:14px;min-height:110px;position:relative;overflow:hidden;
    }
    .card .k{font-size:12px;color:var(--muted);margin-bottom:6px;letter-spacing:.2px}
    .card .v{font-size:18px;font-weight:950;letter-spacing:.6px}
    .card .t{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .smallText{font-size:12px;color:var(--muted);line-height:1.35}
    .map{
      margin-top:14px;border:1px solid var(--line);border-radius:24px;background:rgba(0,0,0,.20);
      box-shadow:var(--shadow);padding:16px;position:relative;overflow:hidden;
    }
    .mapHead{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .mapHead .h{font-weight:950;letter-spacing:.6px;font-size:16px;}
    .mapHead .s{color:var(--muted);font-size:12px;}
    .nodes{display:grid;grid-template-columns:repeat(4, 1fr);gap:10px;margin-top:10px;}
    @media (max-width:900px){.nodes{grid-template-columns:repeat(2, 1fr)}}
    @media (max-width:520px){.nodes{grid-template-columns:1fr}}
    .node{
      border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.06);
      padding:12px;text-decoration:none;display:flex;flex-direction:column;gap:6px;transition:.15s;min-height:110px;
    }
    .node:hover{background:rgba(255,255,255,.10)}
    .node .n{font-weight:950;letter-spacing:.5px}
    .node .p{color:var(--muted);font-size:12px;line-height:1.35}
    .node .id{color:rgba(255,255,255,.75);font-size:12px;font-family:var(--mono)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.18);font-size:12px;color:var(--muted)}
    .ok{color:#9fffd9}
    .warn{color:#ffd28c}
    .err{color:#ff9fb2}

    .footer{color:var(--muted);font-size:12px;margin-top:14px;line-height:1.55;padding-bottom:6px;}
    .hr{height:1px;background:var(--line);margin:10px 0}
  </style>

  <!-- Ethers v5.7.2 (ä½ éœ€è‡ªè¡Œæ”¾æª”) -->
  <script src="./assets/ethers-5.7.2.umd.min.js"></script>

  <style>
    /* ===== Portal V1.2 additions ===== */
    .topRight{
      position:fixed; right:14px; top:14px; z-index:50;
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    .miniPill{
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.18);
      padding:8px 10px;
      border-radius:999px;
      box-shadow: var(--shadow);
      font-size:12px;
      color: var(--text);
      backdrop-filter: blur(8px);
    }
    .miniPill b{ font-family: var(--mono); }
    .progressWrap{ margin-top:10px; }
    .progressBar{
      width:100%; height:14px; border-radius:999px;
      background: rgba(255,255,255,.10);
      overflow:hidden; border:1px solid rgba(255,255,255,.14);
    }
    .progressFill{
      height:100%; width:0%;
      background: linear-gradient(90deg, rgba(255,215,0,.95), rgba(255,160,0,.95));
      transition: width .6s ease;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 10px; border-radius:999px; font-size:12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      color: var(--text);
      white-space:nowrap;
    }
    .badge.ok{ border-color: rgba(120,255,200,.35); }
    .badge.warn{ border-color: rgba(255,210,120,.35); }
    .badge.bad{ border-color: rgba(255,120,120,.35); }
    .supervisorBtn{
      cursor:pointer; user-select:none;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      padding:8px 12px; border-radius:999px;
      box-shadow: var(--shadow);
      font-weight:800;
    }
    .overlay{
      position:fixed; inset:0; z-index:80;
      background: rgba(0,0,0,.72);
      display:none;
    }
    .overlay.on{ display:block; }
    .overlayCard{
      position:absolute; right:14px; top:64px;
      width:min(520px, calc(100vw - 28px));
      background: rgba(10,10,16,.85);
      border:1px solid rgba(255,215,0,.30);
      border-radius: var(--r);
      box-shadow: 0 18px 70px rgba(0,0,0,.65);
      padding:14px;
      backdrop-filter: blur(10px);
      color: var(--text);
    }
    .chkGrid{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px 10px;
      margin-top:10px;
      font-size:13px;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.25);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 0 10px rgba(255,255,255,.10);
      justify-self:end;
      margin-top:4px;
    }
    .dot.ok{ background: rgba(120,255,200,.95); box-shadow:0 0 14px rgba(120,255,200,.45); }
    .dot.warn{ background: rgba(255,210,120,.95); box-shadow:0 0 14px rgba(255,210,120,.45); }
    .dot.bad{ background: rgba(255,120,120,.95); box-shadow:0 0 14px rgba(255,120,120,.45); }
    .nodesGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
    }
    @media (max-width: 760px){ .nodesGrid{ grid-template-columns:1fr; } }
    .nodeCard{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      border-radius: var(--r);
      padding:12px;
      box-shadow: var(--shadow);
    }
    .nodeTitle{ font-weight:950; letter-spacing:.3px; }
    .nodeSub{ color: var(--muted); margin-top:6px; font-size:12px; line-height:1.5; }
    .nodeRow{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:10px; flex-wrap:wrap; }
    .nodeRow a{
      display:inline-flex; align-items:center; justify-content:center;
      padding:9px 12px; border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      text-decoration:none; color: var(--text);
      font-weight:850;
    }
    .nodeRow a:hover{ background: rgba(255,255,255,.16); }
  </style>

</head></head>

<body>

  <div class="topRight">
    <div class="miniPill">ç‰ˆæœ¬ï¼š<b id="uiVersion" class="mono">Portal V1.2</b></div>
    <div class="miniPill">æ™‚é–“ï¼š<b id="nowClock" class="mono">--</b></div>
    <div class="supervisorBtn" id="btnSupervisor">ç›£å·¥æª¢æŸ¥</div>
  </div>

  <div class="overlay" id="supervisorOverlay" aria-hidden="true">
    <div class="overlayCard">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div style="font-weight:950;letter-spacing:.35px;">ç›£å·¥æª¢æŸ¥ï½œPortal V1.2</div>
        <div class="badge" id="supClose" style="cursor:pointer;">é—œé–‰</div>
      </div>
      <div class="progressWrap">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div style="color:var(--muted);font-size:12px;">å·¥ç¨‹é€²åº¦ï¼ˆè‡ªå‹•æª¢æŸ¥ï¼‰</div>
          <div class="badge" id="supPct">0%</div>
        </div>
        <div class="progressBar"><div class="progressFill" id="supFill"></div></div>
      </div>

      <div class="chkGrid" id="supChecks">
        <div>é é¢è¼‰å…¥</div><div class="dot" id="chkLoaded"></div>
        <div>æ˜Ÿç©ºå¼•æ“ï¼ˆCanvasï¼‰</div><div class="dot" id="chkStars"></div>
        <div>ç¯€é»åµæ¸¬ï¼ˆå„æ®¿ index.htmlï¼‰</div><div class="dot" id="chkNodes"></div>
        <div>Heart é¢æ¿å¯ç”¨</div><div class="dot" id="chkHeartPanel"></div>
        <div>éŒ¯èª¤ç›£çœ‹ï¼ˆConsole æ•æ‰ï¼‰</div><div class="dot" id="chkErrors"></div>
      </div>

      <div style="margin-top:12px;color:var(--muted);font-size:12px;line-height:1.6;">
        èªªæ˜ï¼šPortal æœƒå˜—è©¦ä»¥ <span class="mono">fetch</span> åµæ¸¬å„é»ä½æ˜¯å¦å·²å®Œå·¥ï¼ˆå­˜åœ¨ index.htmlï¼‰ã€‚æœªå®Œå·¥é¡¯ç¤ºã€Œæ–½å·¥æº–å‚™ä¸­ã€ã€‚
      </div>
    </div>
  </div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="h">Kç·šè¥¿éŠè¨˜ï½œéŠ€æ²³å®‡å®™å…¥å£</div>
        <div class="s">KLINE Odyssey Â· Map Portal Â· Portal V1.2</div>
      </div>

      <div class="pillrow">
        <div class="pill">KGEN ç¸½é‡ï¼š<b class="mono" id="supply">72,000,000</b></div>
        <div class="pill">ä»Šæ—¥åƒè¨ªï¼š<b class="mono" id="today">0</b></div>
        <div class="pill">ç¸½åƒè¨ªï¼š<b class="mono" id="total">0</b></div>
      </div>
    </header>

    <section class="hero">
      <canvas id="stars"></canvas>

      <div class="heroGrid">
        <div>
          <div class="title">å®‡å®™ä¸éœ€è¦è§£é‡‹ï¼Œåªéœ€è¦å…¥å£ã€‚</div>
          <p class="subtitle">
            é€™è£¡æ˜¯ã€ŠKç·šè¥¿éŠè¨˜ã€‹çš„åœ°åœ–é–€æˆ¶ã€‚<br/>
            Portal V1.2ï¼šæ–°å¢ã€Œäº”æŒ‡å±± 12345 å¿ƒè‡Ÿç‹€æ…‹ã€è®€éˆé¢æ¿ï¼ˆè¡€é‡ / å‘¼å¸çª—å£ / ä»Šæ—¥æ˜¯å¦é»ç«ï¼‰ã€‚
          </p>

          <div class="ctaRow">
            <a class="btn" href="#map">ğŸ—ºï¸ é€²å…¥å®‡å®™åœ°åœ–</a>
            <a class="btn" href="./README.md">ğŸ“˜ æŸ¥çœ‹è³‡æ–™èªªæ˜</a>
            <a class="btn small" href="https://t.me/klineodyssey" target="_blank" rel="noreferrer">Telegram</a>
            <a class="btn small" href="https://lin.ee/b8X18F7" target="_blank" rel="noreferrer">LINE å®˜æ–¹</a>
          </div>

          <div class="hr"></div>

          <div class="smallText">
            RPC æ¨¡å¼ï¼šé è¨­ç”¨å…¬é–‹ RPC è®€éˆï¼ˆä¸éœ€è¦éŒ¢åŒ…ï¼‰ã€‚<br/>
            é€£éŒ¢åŒ…åªæ˜¯ç‚ºäº†å¾ŒçºŒè¦åœ¨ Portal ä¸Šåšã€Œä¸€éµè·³è½‰ï¼‹å¿«é€Ÿé»ç«ã€æ‰éœ€è¦ï¼›æœ¬ç‰ˆå…ˆåšè®€éˆç©©å®šã€‚
          </div>
        </div>

        <div class="grid">
          <div class="card">
            <div class="k">ç•¶å‰ç¯€å¾‹ï¼ˆæœ¬æ©Ÿï¼‰</div>
            <div class="v mono" id="clock">--:--:--</div>
            <div class="t">
              <span class="btn small" id="pingBtn">ğŸ”” å¿ƒè·³æ‰“é»</span>
              <span class="btn small" id="resetBtn">â™»ï¸ é‡ç½®çµ±è¨ˆ</span>
            </div>
          </div>

          <div class="card">
            <div class="k">éˆä¸Šé€£ç·š</div>
            <div class="v" style="font-size:14px;font-weight:900;" id="rpcStatus">å°šæœªæª¢æ¸¬</div>
            <div class="t">
              <span class="badge">CHAIN: <b class="mono" id="chainId">--</b></span>
              <span class="badge">BLOCK: <b class="mono" id="blockNum">--</b></span>
            </div>
          </div>

          <div class="card">
            <div class="k">äº”æŒ‡å±± 12345ï½œHeart ç‹€æ…‹</div>
            <div class="v" style="font-size:14px;font-weight:900;" id="heartStatus">å°šæœªè®€å–</div>
            <div class="t">
              <span class="badge">è¡€é‡: <b class="mono" id="heartBal">--</b> <span class="mono">KGEN</span></span>
              <span class="badge">ä»Šæ—¥é»ç«: <b class="mono" id="ignitedToday">--</b></span>
              <span class="badge">çª—å£: <b class="mono" id="igniteWindow">--</b></span>
            </div>
            <div class="smallText" style="margin-top:10px;">
              Heart: <span class="mono" id="heartAddr">æœªè¨­å®š</span>
            </div>
          </div>
        </div>
      </div>
    </section>
    <section class="card" style="margin-top:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <div style="font-weight:950;letter-spacing:.35px;">æ™‚å…‰éš§é“ï½œå®‡å®™å…¥å£åˆ—è¡¨</div>
        <div class="badge warn" id="nodesStatus">åµæ¸¬ä¸­â€¦</div>
      </div>
      <div class="nodeSub">é»ä½å°šæœªæ–½å·¥å®Œæˆæ™‚ï¼Œå…¥å£æœƒé¡¯ç¤ºã€Œæ–½å·¥æº–å‚™ä¸­ã€ã€‚åµæ¸¬åˆ°æª”æ¡ˆå¾Œè‡ªå‹•äº®ç‡ˆã€‚</div>

      <div class="nodesGrid" id="nodesGrid" style="margin-top:12px;"></div>
    </section>


    <section class="map" id="map">
      <div class="mapHead">
        <div>
          <div class="h">å®‡å®™ç¯€é»å°èˆª</div>
          <div class="s">æ¯å€‹æ®¿å„è‡ª index.htmlï¼›å…¥å£åªåšå°èˆªï¼‹è®€éˆç‹€æ…‹</div>
        </div>
        <div class="s mono" id="pathHint">/Kç·šè¥¿éŠè¨˜/index.html</div>
      </div>

      <div class="nodes">
        <a class="node" href="./temples/12345/index.html" data-node="12345">
          <div class="n">äº”æŒ‡å±±ãƒ»æ‚Ÿç©ºè²¡ç¥æ®¿</div>
          <div class="id">12345</div>
          <div class="p">Heart / ç™¼è²¡é‡‘ / å‘¼å¸å¿ƒè·³ / é‚„é¡˜ / è¨±é¡˜ / å…‰æ˜ç‡ˆ / å½±åƒè‡ªçœ‹</div>
          <div class="p mono" id="node12345Hint">Heart æœªè¨­å®š</div>
        </a>

        <a class="node" href="javascript:void(0)" data-node="18888">
          <div class="n">éˆéœ„å¯¶æ®¿ãƒ»ç‰å¸é‡‘åº«</div>
          <div class="id">18888</div>
          <div class="p">äººæ°‘éŠ€è¡Œ / å­˜æ¬¾åˆ©æ¯ / è²¸æ¬¾ / 0.1% ç¨…ï¼ˆå¦æ®¿å¦åˆç´„ï¼‰</div>
        </a>

        <a class="node" href="javascript:void(0)" data-node="18921">
          <div class="n">æ–¬å¦–å°ãƒ»AutoLP/è’¸ç™¼å¼•æ“</div>
          <div class="id">18921</div>
          <div class="p">0.05% AutoLP ç¨… / ç¯€æ—¥æ´»å‹•ï¼ˆå¦æ®¿å¦åˆç´„ï¼‰</div>
        </a>

        <a class="node" href="javascript:void(0)" data-node="MARS">
          <div class="n">èŠ±æœå±±ç«æ˜Ÿï¼ˆMARSï¼‰</div>
          <div class="id">MARS</div>
          <div class="p">è±ªå®… 500 å¸­ / 5000 KGEN å…¥ä½ / 0.05% Reward ç¨…ï¼ˆå¦æ®¿å¦åˆç´„ï¼‰</div>
        </a>
      </div>

      <div class="footer">
        Portal V1.2 åªæ–°å¢ï¼šè®€å– Heart è¡€é‡èˆ‡ä»Šæ—¥é»ç«ç‹€æ…‹ã€‚<br/>
        ä¹‹å¾Œè¦åšã€Œå½±åƒ AI ç„¡äººå®¢æœã€æœƒæ”¾åœ¨ Portal çš„å®¢æœå€ï¼ˆä½†ä¸æ“ é€² 12345 ç¥æ®¿ï¼‰ã€‚
      </div>
    </section>

    <div class="footer" style="margin-top:14px;">
      PrimeForge ä»¥æ¯æ©Ÿä¹‹åï¼Œé–‹å•Ÿé‡‘èç”Ÿå‘½ã€‚<br/>
      èŠ±æœå±±å°ç£ãƒ»ä¿¡å¿µä¸æ»…ãƒ»å¸‚å ´ç„¡ç•Œã€‚<br/>
      Where the Market Becomes the Myth.<br/>
      â€”â€” æ¨‚å¤©å¸ âŒ–
    </div>
  </div>

<script>
/* =========================
   Portal V1.2 â€” On-chain Read Panel (BSC)
   - No wallet required (default JsonRpcProvider)
   - Heart address is configured in CFG
   ========================= */

const CFG = {
  chain: {
    name: "BSC",
    chainIdExpected: 56,
    // å¯è‡ªè¡Œæ›æˆä½ åå¥½çš„ RPCï¼›é€™è£¡ç•™å¤šå€‹ï¼Œæœƒè‡ªå‹•å˜—è©¦
    rpcUrls: [
      "https://bsc-dataseed.binance.org/",
      "https://bsc-dataseed1.binance.org/",
      "https://bsc-dataseed2.binance.org/"
    ]
  },
  addresses: {
    // å·²éƒ¨ç½²ï¼ˆä½ æä¾›ï¼‰
    kgenToken: "0xBA3d3810e58735cb6813bC1CDc5458C0d71432Be",
    // ä½ éƒ¨ç½² Heart å¾ŒæŠŠåœ°å€è²¼åœ¨é€™è£¡
    heart12345: "0x0000000000000000000000000000000000000000"
  }
};

// Minimal ABIs
const ERC20_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)"
];

// Heart ABI (read-only subset)
const HEART_ABI = [
  "function token() view returns (address)",
  "function windowStartSec() view returns (uint32)",
  "function windowEndSec() view returns (uint32)",
  "function inIgniteWindow() view returns (bool)",
  "function localDayIdNow() view returns (uint256)",
  "function dayIgnited(uint256) view returns (bool)",
  "function igniteReward() view returns (uint256)",
  "function heartbeatReward() view returns (uint256)"
];

function $(id){ return document.getElementById(id); }
function setText(id, v){ $(id).textContent = v; }

function fmtNum(n){
  try{ return new Intl.NumberFormat("en-US").format(n); }catch(e){ return String(n); }
}

function shortAddr(a){
  if(!a || a.length < 10) return a || "";
  return a.slice(0,6) + "â€¦" + a.slice(-4);
}

function statusBadge(el, kind, text){
  el.className = "v " + (kind==="ok"?"ok":kind==="warn"?"warn":"err");
  el.textContent = text;
}

async function makeProvider(){
  if(!window.ethers) throw new Error("ethers not loaded. Put ethers-5.7.2.umd.min.js into /Kç·šè¥¿éŠè¨˜/assets/");
  let lastErr = null;
  for(const url of CFG.chain.rpcUrls){
    try{
      const p = new ethers.providers.JsonRpcProvider(url);
      // probe
      await p.getBlockNumber();
      return p;
    }catch(e){
      lastErr = e;
    }
  }
  throw lastErr || new Error("No RPC works");
}

async function refreshChain(provider){
  try{
    const net = await provider.getNetwork();
    setText("chainId", String(net.chainId));
    const bn = await provider.getBlockNumber();
    setText("blockNum", String(bn));
    if(net.chainId === CFG.chain.chainIdExpected){
      statusBadge($("rpcStatus"), "ok", "RPC OKï¼ˆè®€éˆæ­£å¸¸ï¼‰");
    }else{
      statusBadge($("rpcStatus"), "warn", `RPC OKï¼ˆchainId=${net.chainId}ï¼‰`);
    }
  }catch(e){
    statusBadge($("rpcStatus"), "err", "RPC å¤±æ•—ï¼ˆç„¡æ³•è®€éˆï¼‰");
    throw e;
  }
}

async function refreshHeart(provider){
  const heart = CFG.addresses.heart12345;
  setText("heartAddr", heart);
  setText("node12345Hint", heart && heart !== ethers.constants.AddressZero ? `Heart: ${shortAddr(heart)}` : "Heart æœªè¨­å®š");

  if(!heart || heart === ethers.constants.AddressZero){
    statusBadge($("heartStatus"), "warn", "Heart æœªè¨­å®šï¼ˆå…ˆéƒ¨ç½²/å¡«å…¥åœ°å€ï¼‰");
    setText("heartBal", "--");
    setText("ignitedToday", "--");
    setText("igniteWindow", "--");
    return;
  }

  const heartC = new ethers.Contract(heart, HEART_ABI, provider);

  // token balance
  const tokenAddr = CFG.addresses.kgenToken;
  const token = new ethers.Contract(tokenAddr, ERC20_ABI, provider);

  const [dec, sym, bal] = await Promise.all([
    token.decimals().catch(()=>18),
    token.symbol().catch(()=> "KGEN"),
    token.balanceOf(heart).catch(()=> ethers.BigNumber.from(0))
  ]);

  const balFmt = ethers.utils.formatUnits(bal, dec);
  setText("heartBal", fmtNum(Number(balFmt).toFixed(2)));

  // ignite window + ignited today
  const [ws, we, inWin, dayId] = await Promise.all([
    heartC.windowStartSec(),
    heartC.windowEndSec(),
    heartC.inIgniteWindow(),
    heartC.localDayIdNow()
  ]);

  const ignited = await heartC.dayIgnited(dayId);
  setText("ignitedToday", ignited ? "YES" : "NO");

  const hhmm = (sec)=>{
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
  };
  setText("igniteWindow", `${hhmm(ws)}â€“${hhmm(we)}ï¼ˆTWï¼‰${inWin ? " Â· NOW" : ""}`);

  // status line
  if(Number(balFmt) <= 0){
    statusBadge($("heartStatus"), "warn", `ç¼ºæ°§ï¼šè¡€é‡ 0 ${sym}ï¼ˆä»»ä½•å‡ºé‡‘éƒ½æœƒå¤±æ•—ï¼‰`);
  }else if(!ignited){
    statusBadge($("heartStatus"), "warn", inWin ? "å‘¼å¸çª—å£é–‹å•Ÿï¼ˆå°šæœªé»ç«ï¼‰" : "ä»Šæ—¥å°šæœªé»ç«ï¼ˆçª—å£æœªé–‹ï¼‰");
  }else{
    statusBadge($("heartStatus"), "ok", "å¿ƒè‡Ÿé‹ä½œä¸­ï¼ˆä»Šæ—¥å·²é»ç«ï¼‰");
  }
}

/* ========= local counters ========= */
const KEY_TOTAL="KLINE_PORTAL_TOTAL_VISITS";
const KEY_TODAY="KLINE_PORTAL_TODAY_VISITS";
const KEY_DATE ="KLINE_PORTAL_TODAY_DATE";

const todayStr=()=>{
  const d=new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
};

function loadVisits(){
  const d=todayStr();
  const last=localStorage.getItem(KEY_DATE);
  if(last!==d){
    localStorage.setItem(KEY_DATE,d);
    localStorage.setItem(KEY_TODAY,"0");
  }
  setText("total", localStorage.getItem(KEY_TOTAL)||"0");
  setText("today", localStorage.getItem(KEY_TODAY)||"0");
}
function incVisits(){
  const d=todayStr();
  const last=localStorage.getItem(KEY_DATE);
  if(last!==d){
    localStorage.setItem(KEY_DATE,d);
    localStorage.setItem(KEY_TODAY,"0");
  }
  const total=Number(localStorage.getItem(KEY_TOTAL)||"0")+1;
  const today=Number(localStorage.getItem(KEY_TODAY)||"0")+1;
  localStorage.setItem(KEY_TOTAL,String(total));
  localStorage.setItem(KEY_TODAY,String(today));
  setText("total", String(total));
  setText("today", String(today));
}

$("resetBtn").addEventListener("click", ()=>{
  localStorage.removeItem(KEY_TOTAL);
  localStorage.removeItem(KEY_TODAY);
  localStorage.removeItem(KEY_DATE);
  loadVisits();
});

$("pingBtn").addEventListener("click", ()=>{
  // Portal åªç¤ºç¯„ï¼Œä¸ä¸Šéˆ
  $("rpcStatus").textContent = $("rpcStatus").textContent + " Â· ping";
});

/* ========= clock ========= */
function tick(){
  const d=new Date();
  const hh=String(d.getHours()).padStart(2,"0");
  const mm=String(d.getMinutes()).padStart(2,"0");
  const ss=String(d.getSeconds()).padStart(2,"0");
  setText("clock", `${hh}:${mm}:${ss}`);
}
setInterval(tick, 500); tick();

/* ========= starfield ========= */
const canvas=$("stars");
const ctx=canvas.getContext("2d");
let W=0,H=0,stars=[];
function resize(){
  W=canvas.width=canvas.offsetWidth*devicePixelRatio;
  H=canvas.height=canvas.offsetHeight*devicePixelRatio;
  const count=Math.floor((canvas.offsetWidth*canvas.offsetHeight)/12000);
  stars=new Array(Math.max(60, Math.min(220, count))).fill(0).map(()=>({
    x:Math.random()*W,y:Math.random()*H,
    r:(Math.random()*1.4+0.4)*devicePixelRatio,
    v:(Math.random()*0.25+0.05)*devicePixelRatio,
    a:Math.random()*0.7+0.15
  }));
}
window.addEventListener("resize", resize); resize();
function draw(){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle="rgba(255,255,255,0.9)";
  for(const s of stars){
    s.y += s.v;
    if(s.y>H){ s.y=-10; s.x=Math.random()*W; }
    ctx.globalAlpha=s.a;
    ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
  }
  requestAnimationFrame(draw);
}
draw();

/* ========= node click placeholder ========= */
document.querySelectorAll(".node").forEach(el=>{
  el.addEventListener("click", (e)=>{
    const href=(el.getAttribute("href")||"").trim();
    if(href && !href.startsWith("javascript")) return;
    e.preventDefault();
    alert("æ­¤ç¯€é»å°šæœªæ¥é é¢ã€‚");
  });
});

/* ========= boot ========= */
(async function boot(){
  loadVisits(); incVisits();

  try{
    const provider = await makeProvider();
    await refreshChain(provider);
    await refreshHeart(provider);

    // refresh periodically
    setInterval(async ()=>{
      try{
        await refreshChain(provider);
        await refreshHeart(provider);
      }catch(e){ /* ignore */ }
    }, 15000);
  }catch(e){
    statusBadge($("rpcStatus"), "err", "ç¼º ethers æˆ– RPC ç„¡æ³•é€£ç·š");
    console.error(e);
  }
})();
</script>

<script>
/* ===== Portal V1.2 Supervisor + Nodes ===== */
(function(){
  const uiVersion = "Portal V1.2";
  const elClock = document.getElementById("nowClock");
  const overlay = document.getElementById("supervisorOverlay");
  const btn = document.getElementById("btnSupervisor");
  const close = document.getElementById("supClose");
  const supFill = document.getElementById("supFill");
  const supPct = document.getElementById("supPct");
  const nodesGrid = document.getElementById("nodesGrid");
  const nodesStatus = document.getElementById("nodesStatus");
  const chk = (id, cls)=>{ const e=document.getElementById(id); if(!e) return; e.classList.remove("ok","warn","bad"); if(cls) e.classList.add(cls); };

  // Clock
  function tick(){
    const d = new Date();
    const pad = n=>String(n).padStart(2,"0");
    const s = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    if(elClock) elClock.textContent = s;
  }
  tick(); setInterval(tick, 1000);

  // Supervisor toggle
  function setOverlay(on){
    if(!overlay) return;
    overlay.classList.toggle("on", !!on);
    overlay.setAttribute("aria-hidden", on ? "false" : "true");
  }
  if(btn) btn.addEventListener("click", ()=>setOverlay(true));
  if(close) close.addEventListener("click", ()=>setOverlay(false));
  if(overlay) overlay.addEventListener("click", (e)=>{ if(e.target===overlay) setOverlay(false); });

  // Error capture
  let errorCount = 0;
  window.addEventListener("error", ()=>{ errorCount++; });
  window.addEventListener("unhandledrejection", ()=>{ errorCount++; });

  // Nodes config
  const nodes = [
    { id:"12345", name:"äº”æŒ‡å±± 12345ï½œæ‚Ÿç©ºè²¡ç¥æ®¿", path:"./temples/12345/index.html", note:"å¿ƒè‡Ÿè£œè¡€ã€é»ç«ã€è¨±é¡˜ã€ç•™è­‰ã€è‡ªæ‹ç•™å¿µ" },
    { id:"11520", name:"èŠ±æœå±±å°ç£ 11520ï½œæ‚Ÿç©ºå¤§è…¦ï¼ˆäº¤æ˜“æ‰€ï¼‰", path:"./temples/11520/index.html", note:"æ–½å·¥æº–å‚™ä¸­ï¼ˆåµæ¸¬åˆ°æª”æ¡ˆè‡ªå‹•é–‹æ”¾ï¼‰" },
    { id:"18888", name:"éˆéœ„å¯¶æ®¿ 18888ï½œäººæ°‘/ç¥æ˜éŠ€è¡Œ", path:"./temples/18888/index.html", note:"0.10% ç¨…æ”¶æ‰¿æ¥ï¼ˆæ–½å·¥æº–å‚™ä¸­ï¼‰" },
    { id:"108000", name:"Mars 108000ï½œèŠ±æœå±±ç«æ˜Ÿé½Šå¤©è±ªå®…ï¼ˆKUFOï¼‰", path:"./temples/108000/index.html", note:"Reward 0.05% æ‰¿æ¥ï¼ˆæ–½å·¥æº–å‚™ä¸­ï¼‰" },
    { id:"AUTO-LP", name:"æ–¬å¦–å°ï½œAutoLP", path:"./temples/autolp/index.html", note:"AutoLP 0.05% æ‰¿æ¥ï¼ˆæ–½å·¥æº–å‚™ä¸­ï¼‰" },
    { id:"8888", name:"é«˜è€èŠ 8888ï½œå¾ŒçºŒå®®æ®¿", path:"./temples/8888/index.html", note:"æ–½å·¥æº–å‚™ä¸­" },
    { id:"88888", name:"ç¾æ´²å¤§é™¸ 88888ï½œè·¨æ´²å‚³é€é–€", path:"./temples/88888/index.html", note:"æ–½å·¥æº–å‚™ä¸­" },
    { id:"é›·éŸ³å¯º", name:"é›·éŸ³å¯ºï½œå¦‚ä¾†ç³»çµ±", path:"./temples/leiyin/index.html", note:"æ–½å·¥æº–å‚™ä¸­" },
  ];

  function makeBadge(state, text){
    const span = document.createElement("span");
    span.className = "badge " + (state==="ok"?"ok":state==="bad"?"bad":"warn");
    span.textContent = text;
    return span;
  }

  async function probe(url){
    try{
      const r = await fetch(url, { method:"GET", cache:"no-store" });
      return r && r.ok;
    }catch(e){
      return false;
    }
  }

  async function buildNodes(){
    if(!nodesGrid) return;
    nodesGrid.innerHTML = "";
    nodesStatus.textContent = "åµæ¸¬ä¸­â€¦";
    nodesStatus.className = "badge warn";

    let okCount = 0;
    for(const n of nodes){
      const card = document.createElement("div");
      card.className = "nodeCard";

      const title = document.createElement("div");
      title.className = "nodeTitle";
      title.textContent = n.name;

      const sub = document.createElement("div");
      sub.className = "nodeSub";
      sub.textContent = n.note;

      const row = document.createElement("div");
      row.className = "nodeRow";

      const state = document.createElement("div");
      state.appendChild(makeBadge("warn","åµæ¸¬ä¸­"));

      const a = document.createElement("a");
      a.href = n.path;
      a.textContent = "é€²å…¥";

      row.appendChild(state);
      row.appendChild(a);

      card.appendChild(title);
      card.appendChild(sub);
      card.appendChild(row);

      nodesGrid.appendChild(card);

      const ok = await probe(n.path);
      if(ok){
        okCount++;
        state.innerHTML = "";
        state.appendChild(makeBadge("ok","å·²å®Œå·¥"));
        a.style.opacity = "1";
      }else{
        state.innerHTML = "";
        state.appendChild(makeBadge("warn","æ–½å·¥æº–å‚™ä¸­"));
        a.style.opacity = ".55";
      }
    }

    // Update supervisor checks + progress
    chk("chkLoaded","ok");
    chk("chkStars", document.getElementById("stars") ? "ok" : "warn");
    chk("chkNodes", okCount>0 ? "ok" : "warn");
    chk("chkHeartPanel", document.getElementById("heartHp") ? "ok" : "warn");
    chk("chkErrors", errorCount===0 ? "ok" : "warn");

    const total = 5;
    let score = 0;
    score += 1; // loaded
    score += document.getElementById("stars") ? 1 : 0;
    score += okCount>0 ? 1 : 0;
    score += document.getElementById("heartHp") ? 1 : 0;
    score += errorCount===0 ? 1 : 0;

    const pct = Math.round((score/total)*100);
    if(supFill) supFill.style.width = pct + "%";
    if(supPct) supPct.textContent = pct + "%";

    if(okCount>0){
      nodesStatus.textContent = `å®Œæˆç¯€é»ï¼š${okCount}/${nodes.length}`;
      nodesStatus.className = "badge ok";
    }else{
      nodesStatus.textContent = "ç›®å‰çš†æ–½å·¥æº–å‚™ä¸­";
      nodesStatus.className = "badge warn";
    }
  }

  // initial run
  setTimeout(buildNodes, 700);
})();
</script>

</body></body>
</html>
