<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kç·šè¥¿éŠè¨˜ï½œéŠ€æ²³å®‡å®™å…¥å£ï¼ˆPortal V1.2.1 GLOBAL-IGNITEï¼‰</title>
  <style>
    :root{
      --bg:#06070b;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --line: rgba(255,255,255,.14);
      --btn: rgba(255,255,255,.12);
      --btnh: rgba(255,255,255,.18);
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --r: 18px;
      --r2: 999px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Heiti TC", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 800px at 30% 20%, rgba(120,170,255,.10), transparent 60%),
                  radial-gradient(1000px 700px at 70% 60%, rgba(255,160,220,.08), transparent 55%),
                  var(--bg);
      color: var(--text);
      min-height:100vh;
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 40px;}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 0 14px;}
    .brand{display:flex;flex-direction:column;gap:4px;}
    .brand .h{font-weight:900;letter-spacing:.5px;font-size:18px;}
    .brand .s{font-size:12px;color:var(--muted);}
    .pillrow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .pill{
      display:flex;gap:8px;align-items:center;
      padding:9px 12px;border:1px solid var(--line);border-radius:var(--r2);
      background:rgba(255,255,255,.05);backdrop-filter:blur(8px);box-shadow:var(--shadow);
      font-size:12px;color:var(--muted);white-space:nowrap;
    }
    .pill b{color:var(--text);font-weight:800}
    .mono{font-family:var(--mono)}
    .hero{
      position:relative;border:1px solid var(--line);border-radius:24px;
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow:var(--shadow);overflow:hidden;padding:18px;
    }
    canvas#stars{position:absolute;inset:0;width:100%;height:100%;opacity:.85;pointer-events:none;}
    .heroGrid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;}
    @media (max-width:900px){.heroGrid{grid-template-columns:1fr}}
    .title{font-size:26px;font-weight:950;letter-spacing:.8px;margin:4px 0 8px;}
    .subtitle{color:var(--muted);line-height:1.55;margin:0 0 14px;font-size:13px;}
    .ctaRow{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 14px;border-radius:var(--r2);border:1px solid var(--line);
      background:var(--btn);text-decoration:none;font-weight:850;font-size:13px;transition:.15s;user-select:none;
      cursor:pointer;
    }
    .btn:hover{background:var(--btnh)}
    .btn.small{padding:8px 12px;font-weight:800}
    .grid{display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;margin-top:14px;}
    @media (max-width:900px){.grid{grid-template-columns:1fr 1fr}}
    @media (max-width:520px){.grid{grid-template-columns:1fr}}
    .card{
      border:1px solid var(--line);border-radius:var(--r);background:var(--panel);
      box-shadow:var(--shadow);padding:14px;min-height:110px;position:relative;overflow:hidden;
    }
    .card .k{font-size:12px;color:var(--muted);margin-bottom:6px;letter-spacing:.2px}
    .card .v{font-size:18px;font-weight:950;letter-spacing:.6px}
    .card .t{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .smallText{font-size:12px;color:var(--muted);line-height:1.35}
    .map{
      margin-top:14px;border:1px solid var(--line);border-radius:24px;background:rgba(0,0,0,.20);
      box-shadow:var(--shadow);padding:16px;position:relative;overflow:hidden;
    }
    .mapHead{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .mapHead .h{font-weight:950;letter-spacing:.6px;font-size:16px;}
    .mapHead .s{color:var(--muted);font-size:12px;}
    .nodes{display:grid;grid-template-columns:repeat(4, 1fr);gap:10px;margin-top:10px;}
    @media (max-width:900px){.nodes{grid-template-columns:repeat(2, 1fr)}}
    @media (max-width:520px){.nodes{grid-template-columns:1fr}}
    .node{
      border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.06);
      padding:12px;text-decoration:none;display:flex;flex-direction:column;gap:6px;transition:.15s;min-height:110px;
    }
    .node:hover{background:rgba(255,255,255,.10)}
    .node .n{font-weight:950;letter-spacing:.5px}
    .node .p{color:var(--muted);font-size:12px;line-height:1.35}
    .node .id{color:rgba(255,255,255,.75);font-size:12px;font-family:var(--mono)}
    .badge{
      display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);font-size:12px;color:var(--muted)
    }
    .ok{color:#9fffd9}
    .warn{color:#ffd28c}
    .err{color:#ff9fb2}

    .footer{color:var(--muted);font-size:12px;margin-top:14px;line-height:1.55;padding-bottom:6px;}
    .hr{height:1px;background:var(--line);margin:10px 0}

    /* ===== Portal V1.2+ additions ===== */
    .topRight{
      position:fixed; right:14px; top:14px; z-index:50;
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    .miniPill{
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.18);
      padding:8px 10px;
      border-radius:999px;
      box-shadow: var(--shadow);
      font-size:12px;
      color: var(--text);
      backdrop-filter: blur(8px);
    }
    .miniPill b{ font-family: var(--mono); }
    .progressWrap{ margin-top:10px; }
    .progressBar{
      width:100%; height:14px; border-radius:999px;
      background: rgba(255,255,255,.10);
      overflow:hidden; border:1px solid rgba(255,255,255,.14);
    }
    .progressFill{
      height:100%; width:0%;
      background: linear-gradient(90deg, rgba(255,215,0,.95), rgba(255,160,0,.95));
      transition: width .6s ease;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 10px; border-radius:999px; font-size:12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      color: var(--text);
      white-space:nowrap;
    }
    .badge.ok{ border-color: rgba(120,255,200,.35); }
    .badge.warn{ border-color: rgba(255,210,120,.35); }
    .badge.bad{ border-color: rgba(255,120,120,.35); }
    .supervisorBtn{
      cursor:pointer; user-select:none;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      padding:8px 12px; border-radius:999px;
      box-shadow: var(--shadow);
      font-weight:800;
    }
    .overlay{
      position:fixed; inset:0; z-index:80;
      background: rgba(0,0,0,.72);
      display:none;
    }
    .overlay.on{ display:block; }
    .overlayCard{
      position:absolute; right:14px; top:64px;
      width:min(520px, calc(100vw - 28px));
      background: rgba(10,10,16,.85);
      border:1px solid rgba(255,215,0,.30);
      border-radius: var(--r);
      box-shadow: 0 18px 70px rgba(0,0,0,.65);
      padding:14px;
      backdrop-filter: blur(10px);
      color: var(--text);
    }
    .chkGrid{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px 10px;
      margin-top:10px;
      font-size:13px;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.25);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 0 10px rgba(255,255,255,.10);
      justify-self:end;
      margin-top:4px;
    }
    .dot.ok{ background: rgba(120,255,200,.95); box-shadow:0 0 14px rgba(120,255,200,.45); }
    .dot.warn{ background: rgba(255,210,120,.95); box-shadow:0 0 14px rgba(255,210,120,.45); }
    .dot.bad{ background: rgba(255,120,120,.95); box-shadow:0 0 14px rgba(255,120,120,.45); }
    .nodesGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
    }
    @media (max-width: 760px){ .nodesGrid{ grid-template-columns:1fr; } }
    .nodeCard{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      border-radius: var(--r);
      padding:12px;
      box-shadow: var(--shadow);
    }
    .nodeTitle{ font-weight:950; letter-spacing:.3px; }
    .nodeSub{ color: var(--muted); margin-top:6px; font-size:12px; line-height:1.5; }
    .nodeRow{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:10px; flex-wrap:wrap; }
    .nodeRow a{
      display:inline-flex; align-items:center; justify-content:center;
      padding:9px 12px; border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      text-decoration:none; color: var(--text);
      font-weight:850;
    }
    .nodeRow a:hover{ background: rgba(255,255,255,.16); }
  </style>

  <!-- Ethers v5.7.2 (ä½ éœ€è‡ªè¡Œæ”¾æª”) -->
  <script src="./assets/ethers-5.7.2.umd.min.js"></script>
</head>

<body>

  <div class="topRight">
    <div class="miniPill">ç‰ˆæœ¬ï¼š<b id="uiVersion" class="mono">Portal V1.2.1</b></div>
    <div class="miniPill">æ™‚é–“ï¼š<b id="nowClock" class="mono">--</b></div>
    <div class="supervisorBtn" id="btnSupervisor">ç›£å·¥æª¢æŸ¥</div>
  </div>

  <div class="overlay" id="supervisorOverlay" aria-hidden="true">
    <div class="overlayCard">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div style="font-weight:950;letter-spacing:.35px;">ç›£å·¥æª¢æŸ¥ï½œPortal V1.2.1 GLOBAL-IGNITE</div>
        <div class="badge" id="supClose" style="cursor:pointer;">é—œé–‰</div>
      </div>
      <div class="progressWrap">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div style="color:var(--muted);font-size:12px;">å·¥ç¨‹é€²åº¦ï¼ˆè‡ªå‹•æª¢æŸ¥ï¼‰</div>
          <div class="badge" id="supPct">0%</div>
        </div>
        <div class="progressBar"><div class="progressFill" id="supFill"></div></div>
      </div>

      <div class="chkGrid" id="supChecks">
        <div>é é¢è¼‰å…¥</div><div class="dot" id="chkLoaded"></div>
        <div>æ˜Ÿç©ºå¼•æ“ï¼ˆCanvasï¼‰</div><div class="dot" id="chkStars"></div>
        <div>ç¯€é»åµæ¸¬ï¼ˆå„æ®¿ index.htmlï¼‰</div><div class="dot" id="chkNodes"></div>
        <div>Heart é¢æ¿å¯ç”¨ï¼ˆè®€éˆï¼‰</div><div class="dot" id="chkHeartPanel"></div>
        <div>å…¨åŸŸé»ç«ï¼ˆäº‹ä»¶/å‡½å¼åµæ¸¬ï¼‰</div><div class="dot" id="chkIgniteGlobal"></div>
        <div>éŒ¯èª¤ç›£çœ‹ï¼ˆConsole æ•æ‰ï¼‰</div><div class="dot" id="chkErrors"></div>
      </div>

      <div style="margin-top:12px;color:var(--muted);font-size:12px;line-height:1.6;">
        èªªæ˜ï¼šPortal æœƒå˜—è©¦ä»¥ <span class="mono">fetch</span> åµæ¸¬å„é»ä½æ˜¯å¦å·²å®Œå·¥ï¼ˆå­˜åœ¨ index.htmlï¼‰ã€‚æœªå®Œå·¥é¡¯ç¤ºã€Œæ–½å·¥æº–å‚™ä¸­ã€ã€‚<br/>
        å…¨åŸŸé»ç«ï¼šå„ªå…ˆç”¨ Heart çš„å…¨åŸŸå‡½å¼ï¼ˆè‹¥å­˜åœ¨ï¼‰ï¼Œå¦å‰‡å›é€€æƒæè¿‘ 24 å°æ™‚äº‹ä»¶ï¼ˆè¿‘ä¼¼å…¨åŸŸï¼‰ä¸¦ä»¥ UTC ç•¶æ—¥åˆ¤æ–·ã€‚
      </div>
    </div>
  </div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="h">Kç·šè¥¿éŠè¨˜ï½œéŠ€æ²³å®‡å®™å…¥å£</div>
        <div class="s">KLINE Odyssey Â· Map Portal Â· Portal V1.2.1 (GLOBAL-IGNITE)</div>
      </div>

      <div class="pillrow">
        <div class="pill">KGEN ç¸½é‡ï¼š<b class="mono" id="supply">72,000,000</b></div>
        <div class="pill">ä»Šæ—¥åƒè¨ªï¼š<b class="mono" id="today">0</b></div>
        <div class="pill">ç¸½åƒè¨ªï¼š<b class="mono" id="total">0</b></div>
      </div>
    </header>

    <section class="hero">
      <canvas id="stars"></canvas>

      <div class="heroGrid">
        <div>
          <div class="title">å®‡å®™ä¸éœ€è¦è§£é‡‹ï¼Œåªéœ€è¦å…¥å£ã€‚</div>
          <p class="subtitle">
            é€™è£¡æ˜¯ã€ŠKç·šè¥¿éŠè¨˜ã€‹çš„åœ°åœ–é–€æˆ¶ã€‚<br/>
            Portal V1.2.1ï¼šè®€å– Heart è¡€é‡ / å‘¼å¸çª—å£ / ä»Šæ—¥ã€Œå…¨åŸŸé»ç«ã€ç‹€æ…‹ï¼ˆå‡½å¼å„ªå…ˆï¼‹äº‹ä»¶å›é€€ï¼‰ã€‚
          </p>

          <div class="ctaRow">
            <a class="btn" href="#map">ğŸ—ºï¸ é€²å…¥å®‡å®™åœ°åœ–</a>
            <a class="btn" href="./README.md">ğŸ“˜ æŸ¥çœ‹è³‡æ–™èªªæ˜</a>
            <a class="btn small" href="https://t.me/klineodyssey" target="_blank" rel="noreferrer">Telegram</a>
            <a class="btn small" href="https://lin.ee/b8X18F7" target="_blank" rel="noreferrer">LINE å®˜æ–¹</a>
          </div>

          <div class="hr"></div>

          <div class="smallText">
            RPC æ¨¡å¼ï¼šé è¨­ç”¨å…¬é–‹ RPC è®€éˆï¼ˆä¸éœ€è¦éŒ¢åŒ…ï¼‰ã€‚<br/>
            é€£éŒ¢åŒ…åªæ˜¯ç‚ºäº†å¾ŒçºŒè¦åœ¨ Portal ä¸Šåšã€Œä¸€éµè·³è½‰ï¼‹å¿«é€Ÿé»ç«ã€ï¼›æœ¬ç‰ˆå…ˆåšè®€éˆç©©å®šï¼‹å…¨åŸŸç‹€æ…‹ã€‚
          </div>
        </div>

        <div class="grid">
          <div class="card">
            <div class="k">ç•¶å‰ç¯€å¾‹ï¼ˆæœ¬æ©Ÿï¼‰</div>
            <div class="v mono" id="clock">--:--:--</div>
            <div class="t">
              <span class="btn small" id="pingBtn">ğŸ”” å¿ƒè·³æ‰“é»</span>
              <span class="btn small" id="resetBtn">â™»ï¸ é‡ç½®çµ±è¨ˆ</span>
            </div>
          </div>

          <div class="card">
            <div class="k">éˆä¸Šé€£ç·š</div>
            <div class="v" style="font-size:14px;font-weight:900;" id="rpcStatus">å°šæœªæª¢æ¸¬</div>
            <div class="t">
              <span class="badge">CHAIN: <b class="mono" id="chainId">--</b></span>
              <span class="badge">BLOCK: <b class="mono" id="blockNum">--</b></span>
            </div>
          </div>

          <div class="card">
            <div class="k">äº”æŒ‡å±± 12345ï½œHeart ç‹€æ…‹</div>
            <div class="v" style="font-size:14px;font-weight:900;" id="heartStatus">å°šæœªè®€å–</div>
            <div class="t">
              <span class="badge">è¡€é‡: <b class="mono" id="heartBal">--</b> <span class="mono">KGEN</span></span>
              <span class="badge">ä»Šæ—¥é»ç«: <b class="mono" id="ignitedToday">--</b></span>
              <span class="badge">çª—å£: <b class="mono" id="igniteWindow">--</b></span>
            </div>
            <div class="smallText" style="margin-top:10px;">
              Heart: <span class="mono" id="heartAddr">æœªè¨­å®š</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <div style="font-weight:950;letter-spacing:.35px;">æ™‚å…‰éš§é“ï½œå®‡å®™å…¥å£åˆ—è¡¨</div>
        <div class="badge warn" id="nodesStatus">åµæ¸¬ä¸­â€¦</div>
      </div>
      <div class="nodeSub">é»ä½å°šæœªæ–½å·¥å®Œæˆæ™‚ï¼Œå…¥å£æœƒé¡¯ç¤ºã€Œæ–½å·¥æº–å‚™ä¸­ã€ã€‚åµæ¸¬åˆ°æª”æ¡ˆå¾Œè‡ªå‹•äº®ç‡ˆã€‚</div>

      <div class="nodesGrid" id="nodesGrid" style="margin-top:12px;"></div>
    </section>

    <section class="map" id="map">
      <div class="mapHead">
        <div>
          <div class="h">å®‡å®™ç¯€é»å°èˆª</div>
          <div class="s">æ¯å€‹æ®¿å„è‡ª index.htmlï¼›å…¥å£åªåšå°èˆªï¼‹è®€éˆç‹€æ…‹</div>
        </div>
        <div class="s mono" id="pathHint">/Kç·šè¥¿éŠè¨˜/index.html</div>
      </div>

      <div class="nodes">
        <a class="node" href="./temples/12345/index.html" data-node="12345">
          <div class="n">äº”æŒ‡å±±ãƒ»æ‚Ÿç©ºè²¡ç¥æ®¿</div>
          <div class="id">12345</div>
          <div class="p">Heart / ç™¼è²¡é‡‘ / å‘¼å¸å¿ƒè·³ / é‚„é¡˜ / è¨±é¡˜ / å…‰æ˜ç‡ˆ / å½±åƒè‡ªçœ‹</div>
          <div class="p mono" id="node12345Hint">Heart æœªè¨­å®š</div>
        </a>

        <a class="node" href="javascript:void(0)" data-node="18888">
          <div class="n">éˆéœ„å¯¶æ®¿ãƒ»ç‰å¸é‡‘åº«</div>
          <div class="id">18888</div>
          <div class="p">äººæ°‘éŠ€è¡Œ / å­˜æ¬¾åˆ†ç´… / 0.1% ç¨…ï¼ˆå¦æ®¿å¦åˆç´„ï¼‰</div>
        </a>

        <a class="node" href="javascript:void(0)" data-node="18921">
          <div class="n">æ–¬å¦–å°ãƒ»AutoLP/åˆ†æµå¼•æ“</div>
          <div class="id">18921</div>
          <div class="p">0.05% AutoLP ç¨… / ç¯€æ—¥æ´»å‹•ï¼ˆå¦æ®¿å¦åˆç´„ï¼‰</div>
        </a>

        <a class="node" href="javascript:void(0)" data-node="MARS">
          <div class="n">èŠ±æœå±±ç«æ˜Ÿï¼ˆMARSï¼‰</div>
          <div class="id">MARS</div>
          <div class="p">è±ªå®… 500 å¸­ / 5000 KGEN å…¥ä½ / Brain æ¯æœˆæ’¥æ¬¾åˆ†æ½¤</div>
        </a>
      </div>

      <div class="footer">
        Portal V1.2.1ï¼šè®€å– Heart è¡€é‡ / çª—å£ / ä»Šæ—¥å…¨åŸŸé»ç«ç‹€æ…‹ã€‚<br/>
        ä¹‹å¾Œè¦åšã€Œå½±åƒ AI ç„¡äººå®¢æœã€æœƒæ”¾åœ¨ Portal çš„å®¢æœå€ï¼ˆä½†ä¸æ“ é€² 12345 ç¥æ®¿ï¼‰ã€‚
      </div>
    </section>

    <div class="footer" style="margin-top:14px;">
      PrimeForge ä»¥æ¯æ©Ÿä¹‹åï¼Œé–‹å•Ÿé‡‘èç”Ÿå‘½ã€‚<br/>
      èŠ±æœå±±å°ç£ãƒ»ä¿¡å¿µä¸æ»…ãƒ»å¸‚å ´ç„¡ç•Œã€‚<br/>
      Where the Market Becomes the Myth.<br/>
      â€”â€” æ¨‚å¤©å¸ âŒ–
    </div>
  </div>

<script>
/* =========================
   Portal V1.2.1 â€” On-chain Read Panel (BSC)
   - No wallet required (default JsonRpcProvider)
   - Heart address configured in CFG
   - GLOBAL ignite status: function-first, event-fallback
   ========================= */

const CFG = {
  chain: {
    name: "BSC",
    chainIdExpected: 56,
    rpcUrls: [
      "https://bsc-dataseed.binance.org/",
      "https://bsc-dataseed1.binance.org/",
      "https://bsc-dataseed2.binance.org/",
      "https://bsc.publicnode.com"
    ]
  },
  addresses: {
    // å·²éƒ¨ç½²ï¼ˆä½ æä¾›ï¼‰
    kgenToken: "0xBA3d3810e58735cb6813bC1CDc5458C0d71432Be",
    // ä½ éƒ¨ç½² Heart å¾ŒæŠŠåœ°å€è²¼åœ¨é€™è£¡
    heart12345: "0x0000000000000000000000000000000000000000"
  },
  // è‹¥ Heart æ˜¯ã€Œæ¯äººå„è‡ªé»ç«ã€ï¼šPortal ç„¡éŒ¢åŒ…æ¨¡å¼ä»å¯ç”¨ã€Œè§€æ¸¬è€…ã€åœ°å€æ¨æ–·æ˜¯å¦æœ‰äººé»ç«ï¼ˆäº‹ä»¶å›é€€ï¼‰
  observers: {
    keeperOrOwner: "0x0000000000000000000000000000000000000000"
  }
};

// Minimal ABIs
const ERC20_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)"
];

/**
 * Heart read-only ABI (å…¼å®¹ï¼šæœƒç”¨ callStatic/try-catch åµæ¸¬å“ªå€‹å­˜åœ¨)
 * ä½ çš„æœ€æ–° Heartï¼ˆV3.2.3ï¼‰å¸¸è¦‹ï¼š
 * - kgen() / token()
 * - igniteWindowStart()/igniteWindowEnd() æˆ– windowStartSec/windowEndSec
 * - currentDayIndex()/localDayIdNow()
 * - dayIgnited(dayId)ï¼ˆå…¨åŸŸï¼‰æˆ– lastIgniteDay(user)ï¼ˆå€‹é«”ï¼‰
 */
const HEART_READ_ABI = [
  "function kgen() view returns (address)",
  "function token() view returns (address)",
  "function igniteWindowStart() view returns (uint256)",
  "function igniteWindowEnd() view returns (uint256)",
  "function windowStartSec() view returns (uint32)",
  "function windowEndSec() view returns (uint32)",
  "function inIgniteWindow() view returns (bool)",
  "function currentDayIndex() view returns (uint256)",
  "function localDayIdNow() view returns (uint256)",
  "function dayIgnited(uint256) view returns (bool)",
  "function lastIgniteDay(address) view returns (uint256)",
  "function igniteReward() view returns (uint256)",
  "function heartbeatReward() view returns (uint256)",
  // è‹¥ä½ åˆç´„æœ‰é€™å€‹ï¼ˆä½ ä¹‹å‰ç‰ˆæœ¬æåˆ°ï¼‰
  "function heartBalanceWhole() view returns (uint256)"
];

// Event fallback candidates (we'll probe multiple; parse if matches)
const HEART_EVENT_SIGS = [
  // very common patterns
  "event Ignited(address indexed user, uint256 indexed dayId, uint256 rewardWei)",
  "event Ignite(address indexed user, uint256 indexed dayId, uint256 rewardWei)",
  "event IgniteAndClaim(address indexed user, uint256 indexed dayId, uint256 rewardWei)",
  "event IgniteClaimed(address indexed user, uint256 indexed dayId, uint256 rewardWei)",
  // alternative ordering
  "event Ignited(uint256 indexed dayId, address indexed user, uint256 rewardWei)",
  "event Ignite(uint256 indexed dayId, address indexed user, uint256 rewardWei)"
];

function $(id){ return document.getElementById(id); }
function setText(id, v){ const el=$(id); if(el) el.textContent = v; }

function fmtNum(n){
  try{ return new Intl.NumberFormat("en-US").format(n); }catch(e){ return String(n); }
}
function shortAddr(a){
  if(!a || a.length < 10) return a || "";
  return a.slice(0,6) + "â€¦" + a.slice(-4);
}
function statusBadge(el, kind, text){
  // kind: ok/warn/err
  el.className = "v " + (kind==="ok"?"ok":kind==="warn"?"warn":"err");
  el.textContent = text;
}

function setDot(id, kind){
  const el = $(id);
  if(!el) return;
  el.classList.remove("ok","warn","bad");
  if(kind==="ok") el.classList.add("ok");
  else if(kind==="warn") el.classList.add("warn");
  else el.classList.add("bad");
}

// ===== Stars canvas =====
function bootStars(){
  const c = $("stars");
  if(!c) return false;
  const ctx = c.getContext("2d");
  let w=0,h=0,stars=[];
  function resize(){
    w = c.width = c.offsetWidth * devicePixelRatio;
    h = c.height = c.offsetHeight * devicePixelRatio;
    stars = Array.from({length:120}, ()=>({
      x: Math.random()*w,
      y: Math.random()*h,
      r: (Math.random()*1.6+0.4)*devicePixelRatio,
      v: (Math.random()*0.5+0.15)*devicePixelRatio
    }));
  }
  resize();
  window.addEventListener("resize", resize);
  (function tick(){
    ctx.clearRect(0,0,w,h);
    ctx.globalAlpha = 0.9;
    for(const s of stars){
      s.y += s.v;
      if(s.y > h){ s.y = -10; s.x = Math.random()*w; }
      ctx.beginPath();
      ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      ctx.fillStyle = "rgba(255,255,255,0.75)";
      ctx.fill();
    }
    requestAnimationFrame(tick);
  })();
  return true;
}

// ===== Provider =====
async function makeProvider(){
  if(!window.ethers) throw new Error("ethers not loaded. Put ethers-5.7.2.umd.min.js into ./assets/");
  let lastErr = null;
  for(const url of CFG.chain.rpcUrls){
    try{
      const p = new ethers.providers.JsonRpcProvider(url);
      await p.getBlockNumber();
      return p;
    }catch(e){
      lastErr = e;
    }
  }
  throw lastErr || new Error("No RPC works");
}

async function refreshChain(provider){
  const net = await provider.getNetwork();
  setText("chainId", String(net.chainId));
  const bn = await provider.getBlockNumber();
  setText("blockNum", String(bn));
  if(net.chainId === CFG.chain.chainIdExpected){
    statusBadge($("rpcStatus"), "ok", "RPC OKï¼ˆè®€éˆæ­£å¸¸ï¼‰");
  }else{
    statusBadge($("rpcStatus"), "warn", `RPC OKï¼ˆchainId=${net.chainId}ï¼‰`);
  }
  return {net, bn};
}

function utcDayStartTs(nowTs){
  // nowTs in seconds (UTC)
  const d = new Date(nowTs*1000);
  const y = d.getUTCFullYear();
  const m = d.getUTCMonth();
  const day = d.getUTCDate();
  const start = Date.UTC(y,m,day,0,0,0)/1000;
  return start;
}

async function callIfExists(contract, method){
  try{
    if(!contract.functions[method]) return {ok:false, v:null};
    const v = await contract[method]();
    return {ok:true, v};
  }catch(e){
    return {ok:false, v:null};
  }
}
async function callIfExists1(contract, method, arg1){
  try{
    if(!contract.functions[method]) return {ok:false, v:null};
    const v = await contract[method](arg1);
    return {ok:true, v};
  }catch(e){
    return {ok:false, v:null};
  }
}

function hhmm(sec){
  const s = Number(sec);
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
}

async function detectGlobalIgnite(provider, heartAddr, heartC, bn){
  // 1) function-first: dayIgnited(dayId)
  // Determine dayId using currentDayIndex()/localDayIdNow()
  let dayIdRes = await callIfExists(heartC, "currentDayIndex");
  if(!dayIdRes.ok) dayIdRes = await callIfExists(heartC, "localDayIdNow");

  if(dayIdRes.ok){
    const dayId = dayIdRes.v;
    const di = await callIfExists1(heartC, "dayIgnited", dayId);
    if(di.ok){
      return {kind:"func", ignited: !!di.v, detail: `dayId=${dayId.toString()}`};
    }
  }

  // 2) event-fallback (near-24h scan)
  // We'll scan last ~36k blocks (approx >24h on BSC) and then filter by UTC day start using block timestamps.
  const fromBlock = Math.max(0, bn - 36000);
  const toBlock = bn;

  const iface = new ethers.utils.Interface(HEART_EVENT_SIGS);
  const topics = [];
  for(const frag of Object.values(iface.events)){
    topics.push(iface.getEventTopic(frag));
  }

  // getLogs for each topic (some nodes cap results; we chunk topics)
  let logs = [];
  for(const t of topics){
    try{
      const got = await provider.getLogs({address: heartAddr, fromBlock, toBlock, topics:[t]});
      logs = logs.concat(got || []);
    }catch(e){
      // ignore per-topic failures
    }
  }
  if(!logs.length){
    return {kind:"event", ignited:false, detail:`no logs (from ${fromBlock})`};
  }

  // Sort newest first
  logs.sort((a,b)=> (b.blockNumber - a.blockNumber) || (b.logIndex - a.logIndex));

  // Determine UTC day window [start, start+86400)
  const nowTs = Math.floor(Date.now()/1000);
  const start = utcDayStartTs(nowTs);
  const end = start + 86400;

  // Walk newest logs; fetch blocks until we find one in today's window
  const blockCache = new Map();
  for(const lg of logs){
    let blk = blockCache.get(lg.blockNumber);
    if(!blk){
      try{
        blk = await provider.getBlock(lg.blockNumber);
        blockCache.set(lg.blockNumber, blk);
      }catch(e){
        continue;
      }
    }
    const ts = Number(blk.timestamp);
    if(ts >= start && ts < end){
      // parse to show dayId if present
      let parsed = null;
      try{ parsed = iface.parseLog(lg); }catch(e){}
      const who = parsed && parsed.args && parsed.args.user ? String(parsed.args.user) : (parsed && parsed.args && parsed.args[0] && String(parsed.args[0]).startsWith("0x") ? String(parsed.args[0]) : "");
      const dayId = parsed && parsed.args && (parsed.args.dayId ?? parsed.args[1]) ? (parsed.args.dayId ?? parsed.args[1]).toString() : "";
      return {kind:"event", ignited:true, detail:`log@${lg.blockNumber} ${who?shortAddr(who):""} ${dayId?("dayId="+dayId):""}`};
    }
    if(ts < start){
      // older than today; we can stop
      break;
    }
  }
  return {kind:"event", ignited:false, detail:`no today's ignite logs`};
}

async function refreshHeart(provider, bn){
  const heart = CFG.addresses.heart12345;
  setText("heartAddr", heart);
  setText("node12345Hint", heart && heart !== ethers.constants.AddressZero ? `Heart: ${shortAddr(heart)}` : "Heart æœªè¨­å®š");

  if(!heart || heart === ethers.constants.AddressZero){
    statusBadge($("heartStatus"), "warn", "Heart æœªè¨­å®šï¼ˆå…ˆéƒ¨ç½²/å¡«å…¥åœ°å€ï¼‰");
    setText("heartBal", "--");
    setText("ignitedToday", "--");
    setText("igniteWindow", "--");
    return {ok:false, igniteOk:false};
  }

  const heartC = new ethers.Contract(heart, HEART_READ_ABI, provider);

  // Token info (use CFG token as canonical)
  const tokenAddr = CFG.addresses.kgenToken;
  const token = new ethers.Contract(tokenAddr, ERC20_ABI, provider);

  const [dec, sym, bal] = await Promise.all([
    token.decimals().catch(()=>18),
    token.symbol().catch(()=> "KGEN"),
    token.balanceOf(heart).catch(()=> ethers.BigNumber.from(0))
  ]);

  // Prefer heartBalanceWhole() if exists (more "å»ºç¯‰é©—æ”¶" friendly)
  let balWhole = null;
  try{
    if(heartC.functions["heartBalanceWhole"]){
      balWhole = await heartC.heartBalanceWhole();
    }
  }catch(e){ balWhole = null; }

  if(balWhole !== null){
    setText("heartBal", fmtNum(balWhole.toString()));
  }else{
    const balFmt = ethers.utils.formatUnits(bal, dec);
    // avoid NaN issues
    const n = Number(balFmt);
    setText("heartBal", Number.isFinite(n) ? fmtNum(n.toFixed(2)) : balFmt);
  }

  // Window: support both igniteWindowStart/End and windowStartSec/windowEndSec
  let ws = null, we = null, inWin = null;

  const ws1 = await callIfExists(heartC, "igniteWindowStart");
  const we1 = await callIfExists(heartC, "igniteWindowEnd");
  if(ws1.ok && we1.ok){
    ws = ws1.v; we = we1.v;
  }else{
    const ws2 = await callIfExists(heartC, "windowStartSec");
    const we2 = await callIfExists(heartC, "windowEndSec");
    if(ws2.ok && we2.ok){
      ws = ws2.v; we = we2.v;
    }
  }
  const in1 = await callIfExists(heartC, "inIgniteWindow");
  if(in1.ok) inWin = !!in1.v;

  if(ws!==null && we!==null){
    setText("igniteWindow", `${hhmm(ws)}â€“${hhmm(we)}${inWin===null?"":(inWin?" (IN)":" (OUT)")}`);
  }else{
    setText("igniteWindow", inWin===null ? "--" : (inWin?"IN":"OUT"));
  }

  // Global ignite (function-first, event-fallback)
  let igniteRes = {kind:"none", ignited:false, detail:""};
  try{
    igniteRes = await detectGlobalIgnite(provider, heart, heartC, bn);
    setText("ignitedToday", igniteRes.ignited ? "YES" : "NO");
  }catch(e){
    setText("ignitedToday", "--");
  }

  // Status line
  statusBadge($("heartStatus"), "ok", `Heart OKï¼ˆ${sym} è¡€é‡å·²è®€å–ï¼‰`);
  return {ok:true, igniteOk:true, igniteRes};
}

// ===== Node detection =====
const NODES = [
  { key:"12345", name:"äº”æŒ‡å±±ãƒ»æ‚Ÿç©ºè²¡ç¥æ®¿", href:"./temples/12345/index.html", path:"./temples/12345/index.html" },
  { key:"18888", name:"éˆéœ„å¯¶æ®¿ãƒ»ç‰å¸é‡‘åº«", href:"./temples/18888/index.html", path:"./temples/18888/index.html" },
  { key:"18921", name:"æ–¬å¦–å°ãƒ»AutoLP/åˆ†æµå¼•æ“", href:"./temples/18921/index.html", path:"./temples/18921/index.html" },
  { key:"MARS",  name:"èŠ±æœå±±ç«æ˜Ÿï¼ˆMARSï¼‰", href:"./temples/MARS/index.html",  path:"./temples/MARS/index.html" }
];

async function probeNode(url){
  // fetch HEAD may be blocked on GH pages sometimes; use GET with cache-bust and small response
  const u = url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();
  try{
    const r = await fetch(u, {method:"GET", cache:"no-store"});
    // GH Pages returns 200 for found; 404 for not found
    return r && r.ok;
  }catch(e){
    return false;
  }
}

async function refreshNodes(){
  const grid = $("nodesGrid");
  if(!grid) return {ok:false, done:0, total:0};
  grid.innerHTML = "";
  let done = 0;

  for(const n of NODES){
    const ok = await probeNode(n.path);
    const card = document.createElement("div");
    card.className = "nodeCard";
    card.innerHTML = `
      <div class="nodeTitle">${n.name}</div>
      <div class="nodeSub">${ok ? "å·²æ–½å·¥å®Œæˆï¼ˆå…¥å£å¯ç”¨ï¼‰" : "æ–½å·¥æº–å‚™ä¸­ï¼ˆæœªåµæ¸¬åˆ° index.htmlï¼‰"}</div>
      <div class="nodeRow">
        <div class="badge ${ok?"ok":"warn"}">${ok ? "OK" : "PENDING"}</div>
        <a href="${ok ? n.href : "javascript:void(0)"}" ${ok ? "" : "onclick=\"alert('æ–½å·¥æº–å‚™ä¸­ï¼šå°šæœªåµæ¸¬åˆ°è©²é»ä½ index.html')\""}>${ok ? "é€²å…¥" : "å°šæœªé–‹æ”¾"}</a>
      </div>
    `;
    grid.appendChild(card);
    if(ok) done++;
  }
  const total = NODES.length;
  const status = $("nodesStatus");
  if(status){
    status.classList.remove("warn","ok","bad");
    status.classList.add(done===total ? "ok" : "warn");
    status.textContent = done===total ? "å…¨éƒ¨å®Œå·¥" : `å·²åµæ¸¬ ${done}/${total}`;
  }
  return {ok:true, done, total};
}

// ===== Visit counters (local) =====
function loadCounters(){
  const key = "kline_portal_stats_v1_2_1";
  let s = null;
  try{ s = JSON.parse(localStorage.getItem(key)||"null"); }catch(e){}
  if(!s) s = { total:0, today:0, dayKey:"" };
  const todayKey = new Date().toISOString().slice(0,10);
  if(s.dayKey !== todayKey){
    s.dayKey = todayKey;
    s.today = 0;
  }
  s.total += 1;
  s.today += 1;
  localStorage.setItem(key, JSON.stringify(s));
  setText("today", String(s.today));
  setText("total", String(s.total));
  return {key, s};
}

function resetCounters(){
  const key = "kline_portal_stats_v1_2_1";
  localStorage.removeItem(key);
  setText("today","0");
  setText("total","0");
}

// ===== Supervisor overlay =====
function bindSupervisor(){
  const btn = $("btnSupervisor");
  const ov = $("supervisorOverlay");
  const close = $("supClose");
  function open(){ ov.classList.add("on"); ov.setAttribute("aria-hidden","false"); }
  function shut(){ ov.classList.remove("on"); ov.setAttribute("aria-hidden","true"); }
  btn && btn.addEventListener("click", open);
  close && close.addEventListener("click", shut);
  ov && ov.addEventListener("click", (e)=>{ if(e.target===ov) shut(); });
}

function setProgress(pct){
  pct = Math.max(0, Math.min(100, pct));
  setText("supPct", pct.toFixed(0) + "%");
  const fill = $("supFill");
  if(fill) fill.style.width = pct + "%";
}

// ===== Clock =====
function bootClock(){
  function tick(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    const ss = String(d.getSeconds()).padStart(2,"0");
    setText("clock", `${hh}:${mm}:${ss}`);
    setText("nowClock", `${hh}:${mm}:${ss}`);
  }
  tick();
  setInterval(tick, 1000);
}

// ===== Error watcher =====
let consoleErrors = 0;
(function(){
  const orig = console.error;
  console.error = function(){
    consoleErrors++;
    try{ orig.apply(console, arguments); }catch(e){}
  };
  window.addEventListener("error", ()=>{ consoleErrors++; });
  window.addEventListener("unhandledrejection", ()=>{ consoleErrors++; });
})();

async function main(){
  // Supervisor baseline
  setDot("chkLoaded","ok");

  // Stars
  const starsOk = bootStars();
  setDot("chkStars", starsOk ? "ok" : "warn");

  // Clock + counters
  bootClock();
  loadCounters();

  // Buttons
  bindSupervisor();
  $("pingBtn")?.addEventListener("click", ()=> alert("å¿ƒè·³æ‰“é»å®Œæˆï¼ˆæœ¬æ©Ÿäº‹ä»¶ï¼‰"));
  $("resetBtn")?.addEventListener("click", ()=> { resetCounters(); alert("å·²é‡ç½®çµ±è¨ˆ"); });

  // Nodes
  let nodeRes = {ok:false, done:0, total:NODES.length};
  try{
    nodeRes = await refreshNodes();
    setDot("chkNodes", nodeRes.ok ? "ok" : "warn");
  }catch(e){
    setDot("chkNodes","warn");
  }

  // Chain/Heart
  let provider = null;
  let chainOk = false;
  let heartOk = false;
  let igniteGlobalOk = false;

  try{
    provider = await makeProvider();
    const {bn} = await refreshChain(provider);
    chainOk = true;

    const h = await refreshHeart(provider, bn);
    heartOk = !!h.ok;

    // global ignite check mark
    igniteGlobalOk = heartOk && !!h.igniteOk;
    setDot("chkIgniteGlobal", igniteGlobalOk ? "ok" : (heartOk ? "warn" : "bad"));
    setDot("chkHeartPanel", heartOk ? "ok" : "bad");

  }catch(e){
    setDot("chkHeartPanel","bad");
    setDot("chkIgniteGlobal","bad");
    statusBadge($("rpcStatus"), "err", "RPC å¤±æ•—ï¼ˆç„¡æ³•è®€éˆï¼‰");
    statusBadge($("heartStatus"), "warn", "Heart æœªè®€å–ï¼ˆç­‰å¾… RPC/åœ°å€ï¼‰");
  }

  // Error dot
  setDot("chkErrors", consoleErrors===0 ? "ok" : "warn");

  // Progress %
  // We weight: loaded 10, stars 10, nodes 20, chain 20, heart 30, global ignite 10
  let pct = 0;
  pct += 10; // loaded
  pct += (starsOk ? 10 : 5);
  pct += (nodeRes.ok ? 20 : 5);
  pct += (chainOk ? 20 : 0);
  pct += (heartOk ? 30 : 0);
  pct += (igniteGlobalOk ? 10 : 0);
  setProgress(pct);

  // periodic refresh (light)
  setInterval(async ()=>{
    try{
      await refreshNodes();
    }catch(e){}
  }, 60_000);

  // periodic on-chain refresh
  setInterval(async ()=>{
    try{
      if(!provider) provider = await makeProvider();
      const {bn} = await refreshChain(provider);
      await refreshHeart(provider, bn);
      setDot("chkErrors", consoleErrors===0 ? "ok" : "warn");
    }catch(e){}
  }, 30_000);
}

document.addEventListener("DOMContentLoaded", main);
</script>

</body>
</html>
