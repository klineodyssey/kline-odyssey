<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Kç·šè¥¿éŠè¨˜ï½œéŠ€æ²³å®‡å®™å…¥å£ï¼ˆPortal V1.3 Â· Global Igniteï¼‰</title>

  <!-- ä½ éœ€è¦æŠŠ ethers æ”¾åœ¨ï¼š/Kç·šè¥¿éŠè¨˜/assets/ethers-5.7.2.umd.min.js -->
  <script src="./assets/ethers-5.7.2.umd.min.js"></script>

  <style>
    :root{
      --bg:#06070b;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --line: rgba(255,255,255,.14);
      --btn: rgba(255,255,255,.12);
      --btnh: rgba(255,255,255,.18);
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --r: 18px;
      --r2: 999px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Heiti TC", Arial, sans-serif;
      --gold: rgba(255,215,0,.95);
      --ok: rgba(120,255,200,.95);
      --warn: rgba(255,210,120,.95);
      --bad: rgba(255,120,120,.95);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 800px at 30% 20%, rgba(120,170,255,.10), transparent 60%),
                  radial-gradient(1000px 700px at 70% 60%, rgba(255,160,220,.08), transparent 55%),
                  var(--bg);
      color: var(--text);
      min-height:100vh;
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 40px;}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 0 14px;}
    .brand{display:flex;flex-direction:column;gap:4px;}
    .brand .h{font-weight:900;letter-spacing:.5px;font-size:18px;}
    .brand .s{font-size:12px;color:var(--muted);}
    .pillrow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .pill{
      display:flex;gap:8px;align-items:center;
      padding:9px 12px;border:1px solid var(--line);border-radius:var(--r2);
      background:rgba(255,255,255,.05);backdrop-filter:blur(8px);box-shadow:var(--shadow);
      font-size:12px;color:var(--muted);white-space:nowrap;
    }
    .pill b{color:var(--text);font-weight:800}
    .mono{font-family:var(--mono)}
    .hero{
      position:relative;border:1px solid var(--line);border-radius:24px;
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow:var(--shadow);overflow:hidden;padding:18px;
    }
    canvas#stars{position:absolute;inset:0;width:100%;height:100%;opacity:.85;pointer-events:none;}
    .heroGrid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;}
    @media (max-width:900px){.heroGrid{grid-template-columns:1fr}}
    .title{font-size:26px;font-weight:950;letter-spacing:.8px;margin:4px 0 8px;}
    .subtitle{color:var(--muted);line-height:1.55;margin:0 0 14px;font-size:13px;}
    .ctaRow{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 14px;border-radius:var(--r2);border:1px solid var(--line);
      background:var(--btn);text-decoration:none;font-weight:850;font-size:13px;transition:.15s;user-select:none;
      cursor:pointer;
    }
    .btn:hover{background:var(--btnh)}
    .btn.small{padding:8px 12px;font-weight:800}
    .grid{display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;margin-top:14px;}
    @media (max-width:900px){.grid{grid-template-columns:1fr 1fr}}
    @media (max-width:520px){.grid{grid-template-columns:1fr}}
    .card{
      border:1px solid var(--line);border-radius:var(--r);background:var(--panel);
      box-shadow:var(--shadow);padding:14px;min-height:110px;position:relative;overflow:hidden;
    }
    .card .k{font-size:12px;color:var(--muted);margin-bottom:6px;letter-spacing:.2px}
    .card .v{font-size:18px;font-weight:950;letter-spacing:.6px}
    .card .t{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .smallText{font-size:12px;color:var(--muted);line-height:1.35}
    .map{
      margin-top:14px;border:1px solid var(--line);border-radius:24px;background:rgba(0,0,0,.20);
      box-shadow:var(--shadow);padding:16px;position:relative;overflow:hidden;
    }
    .mapHead{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .mapHead .h{font-weight:950;letter-spacing:.6px;font-size:16px;}
    .mapHead .s{color:var(--muted);font-size:12px;}
    .nodes{display:grid;grid-template-columns:repeat(4, 1fr);gap:10px;margin-top:10px;}
    @media (max-width:900px){.nodes{grid-template-columns:repeat(2, 1fr)}}
    @media (max-width:520px){.nodes{grid-template-columns:1fr}}
    .node{
      border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.06);
      padding:12px;text-decoration:none;display:flex;flex-direction:column;gap:6px;transition:.15s;min-height:110px;
    }
    .node:hover{background:rgba(255,255,255,.10)}
    .node .n{font-weight:950;letter-spacing:.5px}
    .node .p{color:var(--muted);font-size:12px;line-height:1.35}
    .node .id{color:rgba(255,255,255,.75);font-size:12px;font-family:var(--mono)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.18);font-size:12px;color:var(--muted)}
    .badge strong{color:var(--text)}
    .badge.ok{border-color: rgba(120,255,200,.35); color: rgba(210,255,235,.92)}
    .badge.warn{border-color: rgba(255,210,120,.35); color: rgba(255,238,210,.92)}
    .badge.bad{border-color: rgba(255,120,120,.35); color: rgba(255,210,220,.92)}

    .footer{color:var(--muted);font-size:12px;margin-top:14px;line-height:1.55;padding-bottom:6px;}
    .hr{height:1px;background:var(--line);margin:10px 0}

    /* ===== Supervisor overlay ===== */
    .topRight{
      position:fixed; right:14px; top:14px; z-index:50;
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    .miniPill{
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.18);
      padding:8px 10px;
      border-radius:999px;
      box-shadow: var(--shadow);
      font-size:12px;
      color: var(--text);
      backdrop-filter: blur(8px);
    }
    .miniPill b{ font-family: var(--mono); }
    .supervisorBtn{
      cursor:pointer; user-select:none;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      padding:8px 12px; border-radius:999px;
      box-shadow: var(--shadow);
      font-weight:800;
    }
    .overlay{
      position:fixed; inset:0; z-index:80;
      background: rgba(0,0,0,.72);
      display:none;
    }
    .overlay.on{ display:block; }
    .overlayCard{
      position:absolute; right:14px; top:64px;
      width:min(560px, calc(100vw - 28px));
      background: rgba(10,10,16,.85);
      border:1px solid rgba(255,215,0,.30);
      border-radius: var(--r);
      box-shadow: 0 18px 70px rgba(0,0,0,.65);
      padding:14px;
      backdrop-filter: blur(10px);
      color: var(--text);
    }
    .progressWrap{ margin-top:10px; }
    .progressBar{
      width:100%; height:14px; border-radius:999px;
      background: rgba(255,255,255,.10);
      overflow:hidden; border:1px solid rgba(255,255,255,.14);
    }
    .progressFill{
      height:100%; width:0%;
      background: linear-gradient(90deg, rgba(255,215,0,.95), rgba(255,160,0,.95));
      transition: width .6s ease;
    }
    .chkGrid{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px 10px;
      margin-top:10px;
      font-size:13px;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.25);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 0 10px rgba(255,255,255,.10);
      justify-self:end;
      margin-top:4px;
    }
    .dot.ok{ background: var(--ok); box-shadow:0 0 14px rgba(120,255,200,.45); }
    .dot.warn{ background: var(--warn); box-shadow:0 0 14px rgba(255,210,120,.45); }
    .dot.bad{ background: var(--bad); box-shadow:0 0 14px rgba(255,120,120,.45); }

    /* ===== Global Ignite panel ===== */
    .global{
      margin-top:12px;
      border:1px solid rgba(255,215,0,.20);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding: 12px;
    }
    .globalHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .globalTitle{
      font-weight:950; letter-spacing:.4px;
      display:flex; align-items:center; gap:10px;
    }
    .globalGrid{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .gRow{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      padding: 10px 12px;
      background: rgba(255,255,255,.04);
      display:flex; flex-direction:column; gap:6px;
    }
    .gTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .gName{font-weight:950; letter-spacing:.3px;}
    .gMeta{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .gAddr{font-family:var(--mono); font-size:12px; color: rgba(255,255,255,.78)}
    .copyBtn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:6px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:850;
      font-size:12px;
      user-select:none;
    }
    .copyBtn:hover{ background: rgba(255,255,255,.12); }
    .gBadges{display:flex; gap:8px; flex-wrap:wrap}
  </style>
</head>

<body>

  <div class="topRight">
    <div class="miniPill">ç‰ˆæœ¬ï¼š<b id="uiVersion" class="mono">Portal V1.3</b></div>
    <div class="miniPill">æ™‚é–“ï¼š<b id="nowClock" class="mono">--</b></div>
    <div class="supervisorBtn" id="btnSupervisor">ç›£å·¥æª¢æŸ¥</div>
  </div>

  <div class="overlay" id="supervisorOverlay" aria-hidden="true">
    <div class="overlayCard">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div style="font-weight:950;letter-spacing:.35px;">ç›£å·¥æª¢æŸ¥ï½œPortal V1.3</div>
        <div class="badge" id="supClose" style="cursor:pointer;">é—œé–‰</div>
      </div>
      <div class="progressWrap">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div style="color:var(--muted);font-size:12px;">å·¥ç¨‹é€²åº¦ï¼ˆè‡ªå‹•æª¢æŸ¥ï¼‰</div>
          <div class="badge" id="supPct">0%</div>
        </div>
        <div class="progressBar"><div class="progressFill" id="supFill"></div></div>
      </div>

      <div class="chkGrid" id="supChecks">
        <div>é é¢è¼‰å…¥</div><div class="dot" id="chkLoaded"></div>
        <div>æ˜Ÿç©ºå¼•æ“ï¼ˆCanvasï¼‰</div><div class="dot" id="chkStars"></div>
        <div>ç¯€é»åµæ¸¬ï¼ˆå„æ®¿ index.htmlï¼‰</div><div class="dot" id="chkNodes"></div>
        <div>è®€éˆé¢æ¿ï¼ˆGlobal Igniteï¼‰</div><div class="dot" id="chkGlobal"></div>
        <div>éŒ¯èª¤ç›£çœ‹ï¼ˆConsole æ•æ‰ï¼‰</div><div class="dot" id="chkErrors"></div>
      </div>

      <div style="margin-top:12px;color:var(--muted);font-size:12px;line-height:1.6;">
        èªªæ˜ï¼šPortal æœƒä»¥ <span class="mono">fetch</span> æª¢æŸ¥å„é»ä½æ˜¯å¦å­˜åœ¨ <span class="mono">index.html</span>ï¼Œä¸¦ç”¨å…¬é–‹ RPC è®€éˆï¼Œä¸éœ€è¦éŒ¢åŒ…ã€‚
      </div>
    </div>
  </div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="h">Kç·šè¥¿éŠè¨˜ï½œéŠ€æ²³å®‡å®™å…¥å£</div>
        <div class="s">KLINE Odyssey Â· Map Portal Â· Portal V1.3ï¼ˆæ–°å¢ï¼šå…¨åŸŸé»ç«é¢æ¿ï¼‰</div>
      </div>

      <div class="pillrow">
        <div class="pill">KGEN ç¸½é‡ï¼š<b class="mono" id="supply">72,000,000</b></div>
        <div class="pill">ä»Šæ—¥åƒè¨ªï¼š<b class="mono" id="today">0</b></div>
        <div class="pill">ç¸½åƒè¨ªï¼š<b class="mono" id="total">0</b></div>
      </div>
    </header>

    <section class="hero">
      <canvas id="stars"></canvas>

      <div class="heroGrid">
        <div>
          <div class="title">å®‡å®™ä¸éœ€è¦è§£é‡‹ï¼Œåªéœ€è¦å…¥å£ã€‚</div>
          <p class="subtitle">
            é€™è£¡æ˜¯ã€ŠKç·šè¥¿éŠè¨˜ã€‹çš„åœ°åœ–é–€æˆ¶ã€‚<br/>
            Portal V1.3ï¼šæ–°å¢ã€Œå…¨åŸŸé»ç«ï¼ˆGlobal Igniteï¼‰ã€é¢æ¿ï¼Œå°é½Šæœ€æ–° Heart è®€å–ä»‹é¢ï¼ˆè¡€é‡ / é»ç« / çª—å£ / çå‹µåƒæ•¸ï¼‰ã€‚
          </p>

          <div class="ctaRow">
            <a class="btn" href="#map">ğŸ—ºï¸ é€²å…¥å®‡å®™åœ°åœ–</a>
            <a class="btn" href="./README.md">ğŸ“˜ æŸ¥çœ‹è³‡æ–™èªªæ˜</a>
            <a class="btn small" href="https://t.me/klineodyssey" target="_blank" rel="noreferrer">Telegram</a>
            <a class="btn small" href="https://lin.ee/b8X18F7" target="_blank" rel="noreferrer">LINE å®˜æ–¹</a>
          </div>

          <div class="hr"></div>

          <div class="smallText">
            RPC æ¨¡å¼ï¼šé è¨­ç”¨å…¬é–‹ RPC è®€éˆï¼ˆä¸éœ€è¦éŒ¢åŒ…ï¼‰ã€‚<br/>
            ä¹‹å¾Œè‹¥è¦åœ¨ Portal ç›´æ¥åšã€Œä¸€éµé»ç« / å¿ƒè·³ã€ï¼Œå†æ”¹æˆé€£éŒ¢åŒ…æ¨¡å¼ï¼ˆæœ¬ç‰ˆå…ˆä¿è®€éˆç©©å®šï¼‰ã€‚
          </div>

          <div class="global" id="globalPanel">
            <div class="globalHead">
              <div class="globalTitle">ğŸ”¥ å…¨åŸŸé»ç«ï¼ˆGlobal Igniteï¼‰</div>
              <div class="gBadges">
                <span class="badge" id="globalChain">CHAIN: <strong class="mono" id="chainId">--</strong></span>
                <span class="badge" id="globalBlock">BLOCK: <strong class="mono" id="blockNum">--</strong></span>
                <span class="badge warn" id="globalIgnite">GLOBAL: <strong class="mono" id="globalIgniteText">--</strong></span>
              </div>
            </div>

            <div class="globalGrid" id="globalGrid"></div>

            <div class="smallText" style="margin-top:10px;">
              è¨­å®šï¼šè«‹åœ¨æœ¬æª”æ¡ˆæœ€ä¸‹æ–¹ <span class="mono">CFG.addresses</span> å¡«ä¸Šå·²éƒ¨ç½²çš„åˆç´„åœ°å€ã€‚<br/>
              è‹¥ Heart å°šæœªä¸Šéˆæˆ–åœ°å€æœªå¡«ï¼Œè©²åˆ—æœƒé¡¯ç¤ºã€Œæœªè¨­å®šã€ä¸¦ä¸å½±éŸ¿å…¶ä»–é»ä½è®€å–ã€‚
            </div>
          </div>
        </div>

        <div class="grid">
          <div class="card">
            <div class="k">ç•¶å‰ç¯€å¾‹ï¼ˆæœ¬æ©Ÿï¼‰</div>
            <div class="v mono" id="clock">--:--:--</div>
            <div class="t">
              <span class="btn small" id="pingBtn">ğŸ”” å¿ƒè·³æ‰“é»</span>
              <span class="btn small" id="resetBtn">â™»ï¸ é‡ç½®çµ±è¨ˆ</span>
            </div>
          </div>

          <div class="card">
            <div class="k">éˆä¸Šé€£ç·š</div>
            <div class="v" style="font-size:14px;font-weight:900;" id="rpcStatus">å°šæœªæª¢æ¸¬</div>
            <div class="t">
              <span class="badge">RPC: <b class="mono" id="rpcNow">--</b></span>
              <span class="badge">STATUS: <b class="mono" id="rpcCode">--</b></span>
            </div>
          </div>

          <div class="card">
            <div class="k">å¿«é€Ÿæç¤º</div>
            <div class="v" style="font-size:14px;font-weight:900;">å…¥å£åªåšå°èˆªï¼‹è®€éˆ</div>
            <div class="t">
              <span class="badge">Temple: <b class="mono">/Kç·šè¥¿éŠè¨˜/temples/</b></span>
              <span class="badge">Assets: <b class="mono">/Kç·šè¥¿éŠè¨˜/assets/</b></span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <div style="font-weight:950;letter-spacing:.35px;">æ™‚å…‰éš§é“ï½œå®‡å®™å…¥å£åˆ—è¡¨</div>
        <div class="badge warn" id="nodesStatus">åµæ¸¬ä¸­â€¦</div>
      </div>
      <div class="smallText" style="margin-top:8px;">
        é»ä½å°šæœªæ–½å·¥å®Œæˆæ™‚ï¼Œå…¥å£æœƒé¡¯ç¤ºã€Œæ–½å·¥æº–å‚™ä¸­ã€ã€‚åµæ¸¬åˆ°æª”æ¡ˆå¾Œè‡ªå‹•äº®ç‡ˆã€‚
      </div>

      <div id="nodesGrid" style="margin-top:12px;display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:12px;">
      </div>
    </section>

    <section class="map" id="map">
      <div class="mapHead">
        <div>
          <div class="h">å®‡å®™ç¯€é»å°èˆª</div>
          <div class="s">æ¯å€‹æ®¿å„è‡ª index.htmlï¼›å…¥å£åªåšå°èˆªï¼‹è®€éˆç‹€æ…‹</div>
        </div>
        <div class="s mono" id="pathHint">/Kç·šè¥¿éŠè¨˜/index.html</div>
      </div>

      <div class="nodes">
        <a class="node" href="./temples/12345/index.html" data-node="12345">
          <div class="n">äº”æŒ‡å±±ãƒ»æ‚Ÿç©ºè²¡ç¥æ®¿</div>
          <div class="id">12345</div>
          <div class="p">Heart / ç™¼è²¡é‡‘ / å‘¼å¸å¿ƒè·³ / é‚„é¡˜ / è¨±é¡˜ / å…‰æ˜ç‡ˆ / å½±åƒè‡ªçœ‹</div>
          <div class="p mono" id="node12345Hint">Heart æœªè¨­å®š</div>
        </a>

        <a class="node" href="javascript:void(0)" data-node="18888">
          <div class="n">éˆéœ„å¯¶æ®¿ãƒ»ç‰å¸é‡‘åº«</div>
          <div class="id">18888</div>
          <div class="p">ç¥æ˜éŠ€è¡Œ / 0.1% ç¨…æ¥æ”¶ / Pull Claim / æ¯æœˆ 5 æ—¥çµç®—</div>
          <div class="p mono" id="node18888Hint">æ–½å·¥æº–å‚™ä¸­</div>
        </a>

        <a class="node" href="javascript:void(0)" data-node="18921">
          <div class="n">æ–¬å¦–å°ãƒ»AutoLP/åˆ†æµ</div>
          <div class="id">18921</div>
          <div class="p">AutoLP 0.05% / æ–¬å¦–åˆ†æµ splitter / æ´»å‹•å¼•æ“</div>
          <div class="p mono" id="node18921Hint">æ–½å·¥æº–å‚™ä¸­</div>
        </a>

        <a class="node" href="javascript:void(0)" data-node="108000">
          <div class="n">èŠ±æœå±±ç«æ˜Ÿï¼ˆMARSï¼‰</div>
          <div class="id">108000</div>
          <div class="p">è±ªå®… 500 å¸­ / 5000 KGEN å…¥ä½ / Brain æœˆæ’¥ä»˜åˆ†æ½¤</div>
          <div class="p mono" id="node108000Hint">æ–½å·¥æº–å‚™ä¸­</div>
        </a>
      </div>

      <div class="footer">
        Portal V1.3 æ–°å¢ï¼šå…¨åŸŸé»ç«é¢æ¿ï¼ˆå¯åŒæ™‚è¿½è¹¤å¤šå€‹ Heartï¼‰ã€‚<br/>
        æœ¬é ä¸æ”¾ã€Œå®¢æœï¼ç›¸æ©Ÿï¼è¨±é¡˜ã€é¿å…æ“ çˆ†å…¥å£ï¼›é‚£äº›ç•™åœ¨å„ Templeã€‚
      </div>
    </section>

    <div class="footer" style="margin-top:14px;">
      PrimeForge ä»¥æ¯æ©Ÿä¹‹åï¼Œé–‹å•Ÿé‡‘èç”Ÿå‘½ã€‚<br/>
      èŠ±æœå±±å°ç£ãƒ»ä¿¡å¿µä¸æ»…ãƒ»å¸‚å ´ç„¡ç•Œã€‚<br/>
      Where the Market Becomes the Myth.<br/>
      â€”â€” æ¨‚å¤©å¸ âŒ–
    </div>
  </div>

<script>
/* =========================
   Portal V1.3 â€” Global Ignite (BSC)
   - No wallet required (default JsonRpcProvider)
   - Multi-heart support
   ========================= */

const CFG = {
  chain: {
    name: "BSC",
    chainIdExpected: 56,
    rpcUrls: [
      "https://bsc-dataseed.binance.org/",
      "https://bsc-dataseed1.binance.org/",
      "https://bsc-dataseed2.binance.org/"
    ]
  },
  addresses: {
    // å·²éƒ¨ç½²ï¼ˆä½ æä¾›ï¼‰
    kgenToken: "0xBA3d3810e58735cb6813bC1CDc5458C0d71432Be",
    // Heartï¼ˆéƒ¨ç½²å¾Œå¡«ï¼‰
    heart12345: "0x0000000000000000000000000000000000000000",

    // æœªä¸Šéˆè€…å…ˆç•™ç©ºæˆ– 0x0ï¼ˆä¸å½±éŸ¿è®€å–ï¼‰
    bank18888: "0x0000000000000000000000000000000000000000",
    mars108000: "0x0000000000000000000000000000000000000000",
    splitter18921: "0x0000000000000000000000000000000000000000"
  },
  nodesToProbe: [
    { id:"12345", name:"äº”æŒ‡å±±ãƒ»æ‚Ÿç©ºè²¡ç¥æ®¿", path:"./temples/12345/index.html" },
    { id:"108000", name:"èŠ±æœå±±ç«æ˜Ÿãƒ»é½Šå¤©è±ªå®…", path:"./temples/108000/index.html" },
    { id:"18888", name:"éˆéœ„å¯¶æ®¿ãƒ»ç‰å¸é‡‘åº«", path:"./temples/18888/index.html" },
    { id:"18921", name:"æ–¬å¦–å°ãƒ»AutoLP/åˆ†æµ", path:"./temples/18921/index.html" },
  ]
};

// Minimal ABIs
const ERC20_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)"
];

// Heart ABI (read-only subset aligned to your Portal V1.2)
const HEART_ABI = [
  "function token() view returns (address)",
  "function windowStartSec() view returns (uint32)",
  "function windowEndSec() view returns (uint32)",
  "function inIgniteWindow() view returns (bool)",
  "function localDayIdNow() view returns (uint256)",
  "function dayIgnited(uint256) view returns (bool)",
  "function igniteReward() view returns (uint256)",
  "function heartbeatReward() view returns (uint256)"
];

function $(id){ return document.getElementById(id); }
function setText(id, v){ const el=$(id); if(el) el.textContent = v; }

function fmtNum(n){
  try{ return new Intl.NumberFormat("en-US").format(n); }catch(e){ return String(n); }
}
function shortAddr(a){
  if(!a || a.length < 10) return a || "";
  return a.slice(0,6) + "â€¦" + a.slice(-4);
}
function isZero(a){
  return !a || a.toLowerCase() === "0x0000000000000000000000000000000000000000";
}
function setBadge(el, kind, text){
  if(!el) return;
  el.classList.remove("ok","warn","bad");
  if(kind) el.classList.add(kind);
  el.textContent = text;
}

function copyText(text){
  const t = String(text || "");
  if(!t) return;
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(t).catch(()=>{});
  }else{
    const ta = document.createElement("textarea");
    ta.value = t; document.body.appendChild(ta); ta.select();
    try{ document.execCommand("copy"); }catch(e){}
    document.body.removeChild(ta);
  }
}

/* ===== Supervisor ===== */
const SUP = { loaded:false, stars:false, nodes:false, global:false, errors:false };
function setDot(id, kind){
  const el = $(id);
  if(!el) return;
  el.classList.remove("ok","warn","bad");
  el.classList.add(kind);
}
function updateSupervisor(){
  const checks = [
    ["chkLoaded", SUP.loaded ? "ok":"bad"],
    ["chkStars",  SUP.stars  ? "ok":"warn"],
    ["chkNodes",  SUP.nodes  ? "ok":"warn"],
    ["chkGlobal", SUP.global ? "ok":"warn"],
    ["chkErrors", SUP.errors ? "warn":"ok"],
  ];
  let okCount = 0;
  for(const [id, kind] of checks){
    setDot(id, kind);
    if(kind === "ok") okCount++;
  }
  const pct = Math.round((okCount / checks.length) * 100);
  setText("supPct", `${pct}%`);
  const fill = $("supFill"); if(fill) fill.style.width = `${pct}%`;
}

/* ===== Starfield ===== */
function startStars(){
  const c = $("stars");
  if(!c) return false;
  const ctx = c.getContext("2d");
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  let w=0,h=0, stars=[];
  function resize(){
    w = c.clientWidth; h = c.clientHeight;
    c.width = Math.floor(w*dpr);
    c.height = Math.floor(h*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    stars = [];
    const n = Math.min(140, Math.floor((w*h)/9000));
    for(let i=0;i<n;i++){
      stars.push({x:Math.random()*w, y:Math.random()*h, r:Math.random()*1.6+0.2, a:Math.random()*0.75+0.1, s:Math.random()*0.3+0.05});
    }
  }
  function tick(){
    ctx.clearRect(0,0,w,h);
    for(const s of stars){
      s.y += s.s; if(s.y > h) s.y = 0;
      ctx.globalAlpha = s.a;
      ctx.fillStyle = "white";
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
      ctx.fill();
    }
    requestAnimationFrame(tick);
  }
  window.addEventListener("resize", resize);
  resize(); tick();
  return true;
}

/* ===== Provider ===== */
let provider = null;
let providerUrl = "";
async function makeProvider(){
  if(!window.ethers) throw new Error("ethers not loaded. Put ethers-5.7.2.umd.min.js into /Kç·šè¥¿éŠè¨˜/assets/");
  let lastErr = null;
  for(const url of CFG.chain.rpcUrls){
    try{
      const p = new ethers.providers.JsonRpcProvider(url);
      await p.getBlockNumber();
      providerUrl = url;
      return p;
    }catch(e){
      lastErr = e;
    }
  }
  throw lastErr || new Error("No RPC works");
}

async function refreshChain(){
  const net = await provider.getNetwork();
  const bn = await provider.getBlockNumber();
  setText("chainId", String(net.chainId));
  setText("blockNum", String(bn));
  setText("rpcNow", providerUrl ? shortAddr(providerUrl) : "--");
  setText("rpcCode", "OK");
  if(net.chainId === CFG.chain.chainIdExpected){
    $("rpcStatus").textContent = "RPC OKï¼ˆè®€éˆæ­£å¸¸ï¼‰";
    $("rpcStatus").style.color = "rgba(210,255,235,.92)";
  }else{
    $("rpcStatus").textContent = `RPC OKï¼ˆchainId=${net.chainId}ï¼‰`;
    $("rpcStatus").style.color = "rgba(255,238,210,.92)";
  }
}

/* ===== Global Ignite ===== */
function heartsList(){
  return [
    { id:"12345", name:"äº”æŒ‡å±± Heartï¼ˆ12345ï¼‰", addr: CFG.addresses.heart12345 }
    // ä¹‹å¾Œè¦åŠ æ–° Heartï¼Œåªè¦åœ¨é€™è£¡å¤šåŠ ä¸€åˆ—å³å¯ï¼š
    // { id:"xxxxx", name:"æŸæŸ Heartï¼ˆxxxxxï¼‰", addr:"0x..." }
  ];
}

function hhmm(sec){
  const s = Number(sec || 0);
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
}

async function readHeartRow(h){
  const grid = $("globalGrid");
  const rowId = `heartRow_${h.id}`;
  let row = $(rowId);

  if(!row){
    row = document.createElement("div");
    row.className = "gRow";
    row.id = rowId;
    row.innerHTML = `
      <div class="gTop">
        <div>
          <div class="gName" id="${rowId}_name"></div>
          <div class="gAddr" id="${rowId}_addr"></div>
        </div>
        <div class="gMeta">
          <span class="copyBtn" id="${rowId}_copy">Copy</span>
          <span class="badge warn" id="${rowId}_state">å¾…æª¢æ¸¬</span>
        </div>
      </div>
      <div class="gBadges">
        <span class="badge" id="${rowId}_bal">è¡€é‡: <strong class="mono">--</strong> KGEN</span>
        <span class="badge" id="${rowId}_ignite">ä»Šæ—¥é»ç«: <strong class="mono">--</strong></span>
        <span class="badge" id="${rowId}_window">çª—å£: <strong class="mono">--</strong></span>
        <span class="badge" id="${rowId}_inwin">inWindow: <strong class="mono">--</strong></span>
        <span class="badge" id="${rowId}_reward">ignite/heartbeat: <strong class="mono">--</strong></span>
      </div>
    `;
    grid.appendChild(row);
    $( `${rowId}_copy`).addEventListener("click", ()=> copyText(h.addr));
  }

  setText(`${rowId}_name`, h.name);
  setText(`${rowId}_addr`, isZero(h.addr) ? "æœªè¨­å®šï¼ˆè«‹å¡«åˆç´„åœ°å€ï¼‰" : h.addr);

  if(isZero(h.addr)){
    setBadge($( `${rowId}_state`), "warn", "æœªè¨­å®š");
    setText(`${rowId}_bal`, "è¡€é‡: -- KGEN");
    setText(`${rowId}_ignite`, "ä»Šæ—¥é»ç«: --");
    setText(`${rowId}_window`, "çª—å£: --");
    setText(`${rowId}_inwin`, "inWindow: --");
    setText(`${rowId}_reward`, "ignite/heartbeat: --");
    return { ok:false, ignited:false };
  }

  const tokenAddr = CFG.addresses.kgenToken;
  const token = new ethers.Contract(tokenAddr, ERC20_ABI, provider);
  const heartC = new ethers.Contract(h.addr, HEART_ABI, provider);

  try{
    const [dec, bal, ws, we, inWin, dayId, ignited, ir, hr] = await Promise.all([
      token.decimals().catch(()=>18),
      token.balanceOf(h.addr).catch(()=> ethers.BigNumber.from(0)),
      heartC.windowStartSec(),
      heartC.windowEndSec(),
      heartC.inIgniteWindow(),
      heartC.localDayIdNow(),
      heartC.localDayIdNow().then(d=>heartC.dayIgnited(d)).catch(()=>false),
      heartC.igniteReward().catch(()=> ethers.BigNumber.from(0)),
      heartC.heartbeatReward().catch(()=> ethers.BigNumber.from(0))
    ]);

    const balFmt = Number(ethers.utils.formatUnits(bal, dec));
    setText(`${rowId}_bal`, `è¡€é‡: ${fmtNum(balFmt.toFixed(2))} KGEN`);
    setText(`${rowId}_ignite`, `ä»Šæ—¥é»ç«: ${ignited ? "YES" : "NO"}`);
    setText(`${rowId}_window`, `çª—å£: ${hhmm(ws)}-${hhmm(we)}`);
    setText(`${rowId}_inwin`, `inWindow: ${inWin ? "YES" : "NO"}`);

    const irFmt = Number(ethers.utils.formatUnits(ir, dec));
    const hrFmt = Number(ethers.utils.formatUnits(hr, dec));
    setText(`${rowId}_reward`, `ignite/heartbeat: ${fmtNum(irFmt)} / ${fmtNum(hrFmt)} KGEN`);

    setBadge($( `${rowId}_state`), ignited ? "ok" : (inWin ? "warn" : "warn"), ignited ? "å·²é»ç«" : (inWin ? "çª—å£ä¸­" : "æœªé»ç«"));
    return { ok:true, ignited: !!ignited, inWin: !!inWin, dayId: String(dayId) };
  }catch(e){
    setBadge($( `${rowId}_state`), "bad", "è®€å–å¤±æ•—");
    return { ok:false, ignited:false, err: e };
  }
}

async function refreshGlobalIgnite(){
  const hs = heartsList();
  $("globalGrid").innerHTML = "";
  let anyIgnited = false;
  let allOk = true;
  let dayIdRef = null;
  for(const h of hs){
    const r = await readHeartRow(h);
    if(!r.ok) allOk = false;
    if(r.ignited) anyIgnited = true;
    if(!dayIdRef && r.dayId) dayIdRef = r.dayId;
  }

  // Global ignite logic: åªè¦ä»»ä¸€ Heart ä»Šæ—¥å·²é»ç« => GLOBAL=YES
  if(anyIgnited){
    setBadge($("globalIgnite"), "ok", "GLOBAL: YES");
    setText("globalIgniteText", "YES");
  }else{
    setBadge($("globalIgnite"), "warn", "GLOBAL: NO");
    setText("globalIgniteText", "NO");
  }

  SUP.global = allOk;
}

/* ===== Nodes probe ===== */
async function probeNodes(){
  const grid = $("nodesGrid");
  grid.innerHTML = "";
  const results = [];
  for(const n of CFG.nodesToProbe){
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="k">${n.name}</div>
      <div class="v mono">${n.id}</div>
      <div class="t">
        <span class="badge warn" id="probe_${n.id}">åµæ¸¬ä¸­â€¦</span>
        <a class="btn small" href="${n.path}" target="_blank" rel="noreferrer">é–‹å•Ÿ</a>
      </div>
      <div class="smallText mono" style="margin-top:10px;opacity:.85;">${n.path}</div>
    `;
    grid.appendChild(card);

    try{
      const res = await fetch(n.path, { method:"GET", cache:"no-store" });
      if(res.ok){
        setBadge($( `probe_${n.id}` ), "ok", "å·²æ–½å·¥ï¼ˆindex.html OKï¼‰");
        results.push(true);
        // update node hint lines
        if(n.id === "12345") setText("node12345Hint", "å…¥å£å¯ç”¨");
        if(n.id === "108000") setText("node108000Hint", "å…¥å£å¯ç”¨");
        if(n.id === "18888") setText("node18888Hint", "å…¥å£å¯ç”¨");
        if(n.id === "18921") setText("node18921Hint", "å…¥å£å¯ç”¨");
      }else{
        setBadge($( `probe_${n.id}` ), "warn", "æ–½å·¥æº–å‚™ä¸­");
        results.push(false);
      }
    }catch(e){
      setBadge($( `probe_${n.id}` ), "bad", "åµæ¸¬å¤±æ•—");
      results.push(false);
    }
  }
  const okCount = results.filter(Boolean).length;
  if(okCount === results.length){
    setBadge($("nodesStatus"), "ok", `å…¨éƒ¨äº®ç‡ˆï¼ˆ${okCount}/${results.length}ï¼‰`);
  }else{
    setBadge($("nodesStatus"), "warn", `éƒ¨åˆ†æ–½å·¥ï¼ˆ${okCount}/${results.length}ï¼‰`);
  }
  SUP.nodes = okCount > 0;
}

/* ===== Visit counters ===== */
const VISIT_KEY = "KLINE_PORTAL_VISITS_V1";
function getDayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${y}${m}${dd}`;
}
function loadVisits(){
  try{
    const raw = localStorage.getItem(VISIT_KEY);
    return raw ? JSON.parse(raw) : { total:0, daily:{} };
  }catch(e){
    return { total:0, daily:{} };
  }
}
function saveVisits(v){ localStorage.setItem(VISIT_KEY, JSON.stringify(v)); }
function bumpVisits(){
  const v = loadVisits();
  v.total = (v.total||0) + 1;
  const dk = getDayKey();
  v.daily[dk] = (v.daily[dk]||0) + 1;
  saveVisits(v);
  setText("total", String(v.total));
  setText("today", String(v.daily[dk]));
}

/* ===== Clock ===== */
function startClock(){
  function tick(){
    const d = new Date();
    const t = d.toLocaleTimeString("en-GB");
    setText("clock", t);
    setText("nowClock", t);
  }
  tick(); setInterval(tick, 1000);
}

/* ===== Init ===== */
window.addEventListener("error", (e)=>{ SUP.errors = true; updateSupervisor(); });

$("btnSupervisor").addEventListener("click", ()=>{
  $("supervisorOverlay").classList.add("on");
  updateSupervisor();
});
$("supClose").addEventListener("click", ()=>{
  $("supervisorOverlay").classList.remove("on");
});
$("supervisorOverlay").addEventListener("click", (e)=>{
  if(e.target === $("supervisorOverlay")) $("supervisorOverlay").classList.remove("on");
});

$("pingBtn").addEventListener("click", ()=> bumpVisits());
$("resetBtn").addEventListener("click", ()=>{
  localStorage.removeItem(VISIT_KEY);
  bumpVisits();
});

(async function boot(){
  SUP.loaded = true;

  startClock();
  bumpVisits();

  // Stars
  SUP.stars = !!startStars();

  // Provider + chain + global
  try{
    provider = await makeProvider();
    await refreshChain();
    SUP.global = true;
    setText("rpcNow", providerUrl ? shortAddr(providerUrl) : "--");
    await refreshGlobalIgnite();
  }catch(e){
    $("rpcStatus").textContent = "RPC å¤±æ•—ï¼ˆç„¡æ³•è®€éˆï¼‰";
    $("rpcStatus").style.color = "rgba(255,210,220,.92)";
    setText("rpcCode", "FAIL");
    SUP.global = false;
  }

  // Nodes
  await probeNodes();

  updateSupervisor();
})();
</script>

</body>
</html>
