<!--
悟空財神廟｜互動循環 V0.2（可回饋・可記錄・三還願地址）
File: /kline-odyssey/wukong-temple/index.html
Deploy: GitHub Pages
-->

<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>悟空財神廟｜Wukong Temple</title>
  <meta name="description" content="悟空財神廟｜互動式遊戲入口：參觀、選擇、體驗，然後離開。" />
</head>

<body>
<div style="max-width:760px;margin:22px auto;padding:16px;">

  <!-- Brand Header -->
  <div style="margin-bottom:10px;">
    <div style="font-weight:900;font-size:22px;line-height:1.2;">
      🐒 悟空財神廟｜Wukong Temple
    </div>
    <div style="margin-top:6px;font-weight:800;">
      #悟空新文 #K線西遊記 #花果山台灣
    </div>
    <div style="margin-top:8px;">
      <a href="https://klineodyssey.github.io/kline-odyssey/"
         target="_blank" rel="noopener"
         style="text-decoration:none;font-weight:900;">
        https://klineodyssey.github.io/kline-odyssey/
      </a>
    </div>
  </div>

  <!-- One-sentence rule -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="font-weight:900;">規則一句話</div>
    <div style="line-height:1.75;margin-top:6px;">
      這裡是<strong>互動式遊戲入口</strong>：參觀、選擇、體驗，然後離開。<br/>
      不承諾收益、不提供投資建議、不做回報保證。
    </div>
  </div>

  <!-- Live Status Panel -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="font-weight:900;">📜 你的參拜紀錄（本機瀏覽器）</div>
    <div id="statusText" style="margin-top:8px;line-height:1.9;"></div>
    <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;">
      <button id="btnExport"
        style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
        ⬇️ 匯出紀錄 JSON
      </button>
      <button id="btnClear"
        style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
        🧹 清除本機紀錄
      </button>
    </div>
    <div id="toast" style="margin-top:10px;font-weight:900;"></div>
  </div>

  <!-- Main Action Buttons -->
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin:14px 0;">

    <button id="btnVisit"
      style="text-align:left;cursor:pointer;padding:14px 14px;border:1px solid #111;border-radius:14px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">🏮 登入參拜</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">
        確認存在 → 進入前庭（會記錄）
      </div>
    </button>

    <a href="/kline-odyssey/bookstore/"
       style="display:block;padding:14px 14px;border:1px solid #111;border-radius:14px;text-decoration:none;background:#fff;">
      <div style="font-weight:900;font-size:16px;">📘 領書｜悟空書城</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">
        連結到書城／內容兌換
      </div>
    </a>

    <button id="btnFortune"
      style="text-align:left;cursor:pointer;padding:14px 14px;border:1px solid #111;border-radius:14px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">🧧 領發財金（遊戲事件）</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">
        一天一次｜同地址冷卻（本機）
      </div>
    </button>

    <button id="btnDivination"
      style="text-align:left;cursor:pointer;padding:14px 14px;border:1px solid #111;border-radius:14px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">🥢 搏杯</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">
        聖筊連勝 → 2 的 N 次方節奏
      </div>
    </button>

    <button id="btnBurn"
      style="text-align:left;cursor:pointer;padding:14px 14px;border:1px solid #111;border-radius:14px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">🔥 還願（選三個地址之一）</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">
        感恩與轉換｜顯示地址＋一鍵複製＋各自冷卻
      </div>
    </button>

    <button id="btnExit"
      style="text-align:left;cursor:pointer;padding:14px 14px;border:1px solid #111;border-radius:14px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">🚪 登出離開</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">
        結束參拜｜完成紀錄
      </div>
    </button>

  </div>

  <!-- Vow Panel: 3 address options + copy + cooldown -->
  <div id="vowPanel"
       style="display:none;border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:14px 0;">

    <div style="font-weight:900;margin-bottom:8px;">
      🔥 請選擇還願去向（必選）
    </div>

    <div style="opacity:.9;line-height:1.7;margin-bottom:10px;">
      這是<strong>感恩</strong>與<strong>能量轉換</strong>的敘事行為。<br/>
      系統只記錄「你選了哪一個去向」，不保證、不承諾、不上鏈。
    </div>

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;">

      <!-- Blackhole -->
      <div style="border:1px solid #111;border-radius:14px;padding:12px;">
        <div style="font-weight:900;">🕳 黑洞燃燒</div>
        <div style="opacity:.85;font-size:13px;line-height:1.6;margin-top:6px;">
          進黑洞・轉化完成（故事節點）
        </div>
        <div style="margin-top:8px;font-size:13px;word-break:break-all;">
          地址：<span id="addr_blackhole" style="font-weight:900;"></span>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
          <button type="button" data-copy="blackhole"
            style="cursor:pointer;padding:8px 10px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
            複製地址
          </button>
          <button type="button" data-vow="blackhole"
            style="cursor:pointer;padding:8px 10px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
            選這個還願
          </button>
        </div>
        <div id="cool_blackhole" style="margin-top:8px;opacity:.85;font-size:13px;"></div>
      </div>

      <!-- Engine -->
      <div style="border:1px solid #111;border-radius:14px;padding:12px;">
        <div style="font-weight:900;">🚀 引擎補油</div>
        <div style="opacity:.85;font-size:13px;line-height:1.6;margin-top:6px;">
          補油到引擎室・推動 KUFO 前進
        </div>
        <div style="margin-top:8px;font-size:13px;word-break:break-all;">
          地址：<span id="addr_engine" style="font-weight:900;"></span>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
          <button type="button" data-copy="engine"
            style="cursor:pointer;padding:8px 10px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
            複製地址
          </button>
          <button type="button" data-vow="engine"
            style="cursor:pointer;padding:8px 10px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
            選這個還願
          </button>
        </div>
        <div id="cool_engine" style="margin-top:8px;opacity:.85;font-size:13px;"></div>
      </div>

      <!-- Public Good -->
      <div style="border:1px solid #111;border-radius:14px;padding:12px;">
        <div style="font-weight:900;">🤲 社會還願</div>
        <div style="opacity:.85;font-size:13px;line-height:1.6;margin-top:6px;">
          公益・震災・自由民主（故事用途）
        </div>
        <div style="margin-top:8px;font-size:13px;word-break:break-all;">
          地址：<span id="addr_public_good" style="font-weight:900;"></span>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
          <button type="button" data-copy="public_good"
            style="cursor:pointer;padding:8px 10px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
            複製地址
          </button>
          <button type="button" data-vow="public_good"
            style="cursor:pointer;padding:8px 10px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
            選這個還願
          </button>
        </div>
        <div id="cool_public_good" style="margin-top:8px;opacity:.85;font-size:13px;"></div>
      </div>

    </div>

    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
      <button type="button" id="btnVowCancel"
        style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
        取消
      </button>
    </div>

    <div style="margin-top:10px;opacity:.85;line-height:1.7;">
      （提示：冷卻與紀錄只存在你的瀏覽器本機，不上鏈、不上傳。）
    </div>
  </div>

  <!-- AI Voice Service -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:14px 0;">
    <div style="font-weight:900;">🎧 AI 語音客服（中文台詞｜可直接照唸）</div>
    <div style="margin-top:8px;line-height:1.85;">
      歡迎來到五指山悟空財神廟。<br/>
      這裡是互動式遊戲入口，不是投資平台。<br/>
      你可以參觀、選擇、體驗，然後離開。<br/><br/>
      發財金是遊戲事件，一天一次，完成就冷卻。<br/>
      還願代表感恩與轉換，你會看到三個去向地址，選一個就完成記錄。<br/>
      所有紀錄只在本機，不上鏈、不上傳、不承諾任何回報。<br/><br/>
      想開始就按「登入參拜」。想離開就按「登出離開」。
    </div>
  </div>

  <!-- Physics metaphor -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:14px 0;">
    <div style="font-weight:900;">⚙️ 世界觀提示（隱喻，不是承諾）</div>
    <div style="margin-top:8px;line-height:1.85;">
      在 Kline Odyssey 敘事裡，K G E N 被視為「質量」的象徵。<br/>
      E = m c² 與 W = m g h 是世界觀隱喻，用來描述「選擇造成能量轉換」。<br/>
      公式不代表現實保證、不代表收益、不代表兌換。
    </div>
  </div>

  <!-- Log Preview -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:14px 0;">
    <div style="font-weight:900;">🧾 行為日誌（最近 20 筆）</div>
    <pre id="logPreview"
      style="margin-top:10px;white-space:pre-wrap;word-break:break-word;line-height:1.6;background:#fafafa;border:1px solid #ddd;border-radius:12px;padding:10px;"></pre>
  </div>

  <!-- Footer signature (固定章) -->
  <div style="margin-top:14px;padding-top:12px;border-top:1px solid #111;line-height:1.8;">
    悟空不保證你得到什麼，<br/>
    只陪你走過一次選擇。<br/><br/>
    PrimeForge 以母機之名，開啟金融生命。<br/>
    花果山台灣・信念不滅・市場無界。<br/>
    Where the Market Becomes the Myth.<br/>
    —— 樂天帝 ⌖
  </div>

</div>

<script>
(() => {
  "use strict";

  // ====== Storage Key ======
  const KEY = "klineodyssey_wukongTemple_v0_2";

  // ====== Addresses (replace these 3 if you have real ones) ======
  // 你若要換成真地址：直接改這三行就好
  const VOW_ADDR = {
    blackhole: "0x000000000000000000000000000000000000dEaD",
    engine: "0x0000000000000000000000000000000000000000",
    public_good: "0x0000000000000000000000000000000000000000"
  };

  // ====== Helpers ======
  const nowISO = () => new Date().toISOString();
  const todayLocal = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  };

  const safeParse = (s) => {
    try { return JSON.parse(s); } catch { return null; }
  };

  const defaultState = () => ({
    wukongTemple: {
      lastVisit: null,
      visitCount: 0,

      // fortune: once per day
      fortuneTaken: false,
      fortuneDate: null, // YYYY-MM-DD (local)

      // divination
      divinationStreak: 0,

      // vows
      burnCount: 0,
      vowLastDate: { // each address has its own cooldown date
        blackhole: null,
        engine: null,
        public_good: null
      },

      // exits
      exitCount: 0,

      // logs
      log: []
    }
  });

  const load = () => {
    const raw = localStorage.getItem(KEY);
    const parsed = raw ? safeParse(raw) : null;
    if (!parsed || !parsed.wukongTemple) return defaultState();

    const base = defaultState();
    const merged = {
      wukongTemple: {
        ...base.wukongTemple,
        ...parsed.wukongTemple,
        vowLastDate: {
          ...base.wukongTemple.vowLastDate,
          ...(parsed.wukongTemple.vowLastDate || {})
        },
        log: Array.isArray(parsed.wukongTemple.log) ? parsed.wukongTemple.log : []
      }
    };
    return merged;
  };

  const save = (state) => {
    localStorage.setItem(KEY, JSON.stringify(state));
  };

  const pushLog = (state, type, meta = {}) => {
    const entry = { type, time: nowISO(), ...meta };
    state.wukongTemple.log.push(entry);
    if (state.wukongTemple.log.length > 400) {
      state.wukongTemple.log = state.wukongTemple.log.slice(-400);
    }
  };

  const chance = (p) => Math.random() < p;

  const downloadJSON = (obj, filename) => {
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };

  const copyText = async (text) => {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch {
      // fallback
      try {
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand("copy");
        ta.remove();
        return ok;
      } catch {
        return false;
      }
    }
  };

  // ====== UI ======
  const $status = document.getElementById("statusText");
  const $toast = document.getElementById("toast");
  const $logPreview = document.getElementById("logPreview");

  const vowPanel = document.getElementById("vowPanel");
  const btnVowCancel = document.getElementById("btnVowCancel");

  // address spans
  document.getElementById("addr_blackhole").textContent = VOW_ADDR.blackhole;
  document.getElementById("addr_engine").textContent = VOW_ADDR.engine;
  document.getElementById("addr_public_good").textContent = VOW_ADDR.public_good;

  const $cool = {
    blackhole: document.getElementById("cool_blackhole"),
    engine: document.getElementById("cool_engine"),
    public_good: document.getElementById("cool_public_good")
  };

  const toast = (msg) => {
    $toast.textContent = msg;
    setTimeout(() => { if ($toast.textContent === msg) $toast.textContent = ""; }, 2800);
  };

  const cooldownText = (lastDate) => {
    const t = todayLocal();
    if (lastDate === t) return "今日已完成（冷卻中）";
    return "今日可還願";
  };

  const render = (state) => {
    const s = state.wukongTemple;

    // fortune status
    const fortuneStatus = (() => {
      const t = todayLocal();
      if (s.fortuneTaken && s.fortuneDate === t) return "今日：已完成（冷卻中）";
      return "今日：尚未完成";
    })();

    const streakN = s.divinationStreak || 0;
    const oddsText = (streakN <= 0)
      ? "尚未連勝"
      : `聖筊連勝 ${streakN} 次（約 1 / 2^${streakN}）`;

    const last = s.lastVisit ? s.lastVisit : "尚無";

    $status.innerHTML = `
      <div>🏮 參拜次數：<strong>${s.visitCount}</strong></div>
      <div>🧧 發財金：<strong>${fortuneStatus}</strong></div>
      <div>🥢 搏杯：<strong>${oddsText}</strong></div>
      <div>🔥 還願記錄：<strong>${s.burnCount}</strong> 次</div>
      <div>🚪 登出次數：<strong>${s.exitCount}</strong> 次</div>
      <div>🕒 最近一次：<strong>${last}</strong></div>
      <div style="margin-top:8px;opacity:.85;">（提示：所有紀錄只存在你的瀏覽器本機，不上鏈、不上傳。）</div>
    `;

    // per-address cooldown display
    $cool.blackhole.textContent = `冷卻：${cooldownText(s.vowLastDate.blackhole)}`;
    $cool.engine.textContent = `冷卻：${cooldownText(s.vowLastDate.engine)}`;
    $cool.public_good.textContent = `冷卻：${cooldownText(s.vowLastDate.public_good)}`;

    // log preview
    const lastLogs = s.log.slice(-20).reverse();
    $logPreview.textContent = lastLogs.length
      ? lastLogs.map((x) => JSON.stringify(x)).join("\n")
      : "（尚無日誌）";
  };

  // ====== Init ======
  render(load());

  // ====== Actions ======

  // 登入參拜
  document.getElementById("btnVisit").addEventListener("click", () => {
    const s = load();
    s.wukongTemple.visitCount += 1;
    s.wukongTemple.lastVisit = nowISO();
    pushLog(s, "visit");
    save(s);
    render(s);
    toast(`✅ 已完成參拜：第 ${s.wukongTemple.visitCount} 次`);
  });

  // 領發財金（每天一次）
  document.getElementById("btnFortune").addEventListener("click", () => {
    const s = load();
    const t = todayLocal();
    if (s.wukongTemple.fortuneTaken && s.wukongTemple.fortuneDate === t) {
      pushLog(s, "fortune_blocked", { reason: "cooldown_today" });
      save(s);
      render(s);
      toast("🧧 今日已完成發財金事件（冷卻中）");
      return;
    }
    s.wukongTemple.fortuneTaken = true;
    s.wukongTemple.fortuneDate = t;
    pushLog(s, "fortune");
    save(s);
    render(s);
    toast("🧧 發財金事件完成：一次性體驗已記錄");
  });

  // 搏杯（50% 聖筊；連勝 N → 1/2^N）
  document.getElementById("btnDivination").addEventListener("click", () => {
    const s = load();
    const ok = chance(0.5);
    if (ok) {
      s.wukongTemple.divinationStreak += 1;
      pushLog(s, "divination_yes", { streak: s.wukongTemple.divinationStreak });
      save(s);
      render(s);
      toast(`🥢 聖筊！連勝 ${s.wukongTemple.divinationStreak} 次`);
    } else {
      s.wukongTemple.divinationStreak = 0;
      pushLog(s, "divination_no");
      save(s);
      render(s);
      toast("🥢 笑筊… 連勝歸零");
    }
  });

  // 打開還願面板
  document.getElementById("btnBurn").addEventListener("click", () => {
    vowPanel.style.display = "block";
    render(load()); // refresh cooldown text
    toast("請選擇還願去向");
    vowPanel.scrollIntoView({ behavior: "smooth", block: "start" });
  });

  // 取消還願
  btnVowCancel.addEventListener("click", () => {
    vowPanel.style.display = "none";
    toast("已取消還願選擇");
  });

  // 面板內：複製地址 / 選擇還願
  vowPanel.addEventListener("click", async (e) => {
    const copyBtn = e.target.closest("button[data-copy]");
    if (copyBtn) {
      const k = copyBtn.getAttribute("data-copy");
      const ok = await copyText(VOW_ADDR[k] || "");
      toast(ok ? "✅ 已複製地址" : "❌ 複製失敗（瀏覽器限制）");
      return;
    }

    const vowBtn = e.target.closest("button[data-vow]");
    if (!vowBtn) return;

    const vowType = vowBtn.getAttribute("data-vow"); // blackhole/engine/public_good
    const s = load();
    const t = todayLocal();

    // per-address cooldown: once per day
    if (s.wukongTemple.vowLastDate[vowType] === t) {
      pushLog(s, "vow_blocked", { to: vowType, reason: "cooldown_today" });
      save(s);
      render(s);
      toast("今日此去向已完成（冷卻中）");
      return;
    }

    s.wukongTemple.burnCount += 1;
    s.wukongTemple.vowLastDate[vowType] = t;

    pushLog(s, "vow", {
      to: vowType,
      addr: VOW_ADDR[vowType] || null
    });

    save(s);
    render(s);
    vowPanel.style.display = "none";

    const msgMap = {
      blackhole: "🕳 還願完成：黑洞轉化已記錄",
      engine: "🚀 還願完成：引擎補油已記錄",
      public_good: "🤲 還願完成：社會還願已記錄"
    };
    toast(msgMap[vowType] || "🔥 還願完成：已記錄");
  });

  // 登出離開
  document.getElementById("btnExit").addEventListener("click", () => {
    const s = load();
    s.wukongTemple.exitCount += 1;
    pushLog(s, "exit");
    save(s);
    render(s);
    toast("🚪 已登出離開：本次行為已記錄");
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  // 匯出 JSON
  document.getElementById("btnExport").addEventListener("click", () => {
    const s = load();
    const filename = `wukong-temple-log_${todayLocal()}.json`;
    downloadJSON(s, filename);
    toast("⬇️ 已匯出 JSON（下載檔案）");
  });

  // 清除本機紀錄
  document.getElementById("btnClear").addEventListener("click", () => {
    const ok = confirm("確定要清除本機紀錄？這只會清你的瀏覽器，不影響任何鏈上或外部資料。");
    if (!ok) return;
    localStorage.removeItem(KEY);
    render(load());
    toast("🧹 已清除本機紀錄");
  });

})();
</script>

</body>
</html>
