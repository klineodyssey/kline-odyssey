<!--
悟空財神廟｜互動循環 V0.1（可回饋・可記錄）
File: /kline-odyssey/wukong-temple/index.html
Deploy: GitHub Pages
-->

<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>悟空財神廟｜Wukong Temple</title>
  <meta name="description" content="悟空財神廟｜互動式遊戲入口：參觀、選擇、體驗，然後離開。" />
</head>

<body>
<div style="max-width:760px;margin:22px auto;padding:16px;">

  <!-- Brand Header -->
  <div style="margin-bottom:10px;">
    <div style="font-weight:900;font-size:22px;line-height:1.2;">
      🐒 悟空財神廟｜Wukong Temple
    </div>
    <div style="margin-top:6px;font-weight:800;">
      #悟空新文 #K線西遊記 #花果山台灣
    </div>
    <div style="margin-top:8px;">
      <a href="https://klineodyssey.github.io/kline-odyssey/"
         target="_blank" rel="noopener"
         style="text-decoration:none;font-weight:900;">
        https://klineodyssey.github.io/kline-odyssey/
      </a>
    </div>
  </div>

  <!-- One-sentence rule -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="font-weight:900;">規則一句話</div>
    <div style="line-height:1.75;margin-top:6px;">
      這裡是<strong>互動式遊戲入口</strong>：參觀、選擇、體驗，然後離開。<br/>
      不承諾收益、不提供投資建議、不做回報保證。
    </div>
  </div>

  <!-- Live Status Panel -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="font-weight:900;">📜 你的參拜紀錄（本機瀏覽器）</div>
    <div id="statusText" style="margin-top:8px;line-height:1.9;"></div>
    <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;">
      <button id="btnExport"
        style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
        ⬇️ 匯出紀錄 JSON
      </button>
      <button id="btnClear"
        style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
        🧹 清除本機紀錄
      </button>
    </div>
    <div id="toast" style="margin-top:10px;font-weight:900;"></div>
  </div>

  <!-- Main Action Buttons (All-in-one) -->
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin:14px 0;">

    <button id="btnVisit"
      style="text-align:left;cursor:pointer;padding:14px 14px;border:1px solid #111;border-radius:14px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">🏮 登入參拜</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">
        確認存在 → 進入前庭（會記錄）
      </div>
    </button>

    <a href="/kline-odyssey/bookstore/"
       style="display:block;padding:14px 14px;border:1px solid #111;border-radius:14px;text-decoration:none;background:#fff;">
      <div style="font-weight:900;font-size:16px;">📘 領書｜悟空書城</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">
        連結到書城／內容兌換
      </div>
    </a>

    <button id="btnFortune"
      style="text-align:left;cursor:pointer;padding:14px 14px;border:1px solid #111;border-radius:14px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">🧧 領發財金（遊戲事件）</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">
        一次性事件｜同地址冷卻（本機）
      </div>
    </button>

    <button id="btnDivination"
      style="text-align:left;cursor:pointer;padding:14px 14px;border:1px solid #111;border-radius:14px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">🥢 搏杯</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">
        聖筊連勝 → 2 的 N 次方節奏
      </div>
    </button>

    <button id="btnBurn"
      style="text-align:left;cursor:pointer;padding:14px 14px;border:1px solid #111;border-radius:14px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">🔥 燒幣／還願</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">
        感恩與轉換（只記錄行為）
      </div>
    </button>

    <button id="btnExit"
      style="text-align:left;cursor:pointer;padding:14px 14px;border:1px solid #111;border-radius:14px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">🚪 登出離開</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">
        結束參拜｜完成紀錄
      </div>
    </button>

  </div>

  <!-- AI Voice Service (Chinese script, ready to record / TTS) -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:14px 0;">
    <div style="font-weight:900;">🎧 AI 語音客服（中文台詞｜可直接照唸）</div>
    <div style="margin-top:8px;line-height:1.85;">
      歡迎來到五指山悟空財神廟。<br/>
      這裡不是銀行，也不是投資平台。<br/>
      你可以參觀、選擇、體驗，然後離開。<br/><br/>
      發財金是遊戲事件，一次性完成，不保留、不回收，也不保證價值。<br/>
      燒幣與還願代表感恩與轉換，是故事行為，不是回報承諾。<br/><br/>
      想開始就按「登入參拜」。想離開就按「登出離開」。
    </div>
  </div>

  <!-- Physics metaphor (short, non-promissory) -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:14px 0;">
    <div style="font-weight:900;">⚙️ 世界觀提示（隱喻，不是承諾）</div>
    <div style="margin-top:8px;line-height:1.85;">
      在 KLINE Odyssey 敘事裡，K G E N 被視為「質量」的象徵。<br/>
      E = m c² 與 W = m g h 是世界觀隱喻，用來描述「選擇造成能量轉換」。<br/>
      公式不代表現實保證、不代表收益、不代表兌換。
    </div>
  </div>

  <!-- Log Preview -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:14px 0;">
    <div style="font-weight:900;">🧾 行為日誌（最近 20 筆）</div>
    <pre id="logPreview"
      style="margin-top:10px;white-space:pre-wrap;word-break:break-word;line-height:1.6;background:#fafafa;border:1px solid #ddd;border-radius:12px;padding:10px;"></pre>
  </div>

  <!-- Footer signature -->
  <div style="margin-top:14px;padding-top:12px;border-top:1px solid #111;line-height:1.8;">
    悟空不保證你得到什麼，<br/>
    只陪你走過一次選擇。<br/><br/>
    PrimeForge 以母機之名，開啟金融生命。<br/>
    花果山台灣・信念不滅・市場無界。<br/>
    Where the Market Becomes the Myth.<br/>
    —— 樂天帝 ⌖
  </div>

</div>

<script>
(() => {
  "use strict";

  // ====== Storage Key ======
  const KEY = "klineodyssey_wukongTemple_v0_1";

  // ====== Helpers ======
  const nowISO = () => new Date().toISOString();
  const todayLocal = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  };

  const safeParse = (s) => {
    try { return JSON.parse(s); } catch { return null; }
  };

  const defaultState = () => ({
    wukongTemple: {
      lastVisit: null,
      visitCount: 0,
      fortuneTaken: false,
      fortuneDate: null,          // YYYY-MM-DD (local)
      divinationStreak: 0,
      burnCount: 0,
      exitCount: 0,
      log: []
    }
  });

  const load = () => {
    const raw = localStorage.getItem(KEY);
    const parsed = raw ? safeParse(raw) : null;
    if (!parsed || !parsed.wukongTemple) return defaultState();
    // Backward-safe merge
    const base = defaultState();
    return {
      wukongTemple: {
        ...base.wukongTemple,
        ...parsed.wukongTemple,
        log: Array.isArray(parsed.wukongTemple.log) ? parsed.wukongTemple.log : []
      }
    };
  };

  const save = (state) => {
    localStorage.setItem(KEY, JSON.stringify(state));
  };

  const pushLog = (state, type, meta = {}) => {
    const entry = { type, time: nowISO(), ...meta };
    state.wukongTemple.log.push(entry);
    // keep log capped (avoid infinite growth)
    if (state.wukongTemple.log.length > 300) {
      state.wukongTemple.log = state.wukongTemple.log.slice(-300);
    }
  };

  const chance = (p) => Math.random() < p; // p in [0,1)

  const downloadJSON = (obj, filename) => {
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };

  // ====== UI ======
  const $status = document.getElementById("statusText");
  const $toast = document.getElementById("toast");
  const $logPreview = document.getElementById("logPreview");

  const toast = (msg) => {
    $toast.textContent = msg;
    setTimeout(() => { if ($toast.textContent === msg) $toast.textContent = ""; }, 2800);
  };

  const render = (state) => {
    const s = state.wukongTemple;

    const fortuneStatus = (() => {
      const t = todayLocal();
      if (s.fortuneTaken && s.fortuneDate === t) return "今日：已完成（冷卻中）";
      return "今日：尚未完成";
    })();

    const streakN = s.divinationStreak || 0;
    const oddsText = (streakN <= 0)
      ? "尚未連勝"
      : `聖筊連勝 ${streakN} 次（約 1 / 2^${streakN}）`;

    const last = s.lastVisit ? s.lastVisit : "尚無";
    $status.innerHTML = `
      <div>🏮 參拜次數：<strong>${s.visitCount}</strong></div>
      <div>🧧 發財金：<strong>${fortuneStatus}</strong></div>
      <div>🥢 搏杯：<strong>${oddsText}</strong></div>
      <div>🔥 還願記錄：<strong>${s.burnCount}</strong> 次</div>
      <div>🚪 登出次數：<strong>${s.exitCount}</strong> 次</div>
      <div>🕒 最近一次：<strong>${last}</strong></div>
      <div style="margin-top:8px;opacity:.85;">（提示：所有紀錄只存在你的瀏覽器本機，不上鏈、不上傳。）</div>
    `;

    const lastLogs = s.log.slice(-20).reverse();
    $logPreview.textContent = lastLogs.length
      ? lastLogs.map((x) => JSON.stringify(x)).join("\n")
      : "（尚無日誌）";
  };

  // ====== Actions ======
  const state = load();
  render(state);

  // 登入參拜
  document.getElementById("btnVisit").addEventListener("click", () => {
    const s = load();
    s.wukongTemple.visitCount += 1;
    s.wukongTemple.lastVisit = nowISO();
    pushLog(s, "visit");
    save(s);
    render(s);
    toast(`✅ 已完成參拜：第 ${s.wukongTemple.visitCount} 次`);
  });

  // 領發財金（本機冷卻：每天一次）
  document.getElementById("btnFortune").addEventListener("click", () => {
    const s = load();
    const t = todayLocal();
    if (s.wukongTemple.fortuneTaken && s.wukongTemple.fortuneDate === t) {
      pushLog(s, "fortune_blocked", { reason: "cooldown_today" });
      save(s);
      render(s);
      toast("🧧 今日已完成發財金事件（冷卻中）");
      return;
    }
    s.wukongTemple.fortuneTaken = true;
    s.wukongTemple.fortuneDate = t;
    pushLog(s, "fortune");
    save(s);
    render(s);
    toast("🧧 發財金事件完成：一次性體驗已記錄");
  });

  // 搏杯（50% 聖筊；連勝 N → 1/2^N 節奏）
  document.getElementById("btnDivination").addEventListener("click", () => {
    const s = load();
    const ok = chance(0.5);
    if (ok) {
      s.wukongTemple.divinationStreak += 1;
      pushLog(s, "divination_yes", { streak: s.wukongTemple.divinationStreak });
      save(s);
      render(s);
      toast(`🥢 聖筊！連勝 ${s.wukongTemple.divinationStreak} 次`);
    } else {
      s.wukongTemple.divinationStreak = 0;
      pushLog(s, "divination_no");
      save(s);
      render(s);
      toast("🥢 笑筊… 連勝歸零");
    }
  });

  // 燒幣／還願（只記錄行為：感恩）
  document.getElementById("btnBurn").addEventListener("click", () => {
    const s = load();
    s.wukongTemple.burnCount += 1;
    pushLog(s, "vow_gratitude"); // 用「感恩」語意，不用「燒幣」字眼當主名
    save(s);
    render(s);
    toast("🔥 感恩已記錄：能量完成轉換（敘事）");
  });

  // 登出離開
  document.getElementById("btnExit").addEventListener("click", () => {
    const s = load();
    s.wukongTemple.exitCount += 1;
    pushLog(s, "exit");
    save(s);
    render(s);
    toast("🚪 已登出離開：本次行為已記錄");
    // optional: scroll to top so user sees status
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  // 匯出 JSON
  document.getElementById("btnExport").addEventListener("click", () => {
    const s = load();
    const filename = `wukong-temple-log_${todayLocal()}.json`;
    downloadJSON(s, filename);
    toast("⬇️ 已匯出 JSON（下載檔案）");
  });

  // 清除本機紀錄
  document.getElementById("btnClear").addEventListener("click", () => {
    const ok = confirm("確定要清除本機紀錄？這只會清你的瀏覽器，不影響任何鏈上或外部資料。");
    if (!ok) return;
    localStorage.removeItem(KEY);
    const s = load(); // reload default
    render(s);
    toast("🧹 已清除本機紀錄");
  });

})();
</script>

</body>
</html>
