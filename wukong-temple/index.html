<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ‚Ÿç©ºè²¡ç¥æ®¿ï½œWukong Fortune Hall</title>
  <meta name="description" content="æ‚Ÿç©ºè²¡ç¥æ®¿ï½œå¿ƒè·³ãƒ»å‘¼å¸ãƒ»ç™¼è²¡é‡‘ãƒ»ä¸ƒä»™å¥³è¨±é¡˜æ± ï½œè‡ªå‹•åŒ–å®‡å®™ç”Ÿå‘½é«”å…¥å£" />
  <style>
    :root{--b:#111;--bg:#fff;--muted:#666;--soft:#f3f3f3;--ok:#0a7;--bad:#c33;}
    *{box-sizing:border-box}
    body{margin:0;background:#fafafa;color:#111;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial,sans-serif;}
    a{color:inherit}
    .wrap{max-width:920px;margin:18px auto;padding:14px;}
    .topbar{position:sticky;top:10px;z-index:50;display:flex;justify-content:flex-end;margin:10px 0;}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;font-weight:900;text-decoration:none;border:1px solid var(--b);background:var(--bg);}
    .h1{font-weight:1000;font-size:22px;line-height:1.2;}
    .tag{margin-top:6px;font-weight:900;}
    .card{border:1px solid var(--b);border-radius:16px;background:var(--bg);padding:12px;margin:12px 0;box-shadow:0 6px 18px rgba(0,0,0,.04)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btn{cursor:pointer;padding:10px 12px;border:1px solid var(--b);border-radius:999px;background:var(--bg);font-weight:900;}
    .btn:disabled{cursor:not-allowed;background:var(--soft);opacity:.75}
    .btn.small{padding:8px 10px;font-weight:900}
    .muted{color:var(--muted)}
    .kvs{display:grid;grid-template-columns:140px 1fr;gap:6px 10px;align-items:start}
    .k{font-weight:900}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;word-break:break-all}
    .hr{height:1px;background:#eee;margin:10px 0}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}

    .zodiacGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
    @media (max-width:820px){.zodiacGrid{grid-template-columns:1fr}}
    .node{border:1px dashed #999;border-radius:14px;padding:10px;background:#fff;}
    .node h3{margin:0;font-size:16px}

    .toast{padding:10px 12px;border-radius:12px;border:1px solid #ddd;background:#fff;}
    .ok{border-color:rgba(0,160,110,.35);background:rgba(0,160,110,.06)}
    .bad{border-color:rgba(200,50,50,.35);background:rgba(200,50,50,.06)}

    .debug{position:fixed;right:10px;bottom:10px;z-index:60;width:min(520px,calc(100vw - 20px));max-height:42vh;overflow:auto;border:1px solid var(--b);border-radius:14px;background:#fff;box-shadow:0 12px 30px rgba(0,0,0,.12)}
    .debug header{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid #eee;position:sticky;top:0;background:#fff}
    .debug header .title{font-weight:1000}
    .debug pre{margin:0;padding:10px 12px;white-space:pre-wrap;word-break:break-word;font-size:12px;line-height:1.35}

    .input{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:12px;font-size:14px;}
    .select{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:12px;font-size:14px;background:#fff;}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid #ddd;background:#fff;font-weight:900;font-size:12px;}
  </style>
</head>
<body>

<div class="topbar">
  <a class="pill" href="https://klineodyssey.github.io/kline-odyssey/" target="_blank" rel="noopener">ğŸŒ Official Website</a>
</div>

<div class="wrap">

  <div>
    <div class="h1">ğŸ’ äº”æŒ‡å±±ãƒ»æ‚Ÿç©ºè²¡ç¥æ®¿ï½œWukong Fortune Hall</div>
    <div class="tag">#æ‚Ÿç©ºæ–°æ–‡ #Kç·šè¥¿éŠè¨˜ #èŠ±æœå±±å°ç£</div>
    <div style="margin-top:8px" class="muted">boot_version=<span class="mono" id="bootVer"></span></div>
  </div>

  <div class="card">
    <div class="row">
      <div style="font-weight:1000">ğŸ« å®‡å®™ç”Ÿå‘½å¾µè±¡ï½œå¿ƒè·³ãƒ»å‘¼å¸ãƒ»è¡€å£“ï¼ˆCosmic Vitalsï¼‰</div>
      <div class="badge" id="cupBadge">è–ç­Šé€£å‹ï¼š0 / 3</div>
    </div>

    <div style="margin-top:8px;line-height:1.75">
      é€™è£¡ä¸æ˜¯ä¸€èˆ¬å»Ÿã€‚æ‚Ÿç©ºå¿ƒè‡Ÿå°‡ç”± <b>Faucet åˆç´„</b> è‡ªå‹•è·³å‹•ã€‚<br/>
      äººé¡ä¸å†ç›´æ¥æŒæœ‰æ ¸å¿ƒè³‡é‡‘ï¼›æ¯æ©Ÿåªè² è²¬æ•‘æ´ï¼Œä¸æ“æœ‰ã€‚<br/>
      ä½ æ¯ä¸€æ¬¡åƒæ‹œï¼Œéƒ½æœƒè§¸ç™¼ä¸€æ¬¡ã€Œç”Ÿå‘½å¾µè±¡ã€èˆ‡ã€Œè–ç­Šã€è¨˜éŒ„ã€‚
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn" id="btnHeartbeat">â¤ï¸ å¿ƒè·³</button>
      <button class="btn" id="btnBreath">ğŸ« å‘¼å¸</button>
      <button class="btn" id="btnPressure">ğŸ©¸ è¡€å£“</button>
      <button class="btn" id="btnCup">ğŸ¥¢ æ“²ç­Š</button>
      <button class="btn" id="btnFortune" disabled>ğŸ§§ é ˜ç™¼è²¡é‡‘ï¼ˆéœ€åˆç´„ï¼‰</button>
    </div>

    <div id="vitalsOut" style="margin-top:10px"></div>
    <div class="muted" style="margin-top:8px;line-height:1.65">
      è¦å‰‡ï¼šè–ç­Šæ©Ÿç‡ 50%ã€‚å¤±æ•—é€£å‹æ­¸é›¶ã€‚é€£å‹é” 3 æ‰è§£é–ã€Œé ˜ç™¼è²¡é‡‘ã€ã€‚<br/>
      ç™¼è²¡é‡‘è¦å‰‡ï¼ˆé è¨­ï¼‰ï¼šæ¯æœˆæœ€å¤š <b>500 å</b>ï¼Œæ¯åæœ€é«˜ <b>888 KGEN</b>ï¼ˆçœŸæ­£ç™¼æ”¾ä»¥ Faucet åˆç´„åƒæ•¸ç‚ºæº–ï¼‰ã€‚
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div style="font-weight:1000">ğŸªª éŒ¢åŒ…ç‹€æ…‹ï¼ˆBSC ä¸»ç¶²ï¼‰</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn" id="btnConnect">é€£ç·šéŒ¢åŒ…</button>
        <button class="btn" id="btnDisconnect">æ–·é–‹</button>
        <button class="btn" id="btnExport">åŒ¯å‡ºç‹€æ…‹ JSON</button>
      </div>
    </div>

    <div class="hr"></div>

    <div class="kvs">
      <div class="k">Wallet</div>
      <div class="mono" id="walletAddr">(not connected)</div>

      <div class="k">Chain</div>
      <div class="mono" id="chainInfo">(unknown)</div>

      <div class="k">Faucet Contract</div>
      <div class="mono" id="faucetAddr">(to be set after deploy)</div>

      <div class="k">KUFO Bank Contract</div>
      <div class="mono" id="kufoAddr">(to be set after deploy)</div>

      <div class="k">Public Good Treasury</div>
      <div class="mono" id="treasuryAddr">0xB73D6716005B37BEC742D64482fA26033eE1A4E1</div>
    </div>

    <div class="muted" style="margin-top:10px;line-height:1.6">
      è‹¥ä½ å°šæœªéƒ¨ç½² Faucet / KUFOï¼Œè«‹å…ˆæŠŠåˆç´„åœ°å€è²¼åˆ°ã€Œè¨­å®šé¢æ¿ã€ã€‚åœ°å€ä¸€æ—¦ä¸Šéˆå°±ä¸å¯è®Šæ›´ï¼ˆé™¤éå‡ç‰ˆå†éƒ¨ç½²æ–°å™¨å®˜ï¼‰ã€‚
    </div>

    <div class="hr"></div>

    <div class="grid">
      <div>
        <div style="font-weight:1000;margin-bottom:6px">âš™ï¸ è¨­å®šé¢æ¿ï¼ˆæœ¬æ©Ÿå„²å­˜ï¼Œä¸ä¸Šéˆï¼‰</div>
        <div class="muted" style="margin-bottom:8px">ç”¨ä¾†æŠŠã€Œå·²éƒ¨ç½²åˆç´„åœ°å€ã€æ¥åˆ°ç¥æ®¿æŒ‰éµï¼Œä¸æœƒæ”¹è®Šéˆä¸Šæ¬Šé™ã€‚</div>

        <label class="muted">Faucet åˆç´„åœ°å€</label>
        <input id="inFaucet" class="input mono" placeholder="0x..." />

        <div style="height:8px"></div>
        <label class="muted">KUFO ç„¡äººéŠ€è¡Œåˆç´„åœ°å€</label>
        <input id="inKUFO" class="input mono" placeholder="0x..." />

        <div style="height:8px"></div>
        <button class="btn" id="btnSaveCfg">ä¿å­˜</button>
        <button class="btn" id="btnClearCfg">æ¸…é™¤</button>
      </div>

      <div>
        <div style="font-weight:1000;margin-bottom:6px">ğŸ§ å½±åƒèªéŸ³å®¢æœï¼ˆæœ¬æ©Ÿï¼‰</div>
        <div class="muted" style="margin-bottom:8px">ä½ çš„ç’°å¢ƒé¡¯ç¤º speechSynthesis=falseï¼ˆWebView å¯èƒ½ä¸æ”¯æ´ TTSï¼‰ã€‚æˆ‘å€‘ä»æä¾›æ–‡å­—å®¢æœï¼‹èªéŸ³è¼¸å…¥ï¼ˆè‹¥å…è¨±ï¼‰ã€‚</div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn" id="btnAssistant">â–¶ï¸ å•Ÿå‹•å®¢æœ</button>
          <button class="btn" id="btnSTT">ğŸ™ï¸ èªéŸ³è¼¸å…¥</button>
          <button class="btn" id="btnStopSTT">â¹ï¸ åœæ­¢</button>
        </div>

        <div style="margin-top:10px" class="toast" id="assistantBox">
          <div style="font-weight:1000">æ‚Ÿç©ºå®¢æœ</div>
          <div id="assistantText" style="margin-top:6px;line-height:1.65" class="muted">æŒ‰ã€Œå•Ÿå‹•å®¢æœã€æœƒé¡¯ç¤ºè¦å‰‡è§£èªªã€‚ä½ ä¹Ÿå¯ä»¥ç”¨èªéŸ³è¼¸å…¥å•å•é¡Œï¼ˆè‹¥è£ç½®æ”¯æ´ï¼‰ã€‚</div>
        </div>
      </div>
    </div>

  </div>

  <div class="card">
    <div class="row">
      <div style="font-weight:1000">âœ¨ ä¸ƒä»™å¥³æ˜Ÿåº§ç›¤ï½œä¸ƒæ˜Ÿå®ˆè­·ï¼ˆSeven Fairies Constellationï¼‰</div>
      <button class="btn small" id="btnLoadFairies">è¼‰å…¥åˆ°è¨±é¡˜æ± </button>
    </div>

    <div class="muted" style="margin-top:8px;line-height:1.65">
      é€™æ˜¯æ‚Ÿç©ºè²¡ç¥æ®¿çš„ã€Œç¥ˆé¡˜è·¯ç”±ã€ã€‚æ¯ä½ä»™å¥³å°æ‡‰ä¸€å€‹åº§æ¨™é»ï¼Œä¸¦æœ‰å„è‡ªçš„å®ˆè­·è·è²¬èˆ‡å¤šç©ºæ°£è„ˆã€‚
      <b>æ–°å¢ï¼šä¸ƒä»™å¥³è¨±é¡˜æ± </b>ï¼ˆä¸‹æ–¹ï¼‰â€”â€” è®“é¦™å®¢èƒ½é¸æ“‡å®ˆè­·ä»™å¥³ã€å¯«ä¸‹é¡˜æœ›ã€ç•™ä¸‹èª“è¨€ã€‚
    </div>

    <div class="zodiacGrid" style="margin-top:10px" id="fairyGrid"></div>
  </div>

  <div class="card">
    <div class="row">
      <div style="font-weight:1000">ğŸ’§ ä¸ƒä»™å¥³è¨±é¡˜æ± ï¼ˆWish Poolï¼‰</div>
      <div class="badge" id="wishCount">ä»Šæ—¥è¨±é¡˜ï¼š0</div>
    </div>

    <div class="muted" style="margin-top:8px;line-height:1.65">
      è¦å‰‡ï¼ˆç¥æ®¿ç‰ˆï¼‰ï¼šè¨±é¡˜ä¸ç­‰æ–¼ä¿è­‰ï¼›ç™¼è²¡é‡‘æ˜¯ã€Œå€Ÿä½ å»åšç”Ÿæ„ã€çš„ç¦®ç‰©ï¼Œä¸æ˜¯å¼·ç´¢å›æ”¶ã€‚<br/>
      ä½ å¯è‡ªè¡Œé¸æ“‡æ˜¯å¦ã€Œé‚„é¡˜ã€ã€‚è‹¥ä½ é¡˜æ„ä½é€²èŠ±æœå±±ç«æ˜Ÿé½Šå¤©è±ªå®…ï¼Œéœ€å®Œæˆ <b>5000 KGEN é‚„é¡˜</b>ï¼ˆä»¥ KUFO ç„¡äººéŠ€è¡Œè¦å‰‡ç‚ºæº–ï¼‰ã€‚
    </div>

    <div class="grid" style="margin-top:10px">
      <div>
        <label class="muted">é¸æ“‡å®ˆè­·ä»™å¥³</label>
        <select id="wishFairy" class="select"></select>

        <div style="height:8px"></div>
        <label class="muted">é¡˜æœ›å…§å®¹ï¼ˆä¸è¦ç•™å€‹è³‡ï¼‰</label>
        <textarea id="wishText" class="input" rows="5" placeholder="ä¾‹å¦‚ï¼šæ±‚äº‹æ¥­é‹é€šã€å®¶åº­ç¾æ»¿ã€èº«é«”å¥åº·â€¦"></textarea>

        <div style="height:8px"></div>
        <label class="muted">èª“è¨€ï¼ˆé¸å¡«ï¼‰</label>
        <input id="wishVow" class="input" placeholder="ä¾‹å¦‚ï¼šè‹¥æˆï¼Œå°‡å›æ®¿é‚„é¡˜ã€‚" />

        <div style="height:10px"></div>
        <button class="btn" id="btnWish">æŠ•ä¸‹è¨±é¡˜</button>
        <button class="btn" id="btnWishExport">åŒ¯å‡ºè¨±é¡˜ JSON</button>
      </div>

      <div>
        <div class="toast" id="wishBox">
          <div style="font-weight:1000">è¨±é¡˜å›éŸ¿</div>
          <div id="wishOut" style="margin-top:6px;line-height:1.65" class="muted">é¸å¥½ä»™å¥³ï¼Œå¯«ä¸‹é¡˜æœ›ï¼ŒæŒ‰ä¸‹ã€ŒæŠ•ä¸‹è¨±é¡˜ã€ã€‚</div>
        </div>

        <div style="margin-top:10px" class="toast">
          <div style="font-weight:1000">è±ªå®… 500 å¸­ï¼ˆæ¦‚å¿µï¼‰</div>
          <div class="muted" style="margin-top:6px;line-height:1.65">
            ä½é€²ã€ŒèŠ±æœå±±ç«æ˜Ÿé½Šå¤©è±ªå®…ã€ï¼šä»¥ <b>5000 KGEN</b> é‚„é¡˜ä½œç‚ºå¸­ä½é–€æª»ã€‚<br/>
            æ˜¯å¦ç¶ã€Œé ˜éç™¼è²¡é‡‘åœ°å€ã€ï¼šäº¤ç”± KUFO åˆç´„è¦å‰‡æ±ºå®šï¼ˆä¸Šéˆå¾Œä¸å¯è‡¨æ™‚æ”¹å£ï¼‰ã€‚
          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="card">
    <div style="font-weight:1000">ğŸ“œ å“ç‰Œå›ºå®šå°¾æ®µ</div>
    <div style="margin-top:8px;line-height:1.75">
      PrimeForge ä»¥æ¯æ©Ÿä¹‹åï¼Œé–‹å•Ÿé‡‘èç”Ÿå‘½ã€‚<br/>
      èŠ±æœå±±å°ç£ãƒ»ä¿¡å¿µä¸æ»…ãƒ»å¸‚å ´ç„¡ç•Œã€‚<br/>
      Where the Market Becomes the Myth.<br/>
      â€”â€” æ¨‚å¤©å¸ âŒ–
    </div>
  </div>

</div>


<!-- Sound Settings -->
<div class="card">
  <h3>ğŸ”Š è²éŸ³ï¼ˆTTS / å®ï¼‰</h3>
  <div class="row">
    <label class="lbl">æ¨¡å¼</label>
    <select id="soundMode" class="input" style="max-width:260px">
      <option value="auto" selected>Autoï¼ˆæœ‰ TTS ç”¨ TTSï¼Œå¦å‰‡å®ï¼‰</option>
      <option value="tts">TTSï¼ˆéœ€è¦è£ç½®æ”¯æ´ï¼‰</option>
      <option value="beep">å®ï¼ˆWebAudioï¼‰</option>
      <option value="off">é—œé–‰</option>
    </select>
    <button class="btn" id="btnTestSound" style="margin-left:8px">æ¸¬è©¦</button>
  </div>
  <div class="muted" style="margin-top:6px;line-height:1.6">
    ä½ çš„ MetaMask WebView å¸¸æœƒé¡¯ç¤º <code>speechSynthesis=false</code>ï¼Œé€™æ™‚æœƒè‡ªå‹•æ”¹ç”¨ã€Œå®ã€è²ã€‚è‹¥è¦çœŸäººèªéŸ³ï¼Œå¯æ”¹ç”¨ Chrome é–‹å•Ÿï¼ˆä½†å¯èƒ½å¤±å»éŒ¢åŒ…æ³¨å…¥ï¼‰ã€‚
  </div>
</div>

<!-- Debug Panel -->
<div class="debug" id="debug" style="display:block">
  <header>
    <div class="title">Debug Console</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn small" id="btnSelfcheck">Selfcheck</button>
      <button class="btn small" id="btnClearLog">Clear</button>
      <button class="btn small" id="btnHideDbg">Hide</button>
    </div>
  </header>
  <pre id="log"></pre>
</div>

<script>
(function(){
  // ===== Version =====
  const BOOT_VERSION = "v2.8.4-ethretry-soundfix";
  document.getElementById('bootVer').textContent = BOOT_VERSION;

  // ===== Debug =====
  const logEl = document.getElementById('log');
  function nowISO(){ try{return new Date().toISOString();}catch(e){return ''} }
  function log(msg){
    const line = `[${nowISO()}] ${msg}`;
    console.log(line);
    logEl.textContent = (logEl.textContent ? (logEl.textContent + "\n") : "") + line;
    // keep last ~400 lines
    const lines = logEl.textContent.split(/\n/);
    if(lines.length>450) logEl.textContent = lines.slice(lines.length-450).join("\n");
  }
  window.__WK_LOG__ = log;

  // ===== Errors Hook =====
  function hookGlobalErrors(){
    if (window.__wukongErrorsHooked) return;
    window.__wukongErrorsHooked = true;
    window.addEventListener('error', function(ev){
      try{
        const msg = ev && ev.message ? ev.message : 'Unknown error';
        const src = ev && ev.filename ? ev.filename : '';
        const ln = ev && ev.lineno ? ev.lineno : '';
        const col = ev && ev.colno ? ev.colno : '';
        log(`ERROR: ${msg}${src?(' @ '+src+':'+ln+':'+col):''}`);
      }catch(e){}
    });
    window.addEventListener('unhandledrejection', function(ev){
      try{
        const r = ev && ev.reason ? (ev.reason.message || String(ev.reason)) : 'Unknown rejection';
        log('PROMISE_REJECT: ' + r);
      }catch(e){}
    });
  }

  // ===== Selfcheck =====
  function selfCheck(){
    hookGlobalErrors();
    log('selfcheck_start');
    log('userAgent: ' + (navigator.userAgent || '(none)'));
    log('speechSynthesis: ' + ('speechSynthesis' in window));
    log('speechRecognition: ' + (!!(window.SpeechRecognition || window.webkitSpeechRecognition)));
    log('ethers_loaded: ' + (typeof window.ethers !== 'undefined'));
    log('ethereum_injected: ' + (typeof window.ethereum !== 'undefined'));
  
    // Re-check late injections (MetaMask WebView)
    ensureEthers().then(()=>ensureEthereum()).then(()=>{
      try{
        log("ethers_loaded_now: " + (!!window.ethers));
        log("ethereum_injected_now: " + (!!window.ethereum));
      }catch(e){}
    });

}

  // ====== Lazy loaders (MetaMask WebView sometimes injects late) ======
  function ensureEthers(maxWaitMs=3500){
    return new Promise((resolve)=>{
      if (window.ethers) { resolve(true); return; }
      log("ethers_load_attempt");
      const s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js";
      s.async = true;
      s.onload = () => { log("ethers_loaded_after: " + (!!window.ethers)); resolve(!!window.ethers); };
      s.onerror = () => { log("ethers_load_failed"); resolve(false); };
      document.head.appendChild(s);
      setTimeout(()=>{ if(!window.ethers){ log("ethers_load_timeout"); resolve(false);} }, maxWaitMs);
    });
  }

  function ensureEthereum(maxWaitMs=3500, stepMs=120){
    return new Promise((resolve)=>{
      const t0 = Date.now();
      function tick(){
        const ok = !!window.ethereum;
        if (ok){ log("ethereum_injected_after: true"); resolve(true); return; }
        if (Date.now() - t0 >= maxWaitMs){ log("ethereum_injected_after: false"); resolve(false); return; }
        setTimeout(tick, stepMs);
      }
      tick();
    });
  }


  // ===== UI helpers =====
  function toast(targetId, kind, html){
    const el = document.getElementById(targetId);
    el.classList.remove('ok','bad');
    if(kind==='ok') el.classList.add('ok');
    if(kind==='bad') el.classList.add('bad');
    el.innerHTML = html;
  }

  // ===== Storage =====
  const CFG_KEY = 'WK_TEMPLE_CFG_V2';
  function loadCfg(){
    try{ return JSON.parse(localStorage.getItem(CFG_KEY) || '{}') || {}; }catch(e){ return {}; }
  }
  function saveCfg(cfg){
    localStorage.setItem(CFG_KEY, JSON.stringify(cfg||{}));
  }

  // ===== Wallet =====
  const walletAddrEl = document.getElementById('walletAddr');
  const chainInfoEl = document.getElementById('chainInfo');
  let connectedAddr = null;

  async function connectWallet(){
    if(!window.ethereum){
      log('wallet_connect_failed: no ethereum');
      toast('assistantText','bad','æ‰¾ä¸åˆ°éŒ¢åŒ…æ³¨å…¥ï¼ˆwindow.ethereumï¼‰ã€‚è«‹ç”¨ MetaMask å…§å»ºç€è¦½å™¨é–‹å•Ÿã€‚');
      return;
    }
    try{
      const accounts = await window.ethereum.request({method:'eth_requestAccounts'});
      connectedAddr = accounts && accounts[0] ? accounts[0] : null;
      walletAddrEl.textContent = connectedAddr || '(no account)';
      const chainId = await window.ethereum.request({method:'eth_chainId'});
      chainInfoEl.textContent = chainId ? `${chainId}` : '(unknown)';
      log('wallet_connected=' + connectedAddr);
    }catch(e){
      log('wallet_connect_error: ' + (e && e.message ? e.message : String(e)));
    }
  }

  function disconnectWallet(){
    // EIP-1193 has no true disconnect from dapp side; we just clear UI
    connectedAddr = null;
    walletAddrEl.textContent = '(not connected)';
    chainInfoEl.textContent = '(unknown)';
    log('wallet_ui_disconnected');
  }

  // avoid spam reconnect logs
  let accHandlerBound = false;
  function bindEthEvents(){
    if(!window.ethereum || accHandlerBound) return;
    accHandlerBound = true;
    window.ethereum.on('accountsChanged', function(accs){
      const a = accs && accs[0] ? accs[0] : null;
      connectedAddr = a;
      walletAddrEl.textContent = a || '(not connected)';
      log('accountsChanged=' + (a||'(none)'));
    });
    window.ethereum.on('chainChanged', function(cid){
      chainInfoEl.textContent = cid ? `${cid}` : '(unknown)';
      log('chainChanged=' + cid);
    });
  }

  // ===== Vitals + Cup =====
  const vitalsOut = document.getElementById('vitalsOut');
  const cupBadge = document.getElementById('cupBadge');
  const btnFortune = document.getElementById('btnFortune');

  let cupStreak = 0;
  const CUP_MAX = 3;
  const ST_KEY = 'WK_CUP_STREAK';
  try{ cupStreak = parseInt(localStorage.getItem(ST_KEY)||'0',10) || 0; }catch(e){ cupStreak = 0; }

  function updateCupUI(){
    cupBadge.textContent = `è–ç­Šé€£å‹ï¼š${cupStreak} / ${CUP_MAX}`;
    if(cupStreak>=CUP_MAX){
      btnFortune.disabled = false;
      btnFortune.style.cursor = 'pointer';
    }else{
      btnFortune.disabled = true;
      btnFortune.style.cursor = 'not-allowed';
    }
  }
  updateCupUI();

  function renderVitals(title, lines){
    const html = `
      <div class="toast ok">
        <div style="font-weight:1000">${title}</div>
        <div style="margin-top:6px;line-height:1.7">${lines.join('<br/>')}</div>
      </div>`;
    vitalsOut.innerHTML = html;
  }

  function doHeartbeat(){
    log('heartbeat');
    const bpm = 60 + Math.floor(Math.random()*33); // 60~92
    renderVitals('å¿ƒè·³å›éŸ¿', [
      `Pulsar BPMï¼š<b>${bpm}</b>`,
      'æ‚Ÿç©ºå¿ƒè‡Ÿï¼šç”± Faucet åˆç´„è·³å‹•ï¼ˆæœªéƒ¨ç½²æ™‚åƒ…è¨˜éŒ„ï¼‰',
      'æç¤ºï¼šä½ å¯ä»¥å…ˆç”¨ã€Œè¨­å®šé¢æ¿ã€è²¼ä¸Š Faucet åœ°å€ã€‚'
    ]);
  }
  function doBreath(){
    log('breath');
    const breath = 12 + Math.floor(Math.random()*9); // 12~20
    renderVitals('å‘¼å¸å›éŸ¿', [
      `Breath/minï¼š<b>${breath}</b>`,
      'è½‰æ—¥çª—å£ï¼š00:00~00:10ï¼ˆUTC+8ï¼‰å±¬æ–¼å®‡å®™é‡ç½®å‘¼å¸å¸¶ã€‚'
    ]);
  }
  function doPressure(){
    log('pressure');
    const s = 100 + Math.floor(Math.random()*31);
    const d = 60 + Math.floor(Math.random()*21);
    renderVitals('è¡€å£“å›éŸ¿', [
      `BPï¼š<b>${s}/${d}</b>`,
      'è¡€ç®¡ï¼šæœªä¾†ç”± KUFO ç„¡äººéŠ€è¡Œä¾›è¡€ï¼ˆè³‡é‡‘æµï¼‰èˆ‡ Faucet å¿ƒè‡Ÿå…±æŒ¯ã€‚'
    ]);
  }

  function doCup(){
    log('cup_throw');
    const ok = Math.random() < 0.5;
    if(ok){
      cupStreak += 1;
      localStorage.setItem(ST_KEY, String(cupStreak));
      updateCupUI();
      toast('assistantText','ok',`è–ç­Šæˆç«‹ã€‚é€£å‹ ${cupStreak}/${CUP_MAX}ã€‚`);
      vitalsOut.innerHTML = `<div class="toast ok"><div style="font-weight:1000">è–ç­Šï¼šæˆç«‹</div><div class="muted" style="margin-top:6px">ä½ é›¢ã€Œé ˜ç™¼è²¡é‡‘ã€æ›´è¿‘ä¸€æ­¥ã€‚</div></div>`;
    }else{
      cupStreak = 0;
      localStorage.setItem(ST_KEY, '0');
      updateCupUI();
      toast('assistantText','bad','ç¬‘ç­Šæˆ–é™°ç­Šã€‚é€£å‹æ­¸é›¶ã€‚å†ä¾†ä¸€æ¬¡ã€‚');
      vitalsOut.innerHTML = `<div class="toast bad"><div style="font-weight:1000">è–ç­Šï¼šæœªæˆ</div><div class="muted" style="margin-top:6px">æ­¸é›¶é‡ä¾†ï¼Œé€™å°±æ˜¯ä¿®è¡Œã€‚</div></div>`;
    }
  }

  function fortuneClaim(){
    log('fortune_click');
    const cfg = loadCfg();
    if(!cfg.faucet){
      toast('assistantText','bad','å°šæœªè¨­å®š Faucet åˆç´„åœ°å€ã€‚è«‹å…ˆåœ¨è¨­å®šé¢æ¿è²¼ä¸Š Faucet åœ°å€ä¸¦ä¿å­˜ã€‚');
      return;
    }
    // UI-only placeholder: on-chain call will be wired after deploy
    toast('assistantText','ok',`å·²è§£é–ç™¼è²¡é‡‘ã€‚Faucet=${cfg.faucet}ï¼ˆå°šæœªåŸ·è¡Œéˆä¸Šäº¤æ˜“ï¼Œé€™è£¡å…ˆåšä»‹é¢é©—æ”¶ï¼‰ã€‚`);
  }

  // ===== Assistant (text + STT) =====
  const assistantText = document.getElementById('assistantText');
  function assistantStart(){
    log('assistant_start');
    wukongSound('æ‚Ÿç©ºå®¢æœå•Ÿå‹•');
    const cfg = loadCfg();
    const lines = [
      'æ‚Ÿç©ºå¿ƒè‡Ÿç”± Faucet åˆç´„è‡ªå‹•è·³å‹•ï¼›æ¯æ©Ÿåªæ•‘æ´ï¼Œä¸æ“æœ‰ã€‚',
      'ä½ å¯ä»¥ï¼šå¿ƒè·³ã€å‘¼å¸ã€è¡€å£“ã€æ“²ç­Šä¸‰é€£å‹è§£é–ç™¼è²¡é‡‘ã€‚',
      `ç›®å‰è¨­å®šï¼šFaucet=${cfg.faucet||'(æœªè¨­å®š)'}ï¼›KUFO=${cfg.kufo||'(æœªè¨­å®š)'}.`,
      'æ–°å¢ï¼šä¸ƒä»™å¥³è¨±é¡˜æ± ï¼ˆé¸ä»™å¥³ã€å¯«é¡˜æœ›ã€åŒ¯å‡º JSONï¼‰ã€‚'
    ];
    assistantText.innerHTML = lines.join('<br/>');
  }

  let rec = null;
  function sttStart(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){
      log('stt_unsupported');
      toast('assistantText','bad','æœ¬è£ç½®ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼ˆSpeechRecognitionï¼‰ã€‚');
      return;
    }
    if(rec){ try{rec.stop();}catch(e){} rec=null; }
    rec = new SR();
    rec.lang = 'zh-TW';
    rec.interimResults = false;
    rec.maxAlternatives = 1;
    rec.onstart = function(){ log('stt_start'); toast('assistantText','ok','æˆ‘åœ¨è½ã€‚èªªå®Œæœƒè‡ªå‹•åœã€‚'); };
    rec.onerror = function(e){ log('stt_error: ' + (e && e.error ? e.error : 'unknown')); };
    rec.onresult = function(ev){
      try{
        const t = ev.results && ev.results[0] && ev.results[0][0] ? ev.results[0][0].transcript : '';
        log('stt_text: ' + t);
        // simple router
        const txt = (t||'').trim();
        if(!txt){ toast('assistantText','bad','æ²’æœ‰è½åˆ°å…§å®¹ã€‚'); return; }
        if(txt.includes('å¿ƒè·³')) doHeartbeat();
        else if(txt.includes('å‘¼å¸')) doBreath();
        else if(txt.includes('è¡€å£“')) doPressure();
        else if(txt.includes('æ“²') || txt.includes('ç­Š')) doCup();
        else if(txt.includes('è¨±é¡˜')) document.getElementById('wishText').focus();
        else toast('assistantText','ok','æ”¶åˆ°ï¼š' + txt + '<br/>ä½ å¯ä»¥èªªï¼šå¿ƒè·³ã€å‘¼å¸ã€è¡€å£“ã€æ“²ç­Šã€è¨±é¡˜ã€‚');
      }catch(e){}
    };
    rec.onend = function(){ log('stt_stop'); };
    try{ rec.start(); }catch(e){ log('stt_start_fail: ' + (e && e.message ? e.message : String(e))); }
  }
  function sttStop(){ try{ if(rec) rec.stop(); }catch(e){} log('stt_stop_btn'); }

  // ===== Seven Fairies Data =====
  const FAIRIES = [
    {id:'f1', name:'å¤§ä»™å¥³ï¼ˆå·§é›²ï¼‰', star:'å¤©æ¨', mode:'åšç©º', point:14520, duty:'é¢¨èª¿é›¨é †'},
    {id:'f2', name:'äºŒä»™å¥³ï¼ˆå·§è™¹ï¼‰', star:'å¤©ç’‡', mode:'åšå¤š', point:14866, duty:'å®¶åº­ç¾æ»¿'},
    {id:'f3', name:'ä¸‰ä»™å¥³ï¼ˆå·§èŠï¼‰', star:'å¤©ç’£', mode:'åšç©º', point:16184, duty:'è‚²å­æ”¶é©š'},
    {id:'f4', name:'å››ä»™å¥³ï¼ˆå·§ä»™ï¼‰', star:'å¤©æ¬Š', mode:'åšå¤š', point:16888, duty:'äº‹æ¥­é‹é€š'},
    {id:'f5', name:'äº”ä»™å¥³ï¼ˆå·§è˜­ï¼‰', star:'å¤©è¡¡', mode:'åšç©º', point:17347, duty:'é•·å‘½ç™¾æ­²'},
    {id:'f6', name:'å…­ä»™å¥³ï¼ˆå·§æ¢…ï¼‰', star:'é—“é™½', mode:'åšå¤š', point:18056, duty:'èº«é«”å¥åº·'},
    {id:'f7', name:'ä¸ƒä»™å¥³ï¼ˆå·§éˆï¼‰', star:'ç‘¤å…‰', mode:'å¤šå–®é€€', point:18459, duty:'æ„Ÿæƒ…åœ“æ»¿'}
  ];

  function renderFairies(){
    const grid = document.getElementById('fairyGrid');
    grid.innerHTML = '';
    FAIRIES.forEach(f=>{
      const el = document.createElement('div');
      el.className = 'node';
      el.innerHTML = `
        <h3>â­ ${f.star}ï½œ${f.name}</h3>
        <div class="muted" style="margin-top:6px;line-height:1.65">
          åº§æ¨™é»ï¼š<b>${f.point}</b><br/>
          å°ˆæŒï¼š<b>${f.duty}</b><br/>
          æ°£è„ˆï¼š<b>${f.mode}</b>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn small" data-wish="${f.id}">æŠ•å‘è¨±é¡˜æ± </button>
        </div>
      `;
      grid.appendChild(el);
    });

    // bind wish buttons
    grid.querySelectorAll('button[data-wish]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-wish');
        const sel = document.getElementById('wishFairy');
        sel.value = id;
        document.getElementById('wishText').focus();
        log('wish_route=' + id);
      });
    });
  }

  function fillWishSelect(){
    const sel = document.getElementById('wishFairy');
    sel.innerHTML = '';
    FAIRIES.forEach(f=>{
      const opt = document.createElement('option');
      opt.value = f.id;
      opt.textContent = `${f.star}ï½œ${f.name}ï½œ${f.duty}ï½œ${f.mode}ï½œ${f.point}`;
      sel.appendChild(opt);
    });
  }

  // ===== Wish Pool =====
  const WISH_KEY = 'WK_WISH_POOL_V1';
  function loadWishes(){
    try{ return JSON.parse(localStorage.getItem(WISH_KEY)||'[]') || []; }catch(e){ return []; }
  }
  function saveWishes(arr){ localStorage.setItem(WISH_KEY, JSON.stringify(arr||[])); }
  function updateWishCount(){
    const arr = loadWishes();
    // count today
    const today = new Date();
    const ymd = today.getFullYear()+"-"+String(today.getMonth()+1).padStart(2,'0')+"-"+String(today.getDate()).padStart(2,'0');
    const n = arr.filter(x=> (x && x.ymd===ymd)).length;
    document.getElementById('wishCount').textContent = `ä»Šæ—¥è¨±é¡˜ï¼š${n}`;
  }

  function makeWishObject(){
    const fid = document.getElementById('wishFairy').value;
    const f = FAIRIES.find(x=>x.id===fid) || FAIRIES[0];
    const text = (document.getElementById('wishText').value||'').trim();
    const vow = (document.getElementById('wishVow').value||'').trim();
    const t = new Date();
    const ymd = t.getFullYear()+"-"+String(t.getMonth()+1).padStart(2,'0')+"-"+String(t.getDate()).padStart(2,'0');
    return {
      boot_version: BOOT_VERSION,
      at: t.toISOString(),
      ymd,
      wallet: connectedAddr,
      fairy: {
        id: f.id, name: f.name, star: f.star, duty: f.duty, mode: f.mode, point: f.point
      },
      wish: {
        text,
        vow
      }
    };
  }

  function wishSubmit(){
    log('wish_submit');
    wukongSound('è¨±é¡˜å·²æŠ•ä¸‹');
    const obj = makeWishObject();
    if(!obj.wish.text){
      toast('wishOut','bad','è«‹å…ˆå¯«ä¸‹é¡˜æœ›å…§å®¹ã€‚');
      return;
    }
    const arr = loadWishes();
    arr.push(obj);
    saveWishes(arr);
    updateWishCount();
    toast('wishOut','ok',`å·²æŠ•ä¸‹è¨±é¡˜ã€‚<br/>å®ˆè­·ï¼š<b>${obj.fairy.star}</b>ï½œ${obj.fairy.name}<br/>é¡˜æœ›ï¼š${escapeHtml(obj.wish.text)}`);
  }

  function exportWish(){
    log('wish_export');
    const obj = makeWishObject();
    if(!obj.wish.text){
      toast('wishOut','bad','è«‹å…ˆå¯«ä¸‹é¡˜æœ›å…§å®¹å¾Œå†åŒ¯å‡ºã€‚');
      return;
    }
    downloadJson(`wish_${obj.fairy.id}_${Date.now()}.json`, obj);
    toast('wishOut','ok','å·²åŒ¯å‡º JSONï¼ˆä¸‹è¼‰æˆ–åˆ†äº«çµ¦æ¯æ©Ÿï¼‰ã€‚');
  }

  // ===== Export State =====
  function downloadJson(filename, obj){
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1200);
  }

  function exportState(){
    log('export_json');
    const cfg = loadCfg();
    const state = {
      boot_version: BOOT_VERSION,
      at: new Date().toISOString(),
      wallet: connectedAddr,
      chain: chainInfoEl.textContent,
      cup_streak: cupStreak,
      cfg,
      wish_today_count: document.getElementById('wishCount').textContent,
    };
    downloadJson(`wukong_temple_state_${Date.now()}.json`, state);
  }

  // ===== Small utils =====
  function escapeHtml(str){
    return String(str||'')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  // ===== Bind UI =====
  document.getElementById('btnSelfcheck').addEventListener('click', selfCheck);
  document.getElementById('btnClearLog').addEventListener('click', ()=>{ logEl.textContent=''; log('log_cleared'); });
  document.getElementById('btnHideDbg').addEventListener('click', ()=>{ document.getElementById('debug').style.display='none'; });

  document.getElementById('btnHeartbeat').addEventListener('click', doHeartbeat);
  document.getElementById('btnBreath').addEventListener('click', doBreath);
  document.getElementById('btnPressure').addEventListener('click', doPressure);
  document.getElementById('btnCup').addEventListener('click', doCup);
  document.getElementById('btnFortune').addEventListener('click', fortuneClaim);

  document.getElementById('btnConnect').addEventListener('click', ()=>{ bindEthEvents(); connectWallet(); });
  document.getElementById('btnDisconnect').addEventListener('click', disconnectWallet);
  document.getElementById('btnExport').addEventListener('click', exportState);

  document.getElementById('btnAssistant').addEventListener('click', assistantStart);
  document.getElementById('btnSTT').addEventListener('click', sttStart);
  document.getElementById('btnStopSTT').addEventListener('click', sttStop);

  document.getElementById('btnSaveCfg').addEventListener('click', ()=>{
    const faucet = (document.getElementById('inFaucet').value||'').trim();
    const kufo = (document.getElementById('inKUFO').value||'').trim();
    const cfg = loadCfg();
    if(faucet) cfg.faucet = faucet;
    if(kufo) cfg.kufo = kufo;
    saveCfg(cfg);
    applyCfgToUI(cfg);
    log('cfg_saved');
    toast('assistantText','ok','è¨­å®šå·²ä¿å­˜ï¼ˆæœ¬æ©Ÿï¼‰ã€‚');
  });

  document.getElementById('btnClearCfg').addEventListener('click', ()=>{
    saveCfg({});
    applyCfgToUI({});
    document.getElementById('inFaucet').value='';
    document.getElementById('inKUFO').value='';
    log('cfg_cleared');
    toast('assistantText','ok','å·²æ¸…é™¤è¨­å®šï¼ˆæœ¬æ©Ÿï¼‰ã€‚');
  });

  document.getElementById('btnLoadFairies').addEventListener('click', ()=>{
    fillWishSelect();
    toast('wishOut','ok','å·²è¼‰å…¥ä¸ƒä»™å¥³åˆ°è¨±é¡˜æ± ã€‚');
    log('fairies_loaded_to_wishpool');
  });

  document.getElementById('btnWish').addEventListener('click', wishSubmit);
  document.getElementById('btnWishExport').addEventListener('click', exportWish);

  function applyCfgToUI(cfg){
    document.getElementById('faucetAddr').textContent = cfg.faucet || '(to be set after deploy)';
    document.getElementById('kufoAddr').textContent = cfg.kufo || '(to be set after deploy)';
  }

  // ===== Boot init =====
  (function init(){
    log('boot_version=' + BOOT_VERSION);
    // render fairies + wish select
    renderFairies();
    fillWishSelect();
    updateWishCount();

    // load cfg
    const cfg = loadCfg();
    applyCfgToUI(cfg);
    if(cfg.faucet) document.getElementById('inFaucet').value = cfg.faucet;
    if(cfg.kufo) document.getElementById('inKUFO').value = cfg.kufo;


    // sound ui
    try{
      const sm = document.getElementById('soundMode');
      const bt = document.getElementById('btnTestSound');
      if(sm){
        sm.value = getSoundMode();
        sm.addEventListener('change', ()=>{ setSoundMode(sm.value); log('sound_mode=' + sm.value); }, true);
      }
      if(bt){
        bt.addEventListener('click', ()=>{ wukongSound('æ‚Ÿç©ºåœ¨æ­¤'); log('sound_test'); }, true);
      }
    }catch(e){}
    // first selfcheck
    selfCheck();
  })();

})();
</script>

</body>
</html>
