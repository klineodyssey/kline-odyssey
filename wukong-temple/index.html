<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>五指山・悟空財神殿｜Wukong Fortune Hall</title>
<style>
  :root { --bg:#0b0f14; --card:#111827; --muted:#9ca3af; --txt:#e5e7eb; --acc:#f59e0b; --ok:#10b981; --bad:#ef4444; --line:#1f2937; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#070a0f,#0b0f14 30%,#070a0f);color:var(--txt);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif}
  a{color:#93c5fd;text-decoration:none}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .hero{padding:12px 14px;border:1px solid var(--line);background:rgba(17,24,39,.65);border-radius:16px}
  .row{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
  @media (min-width:860px){.row{grid-template-columns:1.1fr .9fr}}
  .card{padding:12px 14px;border:1px solid var(--line);background:rgba(17,24,39,.55);border-radius:16px}
  .h{font-weight:800;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:13px;line-height:1.4}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.25);font-size:12px;color:var(--muted)}
  .btn{cursor:pointer;border:1px solid var(--line);background:rgba(0,0,0,.25);color:var(--txt);padding:10px 12px;border-radius:12px;font-weight:700}
  .btn:hover{border-color:#334155}
  .btn.acc{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.35)}
  .btn.ok{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.35)}
  .btn.bad{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .k{color:var(--muted);font-size:12px}
  input,select,textarea{width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.25);color:var(--txt)}
  textarea{min-height:84px;resize:vertical}
  pre{white-space:pre-wrap;background:rgba(0,0,0,.35);padding:10px;border-radius:12px;border:1px solid var(--line);color:#d1d5db}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .tagok{color:var(--ok);font-weight:800}
  .tagbad{color:var(--bad);font-weight:800}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  details>summary{cursor:pointer;color:#cbd5e1;font-weight:800}
  .mini{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <div class="h">🐒 五指山・悟空財神殿｜Wukong Fortune Hall</div>
    <div class="sub">
      <span class="pill mono">boot_version=<span id="bootVer">v3.3.1-voicefix</span></span>
      <span class="pill mono" id="envPill">env: ...</span>
      <span class="pill">🌐 <a href="../" target="_blank" rel="noopener">Official Website</a></span>
    </div>
    <div class="hr"></div>
    <div class="sub">這裡不是一般廟。心跳・呼吸・血壓・擲筊・許願池・光明燈・宇宙細包・生命工廠，都以「本機原型」先建好，等 Faucet / KUFO 上鏈後再接地址。</div>
  </div>

  <div class="row">
    <div class="card">
      <div class="h">🫁 宇宙生命徵象｜Cosmic Vitals</div>
      <div class="sub">（本機記錄）每次按鍵都會寫入 Debug Console，方便你貼回來定位問題。</div>
      <div class="hr"></div>
      <div class="grid3">
        <button class="btn acc" id="btnHeartbeat">❤️ 心跳</button>
        <button class="btn acc" id="btnBreath">🫁 呼吸</button>
        <button class="btn acc" id="btnPressure">🩸 血壓</button>
      </div>
      <div style="margin-top:10px" class="grid2">
        <button class="btn" id="btnCup">🥢 擲筊</button>
        <button class="btn ok" id="btnFortune">🧧 領發財金（需合約）</button>
      </div>
      <div style="margin-top:10px" class="sub">
        聖筊連勝：<span class="mono" id="cupStreak">0</span> / 3　
        <span id="cupResult" class="mono"></span>
      </div>

      <div class="hr"></div>

      <div class="h">🔊 聲音（TTS / 叮）</div>
      <div class="sub">Auto：有 TTS 就用 TTS，否則用叮聲。MetaMask WebView 常會 speechSynthesis=false。</div>
      <div class="grid2" style="margin-top:10px">
        <select id="soundMode">
          <option value="auto">Auto</option>
          <option value="tts">TTS</option>
          <option value="beep">叮（WebAudio）</option>
          <option value="off">關閉</option>
        </select>
        <button class="btn" id="btnSoundTest">測試</button>
      </div>
    </div>

    <div class="card">
      <div class="h">🪪 錢包狀態（BSC 主網）</div>
      <div class="sub">Chrome 開啟可能有 TTS，但可能沒有錢包注入；MetaMask 內建 WebView 反之。</div>
      <div class="hr"></div>
      <div class="grid2">
        <button class="btn ok" id="btnConnect">連線錢包</button>
        <button class="btn" id="btnDisconnect">斷開（UI）</button>
      </div>
      <div style="margin-top:10px" class="grid2">
        <button class="btn" id="btnExportState">匯出狀態 JSON</button>
        <button class="btn bad" id="btnClearState">清除本機狀態</button>
      </div>

      <div class="hr"></div>
      <div class="mini mono">Wallet</div>
      <div class="mono" id="walletAddr">(not connected)</div>
      <div class="mini mono" style="margin-top:8px">Chain</div>
      <div class="mono" id="chainId">(unknown)</div>

      <div class="hr"></div>
      <div class="h">⚙️ 設定面板（本機儲存，不上鏈）</div>
      <div class="sub">把已部署合約地址貼上來，讓按鍵知道要打哪個合約。</div>
      <div class="hr"></div>
      <div class="k">Faucet 合約地址</div>
      <input id="cfgFaucet" placeholder="0x..."/>
      <div class="k" style="margin-top:8px">KUFO 無人銀行合約地址</div>
      <input id="cfgKufo" placeholder="0x..."/>
      <div class="k" style="margin-top:8px">回收地址（R1/R2/R3）</div>
      <div class="grid3">
        <input id="cfgR1" placeholder="R1 0x..."/>
        <input id="cfgR2" placeholder="R2 0x..."/>
        <input id="cfgR3" placeholder="R3 0x..."/>
      </div>
      <div class="k" style="margin-top:8px">公益國庫（預設）</div>
      <input id="cfgPG" value="0xB73D6716005B37BEC742D64482fA26033eE1A4E1"/>

      <div class="grid2" style="margin-top:10px">
        <button class="btn ok" id="btnCfgSave">保存</button>
        <button class="btn" id="btnCfgClear">清除</button>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="h">🎧 影像語音客服（本機）</div>
    <div class="sub">按「啟動客服」會朗讀規則（TTS 或叮）。也可語音輸入（裝置支援才會有 STT）。</div>
    <div class="hr"></div>
    <div class="grid3">
      <button class="btn acc" id="btnAssistantStart">▶️ 啟動客服</button>
      <button class="btn" id="btnSttStart">🎙️ 語音輸入</button>
      <button class="btn" id="btnSttStop">⏹️ 停止</button>
    </div>
    <div class="hr"></div>
    <div class="mono" id="assistantBox">悟空客服：按「啟動客服」會顯示規則解說。</div>
  </div>

  <div class="row" style="margin-top:12px">
    <div class="card">
      <div class="h">✨ 七仙女星座盤｜七星守護</div>
      <div class="sub">載入後可直接投向許願池。</div>
      <div class="hr"></div>
      <button class="btn" id="btnLoadFairies">載入到許願池</button>
      <div class="hr"></div>
      <div id="fairyList"></div>
    </div>

    <div class="card">
      <div class="h">💧 七仙女許願池（Wish Pool）</div>
      <div class="sub">本機記錄。上鏈後可接 KUFO / 回收地址決定還願與席位。</div>
      <div class="hr"></div>
      <div class="sub">今日許願：<span class="mono" id="wishCount">0</span></div>
      <div class="hr"></div>
      <div class="k">選擇守護仙女</div>
      <select id="wishSelect"></select>
      <div class="k" style="margin-top:8px">願望內容（不要留個資）</div>
      <textarea id="wishText" placeholder="寫下你的願望..."></textarea>
      <div class="k" style="margin-top:8px">誓言（選填）</div>
      <input id="wishOath" placeholder="我願意..."/>
      <div class="grid2" style="margin-top:10px">
        <button class="btn acc" id="btnWishSubmit">投下許願</button>
        <button class="btn" id="btnWishExport">匯出許願 JSON</button>
      </div>
      <div class="hr"></div>
      <div class="mono" id="wishEcho">選好仙女，寫下願望，按下「投下許願」。</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="h">🕯️ 12 生肖光明燈（每生肖 72 名）＋第13肖（任意物種）</div>
    <div class="sub">這是「廟的有限額」玩法：12×72 = 864 盞。第 13 肖是擴充槽：任意物種（變形金剛、大象、蟻人、外星人、孫悟空猴毛…）。</div>
    <div class="hr"></div>
    <div class="grid2">
      <button class="btn" id="btnLampInit">初始化名冊</button>
      <button class="btn" id="btnLampExport">匯出名冊 JSON</button>
    </div>
    <div class="hr"></div>
    <div class="grid2">
      <div>
        <div class="k">選擇生肖/第13肖</div>
        <select id="lampZodiac"></select>
      </div>
      <div>
        <div class="k">你的名字（不要留個資）</div>
        <input id="lampName" placeholder="例如：巧雲"/>
      </div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <div>
        <div class="k">第13肖物種（選填）</div>
        <input id="lampSpecies" placeholder="例如：變形金剛 / 大象 / 猿人 / 猴毛..."/>
      </div>
      <div>
        <div class="k">年期（預設 1 年）</div>
        <select id="lampTerm">
          <option value="365">365 天</option>
          <option value="30">30 天（測試）</option>
          <option value="500">500 天（五指山）</option>
        </select>
      </div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <button class="btn acc" id="btnLampRegister">點燈登記</button>
      <button class="btn bad" id="btnLampClear">清除名冊（本機）</button>
    </div>
    <div class="hr"></div>
    <div class="mono" id="lampStats">尚未初始化</div>
    <pre class="mono" id="lampPreview">（尚無資料）</pre>
  </div>

  <div class="row" style="margin-top:12px">
    <div class="card">
      <div class="h">🧬 宇宙細包（Microcell Shop）</div>
      <div class="sub">讓信眾建立自己的 KGEN 細包商店：付款路由可選 KUFO / 公益國庫 / 回收 R1~R3。這只是本機原型，等合約上鏈再接。</div>
      <div class="hr"></div>
      <div class="grid2">
        <div><div class="k">細包名稱</div><input id="mcName" placeholder="例如：花果山服飾店"/></div>
        <div><div class="k">分類</div><input id="mcCategory" placeholder="服飾 / 餐飲 / 心臟紅利..."/></div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <div><div class="k">物種（任意）</div><input id="mcSpecies" placeholder="人類 / 變形金剛 / 大象..."/></div>
        <div><div class="k">座標（可填 8888/11520/18888 或自定）</div><input id="mcLoc" placeholder="例如：11520"/></div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <div><div class="k">紅利（bps，例 888=8.88%）</div><input id="mcBps" placeholder="例如：888"/></div>
        <div><div class="k">付款路由</div>
          <select id="mcRoute">
            <option value="KUFO">KUFO 無人銀行</option>
            <option value="PG">公益國庫</option>
            <option value="R1">回收 R1</option>
            <option value="R2">回收 R2</option>
            <option value="R3">回收 R3</option>
          </select>
        </div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <button class="btn acc" id="btnMcCreate">建立細包</button>
        <button class="btn" id="btnMcExport">匯出細包 JSON</button>
      </div>
      <div class="hr"></div>
      <div class="mono" id="mcStats">細包：0</div>
      <pre class="mono" id="mcList">（尚無細包）</pre>
      <button class="btn bad" id="btnMcClear" style="margin-top:10px">清除細包（本機）</button>
    </div>

    <div class="card">
      <div class="h">🏭 
  <!-- =========================
       🧠 Wukong Brain Foundry (Local Prototype)
       ========================= -->
  <div class="card" id="brain">
    <div class="card-hd">
      <div class="title">🧠 悟空大腦｜Brain Foundry</div>
      <div class="sub">腦容量上限：<b id="brainCap">50,000,000</b> KGEN（募資/鎖倉概念；未上鏈前只做本機紀錄）</div>
    </div>

    <div class="grid2">
      <div class="kv">
        <div class="k">目前淨投入（本機）</div>
        <div class="v"><b id="brainNet">0</b> KGEN</div>
      </div>
      <div class="kv">
        <div class="k">進度</div>
        <div class="v"><b id="brainPct">0%</b></div>
      </div>
    </div>

    <div class="note">
      規則（神殿版）：大腦不是保證報酬；它是「Kline App Game」未來研發的能量池。
      你可以投入（視為開發能量），也可以提領（視為能量撤回／往生）。
      上鏈後是否允許提領，由 Brain 合約的天條決定；本頁先提供可提領的原型流程。
    </div>

    <div class="row">
      <input id="brainAmount" class="inp" inputmode="decimal" placeholder="輸入 KGEN 數量（原型）" />
      <button class="btn" id="btnBrainDeposit">投入</button>
      <button class="btn" id="btnBrainWithdraw">提領</button>
    </div>

    <div class="row">
      <button class="btn ghost" id="btnBrainExport">匯出 Brain JSON</button>
      <button class="btn ghost" id="btnBrainClear">清除本機紀錄</button>
    </div>

    <pre class="mono" id="brainList">(尚無紀錄)</pre>
  </div>
生命工廠（
  <!-- =========================
       Kline App Game MVP (local prototype)
       ========================= -->
  <div class="card" id="klineGameMVP">
    <h2>🎮 Kline App Game｜MVP（本機原型）</h2>
    <div class="muted" style="margin-top:6px">
      玩法（你定的世界線）：0–170 做多；170–190 休息；190–360 做空。<br/>
      這版先做「可玩可記帳」：選日期→選多/空→輸入入場/出場→用 KGEN 當能量值→立即結算（或先存為待結算）。
    </div>

    <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap">
      <div style="min-width:160px">
        <div class="label">市場</div>
        <select id="kg_market" class="input">
          <option value="TX">TX（台指）</option>
          <option value="BTC">BTC</option>
          <option value="NASDAQ">NASDAQ</option>
        </select>
      </div>

      <div style="min-width:160px">
        <div class="label">日期（YYYYMMDD）</div>
        <input id="kg_date" class="input" placeholder="20260213" />
      </div>

      <div style="min-width:160px">
        <div class="label">入場價</div>
        <input id="kg_entry" class="input" placeholder="0" inputmode="decimal"/>
      </div>

      <div style="min-width:160px">
        <div class="label">出場價（可空白＝待結算）</div>
        <input id="kg_exit" class="input" placeholder="" inputmode="decimal"/>
      </div>
    </div>

    <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap; align-items:flex-end">
      <div style="min-width:160px">
        <div class="label">能量（Energy）</div>
        <input id="kg_stake" class="input" placeholder="100" inputmode="decimal"/>
      </div>

      <div style="min-width:260px; flex:1">
        <div class="label">槓桿（1～150）</div>
        <input id="kg_lev" type="range" min="1" max="150" value="10" style="width:100%"/>
        <div class="muted">目前：<span id="kg_lev_v">10</span>x</div>
      </div>

      <div style="min-width:260px">
        <div class="label">選擇世界線</div>
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <button class="btn" id="kg_btn_long">做多（0–170）</button>
          <button class="btn" id="kg_btn_rest">休息（170–190）</button>
          <button class="btn" id="kg_btn_short">做空（190–360）</button>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap">
      <button class="btn primary" id="kg_btn_settle">開局 / 結算（本機）</button>
      <button class="btn" id="kg_btn_export">匯出 Game JSON</button>
      <button class="btn danger" id="kg_btn_clear">清除本機紀錄</button>
    </div>

    <div class="muted" style="margin-top:10px">
      ✅ 宇宙規則：KGEN=質量（Mass）；能量（Energy）是行動力。1 指數點 = 1 KGEN（跨市場一致）。上鏈後可把能量改成鏈上鎖倉。本版先把邏輯與資料格式定住。
    </div>

    <pre id="kg_out" class="pre" style="margin-top:10px; max-height:240px; overflow:auto">(尚未開局)</pre>
  </div>

Life Factory｜宇宙細胞誕生）</div>
      <div class="sub">完成流程（點燈/許願/擲筊/還願）後可生成「生命藍圖 JSON」。上鏈版本可由 KUFO / Faucet 驗證條件。</div>
      <div class="hr"></div>
      <div class="grid2">
        <div><div class="k">生命名稱</div><input id="lfName" placeholder="例如：豬八戒 / 新人類 / 猿人"/></div>
        <div><div class="k">物種</div><input id="lfSpecies" placeholder="有機/無機/任意"/></div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <div><div class="k">出生地（座標）</div><input id="lfBirth" placeholder="例如：8888 / 11520 / 18888"/></div>
        <div><div class="k">Pulsar 心率（Hz，可真實或自定）</div><input id="lfPulsar" placeholder="例如：1.337"/></div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <button class="btn acc" id="btnLfMint">生成生命藍圖</button>
        <button class="btn" id="btnLfExport">匯出藍圖 JSON</button>
      </div>
      <div class="hr"></div>
      <pre class="mono" id="lfOut">（尚未生成）</pre>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="h">📜 品牌固定尾段</div>
    <div class="sub">PrimeForge 以母機之名，開啟金融生命。花果山台灣・信念不滅・市場無界。Where the Market Becomes the Myth.—— 樂天帝 ⌖</div>
  </div>

  <div class="card" style="margin-top:12px">
    <details open>
      <summary>Debug Console</summary>
      <div class="hr"></div>
      <div class="grid3">
        <button class="btn" id="btnLogSelfcheck">Selfcheck</button>
        <button class="btn" id="btnLogClear">Clear</button>
        <button class="btn" id="btnLogCopy">Copy</button>
      </div>
      <div style="margin-top:10px" class="grid2">
        <button class="btn acc" id="btnRunSelfTest">一鍵全測（All Buttons）</button>
        <button class="btn" id="btnUnlockAudio">解鎖音訊</button>
      </div>
      <pre class="mono" id="logBox" style="margin-top:10px">（尚無紀錄）</pre>
    </details>
  </div>
</div>

<script>
(function(){
  'use strict';
  const BOOT_VERSION = "v3.3.3-autopilot-stable";
  
const BUILD_HASH = "c1704d7632c2";
const NOW_ISO = () => new Date().toISOString();

  const Log = (function(){
    const KEY = 'wukong_log_v1';
    const box = () => document.getElementById('logBox');
    function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch(e){ return []; } }
    function save(arr){ try{ localStorage.setItem(KEY, JSON.stringify(arr.slice(-800))); }catch(e){} }
    function line(msg){
      const arr = load();
      const s = `[${NOW_ISO()}] ${msg}`;
      arr.push(s);
      save(arr);
      const el = box();
      if(el) el.textContent = arr.join('\n');
    }
    function clear(){ save([]); const el=box(); if(el) el.textContent='（已清除）'; line('log_cleared'); }
    function render(){ const el=box(); if(!el) return; el.textContent = load().join('\n') || '（尚無紀錄）'; }
    function copy(){
      const txt = load().join('\n');
      navigator.clipboard?.writeText(txt).then(()=>line('log_copied')).catch(()=>line('log_copy_failed'));
    }
    return { line, clear, render, copy };
  })();

  const U = { qs:(id)=>document.getElementById(id), clamp:(n,a,b)=>Math.max(a,Math.min(b,n)) };

  const Sound = (function(){
    let ctx = null;
    const modeEl = () => U.qs('soundMode');
    function hasTTS(){
      return !!(window.speechSynthesis && typeof window.speechSynthesis.speak==='function' && window.SpeechSynthesisUtterance);
    }
    function beep(){
      try{
        ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
        try{ if(ctx.state==='suspended') ctx.resume(); }catch(e){}
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 880; g.gain.value = 0.001;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        g.gain.exponentialRampToValueAtTime(0.15, ctx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.18);
        o.stop(ctx.currentTime + 0.2);
      }catch(e){ Log.line('beep_fail ' + (e?.message||e)); }
    }
    function tts(text){
      try{
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-TW'; u.rate = 1.02;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      }catch(e){ Log.line('tts_fail ' + (e?.message||e)); try{ beep(); }catch(_e){} }
    }
    function speak(text){
      const mode = (modeEl()?.value)||'auto';
      if(mode==='off') return;
      if(mode==='beep') return beep();
      if(mode==='tts') return hasTTS() ? tts(text) : beep();
      return hasTTS() ? tts(text) : beep();
    }
    function test(){ Log.line('sound_test'); speak('悟空財神殿，聲音測試。'); }
    function unlockOnGesture(){
      const once = ()=>{
        try{ if(ctx && ctx.state==='suspended') ctx.resume(); }catch(e){}
        try{ if(window.speechSynthesis) window.speechSynthesis.getVoices(); }catch(e){}
      };
      document.addEventListener('touchend', once, {once:true, passive:true});
      document.addEventListener('click', once, {once:true});
    }
    function init(){
      unlockOnGesture();
      const m = localStorage.getItem('wukong_sound_mode_v1');
      if(m && modeEl()) modeEl().value = m;
      modeEl()?.addEventListener('change', ()=>{
        const v = modeEl().value;
        localStorage.setItem('wukong_sound_mode_v1', v);
        Log.line('sound_mode=' + v);
      });
      U.qs('btnSoundTest')?.addEventListener('click', test);
    }
    window.wukongSound = speak; window.wukongSpeak = speak;
    return { speak, init };
  })();

  const Cfg = (function(){
    const KEY='wukong_cfg_v2';
    function load(){ try{ const d=JSON.parse(localStorage.getItem(KEY)||'{}'); return (d&&typeof d==='object')?d:{}; }catch(e){ return {}; } }
    function save(d){ try{ localStorage.setItem(KEY, JSON.stringify(d)); }catch(e){} }
    function applyToUI(d){
      U.qs('cfgFaucet').value = d.faucet||'';
      U.qs('cfgKufo').value = d.kufo||'';
      U.qs('cfgR1').value = d.recycle1||'';
      U.qs('cfgR2').value = d.recycle2||'';
      U.qs('cfgR3').value = d.recycle3||'';
      if(d.publicGood) U.qs('cfgPG').value = d.publicGood;
    }
    function readFromUI(){
      return {
        faucet: (U.qs('cfgFaucet').value||'').trim(),
        kufo: (U.qs('cfgKufo').value||'').trim(),
        recycle1: (U.qs('cfgR1').value||'').trim(),
        recycle2: (U.qs('cfgR2').value||'').trim(),
        recycle3: (U.qs('cfgR3').value||'').trim(),
        publicGood: (U.qs('cfgPG').value||'').trim(),
      };
    }
    function init(){
      const d=load(); applyToUI(d);
      U.qs('btnCfgSave')?.addEventListener('click', ()=>{ save(readFromUI()); Log.line('cfg_saved'); Sound.speak('設定已保存。'); });
      U.qs('btnCfgClear')?.addEventListener('click', ()=>{ save({}); applyToUI({}); Log.line('cfg_cleared'); Sound.speak('設定已清除。'); });
      return d;
    }
    return { load, init };
  })();

  const Ethers = (function(){
    function loadOnce(){ return new Promise((resolve)=>{ if(window.ethers) return resolve(true);
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js';
      s.onload=()=>resolve(!!window.ethers); s.onerror=()=>resolve(false);
      document.head.appendChild(s);
    });}
    async function ensure(){ if(window.ethers) return true; Log.line('ethers_load_attempt'); const ok=await loadOnce(); Log.line('ethers_loaded_after: '+ok); return ok; }
    return { ensure };
  })();

  const Wallet = (function(){
    const st={addr:'',chain:''};
    function setUI(){ U.qs('walletAddr').textContent=st.addr||'(not connected)'; U.qs('chainId').textContent=st.chain||'(unknown)'; }
    async function connect(){
      await Ethers.ensure();
      const eth=window.ethereum;
      if(!eth){ Log.line('wallet_connect_failed: no ethereum'); Sound.speak('沒有偵測到錢包注入。'); return; }
      try{
        const accs=await eth.request({method:'eth_requestAccounts'});
        st.addr=(accs&&accs[0])?accs[0].toLowerCase():'';
        st.chain=await eth.request({method:'eth_chainId'});
        setUI(); Log.line('wallet_connected='+st.addr); Sound.speak('錢包已連線。');
      }catch(e){ Log.line('wallet_connect_failed: '+(e?.message||e)); }
    }
    function disconnectUI(){ st.addr=''; st.chain=''; setUI(); Log.line('wallet_ui_disconnected'); }
    function bindEvents(){
      const eth=window.ethereum; if(!eth) return;
      eth.on?.('accountsChanged',(a)=>{ st.addr=(a&&a[0])?a[0].toLowerCase():''; Log.line('accountsChanged='+(st.addr||'(empty)')); setUI(); });
      eth.on?.('chainChanged',(c)=>{ st.chain=c; Log.line('chainChanged='+c); setUI(); });
    }
    function init(){ U.qs('btnConnect')?.addEventListener('click',connect); U.qs('btnDisconnect')?.addEventListener('click',disconnectUI); bindEvents(); setUI(); }
    return { init, state:st };
  })();

  const Vitals = (function(){
    const KEY='wukong_vitals_v1'; const S={cupStreak:0};
    function load(){ try{ const d=JSON.parse(localStorage.getItem(KEY)||'{}'); if(d&&typeof d==='object') S.cupStreak=d.cupStreak||0; }catch(e){} U.qs('cupStreak').textContent=String(S.cupStreak); }
    function save(){ try{ localStorage.setItem(KEY, JSON.stringify(S)); }catch(e){} }
    function heartbeat(){ Log.line('heartbeat'); Sound.speak('心跳。'); }
    function breath(){ Log.line('breath'); Sound.speak('呼吸。'); }
    function pressure(){ Log.line('pressure'); Sound.speak('血壓。'); }
    function cupThrow(){
      Log.line('cup_throw');
      const ok=Math.random()<0.5;
      if(ok){ S.cupStreak=Math.min(3,S.cupStreak+1); U.qs('cupResult').innerHTML='<span class="tagok">聖筊：成立</span>'; Sound.speak('聖筊成立。'); }
      else { S.cupStreak=0; U.qs('cupResult').innerHTML='<span class="tagbad">聖筊：未成</span>'; Sound.speak('未成。'); }
      U.qs('cupStreak').textContent=String(S.cupStreak); save();
    }
    function fortune(){ Log.line('fortune_click'); if(S.cupStreak<3){ Sound.speak('聖筊連勝不足三次。'); return; } Sound.speak('已解鎖。等待 Faucet 上鏈後啟用。'); }
    function init(){ load(); U.qs('btnHeartbeat')?.addEventListener('click',heartbeat); U.qs('btnBreath')?.addEventListener('click',breath); U.qs('btnPressure')?.addEventListener('click',pressure); U.qs('btnCup')?.addEventListener('click',cupThrow); U.qs('btnFortune')?.addEventListener('click',fortune); }
    return { init };
  })();

  const Assistant = (function(){
    let rec=null;
    function setBox(t){ U.qs('assistantBox').textContent=t; }
    function start(){
      Log.line('assistant_start');
      const t='規則：許願不等於保證。發財金是借你去做生意的禮物，不是強索回收。若要住進花果山火星齊天豪宅，門檻為五千 KGEN 還願，實際以 KUFO 無人銀行合約為準。';
      setBox('悟空客服：'+t);
      Sound.speak(t);
    }
    function sttStart(){
      const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!SR){ Log.line('stt_unavailable'); setBox('悟空客服：此裝置不支援語音輸入。'); return; }
      if(rec){ try{ rec.stop(); }catch(e){} rec=null; }
      rec=new SR(); rec.lang='zh-TW'; rec.interimResults=false; rec.maxAlternatives=1;
      rec.onstart=()=>Log.line('stt_start');
      rec.onend=()=>Log.line('stt_stop');
      rec.onerror=(e)=>Log.line('stt_error '+(e?.error||e?.message||e));
      rec.onresult=(e)=>{ const txt=e.results?.[0]?.[0]?.transcript||''; Log.line('stt_text='+txt); setBox('你說：'+txt); Sound.speak('我收到。'); };
      rec.start();
    }
    function sttStop(){ Log.line('stt_stop_btn'); try{ rec?.stop(); }catch(e){} rec=null; }
    function init(){ U.qs('btnAssistantStart')?.addEventListener('click',start); U.qs('btnSttStart')?.addEventListener('click',sttStart); U.qs('btnSttStop')?.addEventListener('click',sttStop); }
    return { init };
  })();

  const Fairies = (function(){
    const LIST=[
      {id:'f1', star:'天樞', name:'大仙女（巧雲）', point:14520, duty:'風調雨順', flow:'做空'},
      {id:'f2', star:'天璇', name:'二仙女（巧虹）', point:14866, duty:'家庭美滿', flow:'做多'},
      {id:'f3', star:'天璣', name:'三仙女（巧芝）', point:16184, duty:'育子收驚', flow:'做空'},
      {id:'f4', star:'天權', name:'四仙女（巧仙）', point:16888, duty:'事業運通', flow:'做多'},
      {id:'f5', star:'天衡', name:'五仙女（巧蘭）', point:17347, duty:'長命百歲', flow:'做空'},
      {id:'f6', star:'闓陽', name:'六仙女（巧梅）', point:18056, duty:'身體健康', flow:'做多'},
      {id:'f7', star:'瑤光', name:'七仙女（巧靈）', point:18459, duty:'感情圓滿', flow:'多單退'}
    ];
    const WKEY='wukong_wishpool_v1';
    function wishLoad(){ try{ return JSON.parse(localStorage.getItem(WKEY)||'[]')||[]; }catch(e){ return []; } }
    function wishSave(a){ try{ localStorage.setItem(WKEY, JSON.stringify(a.slice(-500))); }catch(e){} }
    function renderFairies(){
      const el=U.qs('fairyList'); if(!el) return;
      el.innerHTML='';
      LIST.forEach(f=>{
        const d=document.createElement('div'); d.className='card'; d.style.margin='10px 0';
        d.innerHTML=`<div class="h">⭐ ${f.star}｜${f.name}</div>
          <div class="sub">座標點：<span class="mono">${f.point}</span>　專掌：<b>${f.duty}</b>　氣脈：<b>${f.flow}</b></div>
          <button class="btn" style="margin-top:10px">投向許願池</button>`;
        d.querySelector('button')?.addEventListener('click', ()=>{ U.qs('wishSelect').value=f.id; Log.line('wish_route='+f.id); Sound.speak('已選擇守護仙女。'); });
        el.appendChild(d);
      });
    }
    function renderWishUI(){
      const sel=U.qs('wishSelect'); sel.innerHTML='';
      LIST.forEach(f=>{ const o=document.createElement('option'); o.value=f.id; o.textContent=`${f.star}｜${f.name}｜${f.duty}｜${f.flow}｜${f.point}`; sel.appendChild(o); });
      U.qs('wishCount').textContent=String(wishLoad().length);
    }
    function submitWish(){
      const who=U.qs('wishSelect').value;
      const txt=(U.qs('wishText').value||'').trim();
      const oath=(U.qs('wishOath').value||'').trim();
      if(!txt){ U.qs('wishEcho').textContent='請先寫下願望內容。'; Sound.speak('請先寫下願望內容。'); return; }
      const f=LIST.find(x=>x.id===who)||LIST[0];
      const a=wishLoad(); a.push({ts:NOW_ISO(), fairy:f, wish:txt, oath:oath}); wishSave(a);
      U.qs('wishCount').textContent=String(a.length);
      U.qs('wishEcho').textContent=`許願已投下：${f.name}｜${f.duty}。`;
      Log.line('wish_submit'); Sound.speak('許願已投下。');
    }
    function exportWish(){
      const a=wishLoad();
      const blob=new Blob([JSON.stringify(a,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const link=document.createElement('a');
      link.href=url; link.download=`wishpool_${BOOT_VERSION}.json`; link.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000);
      Log.line('export_wish_json');
    }
    function init(){
      U.qs('btnLoadFairies')?.addEventListener('click', ()=>{ renderFairies(); renderWishUI(); Log.line('fairies_loaded_to_wishpool'); Sound.speak('七仙女已載入。'); });
      U.qs('btnWishSubmit')?.addEventListener('click', submitWish);
      U.qs('btnWishExport')?.addEventListener('click', exportWish);
      renderWishUI();
    }
    return { init };
  })();

  const Lamps=(function(){
    const KEY='wukong_lamps_v1';
    const Z=['鼠','牛','虎','兔','龍','蛇','馬','羊','猴','雞','狗','豬','第13肖（任意物種）'];
    function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'{}'); }catch(e){ return {}; } }
    function save(d){ try{ localStorage.setItem(KEY, JSON.stringify(d)); }catch(e){} }
    function initRoster(){
      const d={boot:BOOT_VERSION,ts:NOW_ISO(),slots:{}}; Z.forEach(z=>d.slots[z]=[]);
      save(d); Log.line('lamp_init'); Sound.speak('光明燈名冊已初始化。'); render();
    }
    function render(){
      const d=load(); const stats=U.qs('lampStats'); const prev=U.qs('lampPreview');
      if(!d.slots){ stats.textContent='尚未初始化'; prev.textContent='（尚無資料）'; return; }
      let total=0; const lines=[];
      Z.forEach(z=>{
        const a=d.slots[z]||[]; total+=a.length; const cap=(z==='第13肖（任意物種）')?'∞':'72';
        lines.push(`${z}：${a.length} / ${cap}`);
        a.slice(-3).forEach(x=>lines.push(`  - ${x.name}｜term=${x.termDays}d｜exp=${x.exp}` + (x.species?`｜species=${x.species}`:'')));
      });
      stats.textContent=`已登記：${total} 盞（12×72=864 + 第13肖擴充）`;
      prev.textContent=lines.join('\n');
    }
    function register(){
      const d=load(); if(!d.slots){ Sound.speak('請先初始化名冊。'); return; }
      const z=U.qs('lampZodiac').value;
      const name=(U.qs('lampName').value||'').trim();
      const species=(U.qs('lampSpecies').value||'').trim();
      const termDays=parseInt(U.qs('lampTerm').value||'365',10);
      if(!name){ Sound.speak('請先填名字。'); return; }
      const a=d.slots[z]||[];
      if(z!=='第13肖（任意物種）' && a.length>=72){ Sound.speak('此生肖名額已滿。'); return; }
      const exp=new Date(Date.now()+termDays*86400*1000).toISOString().slice(0,10);
      a.push({name, species: z==='第13肖（任意物種）'?species:'', termDays, exp, ts:NOW_ISO()});
      d.slots[z]=a; save(d); Log.line('lamp_register '+z); Sound.speak('點燈登記完成。'); render();
    }
    function exportJson(){
      const d=load(); const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const link=document.createElement('a');
      link.href=url; link.download=`lamps_${BOOT_VERSION}.json`; link.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000); Log.line('export_lamps_json');
    }
    function clear(){ localStorage.removeItem(KEY); Log.line('lamp_cleared'); Sound.speak('光明燈名冊已清除。'); render(); }
    function init(){
      const sel=U.qs('lampZodiac'); sel.innerHTML=''; Z.forEach(z=>{ const o=document.createElement('option'); o.value=z; o.textContent=z; sel.appendChild(o); });
      U.qs('btnLampInit')?.addEventListener('click',initRoster);
      U.qs('btnLampRegister')?.addEventListener('click',register);
      U.qs('btnLampExport')?.addEventListener('click',exportJson);
      U.qs('btnLampClear')?.addEventListener('click',clear);
      render();
    }
    return { init };
  })();

  
  const Brain=(function(){
    const KEY='wukong_brain_v1';
    const CAP=50000000; // 50,000,000 KGEN cap (concept)
    function load(){ try{ const a=JSON.parse(localStorage.getItem(KEY)||'[]'); return Array.isArray(a)?a:[]; }catch(e){ return []; } }
    function save(a){ try{ localStorage.setItem(KEY, JSON.stringify(a)); }catch(e){} }
    function fmt(n){ try{ return (Number(n)||0).toLocaleString('en-US'); }catch(e){ return String(n||0); } }
    function getAddr(){ return (STATE.wallet && STATE.wallet.address) ? STATE.wallet.address : '(not connected)'; }

    function net(){
      const arr=load();
      let v=0;
      for(const x of arr){
        const amt=Number(x.amount)||0;
        if(x.type==='deposit') v+=amt;
        if(x.type==='withdraw') v-=amt;
      }
      return Math.max(0, v);
    }

    function render(){
      const arr=load();
      const netv=net();
      U.text('brainCap', fmt(CAP));
      U.text('brainNet', fmt(netv));
      const pct = CAP>0 ? Math.min(100, (netv/CAP)*100) : 0;
      U.text('brainPct', (pct.toFixed(2)+'%'));
      const el = U.el('brainList');
      if(!el) return;
      if(arr.length===0){ el.textContent='(尚無紀錄)'; return; }
      const lines = arr.slice().reverse().slice(0,80).map(x=>{
        const t=new Date(x.ts||Date.now()).toISOString().replace('T',' ').slice(0,19);
        return `• ${t}｜${x.type}｜${fmt(x.amount)} KGEN｜${x.addr||'-'}｜note:${x.note||''}`;
      });
      el.textContent = lines.join('\n');
    }

    function deposit(){
      const amt = Number((U.val('brainAmount')||'').trim());
      if(!amt || amt<=0){ Sound.ping('請輸入正確數量'); return; }
      const arr=load();
      arr.push({ts:Date.now(), type:'deposit', amount:amt, addr:getAddr(), note:'local-prototype'});
      save(arr);
      log('brain_deposit '+amt);
      Sound.ping('已紀錄投入');
      render();
    }

    function withdraw(){
      const amt = Number((U.val('brainAmount')||'').trim());
      if(!amt || amt<=0){ Sound.ping('請輸入正確數量'); return; }
      const netv=net();
      if(amt>netv){ Sound.ping('超過可提領餘額'); return; }
      const arr=load();
      arr.push({ts:Date.now(), type:'withdraw', amount:amt, addr:getAddr(), note:'local-prototype'});
      save(arr);
      log('brain_withdraw '+amt);
      Sound.ping('已紀錄提領');
      render();
    }

    function exportJson(){
      const payload = { version:'brain_v1', cap:CAP, net:net(), records:load(), cfg:STATE.cfg||{}, wallet:STATE.wallet||{} };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'wukong_brain_export.json';
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
      log('export_brain_json');
      Sound.ping('已匯出 Brain JSON');
    }

    function clear(){
      try{ localStorage.removeItem(KEY); }catch(e){}
      log('brain_cleared');
      Sound.ping('已清除');
      render();
    }

    function init(){
      U.on('btnBrainDeposit','click',deposit);
      U.on('btnBrainWithdraw','click',withdraw);
      U.on('btnBrainExport','click',exportJson);
      U.on('btnBrainClear','click',clear);
      U.on('brainAmount','keydown',(e)=>{ if(e.key==='Enter') deposit(); });
      render();
    }
    return { init, render, net };
  })();
const Microcell=(function(){
    const KEY='wukong_microcells_v1';
    function load(){ try{ const a=JSON.parse(localStorage.getItem(KEY)||'[]'); return Array.isArray(a)?a:[]; }catch(e){ return []; } }
    function save(a){ try{ localStorage.setItem(KEY, JSON.stringify(a.slice(-500))); }catch(e){} }
    function resolveRoute(route,cfg){
      if(route==='KUFO') return cfg.kufo||'';
      if(route==='PG') return cfg.publicGood||'';
      if(route==='R1') return cfg.recycle1||'';
      if(route==='R2') return cfg.recycle2||'';
      if(route==='R3') return cfg.recycle3||'';
      return '';
    }
    function render(cfg){
      const a=load(); U.qs('mcStats').textContent='細包：'+a.length;
      if(a.length===0){ U.qs('mcList').textContent='（尚無細包）'; return; }
      const lines=a.slice().reverse().map(x=>{
        const pay=resolveRoute(x.route,cfg);
        return `• ${x.name}｜${x.category||'-'}｜${x.species||'-'}｜座標 ${x.location||'-'}｜reward ${x.rewardBps||0}bps｜${x.route}` + (pay?` -> ${pay}`:'');
      });
      U.qs('mcList').textContent=lines.join('\n');
    }
    function create(cfg){
      const name=(U.qs('mcName').value||'').trim();
      const category=(U.qs('mcCategory').value||'').trim();
      const species=(U.qs('mcSpecies').value||'').trim();
      const location=(U.qs('mcLoc').value||'').trim();
      const rewardBps=parseInt((U.qs('mcBps').value||'0').trim(),10)||0;
      const route=U.qs('mcRoute').value;
      if(!name){ Sound.speak('請先填細包名稱。'); return; }
      const a=load(); a.push({ts:NOW_ISO(),name,category,species,location,rewardBps:U.clamp(rewardBps,0,5000),route});
      save(a); Log.line('mc_create'); Sound.speak('細包已建立。'); render(cfg);
    }
    function exportJson(){
      const a=load(); const blob=new Blob([JSON.stringify(a,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const link=document.createElement('a');
      link.href=url; link.download=`microcells_${BOOT_VERSION}.json`; link.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000); Log.line('export_microcells_json');
    }
    function clear(cfg){ localStorage.removeItem(KEY); Log.line('mc_cleared'); Sound.speak('細包已清除。'); render(cfg); }
    function init(cfg){
      U.qs('btnMcCreate')?.addEventListener('click',()=>create(cfg));
      U.qs('btnMcExport')?.addEventListener('click',exportJson);
      U.qs('btnMcClear')?.addEventListener('click',()=>clear(cfg));
      render(cfg);
    }
    return { init };
  })();

  const LifeFactory=(function(){
    const KEY='wukong_life_blueprints_v1';
    function load(){ try{ const a=JSON.parse(localStorage.getItem(KEY)||'[]'); return Array.isArray(a)?a:[]; }catch(e){ return []; } }
    function save(a){ try{ localStorage.setItem(KEY, JSON.stringify(a.slice(-200))); }catch(e){} }
    function make(){
      const name=(U.qs('lfName').value||'').trim();
      const species=(U.qs('lfSpecies').value||'').trim();
      const birth=(U.qs('lfBirth').value||'').trim();
      const pulsar=(U.qs('lfPulsar').value||'').trim();
      if(!name||!birth){ Sound.speak('請先填生命名稱與出生地。'); return null; }
      return { boot:BOOT_VERSION, ts:NOW_ISO(), name, species:species||'unspecified', birth, pulsarHz:pulsar||'auto',
        organs:{heart:'FaucetHeart',brain:'AutopilotBrain',bank:'KUFO',ufo:'KUFO-PocketTimeUFO'},
        rulesHint:{lamp72:true,wishpool:true,cup3:true,vow5000:true} };
    }
    function render(bp){ U.qs('lfOut').textContent=bp?JSON.stringify(bp,null,2):'（尚未生成）'; }
    function mint(){ const bp=make(); if(!bp) return; const a=load(); a.push(bp); save(a); render(bp); Log.line('life_blueprint_minted'); Sound.speak('生命藍圖已生成。'); }
    function exportJson(){
      const a=load(); const blob=new Blob([JSON.stringify(a,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const link=document.createElement('a');
      link.href=url; link.download=`life_blueprints_${BOOT_VERSION}.json`; link.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000); Log.line('export_life_json');
    }
    function init(){ U.qs('btnLfMint')?.addEventListener('click',mint); U.qs('btnLfExport')?.addEventListener('click',exportJson); render(null); }
    return { init };
  })();

  const State=(function(){
    function exportAll(){
      const payload={ boot:BOOT_VERSION, ts:NOW_ISO(), ua:navigator.userAgent,
        speechSynthesis:!!window.speechSynthesis, speechRecognition:!!(window.SpeechRecognition||window.webkitSpeechRecognition),
        ethers_loaded:!!window.ethers, ethereum_injected:!!window.ethereum, wallet:Wallet.state, cfg:Cfg.load() };
      const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const link=document.createElement('a');
      link.href=url; link.download=`wukong_state_${BOOT_VERSION}.json`; link.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000); Log.line('export_json');
    }
    function clearAll(){
      ['wukong_log_v1','wukong_cfg_v2','wukong_vitals_v1','wukong_wishpool_v1','wukong_lamps_v1','wukong_microcells_v1','wukong_life_blueprints_v1']
        .forEach(k=>localStorage.removeItem(k));
      Log.line('clear_state'); Sound.speak('本機狀態已清除。'); location.reload();
    }
    function init(){ U.qs('btnExportState')?.addEventListener('click',exportAll); U.qs('btnClearState')?.addEventListener('click',clearAll); }
    return { init };
  })();

  async function selfcheck(){
    Log.line('boot_version='+BOOT_VERSION);
    Log.line('selfcheck_start');
    Log.line('userAgent: '+navigator.userAgent);
    Log.line('speechSynthesis: '+(!!window.speechSynthesis));
    Log.line('speechRecognition: '+(!!(window.SpeechRecognition||window.webkitSpeechRecognition)));
    const ethersOk=await Ethers.ensure();
    Log.line('ethers_loaded_now: '+ethersOk);
    Log.line('ethereum_injected_now: '+(!!window.ethereum));
    const pill=U.qs('envPill');
    if(pill){
      pill.textContent = `env: TTS=${!!window.speechSynthesis} | ETH=${!!window.ethereum} | ethers=${ethersOk}`;
    }
  }

  function bindDebugButtons(){
    U.qs('btnLogSelfcheck')?.addEventListener('click',selfcheck);
    U.qs('btnLogClear')?.addEventListener('click',()=>Log.clear());
    U.qs('btnLogCopy')?.addEventListener('click',()=>Log.copy());
  
  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

  async function runSelfTest(){
    Log.line('SELFTEST_START ' + now());
    // 1) environment
    try{ selfcheck(); }catch(e){ Log.line('selfcheck_fail ' + (e?.message||e)); }

    // 2) try unlock audio (gesture still required on some browsers)
    try{ Log.line('audio_unlock_try'); Sound.speak('Audio unlock test'); }catch(e){ Log.line('audio_unlock_fail ' + (e?.message||e)); }

    // 3) sequentially click all known buttons
    const ids = [
      'btnHeartbeat','btnBreath','btnPressure','btnCup','btnAssistantStart',
      'btnSoundTest','btnKGENVerify','btnBrainPing','btnBrainRead',
      'kg_long','kg_short','kg_rest','kg_settle','kg_copy',
      'btnLifeMint','btnLifePulse','btnLifeBurn'
    ];
    for(const id of ids){
      const el = U.qs(id);
      if(!el){ Log.line('selftest_miss ' + id); continue; }
      try{
        Log.line('selftest_click ' + id);
        el.click();
      }catch(e){
        Log.line('selftest_click_fail ' + id + ' ' + (e?.message||e));
      }
      await sleep(220);
    }
    Log.line('SELFTEST_DONE ' + now());
  }

  function unlockAudio(){
    Log.line('audio_unlock_manual ' + now());
    try{ Sound.speak('Audio unlock'); }catch(e){ Log.line('audio_unlock_fail ' + (e?.message||e)); }
  }

  // Bind self-test & audio unlock buttons
  U.qs('btnRunSelfTest')?.addEventListener('click',()=>runSelfTest());
  U.qs('btnUnlockAudio')?.addEventListener('click',()=>unlockAudio());
}

  function boot(){
    U.qs('bootVer').textContent=BOOT_VERSION;
    Log.render();
    bindDebugButtons();
    Sound.init();
    const cfg=Cfg.init();
    Wallet.init();
    Vitals.init();
    Assistant.init();
    Fairies.init();
    Lamps.init();
    Brain.init();
    Microcell.init(cfg);
    LifeFactory.init();
    State.init();
    selfcheck();
  }

  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',boot,{once:true}); }
  else { boot(); }
})();
</script>


<!-- =========================
     🧠 Brain Foundry On-chain Panel (V3.2.0 add-on)
     ========================= -->
<section class="card" id="brain_onchain">
  <h2>🧠 悟空大腦｜Brain Foundry（鏈上）</h2>
  <p class="muted">需要已部署 Brain 合約地址；在有錢包注入（MetaMask WebView）時才會可按。<br/>提示：Chrome 一般沒有錢包注入；MetaMask WebView 常見 <code>speechSynthesis=false</code> 但錢包可用。</p>

  <div class="grid2">
    <div>
      <label>Brain 合約地址</label>
      <input id="cfg_brain" placeholder="0x..." />
    </div>
    <div>
      <label>受益人（可留空=自己）</label>
      <input id="brain_beneficiary" placeholder="0x..." />
    </div>
    <div>
      <label>投入（KGEN）</label>
      <input id="brain_amount" placeholder="例如 100" inputmode="decimal" />
    </div>
    <div>
      <label>提領路由</label>
      <select id="brain_route">
        <option value="0">自訂地址</option>
        <option value="1">KUFO</option>
        <option value="2">Public Good</option>
        <option value="3">Recycle1</option>
        <option value="4">Recycle2</option>
        <option value="5">Recycle3</option>
      </select>
    </div>
    <div>
      <label>自訂提領地址（route=自訂）</label>
      <input id="brain_to" placeholder="0x..." />
    </div>
    <div>
      <label>狀態</label>
      <pre id="brain_status" class="pre">(not loaded)</pre>
    </div>
  </div>

  <div class="row">
    <button id="btnBrainSave" class="btn">保存 Brain 地址</button>
    <button id="btnBrainRefresh" class="btn">刷新狀態</button>
    <button id="btnBrainDeposit" class="btn primary">投入大腦（deposit）</button>
    <button id="btnBrainWithdraw" class="btn danger">提領（withdraw）</button>
  </div>

  <details style="margin-top:10px;">
    <summary>合約 ABI / 注意事項</summary>
    <div class="muted" style="margin-top:8px; line-height:1.6;">
      這裡只呼叫大腦合約的 <code>deposit</code> / <code>withdraw</code> / <code>withdrawToRoute</code> / <code>credits</code>。
      若未部署 Faucet / KUFO，仍可先測 UI。地址上鏈後不建議頻繁改動。
    </div>
  </details>
</section>

<script>
// ------------------------------
// Brain Foundry On-chain (V3.2.0)
// ------------------------------
(function(){
  try{
    // bump boot version (UI uses BOOT_VERSION already, but keep a visible log)
    if(window.__wukong_log) window.__wukong_log('brain_panel_loaded');
  }catch(e){}

  const BRAIN_CFG_KEY = 'wukong_brain_v1';

  function loadBrainCfg(){
    try{ return JSON.parse(localStorage.getItem(BRAIN_CFG_KEY)||'{}') || {}; }catch(e){ return {}; }
  }
  function saveBrainCfg(cfg){
    try{ localStorage.setItem(BRAIN_CFG_KEY, JSON.stringify(cfg||{})); }catch(e){}
  }

  function q(id){ return document.getElementById(id); }

  function bootFill(){
    const cfg = loadBrainCfg();
    if(q('cfg_brain')) q('cfg_brain').value = cfg.brain || '';
  }

  const BRAIN_ABI = [
    'function VERSION() view returns (string)',
    'function KGEN() view returns (address)',
    'function CAP() view returns (uint256)',
    'function totalCredits() view returns (uint256)',
    'function credits(address) view returns (uint256)',
    'function routes() view returns (tuple(address kufo,address publicGood,address recycle1,address recycle2,address recycle3))',
    'function deposit(uint256 amount, address beneficiary)',
    'function withdraw(uint256 amount, address to)',
    'function withdrawToRoute(uint8 routeId, uint256 amount)'
  ];

  async function brainContract(){
    const addr = (q('cfg_brain')?.value||'').trim();
    if(!addr || !addr.startsWith('0x') || addr.length < 42) throw new Error('Brain address missing');
    if(!window.ethers) throw new Error('ethers not loaded');
    if(!window.ethereum) throw new Error('no ethereum');
    const provider = new ethers.BrowserProvider(window.ethereum);
    const signer = await provider.getSigner();
    return { c: new ethers.Contract(addr, BRAIN_ABI, signer), provider, signer };
  }

  function fmtU(x){
    try{ return ethers.formatUnits(x, 18); }catch(e){ return String(x); }
  }

  async function refreshBrain(){
    const out = q('brain_status');
    if(!out) return;
    try{
      const {c, signer} = await brainContract();
      const me = await signer.getAddress();
      const [ver,kgen,cap,total,route,credit] = await Promise.all([
        c.VERSION(), c.KGEN(), c.CAP(), c.totalCredits(), c.routes(), c.credits(me)
      ]);
      const lines = [];
      lines.push('VERSION: ' + ver);
      lines.push('KGEN: ' + kgen);
      lines.push('CAP: ' + fmtU(cap));
      lines.push('totalCredits: ' + fmtU(total));
      lines.push('myCredits: ' + fmtU(credit));
      lines.push('routes.KUFO: ' + route.kufo);
      lines.push('routes.PG: ' + route.publicGood);
      lines.push('routes.R1: ' + route.recycle1);
      lines.push('routes.R2: ' + route.recycle2);
      lines.push('routes.R3: ' + route.recycle3);
      out.textContent = lines.join('
');
      if(window.__wukong_log) window.__wukong_log('brain_refresh_ok');
    }catch(err){
      out.textContent = 'ERROR: ' + (err?.message || err);
      if(window.__wukong_log) window.__wukong_log('brain_refresh_err ' + (err?.message||err));
    }
  }

  async function depositBrain(){
    try{
      const {c, signer} = await brainContract();
      const me = await signer.getAddress();
      const amountStr = (q('brain_amount')?.value||'').trim();
      if(!amountStr) throw new Error('amount empty');
      const amt = ethers.parseUnits(amountStr, 18);
      const ben = (q('brain_beneficiary')?.value||'').trim() || me;
      const tx = await c.deposit(amt, ben);
      if(window.__wukong_log) window.__wukong_log('brain_deposit_tx ' + tx.hash);
      await tx.wait();
      if(window.__wukong_log) window.__wukong_log('brain_deposit_ok');
      await refreshBrain();
    }catch(err){
      if(window.__wukong_log) window.__wukong_log('brain_deposit_err ' + (err?.message||err));
      alert('Deposit failed: ' + (err?.message||err));
    }
  }

  async function withdrawBrain(){
    try{
      const {c, signer} = await brainContract();
      const me = await signer.getAddress();
      const amountStr = (q('brain_amount')?.value||'').trim();
      if(!amountStr) throw new Error('amount empty');
      const amt = ethers.parseUnits(amountStr, 18);
      const routeId = parseInt(q('brain_route')?.value||'0',10) || 0;
      if(routeId === 0){
        const to = (q('brain_to')?.value||'').trim() || me;
        const tx = await c.withdraw(amt, to);
        if(window.__wukong_log) window.__wukong_log('brain_withdraw_tx ' + tx.hash);
        await tx.wait();
      }else{
        const tx = await c.withdrawToRoute(routeId, amt);
        if(window.__wukong_log) window.__wukong_log('brain_withdrawRoute_tx ' + tx.hash);
        await tx.wait();
      }
      if(window.__wukong_log) window.__wukong_log('brain_withdraw_ok');
      await refreshBrain();
    }catch(err){
      if(window.__wukong_log) window.__wukong_log('brain_withdraw_err ' + (err?.message||err));
      alert('Withdraw failed: ' + (err?.message||err));
    }
  }

  function saveBrain(){
    const cfg = loadBrainCfg();
    cfg.brain = (q('cfg_brain')?.value||'').trim();
    saveBrainCfg(cfg);
    if(window.__wukong_log) window.__wukong_log('brain_cfg_saved');
    alert('Brain address saved (local).');
  }

  // hook buttons
  function hook(){
    bootFill();
    q('btnBrainSave')?.addEventListener('click', saveBrain);
    q('btnBrainRefresh')?.addEventListener('click', refreshBrain);
    q('btnBrainDeposit')?.addEventListener('click', depositBrain);
    q('btnBrainWithdraw')?.addEventListener('click', withdrawBrain);
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', hook);
  }else{
    hook();
  }
})();

// ------------------------------
// Kline App Game MVP (local)
// ------------------------------
(function(){
  const KG_KEY = 'kline_game_sessions_v1';
  function kgLoad(){ try{ const a=JSON.parse(localStorage.getItem(KG_KEY)||'[]'); return Array.isArray(a)?a:[]; }catch(e){ return []; } }
  function kgSave(a){ try{ localStorage.setItem(KG_KEY, JSON.stringify(a)); }catch(e){} }
  function now(){ return new Date().toISOString(); }
  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
  function asNum(v){ const n=Number(String(v).trim()); return Number.isFinite(n)?n:0; }
  function asStr(v){ return String(v||'').trim(); }
  function validYYYYMMDD(s){ return /^\d{8}$/.test(s); }

  let choice = 'LONG'; // default

  function ui(){
    return {
      market: document.getElementById('kg_market'),
      date: document.getElementById('kg_date'),
      entry: document.getElementById('kg_entry'),
      exit: document.getElementById('kg_exit'),
      stake: document.getElementById('kg_stake'),
      lev: document.getElementById('kg_lev'),
      levV: document.getElementById('kg_lev_v'),
      out: document.getElementById('kg_out'),
      btnLong: document.getElementById('kg_btn_long'),
      btnRest: document.getElementById('kg_btn_rest'),
      btnShort: document.getElementById('kg_btn_short'),
      btnSettle: document.getElementById('kg_btn_settle'),
      btnExport: document.getElementById('kg_btn_export'),
      btnClear: document.getElementById('kg_btn_clear'),
    };
  }

  function setChoice(c){
    choice=c;
    const u=ui();
    if(!u.btnLong) return;
    u.btnLong.classList.toggle('primary', c==='LONG');
    u.btnRest.classList.toggle('primary', c==='REST');
    u.btnShort.classList.toggle('primary', c==='SHORT');
    try{ log('game_choice=' + c); }catch(e){}
  }

  function settle(){
    const u=ui(); if(!u.out) return;
    const market = asStr(u.market?.value||'TX');
    const date = asStr(u.date?.value||'');
    const entry = asNum(u.entry?.value||0);
    const exitV = asStr(u.exit?.value||'');
    const exit = exitV==='' ? null : asNum(exitV);
    const stake = asNum(u.stake?.value||0);
    const lev = clamp(asNum(u.lev?.value||10), 1, 150);

    if(!validYYYYMMDD(date)){
      u.out.textContent = '日期格式錯誤：請輸入 YYYYMMDD（例如 20260213）';
      return;
    }
    if(energy<=0){
      u.out.textContent = '能量（Energy）必須 > 0';
      return;
    }
    if(choice!=='REST' && entry<=0){
      u.out.textContent = '入場價必須 > 0（做多/做空需要）';
      return;
    }

    const rec = {
      id: 'G' + Date.now(),
      ts: now(),
      market,
      date,
      action: choice,
      entry: entry || 0,
      exit: exit===null? null : exit,
      energy,
      stake: energy, // backward-compat alias
      leverage: lev,
      unit: 'KGEN_per_point',
      rule: '1point=1KGEN',
      status: 'PENDING',
      pnl: 0
    };

    if(choice==='REST'){
      rec.status='REST';
      rec.pnl=0;
    }else if(exit===null){
      rec.status='PENDING';
      rec.pnl=0;
    }else{
      let diff = (exit - entry);
      if(choice==='SHORT') diff = -diff;
      // Universe rule: 1 point = 1 KGEN (cross-market). Energy is your action mass->energy budget.
      let pnl = diff * lev;
      // Risk cap: lose at most -energy, win up to energy*lev
      pnl = clamp(pnl, -energy, energy*lev);
      rec.pnl_points = Number(diff.toFixed ? diff.toFixed(8) : diff);
      rec.pnl_kgen = Number(pnl.toFixed(8));
      // Keep rec.pnl for backward compatibility
      rec.pnl = rec.pnl_kgen;
      rec.status='SETTLED';
      rec.pnl = Number(pnl.toFixed(8));
    }

    const arr = kgLoad();
    arr.push(rec);
    kgSave(arr);

    const last = rec;
    const summary = {
      ok: true,
      note: '本機 MVP 結算完成（跨市場：1點=1KGEN）',
      last,
      stats: {
        total: arr.length,
        settled: arr.filter(x=>x.status==='SETTLED').length,
        pending: arr.filter(x=>x.status==='PENDING').length
      }
    };
    u.out.textContent = JSON.stringify(summary, null, 2);
    try{ log('game_settle ' + last.action + ' ' + last.market + ' ' + last.date); }catch(e){}
  }

  function exportJSON(){
    const arr = kgLoad();
    const blob = new Blob([JSON.stringify(arr, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'kline_game_sessions.json';
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
    try{ log('export_game_json'); }catch(e){}
  }

  function clearAll(){
    localStorage.removeItem(KG_KEY);
    const u=ui(); if(u.out) u.out.textContent='（已清除本機 Game 紀錄）';
    try{ log('game_cleared'); }catch(e){}
  }

  function init(){
    const u=ui();
    if(!u.btnSettle) return; // section may not exist
    // lev
    if(u.lev){
      u.lev.addEventListener('input', ()=>{ if(u.levV) u.levV.textContent = String(u.lev.value); });
      if(u.levV) u.levV.textContent = String(u.lev.value);
    }
    // choice
    u.btnLong?.addEventListener('click', ()=>setChoice('LONG'));
    u.btnRest?.addEventListener('click', ()=>setChoice('REST'));
    u.btnShort?.addEventListener('click', ()=>setChoice('SHORT'));
    setChoice('LONG');

    u.btnSettle?.addEventListener('click', settle);
    u.btnExport?.addEventListener('click', exportJSON);
    u.btnClear?.addEventListener('click', clearAll);
  }

  // wait DOM ready
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', init);
  }else{
    init();
  }
})();

</script>

</body>
</html>
