<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ‚Ÿç©ºè²¡ç¥æ®¿ï½œWukong Fortune Temple V2.2</title>
  <meta name="description" content="äº”æŒ‡å±±æ‚Ÿç©ºè²¡ç¥æ®¿ï¼šæœ‰å¿ƒè·³ã€æœ‰å‘¼å¸ã€å¯é©—è­‰ã€å¯åƒæ‹œã€å¯é‚„é¡˜ã€å¯é ˜ç™¼è²¡é‡‘ï¼ˆéœ€ä¸Šéˆå¿ƒè‡Ÿåˆç´„ï¼‰ã€‚" />
  <style>
    :root {
      --ink:#111;
      --bg:#fff;
      --soft:#fafafa;
      --muted:rgba(0,0,0,.66);
      --card-radius:16px;
    }
    body {
      margin:0; background:#f7f7f7; color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
    }
    .wrap { max-width: 920px; margin: 0 auto; padding: 16px; }
    .topbar { position: sticky; top: 10px; z-index: 9999; display:flex; justify-content:flex-end; margin:10px 0; }
    .pill {
      display:inline-flex; align-items:center; gap:10px; padding:10px 14px;
      border-radius:999px; font-weight:900; text-decoration:none;
      border:1px solid var(--ink); background:var(--bg); color:var(--ink);
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
    }
    .h1 { font-weight: 950; font-size: 26px; line-height: 1.15; }
    .sub { margin-top:8px; font-weight:900; opacity:.95; }
    .grid { display:grid; grid-template-columns: 1.15fr .85fr; gap: 12px; align-items: start; }
    @media (max-width: 860px) { .grid { grid-template-columns: 1fr; } }
    .card {
      border: 1px solid var(--ink); border-radius: var(--card-radius);
      padding: 12px; background: var(--bg);
      box-shadow: 0 10px 26px rgba(0,0,0,.06);
    }
    .soft { background: var(--soft); }
    .row { display:flex; gap:10px; align-items:center; justify-content: space-between; flex-wrap: wrap; }
    .btn {
      cursor:pointer; padding:10px 12px; border:1px solid var(--ink);
      border-radius:999px; background: var(--bg); font-weight: 950;
    }
    .btn:disabled { opacity:.45; cursor:not-allowed; }
    .btn2 {
      cursor:pointer; padding:12px 14px; border:1px solid var(--ink);
      border-radius:14px; background: var(--bg); font-weight: 950; text-align:left;
    }
    .btn2 small { display:block; opacity:.75; margin-top:6px; line-height:1.5; font-weight:800; }
    .muted { color:var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .addr {
      display:inline-block; max-width: 100%;
      overflow:hidden; text-overflow: ellipsis; vertical-align: bottom;
      white-space: nowrap;
    }
    .addr-2line {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      white-space: normal;
      word-break: break-all;
    }
    .kpi { display:grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin-top:10px; }
    @media (max-width: 640px) { .kpi { grid-template-columns: 1fr; } }
    .kpi .item {
      border:1px solid var(--ink); border-radius:14px; padding:10px; background:var(--bg);
    }
    .kpi .v { font-weight: 950; font-size: 18px; margin-top:4px; }
    .progress {
      height: 10px; border: 1px solid var(--ink); border-radius: 999px; overflow:hidden; background:#fff;
    }
    .progress > i { display:block; height:100%; background:#111; width: 0%; }
    .toast {
      margin-top:10px; font-weight: 950;
    }
    .modal {
      position: fixed; inset: 0; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.4); padding: 20px; z-index: 99999;
    }
    .modal .panel {
      width: min(920px, 96vw); max-height: 90vh; overflow:auto;
      border: 1px solid var(--ink); border-radius: 18px; background: #fff; padding: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
    }
    .modal pre { white-space: pre-wrap; margin: 0; line-height: 1.75; }
    .tag {
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--ink); border-radius: 999px;
      padding: 6px 10px; font-weight: 950; background: #fff;
    }
    .bubble {
      border:1px solid var(--ink); border-radius: 16px; padding: 10px; background:#fff;
      line-height: 1.75;
    }
    .bubble.soft { background: #fafafa; }
    .split {
      display:grid; grid-template-columns: 1fr 1fr; gap: 10px;
    }
    @media (max-width: 860px) { .split { grid-template-columns: 1fr; } }
    .textarea {
      width:100%; min-height: 96px; resize: vertical;
      border:1px solid var(--ink); border-radius: 14px; padding: 10px; font-weight: 800;
      background:#fff;
    }
  </style>
</head>
<body>
  <!-- Official Entry -->
  <div class="wrap">
    <div class="topbar">
      <a class="pill" href="https://klineodyssey.github.io/kline-odyssey/" target="_blank" rel="noopener">ğŸŒ Official Website</a>
    </div>

    <!-- Header -->
    <div class="card">
      <div class="row">
        <div>
          <div class="h1">ğŸ’ æ‚Ÿç©ºè²¡ç¥æ®¿ï½œWukong Fortune Temple</div>
          <div class="sub">#æ‚Ÿç©ºæ–°æ–‡ #Kç·šè¥¿éŠè¨˜ #èŠ±æœå±±å°ç£ #å®‡å®™ç´°èƒå‘¼å¸å¿ƒè·³ç”Ÿå‘½</div>
          <div class="muted" style="margin-top:8px;">
            ç‰ˆæœ¬ï¼š<span class="mono">V2.2</span>ï½œå»ºæ®¿å•Ÿå§‹ï¼š<span class="mono" id="buildStart">2026-02-10</span>ï½œå»ºæ®¿å®Œæˆåº¦ï¼š<span class="mono" id="buildPct">0%</span>
          </div>
        </div>
        <div class="row" style="gap:8px;">
          <span class="tag">å¿ƒè·³ <span class="mono" id="hb">â€”</span></span>
          <span class="tag">å‘¼å¸ <span class="mono" id="breath">â€”</span></span>
          <span class="tag">è¡€å£“ <span class="mono" id="bp">â€”</span></span>
          <button class="btn" id="btnBlueprint">å»ºæ®¿ç¸½è—åœ–</button>
        </div>
      </div>

      <div style="margin-top:12px;" class="progress" aria-label="build-progress"><i id="buildBar"></i></div>

      <div class="grid" style="margin-top:12px;">
        <div class="card soft">
          <div class="row">
            <div style="font-weight:950;">æ‚Ÿç©ºå½±åƒ</div>
            <div class="muted">ï¼ˆwukong-avatar.png æ”¾åœ¨åŒè³‡æ–™å¤¾å³å¯ï¼‰</div>
          </div>
          <div style="display:flex; gap:12px; align-items:center; margin-top:10px; flex-wrap:wrap;">
            <img id="avatar" src="./wukong-avatar.png" alt="Wukong Avatar" style="width:140px; height:140px; object-fit:cover; border-radius:18px; border:1px solid var(--ink); background:#fff;" />
            <div style="flex:1; min-width:240px;">
              <div class="bubble soft">
                <div style="font-weight:950;">æ‚Ÿç©ºå€¼ç­å°</div>
                <div class="muted" style="margin-top:6px;">
                  é€™è£¡æ˜¯äº’å‹•å¼å…¥å£ï¼Œä¸æ˜¯æŠ•è³‡å¹³å°ã€‚æ‰€æœ‰éˆä¸Šå‹•ä½œéƒ½å¿…é ˆç”±ä½ åœ¨éŒ¢åŒ…æŒ‰ç¢ºèªã€‚
                </div>
              </div>
              <div class="row" style="margin-top:10px;">
                <button class="btn" id="btnVoiceIntro">â–¶ï¸ è®“æ‚Ÿç©ºèªªè©±</button>
                <button class="btn" id="btnStopTTS">â¹ï¸ åœæ­¢</button>
                <button class="btn" id="btnToggleDebug">ğŸ§ª Debug</button>
              </div>
              <div class="toast" id="toast"></div>
            </div>
          </div>

          <div class="kpi">
            <div class="item">
              <div class="muted">ä»Šæ—¥ä¾†è¨ª</div>
              <div class="v mono" id="visToday">â€”</div>
            </div>
            <div class="item">
              <div class="muted">ç¸½ä¾†è¨ª</div>
              <div class="v mono" id="visTotal">â€”</div>
            </div>
            <div class="item">
              <div class="muted">éˆä¸Šå¿ƒè·³</div>
              <div class="v mono" id="chainBeat">æœªéƒ¨ç½²</div>
            </div>
          </div>

          <div class="muted" style="margin-top:10px; line-height:1.75;">
            èªªæ˜ï¼š<br/>
            1) ã€Œä»Šæ—¥/ç¸½ä¾†è¨ªã€ä½¿ç”¨ CountAPIï¼ˆGitHub Pages å¯è·‘ï¼‰ã€‚<br/>
            2) ã€Œéˆä¸Šå¿ƒè·³ã€éœ€è¦éƒ¨ç½² Faucet Heart åˆç´„å¾Œæ‰æœƒé¡¯ç¤ºï¼ˆå¯é©—è­‰äº‹ä»¶ï¼‰ã€‚<br/>
            3) æœ¬é æŠŠã€Œå‘¼å¸/å¿ƒè·³/è¡€å£“ã€åšæˆå¯è¦–åŒ–æŒ‡æ¨™ï¼šæœ‰å‰ç«¯ç¯€å¥ï¼Œä¹Ÿå¯æ¥ä¸Šéˆä¸Šäº‹ä»¶ã€‚
          </div>
        </div>

        <div class="card">
          <div class="row">
            <div style="font-weight:950;">ğŸªª éŒ¢åŒ…ç‹€æ…‹ï¼ˆBSC ä¸»ç¶²ï¼‰</div>
            <button class="btn" id="btnConnect">é€£ç·šéŒ¢åŒ…</button>
          </div>
          <div id="walletBox" style="margin-top:10px; line-height:1.85;"></div>

          <div class="card soft" style="margin-top:12px;">
            <div style="font-weight:950;">ğŸ” éˆä¸Šé©—è­‰ï¼ˆBscScanï¼‰</div>

            <div style="margin-top:8px; line-height:1.8;">
              <div>Tokenï¼š<a id="aToken" class="addr addr-2line mono" target="_blank" rel="noopener"></a></div>
              <div>å®‡å®™éŠ€è¡Œï¼š<a id="aBank" class="addr addr-2line mono" target="_blank" rel="noopener"></a></div>
              <div>ç¨…æ”¶/è–ªæ°´ï¼š<a id="aReward" class="addr addr-2line mono" target="_blank" rel="noopener"></a></div>
            </div>

            <div class="muted" style="margin-top:8px;">
              æ³¨æ„ï¼šéŒ¢åŒ…è¦ç”¨ MetaMask æˆ–éŒ¢åŒ…ç€è¦½å™¨é–‹æœ¬é ï¼Œæ‰çœ‹å¾—åˆ°é€£ç·šèˆ‡äº¤æ˜“ç¢ºèªã€‚
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Temple Actions -->
    <div class="card" style="margin-top:12px;">
      <div style="font-weight:950; font-size:18px;">ä¸»æ®¿åŠŸèƒ½ï¼ˆåªèƒ½å¤šä¸èƒ½å°‘ï¼‰</div>
      <div class="muted" style="margin-top:6px; line-height:1.75;">
        å…ˆæŠŠæ®¿è“‹ç©©ï¼šæŒ‰éˆ•å¿…é ˆæœ‰åæ‡‰ã€å¿…é ˆå¯é©—è­‰ã€å¿…é ˆå¯å›æ”¶ã€å¿…é ˆå¯å‡ç´šã€‚<br/>
        ã€Œç™¼è²¡é‡‘ã€= Faucet Heart åˆç´„å‡ºé‡‘ï¼›ã€Œé‚„é¡˜ã€= ä½ ä¸»å‹•è½‰å‡º KGEN åˆ°æŒ‡å®šåœ°å€ï¼ˆæˆ–åˆç´„ï¼‰ã€‚<br/>
      </div>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;margin-top:12px;">
        <button class="btn2" id="btnBobei">
          ğŸ² æ“²ç­Šï¼ˆäº’å‹•éŠæˆ²ï¼‰
          <small>ä¸‰æ¬¡è–ç­Šå¾Œæ‰å•Ÿç”¨ã€Œæ±‚ç™¼è²¡é‡‘ã€ï¼›è³‡æ–™å…ˆå­˜åœ¨æœ¬æ©Ÿï¼ˆå¯åŒ¯å‡ºï¼‰ã€‚</small>
        </button>

        <button class="btn2" id="btnClaim" disabled>
          ğŸ§§ æ±‚ç™¼è²¡é‡‘ï¼ˆFaucet Heartï¼‰
          <small>éœ€è¦å·²éƒ¨ç½² Faucet åˆç´„ï¼›æœªéƒ¨ç½²æœƒé¡¯ç¤ºç¼ºå°‘ä»€éº¼ã€‚</small>
        </button>

        <button class="btn2" id="btnVow">
          ğŸ™ é‚„é¡˜ï¼ˆä½ ä¸»å‹•é€å‡ºäº¤æ˜“ï¼‰
          <small>é¸æ“‡ï¼šæ°´é¾é ­å¿ƒè‡Ÿ / ç„¡äººéŠ€è¡Œ / è³ªèƒ½è½‰æ›é»‘æ´ï¼ˆç‡’å¹£ï¼‰ã€‚</small>
        </button>

        <a class="btn2" href="/kline-odyssey/bookstore/" style="text-decoration:none;color:inherit;">
          ğŸ“˜ æ‚Ÿç©ºæ›¸åŸ
          <small>å…§å®¹å…Œæ›ï¼é ˜æ›¸ï¼ˆä¸å°å…¥é‡‘æµï¼›çµ±ä¸€ç”¨ email æ¨¡æ¿ï¼‰ã€‚</small>
        </a>
      </div>

      <div class="split" style="margin-top:12px;">
        <div class="card soft">
          <div class="row">
            <div style="font-weight:950;">é‚„é¡˜åœ°å€ï¼ˆ3 é¸ 1ï¼‰</div>
            <button class="btn" id="btnCopySel">è¤‡è£½é¸ä¸­åœ°å€</button>
          </div>

          <div style="margin-top:10px; line-height:1.9;">
            <label style="display:flex;gap:10px;align-items:flex-start;">
              <input type="radio" name="vowTarget" value="faucet" checked />
              <div>
                <div style="font-weight:950;">æ°´é¾é ­å¿ƒè‡Ÿ Faucetï¼ˆç™¼æ”¾/å›æ”¶ï¼‰</div>
                <div class="muted">å°šæœªéƒ¨ç½²æ™‚ï¼Œæ­¤è™•é¡¯ç¤ºã€Œå¾…ä¸Šéˆã€ã€‚</div>
                <div class="mono addr addr-2line" id="addrFaucet">ï¼ˆå¾…ä¸Šéˆï¼‰</div>
              </div>
            </label>

            <label style="display:flex;gap:10px;align-items:flex-start;margin-top:10px;">
              <input type="radio" name="vowTarget" value="bank" />
              <div>
                <div style="font-weight:950;">ç„¡äººéŠ€è¡Œï¼ˆWukong Bankï¼‰</div>
                <div class="muted">å¸­ä½/è–ªæ°´/è±ªå®…ç­‰é«˜éšè¦å‰‡åœ¨é€™è£¡ç”Ÿé•·ã€‚</div>
                <div class="mono addr addr-2line" id="addrBank">0xfc522243e988a837700CaD600D6f030f5932681F</div>
              </div>
            </label>

            <label style="display:flex;gap:10px;align-items:flex-start;margin-top:10px;">
              <input type="radio" name="vowTarget" value="blackhole" />
              <div>
                <div style="font-weight:950;">è³ªèƒ½è½‰æ›é»‘æ´ï¼ˆ0x000â€¦0000ï¼‰</div>
                <div class="muted">ä¸å¯é€†ï¼Œé€å‡ºå³ç‡’å¹£ï¼ˆé€šç¸®ï¼‰ã€‚</div>
                <div class="mono addr addr-2line" id="addrBlackhole">0x0000000000000000000000000000000000000000</div>
              </div>
            </label>
          </div>

          <div style="margin-top:12px;">
            <div style="font-weight:950;">é‚„é¡˜æ•¸é‡ï¼ˆK G E Nï¼‰</div>
            <input id="inpAmount" value="1" inputmode="decimal" class="textarea" style="min-height:auto;" />
            <div class="muted" style="margin-top:8px;">
              æç¤ºï¼šé‚„é¡˜é‡‘é¡ç”±ä½ æ±ºå®šï¼›ã€Œæ±‚ç™¼è²¡é‡‘ã€æ˜¯åˆç´„è¦å‰‡æ±ºå®šã€‚å…©è€…è¦åˆ†æ¸…æ¥šã€‚
            </div>
          </div>
        </div>

        <div class="card">
          <div style="font-weight:950;">å³æ™‚æ–‡å­—ï¼ˆä½ èªª/æ‚Ÿç©ºèªªï¼‰</div>
          <div class="muted" style="margin-top:6px; line-height:1.75;">
            ä¸‹æ–¹æ˜¯ã€Œä¸€å•ä¸€ç­”ã€ç”¨çš„å³æ™‚æ–‡å­—æ¬„ã€‚è‹¥ä½ åˆªäº†æŸæ®µ JSï¼Œéº¥å…‹é¢¨åŠŸèƒ½æœƒæ¶ˆå¤±ï¼Œé€™è£¡æœƒæç¤ºåŸå› ã€‚
          </div>
          <div style="margin-top:10px;">
            <div class="bubble soft">
              <div style="font-weight:950;">ä½ èªª</div>
              <div class="mono" id="liveUser">â€”</div>
            </div>
            <div class="bubble" style="margin-top:10px;">
              <div style="font-weight:950;">æ‚Ÿç©ºå›</div>
              <div class="mono" id="liveAI">â€”</div>
            </div>
          </div>

          <div class="row" style="margin-top:10px; justify-content:flex-start;">
            <button class="btn" id="btnMic">ğŸ™ï¸ é–‹å§‹èªªè©±</button>
            <button class="btn" id="btnMicStop">ğŸ›‘ åœæ­¢</button>
            <button class="btn" id="btnSubTop">å­—å¹•ç½®é ‚ï¼šåˆ‡æ›</button>
          </div>

          <div class="card soft" style="margin-top:10px;">
            <div style="font-weight:950;">å­—å¹•ï¼ˆå¯ç½®é ‚ï¼‰</div>
            <div class="mono" id="subtitle">â€”</div>
          </div>
        </div>
      </div>

      <div class="card soft" style="margin-top:12px;">
        <div style="font-weight:950;">æœ¬æ©Ÿç´€éŒ„ï¼ˆå¯åŒ¯å‡ºï¼‰</div>
        <div id="localLog" style="margin-top:10px; line-height:1.9;"></div>
        <div class="row" style="margin-top:10px; justify-content:flex-start;">
          <button class="btn" id="btnExport">â¬‡ï¸ åŒ¯å‡º JSON</button>
          <button class="btn" id="btnClear">ğŸ§¹ æ¸…é™¤</button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="card" style="margin-top:12px; line-height:1.8;">
      PrimeForge ä»¥æ¯æ©Ÿä¹‹åï¼Œé–‹å•Ÿé‡‘èç”Ÿå‘½ã€‚<br/>
      èŠ±æœå±±å°ç£ãƒ»ä¿¡å¿µä¸æ»…ãƒ»å¸‚å ´ç„¡ç•Œã€‚<br/>
      Where the Market Becomes the Myth.<br/>
      â€”â€” æ¨‚å¤©å¸ âŒ–
    </div>

    <!-- Debug Panel -->
    <div class="card" id="debugPanel" style="margin-top:12px; display:none;">
      <div class="row">
        <div style="font-weight:950;">ğŸ§ª Debug Panelï¼ˆå…¨éƒ¨æ²’åæ‡‰æ™‚å…ˆçœ‹é€™è£¡ï¼‰</div>
        <button class="btn" id="btnHideDebug">é—œé–‰</button>
      </div>
      <div class="muted" style="margin-top:8px; line-height:1.75;">
        é€™è£¡æœƒé¡¯ç¤ºï¼šJS æ˜¯å¦è¼‰å…¥ã€éŒ¢åŒ…æ˜¯å¦å­˜åœ¨ã€éŒ¯èª¤è¨Šæ¯ã€æœ€å¾Œä¸€ç­†äº‹ä»¶ã€‚
      </div>
      <pre class="mono" id="debugText" style="margin-top:10px; white-space:pre-wrap;"></pre>
    </div>
  </div>

  <!-- Blueprint Modal -->
  <div class="modal" id="modalBlueprint" role="dialog" aria-modal="true">
    <div class="panel">
      <div class="row">
        <div style="font-weight:950; font-size:18px;">æ‚Ÿç©ºè²¡ç¥æ®¿ï½œå»ºæ®¿ç¸½è—åœ–ï¼ˆV2.2ï¼‰</div>
        <button class="btn" id="btnCloseBlueprint">é—œé–‰</button>
      </div>
      <div class="muted" style="margin-top:8px; line-height:1.75;">
        é€™ä»½è—åœ–æ˜¯ã€Œé©—æ”¶æ¸…å–®ã€ï¼Œæœªå®Œæˆå°±ä¸ç®—è“‹å¥½ã€‚æ¯æ¬¡å‡ç‰ˆåªèƒ½æ–°å¢ã€ä¸èƒ½åˆªæ¸›ã€‚
      </div>
      <pre class="mono" style="margin-top:10px;" id="blueprintText"></pre>
    </div>
  </div>

  <!-- ethers v5 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <script>
  (() => {
    "use strict";

    // =========================
    // CONFIGï¼ˆå›ºå®šçœŸå€¼ï¼‰
    // =========================
    const VERSION = "V2.2";
    const CHAIN_ID_DEC = 56; // BSC mainnet
    const ADDR = {"KGEN_TOKEN": "0xBA3d3810e58735cb6813bC1CDc5458C0d71432Be", "BANK": "0xfc522243e988a837700CaD600D6f030f5932681F", "INSCRIPTION": "0x15fb2A5463F7873EC328BF6f2E85A115adcC3457", "REWARD": "0x0fd21cf643211d067a18a416da219827da26e288", "DEPLOYER": "0xb3c54ca96de0ded4ca0151f629ff9781506ba261", "MOTHER": "0xcd60bf474e691f2484950a0276eaf507616ca4b9", "PUBLIC_GOOD_TREASURY": "0xB73D6716005B37BEC742D64482fA26033eE1A4E1", "KUFO_ENGINE": "0xef83804c264B47378FCf150086943B53fB90A90b", "BLACKHOLE": "0x0000000000000000000000000000000000000000"};

    // Faucet Heartï¼ˆå°šæœªéƒ¨ç½²å…ˆç•™ç©ºï¼‰
    // éƒ¨ç½²å¾ŒæŠŠåœ°å€è²¼åˆ°é€™è£¡ï¼šæœƒåŒæ™‚ç•¶ã€Œå‡ºé‡‘æ± ã€èˆ‡ã€Œå›æ”¶åœ°å€ï¼ˆé‚„é¡˜ï¼‰ã€ã€‚
    const FAUCET_HEART = ""; // e.g. 0x...

    // è¦å‰‡ï¼ˆå‰ç«¯å±•ç¤º + èªéŸ³å®¢æœç”¨ï¼‰
    const RULES = {
      monthlyCapPerUser: 888,     // æ¯äººæ¯æœˆæœ€å¤šé ˜ 888ï¼ˆé¡¯ç¤ºç”¨ï¼›æœ€çµ‚ä»¥åˆç´„ç‚ºæº–ï¼‰
      monthlyWinners: 500,        // æ¯æœˆæœ€å¤š 500 åï¼ˆé¡¯ç¤ºç”¨ï¼›æœ€çµ‚ä»¥åˆç´„ç‚ºæº–ï¼‰
      bobeiNeedHoly: 3,           // ä¸‰æ¬¡è–ç­Š
      igniteWindowUTC: "00:00 ~ 00:10 (UTC)",
      heartbeatEveryHour: true,
      breathAtUTC0: true
    };

    // CountAPI namespace
    const COUNT_NS = "klineodyssey-wukong-temple-v2";
    const dayKey = () => {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `day_${yyyy}${mm}${dd}`;
    };
    const countapi = {
      hit: async (key) => {
        const url = `https://api.countapi.xyz/hit/${encodeURIComponent(COUNT_NS)}/${encodeURIComponent(key)}`;
        const r = await fetch(url);
        if (!r.ok) throw new Error("countapi_hit_failed");
        return await r.json();
      },
      get: async (key) => {
        const url = `https://api.countapi.xyz/get/${encodeURIComponent(COUNT_NS)}/${encodeURIComponent(key)}`;
        const r = await fetch(url);
        if (!r.ok) throw new Error("countapi_get_failed");
        return await r.json();
      }
    };

    // =========================
    // STATEï¼ˆæœ¬æ©Ÿï¼‰
    // =========================
    const KEY = "wukong_temple_state_v2_2";
    const safeParse = (s) => { try { return JSON.parse(s); } catch { return null; } };
    const nowISO = () => new Date().toISOString();

    const defaultState = () => ({
      visit: 0,
      exit: 0,
      bobei: { total:0, holy:0, log:[] },
      vow: 0,
      claim: 0,
      lastUser: "",
      lastAI: "",
      log: []
    });

    const load = () => {
      const raw = localStorage.getItem(KEY);
      const p = raw ? safeParse(raw) : null;
      if (!p || typeof p !== "object") return defaultState();
      const s = { ...defaultState(), ...p };
      if (!Array.isArray(s.log)) s.log = [];
      if (!s.bobei) s.bobei = defaultState().bobei;
      if (!Array.isArray(s.bobei.log)) s.bobei.log = [];
      return s;
    };
    const save = (s) => localStorage.setItem(KEY, JSON.stringify(s));
    const pushLog = (s, type, meta={}) => {
      s.log.push({ type, time: nowISO(), ...meta });
      if (s.log.length > 600) s.log = s.log.slice(-600);
    };

    // =========================
    // UI refs
    // =========================
    const $ = (id) => document.getElementById(id);
    const $toast = $("toast");
    const $debugPanel = $("debugPanel");
    const $debugText = $("debugText");

    const toast = (msg) => {
      $toast.textContent = msg;
      setTimeout(() => { if ($toast.textContent === msg) $toast.textContent = ""; }, 3500);
    };

    const setDebug = (obj) => {
      $debugText.textContent = JSON.stringify(obj, null, 2);
    };

    // Top chain links
    const mkBsc = (addr) => `https://bscscan.com/address/${addr}`;
    $("aToken").textContent = ADDR.KGEN_TOKEN;
    $("aToken").href = mkBsc(ADDR.KGEN_TOKEN);
    $("aBank").textContent = ADDR.BANK;
    $("aBank").href = mkBsc(ADDR.BANK);
    $("aReward").textContent = ADDR.REWARD;
    $("aReward").href = mkBsc(ADDR.REWARD);

    // Vow address labels
    $("addrBank").textContent = ADDR.BANK;
    $("addrBlackhole").textContent = ADDR.BLACKHOLE;

    // Faucet address placeholder
    const renderFaucetAddr = () => {
      $("addrFaucet").textContent = FAUCET_HEART ? FAUCET_HEART : "ï¼ˆå¾…ä¸Šéˆï¼šéƒ¨ç½² Faucet Heart å¾Œå¡«å…¥ï¼‰";
    };
    renderFaucetAddr();

    // =========================
    // Build progress (fixed baseline)
    // =========================
    const BUILD = {
      start: "2026-02-10",
      pct: 66, // V2.2ï¼šæ®¿é«” + èªéŸ³ + éŒ¢åŒ… + äº’å‹• + Debug + è¨˜éŒ„
      next: [
        "éƒ¨ç½² Faucet Heart åˆç´„ï¼ˆä¸Šéˆå¿ƒè‡Ÿï¼‰",
        "æŠŠ FAUCET_HEART å¡«å›æœ¬é ï¼Œå•Ÿç”¨æ±‚ç™¼è²¡é‡‘æŒ‰éˆ•",
        "æŠŠæ“²ç­Š gate èˆ‡åˆç´„ claim è¦å‰‡å°é½Šï¼ˆæ¯æœˆ 500 å / 888 ä¸Šé™ï¼‰",
        "ç„¡äººéŠ€è¡Œ KUFO åˆç´„åŒ–ï¼ˆä¸å†ä½¿ç”¨ç§é‘°åœ°å€ï¼‰"
      ]
    };
    $("buildPct").textContent = BUILD.pct + "%";
    $("buildBar").style.width = BUILD.pct + "%";

    const BLUEPRINT = `
[å¿…åšï½œæ®¿é«”é©—æ”¶]
- æŒ‰éˆ•å¿…é ˆæœ‰åæ‡‰ï¼šæ“²ç­Š / æ±‚ç™¼è²¡é‡‘ / é‚„é¡˜ / é€£éŒ¢åŒ… / èªéŸ³ / éº¥å…‹é¢¨ / åŒ¯å‡º
- Debug Panel å¿…é ˆèƒ½é¡¯ç¤ºéŒ¯èª¤åŸå› ï¼ˆJS å£ã€éŒ¢åŒ…ä¸å­˜åœ¨ã€éˆä¸å°ï¼‰
- é•·åœ°å€å¿…é ˆä¸è¶…å‡ºé é¢ï¼ˆå…©è¡Œé¡¯ç¤ºï¼‰

[å‘¼å¸/å¿ƒè·³/è¡€å£“]
- å‰ç«¯ï¼šå¿ƒè·³ï¼ˆæ¯å°æ™‚ä¸€æ¬¡ï¼‰+ å‘¼å¸ï¼ˆæ¯æ—¥ 00:00 UTCï¼‰
- éˆä¸Šï¼šFaucet Heart æ¯æ—¥é»ç«çª—å£ 00:00~00:10 UTCï¼ˆäº‹ä»¶å¯é©—è­‰ï¼‰

[æ“²ç­Šï¼ˆäº’å‹•éŠæˆ²ï¼‰]
- ä¸‰æ¬¡è–ç­Š gateï¼šé”æ¨™æ‰å•Ÿç”¨ã€Œæ±‚ç™¼è²¡é‡‘ã€
- å¾ŒçºŒå¯å‡ç´šï¼šä¸‰æ¬¡è–ç­Šæ‰çµ¦ 8.88 / 88.88 / 888 éš¨æ©Ÿç¦®

[æ±‚ç™¼è²¡é‡‘ï¼ˆåˆç´„å‡ºé‡‘ï¼‰]
- Faucet Heart éƒ¨ç½²å¾Œæ‰å•Ÿç”¨
- è¦å‰‡ï¼šæ¯æœˆæœ€å¤š 500 å + æ¯äººæ¯æœˆä¸Šé™ 888ï¼ˆä»¥åˆç´„ç‚ºæº–ï¼‰

[é‚„é¡˜ï¼ˆå›æ”¶/è£œè¡€ï¼‰]
- 3 åœ°å€ï¼šFaucet Heartï¼ˆå›æ”¶ï¼‰/ ç„¡äººéŠ€è¡Œ / é»‘æ´ç‡’å¹£
- é‚„é¡˜é‡‘é¡ç”±é¦™å®¢è‡ªè¡Œæ±ºå®šï¼ˆèˆ‡æ±‚ç™¼è²¡é‡‘è¦å‰‡åˆ†é›¢ï¼‰

[æœªä¾†æ“´å»ºï¼ˆåªèƒ½åŠ ä¸èƒ½åˆªï¼‰]
- èŠ±æœå±±ç«æ˜Ÿé½Šå¤©è±ªå®…ï¼š500 å¸­ä½ï¼Œå…¥ä½æ¢ä»¶ 5000 KGENï¼ˆéœ€åˆç´„åŒ–ï¼‰
- æ¯æœˆ 5 æ—¥ç™¼è–ªï¼šç”±ç„¡äººéŠ€è¡Œåˆç´„ç™¼æ”¾ï¼ˆéœ€åˆç´„åŒ–ï¼‰
- GA600 å¤§è…¦ï¼šæ¥ä¸Šé‹ç®—å¼•æ“å¾Œæ‰é–‹å•Ÿé«˜éšæ¬Šé™
`.trim();

    // Blueprint modal
    const openModal = () => {
      $("blueprintText").textContent = BLUEPRINT;
      $("modalBlueprint").style.display = "flex";
    };
    const closeModal = () => $("modalBlueprint").style.display = "none";
    $("btnBlueprint").addEventListener("click", openModal);
    $("btnCloseBlueprint").addEventListener("click", closeModal);
    $("modalBlueprint").addEventListener("click", (e) => { if (e.target.id === "modalBlueprint") closeModal(); });

    // =========================
    // Visitors
    // =========================
    const renderVisitors = (todayVal, totalVal) => {
      $("visToday").textContent = String(todayVal ?? "â€”");
      $("visTotal").textContent = String(totalVal ?? "â€”");
    };

    const refreshVisitors = async (doHit) => {
      try {
        const dk = dayKey();
        let todayVal = 0, totalVal = 0;
        if (doHit) {
          const [t1, t2] = await Promise.all([countapi.hit(dk), countapi.hit("total")]);
          todayVal = t1.value ?? 0;
          totalVal = t2.value ?? 0;
        } else {
          const [g1, g2] = await Promise.all([countapi.get(dk), countapi.get("total")]);
          todayVal = g1.value ?? 0;
          totalVal = g2.value ?? 0;
        }
        renderVisitors(todayVal, totalVal);
      } catch (e) {
        renderVisitors("â€”", "â€”");
      }
    };
    refreshVisitors(true);

    // =========================
    // Breathing / Heartbeat / Blood pressure (visual)
    // =========================
    const setVitals = (hb, breath, bp) => {
      $("hb").textContent = hb;
      $("breath").textContent = breath;
      $("bp").textContent = bp;
    };

    const calcBP = () => {
      // simulate based on local activity + time
      const s = load();
      const t = Date.now()/1000;
      const baseSys = 108 + Math.round(6*Math.sin(t/180));
      const baseDia = 72 + Math.round(4*Math.cos(t/210));
      const pulse = 66 + Math.round(6*Math.sin(t/90) + Math.min(12, s.bobei.total/2));
      return `${baseSys}/${baseDia}  è„ˆæ${pulse}`;
    };

    const tickVitals = () => {
      const now = new Date();
      const mins = now.getMinutes();
      const secs = now.getSeconds();
      // heartbeat: show "æ¯å°æ™‚" anchor
      const hb = `æ¯å°æ™‚Â·${String(now.getHours()).padStart(2,"0")}:00`;
      // breath: show UTC 00:00 anchor
      const breath = `æ¯æ—¥Â·UTC00:00`;
      const bp = calcBP();
      setVitals(hb, breath, bp);
    };
    tickVitals();
    setInterval(tickVitals, 15000);

    // =========================
    // Voice (TTS) + Mic (SpeechRecognition)
    // =========================
    const canTTS = "speechSynthesis" in window;
    const speak = (text) => {
      try {
        if (!canTTS) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "zh-TW";
        u.rate = 1.0;
        u.pitch = 1.0;
        window.speechSynthesis.speak(u);
      } catch {}
    };
    const stopTTS = () => { try { if (canTTS) window.speechSynthesis.cancel(); } catch {} };

    const setSubtitle = (text) => {
      $("subtitle").textContent = text || "â€”";
      // also mirror to AI bubble by default
      $("liveAI").textContent = text || "â€”";
    };

    const wukongAnswer = (q) => {
      const s = load();
      const text = (q||"").trim();
      const lower = text.toLowerCase();

      const base = "æˆ‘åœ¨äº”æŒ‡å±±ä¸‹ï¼Œå¿ƒè·³å·²å¾©ç”¦ã€‚é€™è£¡ä¸æ˜¯æŠ•è³‡å¹³å°ã€‚ä½ è¦åšçš„æ¯ä¸€ç­†éˆä¸Šå‹•ä½œï¼Œéƒ½ç”±ä½ åœ¨éŒ¢åŒ…æŒ‰ç¢ºèªã€‚";
      if (!text) return "ä½ é‚„æ²’èªªè©±ã€‚æŒ‰é–‹å§‹èªªè©±ï¼Œå†å•æˆ‘ä¸€æ¬¡ã€‚";
      if (lower.includes("ç™¼è²¡é‡‘") || lower.includes("é ˜")) {
        if (!FAUCET_HEART) return "ç™¼è²¡é‡‘å¿ƒè‡Ÿåˆç´„å°šæœªä¸Šéˆã€‚å…ˆéƒ¨ç½² Faucet Heartï¼Œå¡«å…¥åœ°å€å¾Œï¼Œæ‰æœƒå•Ÿç”¨æ±‚ç™¼è²¡é‡‘ã€‚";
        return "æ±‚ç™¼è²¡é‡‘ï¼šå…ˆæ“²ç­Šé”åˆ°ä¸‰æ¬¡è–ç­Šï¼Œæ‰æœƒé–‹å•Ÿã€‚ç™¼æ”¾è¦å‰‡ä»¥åˆç´„ç‚ºæº–ï¼Œæ¯æœˆ 500 åã€æ¯äººæ¯æœˆä¸Šé™ 888ã€‚";
      }
      if (lower.includes("éŒ¢åŒ…") || lower.includes("metamask")) {
        return "è«‹ç”¨ MetaMask æˆ–éŒ¢åŒ…ç€è¦½å™¨æ‰“é–‹æœ¬é ï¼ŒæŒ‰é€£ç·šéŒ¢åŒ…ã€‚è‹¥æ‰¾ä¸åˆ°å¹£ï¼Œè«‹ç”¨ Custom Token åŠ å…¥ KGEN åˆç´„åœ°å€ã€‚";
      }
      if (lower.includes("é‚„é¡˜") || lower.includes("åœ°å€")) {
        return "é‚„é¡˜æœ‰ä¸‰å€‹é¸é …ï¼šæ°´é¾é ­å¿ƒè‡Ÿå›æ”¶ã€ç„¡äººéŠ€è¡Œå¢èƒ½ã€é»‘æ´ç‡’å¹£é€šç¸®ã€‚é‡‘é¡ç”±ä½ æ±ºå®šï¼Œé‚„é¡˜ä¸æ˜¯å¼·åˆ¶ã€‚";
      }
      if (lower.includes("å¿ƒè·³") || lower.includes("å‘¼å¸") || lower.includes("è¡€å£“")) {
        return "å¿ƒè·³æ˜¯æ¯å°æ™‚çš„ç¯€å¥ï¼Œå‘¼å¸æ˜¯æ¯æ—¥é›¶é»çš„é‡ç½®ã€‚è¡€å£“ä»£è¡¨ä»Šå¤©çš„å£“åŠ›èˆ‡æ³¢å‹•ï¼Œæˆ‘æœƒç”¨ç´€éŒ„èˆ‡äº‹ä»¶æŠŠå®ƒé¡¯ç¤ºå‡ºä¾†ã€‚";
      }
      if (lower.includes("è±ªå®…") || lower.includes("5000") || lower.includes("500å¸­")) {
        return "èŠ±æœå±±ç«æ˜Ÿé½Šå¤©è±ªå®…å±¬æ–¼ä¸‹ä¸€æ®µæ“´å»ºï¼š500å¸­ä½ã€5000 KGEN å…¥ä½ã€‚è¦åšæˆåˆç´„ï¼Œä¸é ä»»ä½•ç§é‘°åœ°å€ã€‚";
      }
      return base;
    };

    $("btnVoiceIntro").addEventListener("click", () => {
      const intro = "æ­¡è¿ä¾†åˆ°äº”æŒ‡å±±æ‚Ÿç©ºè²¡ç¥æ®¿ã€‚é€™è£¡æ˜¯äº’å‹•å¼å…¥å£ï¼Œä¸æ˜¯æŠ•è³‡å¹³å°ã€‚ç™¼è²¡é‡‘å¿…é ˆç”±å¿ƒè‡Ÿåˆç´„å‡ºé‡‘ã€‚é‚„é¡˜æœ‰ä¸‰å€‹åœ°å€ï¼Œè«‹çœ‹æ¸…æ¥šå†ç¢ºèªã€‚";
      speak(intro);
      setSubtitle(intro);
      toast("æ‚Ÿç©ºé–‹å§‹èªªè©±");
    });
    $("btnStopTTS").addEventListener("click", () => { stopTTS(); toast("å·²åœæ­¢"); });

    // Speech Recognition
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null;
    let recOn = false;

    const updateButtons = () => {
      $("btnMic").disabled = !SR;
      $("btnMicStop").disabled = !SR;
    };
    updateButtons();

    const setLiveUser = (t) => $("liveUser").textContent = t || "â€”";
    const setLiveAI = (t) => $("liveAI").textContent = t || "â€”";

    const doAnswer = (userText) => {
      const s = load();
      s.lastUser = userText || "";
      const ans = wukongAnswer(userText);
      s.lastAI = ans;
      pushLog(s, "qa", { q:userText, a:ans });
      save(s);
      setLiveUser(userText);
      setLiveAI(ans);
      setSubtitle(ans);
      speak(ans);
      renderLocal();
    };

    if (SR) {
      rec = new SR();
      rec.lang = "zh-TW";
      rec.interimResults = true;
      rec.continuous = false;

      rec.onresult = (ev) => {
        let finalText = "";
        let interim = "";
        for (let i=0; i<ev.results.length; i++) {
          const r = ev.results[i];
          if (r.isFinal) finalText += r[0].transcript;
          else interim += r[0].transcript;
        }
        const show = (finalText || interim || "").trim();
        if (show) {
          setLiveUser(show);
          $("subtitle").textContent = show;
        }
        if (finalText && finalText.trim()) {
          recOn = false;
          doAnswer(finalText.trim());
        }
      };
      rec.onerror = (e) => {
        recOn = false;
        toast("éº¥å…‹é¢¨éŒ¯èª¤ï¼š" + (e.error || "unknown"));
        setDebug({ lastError: e, hasWallet: !!window.ethereum, hasSR: !!SR });
      };
      rec.onend = () => { recOn = false; };
    }

    $("btnMic").addEventListener("click", () => {
      if (!SR || !rec) {
        toast("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ã€‚è«‹æ”¹ç”¨ Chrome / Android Chrome / Edgeã€‚");
        return;
      }
      try {
        recOn = true;
        rec.start();
        toast("ğŸ™ï¸ é–‹å§‹èªªè©±ï¼ˆè¬›å®Œæœƒè‡ªå‹•å›è¦†ï¼‰");
      } catch (e) {
        toast("éº¥å…‹é¢¨å•Ÿå‹•å¤±æ•—ï¼ˆå¯èƒ½å·²åœ¨éŒ„éŸ³ï¼‰");
      }
    });
    $("btnMicStop").addEventListener("click", () => {
      try { if (rec && recOn) rec.stop(); } catch {}
      recOn = false;
      toast("å·²åœæ­¢éº¥å…‹é¢¨");
    });

    // subtitle top toggle
    let subTop = true;
    $("btnSubTop").addEventListener("click", () => {
      subTop = !subTop;
      const el = $("subtitle").parentElement.parentElement;
      if (subTop) {
        el.style.order = "-1";
        toast("å­—å¹•ç½®é ‚ï¼šæ˜¯");
      } else {
        el.style.order = "0";
        toast("å­—å¹•ç½®é ‚ï¼šå¦");
      }
    });

    // =========================
    // Debug toggles
    // =========================
    $("btnToggleDebug").addEventListener("click", () => {
      $debugPanel.style.display = ($debugPanel.style.display === "none") ? "block" : "none";
      setDebug({
        VERSION,
        hasWallet: !!window.ethereum,
        hasEthers: !!window.ethers,
        hasSpeechRecognition: !!SR,
        hasTTS: canTTS,
        chainIdWant: CHAIN_ID_DEC,
        faucetHeartSet: !!FAUCET_HEART
      });
    });
    $("btnHideDebug").addEventListener("click", () => { $debugPanel.style.display = "none"; });

    // =========================
    // Wallet / balances / vow transfer
    // =========================
    let provider = null;
    let signer = null;
    let userAddr = null;

    const ERC20_ABI = [
      "function balanceOf(address) view returns (uint256)",
      "function transfer(address to, uint256 amount) returns (bool)"
    ];

    const fmt = (bn) => {
      try { return ethers.utils.formatUnits(bn, 18); } catch { return String(bn); }
    };

    const ensureChain = async () => {
      if (!window.ethereum) throw new Error("no_wallet");
      const wantHex = "0x" + CHAIN_ID_DEC.toString(16);
      const cur = await window.ethereum.request({ method: "eth_chainId" });
      if (cur !== wantHex) {
        await window.ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: wantHex }] });
      }
    };

    const renderWallet = async () => {
      if (!userAddr) {
        $("walletBox").innerHTML = `
          <div style="font-weight:950;">æœªé€£ç·š</div>
          <div class="muted">è«‹ç”¨ MetaMask / éŒ¢åŒ…ç€è¦½å™¨é–‹æœ¬é ï¼ŒæŒ‰ã€Œé€£ç·šéŒ¢åŒ…ã€ã€‚</div>
        `;
        return;
      }
      const lines = [];
      lines.push(`<div>å·²é€£ç·šï¼š<span class="mono addr addr-2line">${userAddr}</span></div>`);
      try {
        const token = new ethers.Contract(ADDR.KGEN_TOKEN, ERC20_ABI, provider);
        const [uBal, rBal, bBal] = await Promise.all([
          token.balanceOf(userAddr),
          token.balanceOf(ADDR.REWARD),
          token.balanceOf(ADDR.BANK)
        ]);
        lines.push(`<div>KGEN ä½ çš„é¤˜é¡ï¼š<strong class="mono">${fmt(uBal)}</strong></div>`);
        lines.push(`<div>ç¨…æ”¶/è–ªæ°´åœ°å€é¤˜é¡ï¼š<strong class="mono">${fmt(rBal)}</strong></div>`);
        lines.push(`<div>ç„¡äººéŠ€è¡Œåœ°å€é¤˜é¡ï¼š<strong class="mono">${fmt(bBal)}</strong></div>`);
      } catch (e) {
        lines.push(`<div class="muted">è®€å–é¤˜é¡å¤±æ•—ï¼šè«‹ç¢ºèªåœ¨ BSC ä¸»ç¶²ã€‚</div>`);
      }
      $("walletBox").innerHTML = lines.join("");
    };

    $("btnConnect").addEventListener("click", async () => {
      try {
        if (!window.ethereum) {
          toast("æ‰¾ä¸åˆ°éŒ¢åŒ…ï¼šè«‹ç”¨ MetaMask æˆ–éŒ¢åŒ…ç€è¦½å™¨");
          speak("æ‰¾ä¸åˆ°éŒ¢åŒ…ã€‚è«‹ç”¨ MetaMask æˆ–éŒ¢åŒ…ç€è¦½å™¨ã€‚");
          return;
        }
        await ensureChain();
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddr = await signer.getAddress();
        toast("âœ… éŒ¢åŒ…å·²é€£ç·šï¼ˆBSCï¼‰");
        await renderWallet();
      } catch (e) {
        toast("é€£ç·šå¤±æ•—æˆ–æœªæˆæ¬Š");
        setDebug({ lastError: String(e) });
      }
    });

    // Vow address select
    const selectedVow = () => {
      const el = document.querySelector('input[name="vowTarget"]:checked');
      const v = el ? el.value : "faucet";
      if (v === "bank") return ADDR.BANK;
      if (v === "blackhole") return ADDR.BLACKHOLE;
      return FAUCET_HEART || ""; // faucet
    };

    $("btnCopySel").addEventListener("click", async () => {
      const addr = selectedVow() || "";
      if (!addr) {
        toast("æ°´é¾é ­å¿ƒè‡Ÿå°šæœªä¸Šéˆï¼Œç¾åœ¨ç„¡æ³•è¤‡è£½ faucet åœ°å€");
        return;
      }
      try {
        await navigator.clipboard.writeText(addr);
        toast("å·²è¤‡è£½ï¼š" + addr.slice(0,6) + "â€¦" + addr.slice(-4));
      } catch {
        toast("è¤‡è£½å¤±æ•—ï¼šè«‹æ‰‹å‹•é¸å–åœ°å€");
      }
    });

    // Vow transfer
    $("btnVow").addEventListener("click", async () => {
      const amountStr = ($("inpAmount").value || "").trim();
      const to = selectedVow();
      if (!to) {
        toast("æ°´é¾é ­å¿ƒè‡Ÿå°šæœªä¸Šéˆï¼šå…ˆéƒ¨ç½² Faucet Heartï¼Œæˆ–æ”¹é¸ç„¡äººéŠ€è¡Œ/é»‘æ´ã€‚");
        speak("æ°´é¾é ­å¿ƒè‡Ÿå°šæœªä¸Šéˆã€‚è«‹å…ˆéƒ¨ç½²åˆç´„ï¼Œæˆ–æ”¹é¸ç„¡äººéŠ€è¡Œæˆ–é»‘æ´ã€‚");
        return;
      }
      if (!amountStr || isNaN(Number(amountStr)) || Number(amountStr) <= 0) {
        toast("é‚„é¡˜æ•¸é‡ä¸æ­£ç¢º");
        return;
      }
      if (!window.ethereum || !signer) {
        toast("è«‹å…ˆé€£ç·šéŒ¢åŒ…");
        return;
      }
      try {
        await ensureChain();
        const token = new ethers.Contract(ADDR.KGEN_TOKEN, ERC20_ABI, signer);
        const amt = ethers.utils.parseUnits(amountStr, 18);
        const tx = await token.transfer(to, amt);
        toast("äº¤æ˜“é€å‡ºï¼Œç­‰å¾…ç¢ºèªâ€¦");
        speak("é‚„é¡˜äº¤æ˜“å·²é€å‡ºï¼Œç­‰å¾…éˆä¸Šç¢ºèªã€‚");
        const s = load();
        s.vow += 1;
        pushLog(s, "vow", { to, amount: amountStr, tx: tx.hash });
        save(s);
        await tx.wait();
        toast("âœ… é‚„é¡˜å®Œæˆï¼ˆå¯ä¸ŠéˆæŸ¥ txï¼‰");
        await renderWallet();
        renderLocal();
      } catch (e) {
        toast("äº¤æ˜“å¤±æ•—æˆ–å–æ¶ˆ");
        setDebug({ lastError: String(e) });
      }
    });

    // =========================
    // Bobei game (3 holy cups gate)
    // =========================
    const rollBobei = () => {
      // 0=ç¬‘æ¯, 1=é™°æ¯, 2=è–æ¯
      const r = Math.random();
      if (r < 0.2) return 0;
      if (r < 0.5) return 1;
      return 2;
    };
    const bobeiName = (x) => x===2 ? "è–ç­Š" : (x===1 ? "é™°ç­Š" : "ç¬‘ç­Š");

    const renderLocal = () => {
      const s = load();
      const holyNeed = RULES.bobeiNeedHoly;
      const holyNow = s.bobei.holy;
      $("localLog").innerHTML = `
        <div>æ“²ç­Šï¼š<strong class="mono">${s.bobei.total}</strong> æ¬¡ï½œè–ç­Šï¼š<strong class="mono">${holyNow}</strong> / ${holyNeed}</div>
        <div>é‚„é¡˜ï¼š<strong class="mono">${s.vow}</strong> æ¬¡ï½œæ±‚ç™¼è²¡é‡‘ï¼š<strong class="mono">${s.claim}</strong> æ¬¡</div>
        <div class="muted" style="margin-top:8px;">ï¼ˆæç¤ºï¼šé”åˆ°ä¸‰æ¬¡è–ç­Šå¾Œï¼Œæ‰æœƒé–‹å•Ÿæ±‚ç™¼è²¡é‡‘æŒ‰éˆ•ã€‚ï¼‰</div>
      `;
      // enable claim only if gate pass and faucet set
      const gateOk = holyNow >= holyNeed;
      $("btnClaim").disabled = !(gateOk && !!FAUCET_HEART);
    };
    renderLocal();

    $("btnBobei").addEventListener("click", () => {
      const s = load();
      const r = rollBobei();
      s.bobei.total += 1;
      if (r === 2) s.bobei.holy += 1;
      s.bobei.log.push({ t: nowISO(), r, name: bobeiName(r) });
      if (s.bobei.log.length > 120) s.bobei.log = s.bobei.log.slice(-120);
      pushLog(s, "bobei", { r, name: bobeiName(r) });
      save(s);
      const msg = `æ“²ç­Šçµæœï¼š${bobeiName(r)}ï¼ˆè–ç­Š ${s.bobei.holy}/${RULES.bobeiNeedHoly}ï¼‰`;
      toast(msg);
      speak(msg);
      setSubtitle(msg);
      renderLocal();
    });

    // =========================
    // Claim (placeholder until faucet deployed)
    // =========================
    $("btnClaim").addEventListener("click", async () => {
      if (!FAUCET_HEART) {
        toast("ç¼ºå°‘ Faucet Heart åˆç´„åœ°å€ï¼šå…ˆéƒ¨ç½²åˆç´„ï¼Œå†å¡«å›æœ¬é ");
        speak("ç¼ºå°‘ Faucet Heart åˆç´„åœ°å€ã€‚å…ˆéƒ¨ç½²åˆç´„ï¼Œå†å¡«å›æœ¬é ã€‚");
        return;
      }
      toast("å·²å•Ÿç”¨æ±‚ç™¼è²¡é‡‘ï¼šä¸‹ä¸€ç‰ˆå°‡æ¥ä¸Š igniteAndClaim()");
      speak("æ±‚ç™¼è²¡é‡‘æŒ‰éˆ•å·²å•Ÿç”¨ã€‚ä¸‹ä¸€ç‰ˆæœƒæ¥ä¸Šåˆç´„å‡ºé‡‘ã€‚");
      const s = load();
      s.claim += 1;
      pushLog(s, "claim_click", { faucet: FAUCET_HEART });
      save(s);
      renderLocal();
    });

    // =========================
    // Export / Clear
    // =========================
    const downloadJSON = (obj, filename) => {
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    $("btnExport").addEventListener("click", () => {
      const s = load();
      downloadJSON(s, `wukong_temple_state_${VERSION}.json`);
      toast("å·²åŒ¯å‡º JSON");
    });
    $("btnClear").addEventListener("click", () => {
      localStorage.removeItem(KEY);
      toast("å·²æ¸…é™¤æœ¬æ©Ÿç´€éŒ„");
      renderLocal();
    });

    // =========================
    // Final: initial debug snapshot
    // =========================
    setDebug({
      VERSION,
      hasWallet: !!window.ethereum,
      hasEthers: !!window.ethers,
      hasSpeechRecognition: !!SR,
      hasTTS: canTTS,
      faucetHeartSet: !!FAUCET_HEART,
      note: "è‹¥æŒ‰éˆ•éƒ½æ²’åæ‡‰ï¼Œæ‰“é–‹ Debug Panel çœ‹ lastErrorã€‚"
    });

    // Try render wallet (if already connected)
    renderWallet();

  })();
  </script>
</body>
</html>
