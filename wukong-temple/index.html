<!-- Official Entry (Top-Right) -->
<div style="position:sticky; top:10px; z-index:9999; display:flex; justify-content:flex-end; margin:10px 0;">
  <a href="https://klineodyssey.github.io/kline-odyssey/"
     target="_blank" rel="noopener"
     style="display:inline-flex; align-items:center; gap:8px;
            padding:10px 14px; border-radius:999px;
            font-weight:800; text-decoration:none;
            border:1px solid #111; background:#fff;">
    ğŸŒ Official Website
  </a>
</div>

<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ‚Ÿç©ºè²¡ç¥æ®¿ï½œWukong Fortune Hall</title>
  <meta name="description" content="æ‚Ÿç©ºè²¡ç¥æ®¿ï½œäº’å‹•å¼éŠæˆ²å…¥å£ï¼šåƒè§€ã€é¸æ“‡ã€é«”é©—ï¼Œç„¶å¾Œé›¢é–‹ã€‚" />
  <style>
  a, .addr, .wrap-any { overflow-wrap:anywhere; word-break:break-word; }
  .addr-2line{
    display:-webkit-box;
    -webkit-box-orient:vertical;
    -webkit-line-clamp:2;
    overflow:hidden;
  }
  </style>
</head>

<body>
<div style="max-width:860px;margin:22px auto;padding:16px;">

  <div style="margin-bottom:10px;">
    <div style="font-weight:900;font-size:22px;line-height:1.2;">ğŸ’ äº”æŒ‡å±±ãƒ»æ‚Ÿç©ºè²¡ç¥æ®¿ï½œWukong Fortune Hall</div>
    <div style="margin-top:6px;font-weight:800;">#æ‚Ÿç©ºæ–°æ–‡ #Kç·šè¥¿éŠè¨˜ #èŠ±æœå±±å°ç£</div>
    <div style="margin-top:8px;">
      <a href="https://klineodyssey.github.io/kline-odyssey/" target="_blank" rel="noopener"
         style="text-decoration:none;font-weight:900;border:1px solid #111;border-radius:999px;padding:10px 14px;display:inline-block;">
        å›åˆ°å®˜ç¶²ç¸½è¦½
      </a>
    </div>
  </div>

  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;">
    <div style="font-weight:900;">ğŸ« å®‡å®™ç”Ÿå‘½å¾µè±¡ï½œå¿ƒè·³ãƒ»å‘¼å¸ãƒ»è¡€å£“ï¼ˆCosmic Vitalsï¼‰</div>
    <div style="margin-top:8px;line-height:1.8;">
      é€™è£¡æ˜¯ã€Œæ‚Ÿç©ºè²¡ç¥æ®¿ã€å…¥å£ï¼Œä¸æ˜¯ä¸€èˆ¬å»Ÿã€‚<br/>
      ä½ æ¯ä¸€æ¬¡åƒæ‹œï¼Œéƒ½æœƒè§¸ç™¼ä¸€æ¬¡å®‡å®™ç”Ÿå‘½å¾µè±¡ï¼šå¿ƒè·³ã€å‘¼å¸ã€è¡€å£“ã€‚<br/>
      ï¼ˆè‹¥ä½ å°šæœªéƒ¨ç½²ç™¼æ”¾åˆç´„ï¼Œç™¼è²¡é‡‘åŠŸèƒ½æœƒä¿æŒé–å®šã€‚ï¼‰
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
      <button id="btnHeartbeat"
        style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
        â¤ï¸ å¿ƒè·³
      </button>
      <button id="btnBreath"
        style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
        ğŸ« å‘¼å¸
      </button>
      <button id="btnPressure"
        style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
        ğŸ©¸ è¡€å£“
      </button>
      <button id="btnFortune" disabled
        style="cursor:not-allowed;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#f3f3f3;font-weight:900;">
        ğŸ§§ é ˜ç™¼è²¡é‡‘ï¼ˆéœ€åˆç´„ï¼‰
      </button>
    </div>

    <div id="vitalsInfo" style="margin-top:10px;line-height:1.9;"></div>
    <div style="opacity:.85;margin-top:6px;">
      è¦å‰‡ï¼šè–ç­Šæ©Ÿç‡ 50%ã€‚å¤±æ•—æ­¸é›¶ã€‚é€£å‹é” 3 æ‰é–‹å•Ÿã€Œé ˜ç™¼è²¡é‡‘ã€æŒ‰éˆ•ã€‚
    </div>
  </div>

  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
      <div style="font-weight:900;">ğŸªª éŒ¢åŒ…ç‹€æ…‹ï¼ˆBSC ä¸»ç¶²ï¼‰</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="btnConnect"
          style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
          é€£ç·šéŒ¢åŒ…
        </button>
        <button id="btnSpeak"
          style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
          â–¶ï¸ èªéŸ³å®¢æœ
        </button>
        <button id="btnStopSpeak"
          style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
          â¹ï¸ åœæ­¢
        </button>
      </div>
    </div>

    <div id="aiConsole" style="margin-top:10px;border:1px solid #111;border-radius:14px;padding:12px;background:#fafafa;">
      <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;">
        <div style="width:88px;min-width:88px;">
          <img id="avatarImg" src="./wukong-avatar.png" alt="Wukong AI" style="width:88px;height:88px;border-radius:18px;border:1px solid #111;object-fit:cover;background:#fff;"/>
          <div style="margin-top:6px;font-size:12px;opacity:.85;line-height:1.4;">
            æç¤ºï¼šè‹¥æœªé¡¯ç¤ºï¼Œè«‹åœ¨åŒè³‡æ–™å¤¾æ”¾ä¸€å¼µ wukong-avatar.png
          </div>
        </div>

        <div style="flex:1;min-width:220px;">
          <div style="font-weight:900;">AI èªéŸ³å®¢æœï¼ˆæ‚Ÿç©ºè²¡ç¥æ®¿ï¼‰</div>
          <div style="margin-top:6px;font-size:14px;line-height:1.7;">
            <div style="font-weight:900;">å³æ™‚æ–‡å­—ï¼ˆAI èªªè©±å­—å¹•ï¼‰</div>
            <div id="aiCaption" style="margin-top:6px;min-height:46px;padding:10px;border:1px dashed #111;border-radius:12px;background:#fff;white-space:pre-wrap;"></div>

            <div style="margin-top:10px;font-weight:900;">å³æ™‚æ–‡å­—ï¼ˆä½ çš„éº¥å…‹é¢¨è½‰æ–‡å­—ï¼‰</div>
            <div id="userTranscript" style="margin-top:6px;min-height:46px;padding:10px;border:1px dashed #111;border-radius:12px;background:#fff;white-space:pre-wrap;opacity:.95;"></div>

            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
              <button id="btnMic"
                style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
                ğŸ¤ é–‹å§‹èªªè©±
              </button>
              <button id="btnStopMic"
                style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
                ğŸ“´ åœæ­¢è½ä½ 
              </button>
              <button id="btnAutoStart"
                style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
                âš¡ ä¸€éµå•Ÿå‹•ï¼ˆèªéŸ³ï¼‹å­—å¹•ï¼‰
              </button>
            </div>

            <div style="margin-top:8px;font-size:12px;opacity:.85;line-height:1.5;">
              æ³¨æ„ï¼šå¤šæ•¸ç€è¦½å™¨ç¦æ­¢ã€Œç„¡äº’å‹•è‡ªå‹•æ’­æ”¾è²éŸ³ã€ã€‚ç¬¬ä¸€æ¬¡è«‹æŒ‰ã€Œä¸€éµå•Ÿå‹•ã€æˆ–ä»»æ„æŒ‰éµï¼Œä¹‹å¾Œæ‰å¯é€£çºŒæ’­å ±ã€‚
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="walletInfo" style="margin-top:10px;line-height:1.9;"></div>

    <div style="margin-top:10px;padding:10px;border:1px dashed #111;border-radius:12px;background:#fafafa;line-height:1.8;">
      <div style="font-weight:900;">ğŸ” éˆä¸Šé©—è­‰ï¼ˆBscScan / PancakeSwap / PinkLockï¼‰</div>

      <div style="margin-top:6px;">
        KGENï¼ˆKLINE GENESISï¼‰Tokenï¼š
        <a id="linkToken" class="addr addr-2line" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;"></a>
      </div>

      <div style="margin-top:4px;">
        PancakeSwapï¼ˆå®˜æ–¹äº¤æ˜“ï¼‰ï¼š
        <a id="linkSwap" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;">KGEN / WBNB</a>
      </div>

      <div style="margin-top:4px;">
        LP Pairï¼š
        <a id="linkLP" class="addr addr-2line" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;"></a>
      </div>

      <div style="margin-top:4px;">
        PinkLockï¼š
        <a id="linkPink" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;">æŸ¥çœ‹é–å€‰</a>
      </div>

      <div id="envHint" style="margin-top:8px;opacity:.85;"></div>
    </div>
  </div>

  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="font-weight:900;">ğŸ§¿ åƒæ‹œç´€éŒ„ï¼ˆæœ¬æ©Ÿ localStorageï¼‰</div>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
      <button id="btnVisit"
        style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
        ğŸ™ ç™»å…¥åƒæ‹œ
      </button>
      <button id="btnDivination"
        style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
        ğŸ§¿ æ“²ç­Šï¼ˆ50%ï¼‰
      </button>
      <button id="btnExit"
        style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
        ğŸšª ç™»å‡ºé›¢é–‹
      </button>
      <button id="btnExport"
        style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
        â¬‡ï¸ åŒ¯å‡º JSON
      </button>
      <button id="btnClear"
        style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
        ğŸ§¹ æ¸…é™¤ç´€éŒ„
      </button>
    </div>

    <div id="localInfo" style="margin-top:10px;line-height:1.9;"></div>

    <div style="margin-top:10px;border-top:1px solid #111;padding-top:10px;">
      <div style="font-weight:900;">ğŸ“Š ä¾†è¨ªçµ±è¨ˆï¼ˆCountAPI / fallbackï¼‰</div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
        <button id="btnRefreshStats"
          style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
          ğŸ”„ æ›´æ–°çµ±è¨ˆ
        </button>
        <button id="btnReHit"
          style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
          ğŸ« å†å‘¼å¸ä¸€æ¬¡ï¼ˆæ¸¬è©¦ hitï¼‰
        </button>
      </div>
      <div id="visitorInfo" style="margin-top:10px;line-height:1.9;"></div>
      <div id="visitorHint" style="opacity:.85;margin-top:6px;"></div>
    </div>
  </div>

  <div style="margin-top:14px;padding-top:12px;border-top:1px solid #111;line-height:1.8;">
    PrimeForge ä»¥æ¯æ©Ÿä¹‹åï¼Œé–‹å•Ÿé‡‘èç”Ÿå‘½ã€‚<br/>
    èŠ±æœå±±å°ç£ãƒ»ä¿¡å¿µä¸æ»…ãƒ»å¸‚å ´ç„¡ç•Œã€‚<br/>
    Where the Market Becomes the Myth.<br/>
    â€”â€” æ¨‚å¤©å¸ âŒ–
  </div>

</div>

<script src="./ethers-5.7.2.umd.min.js"></script>

<script>
(() => {
  "use strict";
  const $ = (id) => document.getElementById(id);
  const safeParse = (s) => { try { return JSON.parse(s); } catch { return null; } };
  const nowISO = () => new Date().toISOString();

  const CHAIN_ID_DEC = 56;
  const KGEN_TOKEN = "0xBA3d3810e58735cb6813bC1CDc5458C0d71432Be";
  const KGEN_SYMBOL = "KGEN";
  const KGEN_NAME = "KLINE GENESIS";
  const KGEN_DECIMALS = 18;

  const LP_PAIR = "0xf36640d7327b53ba3d7fcc1d98dfc1b85574b6c2";
  const PINKLOCK_URL = "https://www.pinksale.finance/pinklock/bsc/record/1427003";

  const VOW_ADDR = {
    blackhole: "0x0000000000000000000000000000000000000000",
    kufo_engine: "0xef83804c264B47378FCf150086943B53fB90A90b",
    public_good_treasury: "0xB73D6716005B37BEC742D64482fA26033eE1A4E1"
  };
  const FORTUNE_TREASURY = VOW_ADDR.public_good_treasury;

  // é€™å€‹å°±æ˜¯ä½ å•çš„ FAUCET_CONTRACTï¼ˆç™¼æ”¾åˆç´„åœ°å€ï¼‰ï¼šæ²’éƒ¨ç½²å°±ç•™ç©º
  const FAUCET_CONTRACT = "REPLACE_WITH_DEPLOYED_FAUCET_CONTRACT";
  const COUNT_NS = "klineodyssey-wukong-temple";
  const PULSE_KEY = "klineodyssey_wukongTemple_pulse_v0_6";

  const dayKey = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `day_${yyyy}${mm}${dd}`;
  };

  const countapi = {
    hit: async (key) => {
      const url = `https://api.countapi.xyz/hit/${encodeURIComponent(COUNT_NS)}/${encodeURIComponent(key)}`;
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error("countapi_hit_failed");
      return await r.json();
    },
    get: async (key) => {
      const url = `https://api.countapi.xyz/get/${encodeURIComponent(COUNT_NS)}/${encodeURIComponent(key)}`;
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error("countapi_get_failed");
      return await r.json();
    }
  };

  const renderVisitors = (todayVal, totalVal, note) => {
    $("visitorInfo").innerHTML = `
      <div>ğŸ“… ä»Šæ—¥ä¾†è¨ªï¼š<strong>${todayVal}</strong></div>
      <div>ğŸŒ ç¸½ä¾†è¨ªï¼š<strong>${totalVal}</strong></div>
    `;
    $("visitorHint").textContent = note || "";
  };

  const localVisitorFallback = (doHit) => {
    const kDay = "local_visit_" + dayKey();
    const kTotal = "local_visit_total";
    const get = (k) => Number(localStorage.getItem(k) || "0");
    const set = (k, v) => localStorage.setItem(k, String(v));
    let day = get(kDay);
    let total = get(kTotal);
    if (doHit) { day += 1; total += 1; set(kDay, day); set(kTotal, total); }
    renderVisitors(day, total, "ï¼ˆæç¤ºï¼šå¤–éƒ¨çµ±è¨ˆè¢«é˜»æ“‹ï¼Œå·²æ”¹ç”¨æœ¬æ©Ÿçµ±è¨ˆ fallbackã€‚ï¼‰");
  };

  const refreshVisitors = async (doHit) => {
    try {
      const dk = dayKey();
      let todayVal = 0;
      let totalVal = 0;
      if (doHit) {
        const [t1, t2] = await Promise.all([countapi.hit(dk), countapi.hit("total")]);
        todayVal = t1.value ?? 0;
        totalVal = t2.value ?? 0;
      } else {
        const [g1, g2] = await Promise.all([countapi.get(dk), countapi.get("total")]);
        todayVal = g1.value ?? 0;
        totalVal = g2.value ?? 0;
      }
      renderVisitors(todayVal, totalVal, "ï¼ˆä¾†æºï¼šCountAPI å¾Œç«¯çµ±è¨ˆï¼‰");
    } catch {
      localVisitorFallback(doHit);
    }
  };

  const KEY = "klineodyssey_wukongTemple_state_v0_6";
  const load = () => {
    const s = safeParse(localStorage.getItem(KEY) || "");
    const base = { visitCount: 0, exitCount: 0, divinationStreak: 0, vitals: { heartbeat: 0, breath: 0, pressure: 0 }, logs: [] };
    return Object.assign(base, s || {});
  };
  const save = (s) => localStorage.setItem(KEY, JSON.stringify(s));

  const pushLog = (s, type, data) => {
    s.logs = s.logs || [];
    s.logs.push({ t: nowISO(), type, data: data || {} });
    if (s.logs.length > 300) s.logs = s.logs.slice(-300);
  };

  const renderLocal = () => {
    const s = load();
    $("localInfo").innerHTML = `
      <div>ğŸ™ åƒæ‹œæ¬¡æ•¸ï¼š<strong>${s.visitCount}</strong></div>
      <div>ğŸšª é›¢é–‹æ¬¡æ•¸ï¼š<strong>${s.exitCount}</strong></div>
      <div>ğŸ§¿ è–ç­Šé€£å‹ï¼š<strong>${s.divinationStreak}</strong></div>
    `;
    const btn = $("btnFortune");
    if (s.divinationStreak >= 3) {
      btn.disabled = false;
      btn.style.cursor = "pointer";
      btn.style.background = "#fff";
    } else {
      btn.disabled = true;
      btn.style.cursor = "not-allowed";
      btn.style.background = "#f3f3f3";
    }
  };

  const renderDivination = () => {
    const s = load();
    const v = s.divinationStreak || 0;
    $("vitalsInfo").innerHTML = `
      <div>â¤ï¸ å¿ƒè·³æ¬¡æ•¸ï¼š<strong>${s.vitals.heartbeat || 0}</strong></div>
      <div>ğŸ« å‘¼å¸æ¬¡æ•¸ï¼š<strong>${s.vitals.breath || 0}</strong></div>
      <div>ğŸ©¸ è¡€å£“æ¬¡æ•¸ï¼š<strong>${s.vitals.pressure || 0}</strong></div>
      <div style="margin-top:8px;">ğŸ§¿ è–ç­Šé€£å‹ï¼š<strong>${v}</strong>ï¼ˆé” 3 æ‰é–‹å•Ÿé ˜ç™¼è²¡é‡‘ï¼‰</div>
    `;
  };

  const toast = (msg) => {
    const el = document.createElement("div");
    el.textContent = msg;
    el.style.cssText = "position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:999px;font-weight:900;z-index:99999;max-width:92vw;text-align:center;";
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 1600);
  };

  const chance = (p) => Math.random() < p;

  const setAICaption = (t) => { const el = $("aiCaption"); if (el) el.textContent = t || ""; };

  // æ–‡å­—â†’èªéŸ³ï¼ˆåŒæ™‚é€å­—æ›´æ–°ã€Œå³æ™‚æ–‡å­—ã€ï¼‰
  const speakText = (text) => {
    try {
      if (!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "zh-TW";
      u.rate = 1.0;

      // é€å­—å­—å¹•ï¼šç”¨ boundary çš„ charIndexï¼ˆä¸åŒç€è¦½å™¨æ”¯æ´åº¦ä¸ä¸€ï¼›ä¸æ”¯æ´å°±ä¸€æ¬¡é¡¯ç¤ºå…¨æ–‡ï¼‰
      let lastIdx = 0;
      setAICaption("");
      u.onstart = () => { setAICaption(""); lastIdx = 0; };
      u.onboundary = (ev) => {
        try {
          if (typeof ev.charIndex === "number") {
            const idx = Math.max(0, ev.charIndex);
            if (idx !== lastIdx) {
              lastIdx = idx;
              setAICaption(text.slice(0, idx));
            }
          }
        } catch {}
      };
      u.onend = () => { setAICaption(text); };

      window.speechSynthesis.speak(u);
    } catch {}
  };

  const stopSpeak = () => { try { window.speechSynthesis.cancel(); } catch {} };

  let provider = null;
  let signer = null;
  let userAddr = null;

  const ensureChain = async () => {
    const hex = "0x" + CHAIN_ID_DEC.toString(16);
    const curr = await window.ethereum.request({ method: "eth_chainId" });
    if (curr === hex) return;
    try {
      await window.ethereum.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: hex }]
      });
    } catch (e) {
      throw e;
    }
  };

  const fmtAddr = (a) => a ? (a.slice(0, 6) + "â€¦" + a.slice(-4)) : "";
  const fmt = (n) => {
    try { return new Intl.NumberFormat("en-US", { maximumFractionDigits: 4 }).format(n); }
    catch { return String(n); }
  };

 const renderWallet = async () => {
    const lines = [];
    if (!window.ethereum) {
      lines.push(`<div>éŒ¢åŒ…ï¼š<strong>æœªåµæ¸¬åˆ°</strong>ï¼ˆä½ ä»å¯ä½¿ç”¨ã€Œééˆä¸Šã€äº’å‹•ï¼‰</div>`);
      $("walletInfo").innerHTML = lines.join("");
      return;
    }
    try {
      if (!provider || !signer) {
        lines.push(`<div>éŒ¢åŒ…ï¼š<strong>å°šæœªé€£ç·š</strong></div>`);
      } else {
        lines.push(`<div>éŒ¢åŒ…ï¼š<strong>${fmtAddr(userAddr)}</strong></div>`);
        const erc20Abi = [
          "function symbol() view returns (string)",
          "function name() view returns (string)",
          "function decimals() view returns (uint8)",
          "function balanceOf(address) view returns (uint256)"
        ];
        const kgen = new ethers.Contract(KGEN_TOKEN, erc20Abi, provider);
        const bal = await kgen.balanceOf(userAddr);
        const human = Number(ethers.utils.formatUnits(bal, KGEN_DECIMALS));
        lines.push(`<div>KGEN é¤˜é¡ï¼š<strong>${fmt(human)}</strong></div>`);
      }
    } catch {
      lines.push(`<div style="opacity:.85;">é¤˜é¡è®€å–å¤±æ•—ï¼šè«‹ç¢ºèªåœ¨ BSC ä¸»ç¶²ï¼Œä¸” ethers æª”æ¡ˆå¯è¼‰å…¥ã€‚</div>`);
    }
    $("walletInfo").innerHTML = lines.join("");
  };

  const mkBscAddr = (addr) => `https://bscscan.com/address/${addr}`;
  const mkBscToken = (addr) => `https://bscscan.com/token/${addr}`;

  $("linkToken").textContent = KGEN_TOKEN;
  $("linkToken").href = mkBscToken(KGEN_TOKEN);
  $("linkSwap").href = `https://pancakeswap.finance/swap?outputCurrency=${KGEN_TOKEN}`;
  $("linkLP").textContent = LP_PAIR;
  $("linkLP").href = mkBscAddr(LP_PAIR);
  $("linkPink").href = PINKLOCK_URL;

  const env = [];
  env.push(`Networkï¼šBSC Mainnetï¼ˆChainId ${CHAIN_ID_DEC}ï¼‰`);
  env.push(`Tokenï¼š${KGEN_SYMBOL}ï¼ˆ${KGEN_NAME}ï¼‰`);
  env.push(`Web3ï¼š${window.ethereum ? "åµæ¸¬åˆ°éŒ¢åŒ…" : "æœªåµæ¸¬åˆ°éŒ¢åŒ…ï¼ˆä»å¯ç”¨ééˆä¸ŠåŠŸèƒ½ï¼‰"}`);
  env.push(`Ethersï¼š${(typeof ethers !== "undefined") ? "OK" : "æœªè¼‰å…¥ï¼ˆè«‹ç¢ºèª ethers æª”åŒè³‡æ–™å¤¾ï¼‰"}`);
  $("envHint").textContent = env.join("ï½œ");

  const startAssistant = () => {
    const s = load();
    const line1 = `æ­¡è¿ä¾†åˆ°äº”æŒ‡å±±æ‚Ÿç©ºè²¡ç¥æ®¿ã€‚`;
    const line2 = `ä½ ç›®å‰è–ç­Šé€£å‹æ˜¯ ${s.divinationStreak || 0} æ¬¡ã€‚`;
    const line3 = `ä»Šå¤©å…ˆåšä¸‰ä»¶äº‹ï¼šå¿ƒè·³ï¼Œå‘¼å¸ï¼Œè¡€å£“ã€‚æº–å‚™å¥½äº†å°±è·Ÿæˆ‘èªªï¼šå•Ÿå‹•ã€‚`;
    speakText(`${line1}${line2}${line3}`);
    toast("æ‚Ÿç©ºè²¡ç¥æ®¿ï¼šèªéŸ³å®¢æœå•Ÿå‹•");
  };

<button id="btnGuide"
 style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
  ğŸ§­ æ–°æ‰‹å°è¦½
</button>
  
function wukongNewbieGuide(){
  const t =
  "ä½ ç¾åœ¨åœ¨æ‚Ÿç©ºè²¡ç¥æ®¿ã€‚æ²’æœ‰éŒ¢åŒ…ä¹Ÿæ²’é—œä¿‚ï¼Œæˆ‘å¸¶ä½ ä¸€æ­¥ä¸€æ­¥åšã€‚"+
  "ç¬¬ä¸€æ­¥ï¼Œå…ˆå®‰è£éŒ¢åŒ…ï¼Œå»ºè­°ç”¨MetaMaskæˆ–Trust Walletã€‚"+
  "ç¬¬äºŒæ­¥ï¼Œå»ºç«‹éŒ¢åŒ…ä¸¦ä¿å­˜åŠ©è¨˜è©ï¼Œé€™æ˜¯ä½ çš„ç”Ÿå‘½ç·šã€‚"+
  "ç¬¬ä¸‰æ­¥ï¼Œåˆ‡åˆ°BSCä¸»ç¶²ã€‚"+
  "ç¬¬å››æ­¥ï¼ŒKGENæœå°‹ä¸åˆ°æ˜¯æ­£å¸¸çš„ï¼Œä½ è¦ç”¨è‡ªè¨‚ä»£å¹£åŠ å…¥ã€‚"+
  "æŠŠKGENåˆç´„åœ°å€è²¼é€²Importæˆ–Custom Tokenã€‚"+
  "å®Œæˆå¾Œå›åˆ°è²¡ç¥æ®¿ï¼ŒæŒ‰é€£ç·šéŒ¢åŒ…ã€‚"+
  "æœ€å¾Œï¼Œæ“²ç­Šé€£å‹ä¸‰æ¬¡ï¼Œæ‰æœƒé–‹å•Ÿé ˜ç™¼è²¡é‡‘ã€‚";
  speakText(t);
  setAICaption(t);
}
document.getElementById("btnGuide")?.addEventListener("click", wukongNewbieGuide);
  
  $("btnSpeak").addEventListener("click", () => startAssistant());
  $("btnAutoStart")?.addEventListener("click", () => startAssistant());
  $("btnStopSpeak").addEventListener("click", () => { stopSpeak(); toast("å·²åœæ­¢èªéŸ³"); });

  // éº¥å…‹é¢¨è½‰æ–‡å­—ï¼ˆå¯ç”¨å¯ä¸ç”¨ï¼›ä¸æ”¯æ´å°±æç¤ºï¼‰
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null;
  const startMic = () => {
    const out = $("userTranscript");
    if (!SR) { if (out) out.textContent = "æ­¤ç€è¦½å™¨ä¸æ”¯æ´ SpeechRecognitionï¼ˆå»ºè­°ç”¨ Chrome / Edgeï¼‰ã€‚"; toast("éº¥å…‹é¢¨è½‰æ–‡å­—ä¸æ”¯æ´"); return; }
    rec = new SR();
    rec.lang = "zh-TW";
    rec.interimResults = true;
    rec.continuous = true;

    let finalText = "";
    if (out) out.textContent = "";
    rec.onresult = (ev) => {
      let interim = "";
      for (let i = ev.resultIndex; i < ev.results.length; i++) {
        const res = ev.results[i];
        const t = res[0]?.transcript || "";
        if (res.isFinal) finalText += t;
        else interim += t;
      }
      if (out) out.textContent = finalText + interim;
    };
    rec.onerror = () => { toast("éº¥å…‹é¢¨éŒ¯èª¤æˆ–æœªæˆæ¬Š"); };
    rec.onend = () => {};
    try { rec.start(); toast("é–‹å§‹è½ä½ èªªè©±"); } catch { toast("ç„¡æ³•å•Ÿå‹•éº¥å…‹é¢¨"); }
  };
  const stopMic = () => { try { rec && rec.stop(); } catch {} rec = null; toast("å·²åœæ­¢è½ä½ "); };

  $("btnMic")?.addEventListener("click", () => startMic());
  $("btnStopMic")?.addEventListener("click", () => stopMic());

  // ç›¡é‡ã€Œè‡ªå‹•é–‹å§‹ã€ï¼šç¬¬ä¸€æ¬¡äº’å‹•å¾Œè‡ªå‹•æ’­å ±ï¼ˆç¬¦åˆç€è¦½å™¨æ”¿ç­–ï¼‰
  let _autoStarted = false;
  const autoStartOnce = () => {
    if (_autoStarted) return;
    _autoStarted = true;
    startAssistant();
  };
  window.addEventListener("pointerdown", autoStartOnce, { once: true });
  window.addEventListener("keydown", autoStartOnce, { once: true });

  $("btnRefreshStats").addEventListener("click", async () => { await refreshVisitors(false); toast("å·²æ›´æ–°ä¾†è¨ªçµ±è¨ˆ"); });
  $("btnReHit").addEventListener("click", async () => { await refreshVisitors(true); toast("å·²å†å‘¼å¸ä¸€æ¬¡ï¼ˆæ¸¬è©¦ï¼‰"); });

  $("btnDivination").addEventListener("click", () => {
    const s = load();
    const ok = chance(0.5);
    if (ok) { s.divinationStreak = (s.divinationStreak || 0) + 1; pushLog(s, "divination_yes", { streak: s.divinationStreak }); save(s); toast("è–ç­Š"); }
    else { s.divinationStreak = 0; pushLog(s, "divination_no", {}); save(s); toast("é™°ç­Š"); }
    renderDivination(); renderLocal();
  });

  $("btnVisit").addEventListener("click", () => { const s = load(); s.visitCount += 1; pushLog(s, "visit", {}); save(s); renderLocal(); toast("å·²è¨˜éŒ„ï¼šç™»å…¥åƒæ‹œ"); });
  $("btnExit").addEventListener("click", () => { const s = load(); s.exitCount += 1; pushLog(s, "exit", {}); save(s); renderLocal(); toast("å·²è¨˜éŒ„ï¼šç™»å‡ºé›¢é–‹"); });

  const downloadJSON = (obj, filename) => {
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1200);
  };

  $("btnExport").addEventListener("click", () => { downloadJSON(load(), `wukong_temple_log_${dayKey()}.json`); toast("å·²åŒ¯å‡º JSON"); });
  $("btnClear").addEventListener("click", () => { if (!confirm("ç¢ºå®šæ¸…é™¤æœ¬æ©Ÿç´€éŒ„ï¼Ÿ")) return; localStorage.removeItem(KEY); renderLocal(); renderDivination(); toast("å·²æ¸…é™¤"); });

  $("btnConnect").addEventListener("click", async () => {
    try {
      if (!window.ethereum) { toast("æ‰¾ä¸åˆ°éŒ¢åŒ…"); return; }
      await ensureChain();
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      userAddr = await signer.getAddress();
      toast("éŒ¢åŒ…å·²é€£ç·šï¼ˆBSC ä¸»ç¶²ï¼‰");
      await renderWallet();
    } catch { toast("é€£ç·šå¤±æ•—æˆ–æœªæˆæ¬Š"); }
  });

  // Vitalsï¼šå¿ƒè·³ / å‘¼å¸ / è¡€å£“ï¼ˆæœ¬æ©Ÿè¨ˆæ•¸ + æ—¥èªŒï¼‰
  const doHeartbeat = () => {
    const s = load();
    s.vitals.heartbeat = (s.vitals.heartbeat || 0) + 1;
    pushLog(s, "heartbeat", { n: s.vitals.heartbeat });
    save(s);
    renderDivination();
  };
  const doBreath = () => {
    const s = load();
    s.vitals.breath = (s.vitals.breath || 0) + 1;
    pushLog(s, "breath", { n: s.vitals.breath });
    save(s);
    renderDivination();
  };
  const doPressure = () => {
    const s = load();
    s.vitals.pressure = (s.vitals.pressure || 0) + 1;
    pushLog(s, "pressure", { n: s.vitals.pressure });
    save(s);
    renderDivination();
  };

  $("btnHeartbeat").addEventListener("click", () => { doHeartbeat(); toast("å¿ƒè·³å·²è¨˜éŒ„"); });
  $("btnBreath").addEventListener("click", () => { doBreath(); toast("å‘¼å¸å·²è¨˜éŒ„"); });
  $("btnPressure").addEventListener("click", () => { doPressure(); toast("è¡€å£“å·²è¨˜éŒ„"); });

  // ç™¼è²¡é‡‘ï¼šç›®å‰åªåšã€Œæª¢æŸ¥æ˜¯å¦æœ‰éƒ¨ç½²åˆç´„ã€çš„é–å®šæ©Ÿåˆ¶
  $("btnFortune").addEventListener("click", async () => {
    const s = load();
    if ((s.divinationStreak || 0) < 3) { toast("è–ç­Šé€£å‹æœªé” 3"); return; }
    if (!FAUCET_CONTRACT || FAUCET_CONTRACT.includes("REPLACE_WITH")) {
      toast("å°šæœªéƒ¨ç½²ç™¼æ”¾åˆç´„ï¼šFAUCET_CONTRACT æœªè¨­å®š");
      speakText("ç™¼è²¡é‡‘å°šæœªå•Ÿå‹•ã€‚å› ç‚ºä½ é‚„æ²’æŠŠç™¼æ”¾åˆç´„åœ°å€å¡«å…¥ã€‚ç­‰åˆç´„éƒ¨ç½²å¥½ï¼Œæ‚Ÿç©ºæ‰æœƒæŠŠç™¼è²¡é‡‘é€å‡ºå»ã€‚");
      return;
    }
    toast("ç™¼æ”¾åˆç´„å·²è¨­å®šï¼Œä½†ä½ å°šæœªæ¥ä¸Šåˆç´„ ABI èˆ‡ç™¼æ”¾å‡½å¼ã€‚ä¸‹ä¸€æ­¥å†åšã€‚");
    speakText("æˆ‘æ„Ÿå—åˆ°ç™¼æ”¾åˆç´„åœ°å€å·²å­˜åœ¨ã€‚ä½†é‚„ç¼ºå°‘åˆç´„ä»‹é¢èˆ‡å¯¦éš›ç™¼æ”¾å‹•ä½œã€‚ä¸‹ä¸€æ­¥æˆ‘å€‘æœƒæŠŠç™¼è²¡é‡‘çœŸæ­£ç™¼å‡ºå»ã€‚");
  });

 // æ¯å°æ™‚å¿ƒè·³ä¸€æ¬¡ï¼ˆè±¡å¾µå®‡å®™å¿ƒè·³ç¯€å¥ï¼‰
  setInterval(doHeartbeat, 60 * 60 * 1000);

  // åˆå§‹åˆ·æ–°
  refreshVisitors(true);
  renderLocal();
  renderDivination();
  renderWallet();
})();
</script>

<script>
(function(){
  const ua = navigator.userAgent || "";
  const isFB = /FBAN|FBAV|Instagram/i.test(ua);
  const hasEth = typeof window.ethereum !== "undefined";

  if (isFB && !hasEth) {
    const bar = document.createElement("div");
    bar.style.cssText =
      "position:fixed;left:0;right:0;bottom:0;z-index:9999;" +
      "background:#111;color:#fff;padding:12px 14px;" +
      "display:flex;gap:10px;align-items:center;justify-content:space-between;" +
      "font-size:14px;line-height:1.4;";
    bar.innerHTML = `
      <div style="flex:1;">
        âš ï¸ ç›®å‰åœ¨ Facebook å…§å»ºç€è¦½å™¨ï¼Œå¯èƒ½ç„¡æ³•é€£æ¥éŒ¢åŒ…ã€‚<br/>
        å»ºè­°æ”¹ç”¨ <b>Chrome</b> æˆ– <b>éŒ¢åŒ…å…§å»ºç€è¦½å™¨</b> é–‹å•Ÿæ‚Ÿç©ºè²¡ç¥æ®¿ã€‚
      </div>
      <div style="display:flex;gap:8px;">
        <button id="openExternal"
          style="padding:8px 10px;border-radius:999px;border:1px solid #fff;background:#fff;color:#111;font-weight:900;">
          ç”¨ç€è¦½å™¨é–‹
        </button>
        <button id="dismissBar"
          style="padding:8px 10px;border-radius:999px;border:1px solid #555;background:#111;color:#fff;">
          é—œé–‰
        </button>
      </div>
    `;
    document.body.appendChild(bar);

    document.getElementById("openExternal").onclick = () => {
      // å˜—è©¦è·³å¤–éƒ¨ç€è¦½å™¨
      window.open(window.location.href, "_blank");
    };
    document.getElementById("dismissBar").onclick = () => {
      bar.remove();
    };
  }
})();
</script>

<script>
try {
  if ('speechSynthesis' in window) {
    const u = new SpeechSynthesisUtterance("æ‚Ÿç©ºåœ¨æ­¤ï¼ŒèªéŸ³ç³»çµ±å·²æ¢å¾©ã€‚");
    u.lang = "zh-TW";
    window.speechSynthesis.speak(u);
  }
} catch (e) {
  alert("èªéŸ³æ¨¡çµ„éŒ¯èª¤ï¼š" + e.message);
}
</script>
  
</body>
</html>
