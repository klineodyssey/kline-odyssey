<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>äº”æŒ‡å±±ãƒ»æ‚Ÿç©ºè²¡ç¥æ®¿ï½œWukong Fortune Hall</title>
<style>
  :root { --bg:#0b0f14; --card:#111827; --muted:#9ca3af; --txt:#e5e7eb; --acc:#f59e0b; --ok:#10b981; --bad:#ef4444; --line:#1f2937; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#070a0f,#0b0f14 30%,#070a0f);color:var(--txt);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif}
  a{color:#93c5fd;text-decoration:none}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .hero{padding:12px 14px;border:1px solid var(--line);background:rgba(17,24,39,.65);border-radius:16px}
  .row{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
  @media (min-width:860px){.row{grid-template-columns:1.1fr .9fr}}
  .card{padding:12px 14px;border:1px solid var(--line);background:rgba(17,24,39,.55);border-radius:16px}
  .h{font-weight:800;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:13px;line-height:1.4}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.25);font-size:12px;color:var(--muted)}
  .btn{cursor:pointer;border:1px solid var(--line);background:rgba(0,0,0,.25);color:var(--txt);padding:10px 12px;border-radius:12px;font-weight:700}
  .btn:hover{border-color:#334155}
  .btn.acc{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.35)}
  .btn.ok{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.35)}
  .btn.bad{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .k{color:var(--muted);font-size:12px}
  input,select,textarea{width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.25);color:var(--txt)}
  textarea{min-height:84px;resize:vertical}
  pre{white-space:pre-wrap;background:rgba(0,0,0,.35);padding:10px;border-radius:12px;border:1px solid var(--line);color:#d1d5db}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .tagok{color:var(--ok);font-weight:800}
  .tagbad{color:var(--bad);font-weight:800}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  details>summary{cursor:pointer;color:#cbd5e1;font-weight:800}
  .mini{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <div class="h">ğŸ’ äº”æŒ‡å±±ãƒ»æ‚Ÿç©ºè²¡ç¥æ®¿ï½œWukong Fortune Hall</div>
    <div class="sub">
      <span class="pill mono">boot_version=<span id="bootVer">v3.0.0-modular</span></span>
      <span class="pill mono" id="envPill">env: ...</span>
      <span class="pill">ğŸŒ <a href="../" target="_blank" rel="noopener">Official Website</a></span>
    </div>
    <div class="hr"></div>
    <div class="sub">é€™è£¡ä¸æ˜¯ä¸€èˆ¬å»Ÿã€‚å¿ƒè·³ãƒ»å‘¼å¸ãƒ»è¡€å£“ãƒ»æ“²ç­Šãƒ»è¨±é¡˜æ± ãƒ»å…‰æ˜ç‡ˆãƒ»å®‡å®™ç´°åŒ…ãƒ»ç”Ÿå‘½å·¥å» ï¼Œéƒ½ä»¥ã€Œæœ¬æ©ŸåŸå‹ã€å…ˆå»ºå¥½ï¼Œç­‰ Faucet / KUFO ä¸Šéˆå¾Œå†æ¥åœ°å€ã€‚</div>
  </div>

  <div class="row">
    <div class="card">
      <div class="h">ğŸ« å®‡å®™ç”Ÿå‘½å¾µè±¡ï½œCosmic Vitals</div>
      <div class="sub">ï¼ˆæœ¬æ©Ÿè¨˜éŒ„ï¼‰æ¯æ¬¡æŒ‰éµéƒ½æœƒå¯«å…¥ Debug Consoleï¼Œæ–¹ä¾¿ä½ è²¼å›ä¾†å®šä½å•é¡Œã€‚</div>
      <div class="hr"></div>
      <div class="grid3">
        <button class="btn acc" id="btnHeartbeat">â¤ï¸ å¿ƒè·³</button>
        <button class="btn acc" id="btnBreath">ğŸ« å‘¼å¸</button>
        <button class="btn acc" id="btnPressure">ğŸ©¸ è¡€å£“</button>
      </div>
      <div style="margin-top:10px" class="grid2">
        <button class="btn" id="btnCup">ğŸ¥¢ æ“²ç­Š</button>
        <button class="btn ok" id="btnFortune">ğŸ§§ é ˜ç™¼è²¡é‡‘ï¼ˆéœ€åˆç´„ï¼‰</button>
      </div>
      <div style="margin-top:10px" class="sub">
        è–ç­Šé€£å‹ï¼š<span class="mono" id="cupStreak">0</span> / 3ã€€
        <span id="cupResult" class="mono"></span>
      </div>

      <div class="hr"></div>

      <div class="h">ğŸ”Š è²éŸ³ï¼ˆTTS / å®ï¼‰</div>
      <div class="sub">Autoï¼šæœ‰ TTS å°±ç”¨ TTSï¼Œå¦å‰‡ç”¨å®è²ã€‚MetaMask WebView å¸¸æœƒ speechSynthesis=falseã€‚</div>
      <div class="grid2" style="margin-top:10px">
        <select id="soundMode">
          <option value="auto">Auto</option>
          <option value="tts">TTS</option>
          <option value="beep">å®ï¼ˆWebAudioï¼‰</option>
          <option value="off">é—œé–‰</option>
        </select>
        <button class="btn" id="btnSoundTest">æ¸¬è©¦</button>
      </div>
    </div>

    <div class="card">
      <div class="h">ğŸªª éŒ¢åŒ…ç‹€æ…‹ï¼ˆBSC ä¸»ç¶²ï¼‰</div>
      <div class="sub">Chrome é–‹å•Ÿå¯èƒ½æœ‰ TTSï¼Œä½†å¯èƒ½æ²’æœ‰éŒ¢åŒ…æ³¨å…¥ï¼›MetaMask å…§å»º WebView åä¹‹ã€‚</div>
      <div class="hr"></div>
      <div class="grid2">
        <button class="btn ok" id="btnConnect">é€£ç·šéŒ¢åŒ…</button>
        <button class="btn" id="btnDisconnect">æ–·é–‹ï¼ˆUIï¼‰</button>
      </div>
      <div style="margin-top:10px" class="grid2">
        <button class="btn" id="btnExportState">åŒ¯å‡ºç‹€æ…‹ JSON</button>
        <button class="btn bad" id="btnClearState">æ¸…é™¤æœ¬æ©Ÿç‹€æ…‹</button>
      </div>

      <div class="hr"></div>
      <div class="mini mono">Wallet</div>
      <div class="mono" id="walletAddr">(not connected)</div>
      <div class="mini mono" style="margin-top:8px">Chain</div>
      <div class="mono" id="chainId">(unknown)</div>

      <div class="hr"></div>
      <div class="h">âš™ï¸ è¨­å®šé¢æ¿ï¼ˆæœ¬æ©Ÿå„²å­˜ï¼Œä¸ä¸Šéˆï¼‰</div>
      <div class="sub">æŠŠå·²éƒ¨ç½²åˆç´„åœ°å€è²¼ä¸Šä¾†ï¼Œè®“æŒ‰éµçŸ¥é“è¦æ‰“å“ªå€‹åˆç´„ã€‚</div>
      <div class="hr"></div>
      <div class="k">Faucet åˆç´„åœ°å€</div>
      <input id="cfgFaucet" placeholder="0x..."/>
      <div class="k" style="margin-top:8px">KUFO ç„¡äººéŠ€è¡Œåˆç´„åœ°å€</div>
      <input id="cfgKufo" placeholder="0x..."/>
      <div class="k" style="margin-top:8px">å›æ”¶åœ°å€ï¼ˆR1/R2/R3ï¼‰</div>
      <div class="grid3">
        <input id="cfgR1" placeholder="R1 0x..."/>
        <input id="cfgR2" placeholder="R2 0x..."/>
        <input id="cfgR3" placeholder="R3 0x..."/>
      </div>
      <div class="k" style="margin-top:8px">å…¬ç›Šåœ‹åº«ï¼ˆé è¨­ï¼‰</div>
      <input id="cfgPG" value="0xB73D6716005B37BEC742D64482fA26033eE1A4E1"/>

      <div class="grid2" style="margin-top:10px">
        <button class="btn ok" id="btnCfgSave">ä¿å­˜</button>
        <button class="btn" id="btnCfgClear">æ¸…é™¤</button>
      </div>
    </div>
  </div>

<div class="row">
  <label>KGEN Tokenï¼ˆBSCï¼‰</label>
  <input id="cfgKgenToken" placeholder="0x...ï¼ˆKGEN åˆç´„åœ°å€ï¼‰" />
</div>

<div class="row">
  <label>æ‚Ÿç©ºå¤§è…¦ Brain åˆç´„ï¼ˆWBEï¼‰</label>
  <input id="cfgBrain" placeholder="0x...ï¼ˆBrainEngine åˆç´„åœ°å€ï¼Œä¸Šéˆå¾Œå†å¡«ï¼‰" />
</div>

  <div class="card" style="margin-top:12px">
    <div class="h">ğŸ§ å½±åƒèªéŸ³å®¢æœï¼ˆæœ¬æ©Ÿï¼‰</div>
    <div class="sub">æŒ‰ã€Œå•Ÿå‹•å®¢æœã€æœƒæœ—è®€è¦å‰‡ï¼ˆTTS æˆ–å®ï¼‰ã€‚ä¹Ÿå¯èªéŸ³è¼¸å…¥ï¼ˆè£ç½®æ”¯æ´æ‰æœƒæœ‰ STTï¼‰ã€‚</div>
    <div class="hr"></div>
    <div class="grid3">
      <button class="btn acc" id="btnAssistantStart">â–¶ï¸ å•Ÿå‹•å®¢æœ</button>
      <button class="btn" id="btnSttStart">ğŸ™ï¸ èªéŸ³è¼¸å…¥</button>
      <button class="btn" id="btnSttStop">â¹ï¸ åœæ­¢</button>
    </div>
    <div class="hr"></div>
    <div class="mono" id="assistantBox">æ‚Ÿç©ºå®¢æœï¼šæŒ‰ã€Œå•Ÿå‹•å®¢æœã€æœƒé¡¯ç¤ºè¦å‰‡è§£èªªã€‚</div>
  </div>

  <div class="row" style="margin-top:12px">
    <div class="card">
      <div class="h">âœ¨ ä¸ƒä»™å¥³æ˜Ÿåº§ç›¤ï½œä¸ƒæ˜Ÿå®ˆè­·</div>
      <div class="sub">è¼‰å…¥å¾Œå¯ç›´æ¥æŠ•å‘è¨±é¡˜æ± ã€‚</div>
      <div class="hr"></div>
      <button class="btn" id="btnLoadFairies">è¼‰å…¥åˆ°è¨±é¡˜æ± </button>
      <div class="hr"></div>
      <div id="fairyList"></div>
    </div>

    <div class="card">
      <div class="h">ğŸ’§ ä¸ƒä»™å¥³è¨±é¡˜æ± ï¼ˆWish Poolï¼‰</div>
      <div class="sub">æœ¬æ©Ÿè¨˜éŒ„ã€‚ä¸Šéˆå¾Œå¯æ¥ KUFO / å›æ”¶åœ°å€æ±ºå®šé‚„é¡˜èˆ‡å¸­ä½ã€‚</div>
      <div class="hr"></div>
      <div class="sub">ä»Šæ—¥è¨±é¡˜ï¼š<span class="mono" id="wishCount">0</span></div>
      <div class="hr"></div>
      <div class="k">é¸æ“‡å®ˆè­·ä»™å¥³</div>
      <select id="wishSelect"></select>
      <div class="k" style="margin-top:8px">é¡˜æœ›å…§å®¹ï¼ˆä¸è¦ç•™å€‹è³‡ï¼‰</div>
      <textarea id="wishText" placeholder="å¯«ä¸‹ä½ çš„é¡˜æœ›..."></textarea>
      <div class="k" style="margin-top:8px">èª“è¨€ï¼ˆé¸å¡«ï¼‰</div>
      <input id="wishOath" placeholder="æˆ‘é¡˜æ„..."/>
      <div class="grid2" style="margin-top:10px">
        <button class="btn acc" id="btnWishSubmit">æŠ•ä¸‹è¨±é¡˜</button>
        <button class="btn" id="btnWishExport">åŒ¯å‡ºè¨±é¡˜ JSON</button>
      </div>
      <div class="hr"></div>
      <div class="mono" id="wishEcho">é¸å¥½ä»™å¥³ï¼Œå¯«ä¸‹é¡˜æœ›ï¼ŒæŒ‰ä¸‹ã€ŒæŠ•ä¸‹è¨±é¡˜ã€ã€‚</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="h">ğŸ•¯ï¸ 12 ç”Ÿè‚–å…‰æ˜ç‡ˆï¼ˆæ¯ç”Ÿè‚– 72 åï¼‰ï¼‹ç¬¬13è‚–ï¼ˆä»»æ„ç‰©ç¨®ï¼‰</div>
    <div class="sub">é€™æ˜¯ã€Œå»Ÿçš„æœ‰é™é¡ã€ç©æ³•ï¼š12Ã—72 = 864 ç›ã€‚ç¬¬ 13 è‚–æ˜¯æ“´å……æ§½ï¼šä»»æ„ç‰©ç¨®ï¼ˆè®Šå½¢é‡‘å‰›ã€å¤§è±¡ã€èŸ»äººã€å¤–æ˜Ÿäººã€å­«æ‚Ÿç©ºçŒ´æ¯›â€¦ï¼‰ã€‚</div>
    <div class="hr"></div>
    <div class="grid2">
      <button class="btn" id="btnLampInit">åˆå§‹åŒ–åå†Š</button>
      <button class="btn" id="btnLampExport">åŒ¯å‡ºåå†Š JSON</button>
    </div>
    <div class="hr"></div>
    <div class="grid2">
      <div>
        <div class="k">é¸æ“‡ç”Ÿè‚–/ç¬¬13è‚–</div>
        <select id="lampZodiac"></select>
      </div>
      <div>
        <div class="k">ä½ çš„åå­—ï¼ˆä¸è¦ç•™å€‹è³‡ï¼‰</div>
        <input id="lampName" placeholder="ä¾‹å¦‚ï¼šå·§é›²"/>
      </div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <div>
        <div class="k">ç¬¬13è‚–ç‰©ç¨®ï¼ˆé¸å¡«ï¼‰</div>
        <input id="lampSpecies" placeholder="ä¾‹å¦‚ï¼šè®Šå½¢é‡‘å‰› / å¤§è±¡ / çŒ¿äºº / çŒ´æ¯›..."/>
      </div>
      <div>
        <div class="k">å¹´æœŸï¼ˆé è¨­ 1 å¹´ï¼‰</div>
        <select id="lampTerm">
          <option value="365">365 å¤©</option>
          <option value="30">30 å¤©ï¼ˆæ¸¬è©¦ï¼‰</option>
          <option value="500">500 å¤©ï¼ˆäº”æŒ‡å±±ï¼‰</option>
        </select>
      </div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <button class="btn acc" id="btnLampRegister">é»ç‡ˆç™»è¨˜</button>
      <button class="btn bad" id="btnLampClear">æ¸…é™¤åå†Šï¼ˆæœ¬æ©Ÿï¼‰</button>
    </div>
    <div class="hr"></div>
    <div class="mono" id="lampStats">å°šæœªåˆå§‹åŒ–</div>
    <pre class="mono" id="lampPreview">ï¼ˆå°šç„¡è³‡æ–™ï¼‰</pre>
  </div>

  <div class="row" style="margin-top:12px">
    <div class="card">
      <div class="h">ğŸ§¬ å®‡å®™ç´°åŒ…ï¼ˆMicrocell Shopï¼‰</div>
      <div class="sub">è®“ä¿¡çœ¾å»ºç«‹è‡ªå·±çš„ KGEN ç´°åŒ…å•†åº—ï¼šä»˜æ¬¾è·¯ç”±å¯é¸ KUFO / å…¬ç›Šåœ‹åº« / å›æ”¶ R1~R3ã€‚é€™åªæ˜¯æœ¬æ©ŸåŸå‹ï¼Œç­‰åˆç´„ä¸Šéˆå†æ¥ã€‚</div>
      <div class="hr"></div>
      <div class="grid2">
        <div><div class="k">ç´°åŒ…åç¨±</div><input id="mcName" placeholder="ä¾‹å¦‚ï¼šèŠ±æœå±±æœé£¾åº—"/></div>
        <div><div class="k">åˆ†é¡</div><input id="mcCategory" placeholder="æœé£¾ / é¤é£² / å¿ƒè‡Ÿç´…åˆ©..."/></div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <div><div class="k">ç‰©ç¨®ï¼ˆä»»æ„ï¼‰</div><input id="mcSpecies" placeholder="äººé¡ / è®Šå½¢é‡‘å‰› / å¤§è±¡..."/></div>
        <div><div class="k">åº§æ¨™ï¼ˆå¯å¡« 8888/11520/18888 æˆ–è‡ªå®šï¼‰</div><input id="mcLoc" placeholder="ä¾‹å¦‚ï¼š11520"/></div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <div><div class="k">ç´…åˆ©ï¼ˆbpsï¼Œä¾‹ 888=8.88%ï¼‰</div><input id="mcBps" placeholder="ä¾‹å¦‚ï¼š888"/></div>
        <div><div class="k">ä»˜æ¬¾è·¯ç”±</div>
          <select id="mcRoute">
            <option value="KUFO">KUFO ç„¡äººéŠ€è¡Œ</option>
            <option value="PG">å…¬ç›Šåœ‹åº«</option>
            <option value="R1">å›æ”¶ R1</option>
            <option value="R2">å›æ”¶ R2</option>
            <option value="R3">å›æ”¶ R3</option>
          </select>
        </div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <button class="btn acc" id="btnMcCreate">å»ºç«‹ç´°åŒ…</button>
        <button class="btn" id="btnMcExport">åŒ¯å‡ºç´°åŒ… JSON</button>
      </div>
      <div class="hr"></div>
      <div class="mono" id="mcStats">ç´°åŒ…ï¼š0</div>
      <pre class="mono" id="mcList">ï¼ˆå°šç„¡ç´°åŒ…ï¼‰</pre>
      <button class="btn bad" id="btnMcClear" style="margin-top:10px">æ¸…é™¤ç´°åŒ…ï¼ˆæœ¬æ©Ÿï¼‰</button>
    </div>

    <div class="card">
      <div class="h">ğŸ­ ç”Ÿå‘½å·¥å» ï¼ˆLife Factoryï½œå®‡å®™ç´°èƒèª•ç”Ÿï¼‰</div>
      <div class="sub">å®Œæˆæµç¨‹ï¼ˆé»ç‡ˆ/è¨±é¡˜/æ“²ç­Š/é‚„é¡˜ï¼‰å¾Œå¯ç”Ÿæˆã€Œç”Ÿå‘½è—åœ– JSONã€ã€‚ä¸Šéˆç‰ˆæœ¬å¯ç”± KUFO / Faucet é©—è­‰æ¢ä»¶ã€‚</div>
      <div class="hr"></div>
      <div class="grid2">
        <div><div class="k">ç”Ÿå‘½åç¨±</div><input id="lfName" placeholder="ä¾‹å¦‚ï¼šè±¬å…«æˆ’ / æ–°äººé¡ / çŒ¿äºº"/></div>
        <div><div class="k">ç‰©ç¨®</div><input id="lfSpecies" placeholder="æœ‰æ©Ÿ/ç„¡æ©Ÿ/ä»»æ„"/></div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <div><div class="k">å‡ºç”Ÿåœ°ï¼ˆåº§æ¨™ï¼‰</div><input id="lfBirth" placeholder="ä¾‹å¦‚ï¼š8888 / 11520 / 18888"/></div>
        <div><div class="k">Pulsar å¿ƒç‡ï¼ˆHzï¼Œå¯çœŸå¯¦æˆ–è‡ªå®šï¼‰</div><input id="lfPulsar" placeholder="ä¾‹å¦‚ï¼š1.337"/></div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <button class="btn acc" id="btnLfMint">ç”Ÿæˆç”Ÿå‘½è—åœ–</button>
        <button class="btn" id="btnLfExport">åŒ¯å‡ºè—åœ– JSON</button>
      </div>
      <div class="hr"></div>
      <pre class="mono" id="lfOut">ï¼ˆå°šæœªç”Ÿæˆï¼‰</pre>
    </div>
  </div>

<section class="card" id="cardBrain">
  <h2>ğŸ§  æ‚Ÿç©ºå¤§è…¦ï½œWukong Brain Engineï¼ˆWBEï¼‰</h2>
  <div class="muted">
    é€™æ˜¯ã€Œè…¦åŠ›é–‹ç™¼å‹Ÿè³‡æ± ã€çš„æœ¬æ©ŸåŸå‹ã€‚å…ˆä¸æ‰¿è«¾åˆ†æ½¤ï¼Œä¸ç¢°æŠ•è³‡å®£å‘Šã€‚
    ä½ å¯æŠŠå®‡å®™ç´°åŒ…ã€è¨±é¡˜ã€å…‰æ˜ç‡ˆã€ç™¼è²¡é‡‘å›æ”¶å°æµåˆ°é€™è£¡ï¼Œç­‰ä¸Šéˆå¾Œå†æ¥åˆç´„ã€‚
  </div>

  <div class="grid2">
    <div>
      <div><b>è…¦å®¹é‡ä¸Šé™ï¼ˆCapï¼‰</b></div>
      <div class="row">
        <input id="brainCap" value="50000000" />
        <button id="btnBrainSetCap">ä¿å­˜ Cap</button>
      </div>
      <div class="muted">å–®ä½ï¼šKGENï¼ˆæ¦‚å¿µå®¹é‡ï¼‰ã€‚</div>
    </div>

    <div>
      <div><b>ç›®å‰ç´¯ç©ï¼ˆæœ¬æ©Ÿï¼‰</b></div>
      <div id="brainProgressText">0 / 50,000,000</div>
      <progress id="brainProgress" value="0" max="50000000" style="width:100%"></progress>
      <div class="muted">ä¸Šéˆå¾Œæœƒæ”¹è®€åˆç´„ç‹€æ…‹ï¼›ç¾åœ¨å…ˆåšåŸå‹é©—æ”¶ã€‚</div>
    </div>
  </div>

  <hr/>

  <h3>å­˜å…¥è·¯ç”±ï¼ˆå°æµé¸æ“‡ï¼‰</h3>
  <div class="row">
    <select id="brainRoute">
      <option value="KUFO">KUFO ç„¡äººéŠ€è¡Œ</option>
      <option value="R1">ç™¼è²¡é‡‘å›æ”¶åœ°å€ R1</option>
      <option value="R2">ç™¼è²¡é‡‘å›æ”¶åœ°å€ R2</option>
      <option value="R3">ç™¼è²¡é‡‘å›æ”¶åœ°å€ R3</option>
      <option value="PG">å…¬ç›Šé‡‘åº« Public Good</option>
      <option value="ANY">ä»»æ„åœ°å€ï¼ˆè‡ªç”±è¼¸å…¥ï¼‰</option>
    </select>
    <input id="brainAnyAddress" placeholder="è‹¥é¸ä»»æ„åœ°å€ï¼Œåœ¨æ­¤å¡« 0x..." />
  </div>

  <div class="row">
    <input id="brainAmount" placeholder="è¦å­˜å…¥çš„ KGENï¼ˆæœ¬æ©Ÿè¨˜å¸³ï¼‰" />
    <button id="btnBrainDeposit">å­˜å…¥ï¼ˆæœ¬æ©Ÿï¼‰</button>
    <button id="btnBrainExport">åŒ¯å‡º Brain JSON</button>
    <button id="btnBrainClear">æ¸…é™¤ Brainï¼ˆæœ¬æ©Ÿï¼‰</button>
  </div>

  <div class="muted" id="brainRouteResolved"></div>

  <hr/>

  <h3>Kline App Gameï½œè§’åº¦åˆ¤å®šï¼ˆ0â€“170 å¤šï½œ170â€“190 ä¼‘ï½œ190â€“360 ç©ºï¼‰</h3>
  <div class="row">
    <input id="gameAngle" placeholder="è¼¸å…¥è§’åº¦ 0~360" />
    <button id="btnGameJudge">åˆ¤å®š</button>
    <button id="btnGamePing">å®ï¼ˆæ¸¬è©¦ï¼‰</button>
  </div>
  <div id="gameJudgeResult" class="muted">å°šæœªåˆ¤å®šã€‚</div>

</section>

  <div class="card" style="margin-top:12px">
    <div class="h">ğŸ“œ å“ç‰Œå›ºå®šå°¾æ®µ</div>
    <div class="sub">PrimeForge ä»¥æ¯æ©Ÿä¹‹åï¼Œé–‹å•Ÿé‡‘èç”Ÿå‘½ã€‚èŠ±æœå±±å°ç£ãƒ»ä¿¡å¿µä¸æ»…ãƒ»å¸‚å ´ç„¡ç•Œã€‚Where the Market Becomes the Myth.â€”â€” æ¨‚å¤©å¸ âŒ–</div>
  </div>

// ==============================
// SoundBus (single exit)
// - Fix: wukongSound is not defined
// - Any module should call SoundBus.play()
// ==============================
window.SoundBus = (function(){
  let mode = 'auto'; // auto | tts | beep | off
  let lastTTS = 0;

  function log(msg){ try{ dbg(msg); }catch(e){} }

  function hasTTS(){
    try { return !!window.speechSynthesis && typeof SpeechSynthesisUtterance !== 'undefined'; }
    catch(e){ return false; }
  }

  function beep(){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.frequency.value = 880;
      o.connect(g); g.connect(ctx.destination);
      g.gain.value = 0.08;
      o.start();
      setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
      return true;
    }catch(e){
      return false;
    }
  }

  function tts(text){
    try{
      if(!hasTTS()) return false;
      // avoid spam overlap
      const now = Date.now();
      if(now - lastTTS < 350) return true;
      lastTTS = now;

      const u = new SpeechSynthesisUtterance(text || 'OK');
      u.lang = 'zh-TW';
      u.rate = 1.0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
      return true;
    }catch(e){
      return false;
    }
  }

  function play(text){
    const m = mode;
    if(m === 'off') return;
    if(m === 'tts'){
      if(!tts(text)) beep();
      return;
    }
    if(m === 'beep'){ beep(); return; }
    // auto
    if(hasTTS()) { tts(text); }
    else { beep(); }
  }

  function setMode(m){
    mode = m || 'auto';
    log('sound_mode=' + mode);
  }

  function getMode(){ return mode; }

  return { play, setMode, getMode, hasTTS };
})();


// ==============================
// Config patch: add cfgKgenToken + cfgBrain
// ==============================
(function(){
  try{
    const _read = window.readCfgFromUI;
    const _apply = window.applyCfgToUI;

    window.readCfgFromUI = function(){
      const cfg = _read ? _read() : {};
      cfg.kgenToken = (document.getElementById('cfgKgenToken')?.value || '').trim();
      cfg.brain = (document.getElementById('cfgBrain')?.value || '').trim();
      return cfg;
    };

    window.applyCfgToUI = function(cfg){
      if(_apply) _apply(cfg);
      if(cfg){
        const a = document.getElementById('cfgKgenToken'); if(a) a.value = cfg.kgenToken || '';
        const b = document.getElementById('cfgBrain'); if(b) b.value = cfg.brain || '';
      }
    };
  }catch(e){}
})();


// ==============================
// BrainEngine (local prototype)
// - Cap default 50,000,000
// - Route: KUFO / R1/2/3 / PG / ANY
// - Deposit: local ledger (no chain promise)
// ==============================
window.BrainEngine = (function(){
  const KEY = 'wukong_brain_v1';
  const CAP_KEY = 'wukong_brain_cap_v1';

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return { total: 0, items: [] };
      const obj = JSON.parse(raw);
      if(!obj || typeof obj.total !== 'number' || !Array.isArray(obj.items)) return { total: 0, items: [] };
      return obj;
    }catch(e){
      return { total: 0, items: [] };
    }
  }

  function save(obj){
    try{ localStorage.setItem(KEY, JSON.stringify(obj)); }catch(e){}
  }

  function loadCap(){
    try{
      const raw = localStorage.getItem(CAP_KEY);
      const n = raw ? Number(raw) : 50000000;
      return Number.isFinite(n) && n > 0 ? n : 50000000;
    }catch(e){
      return 50000000;
    }
  }

  function saveCap(n){
    try{ localStorage.setItem(CAP_KEY, String(n)); }catch(e){}
  }

  function resolveRoute(cfg){
    const route = (document.getElementById('brainRoute')?.value || '').trim();
    const any = (document.getElementById('brainAnyAddress')?.value || '').trim();
    if(route === 'KUFO') return cfg.kufo || '';
    if(route === 'R1') return cfg.recycle1 || '';
    if(route === 'R2') return cfg.recycle2 || '';
    if(route === 'R3') return cfg.recycle3 || '';
    if(route === 'PG') return (window.STATE?.publicGood) || '';
    if(route === 'ANY') return any;
    return '';
  }

  function render(){
    const capEl = document.getElementById('brainCap');
    const prog = document.getElementById('brainProgress');
    const txt = document.getElementById('brainProgressText');
    const resolved = document.getElementById('brainRouteResolved');

    const cfg = window.loadCfg ? window.loadCfg() : {};
    const cap = loadCap();
    const st = load();

    if(capEl) capEl.value = String(cap);
    if(prog){
      prog.max = cap;
      prog.value = Math.max(0, Math.min(cap, st.total));
    }
    if(txt){
      txt.textContent = `${st.total.toLocaleString()} / ${cap.toLocaleString()} KGEN`;
    }
    if(resolved){
      const addr = resolveRoute(cfg);
      resolved.textContent = addr ? (`è·¯ç”±åœ°å€ï¼š${addr}`) : 'è·¯ç”±åœ°å€ï¼šå°šæœªè¨­å®šï¼ˆæˆ–é¸äº†ä»»æ„åœ°å€ä½†æœªå¡«ï¼‰';
    }
  }

  function deposit(){
    const cfg = window.loadCfg ? window.loadCfg() : {};
    const cap = loadCap();
    const st = load();
    const amt = Number((document.getElementById('brainAmount')?.value || '').trim());
    const addr = resolveRoute(cfg);

    if(!Number.isFinite(amt) || amt <= 0){
      SoundBus.play('é‡‘é¡éŒ¯èª¤');
      try{ dbg('brain_deposit_fail amount'); }catch(e){}
      return;
    }
    if(st.total + amt > cap){
      SoundBus.play('è¶…éè…¦å®¹é‡ä¸Šé™');
      try{ dbg('brain_deposit_fail cap'); }catch(e){}
      return;
    }
    st.total += amt;
    st.items.push({
      ts: new Date().toISOString(),
      amount: amt,
      route: (document.getElementById('brainRoute')?.value || '').trim(),
      to: addr || ''
    });
    save(st);
    try{ dbg('brain_deposit ' + amt); }catch(e){}
    SoundBus.play('å­˜å…¥æˆåŠŸ');
    render();
  }

  function exportJSON(){
    const st = load();
    const payload = {
      boot_version: (window.BOOT_VERSION || 'unknown'),
      ts: new Date().toISOString(),
      cap: loadCap(),
      brain: st
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `wukong_brain_${Date.now()}.json`;
    a.click();
    try{ dbg('export_brain_json'); }catch(e){}
    SoundBus.play('åŒ¯å‡ºå®Œæˆ');
  }

  function clearAll(){
    try{ localStorage.removeItem(KEY); }catch(e){}
    try{ dbg('brain_cleared'); }catch(e){}
    SoundBus.play('å·²æ¸…é™¤');
    render();
  }

  function bindUI(){
    const setCap = document.getElementById('btnBrainSetCap');
    const dep = document.getElementById('btnBrainDeposit');
    const exp = document.getElementById('btnBrainExport');
    const clr = document.getElementById('btnBrainClear');
    const routeSel = document.getElementById('brainRoute');
    const anyAddr = document.getElementById('brainAnyAddress');

    if(setCap){
      setCap.addEventListener('click', ()=>{
        const n = Number((document.getElementById('brainCap')?.value || '').trim());
        if(!Number.isFinite(n) || n <= 0){
          SoundBus.play('Cap éŒ¯èª¤');
          return;
        }
        saveCap(Math.floor(n));
        try{ dbg('brain_cap_saved'); }catch(e){}
        SoundBus.play('Cap å·²ä¿å­˜');
        render();
      });
    }
    if(dep) dep.addEventListener('click', deposit);
    if(exp) exp.addEventListener('click', exportJSON);
    if(clr) clr.addEventListener('click', clearAll);
    if(routeSel) routeSel.addEventListener('change', render);
    if(anyAddr) anyAddr.addEventListener('input', render);
  }

  function init(){
    bindUI();
    render();
  }

  return { init, render };
})();


// ==============================
// Kline App Game Angle Judge
// 0-170 LONG, 170-190 REST, 190-360 SHORT
// ==============================
window.GameAngle = (function(){
  function norm(a){
    let x = Number(a);
    if(!Number.isFinite(x)) return null;
    x = x % 360;
    if(x < 0) x += 360;
    return x;
  }

  function judge(angle){
    const a = norm(angle);
    if(a === null) return { ok:false, msg:'è§’åº¦éŒ¯èª¤' };
    if(a >= 0 && a < 170) return { ok:true, zone:'LONG', msg:`è§’åº¦ ${a.toFixed(2)}ï¼šåšå¤šå€ï¼ˆ0â€“170ï¼‰` };
    if(a >= 170 && a < 190) return { ok:true, zone:'REST', msg:`è§’åº¦ ${a.toFixed(2)}ï¼šä¼‘æ¯å€ï¼ˆ170â€“190ï¼‰` };
    return { ok:true, zone:'SHORT', msg:`è§’åº¦ ${a.toFixed(2)}ï¼šåšç©ºå€ï¼ˆ190â€“360ï¼‰` };
  }

  function bindUI(){
    const btn = document.getElementById('btnGameJudge');
    const ping = document.getElementById('btnGamePing');
    if(btn){
      btn.addEventListener('click', ()=>{
        const val = document.getElementById('gameAngle')?.value;
        const r = judge(val);
        const out = document.getElementById('gameJudgeResult');
        if(out) out.textContent = r.ok ? r.msg : r.msg;
        SoundBus.play(r.ok ? r.zone : 'éŒ¯èª¤');
        try{ dbg('game_judge ' + (r.zone||'fail')); }catch(e){}
      });
    }
    if(ping){
      ping.addEventListener('click', ()=>{
        SoundBus.play('å®');
        try{ dbg('game_ping'); }catch(e){}
      });
    }
  }

  function init(){ bindUI(); }

  return { init, judge };
})();


// ==============================
// Auto-init hooks (safe)
// ==============================
(function(){
  // call after existing boot
  try{
    const _oldBoot = window.boot;
    if(typeof _oldBoot === 'function'){
      window.boot = function(){
        _oldBoot();
        try{ BrainEngine.init(); }catch(e){}
        try{ GameAngle.init(); }catch(e){}
      };
    }else{
      // if no boot, init on DOMContentLoaded
      document.addEventListener('DOMContentLoaded', ()=>{
        try{ BrainEngine.init(); }catch(e){}
        try{ GameAngle.init(); }catch(e){}
      });
    }
  }catch(e){}
})();

  <div class="card" style="margin-top:12px">
    <details open>
      <summary>Debug Console</summary>
      <div class="hr"></div>
      <div class="grid3">
        <button class="btn" id="btnLogSelfcheck">Selfcheck</button>
        <button class="btn" id="btnLogClear">Clear</button>
        <button class="btn" id="btnLogCopy">Copy</button>
      </div>
      <pre class="mono" id="logBox" style="margin-top:10px">ï¼ˆå°šç„¡ç´€éŒ„ï¼‰</pre>
    </details>
  </div>
</div>

<script>
(function(){
  'use strict';
  const BOOT_VERSION = "v3.0.0-modular";
  const NOW_ISO = () => new Date().toISOString();

  const Log = (function(){
    const KEY = 'wukong_log_v1';
    const box = () => document.getElementById('logBox');
    function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch(e){ return []; } }
    function save(arr){ try{ localStorage.setItem(KEY, JSON.stringify(arr.slice(-800))); }catch(e){} }
    function line(msg){
      const arr = load();
      const s = `[${NOW_ISO()}] ${msg}`;
      arr.push(s);
      save(arr);
      const el = box();
      if(el) el.textContent = arr.join('\n');
    }
    function clear(){ save([]); const el=box(); if(el) el.textContent='ï¼ˆå·²æ¸…é™¤ï¼‰'; line('log_cleared'); }
    function render(){ const el=box(); if(!el) return; el.textContent = load().join('\n') || 'ï¼ˆå°šç„¡ç´€éŒ„ï¼‰'; }
    function copy(){
      const txt = load().join('\n');
      navigator.clipboard?.writeText(txt).then(()=>line('log_copied')).catch(()=>line('log_copy_failed'));
    }
    return { line, clear, render, copy };
  })();

  const U = { qs:(id)=>document.getElementById(id), clamp:(n,a,b)=>Math.max(a,Math.min(b,n)) };

  const Sound = (function(){
    let ctx = null;
    const modeEl = () => U.qs('soundMode');
    function hasTTS(){ return !!window.speechSynthesis; }
    function beep(){
      try{
        ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 880; g.gain.value = 0.001;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        g.gain.exponentialRampToValueAtTime(0.15, ctx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.18);
        o.stop(ctx.currentTime + 0.2);
      }catch(e){ Log.line('beep_fail ' + (e?.message||e)); }
    }
    function tts(text){
      try{
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-TW'; u.rate = 1.02;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      }catch(e){ Log.line('tts_fail ' + (e?.message||e)); }
    }
    function speak(text){
      const mode = (modeEl()?.value)||'auto';
      if(mode==='off') return;
      if(mode==='beep') return beep();
      if(mode==='tts') return hasTTS() ? tts(text) : beep();
      return hasTTS() ? tts(text) : beep();
    }
    function test(){ Log.line('sound_test'); speak('æ‚Ÿç©ºè²¡ç¥æ®¿ï¼Œè²éŸ³æ¸¬è©¦ã€‚'); }
    function init(){
      const m = localStorage.getItem('wukong_sound_mode_v1');
      if(m && modeEl()) modeEl().value = m;
      modeEl()?.addEventListener('change', ()=>{
        const v = modeEl().value;
        localStorage.setItem('wukong_sound_mode_v1', v);
        Log.line('sound_mode=' + v);
      });
      U.qs('btnSoundTest')?.addEventListener('click', test);
    }
    window.wukongSound = speak; window.wukongSpeak = speak;
    return { speak, init };
  })();

  const Cfg = (function(){
    const KEY='wukong_cfg_v2';
    function load(){ try{ const d=JSON.parse(localStorage.getItem(KEY)||'{}'); return (d&&typeof d==='object')?d:{}; }catch(e){ return {}; } }
    function save(d){ try{ localStorage.setItem(KEY, JSON.stringify(d)); }catch(e){} }
    function applyToUI(d){
      U.qs('cfgFaucet').value = d.faucet||'';
      U.qs('cfgKufo').value = d.kufo||'';
      U.qs('cfgR1').value = d.recycle1||'';
      U.qs('cfgR2').value = d.recycle2||'';
      U.qs('cfgR3').value = d.recycle3||'';
      if(d.publicGood) U.qs('cfgPG').value = d.publicGood;
    }
    function readFromUI(){
      return {
        faucet: (U.qs('cfgFaucet').value||'').trim(),
        kufo: (U.qs('cfgKufo').value||'').trim(),
        recycle1: (U.qs('cfgR1').value||'').trim(),
        recycle2: (U.qs('cfgR2').value||'').trim(),
        recycle3: (U.qs('cfgR3').value||'').trim(),
        publicGood: (U.qs('cfgPG').value||'').trim(),
      };
    }
    function init(){
      const d=load(); applyToUI(d);
      U.qs('btnCfgSave')?.addEventListener('click', ()=>{ save(readFromUI()); Log.line('cfg_saved'); Sound.speak('è¨­å®šå·²ä¿å­˜ã€‚'); });
      U.qs('btnCfgClear')?.addEventListener('click', ()=>{ save({}); applyToUI({}); Log.line('cfg_cleared'); Sound.speak('è¨­å®šå·²æ¸…é™¤ã€‚'); });
      return d;
    }
    return { load, init };
  })();

  const Ethers = (function(){
    function loadOnce(){ return new Promise((resolve)=>{ if(window.ethers) return resolve(true);
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js';
      s.onload=()=>resolve(!!window.ethers); s.onerror=()=>resolve(false);
      document.head.appendChild(s);
    });}
    async function ensure(){ if(window.ethers) return true; Log.line('ethers_load_attempt'); const ok=await loadOnce(); Log.line('ethers_loaded_after: '+ok); return ok; }
    return { ensure };
  })();

  const Wallet = (function(){
    const st={addr:'',chain:''};
    function setUI(){ U.qs('walletAddr').textContent=st.addr||'(not connected)'; U.qs('chainId').textContent=st.chain||'(unknown)'; }
    async function connect(){
      await Ethers.ensure();
      const eth=window.ethereum;
      if(!eth){ Log.line('wallet_connect_failed: no ethereum'); Sound.speak('æ²’æœ‰åµæ¸¬åˆ°éŒ¢åŒ…æ³¨å…¥ã€‚'); return; }
      try{
        const accs=await eth.request({method:'eth_requestAccounts'});
        st.addr=(accs&&accs[0])?accs[0].toLowerCase():'';
        st.chain=await eth.request({method:'eth_chainId'});
        setUI(); Log.line('wallet_connected='+st.addr); Sound.speak('éŒ¢åŒ…å·²é€£ç·šã€‚');
      }catch(e){ Log.line('wallet_connect_failed: '+(e?.message||e)); }
    }
    function disconnectUI(){ st.addr=''; st.chain=''; setUI(); Log.line('wallet_ui_disconnected'); }
    function bindEvents(){
      const eth=window.ethereum; if(!eth) return;
      eth.on?.('accountsChanged',(a)=>{ st.addr=(a&&a[0])?a[0].toLowerCase():''; Log.line('accountsChanged='+(st.addr||'(empty)')); setUI(); });
      eth.on?.('chainChanged',(c)=>{ st.chain=c; Log.line('chainChanged='+c); setUI(); });
    }
    function init(){ U.qs('btnConnect')?.addEventListener('click',connect); U.qs('btnDisconnect')?.addEventListener('click',disconnectUI); bindEvents(); setUI(); }
    return { init, state:st };
  })();

  const Vitals = (function(){
    const KEY='wukong_vitals_v1'; const S={cupStreak:0};
    function load(){ try{ const d=JSON.parse(localStorage.getItem(KEY)||'{}'); if(d&&typeof d==='object') S.cupStreak=d.cupStreak||0; }catch(e){} U.qs('cupStreak').textContent=String(S.cupStreak); }
    function save(){ try{ localStorage.setItem(KEY, JSON.stringify(S)); }catch(e){} }
    function heartbeat(){ Log.line('heartbeat'); Sound.speak('å¿ƒè·³ã€‚'); }
    function breath(){ Log.line('breath'); Sound.speak('å‘¼å¸ã€‚'); }
    function pressure(){ Log.line('pressure'); Sound.speak('è¡€å£“ã€‚'); }
    function cupThrow(){
      Log.line('cup_throw');
      const ok=Math.random()<0.5;
      if(ok){ S.cupStreak=Math.min(3,S.cupStreak+1); U.qs('cupResult').innerHTML='<span class="tagok">è–ç­Šï¼šæˆç«‹</span>'; Sound.speak('è–ç­Šæˆç«‹ã€‚'); }
      else { S.cupStreak=0; U.qs('cupResult').innerHTML='<span class="tagbad">è–ç­Šï¼šæœªæˆ</span>'; Sound.speak('æœªæˆã€‚'); }
      U.qs('cupStreak').textContent=String(S.cupStreak); save();
    }
    function fortune(){ Log.line('fortune_click'); if(S.cupStreak<3){ Sound.speak('è–ç­Šé€£å‹ä¸è¶³ä¸‰æ¬¡ã€‚'); return; } Sound.speak('å·²è§£é–ã€‚ç­‰å¾… Faucet ä¸Šéˆå¾Œå•Ÿç”¨ã€‚'); }
    function init(){ load(); U.qs('btnHeartbeat')?.addEventListener('click',heartbeat); U.qs('btnBreath')?.addEventListener('click',breath); U.qs('btnPressure')?.addEventListener('click',pressure); U.qs('btnCup')?.addEventListener('click',cupThrow); U.qs('btnFortune')?.addEventListener('click',fortune); }
    return { init };
  })();

  const Assistant = (function(){
    let rec=null;
    function setBox(t){ U.qs('assistantBox').textContent=t; }
    function start(){
      Log.line('assistant_start');
      const t='è¦å‰‡ï¼šè¨±é¡˜ä¸ç­‰æ–¼ä¿è­‰ã€‚ç™¼è²¡é‡‘æ˜¯å€Ÿä½ å»åšç”Ÿæ„çš„ç¦®ç‰©ï¼Œä¸æ˜¯å¼·ç´¢å›æ”¶ã€‚è‹¥è¦ä½é€²èŠ±æœå±±ç«æ˜Ÿé½Šå¤©è±ªå®…ï¼Œé–€æª»ç‚ºäº”åƒ KGEN é‚„é¡˜ï¼Œå¯¦éš›ä»¥ KUFO ç„¡äººéŠ€è¡Œåˆç´„ç‚ºæº–ã€‚';
      setBox('æ‚Ÿç©ºå®¢æœï¼š'+t);
      Sound.speak(t);
    }
    function sttStart(){
      const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!SR){ Log.line('stt_unavailable'); setBox('æ‚Ÿç©ºå®¢æœï¼šæ­¤è£ç½®ä¸æ”¯æ´èªéŸ³è¼¸å…¥ã€‚'); return; }
      if(rec){ try{ rec.stop(); }catch(e){} rec=null; }
      rec=new SR(); rec.lang='zh-TW'; rec.interimResults=false; rec.maxAlternatives=1;
      rec.onstart=()=>Log.line('stt_start');
      rec.onend=()=>Log.line('stt_stop');
      rec.onerror=(e)=>Log.line('stt_error '+(e?.error||e?.message||e));
      rec.onresult=(e)=>{ const txt=e.results?.[0]?.[0]?.transcript||''; Log.line('stt_text='+txt); setBox('ä½ èªªï¼š'+txt); Sound.speak('æˆ‘æ”¶åˆ°ã€‚'); };
      rec.start();
    }
    function sttStop(){ Log.line('stt_stop_btn'); try{ rec?.stop(); }catch(e){} rec=null; }
    function init(){ U.qs('btnAssistantStart')?.addEventListener('click',start); U.qs('btnSttStart')?.addEventListener('click',sttStart); U.qs('btnSttStop')?.addEventListener('click',sttStop); }
    return { init };
  })();

  const Fairies = (function(){
    const LIST=[
      {id:'f1', star:'å¤©æ¨', name:'å¤§ä»™å¥³ï¼ˆå·§é›²ï¼‰', point:14520, duty:'é¢¨èª¿é›¨é †', flow:'åšç©º'},
      {id:'f2', star:'å¤©ç’‡', name:'äºŒä»™å¥³ï¼ˆå·§è™¹ï¼‰', point:14866, duty:'å®¶åº­ç¾æ»¿', flow:'åšå¤š'},
      {id:'f3', star:'å¤©ç’£', name:'ä¸‰ä»™å¥³ï¼ˆå·§èŠï¼‰', point:16184, duty:'è‚²å­æ”¶é©š', flow:'åšç©º'},
      {id:'f4', star:'å¤©æ¬Š', name:'å››ä»™å¥³ï¼ˆå·§ä»™ï¼‰', point:16888, duty:'äº‹æ¥­é‹é€š', flow:'åšå¤š'},
      {id:'f5', star:'å¤©è¡¡', name:'äº”ä»™å¥³ï¼ˆå·§è˜­ï¼‰', point:17347, duty:'é•·å‘½ç™¾æ­²', flow:'åšç©º'},
      {id:'f6', star:'é—“é™½', name:'å…­ä»™å¥³ï¼ˆå·§æ¢…ï¼‰', point:18056, duty:'èº«é«”å¥åº·', flow:'åšå¤š'},
      {id:'f7', star:'ç‘¤å…‰', name:'ä¸ƒä»™å¥³ï¼ˆå·§éˆï¼‰', point:18459, duty:'æ„Ÿæƒ…åœ“æ»¿', flow:'å¤šå–®é€€'}
    ];
    const WKEY='wukong_wishpool_v1';
    function wishLoad(){ try{ return JSON.parse(localStorage.getItem(WKEY)||'[]')||[]; }catch(e){ return []; } }
    function wishSave(a){ try{ localStorage.setItem(WKEY, JSON.stringify(a.slice(-500))); }catch(e){} }
    function renderFairies(){
      const el=U.qs('fairyList'); if(!el) return;
      el.innerHTML='';
      LIST.forEach(f=>{
        const d=document.createElement('div'); d.className='card'; d.style.margin='10px 0';
        d.innerHTML=`<div class="h">â­ ${f.star}ï½œ${f.name}</div>
          <div class="sub">åº§æ¨™é»ï¼š<span class="mono">${f.point}</span>ã€€å°ˆæŒï¼š<b>${f.duty}</b>ã€€æ°£è„ˆï¼š<b>${f.flow}</b></div>
          <button class="btn" style="margin-top:10px">æŠ•å‘è¨±é¡˜æ± </button>`;
        d.querySelector('button')?.addEventListener('click', ()=>{ U.qs('wishSelect').value=f.id; Log.line('wish_route='+f.id); Sound.speak('å·²é¸æ“‡å®ˆè­·ä»™å¥³ã€‚'); });
        el.appendChild(d);
      });
    }
    function renderWishUI(){
      const sel=U.qs('wishSelect'); sel.innerHTML='';
      LIST.forEach(f=>{ const o=document.createElement('option'); o.value=f.id; o.textContent=`${f.star}ï½œ${f.name}ï½œ${f.duty}ï½œ${f.flow}ï½œ${f.point}`; sel.appendChild(o); });
      U.qs('wishCount').textContent=String(wishLoad().length);
    }
    function submitWish(){
      const who=U.qs('wishSelect').value;
      const txt=(U.qs('wishText').value||'').trim();
      const oath=(U.qs('wishOath').value||'').trim();
      if(!txt){ U.qs('wishEcho').textContent='è«‹å…ˆå¯«ä¸‹é¡˜æœ›å…§å®¹ã€‚'; Sound.speak('è«‹å…ˆå¯«ä¸‹é¡˜æœ›å…§å®¹ã€‚'); return; }
      const f=LIST.find(x=>x.id===who)||LIST[0];
      const a=wishLoad(); a.push({ts:NOW_ISO(), fairy:f, wish:txt, oath:oath}); wishSave(a);
      U.qs('wishCount').textContent=String(a.length);
      U.qs('wishEcho').textContent=`è¨±é¡˜å·²æŠ•ä¸‹ï¼š${f.name}ï½œ${f.duty}ã€‚`;
      Log.line('wish_submit'); Sound.speak('è¨±é¡˜å·²æŠ•ä¸‹ã€‚');
    }
    function exportWish(){
      const a=wishLoad();
      const blob=new Blob([JSON.stringify(a,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const link=document.createElement('a');
      link.href=url; link.download=`wishpool_${BOOT_VERSION}.json`; link.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000);
      Log.line('export_wish_json');
    }
    function init(){
      U.qs('btnLoadFairies')?.addEventListener('click', ()=>{ renderFairies(); renderWishUI(); Log.line('fairies_loaded_to_wishpool'); Sound.speak('ä¸ƒä»™å¥³å·²è¼‰å…¥ã€‚'); });
      U.qs('btnWishSubmit')?.addEventListener('click', submitWish);
      U.qs('btnWishExport')?.addEventListener('click', exportWish);
      renderWishUI();
    }
    return { init };
  })();

  const Lamps=(function(){
    const KEY='wukong_lamps_v1';
    const Z=['é¼ ','ç‰›','è™','å…”','é¾','è›‡','é¦¬','ç¾Š','çŒ´','é›','ç‹—','è±¬','ç¬¬13è‚–ï¼ˆä»»æ„ç‰©ç¨®ï¼‰'];
    function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'{}'); }catch(e){ return {}; } }
    function save(d){ try{ localStorage.setItem(KEY, JSON.stringify(d)); }catch(e){} }
    function initRoster(){
      const d={boot:BOOT_VERSION,ts:NOW_ISO(),slots:{}}; Z.forEach(z=>d.slots[z]=[]);
      save(d); Log.line('lamp_init'); Sound.speak('å…‰æ˜ç‡ˆåå†Šå·²åˆå§‹åŒ–ã€‚'); render();
    }
    function render(){
      const d=load(); const stats=U.qs('lampStats'); const prev=U.qs('lampPreview');
      if(!d.slots){ stats.textContent='å°šæœªåˆå§‹åŒ–'; prev.textContent='ï¼ˆå°šç„¡è³‡æ–™ï¼‰'; return; }
      let total=0; const lines=[];
      Z.forEach(z=>{
        const a=d.slots[z]||[]; total+=a.length; const cap=(z==='ç¬¬13è‚–ï¼ˆä»»æ„ç‰©ç¨®ï¼‰')?'âˆ':'72';
        lines.push(`${z}ï¼š${a.length} / ${cap}`);
        a.slice(-3).forEach(x=>lines.push(`  - ${x.name}ï½œterm=${x.termDays}dï½œexp=${x.exp}` + (x.species?`ï½œspecies=${x.species}`:'')));
      });
      stats.textContent=`å·²ç™»è¨˜ï¼š${total} ç›ï¼ˆ12Ã—72=864 + ç¬¬13è‚–æ“´å……ï¼‰`;
      prev.textContent=lines.join('\n');
    }
    function register(){
      const d=load(); if(!d.slots){ Sound.speak('è«‹å…ˆåˆå§‹åŒ–åå†Šã€‚'); return; }
      const z=U.qs('lampZodiac').value;
      const name=(U.qs('lampName').value||'').trim();
      const species=(U.qs('lampSpecies').value||'').trim();
      const termDays=parseInt(U.qs('lampTerm').value||'365',10);
      if(!name){ Sound.speak('è«‹å…ˆå¡«åå­—ã€‚'); return; }
      const a=d.slots[z]||[];
      if(z!=='ç¬¬13è‚–ï¼ˆä»»æ„ç‰©ç¨®ï¼‰' && a.length>=72){ Sound.speak('æ­¤ç”Ÿè‚–åé¡å·²æ»¿ã€‚'); return; }
      const exp=new Date(Date.now()+termDays*86400*1000).toISOString().slice(0,10);
      a.push({name, species: z==='ç¬¬13è‚–ï¼ˆä»»æ„ç‰©ç¨®ï¼‰'?species:'', termDays, exp, ts:NOW_ISO()});
      d.slots[z]=a; save(d); Log.line('lamp_register '+z); Sound.speak('é»ç‡ˆç™»è¨˜å®Œæˆã€‚'); render();
    }
    function exportJson(){
      const d=load(); const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const link=document.createElement('a');
      link.href=url; link.download=`lamps_${BOOT_VERSION}.json`; link.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000); Log.line('export_lamps_json');
    }
    function clear(){ localStorage.removeItem(KEY); Log.line('lamp_cleared'); Sound.speak('å…‰æ˜ç‡ˆåå†Šå·²æ¸…é™¤ã€‚'); render(); }
    function init(){
      const sel=U.qs('lampZodiac'); sel.innerHTML=''; Z.forEach(z=>{ const o=document.createElement('option'); o.value=z; o.textContent=z; sel.appendChild(o); });
      U.qs('btnLampInit')?.addEventListener('click',initRoster);
      U.qs('btnLampRegister')?.addEventListener('click',register);
      U.qs('btnLampExport')?.addEventListener('click',exportJson);
      U.qs('btnLampClear')?.addEventListener('click',clear);
      render();
    }
    return { init };
  })();

  const Microcell=(function(){
    const KEY='wukong_microcells_v1';
    function load(){ try{ const a=JSON.parse(localStorage.getItem(KEY)||'[]'); return Array.isArray(a)?a:[]; }catch(e){ return []; } }
    function save(a){ try{ localStorage.setItem(KEY, JSON.stringify(a.slice(-500))); }catch(e){} }
    function resolveRoute(route,cfg){
      if(route==='KUFO') return cfg.kufo||'';
      if(route==='PG') return cfg.publicGood||'';
      if(route==='R1') return cfg.recycle1||'';
      if(route==='R2') return cfg.recycle2||'';
      if(route==='R3') return cfg.recycle3||'';
      return '';
    }
    function render(cfg){
      const a=load(); U.qs('mcStats').textContent='ç´°åŒ…ï¼š'+a.length;
      if(a.length===0){ U.qs('mcList').textContent='ï¼ˆå°šç„¡ç´°åŒ…ï¼‰'; return; }
      const lines=a.slice().reverse().map(x=>{
        const pay=resolveRoute(x.route,cfg);
        return `â€¢ ${x.name}ï½œ${x.category||'-'}ï½œ${x.species||'-'}ï½œåº§æ¨™ ${x.location||'-'}ï½œreward ${x.rewardBps||0}bpsï½œ${x.route}` + (pay?` -> ${pay}`:'');
      });
      U.qs('mcList').textContent=lines.join('\n');
    }
    function create(cfg){
      const name=(U.qs('mcName').value||'').trim();
      const category=(U.qs('mcCategory').value||'').trim();
      const species=(U.qs('mcSpecies').value||'').trim();
      const location=(U.qs('mcLoc').value||'').trim();
      const rewardBps=parseInt((U.qs('mcBps').value||'0').trim(),10)||0;
      const route=U.qs('mcRoute').value;
      if(!name){ Sound.speak('è«‹å…ˆå¡«ç´°åŒ…åç¨±ã€‚'); return; }
      const a=load(); a.push({ts:NOW_ISO(),name,category,species,location,rewardBps:U.clamp(rewardBps,0,5000),route});
      save(a); Log.line('mc_create'); Sound.speak('ç´°åŒ…å·²å»ºç«‹ã€‚'); render(cfg);
    }
    function exportJson(){
      const a=load(); const blob=new Blob([JSON.stringify(a,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const link=document.createElement('a');
      link.href=url; link.download=`microcells_${BOOT_VERSION}.json`; link.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000); Log.line('export_microcells_json');
    }
    function clear(cfg){ localStorage.removeItem(KEY); Log.line('mc_cleared'); Sound.speak('ç´°åŒ…å·²æ¸…é™¤ã€‚'); render(cfg); }
    function init(cfg){
      U.qs('btnMcCreate')?.addEventListener('click',()=>create(cfg));
      U.qs('btnMcExport')?.addEventListener('click',exportJson);
      U.qs('btnMcClear')?.addEventListener('click',()=>clear(cfg));
      render(cfg);
    }
    return { init };
  })();

  const LifeFactory=(function(){
    const KEY='wukong_life_blueprints_v1';
    function load(){ try{ const a=JSON.parse(localStorage.getItem(KEY)||'[]'); return Array.isArray(a)?a:[]; }catch(e){ return []; } }
    function save(a){ try{ localStorage.setItem(KEY, JSON.stringify(a.slice(-200))); }catch(e){} }
    function make(){
      const name=(U.qs('lfName').value||'').trim();
      const species=(U.qs('lfSpecies').value||'').trim();
      const birth=(U.qs('lfBirth').value||'').trim();
      const pulsar=(U.qs('lfPulsar').value||'').trim();
      if(!name||!birth){ Sound.speak('è«‹å…ˆå¡«ç”Ÿå‘½åç¨±èˆ‡å‡ºç”Ÿåœ°ã€‚'); return null; }
      return { boot:BOOT_VERSION, ts:NOW_ISO(), name, species:species||'unspecified', birth, pulsarHz:pulsar||'auto',
        organs:{heart:'FaucetHeart',brain:'AutopilotBrain',bank:'KUFO',ufo:'KUFO-PocketTimeUFO'},
        rulesHint:{lamp72:true,wishpool:true,cup3:true,vow5000:true} };
    }
    function render(bp){ U.qs('lfOut').textContent=bp?JSON.stringify(bp,null,2):'ï¼ˆå°šæœªç”Ÿæˆï¼‰'; }
    function mint(){ const bp=make(); if(!bp) return; const a=load(); a.push(bp); save(a); render(bp); Log.line('life_blueprint_minted'); Sound.speak('ç”Ÿå‘½è—åœ–å·²ç”Ÿæˆã€‚'); }
    function exportJson(){
      const a=load(); const blob=new Blob([JSON.stringify(a,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const link=document.createElement('a');
      link.href=url; link.download=`life_blueprints_${BOOT_VERSION}.json`; link.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000); Log.line('export_life_json');
    }
    function init(){ U.qs('btnLfMint')?.addEventListener('click',mint); U.qs('btnLfExport')?.addEventListener('click',exportJson); render(null); }
    return { init };
  })();

  const State=(function(){
    function exportAll(){
      const payload={ boot:BOOT_VERSION, ts:NOW_ISO(), ua:navigator.userAgent,
        speechSynthesis:!!window.speechSynthesis, speechRecognition:!!(window.SpeechRecognition||window.webkitSpeechRecognition),
        ethers_loaded:!!window.ethers, ethereum_injected:!!window.ethereum, wallet:Wallet.state, cfg:Cfg.load() };
      const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const link=document.createElement('a');
      link.href=url; link.download=`wukong_state_${BOOT_VERSION}.json`; link.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000); Log.line('export_json');
    }
    function clearAll(){
      ['wukong_log_v1','wukong_cfg_v2','wukong_vitals_v1','wukong_wishpool_v1','wukong_lamps_v1','wukong_microcells_v1','wukong_life_blueprints_v1']
        .forEach(k=>localStorage.removeItem(k));
      Log.line('clear_state'); Sound.speak('æœ¬æ©Ÿç‹€æ…‹å·²æ¸…é™¤ã€‚'); location.reload();
    }
    function init(){ U.qs('btnExportState')?.addEventListener('click',exportAll); U.qs('btnClearState')?.addEventListener('click',clearAll); }
    return { init };
  })();

  async function selfcheck(){
    Log.line('boot_version='+BOOT_VERSION);
    Log.line('selfcheck_start');
    Log.line('userAgent: '+navigator.userAgent);
    Log.line('speechSynthesis: '+(!!window.speechSynthesis));
    Log.line('speechRecognition: '+(!!(window.SpeechRecognition||window.webkitSpeechRecognition)));
    const ethersOk=await Ethers.ensure();
    Log.line('ethers_loaded_now: '+ethersOk);
    Log.line('ethereum_injected_now: '+(!!window.ethereum));
    const pill=U.qs('envPill');
    if(pill){
      pill.textContent = `env: TTS=${!!window.speechSynthesis} | ETH=${!!window.ethereum} | ethers=${ethersOk}`;
    }
  }

  function bindDebugButtons(){
    U.qs('btnLogSelfcheck')?.addEventListener('click',selfcheck);
    U.qs('btnLogClear')?.addEventListener('click',()=>Log.clear());
    U.qs('btnLogCopy')?.addEventListener('click',()=>Log.copy());
  }

  function boot(){
    U.qs('bootVer').textContent=BOOT_VERSION;
    Log.render();
    bindDebugButtons();
    Sound.init();
    const cfg=Cfg.init();
    Wallet.init();
    Vitals.init();
    Assistant.init();
    Fairies.init();
    Lamps.init();
    Microcell.init(cfg);
    LifeFactory.init();
    State.init();
    selfcheck();
  }

  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',boot,{once:true}); }
  else { boot(); }
})();
</script>
</body>
</html>
