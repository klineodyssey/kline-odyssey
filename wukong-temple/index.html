<!-- =========================================================
悟空財神廟｜首頁介面（完成品單頁・可上線版）
File: /kline-odyssey/wukong-temple/index.html
Route: https://klineodyssey.github.io/kline-odyssey/wukong-temple/
Purpose: 入口頁（登入參拜→領書→領發財金→搏杯→燒幣還願→登出）
Brand: klineodyssey (統一英文品牌)
========================================================= -->

<div style="max-width:820px;margin:22px auto;padding:16px;">

  <!-- Brand Header -->
  <div style="margin-bottom:10px;">
    <div style="font-weight:900;font-size:24px;line-height:1.2;">
      悟空財神廟｜Wukong Temple
    </div>
    <div style="margin-top:8px;font-weight:900;">
      #悟空新文 #K線西遊記 #花果山台灣
    </div>
    <div style="margin-top:10px;">
      <a href="https://klineodyssey.github.io/kline-odyssey/"
         target="_blank" rel="noopener"
         style="text-decoration:none;font-weight:900;">
        https://klineodyssey.github.io/kline-odyssey/
      </a>
    </div>
  </div>

  <!-- One-sentence rule -->
  <div style="border:1px solid #111;border-radius:16px;padding:14px;background:#fff;margin:12px 0;">
    <div style="font-weight:900;">規則一句話</div>
    <div style="line-height:1.9;margin-top:8px;">
      這裡是互動式遊戲入口：參觀、選擇、體驗，然後離開。<br/>
      不承諾收益、不提供投資建議、不做回報保證。
    </div>
  </div>

  <!-- Status / Notice -->
  <div style="border:1px solid #111;border-radius:16px;padding:14px;background:#fff;margin:12px 0;">
    <div style="font-weight:900;">今日狀態</div>
    <div id="templeStatus" style="margin-top:8px;line-height:1.9;">
      系統開放。你可以開始參拜。
    </div>
  </div>

  <!-- Main Action Buttons -->
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin:14px 0;">

    <button onclick="enterTemple()"
       style="cursor:pointer;text-align:left;display:block;padding:14px 14px;border:1px solid #111;border-radius:16px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">登入參拜</div>
      <div style="opacity:.9;margin-top:6px;line-height:1.7;">
        確認存在 → 進入前庭（本頁內流程）
      </div>
    </button>

    <a href="/kline-odyssey/bookstore/"
       style="display:block;padding:14px 14px;border:1px solid #111;border-radius:16px;text-decoration:none;background:#fff;">
      <div style="font-weight:900;font-size:16px;">領書｜悟空書城</div>
      <div style="opacity:.9;margin-top:6px;line-height:1.7;">
        連結到書城／內容兌換
      </div>
    </a>

    <a href="https://pancakeswap.finance/swap?outputCurrency=0xBA3d3810e58735cb6813bC1CDc5458C0d71432Be"
       target="_blank" rel="noopener"
       style="display:block;padding:14px 14px;border:1px solid #111;border-radius:16px;text-decoration:none;background:#fff;">
      <div style="font-weight:900;font-size:16px;">領發財金前先看｜KGEN 交易入口</div>
      <div style="opacity:.9;margin-top:6px;line-height:1.7;">
        給你一個可流通的介面（不是紀念幣）
      </div>
    </a>

    <button onclick="openFortuneModal()"
       style="cursor:pointer;text-align:left;display:block;padding:14px 14px;border:1px solid #111;border-radius:16px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">領發財金（遊戲事件）</div>
      <div style="opacity:.9;margin-top:6px;line-height:1.7;">
        一次性事件｜同地址冷卻｜上限 888（下限 1）
      </div>
    </button>

    <button onclick="openDivinationModal()"
       style="cursor:pointer;text-align:left;display:block;padding:14px 14px;border:1px solid #111;border-radius:16px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">搏杯（聖筊連勝）</div>
      <div style="opacity:.9;margin-top:6px;line-height:1.7;">
        連續 N 次聖筊 → 觸發 2 的 N 次方獎階敘事
      </div>
    </button>

    <button onclick="openBurnModal()"
       style="cursor:pointer;text-align:left;display:block;padding:14px 14px;border:1px solid #111;border-radius:16px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">燒幣／還願（感恩與補油）</div>
      <div style="opacity:.9;margin-top:6px;line-height:1.7;">
        進引擎室：燃燒與補油｜公益與宇宙推進
      </div>
    </button>

    <button onclick="exitTemple()"
       style="cursor:pointer;text-align:left;display:block;padding:14px 14px;border:1px solid #111;border-radius:16px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">登出離開</div>
      <div style="opacity:.9;margin-top:6px;line-height:1.7;">
        結束參拜｜完成紀錄
      </div>
    </button>

  </div>

  <!-- KGEN / NTD / Mass Clarification -->
  <div style="border:1px solid #111;border-radius:16px;padding:14px;background:#fff;margin:14px 0;">
    <div style="font-weight:900;">KGEN、台幣與質量（一次說清楚）</div>
    <div style="margin-top:10px;line-height:1.95;">
      1) 本宇宙敘事中：KGEN 被視為「質量（Mass）」的象徵。並加入單位隱喻：1 KGEN = 1 Kg（公斤）。<br/>
      2) 內容兌換層（書城）：採用「定價等值」規則：例如書定價 168 元，就用 168 KGEN 兌換閱讀權或內容取得權。<br/>
      3) 這是創作內容兌換與遊戲敘事的計價方式，不構成投資、報酬或回購承諾。<br/>
      4) 物理式子為世界觀隱喻：E = m c^2 代表質能上限；W = m g h 代表質量在引力場中的位能變化。m 越小、要爬的 h 越高，難度越大；CT（現價）上升可視為高度上升。<br/>
      5) GA600 沖等：可把 KGEN 視為「宇宙存在成本」與「系統燃料」。沖等是玩法，不是保證；是否需要消耗由遊戲規則與版本決定（只升版不回溯）。
    </div>
  </div>

  <!-- AI Voice Service -->
  <div style="border:1px solid #111;border-radius:16px;padding:14px;background:#fff;margin:14px 0;">
    <div style="font-weight:900;">AI 語音客服（中文台詞｜可直接照唸）</div>
    <div style="margin-top:10px;line-height:1.95;">
      歡迎來到五指山悟空財神廟。<br/>
      這裡是互動式遊戲入口，不是投資平台。<br/><br/>
      你可以先領書，或先領發財金。<br/>
      發財金是一次性遊戲事件，同一地址有冷卻時間。<br/>
      上限八百八十八，下限一。<br/><br/>
      K G E N 在這裡代表質量與存在成本，也可用於內容兌換與遊戲燃料敘事。<br/>
      燒幣與還願代表感恩與轉換，用來補油推動引擎室，不是回報承諾。<br/><br/>
      想開始就按「登入參拜」。想離開就按「登出離開」。
    </div>

    <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:10px;">
      <button onclick="speakCN('歡迎來到五指山悟空財神廟。這裡是互動式遊戲入口，不是投資平台。你可以先領書，或先領發財金。發財金是一次性遊戲事件，同一地址有冷卻時間。上限八百八十八，下限一。K G E N 在這裡代表質量與存在成本，也可用於內容兌換與遊戲燃料敘事。燒幣與還願代表感恩與轉換，用來補油推動引擎室，不是回報承諾。想開始就按登入參拜。想離開就按登出離開。')"
              style="cursor:pointer;border:1px solid #111;border-radius:999px;background:#fff;padding:10px 14px;font-weight:900;">
        播放語音
      </button>
      <button onclick="stopSpeak()"
              style="cursor:pointer;border:1px solid #111;border-radius:999px;background:#fff;padding:10px 14px;font-weight:900;">
        停止語音
      </button>
      <div style="opacity:.8;line-height:1.6;">
        提示：若瀏覽器禁用自動播放，請先點一次「播放語音」。
      </div>
    </div>
  </div>

  <!-- Footer signature (固定章不變形：此處僅顯示文字，章符號 ⌖ 保留) -->
  <div style="margin-top:14px;padding-top:12px;border-top:1px solid #111;line-height:1.9;">
    PrimeForge 以母機之名，開啟金融生命。<br/>
    花果山台灣・信念不滅・市場無界。<br/>
    Where the Market Becomes the Myth.<br/>
    —— 樂天帝 ⌖
  </div>

</div>

<!-- =========================
MODALS
========================= -->
<div id="modalBackdrop" onclick="closeAllModals()"
     style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9998;"></div>

<div id="fortuneModal"
     style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
            width:min(92vw,760px);background:#fff;border:1px solid #111;border-radius:16px;
            padding:16px;z-index:9999;">
  <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
    <div style="font-weight:900;font-size:18px;">領發財金（一次性遊戲事件）</div>
    <button onclick="closeAllModals()"
            style="cursor:pointer;border:1px solid #111;border-radius:999px;background:#fff;padding:8px 12px;font-weight:900;">
      關閉
    </button>
  </div>

  <div style="margin-top:10px;line-height:1.95;">
    你要用哪個地址領取發財金事件？（三選一）<br/>
    同一地址會有冷卻時間。上限 888，下限 1。<br/>
    發財金給出即完成，不保留、不回收、不保證價值。
  </div>

  <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;">
    <button onclick="claimFortune('BURN_ENGINE')"
            style="cursor:pointer;text-align:left;border:1px solid #111;border-radius:16px;background:#fff;padding:12px 12px;">
      <div style="font-weight:900;">選擇一：Burn-Engine（領發財金）</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.7;">
        建議入口地址：burn-energy（你設定的領取核心）
      </div>
    </button>

    <button onclick="claimFortune('ENGINE_ROOM')"
            style="cursor:pointer;text-align:left;border:1px solid #111;border-radius:16px;background:#fff;padding:12px 12px;">
      <div style="font-weight:900;">選擇二：引擎室（補油與燃燒）</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.7;">
        接受感恩補油，用於推動 KUFO 引擎敘事
      </div>
    </button>

    <button onclick="claimFortune('PUBLIC_GOOD')"
            style="cursor:pointer;text-align:left;border:1px solid #111;border-radius:16px;background:#fff;padding:12px 12px;">
      <div style="font-weight:900;">選擇三：公益池（自由民主與震災）</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.7;">
        以感恩之名，流向社會公益用途敘事
      </div>
    </button>
  </div>

  <div id="fortuneResult"
       style="margin-top:12px;border:1px solid #111;border-radius:16px;padding:12px;display:none;background:#fff;">
  </div>
</div>

<div id="divinationModal"
     style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
            width:min(92vw,760px);background:#fff;border:1px solid #111;border-radius:16px;
            padding:16px;z-index:9999;">
  <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
    <div style="font-weight:900;font-size:18px;">搏杯（聖筊連勝玩法）</div>
    <button onclick="closeAllModals()"
            style="cursor:pointer;border:1px solid #111;border-radius:999px;background:#fff;padding:8px 12px;font-weight:900;">
      關閉
    </button>
  </div>

  <div style="margin-top:10px;line-height:1.95;">
    玩法概念：每一次判定只有兩種結果。<br/>
    連續 N 次聖筊 → 觸發 2 的 N 次方獎階敘事（不是收益保證，只是故事節奏）。<br/>
    你可以一直玩，但系統會記錄連勝與冷卻。
  </div>

  <div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
    <button onclick="castDivination()"
            style="cursor:pointer;border:1px solid #111;border-radius:999px;background:#fff;padding:10px 14px;font-weight:900;">
      丟筊
    </button>
    <button onclick="resetDivination()"
            style="cursor:pointer;border:1px solid #111;border-radius:999px;background:#fff;padding:10px 14px;font-weight:900;">
      重置連勝
    </button>
    <div style="opacity:.85;">連勝會記在本機瀏覽器（localStorage）。</div>
  </div>

  <div id="divinationResult"
       style="margin-top:12px;border:1px solid #111;border-radius:16px;padding:12px;background:#fff;line-height:1.9;">
    尚未丟筊。
  </div>
</div>

<div id="burnModal"
     style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
            width:min(92vw,760px);background:#fff;border:1px solid #111;border-radius:16px;
            padding:16px;z-index:9999;">
  <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
    <div style="font-weight:900;font-size:18px;">燒幣／還願（感恩與補油）</div>
    <button onclick="closeAllModals()"
            style="cursor:pointer;border:1px solid #111;border-radius:999px;background:#fff;padding:8px 12px;font-weight:900;">
      關閉
    </button>
  </div>

  <div style="margin-top:10px;line-height:1.95;">
    還願不是勒索燒，是感恩。<br/>
    在悟空財神廟敘事裡：燃燒與補油是「質量轉換」的儀式，用來推動引擎室與宇宙航行。<br/>
    你可以選擇一次性燒，或分次點香火慢慢燒（敘事玩法）。
  </div>

  <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;">
    <button onclick="burnTo('BLACKHOLE_0')"
            style="cursor:pointer;text-align:left;border:1px solid #111;border-radius:16px;background:#fff;padding:12px 12px;">
      <div style="font-weight:900;">黑洞燃燒（x0....00）</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.7;">
        一次性燃燒敘事入口（你指定的黑洞地址型態）
      </div>
    </button>

    <button onclick="burnTo('DEAD_0')"
            style="cursor:pointer;text-align:left;border:1px solid #111;border-radius:16px;background:#fff;padding:12px 12px;">
      <div style="font-weight:900;">黑洞燃燒（x0....dead）</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.7;">
        常見燃燒終點型態（dead）
      </div>
    </button>

    <button onclick="burnTo('ENGINE_ROOM')"
            style="cursor:pointer;text-align:left;border:1px solid #111;border-radius:16px;background:#fff;padding:12px 12px;">
      <div style="font-weight:900;">引擎室補油（感恩）</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.7;">
        把 KGEN 視為燃料敘事：補油推動 KUFO 前進
      </div>
    </button>
  </div>

  <div id="burnResult"
       style="margin-top:12px;border:1px solid #111;border-radius:16px;padding:12px;background:#fff;line-height:1.9;display:none;">
  </div>
</div>

<script>
  // ---------------------------
  // BASIC STATE (localStorage)
  // ---------------------------
  const LS = {
    entered: "WK_TEMPLE_ENTERED",
    lastClaim: "WK_TEMPLE_LAST_CLAIM_TS",
    lastClaimKey: "WK_TEMPLE_LAST_CLAIM_KEY",
    divStreak: "WK_TEMPLE_DIV_STREAK"
  };

  // cooldown config (you can change later without rewriting page)
  // default: 12 hours
  const COOLDOWN_MS = 12 * 60 * 60 * 1000;

  // fortune amount config
  const FORTUNE_MIN = 1;
  const FORTUNE_MAX = 888;

  // helper: format time
  function fmt(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const ss = s%60;
    return `${h}小時${m}分${ss}秒`;
  }

  // ---------------------------
  // ENTER / EXIT
  // ---------------------------
  function enterTemple(){
    localStorage.setItem(LS.entered, "1");
    document.getElementById("templeStatus").innerText = "已確認你的存在。你已進入前庭。";
    speakCN("已確認你的存在。你已進入前庭。");
  }

  function exitTemple(){
    localStorage.removeItem(LS.entered);
    document.getElementById("templeStatus").innerText = "紀錄已完成。你已離開。";
    speakCN("紀錄已完成。你已離開。");
  }

  // ---------------------------
  // MODALS
  // ---------------------------
  function openBackdrop(){ document.getElementById("modalBackdrop").style.display = "block"; }
  function closeBackdrop(){ document.getElementById("modalBackdrop").style.display = "none"; }

  function closeAllModals(){
    closeBackdrop();
    ["fortuneModal","divinationModal","burnModal"].forEach(id=>{
      document.getElementById(id).style.display = "none";
    });
  }

  function openFortuneModal(){
    if(!localStorage.getItem(LS.entered)){
      document.getElementById("templeStatus").innerText = "請先登入參拜，再領發財金。";
      speakCN("請先登入參拜，再領發財金。");
      return;
    }
    openBackdrop();
    document.getElementById("fortuneModal").style.display = "block";
    document.getElementById("fortuneResult").style.display = "none";
  }

  function openDivinationModal(){
    openBackdrop();
    document.getElementById("divinationModal").style.display = "block";
    const streak = parseInt(localStorage.getItem(LS.divStreak) || "0", 10);
    document.getElementById("divinationResult").innerText = `目前連勝：${streak}。按「丟筊」開始。`;
  }

  function openBurnModal(){
    openBackdrop();
    document.getElementById("burnModal").style.display = "block";
    document.getElementById("burnResult").style.display = "none";
  }

  // ---------------------------
  // FORTUNE CLAIM (cooldown + narrative)
  // ---------------------------
  function claimFortune(routeKey){
    const now = Date.now();
    const lastTs = parseInt(localStorage.getItem(LS.lastClaim) || "0", 10);
    const lastKey = localStorage.getItem(LS.lastClaimKey) || "";

    // cooldown applies per "routeKey"
    if(lastKey === routeKey && (now - lastTs) < COOLDOWN_MS){
      const remain = COOLDOWN_MS - (now - lastTs);
      const msg = `冷卻中。距離下次可領還有：${fmt(remain)}。`;
      showFortune(msg, false);
      speakCN("冷卻中。今日狀態已鎖定。");
      return;
    }

    // Random amount within [1, 888]
    const amount = Math.floor(Math.random() * (FORTUNE_MAX - FORTUNE_MIN + 1)) + FORTUNE_MIN;

    // Save claim state
    localStorage.setItem(LS.lastClaim, String(now));
    localStorage.setItem(LS.lastClaimKey, routeKey);

    // Narrative response
    const routeName = ({
      "BURN_ENGINE": "Burn-Engine（領發財金）",
      "ENGINE_ROOM": "引擎室（補油與燃燒）",
      "PUBLIC_GOOD": "公益池（自由民主與震災）"
    })[routeKey] || "未知路徑";

    const msg =
      `已放行。你選擇的路徑是：${routeName}。\n` +
      `本次發財金事件額度：${amount}（上限 888，下限 1）。\n` +
      `提醒：發財金是一次性遊戲事件，給出即完成，不保留、不回收、不保證價值。`;

    showFortune(msg, true);
    speakCN("已放行。路已開。");
  }

  function showFortune(text, ok){
    const box = document.getElementById("fortuneResult");
    box.style.display = "block";
    box.style.whiteSpace = "pre-wrap";
    box.style.lineHeight = "1.9";
    box.innerText = text;
  }

  // ---------------------------
  // DIVINATION (2 outcomes, streak => 2^N narrative tier)
  // ---------------------------
  function castDivination(){
    const r = Math.random() < 0.5 ? "聖筊" : "笑筊";
    let streak = parseInt(localStorage.getItem(LS.divStreak) || "0", 10);

    if(r === "聖筊"){
      streak += 1;
      localStorage.setItem(LS.divStreak, String(streak));
      const tier = Math.pow(2, streak);
      const txt =
        `結果：${r}\n` +
        `目前連勝：${streak}\n` +
        `觸發獎階敘事：2 的 ${streak} 次方 = ${tier}\n` +
        `提示：這是玩法節奏，不是收益保證。`;
      document.getElementById("divinationResult").style.whiteSpace = "pre-wrap";
      document.getElementById("divinationResult").innerText = txt;
      speakCN("聖筊。");
    }else{
      streak = 0;
      localStorage.setItem(LS.divStreak, "0");
      const txt =
        `結果：${r}\n` +
        `連勝歸零。\n` +
        `提示：不解釋原因，只記錄結果。`;
      document.getElementById("divinationResult").style.whiteSpace = "pre-wrap";
      document.getElementById("divinationResult").innerText = txt;
      speakCN("未取得回應。");
    }
  }

  function resetDivination(){
    localStorage.setItem(LS.divStreak, "0");
    document.getElementById("divinationResult").innerText = "連勝已重置。";
    speakCN("連勝已重置。");
  }

  // ---------------------------
  // BURN / VOW (narrative routing)
  // ---------------------------
  function burnTo(type){
    const box = document.getElementById("burnResult");
    box.style.display = "block";
    box.style.whiteSpace = "pre-wrap";

    const map = {
      "BLACKHOLE_0": "黑洞燃燒（x0....00）",
      "DEAD_0": "黑洞燃燒（x0....dead）",
      "ENGINE_ROOM": "引擎室補油（感恩）"
    };

    const msg =
      `已記錄你的選擇：${map[type] || type}\n` +
      `提示：此頁僅做敘事與流程導引。真正地址與合約連結由你後續填入固定官方入口。\n` +
      `還願是感恩：把質量轉成推進力，推動引擎室與公益航行。`;

    box.innerText = msg;
    speakCN("已記錄。感恩已完成。");
  }

  // ---------------------------
  // SIMPLE TTS (Chinese)
  // ---------------------------
  let utter = null;
  function speakCN(text){
    try{
      if(!("speechSynthesis" in window)) return;
      stopSpeak();
      utter = new SpeechSynthesisUtterance(text);
      // try prefer zh-TW/zh-Hant if available
      const voices = window.speechSynthesis.getVoices() || [];
      const v = voices.find(x => (x.lang||"").toLowerCase().includes("zh-tw"))
             || voices.find(x => (x.lang||"").toLowerCase().includes("zh-hant"))
             || voices.find(x => (x.lang||"").toLowerCase().startsWith("zh"));
      if(v) utter.voice = v;
      utter.rate = 1.0;
      utter.pitch = 1.0;
      window.speechSynthesis.speak(utter);
    }catch(e){}
  }
  function stopSpeak(){
    try{
      if("speechSynthesis" in window) window.speechSynthesis.cancel();
    }catch(e){}
  }

  // Warm up voices in some browsers
  setTimeout(()=>{ try{ window.speechSynthesis.getVoices(); }catch(e){} }, 200);
  </script>
