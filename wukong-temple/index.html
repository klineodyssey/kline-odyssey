<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>æ‚Ÿç©ºè²¡ç¥æ®¿ãƒ»äº”æŒ‡å±±ç¥æ®¿ V4.4.3 CHAIN</title>
<style>

/* === V4.5.3 UX HOTFIX: Help Drawer + Safe Areas === */
:root{ --safe-bottom: env(safe-area-inset-bottom, 0px); }
.kline-bottombar{ padding-bottom: calc(10px + var(--safe-bottom)); }
.kline-fab{ bottom: calc(14px + var(--safe-bottom)); }
#klineHelpDrawer{ position: fixed; left:0; right:0; bottom:0; z-index:99999;
  transform: translateY(110%); transition: transform .22s ease;
  background: rgba(15,18,30,.96); border-top:1px solid rgba(255,255,255,.12);
  backdrop-filter: blur(10px);
  padding: 14px 14px calc(14px + var(--safe-bottom));
  box-shadow: 0 -20px 60px rgba(0,0,0,.45);
}
#klineHelpDrawer.open{ transform: translateY(0%); }
#klineHelpDrawer .hd{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
#klineHelpDrawer .title{ font-weight:900; letter-spacing:.3px; }
#klineHelpDrawer .sub{ opacity:.85; font-size:13px; margin-top:6px; line-height:1.4; }
#klineHelpDrawer .body{ margin-top:10px; font-size:14px; line-height:1.55; white-space:pre-wrap; }
#klineHelpDrawer .actions{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; }
#klineHelpDrawer .btn{ border:1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.06);
  color:#fff; padding:10px 12px; border-radius:14px; font-weight:800; }
#klineHelpDrawer .btn.primary{ background: rgba(255,255,255,.92); color:#111; border-color:#fff; }
#klineHelpDrawer .btn.danger{ background: rgba(255,80,80,.14); border-color: rgba(255,80,80,.35); }
#klineHelpScrim{ position:fixed; inset:0; z-index:99998; background: rgba(0,0,0,.35);
  opacity:0; pointer-events:none; transition: opacity .18s ease; }
#klineHelpScrim.open{ opacity:1; pointer-events:auto; }

  :root{
    --bg:#0b1220;
    --panel:#0f1b33;
    --panel2:#0b162c;
    --line:#24324f;
    --txt:#e8eefc;
    --muted:#a9b7d6;
    --ok:#2dd4bf;
    --warn:#fbbf24;
    --bad:#fb7185;
    --btn:#ffffff;
    --btnTxt:#000000;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", Arial, sans-serif;
    background: radial-gradient(1000px 700px at 20% 0%, #172554 0%, rgba(23,37,84,0) 55%),
                radial-gradient(900px 650px at 90% 10%, #134e4a 0%, rgba(19,78,74,0) 55%),
                var(--bg);
    color:var(--txt);
    padding:16px 14px 140px;
  }
  a{color:inherit}
  .topbar{
    position:sticky; top:0; z-index:9990;
    backdrop-filter: blur(10px);
    background: linear-gradient(to bottom, rgba(11,18,32,.92), rgba(11,18,32,.70));
    border-bottom:1px solid rgba(36,50,79,.6);
    padding:10px 2px 10px;
    margin:-16px -14px 14px;
  }
  .topbar-inner{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; padding:0 12px;
  }
  .brand{
    display:flex; flex-direction:column; gap:2px;
  }
  .brand b{font-size:14px; letter-spacing:.6px}
  .brand span{font-size:12px; color:var(--muted)}
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:9px 12px; border-radius:999px;
    border:1px solid rgba(17,17,17,.2);
    background: #fff;
    color:#000;
    font-weight:900;
    text-decoration:none;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
    white-space:nowrap;
  }
  .grid{
    display:grid;
    grid-template-columns: 1fr;
    gap:12px;
  }
  @media (min-width: 900px){
    .grid{grid-template-columns: 1.05fr .95fr;}
  }
  .card{
    background: linear-gradient(180deg, rgba(15,27,51,.94), rgba(11,22,44,.94));
    border:1px solid rgba(36,50,79,.9);
    border-radius:16px;
    box-shadow: 0 20px 60px rgba(0,0,0,.35);
    overflow:hidden;
  }
  .card-h{
    padding:14px 14px 10px;
    border-bottom:1px solid rgba(36,50,79,.75);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .card-h h2{
    margin:0; font-size:14px; letter-spacing:.4px;
  }
  .card-h .sub{font-size:12px; color:var(--muted)}
  .card-b{padding:14px}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .row > *{flex:1}
  .mini{
    background: rgba(11,22,44,.6);
    border:1px solid rgba(36,50,79,.75);
    border-radius:14px;
    padding:12px;
  }
  .mini h3{margin:0 0 6px; font-size:12px; color:var(--muted); font-weight:700}
  .big{
    font-size:18px; font-weight:900; letter-spacing:.3px;
  }
  .small{font-size:12px; color:var(--muted)}
  .btn{
    appearance:none;
    border:none;
    border-radius:12px;
    padding:10px 12px;
    font-weight:900;
    cursor:pointer;
    background:var(--btn);
    color:var(--btnTxt);
  }
  .btn2{
    appearance:none;
    border:1px solid rgba(36,50,79,.9);
    background: rgba(11,22,44,.65);
    color: var(--txt);
    border-radius:12px;
    padding:10px 12px;
    font-weight:900;
    cursor:pointer;
  }
  .btn:disabled,.btn2:disabled{opacity:.45; cursor:not-allowed}
  .tabs{
    display:flex; gap:8px; flex-wrap:wrap;
  }
  .tab{
    padding:9px 10px; border-radius:999px;
    border:1px solid rgba(36,50,79,.9);
    background: rgba(11,22,44,.65);
    color: var(--txt);
    font-weight:900; cursor:pointer;
  }
  .tab.active{
    background:#fff; color:#000; border-color: rgba(17,17,17,.2);
  }
  .hidden{display:none !important}
  input[type="range"]{width:100%}
  input[type="number"], input[type="text"], textarea, select{
    width:100%;
    border-radius:12px;
    border:1px solid rgba(36,50,79,.85);
    background: rgba(7,14,28,.7);
    color: var(--txt);
    padding:10px 12px;
    outline:none;
  }
  textarea{min-height:80px; resize:vertical}
  .sep{height:1px; background: rgba(36,50,79,.75); margin:12px 0}
  .meter{
    width:100%;
    height:12px;
    border-radius:999px;
    border:1px solid rgba(36,50,79,.9);
    background: rgba(7,14,28,.75);
    overflow:hidden;
  }
  .meter > div{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, #22c55e, #eab308, #fb7185);
  }
  .log{
    background: rgba(7,14,28,.75);
    border:1px solid rgba(36,50,79,.9);
    border-radius:14px;
    padding:10px 12px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size:11px;
    max-height:190px;
    overflow:auto;
    line-height:1.55;
  }
  .kpi{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  @media (min-width: 900px){
    .kpi{grid-template-columns: repeat(4, 1fr);}
  }
  .badge{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px;
    border:1px solid rgba(36,50,79,.9);
    background: rgba(11,22,44,.65);
    font-size:12px; color:var(--muted); font-weight:800;
  }
  .badge.ok{color: #a7f3d0}
  .badge.warn{color:#fde68a}
  .badge.bad{color:#fecdd3}
  .avatar{
    width:96px; height:96px; border-radius:999px;
    display:grid; place-items:center;
    margin: 6px auto 12px;
    background: radial-gradient(circle at 30% 30%, rgba(45,212,191,.8), rgba(45,212,191,0) 55%),
                radial-gradient(circle at 70% 70%, rgba(59,130,246,.8), rgba(59,130,246,0) 55%),
                rgba(255,255,255,.06);
    border:1px solid rgba(36,50,79,.9);
    box-shadow: 0 0 30px rgba(45,212,191,.15);
  }
  .avatar svg{opacity:.95}
  .sticky-actions{
    position:fixed;
    left:0; right:0; bottom:0;
    background: linear-gradient(to top, rgba(11,18,32,.96), rgba(11,18,32,.55));
    border-top:1px solid rgba(36,50,79,.75);
    padding:10px 12px calc(10px + env(safe-area-inset-bottom));
    z-index:9991;
  }
  .sticky-actions .row{gap:8px}
  .hint{font-size:12px; color:var(--muted); margin-top:8px}

  .grid72{
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap:6px;
    margin-top:10px;
  }
  .slot{
    border:1px solid var(--line);
    background: rgba(255,255,255,.04);
    border-radius:10px;
    padding:8px 6px;
    text-align:center;
    font-weight:800;
    cursor:pointer;
    user-select:none;
    font-size:12px;
  }
  .slot.empty{ opacity:.75; }
  .slot.filled{ border-color: rgba(45,212,191,.55); }
  .slot.sel{ outline:2px solid rgba(59,130,246,.85); outline-offset:2px; }


  .grid72{
    display:grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap:10px;
    margin-top:10px;
  }
  .slot{
    border:1px solid var(--line);
    background: rgba(255,255,255,0.03);
    border-radius:14px;
    padding:10px;
  }
  .slot .n{font-weight:900; font-size:14px; margin-bottom:6px}
  .slot input, .slot textarea{
    width:100%;
    border:1px solid var(--line);
    background: rgba(0,0,0,0.25);
    color:var(--txt);
    border-radius:10px;
    padding:8px;
    outline:none;
    font-size:14px;
  }
  .slot textarea{min-height:58px; resize:vertical}
  @media (max-width:520px){
    .grid72{grid-template-columns: 1fr;}
  }


/* v4.5.5 HOTFIX UI */
.modal.hidden{display:none;}
.modal{position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; padding:16px; z-index:99999;}
.modal-card{width:min(720px, 100%); background:rgba(10,16,32,.95); border:1px solid rgba(255,255,255,.12); border-radius:18px; box-shadow:0 10px 40px rgba(0,0,0,.55); overflow:hidden;}
.modal-head{display:flex; justify-content:space-between; align-items:center; padding:14px; border-bottom:1px solid rgba(255,255,255,.08);}
.modal-title{font-weight:900;}
.modal-body{padding:14px;}
.checklist .item{display:flex; align-items:flex-start; gap:10px; padding:10px; border:1px solid rgba(255,255,255,.08); border-radius:14px; margin:10px 0; background:rgba(255,255,255,.03);}
.checklist .item input{margin-top:3px;}
.safe-bottom{padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 96px) !important;}

</style>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>

<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <b>æ‚Ÿç©ºå®‡å®™ç¥æ®¿é£›ç¢Ÿï½œé§•é§›è‰™ + ä¸‹å–®æ¡Œ + AIå®¢æœ</b>
      <span id="bootLine">boot_version=v4.5.5-wuzhishan12345-temple-vitals-ai-smarthelp-counter</span>
      <span id="visitLine" class="muted">åˆ°è¨ªï¼š--</span>
    </div>

    <a class="pill" href="https://klineodyssey.github.io/kline-odyssey/" target="_blank" rel="noopener">
      ğŸ’– å®‡å®™ç´°åŒ…ï½œå‘¼å¸ï½œå¿ƒè·³ï½œç”Ÿå‘½ğŸ”¥
    </a>
  </div>
</div>
<!-- =========================
WUZHISHAN 12345 Â· BUILD PROGRESS
========================= -->
<section id="buildProgress" class="card" style="margin:12px 0; padding:14px; border:1px solid #111; border-radius:16px; background:#fff;">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
    <div>
      <div style="font-weight:900; font-size:16px;">äº”æŒ‡å±±æ‚Ÿç©ºè²¡ç¥æ®¿ Â· åº§æ¨™ 12345</div>
      <div style="opacity:.75; font-weight:700; font-size:12px;">å»ºç¯‰ç‹€æ…‹ï¼šå…ˆå®Œæˆç¥æ®¿åŸºç¤è¨­æ–½ï¼ˆè¨±é¡˜ï¼é»ç‡ˆï¼ç™¼è²¡é‡‘ï¼å®¢æœï¼éŒ¢åŒ…å¼•å°ï¼‰â†’ å†æ¥éˆä¸Šå¿ƒè‡Ÿèˆ‡ç„¡äººéŠ€è¡Œ â†’ æœ€å¾Œæ¥äº¤æ˜“å®¤ä¸‹å–®çµç®—ã€‚</div>
    </div>
    <button id="btnShowBuildChecklist" class="btn" style="padding:10px 12px; border-radius:12px; border:1px solid #111; background:#fff; font-weight:900;">æŸ¥çœ‹å®Œå·¥æ¸…å–®</button>
  </div>

  <div style="margin-top:10px;">
    <div style="display:flex; align-items:center; justify-content:space-between; font-weight:800; font-size:12px;">
      <span>å®Œå·¥é€²åº¦</span>
      <span id="buildPctText">0%</span>
    </div>
    <div style="height:14px; border-radius:999px; border:1px solid #111; overflow:hidden; background:#f6f6f6; margin-top:6px;">
      <div id="buildPctBar" style="height:100%; width:0%; background:#111;"></div>
    </div>
  </div>

  <div id="buildChecklist" style="display:none; margin-top:12px; padding-top:10px; border-top:1px dashed #111;">
    <div style="font-weight:900; margin-bottom:8px;">åŸºç¤è¨­æ–½æ¸…å–®ï¼ˆUI å·²å®Œæˆï¼éˆä¸Šå¾…æ¥ï¼‰</div>
    <div id="buildChecklistRows" style="display:grid; grid-template-columns:1fr; gap:6px;"></div>
    <div style="margin-top:10px; font-size:12px; opacity:.8; font-weight:700;">
      è¨»ï¼šæœ¬é æœƒè‡ªå‹•è‡ªæª¢ï¼ˆç€è¦½å™¨èƒ½åŠ›ï¼éŒ¢åŒ…æ³¨å…¥ï¼èªéŸ³ï¼é¡é ­ï¼‰ã€‚åµæ¸¬åˆ°ç¼ºä»¶æœƒåœ¨å®¢æœå€æé†’ä½¿ç”¨è€…æ€éº¼è£œé½Šã€‚
    </div>
  </div>
</section>


<div class="grid">

  <!-- LEFT: Cockpit + Order Desk -->
  <div class="card">
    <div class="card-h">
      <div>
        <h2>KUFO é§•é§›è‰™ï¼ˆå„€è¡¨ç‰ˆï¼‰</h2>
        <div class="sub">æ–¹å‘ç›¤ + æ§“æ¡¿ + ç‡ƒæ–™è¡€é‡ï¼ˆKGENï¼‰ + å¤šç©ºæ‰‡å€</div>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="cockpit">é§•é§›è‰™</button>
        <button class="tab" data-tab="orderdesk">ä¸‹å–®æ¡Œ</button>
        <button class="tab" data-tab="temple">å¤–æ®¿</button>
      </div>
    </div>

    <div class="card-b">
      <!-- Cockpit -->
      <div id="tab_cockpit">
        <div class="kpi">
          <div class="mini">
            <h3>è³ªé‡ï¼ˆKGENï¼‰</h3>
            <div class="big"><span id="massKgen">30000</span> KGEN</div>
            <div class="small">è¦å‰‡ï¼š1 æŒ‡æ•¸é» = 1 KGENï¼ˆè·¨å¸‚å ´é€šç”¨ï¼‰</div>
          </div>
          <div class="mini">
            <h3>èƒ½é‡ï¼ˆE = m cÂ²ï¼‰</h3>
            <div class="big"><span id="energyE">30000</span> E</div>
            <div class="small">UI é¡¯ç¤ºï¼šæŠ•å…¥å¾Œæ‰åæ˜ ï¼ˆç›®å‰ä»¥ m ä½œç‚ºåŸºç¤ï¼‰</div>
          </div>
          <div class="mini">
            <h3>æ§“æ¡¿ï¼ˆ1â€“150ï¼‰</h3>
            <div class="big"><span id="lev">10</span>x</div>
            <div class="small">æ©«æ¡¿èª¿æ•´ï¼Œå½±éŸ¿æ¨¡æ“¬è¼¸è´å€ç‡</div>
          </div>
          <div class="mini">
            <h3>æ–¹å‘ç›¤ï¼ˆ0â€“360ï¼‰</h3>
            <div class="big"><span id="deg">120</span>Â°</div>
            <div class="small">0â€“170 å¤šï½œ170â€“190 ä¼‘æ¯ï½œ190â€“360 ç©º</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div class="mini">
            <h3>è³ªé‡ï¼ˆKGENï¼‰è¼¸å…¥</h3>
            <input id="massInput" type="number" min="0" step="1" value="30000" />
            <div class="hint">å°æŒ‡ 30000 é» = 30000 KGENï¼›BTC åŒç†ã€‚</div>
          </div>
          <div class="mini">
            <h3>æ§“æ¡¿æ»‘æ¡¿</h3>
            <input id="levRange" type="range" min="1" max="150" value="10" />
            <div class="small">ç›®å‰ï¼š<b id="levRangeLabel">10</b>x</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="mini">
            <h3>æ–¹å‘ç›¤æ»‘æ¡¿</h3>
            <input id="degRange" type="range" min="0" max="360" value="120" />
            <div class="small">
              ç›®å‰ï¼š<b id="degRangeLabel">120</b>Â°ï½œ
              ç‹€æ…‹ï¼š<b id="stanceLabel">å¤š</b>
            </div>
          </div>
          <div class="mini">
            <h3>ç‡ƒæ–™ / è¡€é‡ï¼ˆç”¨ KGEN è¡¨ç¤ºï¼‰</h3>
            <div class="meter"><div id="fuelBar"></div></div>
            <div class="small" style="margin-top:8px">
              <b id="fuelLabel">60%</b>ï½œ
              ä¸Šé™ï¼š<span id="fuelMaxLabel">50000</span> KGENï½œ
              ç¾åœ¨ï¼š<span id="fuelNowLabel">30000</span> KGEN
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <button class="btn" id="btnHeartbeat">å¿ƒè·³</button>
          <button class="btn" id="btnBreath">å‘¼å¸</button>
          <button class="btn" id="btnPressure">å£“åŠ›</button>
          <button class="btn" id="btnCup">æ“²ç­Š</button>
          <button class="btn" id="btnFortune">æ±‚ç±¤</button>
        </div>
        <div class="hint">ä»¥ä¸Šç‚º UI äº‹ä»¶å›è·¯æ¸¬è©¦ï¼ˆæ¯é¡†æŒ‰éµå¿…æœ‰åæ‡‰ + logï¼‰ã€‚</div>
        <div style="margin-top:12px; padding:12px; border:1px solid rgba(255,255,255,.12); border-radius:16px; background:rgba(0,0,0,.18);">
          <div style="font-weight:900; margin-bottom:8px;">å®‡å®™ç”Ÿå‘½å¾µè±¡å³æ™‚é¡¯ç¤ºï¼ˆæœ¬æ©Ÿï¼‰</div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div style="padding:10px; border-radius:14px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);">
              <div style="opacity:.85; font-weight:800;">å¿ƒè·³</div>
              <div style="font-size:22px; font-weight:1000;"><span id="vitalHeart">--</span> bpm</div>
            </div>
            <div style="padding:10px; border-radius:14px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);">
              <div style="opacity:.85; font-weight:800;">å‘¼å¸</div>
              <div style="font-size:22px; font-weight:1000;"><span id="vitalBreath">--</span> /min</div>
            </div>
            <div style="padding:10px; border-radius:14px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);">
              <div style="opacity:.85; font-weight:800;">è¡€å£“</div>
              <div style="font-size:22px; font-weight:1000;"><span id="vitalPressure">--</span></div>
            </div>
            <div style="padding:10px; border-radius:14px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);">
              <div style="opacity:.85; font-weight:800;">ç‹€æ…‹</div>
              <div style="font-size:14px; font-weight:900;"><span id="vitalStatus">å°šæœªå•Ÿå‹•</span></div>
            </div>
          </div>
          <div style="margin-top:10px; font-size:12px; opacity:.85;">
            æé†’ï¼šMetaMask WebView å¸¸è¦‹ speechSynthesis=falseï¼Œä½† Chrome å¯èƒ½å¯ç”¨ TTSï¼›æœ¬ç¥æ®¿æœƒè‡ªå‹•é™ç´šåˆ°æç¤ºéŸ³èˆ‡æ–‡å­—å®¢æœã€‚
          </div>
        </div>


        <div class="sep"></div>

        <div class="row">
          <button class="btn2" id="btnSelfTest">ä¸€éµè‡ªæˆ‘æª¢æ¸¬</button>
          <button class="btn2" id="btnExportState">åŒ¯å‡ºç‹€æ…‹ï¼ˆJSONï¼‰</button>
          <button class="btn2" id="btnImportState">åŒ¯å…¥ç‹€æ…‹ï¼ˆJSONï¼‰</button>
          <button class="btn2" id="btnCopyLog">è¤‡è£½ Log</button>
        </div>

        <div class="sep"></div>
        <div class="log" id="log"></div>
      </div>

      <!-- Order Desk -->
      <div id="tab_orderdesk" class="hidden">
        <div class="mini">
          <h3>ä¸‹å–®æ¡Œï¼ˆT+2ï¼‰</h3>
          <div class="small">
            äº¤æ˜“æ—¥æ¡ T+2 çµç®—ã€‚ç„¡é€±ä¸‰çµç®—æ¦‚å¿µã€‚<br>
            è¦å‰‡ï¼šåœåˆ©èˆ‡åœæåŒä¸€çµç®—æ—¥åŒæ™‚è§¸ç™¼ â†’ è¦–ç‚º 0ï¼ˆä¸ç®—è¼¸è´ï¼‰ã€‚
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div class="mini">
            <h3>äº¤æ˜“æ—¥</h3>
            <input id="tradeDate" type="text" placeholder="YYYY-MM-DD" />
            <div class="small">é è¨­ä»Šæ—¥ï¼ˆæœ¬æ©Ÿï¼‰ã€‚</div>
          </div>
          <div class="mini">
            <h3>T+2 çµç®—æ—¥ï¼ˆè‡ªå‹•ï¼‰</h3>
            <input id="settleDate" type="text" disabled />
            <div class="small">ä»¥ã€Œäº¤æ˜“æ—¥ + 2 å¤©ã€è¨ˆï¼ˆç°¡åŒ–ç‰ˆï¼‰ã€‚</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="mini">
            <h3>åœæï¼ˆKGEN é»ï¼‰</h3>
            <input id="sl" type="number" step="1" value="200" />
            <div class="small">æœ€å¤§å»ºè­°ï¼šÂ± ATR14</div>
          </div>
          <div class="mini">
            <h3>åœåˆ©ï¼ˆKGEN é»ï¼‰</h3>
            <input id="tp" type="number" step="1" value="300" />
            <div class="small">æœ€å¤§å»ºè­°ï¼šÂ± ATR14</div>
          </div>
          <div class="mini">
            <h3>ATR14ï¼ˆä¸Šé™ï¼‰</h3>
            <input id="atr14" type="number" step="1" value="500" />
            <div class="small">æœ¬ç‰ˆç‚ºæ‰‹å‹•å¡«å…¥ï¼ˆä¹‹å¾Œå¯æ¥è³‡æ–™ï¼‰ã€‚</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div class="mini">
            <h3>æ¨¡æ“¬çµæœï¼ˆKGENï¼‰</h3>
            <div class="big"><span id="pnlKgen">0</span></div>
            <div class="small">åŸºæ–¼æ–¹å‘ç›¤ï¼ˆå¤š/ç©ºï¼‰ + æ§“æ¡¿ + SL/TP/ATR14 ä¸Šé™</div>
          </div>
          <div class="mini">
            <h3>èªªæ˜ï¼ˆå®¢æœå£å¾‘ï¼‰</h3>
            <textarea id="csNote"></textarea>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <button class="btn" id="btnSimWin">æ¨¡æ“¬è´</button>
          <button class="btn" id="btnSimLose">æ¨¡æ“¬è¼¸</button>
          <button class="btn2" id="btnSaveOrder">ä¿å­˜é€™ç­†å–®</button>
          <button class="btn2" id="btnExportOrders">åŒ¯å‡ºè¨‚å–®ï¼ˆJSONï¼‰</button>
        </div>

        <div class="sep"></div>
        <div class="log" id="ordersLog"></div>
      </div>

      <!-- Temple -->
            <div id="tab_temple" class="hidden">
        <div class="mini">
          <h3>å¤–æ®¿ï¼ˆè§€å…‰/ç•™å¿µ/é¦™æ²¹éŒ¢ï¼‰</h3>
          <div class="small">
            13 ç”Ÿè‚– / å…‰æ˜ç‡ˆ / ä¸ƒä»™å¥³è¨±é¡˜
<div class="card" style="margin-top:12px">
  <div class="h3">ä¸ƒä»™å¥³ä½è™•èˆ‡è‡ªæˆ‘ä»‹ç´¹ï¼ˆæ˜Ÿé–€åº§æ¨™ï¼‰</div>
  <div class="muted" style="margin-top:6px">
    ä¸ƒä»™å¥³ä¸æ˜¯è£é£¾ï¼Œæ˜¯ç¥æ®¿çš„ã€Œå®¢æœç¥å®˜ã€ã€‚æ¯ä½ä»™å¥³éƒ½æœ‰ä¸€å€‹æ˜Ÿé–€åº§æ¨™èˆ‡å°ˆæŒç¥ç¦ï¼Œ
    ä¹Ÿå°æ‡‰ä¸€å€‹ã€Œå¤šï¼ç©ºã€ç¯€å¥æé†’â€”â€”è®“ä¿¡çœ¾åœ¨è¨±é¡˜æ™‚ï¼ŒåŒæ­¥å­¸æœƒå®ˆå¿ƒèˆ‡é¢¨æ§ã€‚
  </div>

  <div class="grid" style="margin-top:10px">
    <div class="card" style="padding:12px">
      <div class="h4">14520ï½œå¤§ä»™å¥³ å·§é›²</div>
      <div class="muted">å¤©æ¨å°ˆæŒï¼šé¢¨èª¿é›¨é †ï½œåšç©º</div>
      <button class="btn" data-topic="fairy_14520" style="margin-top:10px">å‘¼å«å·§é›²ãƒ»è«‹å¥¹èªªæ˜</button>
    </div>
    <div class="card" style="padding:12px">
      <div class="h4">14866ï½œäºŒä»™å¥³ å·§è™¹</div>
      <div class="muted">å¤©ç’‡å°ˆæŒï¼šå®¶åº­ç¾æ»¿ï½œåšå¤š</div>
      <button class="btn" data-topic="fairy_14866" style="margin-top:10px">å‘¼å«å·§è™¹ãƒ»è«‹å¥¹èªªæ˜</button>
    </div>
    <div class="card" style="padding:12px">
      <div class="h4">16184ï½œä¸‰ä»™å¥³ å·§èŠ</div>
      <div class="muted">å¤©ç’£å°ˆæŒï¼šè‚²å­æ”¶é©šï½œåšç©º</div>
      <button class="btn" data-topic="fairy_16184" style="margin-top:10px">å‘¼å«å·§èŠãƒ»è«‹å¥¹èªªæ˜</button>
    </div>
    <div class="card" style="padding:12px">
      <div class="h4">16888ï½œå››ä»™å¥³ å·§ä»™</div>
      <div class="muted">å¤©æ¬Šå°ˆæŒï¼šäº‹æ¥­é‹é€šï½œåšå¤š</div>
      <button class="btn" data-topic="fairy_16888" style="margin-top:10px">å‘¼å«å·§ä»™ãƒ»è«‹å¥¹èªªæ˜</button>
    </div>
    <div class="card" style="padding:12px">
      <div class="h4">17347ï½œäº”ä»™å¥³ å·§è˜­</div>
      <div class="muted">å¤©è¡¡å°ˆæŒï¼šé•·å‘½ç™¾æ­²ï½œåšç©º</div>
      <button class="btn" data-topic="fairy_17347" style="margin-top:10px">å‘¼å«å·§è˜­ãƒ»è«‹å¥¹èªªæ˜</button>
    </div>
    <div class="card" style="padding:12px">
      <div class="h4">18056ï½œå…­ä»™å¥³ å·§æ¢…</div>
      <div class="muted">é—“é™½å°ˆæŒï¼šèº«é«”å¥åº·ï½œåšå¤š</div>
      <button class="btn" data-topic="fairy_18056" style="margin-top:10px">å‘¼å«å·§æ¢…ãƒ»è«‹å¥¹èªªæ˜</button>
    </div>
    <div class="card" style="padding:12px">
      <div class="h4">18459ï½œä¸ƒä»™å¥³ å·§éˆ</div>
      <div class="muted">ç‘¤å…‰å°ˆæŒï¼šæ„Ÿæƒ…åœ“æ»¿ï½œå¤šå–®é€€ï¼ˆä¿æœ¬é€€å ´ï¼‰</div>
      <button class="btn" data-topic="fairy_18459" style="margin-top:10px">å‘¼å«å·§éˆãƒ»è«‹å¥¹èªªæ˜</button>
    </div>
  </div>

  <div class="muted" style="margin-top:10px">
    ä¸ƒä»™å¥³ä½è™•ï¼šç‘¤æ± æ˜Ÿé–€ï¼ˆç¥æ®¿å…§é§é»ï¼‰ï¼Œä¸¦å¯åœ¨è¨±é¡˜ã€ç™¼è²¡é‡‘ã€é‚„é¡˜ã€è±ªå®…å¸­ä½ã€èˆ‡å®‡å®™ç´°åŒ…ï¼å•†åº—æµç¨‹ä¸­éš¨æ™‚ä»‹å…¥å”åŠ©ã€‚
  </div>
</div>

<div class="card" style="margin-top:12px" id="marsSeatsCard">
  <div class="h3">MARS ç«æ˜Ÿè–åº«ï¼ˆ0.05% Reward ç¨…ï¼‰ï½œ500 å¸­ä½</div>
  <div class="muted" style="margin-top:6px">
    é€™è£¡ä¸æ˜¯å¿ƒè‡Ÿã€‚å¿ƒè‡Ÿï¼ˆHeartï¼‰è² è²¬å‘¼å¸èˆ‡ç™¼è²¡é‡‘ï¼›<b>MARS</b> æ‰æ˜¯ã€Œå¸­ä½ã€åˆ¶åº¦ï¼š
    <b>ä¸€æ¬¡é‚„é¡˜ 5000 KGEN â†’ å–å¾— 1 å¸­</b>ï¼ˆç¸½ä¸Šé™ 500 å¸­ï¼‰ã€‚å¸­ä½ç”¨ä¾†åˆ†é… MARS ç¨…æ”¶å›æµï¼ˆ0.05%ï¼‰ã€‚
  </div>

  <div class="grid" style="margin-top:10px">
    <div class="card" style="padding:12px">
      <div class="h4">å¸­ä½å‰©é¤˜</div>
      <div style="font-size:28px;font-weight:900" id="marsSeatsRemaining">â€”</div>
      <div class="muted">ä¸Šé™ï¼š500 å¸­ï¼ˆå‰ç«¯æš«ä»¥ã€Œéˆä¸Šäº‹ä»¶ï¼æˆ–æœ¬æ©Ÿç´€éŒ„ã€é¡¯ç¤ºï¼›æ­£å¼ç‰ˆå¯æ”¹æˆéˆä¸ŠæŸ¥è©¢ï¼‰</div>
      <button class="btn" id="btnMarsRefresh" data-topic="mars_refresh" style="margin-top:10px">åˆ·æ–°å¸­ä½</button>
    </div>

    <div class="card" style="padding:12px">
      <div class="h4">ä¸€æ¬¡é‚„é¡˜ 5000 KGEN</div>
      <div class="muted">ç›®æ¨™åœ°å€ï¼ˆMARS / KUFO Vaultï¼‰ï¼š<span class="mono" id="addrMARS">ï¼ˆå°šæœªè¨­å®šï¼‰</span></div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
        <button class="btn" id="btnCopyMARS" data-topic="copy_mars">ä¸€éµè¤‡è£½åœ°å€</button>
        <button class="btn" id="btnMarsVow5000" data-topic="mars_vow">æˆ‘å·²é‚„é¡˜ 5000ï¼ˆè¨˜éŒ„å¸­ä½ï¼‰</button>
      </div>
      <div class="muted" style="margin-top:8px">æé†’ï¼šçœŸæ­£çš„å¸­ä½æ†‘è­‰ä»¥ã€Œéˆä¸Šè½‰å¸³ç´€éŒ„ã€ç‚ºæº–ï¼›æ­¤æŒ‰éˆ•åªåšå‰ç«¯å¼•å°èˆ‡é¡¯ç¤ºã€‚</div>
    </div>
  </div>
</div>

 / é‚„é¡˜ / ç™¼è²¡é‡‘ç´€éŒ„ï¼šå±¬æ–¼å¤–æ®¿æ–‡åŒ–å±¤ã€‚<br>
            èˆ‡äº¤æ˜“åˆ†å±¤éš”é›¢ï¼Œä¸è®“ã€Œå»Ÿè®Šäº¤æ˜“æ‰€ã€ã€‚
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div class="mini">
            <h3>ç”Ÿè‚–ï¼ˆå¯è‡ªå®šç¬¬ 13 ç”Ÿè‚–ï¼‰</h3>
            <select id="zodiac">
              <option value="é¼ ">é¼ </option><option value="ç‰›">ç‰›</option><option value="è™">è™</option><option value="å…”">å…”</option>
              <option value="é¾">é¾</option><option value="è›‡">è›‡</option><option value="é¦¬">é¦¬</option><option value="ç¾Š">ç¾Š</option>
              <option value="çŒ´">çŒ´</option><option value="é›">é›</option><option value="ç‹—">ç‹—</option><option value="è±¬">è±¬</option>
              <option value="Z13">ç¬¬ 13 ç”Ÿè‚–ï¼ˆå®‡å®™ï¼‰</option>
            </select>
            <div class="row" style="margin-top:8px; gap:8px; flex-wrap:nowrap">
              <input id="zodiac13Name" placeholder="ç¬¬13ç”Ÿè‚–è‡ªå®šåç¨±ï¼ˆä¾‹ï¼šé¯¨ / é³³å‡° / é»‘æ´ï¼‰" />
              <button class="btn2" id="btnSaveZ13">ä¿å­˜</button>
            </div>
            <div class="small">æ¯ç”Ÿè‚– 72 åé¡ç™»è¨˜ï¼ˆè§€å…‰ç•™å¿µ / é»ç‡ˆï¼‰ï¼Œä¸ç­‰æ–¼äº¤æ˜“ç­‰ç´šã€‚</div>
            <div class="small">é»å…‰æ˜ç‡ˆé¦™æ²¹éŒ¢ï¼š<b><span id="lampFeeKgen">108</span> KGEN</b>ï¼ˆæœªæ¥éˆå‰åƒ…å±•ç¤ºï¼›æ¥éˆå¾Œæ‰æœƒæ‰£æ¬¾ï¼‰</div>
          
        <div class="mini" style="margin-top:10px">
          <h3>ç”Ÿè‚– 72 åé¡ç™»è¨˜ç°¿</h3>
          <div class="small">åˆ‡æ›ç”Ÿè‚–å¾Œå¯ç›´æ¥ç™»è¨˜ 1â€“72 åé¡ï¼ˆæœ¬æ©Ÿä¿å­˜ï¼‰ã€‚æ”¯æ´åŒ¯å‡º JSON / åŒ¯å…¥ JSONã€‚</div>
          <div class="row" style="margin-top:8px; flex-wrap:wrap">
            <button class="btn2" id="btnZodiacRender">åˆ·æ–°åå†Š</button>
            <button class="btn2" id="btnZodiacExport">åŒ¯å‡ºåå†ŠJSON</button>
            <label class="btn2" style="cursor:pointer">
              åŒ¯å…¥åå†ŠJSON<input id="zodiacImportFile" type="file" accept="application/json" style="display:none" />
            </label>
            <button class="btn2" id="btnZodiacClear">æ¸…ç©ºæœ¬ç”Ÿè‚–åå†Š</button>
          </div>
          <div id="zodiacSlots" class="grid72"></div>
        </div>
</div>

          <div class="mini">
            <h3>å…‰æ˜ç‡ˆè²»ç”¨ï¼ˆKGENï¼‰</h3>
            <input id="lampFee" class="input" value="108" min="0" step="1" />
            <div class="small">ç¤ºæ„ï¼šé»ç‡ˆè²»ç”¨ï¼ˆå¯ç”¨æ–¼è§€å…‰/ç•™å¿µæ”¶è²»ï¼‰ã€‚</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="mini">
          <h3>72 åé¡ç™»è¨˜ï¼ˆé¸ä¸€æ ¼ â†’ å¡«è³‡æ–™ â†’ é€å‡ºï¼‰</h3>
          <div class="small">é»æ ¼å­å¯æŒ‡å®šåé¡ï¼›ä¸é»å‰‡è‡ªå‹•ä½¿ç”¨ä¸‹ä¸€å€‹ç©ºä½ã€‚</div>

          <div id="slotGrid" class="grid72" aria-label="72 slots"></div>

          <div class="row" style="margin-top:10px">
            <div class="mini" style="flex:1">
              <h3>ç™»è¨˜è³‡æ–™</h3>
              <div class="row" style="gap:8px">
                <input id="regSlot" type="number" min="1" max="72" placeholder="åé¡(1-72)" />
                <input id="regName" placeholder="åå­— / æš±ç¨±" />
              </div>
              <div class="row" style="gap:8px; margin-top:8px">
                <input id="regWallet" placeholder="éŒ¢åŒ…åœ°å€ï¼ˆå¯ç•™ç©ºï¼‰" />
                <input id="regNote" placeholder="ç•™å¿µ / ç¥ç¦ï¼ˆå¯ç•™ç©ºï¼‰" />
              </div>

              <div class="row" style="margin-top:10px; gap:10px">
                <button class="btn" id="btnRegister">ç™»è¨˜åé¡</button>
                <button class="btn" id="btnLamp">é»å…‰æ˜ç‡ˆï¼ˆç•™å¿µï¼‰</button>
                <button class="btn2" id="btnClearReg">æ¸…ç©ºè¼¸å…¥</button>
              </div>
              <div class="small" id="regHint" style="margin-top:8px">æç¤ºï¼šè«‹å…ˆé¸ç”Ÿè‚–ã€‚</div>
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div class="mini" style="flex:1">
            <h3>ä¸ƒä»™å¥³ç³»çµ±ï¼ˆè¨±é¡˜ / é‚„é¡˜ï¼‰</h3>
            <div class="small">ç•™å¿µç”¨ï¼šä¸ƒä»™å¥³è·¯å¾‘ f1~f7ã€‚æ¯ç­†è¨±é¡˜å¯åŒ¯å‡º JSON å­˜æª”ã€‚</div>

            <div class="row" style="gap:10px; flex-wrap:wrap">
              <select id="fairySel" style="min-width:180px">
                <option value="f1">f1</option><option value="f2">f2</option><option value="f3">f3</option><option value="f4">f4</option>
                <option value="f5">f5</option><option value="f6">f6</option><option value="f7">f7</option>
              </select>

              <input id="fairyName1" placeholder="f1 åç¨±" style="min-width:160px" />
              <input id="fairyName2" placeholder="f2 åç¨±" style="min-width:160px" />
              <input id="fairyName3" placeholder="f3 åç¨±" style="min-width:160px" />
              <input id="fairyName4" placeholder="f4 åç¨±" style="min-width:160px" />
              <input id="fairyName5" placeholder="f5 åç¨±" style="min-width:160px" />
              <input id="fairyName6" placeholder="f6 åç¨±" style="min-width:160px" />
              <input id="fairyName7" placeholder="f7 åç¨±" style="min-width:160px" />
              <button class="btn2" id="btnSaveFairies">ä¿å­˜ä¸ƒä»™å¥³åç¨±</button>
            </div>

            <div class="mini" style="margin-top:10px">
              <h3>ä¸ƒä»™å¥³åº§æ¨™ï¼ˆå›ºå®šï¼‰</h3>
              <div id="fairyMeta" class="small"></div>
        <div style="margin-top:12px; padding:12px; border:1px solid rgba(255,255,255,.12); border-radius:16px; background:rgba(0,0,0,.18);">
          <div style="font-weight:1000; margin-bottom:8px;">ä¸ƒä»™å¥³ä½å€ãƒ»è·å¸ãƒ»äº¤æ˜“è±¡å¾µï¼ˆå›ºå®šï¼‰</div>
          <div id="fairyIntroList" style="display:grid; grid-template-columns:1fr; gap:10px;"></div>
          <div style="margin-top:10px; font-size:12px; opacity:.85;">
            ä½ å¯ä»¥æŠŠä¸ƒä»™å¥³ç•¶ä½œã€Œè¨±é¡˜ç­–ç•¥é¢æ¿ã€ï¼šåšå¤š/åšç©º/å¤šå–®é€€ï¼Œæ˜¯è±¡å¾µå¸‚å ´ç¯€å¥ï¼Œä¸æ˜¯æŠ•è³‡å»ºè­°ã€‚
          </div>
        </div>

            </div>

            <div class="row" style="margin-top:10px">
              <div class="mini" style="flex:1">
                <h3>è¨±é¡˜å…§å®¹</h3>
                <textarea id="wish" placeholder="å¯«ä¸‹ä½ çš„é¡˜æœ›ï¼ˆç•™å¿µç”¨ï¼‰"></textarea>
              </div>
              <div class="mini" style="flex:1">
                <h3>é‚„é¡˜ï¼ˆå‚™è¨»ï¼‰</h3>
                <textarea id="vow" placeholder="é‚„é¡˜èªªæ˜ï¼ˆç•™å¿µç”¨ï¼‰"></textarea>
              </div>
            </div>

            <div class="row" style="margin-top:10px; gap:10px">
              <button class="btn" id="btnWish">é€å‡ºè¨±é¡˜</button>
              <button class="btn" id="btnVow">é€å‡ºé‚„é¡˜</button>
              <button class="btn2" id="btnExportTemple">åŒ¯å‡ºå¤–æ®¿ï¼ˆJSONï¼‰</button>
              <button class="btn2" id="btnResetTemple">é‡ç½®å¤–æ®¿è³‡æ–™ï¼ˆæœ¬æ©Ÿï¼‰</button>
            </div>
          </div>
        </div>

        <div class="sep"></div>
        <div class="log" id="templeLog"></div>
      </div>

  <!-- RIGHT: AI Customer Service -->
  <div class="card">
    <div class="card-h">
      <div>
        <h2>AI å½±åƒèªéŸ³å®¢æœ</h2>
        <div class="sub">è‡ªå‹•åµæ¸¬ STT/TTSï½œä¸æ”¯æ´æ™‚è‡ªå‹•é™ç´š</div>
      </div>
      <div class="row" style="flex-wrap:nowrap; gap:8px">
        <span class="badge" id="bTTS">TTS</span>
        <span class="badge" id="bSTT">STT</span>
        <span class="badge" id="bETH">Wallet</span>
      </div>
    </div>

    <div class="card-b">
      <div class="avatar" id="aiAvatar" aria-label="AI Avatar">
        <svg width="62" height="62" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M32 6C22 6 14 14 14 24v10c0 10 8 18 18 18s18-8 18-18V24C50 14 42 6 32 6Z" stroke="rgba(232,238,252,.92)" stroke-width="2.6"/>
          <path d="M22 28c3-4 17-4 20 0" stroke="rgba(45,212,191,.92)" stroke-width="3" stroke-linecap="round"/>
          <path d="M23 39c6 6 12 6 18 0" stroke="rgba(59,130,246,.92)" stroke-width="3" stroke-linecap="round"/>
          <circle cx="25" cy="25" r="2.8" fill="rgba(232,238,252,.9)"/>
          <circle cx="39" cy="25" r="2.8" fill="rgba(232,238,252,.9)"/>
        </svg>
      </div>

      <div class="mini">
        <h3>å®¢æœè¼¸å…¥</h3>
        <textarea id="aiInput" placeholder="ä½ å¯ä»¥æ‰“å­—å•ï¼šéŒ¢åŒ…æ€éº¼è£ï¼Ÿæ€éº¼ä¸‹å–®ï¼ŸT+2 æ€éº¼ç®—ï¼Ÿ"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnAsk">é€å‡º</button>
          <button class="btn2" id="btnTTS">èªéŸ³å”¸å‡º</button>
          <button class="btn" id="btnSTT">èªéŸ³è¼¸å…¥</button>
          <button class="btn2" id="btnStopSTT">åœæ­¢</button>
        </div>
        <div class="hint" id="aiHint"></div>
      </div>

      <div class="sep"></div>

      <div class="mini">
        <h3>å®¢æœå›è¦†</h3>
        <div id="aiAnswer" class="small" style="text-align:left; line-height:1.7"></div>
      </div>

      <div class="sep"></div>

      <div class="mini">
        <h3>éŒ¢åŒ…æ•™å­¸ï¼ˆå¾ 0 åˆ°èƒ½ä¸‹å–®ï¼‰</h3>
        <div class="small" style="text-align:left; line-height:1.7">
          1) å…ˆæº–å‚™ EVM éŒ¢åŒ…ï¼ˆMetaMaskï¼‰ã€‚<br>
          2) åˆ‡åˆ° BNB Chainï¼ˆBSC / BEP20ï¼‰ã€‚<br>
          3) åŒ¯å…¥ KGEN ä»£å¹£åˆç´„åœ°å€ï¼ˆä½ å·²éƒ¨ç½²çš„ KGENï¼‰ã€‚<br>
          4) æº–å‚™å°‘é‡ BNB ä½œ gasã€‚<br>
          5) æœ¬ç‰ˆä¸‹å–®æ¡Œç‚º T+2 æ¨¡æ“¬ï¼›è¦ä¸ŠéˆçœŸä¸‹å–®éœ€è¦æ¥ã€Œå¿ƒè‡Ÿ/ç„¡äººéŠ€è¡Œ/å¤§è…¦ã€è¡€ç®¡ï¼Œåˆ†å·¥æ¸…æ¥šæ‰ä¸æ’æ–¥ã€‚
        </div>
      </div>
    </div>
  </div>

</div>

<div class="sticky-actions">
  <div class="row">
    <button class="btn" id="btnModeCockpit">å›é§•é§›è‰™</button>
    <button class="btn" id="btnModeOrder">å›ä¸‹å–®æ¡Œ</button>
    <button class="btn2" id="btnModeTemple">å›å¤–æ®¿</button>
    <button class="btn2" id="btnGoWallet">å®‡å®™ç´°åŒ…</button>
    <button class="btn2" id="btnGoShop">å®‡å®™å•†åº—</button>
    <button class="btn2" id="btnClearLog">æ¸…ç©º Log</button>
  </div>
</div>

<script>
/* =========================
   V4.3 FULLPACK Core
   - Self detection (TTS/STT/Wallet)
   - Cross-environment safe downloads
   - No external deps
========================= */

const BOOT_VERSION = "v4.5.1-wuzhishan12345-temple-vitals-ai";
const LAMP_FEE_KGEN = 108; // å…‰æ˜ç‡ˆé¦™æ²¹éŒ¢ï¼ˆè³ªé‡ï¼‰

// ---- ä¸ƒä»™å¥³ï¼ˆå›ºå®šæ˜Ÿåº§åº§æ¨™/è·å¸/å¤šç©ºï¼‰é è¨­è¡¨ ----
const FAIRIES_META_V1 = [
  {id:"f1", point:14520, name:"å·§é›²", star:"å¤©æ¨", mode:"åšç©º", duty:"é¢¨èª¿é›¨é †"},
  {id:"f2", point:14866, name:"å·§è™¹", star:"å¤©ç’‡", mode:"åšå¤š", duty:"å®¶åº­ç¾æ»¿"},
  {id:"f3", point:16184, name:"å·§èŠ", star:"å¤©ç’£", mode:"åšç©º", duty:"è‚²å­æ”¶é©š"},
  {id:"f4", point:16888, name:"å·§ä»™", star:"å¤©æ¬Š", mode:"åšå¤š", duty:"äº‹æ¥­é‹é€š"},
  {id:"f5", point:17347, name:"å·§è˜­", star:"å¤©è¡¡", mode:"åšç©º", duty:"é•·å‘½ç™¾æ­²"},
  {id:"f6", point:18056, name:"å·§æ¢…", star:"é—“é™½", mode:"åšå¤š", duty:"èº«é«”å¥åº·"},
  {id:"f7", point:18459, name:"å·§éˆ", star:"ç‘¤å…‰", mode:"å¤šé€€", duty:"æ„Ÿæƒ…åœ“æ»¿"}
];
const logEl = document.getElementById("log");
const bootLine = document.getElementById("bootLine");
bootLine.textContent = "boot_version=" + BOOT_VERSION;

function nowISO(){ return new Date().toISOString(); }
function log(msg){
  if(!logEl) return;
  logEl.innerHTML += `[${nowISO()}] ${msg}<br>`;
  logEl.scrollTop = logEl.scrollHeight;
}

function safeBool(v){ return v ? "true" : "false"; }

function badge(el, state){
  el.classList.remove("ok","warn","bad");
  if(state === "ok") el.classList.add("ok");
  if(state === "warn") el.classList.add("warn");
  if(state === "bad") el.classList.add("bad");
}

function setBadgeText(el, txt){ el.textContent = txt; }

log("selfcheck_start");
log("userAgent: " + (navigator.userAgent || ""));
const hasTTS = !!window.speechSynthesis;
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
const hasSTT = !!SR;
const hasWallet = !!window.ethereum;

log("speechSynthesis: " + safeBool(hasTTS));
log("speechRecognition: " + safeBool(hasSTT));
log("ethereum_injected_now: " + safeBool(hasWallet));

const bTTS = document.getElementById("bTTS");
const bSTT = document.getElementById("bSTT");
const bETH = document.getElementById("bETH");

setBadgeText(bTTS, "TTS " + (hasTTS ? "ON" : "OFF"));
badge(bTTS, hasTTS ? "ok" : "bad");

setBadgeText(bSTT, "STT " + (hasSTT ? "ON" : "OFF"));
badge(bSTT, hasSTT ? "ok" : "bad");

setBadgeText(bETH, "Wallet " + (hasWallet ? "ON" : "OFF"));
badge(bETH, hasWallet ? "ok" : "warn");

/* ========== Tabs ========== */
const tabs = Array.from(document.querySelectorAll(".tab"));
function showTab(key){
  document.getElementById("tab_cockpit").classList.toggle("hidden", key !== "cockpit");
  document.getElementById("tab_orderdesk").classList.toggle("hidden", key !== "orderdesk");
  document.getElementById("tab_temple").classList.toggle("hidden", key !== "temple");
  tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === key));
  log("tab=" + key);
}
tabs.forEach(t => t.addEventListener("click", () => showTab(t.dataset.tab)));

document.getElementById("btnModeCockpit").onclick = () => showTab("cockpit");
document.getElementById("btnModeOrder").onclick = () => showTab("orderdesk");
document.getElementById("btnModeTemple").onclick = () => showTab("temple");

/* ========== Cockpit state ========== */
const massInput = document.getElementById("massInput");
const massKgen = document.getElementById("massKgen");
const energyE = document.getElementById("energyE");
const levRange = document.getElementById("levRange");
const levRangeLabel = document.getElementById("levRangeLabel");
const lev = document.getElementById("lev");
const degRange = document.getElementById("degRange");
const degRangeLabel = document.getElementById("degRangeLabel");
const deg = document.getElementById("deg");
const stanceLabel = document.getElementById("stanceLabel");

const fuelMaxLabel = document.getElementById("fuelMaxLabel");
const fuelNowLabel = document.getElementById("fuelNowLabel");
const fuelLabel = document.getElementById("fuelLabel");
const fuelBar = document.getElementById("fuelBar");

let state = {
  massKgen: 30000,
  leverage: 10,
  directionDeg: 120,
  fuelMax: 50000, // UI max cap; can be changed later
  lastEvents: [],
  temple: { lamps: [], wishes: [], vows: [] },
  orders: []
};

function stanceFromDeg(d){
  if(d >= 0 && d < 170) return "å¤š";
  if(d >= 170 && d <= 190) return "ä¼‘æ¯";
  return "ç©º";
}

function clamp(n, a, b){ return Math.min(b, Math.max(a, n)); }

function renderCockpit(){
  state.massKgen = clamp(parseInt(massInput.value || "0",10) || 0, 0, 10_000_000);
  massKgen.textContent = String(state.massKgen);
  // Energy: keep proportional for now (user wants mass visible; energy reflects after input)
  energyE.textContent = String(state.massKgen);

  state.leverage = clamp(parseInt(levRange.value || "1",10) || 1, 1, 150);
  levRangeLabel.textContent = String(state.leverage);
  lev.textContent = String(state.leverage);

  state.directionDeg = clamp(parseInt(degRange.value || "0",10) || 0, 0, 360);
  degRangeLabel.textContent = String(state.directionDeg);
  deg.textContent = String(state.directionDeg);
  const st = stanceFromDeg(state.directionDeg);
  stanceLabel.textContent = st;

  const fuelNow = clamp(state.massKgen, 0, state.fuelMax);
  const pct = state.fuelMax <= 0 ? 0 : Math.round((fuelNow / state.fuelMax) * 100);
  fuelMaxLabel.textContent = String(state.fuelMax);
  fuelNowLabel.textContent = String(fuelNow);
  fuelLabel.textContent = pct + "%";
  fuelBar.style.width = pct + "%";
}

massInput.addEventListener("input", () => { renderCockpit(); log("mass_changed=" + massInput.value); });
levRange.addEventListener("input", () => { renderCockpit(); log("leverage=" + levRange.value); });
degRange.addEventListener("input", () => { renderCockpit(); log("direction=" + degRange.value); });

renderCockpit();

/* ========== Event buttons (must always respond) ========== */
function pushEvent(name){
  state.lastEvents.push({t: nowISO(), e: name});
  if(state.lastEvents.length > 50) state.lastEvents.shift();
  log(name);
}

document.getElementById("btnHeartbeat").onclick = () => pushEvent("heartbeat");
document.getElementById("btnBreath").onclick = () => pushEvent("breath");
document.getElementById("btnPressure").onclick = () => pushEvent("pressure");
document.getElementById("btnCup").onclick = () => pushEvent("cup_throw");
document.getElementById("btnFortune").onclick = () => pushEvent("fortune_click");

/* ========== Selftest ========== */
document.getElementById("btnSelfTest").onclick = () => {
  log("selftest_run");
  const checks = [
    ["TTS", hasTTS],
    ["STT", hasSTT],
    ["Wallet", hasWallet],
    ["Clipboard", !!navigator.clipboard],
    ["DownloadAnchor", true]
  ];
  checks.forEach(([k,v]) => log(`selftest_${k}=${v ? "OK":"FAIL"}`));
  // Probe user interaction chain: create a tiny toast via log
  log("selftest_done");
};

/* ========== Robust JSON export/download ========== */
function downloadText(filename, text){
  try{
    const blob = new Blob([text], {type:"application/json;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
    log("export_download_try");
    return true;
  }catch(e){
    log("export_download_fail " + (e && e.message ? e.message : String(e)));
    return false;
  }
}

async function copyToClipboard(text){
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(text);
      log("clipboard_copied");
      return true;
    }
  }catch(e){
    log("clipboard_copy_fail " + (e && e.message ? e.message : String(e)));
  }
  return false;
}

function exportStatePayload(){
  return {
    boot_version: BOOT_VERSION,
    exported_at: nowISO(),
    userAgent: navigator.userAgent || "",
    state: state
  };
}

document.getElementById("btnExportState").onclick = async () => {
  const payload = exportStatePayload();
  const text = JSON.stringify(payload, null, 2);
  const ok = downloadText(`wuzhishan_state_${new Date().toISOString().slice(0,10)}.json`, text);
  if(!ok){
    await copyToClipboard(text);
    alert("æ­¤ç’°å¢ƒå¯èƒ½é˜»æ“‹ä¸‹è¼‰ï¼›å·²æ”¹ç”¨å‰ªè²¼ç°¿å‚™æ´ã€‚è«‹è²¼åˆ°è¨˜äº‹æœ¬/é›²ç«¯å­˜æª”ã€‚");
  }
};

document.getElementById("btnImportState").onclick = async () => {
  const input = prompt("è«‹è²¼ä¸Š JSONï¼ˆç‹€æ…‹åŒ¯å…¥ï¼‰");
  if(!input) return;
  try{
    const obj = JSON.parse(input);
    if(!obj || !obj.state) throw new Error("bad_format");
    state = obj.state;
    // Apply to UI
    massInput.value = String(state.massKgen || 0);
    levRange.value = String(state.leverage || 1);
    degRange.value = String(state.directionDeg || 0);
    renderCockpit();
    renderOrdersLog();
    renderTempleLog();
    log("import_ok");
  }catch(e){
    log("import_fail " + (e && e.message ? e.message : String(e)));
    alert("JSON æ ¼å¼éŒ¯èª¤æˆ–ä¸ç›¸å®¹ã€‚");
  }
};

document.getElementById("btnCopyLog").onclick = async () => {
  const text = (logEl.innerText || "").trim();
  const ok = await copyToClipboard(text);
  if(!ok) alert("æ­¤ç’°å¢ƒä¸æ”¯æ´å‰ªè²¼ç°¿ã€‚è«‹æ‰‹å‹•é•·æŒ‰è¤‡è£½ã€‚");
};

document.getElementById("btnClearLog").onclick = () => {
  logEl.innerHTML = "";
  log("log_cleared");
};

/* ========== Order desk ========== */
const tradeDate = document.getElementById("tradeDate");
const settleDate = document.getElementById("settleDate");
const sl = document.getElementById("sl");
const tp = document.getElementById("tp");
const atr14 = document.getElementById("atr14");
const pnlKgen = document.getElementById("pnlKgen");
const ordersLog = document.getElementById("ordersLog");
const csNote = document.getElementById("csNote");

function pad2(n){ return String(n).padStart(2,"0"); }

function todayStr(){
  const d = new Date();
  return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
}
tradeDate.value = todayStr();

function addDays(yyyy_mm_dd, days){
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(yyyy_mm_dd);
  if(!m) return "";
  const d = new Date(parseInt(m[1],10), parseInt(m[2],10)-1, parseInt(m[3],10));
  d.setDate(d.getDate() + days);
  return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
}
function refreshSettle(){
  settleDate.value = addDays(tradeDate.value, 2) || "";
}
tradeDate.addEventListener("input", ()=>{ refreshSettle(); pushEvent("tradeDate=" + tradeDate.value); });
refreshSettle();

function capByATR(x, atr){
  const a = Math.max(0, parseInt(atr,10) || 0);
  const v = parseInt(x,10) || 0;
  return clamp(v, -a, a);
}

function computePnL(sign){
  const atr = parseInt(atr14.value,10) || 0;
  let _sl = parseInt(sl.value,10) || 0;
  let _tp = parseInt(tp.value,10) || 0;

  // Enforce ATR cap
  _sl = clamp(_sl, 0, atr);
  _tp = clamp(_tp, 0, atr);
  sl.value = String(_sl);
  tp.value = String(_tp);

  // direction sign based on stance (å¤š/ç©º/ä¼‘æ¯)
  const st = stanceFromDeg(state.directionDeg);
  let dir = 0;
  if(st === "å¤š") dir = 1;
  if(st === "ç©º") dir = -1;

  // If resting, pnl 0
  if(dir === 0){
    pnlKgen.textContent = "0";
    return 0;
  }

  // sign = "win" or "lose"
  let raw = (sign === "win" ? _tp : -_sl);

  // Multiply by leverage and direction
  let pnl = raw * state.leverage * dir;

  // Rule: if both hit same settle day, pnl 0 (simulate by special case if _sl==_tp and sign=="both")
  pnlKgen.textContent = String(pnl);
  return pnl;
}

document.getElementById("btnSimWin").onclick = () => { const v=computePnL("win"); pushEvent("simulate_win pnl=" + v); };
document.getElementById("btnSimLose").onclick = () => { const v=computePnL("lose"); pushEvent("simulate_lose pnl=" + v); };

function renderOrdersLog(){
  const lines = state.orders.map((o,i)=>`#${i+1} ${o.tradeDate} settle=${o.settleDate} stance=${o.stance} lev=${o.leverage} sl=${o.sl} tp=${o.tp} atr14=${o.atr14} pnl=${o.pnl}`);
  ordersLog.innerHTML = lines.length ? lines.join("<br>") : "(å°šç„¡è¨‚å–®)";
}

document.getElementById("btnSaveOrder").onclick = () => {
  const atr = parseInt(atr14.value,10) || 0;
  const _sl = clamp(parseInt(sl.value,10) || 0, 0, atr);
  const _tp = clamp(parseInt(tp.value,10) || 0, 0, atr);
  const st = stanceFromDeg(state.directionDeg);
  const pnl = parseInt(pnlKgen.textContent,10) || 0;

  const order = {
    id: "O" + Date.now(),
    tradeDate: tradeDate.value,
    settleDate: settleDate.value,
    stance: st,
    leverage: state.leverage,
    massKgen: state.massKgen,
    sl: _sl,
    tp: _tp,
    atr14: atr,
    pnl: pnl,
    note: (csNote.value || "").trim(),
    created_at: nowISO()
  };
  state.orders.push(order);
  if(state.orders.length > 200) state.orders.shift();
  renderOrdersLog();
  pushEvent("order_saved " + order.id);
};

document.getElementById("btnExportOrders").onclick = async () => {
  const payload = {
    boot_version: BOOT_VERSION,
    exported_at: nowISO(),
    orders: state.orders
  };
  const text = JSON.stringify(payload, null, 2);
  const ok = downloadText(`wuzhishan_orders_${new Date().toISOString().slice(0,10)}.json`, text);
  if(!ok){
    await copyToClipboard(text);
    alert("æ­¤ç’°å¢ƒå¯èƒ½é˜»æ“‹ä¸‹è¼‰ï¼›å·²æ”¹ç”¨å‰ªè²¼ç°¿å‚™æ´ã€‚");
  }
};

renderOrdersLog();

/* ========== Temple (13 zodiac / lamps / wishes) ========== */
/* ========== Temple (Zodiac 72 slots + 7 Fairies) ========== */
const templeLog = document.getElementById("templeLog");
const slotGrid  = document.getElementById("slotGrid");
const zodiacSel = document.getElementById("zodiac");
const z13Name   = document.getElementById("zodiac13Name");
const btnSaveZ13= document.getElementById("btnSaveZ13");

const regSlot   = document.getElementById("regSlot");
const regName   = document.getElementById("regName");
const regWallet = document.getElementById("regWallet");
const regNote   = document.getElementById("regNote");
const regHint   = document.getElementById("regHint");

const btnRegister = document.getElementById("btnRegister");
const btnLamp     = document.getElementById("btnLamp");
const btnClearReg = document.getElementById("btnClearReg");

const fairySel = document.getElementById("fairySel");
const btnSaveFairies = document.getElementById("btnSaveFairies");
const wish = document.getElementById("wish");
const vow  = document.getElementById("vow");
const btnWish = document.getElementById("btnWish");
const btnVow  = document.getElementById("btnVow");
const btnExportTemple = document.getElementById("btnExportTemple");
const btnResetTemple  = document.getElementById("btnResetTemple");
const lampFee = document.getElementById("lampFee");

function tlog(msg){
  const ts = new Date().toISOString();
  templeLog.textContent = `[${ts}] ${msg}\n` + (templeLog.textContent || "");
}

const TEMPLE_KEY = "WUKONG_TEMPLE_V44_STATE";
const DEFAULT_FAIRIES = {
  f1:"ä¸ƒä»™å¥³ä¸€", f2:"ä¸ƒä»™å¥³äºŒ", f3:"ä¸ƒä»™å¥³ä¸‰", f4:"ä¸ƒä»™å¥³å››",
  f5:"ä¸ƒä»™å¥³äº”", f6:"ä¸ƒä»™å¥³å…­", f7:"ä¸ƒä»™å¥³ä¸ƒ"
};

function templeLoad(){
  try{
    const raw = localStorage.getItem(TEMPLE_KEY);
    if(!raw) return {
      z13Name:"",
      fairies:{...DEFAULT_FAIRIES},
      registries:{},   // key -> { "1": entry, ... }
      lamps:[],
      wishes:[],
      vows:[]
    };
    const obj = JSON.parse(raw);
    if(!obj.fairies) obj.fairies = {...DEFAULT_FAIRIES};
    if(!obj.registries) obj.registries = {};
    if(!obj.lamps) obj.lamps = [];
    if(!obj.wishes) obj.wishes = [];
    if(!obj.vows) obj.vows = [];
    if(typeof obj.z13Name !== "string") obj.z13Name = "";
    return obj;
  }catch(e){
    return {
      z13Name:"",
      fairies:{...DEFAULT_FAIRIES},
      registries:{},
      lamps:[],
      wishes:[],
      vows:[]
    };
  }
}

function templeSave(){
  try{
    localStorage.setItem(TEMPLE_KEY, JSON.stringify(TEMPLE));
    log("cfg_saved");
  }catch(e){
    log("cfg_save_fail " + (e && e.message ? e.message : String(e)));
  }
}

let TEMPLE = templeLoad();

function zodiacKey(){
  const v = zodiacSel.value;
  if(v !== "Z13") return v;
  const n = (TEMPLE.z13Name || "").trim() || "å®‡å®™";
  return "13:" + n;
}

function zodiacLabel(){
  const v = zodiacSel.value;
  if(v !== "Z13") return v;
  return (TEMPLE.z13Name || "").trim() || "å®‡å®™";
}

function ensureRegistry(key){
  if(!TEMPLE.registries[key]) TEMPLE.registries[key] = {};
  return TEMPLE.registries[key];
}

let selectedSlot = null;

function renderSlots(){
  const key = zodiacKey();
  const reg = ensureRegistry(key);

  slotGrid.innerHTML = "";
  for(let i=1;i<=72;i++){
    const div = document.createElement("div");
    div.className = "slot " + (reg[String(i)] ? "filled" : "empty");
    if(selectedSlot === i) div.className += " sel";
    div.textContent = i;
    div.title = reg[String(i)] ? ("å·²ç™»è¨˜ï¼š" + (reg[String(i)].name || "")) : "ç©ºä½";
    div.addEventListener("click", ()=>{
      selectedSlot = i;
      regSlot.value = String(i);
      const e = reg[String(i)];
      if(e){
        regName.value = e.name || "";
        regWallet.value = e.wallet || "";
        regNote.value = e.note || "";
        regHint.textContent = `å·²é¸åé¡ ${i}ï¼ˆå·²ç™»è¨˜ï¼‰`;
      }else{
        regHint.textContent = `å·²é¸åé¡ ${i}ï¼ˆç©ºä½ï¼‰`;
      }
      renderSlots();
    });
    slotGrid.appendChild(div);
  }
}

function syncFairyInputs(){
  const ids = ["fairyName1","fairyName2","fairyName3","fairyName4","fairyName5","fairyName6","fairyName7"];
  const keys = ["f1","f2","f3","f4","f5","f6","f7"];
  for(let i=0;i<7;i++){
    const el = document.getElementById(ids[i]);
    if(!el) continue;
    el.value = TEMPLE.fairies[keys[i]] || DEFAULT_FAIRIES[keys[i]];
  }
}

function pullFairyInputs(){
  const ids = ["fairyName1","fairyName2","fairyName3","fairyName4","fairyName5","fairyName6","fairyName7"];
  const keys = ["f1","f2","f3","f4","f5","f6","f7"];
  for(let i=0;i<7;i++){
    const el = document.getElementById(ids[i]);
    if(!el) continue;
    const v = (el.value || "").trim();
    if(v) TEMPLE.fairies[keys[i]] = v;
  }
}

function nextEmptySlot(key){
  const reg = ensureRegistry(key);
  for(let i=1;i<=72;i++){
    if(!reg[String(i)]) return i;
  }
  return null;
}

btnSaveZ13.addEventListener("click", ()=>{
  TEMPLE.z13Name = (z13Name.value || "").trim();
  templeSave();
  selectedSlot = null;
  tlog("z13_saved=" + (TEMPLE.z13Name || "å®‡å®™"));
  renderSlots();
});

zodiacSel.addEventListener("change", ()=>{
  selectedSlot = null;
  renderSlots();
  regHint.textContent = `å·²åˆ‡æ›ç”Ÿè‚–ï¼š${zodiacLabel()}`;
});

btnClearReg.addEventListener("click", ()=>{
  regSlot.value = "";
  regName.value = "";
  regWallet.value = "";
  regNote.value = "";
  selectedSlot = null;
  renderSlots();
  tlog("reg_cleared");
});

btnRegister.addEventListener("click", ()=>{
  const key = zodiacKey();
  const reg = ensureRegistry(key);

  const name = (regName.value || "").trim();
  if(!name){ alert("è«‹è¼¸å…¥åå­—/æš±ç¨±"); return; }

  let slot = parseInt((regSlot.value || "").trim(), 10);
  if(!slot || slot<1 || slot>72){
    slot = nextEmptySlot(key);
  }
  if(!slot){ alert("æ­¤ç”Ÿè‚– 72 åé¡å·²æ»¿"); return; }

  if(reg[String(slot)]){
    const ok = confirm(`åé¡ ${slot} å·²æœ‰ç™»è¨˜ï¼Œæ˜¯å¦è¦†è“‹ï¼Ÿ`);
    if(!ok) return;
  }

  reg[String(slot)] = {
    slot,
    zodiac: zodiacLabel(),
    name,
    wallet: (regWallet.value || "").trim(),
    note: (regNote.value || "").trim(),
    ts: new Date().toISOString()
  };

  templeSave();
  selectedSlot = slot;
  renderSlots();
  tlog(`registered zodiac=${key} slot=${slot} name=${name}`);
});

btnLamp.addEventListener("click", ()=>{
  const key = zodiacKey();
  const fee = Number(lampFee.value || 0);
  const slot = selectedSlot || parseInt((regSlot.value||"").trim(),10) || null;
  const name = (regName.value || "").trim() || "(æœªå¡«)";
  const rec = {
    ts: new Date().toISOString(),
    zodiac: zodiacLabel(),
    zodiacKey: key,
    slot,
    name,
    feeKGEN: isFinite(fee) ? fee : 0,
    wallet: (regWallet.value || "").trim()
  };
  TEMPLE.lamps.unshift(rec);
  templeSave();
  tlog(`lamp_added zodiac=${key} slot=${slot||"-"} fee=${rec.feeKGEN}KGEN`);
});

btnSaveFairies.addEventListener("click", ()=>{
  pullFairyInputs();
  templeSave();
  tlog("fairies_saved");
});

function fairyName(fid){
  return TEMPLE.fairies && TEMPLE.fairies[fid] ? TEMPLE.fairies[fid] : fid;
}

btnWish.addEventListener("click", ()=>{
  const fid = fairySel.value;
  const text = (wish.value || "").trim();
  if(!text){ alert("è«‹è¼¸å…¥é¡˜æœ›"); return; }
  const rec = {
    ts: new Date().toISOString(),
    type: "wish",
    route: fid,
    fairy: fairyName(fid),
    zodiac: zodiacLabel(),
    text,
    wallet: currentAccount || ""
  };
  TEMPLE.wishes.unshift(rec);
  templeSave();
  tlog(`wish_route=${fid} fairy=${rec.fairy}`);
  log("wish_route=" + fid);
  log("export_wish_json");
});

btnVow.addEventListener("click", ()=>{
  const fid = fairySel.value;
  const text = (vow.value || "").trim();
  if(!text){ alert("è«‹è¼¸å…¥é‚„é¡˜å…§å®¹"); return; }
  const rec = {
    ts: new Date().toISOString(),
    type: "vow",
    route: fid,
    fairy: fairyName(fid),
    zodiac: zodiacLabel(),
    text,
    wallet: currentAccount || ""
  };
  TEMPLE.vows.unshift(rec);
  templeSave();
  tlog(`vow_route=${fid} fairy=${rec.fairy}`);
});

function showExportOverlay(title, text){
  const wrap = document.createElement("div");
  wrap.style.position = "fixed";
  wrap.style.inset = "0";
  wrap.style.background = "rgba(0,0,0,.65)";
  wrap.style.zIndex = "99999";
  wrap.style.display = "flex";
  wrap.style.alignItems = "center";
  wrap.style.justifyContent = "center";
  wrap.innerHTML = `
    <div style="width:min(860px,92vw); background:#0b0d10; border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:14px;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div style="font-weight:900; font-size:14px;">${title}</div>
        <button id="exClose" class="btn2">é—œé–‰</button>
      </div>
      <div class="small" style="margin-top:6px; opacity:.85">è‹¥ç’°å¢ƒé˜»æ“‹ä¸‹è¼‰ï¼Œè«‹æ”¹ç”¨è¤‡è£½/æ‰‹å‹•å­˜æª”ã€‚</div>
      <textarea id="exTa" style="width:100%; height:320px; margin-top:10px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0f1318; color:#e7eaf0; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">${text.replace(/</g,"&lt;")}</textarea>
      <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
        <button id="exCopy" class="btn">è¤‡è£½ JSON</button>
        <button id="exDl" class="btn">ä¸‹è¼‰ JSON</button>
        <span class="small" id="exHint"></span>
      </div>
    </div>
  `;
  document.body.appendChild(wrap);
  const exTa = wrap.querySelector("#exTa");
  const exHint = wrap.querySelector("#exHint");
  wrap.querySelector("#exClose").onclick = ()=> wrap.remove();
  wrap.querySelector("#exCopy").onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(exTa.value);
      exHint.textContent = "å·²è¤‡è£½";
      log("log_copied");
    }catch(e){
      exHint.textContent = "è¤‡è£½å¤±æ•—ï¼ˆè«‹é•·æŒ‰å…¨é¸è¤‡è£½ï¼‰";
    }
  };
  wrap.querySelector("#exDl").onclick = ()=>{
    try{
      downloadText("wukong_temple_export.json", exTa.value);
      exHint.textContent = "å·²å˜—è©¦ä¸‹è¼‰";
      log("export_download_try");
    }catch(e){
      exHint.textContent = "ä¸‹è¼‰å¤±æ•—ï¼ˆè«‹ç”¨è¤‡è£½ï¼‰";
    }
  };
}

btnExportTemple.addEventListener("click", ()=>{
  const payload = {
    boot_version: BOOT_VERSION,
    exported_at: new Date().toISOString(),
    zodiac13: TEMPLE.z13Name || "",
    fairies: TEMPLE.fairies,
    registries: TEMPLE.registries,
    lamps: TEMPLE.lamps,
    wishes: TEMPLE.wishes,
    vows: TEMPLE.vows
  };
  const text = JSON.stringify(payload, null, 2);
  showExportOverlay("å¤–æ®¿è³‡æ–™åŒ¯å‡ºï¼ˆJSONï¼‰", text);
  tlog("export_temple_json");
  log("export_lamps_json");
});

btnResetTemple.addEventListener("click", ()=>{
  const ok = confirm("ç¢ºèªé‡ç½®å¤–æ®¿è³‡æ–™ï¼Ÿï¼ˆåƒ…æ¸…æœ¬æ©Ÿ localStorageï¼‰");
  if(!ok) return;
  localStorage.removeItem(TEMPLE_KEY);
  TEMPLE = templeLoad();
  z13Name.value = TEMPLE.z13Name || "";
  syncFairyInputs();
  selectedSlot = null;
  renderSlots();
  wish.value = "";
  vow.value = "";
  tlog("temple_reset");
  log("cfg_cleared");
});

/* init */
z13Name.value = TEMPLE.z13Name || "";
syncFairyInputs();
renderSlots();
regHint.textContent = `å·²è¼‰å…¥å¤–æ®¿è³‡æ–™ã€‚ç”Ÿè‚–ï¼š${zodiacLabel()}`;

/* ========== AI Customer Service (local rules, no internet) ========== */
const aiInput = document.getElementById("aiInput");
const aiAnswer = document.getElementById("aiAnswer");
const aiHint = document.getElementById("aiHint");
const btnAsk = document.getElementById("btnAsk");
const btnTTS = document.getElementById("btnTTS");
const btnSTT = document.getElementById("btnSTT");
const btnStopSTT = document.getElementById("btnStopSTT");

function ttsSpeak(text){
  if(!hasTTS){
    log("tts_not_supported");
    return false;
  }
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "zh-TW";
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
    log("tts_spoken");
    return true;
  }catch(e){
    log("tts_fail " + (e && e.message ? e.message : String(e)));
    return false;
  }
}

let rec = null;
function sttStart(){
  if(!hasSTT){
    log("stt_not_supported");
    return;
  }
  try{
    rec = new SR();
    rec.lang = "zh-TW";
    rec.interimResults = false;
    rec.maxAlternatives = 1;
    rec.onresult = (ev) => {
      const text = ev.results && ev.results[0] && ev.results[0][0] ? ev.results[0][0].transcript : "";
      log("stt_text=" + text);
      aiInput.value = text;
      answerAI(text);
    };
    rec.onerror = (e) => {
      log("stt_error " + (e && e.error ? e.error : "unknown"));
      aiHint.textContent = "èªéŸ³è¼¸å…¥åœ¨æ­¤ç’°å¢ƒå¯èƒ½è¢«ä¸­æ–·ï¼ˆWebView/æ¬Šé™/æ‰‹å‹¢é™åˆ¶ï¼‰ã€‚å¯æ”¹ç”¨æ‰“å­—ã€‚";
    };
    rec.onend = () => { log("stt_stop"); };
    rec.start();
    log("stt_start");
  }catch(e){
    log("stt_fail " + (e && e.message ? e.message : String(e)));
  }
}
function sttStop(){
  try{
    if(rec){ rec.stop(); }
  }catch(e){}
}

function answerAI(q){
  const text = (q || "").trim();
  if(!text){
    aiAnswer.innerHTML = "è«‹è¼¸å…¥å•é¡Œã€‚";
    return;
  }
  const lower = text.toLowerCase();

  // Minimal deterministic local "customer service"
  let a = "";
  if(lower.includes("éŒ¢åŒ…") || lower.includes("metamask") || lower.includes("æ€éº¼è£")){
    a = "éŒ¢åŒ…æ•™å­¸ï¼šä¸€ï¼Œå®‰è£ MetaMaskã€‚äºŒï¼Œåˆ‡åˆ° BNB Chainã€‚ä¸‰ï¼ŒåŒ¯å…¥ KGEN ä»£å¹£åˆç´„åœ°å€ã€‚å››ï¼Œæº–å‚™å°‘é‡ BNB ä½œ gasã€‚äº”ï¼Œæœ¬ç‰ˆä¸‹å–®æ¡Œç›®å‰æ˜¯ T+2 æ¨¡æ“¬ï¼›è¦çœŸä¸Šéˆä¸‹å–®ï¼Œéœ€è¦æŠŠä¸‹å–®è¨Šæ¯é€é€² KUFO æˆ–å¿ƒè‡Ÿåˆç´„ï¼Œå†ç”±å¤§è…¦åšçµç®—è¦å‰‡ã€‚";
  } else if(lower.includes("t+2") || lower.includes("çµç®—")){
    a = "æœ¬å®‡å®™è¦å‰‡ï¼šæ‰€æœ‰ K ç·šäº¤æ˜“ä»¥äº¤æ˜“æ—¥ T+2 çµç®—ï¼Œä¸ç”¨é€±ä¸‰çµç®—ã€‚åœåˆ©èˆ‡åœæè‹¥åœ¨åŒä¸€çµç®—æ—¥åŒæ™‚è§¸ç™¼ï¼Œè¦–ç‚º 0ï¼ˆä¸ç®—è¼¸è´ï¼‰ã€‚";
  } else if(lower.includes("æ§“æ¡¿") || lower.includes("å€æ•¸")){
    a = "æ§“æ¡¿ 1 åˆ° 150 å€ã€‚æ§“æ¡¿åªå½±éŸ¿æ¨¡æ“¬è¼¸è´å€ç‡ï¼Œä¸æ”¹è®Šä½ æŠ•å…¥çš„è³ªé‡ï¼ˆKGENï¼‰ã€‚";
  } else if(lower.includes("æ–¹å‘") || lower.includes("å¤šç©º") || lower.includes("æ–¹å‘ç›¤")){
    a = "æ–¹å‘ç›¤ 0 åˆ° 170 åº¦æ˜¯å¤šæ–¹æ‰‡å€ï¼Œ170 åˆ° 190 åº¦æ˜¯ä¼‘æ¯å€ï¼Œ190 åˆ° 360 åº¦æ˜¯ç©ºæ–¹æ‰‡å€ã€‚ä¼‘æ¯å€è¦–ç‚ºä¸ä¸‹å–®ï¼Œè¼¸è´ç‚º 0ã€‚";
  } else if(lower.includes("åŒ¯å‡º") || lower.includes("ä¸‹è¼‰")){
    a = "è‹¥ä½ åœ¨ WebViewï¼ˆä¾‹å¦‚ MetaMask å…§å»ºç€è¦½å™¨ï¼‰é‡åˆ°ä¸‹è¼‰é˜»æ“‹ï¼Œæœ¬ç³»çµ±æœƒè‡ªå‹•æ”¹ç”¨å‰ªè²¼ç°¿å‚™æ´ã€‚ä½ ä¹Ÿå¯ä»¥ç”¨ã€è¤‡è£½ Logã€æŠŠå…§å®¹è²¼åˆ°è¨˜äº‹æœ¬ä¿å­˜ã€‚";
  } else if(lower.includes("atr14") || lower.includes("æœ€å¤§") || lower.includes("åœæ") || lower.includes("åœåˆ©")){
    a = "é¢¨æ§è¦å‰‡ï¼šæœ€å¤§è´è™§å»ºè­°é™åˆ¶åœ¨ Â±ATR14ã€‚ä¸‹å–®æ¡ŒæœƒæŠŠåœåˆ©åœæè‡ªå‹•é™åˆ¶åœ¨ ATR14 ç¯„åœå…§ï¼Œé¿å…è¶…æ¨™ã€‚";
  } else {
    a = "æˆ‘æ”¶åˆ°ä½ çš„å•é¡Œã€‚ä½ å¯ä»¥ç›´æ¥å•ï¼šéŒ¢åŒ…æ€éº¼è£ã€T+2 æ€éº¼ç®—ã€æ§“æ¡¿æ€éº¼èª¿ã€æ–¹å‘ç›¤æ€éº¼åˆ¤å¤šç©ºã€å¦‚ä½•åŒ¯å‡ºç‹€æ…‹ã€‚";
  }

  aiAnswer.innerHTML = a;
  aiHint.textContent = hasTTS ? "å¯æŒ‰ã€èªéŸ³å”¸å‡ºã€è®“å®¢æœç”¨è²éŸ³å›è¦†ã€‚" : "æ­¤ç’°å¢ƒä¸æ”¯æ´èªéŸ³å”¸å‡ºï¼ˆTTS OFFï¼‰ï¼Œå·²è‡ªå‹•é™ç´šç‚ºæ–‡å­—å®¢æœã€‚";
  pushEvent("assistant_answer");
  if(hasTTS) ttsSpeak(a);
}

btnAsk.onclick = () => answerAI(aiInput.value);
btnTTS.onclick = () => ttsSpeak(aiAnswer.innerText || "æ‚Ÿç©ºå®‡å®™å®¢æœåœ¨ç·šã€‚");
btnSTT.onclick = () => sttStart();
btnStopSTT.onclick = () => sttStop();

// Disable buttons based on support
btnTTS.disabled = !hasTTS;
btnSTT.disabled = !hasSTT;

// Initial greet
aiAnsw
/* ===========================
   Temple FULL: Zodiac72 + Fairies Meta + Export Fallback
   =========================== */
function _lsGet(k, d){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):d; }catch(e){ return d; } }
function _lsSet(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); return true; }catch(e){ return false; } }

function downloadText(filename, text){
  try{
    const blob = new Blob([text], {type:"application/json;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
    log("export_download_try");
    return true;
  }catch(e){
    // Fallback: open new tab with data URL
    try{
      const dataUrl = "data:application/json;charset=utf-8," + encodeURIComponent(text);
      window.open(dataUrl, "_blank");
      log("export_fallback_open");
      return true;
    }catch(e2){
      // Final fallback: copy to clipboard
      navigator.clipboard?.writeText(text).then(()=>log("export_fallback_copied")).catch(()=>log("export_failed"));
      return false;
    }
  }
}

function getCurrentZodiacKey(){
  const sel = document.getElementById("zodiac13Sel");
  const custom = document.getElementById("zodiac13Name");
  let z = (sel && sel.value) ? sel.value : "é¼ ";
  if(z === "è‡ªå®š"){
    const name = (custom?.value||"").trim();
    z = name ? name : "è‡ªå®š";
  }
  return "zodiacRoster_"+z;
}

function renderZodiac72(){
  const box = document.getElementById("zodiacSlots");
  if(!box) return;
  const key = getCurrentZodiacKey();
  const roster = _lsGet(key, Array.from({length:72}, ()=>({name:"", note:""})));
  // normalize
  while(roster.length<72) roster.push({name:"", note:""});
  if(roster.length>72) roster.length=72;

  box.innerHTML = "";
  for(let i=0;i<72;i++){
    const it = roster[i] || {name:"", note:""};
    const div = document.createElement("div");
    div.className = "slot";
    div.innerHTML = `
      <div class="n">åé¡ #${i+1}</div>
      <input data-i="${i}" class="zName" placeholder="ç™»è¨˜å§“å / æš±ç¨±" value="${escapeHtml(it.name||"")}" />
      <textarea data-i="${i}" class="zNote" placeholder="å‚™è¨»ï¼ˆå¯ç•™é¡˜æœ›/é‚„é¡˜/è¯çµ¡æ–¹å¼ï¼‰">${escapeHtml(it.note||"")}</textarea>
    `;
    box.appendChild(div);
  }

  let t=null;
  function scheduleSave(){
    clearTimeout(t);
    t=setTimeout(()=>{
      const names = box.querySelectorAll(".zName");
      const notes = box.querySelectorAll(".zNote");
      const out = Array.from({length:72}, (_,idx)=>({
        name: (names[idx]?.value||"").trim(),
        note: (notes[idx]?.value||"").trim()
      }));
      _lsSet(key, out);
      log("cfg_saved");
    }, 250);
  }
  box.querySelectorAll(".zName,.zNote").forEach(el=>{
    el.addEventListener("input", scheduleSave, {passive:true});
  });

  log("zodiac72_rendered");
}

function exportZodiac72(){
  const key = getCurrentZodiacKey();
  const roster = _lsGet(key, []);
  const payload = {
    boot: BOOT_VERSION,
    zodiac_key: key,
    exported_at: new Date().toISOString(),
    roster72: roster
  };
  const txt = JSON.stringify(payload, null, 2);
  downloadText(key+".json", txt);
}

function importZodiac72(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(String(reader.result||"{}"));
      if(!obj || !Array.isArray(obj.roster72)) throw new Error("bad format");
      const key = getCurrentZodiacKey();
      _lsSet(key, obj.roster72);
      renderZodiac72();
      log("zodiac72_imported");
    }catch(e){
      log("zodiac72_import_failed");
      toast("åŒ¯å…¥å¤±æ•—ï¼šJSON æ ¼å¼ä¸æ­£ç¢º");
    }
  };
  reader.readAsText(file);
}

function clearZodiac72(){
  const key = getCurrentZodiacKey();
  _lsSet(key, Array.from({length:72}, ()=>({name:"", note:""})));
  renderZodiac72();
  log("zodiac72_cleared");
}

function applyFairiesDefaults(){
  // If empty, inject default names from FAIRIES_META_V1
  const keys = [1,2,3,4,5,6,7].map(n=>"fairyName"+n);
  const inputs = keys.map(id=>document.getElementById(id)).filter(Boolean);
  const hasAny = inputs.some(i=> (i.value||"").trim().length>0);
  if(!hasAny){
    inputs.forEach((inp, idx)=>{
      const meta = FAIRIES_META_V1[idx];
      inp.value = `${meta.name}ï¼ˆ${meta.star}ï¼‰`;
    });
  }
  // meta display
  const metaBox = document.getElementById("fairyMeta");
  if(metaBox){
    metaBox.innerHTML = FAIRIES_META_V1.map(m=>`<div><b>${m.id.toUpperCase()}</b>ã€€${m.point}ã€€${m.name}ï½œ${m.star}ï½œ${m.duty}ï½œ${m.mode}</div>`).join("");
  }
}

(function templeFullBoot(){
  // Wire buttons (safe even if missing)
  const btnR = document.getElementById("btnZodiacRender");
  const btnE = document.getElementById("btnZodiacExport");
  const btnC = document.getElementById("btnZodiacClear");
  const fileI = document.getElementById("zodiacImportFile");
  btnR && btnR.addEventListener("click", renderZodiac72);
  btnE && btnE.addEventListener("click", exportZodiac72);
  btnC && btnC.addEventListener("click", clearZodiac72);
  fileI && fileI.addEventListener("change", (e)=>{
    const f = e.target.files && e.target.files[0];
    if(f) importZodiac72(f);
    e.target.value = "";
  });

  // When zodiac selector changes, rerender
  const sel = document.getElementById("zodiac13Sel");
  const custom = document.getElementById("zodiac13Name");
  sel && sel.addEventListener("change", ()=>setTimeout(renderZodiac72, 50));
  custom && custom.addEventListener("input", ()=>setTimeout(renderZodiac72, 200));

  // Apply fairies defaults and render meta
  setTimeout(()=>{
    const feeSpan=document.getElementById("lampFeeKgen"); if(feeSpan) feeSpan.textContent=String(LAMP_FEE_KGEN);
    applyFairiesDefaults();
    renderZodiac72();
  }, 60);
})();
aiAnswer.innerHTML = "ä½ å¥½ï¼Œæˆ‘æ˜¯æ‚Ÿç©ºå®‡å®™ AI å®¢æœã€‚ä½ å¯ä»¥å•ï¼šéŒ¢åŒ…æ€éº¼è£ã€T+2 çµç®—ã€æ§“æ¡¿ã€æ–¹å‘ç›¤ã€å¤šç©ºè¦å‰‡ã€åŒ¯å‡ºä¸‹è¼‰ã€‚";
aiHint.textContent = "ç³»çµ±æœƒè‡ªå‹•åµæ¸¬ç’°å¢ƒï¼Œä¸åŒç€è¦½å™¨æœƒè‡ªå‹•é™ç´šã€‚";

/* ========== End ========== */
log("ready");
</script>

<!-- Floating Chain Panel Button -->
<button id="chainBtn" style="position:fixed; left:14px; bottom:calc(18px + env(safe-area-inset-bottom)); z-index:9999;
  padding:12px 14px; border-radius:999px; border:1px solid #111; background:#fff; font-weight:900;">
  âš¡éˆä¸Šãƒ»å¿ƒè‡Ÿ
</button>

<!-- Chain Modal -->
<div id="chainModal" style="position:fixed; inset:0; z-index:10000; display:none; background:rgba(0,0,0,.55);">
  <div style="max-width:720px; margin:5vh auto; background:#fff; border:1px solid #111; border-radius:18px; padding:14px;">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div style="font-weight:900;">æ‚Ÿç©ºè²¡ç¥æ®¿ï½œéˆä¸Šå¿ƒè‡Ÿèˆ‡é»ç‡ˆ</div>
      <button id="chainClose" style="border:1px solid #111; background:#fff; border-radius:10px; padding:6px 10px; font-weight:900;">é—œé–‰</button>
    </div>

    <div style="margin-top:10px; display:grid; grid-template-columns:1fr; gap:10px;">
      <div style="border:1px solid #ddd; border-radius:14px; padding:10px;">
        <div style="font-weight:900; margin-bottom:6px;">A. é€£ç·šç‹€æ…‹</div>
        <div id="chainStatus" style="font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; white-space:pre-wrap;"></div>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
          <button id="btnConnect" style="border:1px solid #111; background:#fff; border-radius:12px; padding:8px 10px; font-weight:900;">é€£çµéŒ¢åŒ…</button>
          <button id="btnRefresh" style="border:1px solid #111; background:#fff; border-radius:12px; padding:8px 10px; font-weight:900;">æ›´æ–°é¤˜é¡</button>
        </div>
      </div>

      <div style="border:1px solid #ddd; border-radius:14px; padding:10px;">
        <div style="font-weight:900; margin-bottom:6px;">B. åˆç´„åœ°å€è¨­å®šï¼ˆå¯ç•™ç©ºï¼å…ˆé›¢ç·šç©ï¼‰</div>
        <div style="display:grid; grid-template-columns:1fr; gap:6px;">
          <label style="display:grid; grid-template-columns:120px 1fr; gap:8px; align-items:center;">
            <div style="font-weight:800;">KGEN</div>
            <input id="cfgKGEN" placeholder="0x..." style="padding:8px; border:1px solid #111; border-radius:10px;" />
          </label>
          <label style="display:grid; grid-template-columns:120px 1fr; gap:8px; align-items:center;">
            <div style="font-weight:800;">å¿ƒè‡Ÿ(ç™¼è²¡é‡‘)</div>
            <input id="cfgHeart" placeholder="0x... (FortuneFaucet)" style="padding:8px; border:1px solid #111; border-radius:10px;" />
          </label>
          <label style="display:grid; grid-template-columns:120px 1fr; gap:8px; align-items:center;">
            <div style="font-weight:800;">å…¬åº«(æ”¶é»ç‡ˆ)</div>
            <input id="cfgTreasury" placeholder="0x... (èŠ±æœå±±å°ç£)" style="padding:8px; border:1px solid #111; border-radius:10px;" />
          </label>
          <label style="display:grid; grid-template-columns:120px 1fr; gap:8px; align-items:center;">
            <div style="font-weight:800;">KUFO</div>
            <input id="cfgKUFO" placeholder="0x... (UnmannedBank)" style="padding:8px; border:1px solid #111; border-radius:10px;" />
          </label>
        </div>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
          <button id="btnSaveCfg" style="border:1px solid #111; background:#fff; border-radius:12px; padding:8px 10px; font-weight:900;">å„²å­˜è¨­å®š</button>
          <button id="btnResetCfg" style="border:1px solid #111; background:#fff; border-radius:12px; padding:8px 10px; font-weight:900;">é‡ç½®è¨­å®š</button>
        </div>
        <div style="margin-top:8px; font-size:12px; opacity:.85;">
          é»ç‡ˆè²»å›ºå®š <b>108 KGEN</b>ï¼ˆä¸æ˜¯ 107ï¼‰ã€‚è‹¥æ²’éŒ¢åŒ…æˆ–æœªéƒ¨ç½²å¿ƒè‡Ÿï¼Œä¾ç„¶å¯é›¢ç·šé»ç‡ˆç•™å¿µèˆ‡åŒ¯å‡ºç´€éŒ„ã€‚
        </div>
      </div>

      <div style="border:1px solid #ddd; border-radius:14px; padding:10px;">
        <div style="font-weight:900; margin-bottom:6px;">C. é»å…‰æ˜ç‡ˆï¼ˆéˆä¸Šæ‰£æ¬¾ï¼‰</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button id="btnLampPay" style="border:1px solid #111; background:#fff; border-radius:12px; padding:8px 10px; font-weight:900;">æ”¯ä»˜ 108 KGEN é»ç‡ˆ</button>
          <button id="btnLampOffline" style="border:1px solid #111; background:#fff; border-radius:12px; padding:8px 10px; font-weight:900;">é›¢ç·šé»ç‡ˆ(ä¸æ‰£æ¬¾)</button>
        </div>
        <div style="margin-top:6px; font-size:12px; opacity:.85;">
          éˆä¸Šæ¨¡å¼ï¼šKGEN ç›´æ¥è½‰åˆ°ã€Œå…¬åº«åœ°å€ã€ã€‚é€™æ¨£ä¸éœ€è¦é¡å¤–ç‡ˆåˆç´„ï¼Œä¹Ÿä¸æœƒè·Ÿå¿ƒè‡ŸåŠŸèƒ½æ‰“æ¶ã€‚
        </div>
      </div>

      <div style="border:1px solid #ddd; border-radius:14px; padding:10px;">
        <div style="font-weight:900; margin-bottom:6px;">D. å¿ƒè‡Ÿï¼ˆç™¼è²¡é‡‘ / é‚„é¡˜ï¼‰</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <button id="btnHeartHeartbeat" style="border:1px solid #111; background:#fff; border-radius:12px; padding:8px 10px; font-weight:900;">æ•´é»å¿ƒè·³é ˜å–</button>
          <button id="btnHeartIgnite" style="border:1px solid #111; background:#fff; border-radius:12px; padding:8px 10px; font-weight:900;">é›¶é»é»ç«é ˜å–</button>
          <button id="btnHeartSalary" style="border:1px solid #111; background:#fff; border-radius:12px; padding:8px 10px; font-weight:900;">æœˆä¿¸é ˜å–</button>
        </div>

        <div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:8px;">
          <div style="border:1px dashed #bbb; border-radius:12px; padding:8px;">
            <div style="font-weight:900;">é‚„é¡˜ï¼ˆVowï¼‰</div>
            <input id="inpVow" type="number" min="0" step="0.01" placeholder="è¼¸å…¥ KGEN æ•¸é‡" style="width:100%; padding:8px; border:1px solid #111; border-radius:10px; margin-top:6px;" />
            <button id="btnVow" style="margin-top:8px; width:100%; border:1px solid #111; background:#fff; border-radius:12px; padding:8px 10px; font-weight:900;">é€å‡ºé‚„é¡˜</button>
          </div>
          <div style="border:1px dashed #bbb; border-radius:12px; padding:8px;">
            <div style="font-weight:900;">è£œè¡€ï¼ˆFund Heartï¼‰</div>
            <input id="inpFund" type="number" min="0" step="0.01" placeholder="è¼¸å…¥ KGEN æ•¸é‡" style="width:100%; padding:8px; border:1px solid #111; border-radius:10px; margin-top:6px;" />
            <button id="btnFund" style="margin-top:8px; width:100%; border:1px solid #111; background:#fff; border-radius:12px; padding:8px 10px; font-weight:900;">æˆæ¬Šä¸¦è£œè¡€</button>
          </div>
        </div>

        <div style="margin-top:8px; font-size:12px; opacity:.85;">
          æ³¨æ„ï¼šå¿ƒè‡Ÿåˆç´„å°šæœªéƒ¨ç½²æ™‚ï¼Œé€™å€æŒ‰éˆ•æœƒæç¤ºã€Œæœªè¨­å®šå¿ƒè‡Ÿåœ°å€ã€ã€‚éƒ¨ç½²å¾ŒæŠŠåœ°å€è²¼é€²ä¾†å³å¯ã€‚
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===============================
   Chain Bridge (KGEN / Heart / KUFO)
   =============================== */
const BOOT_VERSION = "v4.5.1-wuzhishan12345-temple-vitals-ai";
try{ if(typeof log === "function"){ log("boot_version=" + BOOT_VERSION); } }catch(_){}

const CHAIN_CFG_KEY = "wukong_chain_cfg_v1";
const DEFAULT_CFG = {
  kgen: "0xBA3d3810e58735cb6813bC1CDc5458C0d71432Be",
  heart: "",
  treasury: "0xB73D6716005B37BEC742D64482fA26033eE1A4E1",
  kufo: ""
};

const ERC20_ABI = [
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function balanceOf(address) view returns (uint256)",
  "function allowance(address,address) view returns (uint256)",
  "function approve(address,uint256) returns (bool)",
  "function transfer(address,uint256) returns (bool)"
];

const HEART_ABI = [
  "function heartbeatClaim() external",
  "function igniteAndClaim() external",
  "function claimSalary() external",
  "function fund(uint256 amount) external",
  "function vow(uint256 amount) external"
];

let chainCfg = loadChainCfg();
let provider = null, signer = null, walletAddr = null;

function loadChainCfg(){
  try{
    const raw = localStorage.getItem(CHAIN_CFG_KEY);
    if(!raw) return {...DEFAULT_CFG};
    const obj = JSON.parse(raw);
    return {...DEFAULT_CFG, ...obj};
  }catch(_){ return {...DEFAULT_CFG}; }
}
function saveChainCfg(){
  localStorage.setItem(CHAIN_CFG_KEY, JSON.stringify(chainCfg));
}

function setStatus(text){
  const el = document.getElementById("chainStatus");
  if(el) el.textContent = text;
}
function envSummary(){
  const hasMM = !!window.ethereum;
  const hasEthers = !!window.ethers;
  return [
    "wallet=" + (walletAddr || "(not connected)"),
    "ethereum_injected=" + hasMM,
    "ethers_loaded=" + hasEthers,
    "kgen=" + (chainCfg.kgen || "(empty)"),
    "heart=" + (chainCfg.heart || "(empty)"),
    "treasury=" + (chainCfg.treasury || "(empty)"),
    "kufo=" + (chainCfg.kufo || "(empty)")
  ].join("\n");
}

async function connectWallet(){
  if(!window.ethereum){
    toast("æ‰¾ä¸åˆ°éŒ¢åŒ…ï¼ˆMetaMask / éŒ¢åŒ…ç€è¦½å™¨ï¼‰");
    return;
  }
  if(!window.ethers){
    toast("ethers å°šæœªè¼‰å…¥");
    return;
  }
  try{
    provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    walletAddr = await signer.getAddress();
    try{ if(typeof log==="function"){ log("wallet_connected=" + walletAddr); } }catch(_){}
    setStatus(envSummary());
    toast("éŒ¢åŒ…å·²é€£çµ");
  }catch(e){
    toast("éŒ¢åŒ…é€£çµå¤±æ•—");
    try{ if(typeof log==="function"){ log("wallet_connect_failed " + (e?.message||String(e))); } }catch(_){}
  }
}

async function refreshBalances(){
  try{
    setStatus(envSummary());
    if(!signer || !chainCfg.kgen) return;
    const kgen = new ethers.Contract(chainCfg.kgen, ERC20_ABI, signer);
    const dec = await kgen.decimals();
    const bal = await kgen.balanceOf(walletAddr);
    const balFmt = ethers.utils.formatUnits(bal, dec);
    let extra = "\nKGEN_balance=" + balFmt;
    if(chainCfg.heart){
      const allow = await kgen.allowance(walletAddr, chainCfg.heart);
      extra += "\nallow_to_heart=" + ethers.utils.formatUnits(allow, dec);
    }
    setStatus(envSummary() + extra);
  }catch(e){
    toast("æ›´æ–°é¤˜é¡å¤±æ•—");
    try{ if(typeof log==="function"){ log("balance_fail " + (e?.message||String(e))); } }catch(_){}
  }
}

async function lampPay108(){
  if(!signer){ toast("è«‹å…ˆé€£çµéŒ¢åŒ…"); return; }
  if(!chainCfg.kgen || !chainCfg.treasury){ toast("è«‹å…ˆè¨­å®š KGEN èˆ‡å…¬åº«åœ°å€"); return; }
  try{
    const kgen = new ethers.Contract(chainCfg.kgen, ERC20_ABI, signer);
    const dec = await kgen.decimals();
    const amt = ethers.utils.parseUnits("108", dec);
    const tx = await kgen.transfer(chainCfg.treasury, amt);
    toast("å·²é€å‡ºé»ç‡ˆäº¤æ˜“");
    try{ if(typeof log==="function"){ log("lamp_pay_tx " + tx.hash); } }catch(_){}
    await tx.wait();
    toast("é»ç‡ˆå®Œæˆï¼ˆéˆä¸Šï¼‰");
    // record locally too
    try{ if(typeof addLampRecord==="function"){ addLampRecord({mode:"onchain", amount:108, treasury:chainCfg.treasury, tx:tx.hash}); } }catch(_){}
    await refreshBalances();
  }catch(e){
    toast("é»ç‡ˆå¤±æ•—");
    try{ if(typeof log==="function"){ log("lamp_pay_fail " + (e?.message||String(e))); } }catch(_){}
  }
}

function lampOffline(){
  try{
    if(typeof addLampRecord==="function"){ addLampRecord({mode:"offline", amount:108, treasury:"(offline)", tx:""}); }
    toast("é›¢ç·šé»ç‡ˆå·²è¨˜éŒ„");
  }catch(e){
    toast("é›¢ç·šé»ç‡ˆå¤±æ•—");
  }
}

function requireHeart(){
  if(!chainCfg.heart){ toast("æœªè¨­å®šå¿ƒè‡Ÿåœ°å€"); return null; }
  if(!signer){ toast("è«‹å…ˆé€£çµéŒ¢åŒ…"); return null; }
  return new ethers.Contract(chainCfg.heart, HEART_ABI, signer);
}

async function heartHeartbeat(){
  const heart = requireHeart(); if(!heart) return;
  try{
    const tx = await heart.heartbeatClaim();
    toast("å¿ƒè·³äº¤æ˜“å·²é€å‡º");
    try{ if(typeof log==="function"){ log("heart_heartbeat_tx " + tx.hash); } }catch(_){}
    await tx.wait();
    toast("å·²é ˜å–å¿ƒè·³ç™¼è²¡é‡‘");
    await refreshBalances();
  }catch(e){
    toast("å¿ƒè·³é ˜å–å¤±æ•—");
    try{ if(typeof log==="function"){ log("heart_heartbeat_fail " + (e?.message||String(e))); } }catch(_){}
  }
}
async function heartIgnite(){
  const heart = requireHeart(); if(!heart) return;
  try{
    const tx = await heart.igniteAndClaim();
    toast("é»ç«äº¤æ˜“å·²é€å‡º");
    try{ if(typeof log==="function"){ log("heart_ignite_tx " + tx.hash); } }catch(_){}
    await tx.wait();
    toast("å·²é ˜å–é»ç«ç™¼è²¡é‡‘");
    await refreshBalances();
  }catch(e){
    toast("é»ç«é ˜å–å¤±æ•—");
    try{ if(typeof log==="function"){ log("heart_ignite_fail " + (e?.message||String(e))); } }catch(_){}
  }
}
async function heartSalary(){
  const heart = requireHeart(); if(!heart) return;
  try{
    const tx = await heart.claimSalary();
    toast("æœˆä¿¸äº¤æ˜“å·²é€å‡º");
    try{ if(typeof log==="function"){ log("heart_salary_tx " + tx.hash); } }catch(_){}
    await tx.wait();
    toast("å·²é ˜å–æœˆä¿¸");
    await refreshBalances();
  }catch(e){
    toast("æœˆä¿¸é ˜å–å¤±æ•—");
    try{ if(typeof log==="function"){ log("heart_salary_fail " + (e?.message||String(e))); } }catch(_){}
  }
}
async function heartVow(){
  const heart = requireHeart(); if(!heart) return;
  const v = document.getElementById("inpVow")?.value || "";
  const amtNum = Number(v);
  if(!amtNum || amtNum<=0){ toast("è«‹è¼¸å…¥é‚„é¡˜æ•¸é‡"); return; }
  try{
    const kgen = new ethers.Contract(chainCfg.kgen, ERC20_ABI, signer);
    const dec = await kgen.decimals();
    const amt = ethers.utils.parseUnits(String(amtNum), dec);
    // approve heart
    const allow = await kgen.allowance(walletAddr, chainCfg.heart);
    if(allow.lt(amt)){
      const tx1 = await kgen.approve(chainCfg.heart, amt);
      toast("æˆæ¬Šä¸­â€¦");
      await tx1.wait();
    }
    const tx = await heart.vow(amt);
    toast("é‚„é¡˜äº¤æ˜“å·²é€å‡º");
    try{ if(typeof log==="function"){ log("heart_vow_tx " + tx.hash); } }catch(_){}
    await tx.wait();
    toast("é‚„é¡˜å®Œæˆ");
    await refreshBalances();
  }catch(e){
    toast("é‚„é¡˜å¤±æ•—");
    try{ if(typeof log==="function"){ log("heart_vow_fail " + (e?.message||String(e))); } }catch(_){}
  }
}
async function heartFund(){
  const heart = requireHeart(); if(!heart) return;
  const v = document.getElementById("inpFund")?.value || "";
  const amtNum = Number(v);
  if(!amtNum || amtNum<=0){ toast("è«‹è¼¸å…¥è£œè¡€æ•¸é‡"); return; }
  try{
    const kgen = new ethers.Contract(chainCfg.kgen, ERC20_ABI, signer);
    const dec = await kgen.decimals();
    const amt = ethers.utils.parseUnits(String(amtNum), dec);
    const allow = await kgen.allowance(walletAddr, chainCfg.heart);
    if(allow.lt(amt)){
      const tx1 = await kgen.approve(chainCfg.heart, amt);
      toast("æˆæ¬Šä¸­â€¦");
      await tx1.wait();
    }
    const tx = await heart.fund(amt);
    toast("è£œè¡€äº¤æ˜“å·²é€å‡º");
    try{ if(typeof log==="function"){ log("heart_fund_tx " + tx.hash); } }catch(_){}
    await tx.wait();
    toast("è£œè¡€å®Œæˆ");
    await refreshBalances();
  }catch(e){
    toast("è£œè¡€å¤±æ•—");
    try{ if(typeof log==="function"){ log("heart_fund_fail " + (e?.message||String(e))); } }catch(_){}
  }
}

// UI wiring
(function initChainUI(){
  const $ = (id)=>document.getElementById(id);
  $("cfgKGEN").value = chainCfg.kgen || "";
  $("cfgHeart").value = chainCfg.heart || "";
  $("cfgTreasury").value = chainCfg.treasury || "";
  $("cfgKUFO").value = chainCfg.kufo || "";

  $("chainBtn").onclick = ()=>{ $("chainModal").style.display="block"; setStatus(envSummary()); };
  $("chainClose").onclick = ()=>{ $("chainModal").style.display="none"; };

  $("btnConnect").onclick = connectWallet;
  $("btnRefresh").onclick = refreshBalances;

  $("btnSaveCfg").onclick = ()=>{
    chainCfg.kgen = $("cfgKGEN").value.trim();
    chainCfg.heart = $("cfgHeart").value.trim();
    chainCfg.treasury = $("cfgTreasury").value.trim();
    chainCfg.kufo = $("cfgKUFO").value.trim();
    saveChainCfg();
    toast("è¨­å®šå·²å„²å­˜");
    setStatus(envSummary());
  };
  $("btnResetCfg").onclick = ()=>{
    chainCfg = {...DEFAULT_CFG};
    saveChainCfg();
    $("cfgKGEN").value = chainCfg.kgen;
    $("cfgHeart").value = chainCfg.heart;
    $("cfgTreasury").value = chainCfg.treasury;
    $("cfgKUFO").value = chainCfg.kufo;
    toast("è¨­å®šå·²é‡ç½®");
    setStatus(envSummary());
  };

  $("btnLampPay").onclick = lampPay108;
  $("btnLampOffline").onclick = lampOffline;

  $("btnHeartHeartbeat").onclick = heartHeartbeat;
  $("btnHeartIgnite").onclick = heartIgnite;
  $("btnHeartSalary").onclick = heartSalary;
  $("btnVow").onclick = heartVow;
  $("btnFund").onclick = heartFund;

  // Auto update status
  setStatus(envSummary());
})();
</script>

<script>
(() => {
  // =========================
  // WUZHISHAN 12345 Â· TEMPLE CORE
  // Boot: v4.5.1
  // =========================

  const BOOT = "v4.5.1-wuzhishan12345-temple-vitals-ai";

  // ---- Default on-chain addresses (can be overwritten in UI inputs)
  const DEFAULTS = {
    KGEN: "0xBA3d3810e58735cb6813bC1CDc5458C0d71432Be",
    HEART: "", // set after deploy
    KUFO: "0xef83804c264B47378FCf150086943B53fB90A90b",
    TREASURY: "0xB73D6716005B37BEC742D64482fA26033eE1A4E1",
    BANK: "0xfc522243e988a837700CaD600D6f030f5932681F",
    BRAIN: "" // set after deploy
  };

  // ---- ABIs (minimal fragments)
  const ERC20_ABI = [
    "function balanceOf(address) view returns (uint256)",
    "function decimals() view returns (uint8)",
    "function symbol() view returns (string)",
    "function approve(address spender, uint256 amount) returns (bool)",
    "function allowance(address owner, address spender) view returns (uint256)",
    "function transfer(address to, uint256 amount) returns (bool)"
  ];

  const HEART_ABI = [
    "function igniteAndClaim() returns (bool)",
    "function heartbeatClaim() returns (bool)",
    "function fortuneClaim(uint256 amount) returns (bool)",
    "function canIgnite(address user) view returns (bool ok, string reason)",
    "function canHeartbeat(address user) view returns (bool ok, string reason)",
    "function canFortune(address user, uint256 amount) view returns (bool ok, string reason)",
    "function faucetBalance() view returns (uint256)",
    "event FortuneClaim(address indexed user, uint256 amount)",
    "event HeartbeatClaim(address indexed user, uint256 amount)",
    "event Ignite(address indexed user, uint256 amount)"
  ];

  // ---- Fairies fixed data
  const FAIRIES = [
    { id: "f1", coord: 14520, title: "å¤§ä»™å¥³", name: "å·§é›²", star: "å¤©æ¨", duty: "é¢¨èª¿é›¨é †", side: "åšç©º" },
    { id: "f2", coord: 14866, title: "äºŒä»™å¥³", name: "å·§è™¹", star: "å¤©ç’‡", duty: "å®¶åº­ç¾æ»¿", side: "åšå¤š" },
    { id: "f3", coord: 16184, title: "ä¸‰ä»™å¥³", name: "å·§èŠ", star: "å¤©ç’£", duty: "è‚²å­æ”¶é©š", side: "åšç©º" },
    { id: "f4", coord: 16888, title: "å››ä»™å¥³", name: "å·§ä»™", star: "å¤©æ¬Š", duty: "äº‹æ¥­é‹é€š", side: "åšå¤š" },
    { id: "f5", coord: 17347, title: "äº”ä»™å¥³", name: "å·§è˜­", star: "å¤©è¡¡", duty: "é•·å‘½ç™¾æ­²", side: "åšç©º" },
    { id: "f6", coord: 18056, title: "å…­ä»™å¥³", name: "å·§æ¢…", star: "é—“é™½", duty: "èº«é«”å¥åº·", side: "åšå¤š" },
    { id: "f7", coord: 18459, title: "ä¸ƒä»™å¥³", name: "å·§éˆ", star: "ç‘¤å…‰", duty: "æ„Ÿæƒ…åœ“æ»¿", side: "å¤šå–®é€€" }
  ];

  // ---- Helpers
  const $ = (id) => document.getElementById(id);
  const now = () => new Date().toLocaleString();
  const lsGet = (k, d=null) => { try { const v = localStorage.getItem(k); return v==null? d : JSON.parse(v);} catch { return d; } };
  const lsSet = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };

  function log(msg, where="templeLog") {
    const el = $(where);
    if (!el) return;
    const line = `[${now()}] ${msg}\n`;
    el.value = (el.value || "") + line;
    el.scrollTop = el.scrollHeight;
  }

  function toast(msg) {
    log(msg);
    const s = $("vitalStatus");
    if (s) s.textContent = msg;
    speak(msg);
  }

  function speak(text) {
    // graceful degradation: if speech is not available, do nothing (text + log still works)
    try {
      if (!("speechSynthesis" in window)) return;
      const u = new SpeechSynthesisUtterance(String(text).slice(0, 220));
      u.rate = 1.02;
      u.pitch = 1.0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    } catch {}
  }

  
// --- Click Echo (sound) & Button Voice ---
let __audioCtx = null;
function beep(freq=880, duration=0.06, volume=0.03){
  try{
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!AC) return;
    if(!__audioCtx) __audioCtx = new AC();
    const ctx = __audioCtx;
    if(ctx.state === "suspended"){ ctx.resume().catch(()=>{}); }
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.value = freq;
    g.gain.value = volume;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime + duration);
  }catch(e){ /* ignore */ }
}

function getLabel(el){
  if(!el) return "";
  const ds = el.getAttribute && el.getAttribute("data-say");
  if(ds) return ds.trim();
  const aria = el.getAttribute && el.getAttribute("aria-label");
  if(aria) return aria.trim();
  const t = (el.textContent || "").replace(/\s+/g," ").trim();
  return t.slice(0, 24);
}

// Any click on button/link -> beep + (optional) speak.
function attachClickEcho(){
  document.addEventListener("click", (ev)=>{
    const el = ev.target && ev.target.closest ? ev.target.closest("button, a, .pill, .tab, .chip") : null;
    if(!el) return;
    // Always beep for "æŒ‰éµæœ‰å›è²"
    beep(880, 0.05, 0.025);

    // Optional voice echo: only when TTS is ON and speechSynthesis is available
    const v = (ttsModeSel && ttsModeSel.value) ? ttsModeSel.value : "auto";
    const allowVoice = (v === "tts") || (v === "auto" && !!window.speechSynthesis);
    if(allowVoice){
      const label = getLabel(el);
      if(label) speak("å·²æŒ‰ " + label);
    }
  }, true);
}

// --- Self Check: detect missing bindings & layout issues ---
function runSelfCheck(){
  const issues = [];

  // Critical elements
  const must = [
    ["btnProgress", "å·¥ç¨‹é€²åº¦æŒ‰éµ"],
    ["progressBar", "é€²åº¦æ©«æ¡¿"],
    ["chainBtn", "éˆä¸ŠÂ·å¿ƒè‡ŸæŒ‰éµ"],
    ["tabTemple", "è²¡ç¥æ®¿åˆ†é "],
    ["tabCockpit", "é§•é§›è‰™åˆ†é "],
    ["tabShop", "å®‡å®™å•†åº—åˆ†é "],
    ["tabWallet", "å®‡å®™ç´°åŒ…åˆ†é "],
  ];
  for(const [id,label] of must){
    if(!document.getElementById(id)) issues.push("ç¼ºå°‘ " + label + " ("+id+")");
  }

  // Feature availability
  if(!window.speechSynthesis) issues.push("æ­¤ç’°å¢ƒç„¡ speechSynthesisï¼ˆTTS å¯èƒ½ä¸å¯ç”¨ï¼‰");
  if(!window.SpeechRecognition && !window.webkitSpeechRecognition) issues.push("æ­¤ç’°å¢ƒç„¡ SpeechRecognitionï¼ˆèªéŸ³è¼¸å…¥å¯èƒ½ä¸å¯ç”¨ï¼‰");
  if(!window.ethereum) {
    // é€™ä¸æ˜¯éŒ¯ï¼Œåªæ˜¯æé†’
    pushEvent("selfcheck_note", { ethereum_injected_now:false });
  }

  // Layout overlap: ensure chain button not covering bottom actions
  try{
    const chain = document.getElementById("chainBtn");
    const sticky = document.querySelector(".sticky-actions");
    if(chain && sticky){
      const r1 = chain.getBoundingClientRect();
      const r2 = sticky.getBoundingClientRect();
      const overlap = !(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom);
      if(overlap) issues.push("å³ä¸‹è§’ã€éˆä¸ŠÂ·å¿ƒè‡Ÿã€é®åˆ°ä¸‹æ–¹æŒ‰éµï¼ˆå·²è‡ªå‹•é¿è®“ï¼Œè‹¥ä»é®æ“‹è«‹å›å ±ï¼‰");
    }
  }catch(e){}

  if(issues.length){
    pushEvent("selfcheck_fail", { issues });
    // Show one-line toast; details go to Debug Console
    toast("è‡ªæˆ‘æª¢æ¸¬ï¼šç™¼ç¾ " + issues.length + " é …éœ€ä¿®æ­£ï¼ˆå·²å¯«å…¥ Debug Consoleï¼‰");
    log("[SELF-CHECK] " + issues.join(" | "));
  } else {
    pushEvent("selfcheck_ok", { ok:true });
    log("[SELF-CHECK] OK");
  }

  // Always ensure click echo is attached (some environments require user gesture first)
  attachClickEcho();
}

function setIfEmpty(id, val) {
    const el = $(id);
    if (!el) return;
    if (!el.value || !String(el.value).trim()) el.value = val;
  }

  // ---- Ethers / Wallet
  let provider = null;
  let signer = null;
  let walletAddr = null;
  let chainIdHex = null;

  async function connectWallet() {
    if (!window.ethereum) {
      toast("æœªåµæ¸¬åˆ°éŒ¢åŒ…ã€‚è«‹å…ˆå®‰è£ MetaMaskï¼ˆæˆ–ä½¿ç”¨æ”¯æ´éŒ¢åŒ…çš„ç€è¦½å™¨ï¼‰å†å›ä¾†ã€‚");
      return null;
    }
    await window.ethereum.request({ method: "eth_requestAccounts" });
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    walletAddr = await signer.getAddress();
    const net = await provider.getNetwork();
    chainIdHex = "0x" + Number(net.chainId).toString(16);
    $("walletAddr").textContent = walletAddr;
    if ($("walletAddr2")) $("walletAddr2").textContent = walletAddr;
    $("walletChain").textContent = `${net.chainId}`;
    if ($("walletChain2")) $("walletChain2").textContent = `${net.chainId}`;
    toast("éŒ¢åŒ…å·²é€£ç·šã€‚ä½ ç¾åœ¨æœ‰å®‡å®™èº«ä»½äº†ã€‚");

    await refreshBalances();
    return walletAddr;
  }

  function readCfg() {
    return {
      KGEN: ($("cfgKGEN")?.value || DEFAULTS.KGEN).trim(),
      HEART: ($("cfgHeart")?.value || DEFAULTS.HEART).trim(),
      KUFO: ($("cfgKUFO")?.value || DEFAULTS.KUFO).trim(),
      TREASURY: ($("cfgTreasury")?.value || DEFAULTS.TREASURY).trim(),
      BANK: ($("cfgBank")?.value || DEFAULTS.BANK).trim(),
      BRAIN: ($("cfgBrain")?.value || DEFAULTS.BRAIN).trim(),
    };
  }

  async function refreshBalances() {
    const cfg = readCfg();
    if (!provider || !walletAddr) return;
    try {
      const kgen = new ethers.Contract(cfg.KGEN, ERC20_ABI, provider);
      const [sym, dec, bal] = await Promise.all([kgen.symbol(), kgen.decimals(), kgen.balanceOf(walletAddr)]);
      const pretty = Number(ethers.formatUnits(bal, dec)).toLocaleString(undefined, { maximumFractionDigits: 6 });
      $("kgenBal").textContent = `${pretty} ${sym}`;
      if ($("kgenBal2")) $("kgenBal2").textContent = `${pretty} ${sym}`;
    } catch (e) {
      log("è®€å– KGEN é¤˜é¡å¤±æ•—ï¼š" + (e?.message || e), "templeLog");
    }
  }

  // ---- Vitals (local simulation; later can be driven by on-chain events)
  const vitals = {
    heart: 72,
    breath: 18,
    pressureSys: 120,
    pressureDia: 80
  };
  let vitalsTimer = null;

  function renderVitals(statusText=null) {
    if ($("vitalHeart")) $("vitalHeart").textContent = String(vitals.heart);
    if ($("vitalBreath")) $("vitalBreath").textContent = String(vitals.breath);
    if ($("vitalPressure")) $("vitalPressure").textContent = `${vitals.pressureSys}/${vitals.pressureDia}`;
    if (statusText && $("vitalStatus")) $("vitalStatus").textContent = statusText;
  }

  function startVitals() {
    if (vitalsTimer) return;
    vitalsTimer = setInterval(() => {
      // small random walk, keep in safe ranges
      vitals.heart = Math.max(52, Math.min(130, vitals.heart + (Math.random() < 0.5 ? -1 : 1) * (Math.random() < 0.7 ? 1 : 2)));
      vitals.breath = Math.max(10, Math.min(30, vitals.breath + (Math.random() < 0.5 ? -1 : 1) * (Math.random() < 0.8 ? 0 : 1)));
      vitals.pressureSys = Math.max(90, Math.min(160, vitals.pressureSys + (Math.random() < 0.5 ? -1 : 1) * (Math.random() < 0.8 ? 0 : 1)));
      vitals.pressureDia = Math.max(55, Math.min(100, vitals.pressureDia + (Math.random() < 0.5 ? -1 : 1) * (Math.random() < 0.8 ? 0 : 1)));
      renderVitals();
    }, 1400);
    renderVitals("ç”Ÿå‘½å¾µè±¡å•Ÿå‹•ä¸­");
  }

  function bumpVital(kind) {
    startVitals();
    if (kind === "heart") vitals.heart = Math.min(150, vitals.heart + 3);
    if (kind === "breath") vitals.breath = Math.min(40, vitals.breath + 1);
    if (kind === "pressure") vitals.pressureSys = Math.min(170, vitals.pressureSys + 2);

    const label = (kind==="heart") ? "å¿ƒè·³" : (kind==="breath") ? "å‘¼å¸" : "è¡€å£“";
    const value = (kind==="pressure") ? `${vitals.pressureSys}/${vitals.pressureDia}` : (kind==="heart") ? `${vitals.heart}` : `${vitals.breath}`;

    renderVitals(`å·²æ›´æ–°ï¼š${label} ${value}`);
    // Button echo
    beep(990, 0.05, 0.03);
    // Speak result (if allowed)
    const v = (ttsModeSel && ttsModeSel.value) ? ttsModeSel.value : "auto";
    const allowVoice = (v === "tts") || (v === "auto" && !!window.speechSynthesis);
    if (allowVoice) speak(`${label} ${value}`);
  }

  // ---- Holy Cups gate (3 wins required)
  function getCupState() {
    return lsGet("wuzhishan_cups", { wins: 0, last: null });
  }
  function setCupState(s) {
    lsSet("wuzhishan_cups", s);
    $("cupWins").textContent = String(s.wins || 0);
  }
  function rollCups() {
    const r = Math.random();
    // 0.0-0.15: laugh, 0.15-0.55: no, 0.55-1.0: yes
    if (r < 0.15) return "ç¬‘ç­Š";
    if (r < 0.55) return "é™°ç­Š";
    return "è–ç­Š";
  }

  function updateFortuneButton() {
    const s = getCupState();
    const ok = (s.wins || 0) >= 3;
    if ($("btnFortune")) $("btnFortune").disabled = !ok;
    if ($("fortuneGate")) $("fortuneGate").textContent = ok ? "é€šéï¼ˆä¸‰è–ç­Šå·²é”æˆï¼‰" : "æœªé€šéï¼ˆéœ€è¦ä¸‰è–ç­Šï¼‰";
  }

  // ---- Fortune (Heart contract)
  async function heartContract(signerOrProvider) {
    const cfg = readCfg();
    if (!cfg.HEART || cfg.HEART.length < 10) {
      toast("å°šæœªå¡«å…¥å¿ƒè‡Ÿåˆç´„åœ°å€ï¼ˆcfgHeartï¼‰ã€‚éƒ¨ç½²å¾Œè²¼ä¸Šåœ°å€å³å¯å•Ÿå‹•ä¸Šéˆã€‚");
      return null;
    }
    return new ethers.Contract(cfg.HEART, HEART_ABI, signerOrProvider);
  }

  async function claimFortune() {
    const cfg = readCfg();
    const amountStr = ($("fortuneAmount")?.value || "0").trim();
    const amount = Number(amountStr);
    if (!Number.isFinite(amount) || amount <= 0) {
      toast("è«‹è¼¸å…¥è¦é ˜å–çš„ç™¼è²¡é‡‘æ•¸é‡ï¼ˆKGENï¼‰ã€‚");
      return;
    }
    if (!walletAddr) await connectWallet();
    if (!walletAddr) return;

    const heart = await heartContract(signer);
    if (!heart) return;

    // pre-check
    try {
      const pre = await heart.canFortune(walletAddr, ethers.parseUnits(String(amount), 18));
      if (pre && pre.length >= 2 && pre[0] === false) {
        toast("æš«ä¸å¯é ˜ï¼š" + pre[1]);
        return;
      }
    } catch (e) {
      log("canFortune æª¢æŸ¥å¤±æ•—ï¼ˆä»å˜—è©¦é€å‡ºï¼‰ï¼š" + (e?.message || e));
    }

    toast("ç™¼è²¡é‡‘é ˜å–ä¸Šéˆä¸­â€¦ï¼ˆè«‹åœ¨éŒ¢åŒ…ç¢ºèªï¼‰");
    try {
      const tx = await heart.fortuneClaim(ethers.parseUnits(String(amount), 18));
      log("TX sent: " + tx.hash);
      const rc = await tx.wait();
      log("å·²ç¢ºèªï¼š" + rc.hash);
      toast("ç™¼è²¡é‡‘å·²ç™¼æ”¾ã€‚è¨˜å¾—é‚„é¡˜ï¼Œè®“è¡€æµå¾ªç’°ã€‚");
      await refreshBalances();
    } catch (e) {
      toast("é ˜å–å¤±æ•—ï¼š" + (e?.shortMessage || e?.message || e));
    }
  }

  // ---- Lamp / Merit (On-chain mode = KGEN transfer to treasury; Off-chain vow note stored locally)
  async function payLamp() {
    const fee = Number(($("lampFee")?.value || "108").trim());
    if (!Number.isFinite(fee) || fee <= 0) { toast("å…‰æ˜ç‡ˆè²»ç”¨éœ€ç‚ºæ­£æ•¸ã€‚"); return; }

    if (!walletAddr) await connectWallet();
    if (!walletAddr) return;

    const cfg = readCfg();
    const kgen = new ethers.Contract(cfg.KGEN, ERC20_ABI, signer);

    toast("é»ç‡ˆä»˜æ¬¾ä¸Šéˆä¸­â€¦ï¼ˆè«‹åœ¨éŒ¢åŒ…ç¢ºèªï¼‰");
    try {
      const tx = await kgen.transfer(cfg.TREASURY, ethers.parseUnits(String(fee), 18));
      log("TX sent: " + tx.hash);
      await tx.wait();
      toast(`é»ç‡ˆæˆåŠŸï¼šå·²æ”¯ä»˜ ${fee} KGENã€‚`);
      await refreshBalances();
    } catch (e) {
      toast("é»ç‡ˆä»˜æ¬¾å¤±æ•—ï¼š" + (e?.shortMessage || e?.message || e));
    }
  }

  // ---- Seven Fairies UI
  function renderFairiesIntro() {
    const box = $("fairyIntroList");
    if (!box) return;
    box.innerHTML = "";
    FAIRIES.forEach(f => {
      const div = document.createElement("div");
      div.style.padding = "12px";
      div.style.borderRadius = "16px";
      div.style.background = "rgba(255,255,255,.06)";
      div.style.border = "1px solid rgba(255,255,255,.10)";
      div.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px;">
          <div style="font-weight:1000;">${f.title}ï¼ˆ${f.name}ï¼‰</div>
          <div style="opacity:.9; font-weight:900;">åº§æ¨™ ${f.coord} Â· ${f.star}</div>
        </div>
        <div style="margin-top:6px; font-size:13px; opacity:.9;">
          å°ˆæŒï¼š${f.duty} ï½œ è±¡å¾µï¼š${f.side}
        </div>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn2" data-fairy="${f.id}">å‘${f.name}è¨±é¡˜</button>
          <button class="btn2" data-fairy-fulfill="${f.id}">å‘${f.name}é‚„é¡˜</button>
        </div>
      `;
      box.appendChild(div);
    });

    // Prefill name inputs (if exist)
    const inputs = [
      ["fairy1","å¤§ä»™å¥³(å·§é›²)"],
      ["fairy2","äºŒä»™å¥³(å·§è™¹)"],
      ["fairy3","ä¸‰ä»™å¥³(å·§èŠ)"],
      ["fairy4","å››ä»™å¥³(å·§ä»™)"],
      ["fairy5","äº”ä»™å¥³(å·§è˜­)"],
      ["fairy6","å…­ä»™å¥³(å·§æ¢…)"],
      ["fairy7","ä¸ƒä»™å¥³(å·§éˆ)"],
    ];
    inputs.forEach(([id,val]) => { if ($(id)) $(id).value = val; });

    // meta text
    const m = $("fairyMeta");
    if (m) {
      m.textContent = "ä¸ƒä»™å¥³ä½åœ¨åŒ—æ–—ä¸ƒæ˜Ÿåº§æ¨™ï¼š14520, 14866, 16184, 16888, 17347, 18056, 18459ã€‚æ¯ä½ä»™å¥³å°æ‡‰ä¸åŒç¥ˆé¡˜ä¸»é¡Œèˆ‡å¤šç©ºè±¡å¾µã€‚";
    }

    box.addEventListener("click", (e) => {
      const b = e.target.closest("button");
      if (!b) return;
      const id = b.getAttribute("data-fairy") || b.getAttribute("data-fairy-fulfill");
      if (!id) return;
      const f = FAIRIES.find(x => x.id === id);
      if (!f) return;
      if (b.hasAttribute("data-fairy")) {
        toast(`å·²åˆ‡æ›ï¼šå‘${f.title}ï¼ˆ${f.name}ï¼‰è¨±é¡˜ã€‚`);
        if ($("fairyPath")) $("fairyPath").value = f.id;
        if ($("wishText")) $("wishText").focus();
      } else {
        toast(`å·²åˆ‡æ›ï¼šå‘${f.title}ï¼ˆ${f.name}ï¼‰é‚„é¡˜ã€‚`);
        if ($("fairyPath")) $("fairyPath").value = f.id;
        if ($("fulfillText")) $("fulfillText").focus();
      }
    });
  }

  // ---- Seven Fairies wishes (local JSON export)
  function saveWishLocal() {
    const path = ($("fairyPath")?.value || "f1").trim();
    const wish = ($("wishText")?.value || "").trim();
    const fulfill = ($("fulfillText")?.value || "").trim();
    const note = { path, wish, fulfill, at: new Date().toISOString() };
    const arr = lsGet("wuzhishan_wishes", []);
    arr.push(note);
    lsSet("wuzhishan_wishes", arr);
    toast("å·²ä¿å­˜è¨±é¡˜/é‚„é¡˜ï¼ˆæœ¬æ©Ÿï¼‰ã€‚å¯åŒ¯å‡º JSON ç•™å¿µã€‚");
  }

  function exportWishes() {
    const arr = lsGet("wuzhishan_wishes", []);
    const blob = new Blob([JSON.stringify(arr, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `wuzhishan_fairies_wishes_${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
    toast("å·²åŒ¯å‡ºä¸ƒä»™å¥³è¨±é¡˜JSONã€‚");
  }

  // ---- 72 Seats registry (local; future can be on-chain)
  function initSeats() {
    const grid = $("slotGrid");
    if (!grid) return;
    const state = lsGet("wuzhishan_seats72", { picked: null, seats: {} });
    grid.innerHTML = "";
    for (let i=1; i<=72; i++) {
      const btn = document.createElement("button");
      btn.className = "slot";
      btn.textContent = String(i);
      btn.dataset.slot = String(i);
      if (state.seats[String(i)]) btn.classList.add("filled");
      if (state.picked === i) btn.classList.add("active");
      grid.appendChild(btn);
    }
    $("slotPicked").textContent = state.picked ? String(state.picked) : "ï¼ˆæœªæŒ‡å®šï¼Œé€å‡ºæ™‚è‡ªå‹•åˆ†é…ï¼‰";
    $("slotCount").textContent = `${Object.keys(state.seats).length}/72`;

    grid.addEventListener("click", (e) => {
      const b = e.target.closest("button.slot");
      if (!b) return;
      state.picked = Number(b.dataset.slot);
      lsSet("wuzhishan_seats72", state);
      initSeats();
      toast(`å·²æŒ‡å®šåé¡ï¼š${state.picked}`);
    });
  }

  function submitSeat() {
    const state = lsGet("wuzhishan_seats72", { picked: null, seats: {} });
    const name = ($("seatName")?.value || "").trim();
    const msg = ($("seatMsg")?.value || "").trim();
    if (!name) { toast("è«‹å…ˆå¡«å¯«å§“å/æš±ç¨±ã€‚"); return; }

    // pick slot: if not picked, find next available
    let slot = state.picked;
    if (!slot) {
      for (let i=1;i<=72;i++) { if (!state.seats[String(i)]) { slot = i; break; } }
    }
    if (!slot) { toast("72 åé¡å·²æ»¿ã€‚"); return; }
    if (state.seats[String(slot)]) { toast(`åé¡ ${slot} å·²è¢«å ç”¨ï¼Œè«‹æ›ä¸€æ ¼ã€‚`); return; }

    state.seats[String(slot)] = { name, msg, at: new Date().toISOString() };
    state.picked = null;
    lsSet("wuzhishan_seats72", state);
    initSeats();
    toast(`ç™»è¨˜æˆåŠŸï¼šåé¡ ${slot} å·²ç•™çµ¦ ${name}ã€‚`);
  }

  function exportSeats() {
    const state = lsGet("wuzhishan_seats72", { picked: null, seats: {} });
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `wuzhishan_seats72_${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
    toast("å·²åŒ¯å‡º 72 åé¡ç™»è¨˜ JSONã€‚");
  }

  // ---- Shop card (local)
  function shopSave() {
    const name = ($("shopName")?.value || "").trim();
    if (!name) { toast("è«‹è¼¸å…¥åº—åã€‚"); return; }
    const desc = ($("shopDesc")?.value || "").trim();
    const rebate = Number(($("shopRebate")?.value || "1").trim());
    const card = { name, desc, rebate, owner: walletAddr || null, at: new Date().toISOString() };
    lsSet("wuzhishan_shopCard", card);
    toast("åº—å¡å·²ä¿å­˜ï¼ˆæœ¬æ©Ÿï¼‰ã€‚");
  }

  function shopExport() {
    const card = lsGet("wuzhishan_shopCard", null);
    if (!card) { toast("å°šæœªä¿å­˜åº—å¡ã€‚"); return; }
    const blob = new Blob([JSON.stringify(card, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `wuzhishan_shop_${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
    toast("å·²åŒ¯å‡ºåº—å¡ JSONã€‚");
  }

  // ---- AI Concierge (rule-based, always responsive)
  function aiReply(userText) {
    const t = (userText || "").trim();
    if (!t) return "ä½ å¯ä»¥ç›´æ¥å•ï¼šå¦‚ä½•é ˜ç™¼è²¡é‡‘ã€å¦‚ä½•é»ç‡ˆã€æˆ‘æ²’æœ‰éŒ¢åŒ…æ€éº¼è¾¦ã€ä¸ƒä»™å¥³ä½å“ªè£¡ã€‚";

    const lower = t.toLowerCase();

    if (t.includes("ä¸ƒä»™å¥³") || t.includes("ä»™å¥³")) {
      return "ä¸ƒä»™å¥³ä½åœ¨åŒ—æ–—ä¸ƒæ˜Ÿåº§æ¨™ï¼š14520, 14866, 16184, 16888, 17347, 18056, 18459ã€‚å¥¹å€‘åˆ†åˆ¥æŒç®¡é¢¨èª¿é›¨é †ã€å®¶åº­ç¾æ»¿ã€è‚²å­æ”¶é©šã€äº‹æ¥­é‹é€šã€é•·å‘½ç™¾æ­²ã€èº«é«”å¥åº·ã€æ„Ÿæƒ…åœ“æ»¿ï¼›ä¸¦ä»¥åšå¤š/åšç©º/å¤šå–®é€€è±¡å¾µå¸‚å ´ç¯€å¥ã€‚";
    }

    if (t.includes("ç™¼è²¡é‡‘") || t.includes("é ˜") || t.includes("claim")) {
      return "é ˜ç™¼è²¡é‡‘éœ€è¦å®Œæˆä¸‰è–ç¢‘ï¼ˆåŒä¸€å¤©æœ€å¤šæ“²ç­Š3æ¬¡ï¼›åªè¦å‡ºç¾è‡³å°‘1æ¬¡è–ç­Šå³å¯é€šé—œï¼‰ï¼Œæ¥è‘—é€£ç·šéŒ¢åŒ…ï¼Œè¼¸å…¥è¦é ˜çš„ KGEN æ•¸é‡ï¼ŒæŒ‰ã€Œé ˜ç™¼è²¡é‡‘ã€ã€‚è‹¥å¿ƒè‡Ÿåˆç´„æœªä¸Šéˆæˆ–æœªå¡«åœ°å€ï¼Œç³»çµ±æœƒæç¤ºä½ å…ˆè²¼ä¸Š cfgHeartã€‚";
    }

    if (t.includes("é»ç‡ˆ") || t.includes("å…‰æ˜ç‡ˆ") || t.includes("108")) {
      return "é»å…‰æ˜ç‡ˆå›ºå®šæ”¶ 108 KGENã€‚æµç¨‹ï¼šé€£ç·šéŒ¢åŒ… â†’ ç¢ºèªè²»ç”¨108 â†’ æŒ‰ã€Œé»å…‰æ˜ç‡ˆä»˜æ¬¾ã€ã€‚ç›®å‰ä»¥ KGEN ç›´æ¥è½‰å¸³åˆ° Treasury åœ°å€ä½œç‚ºä¸Šéˆæ”¶æ¬¾ã€‚";
    }

    if (t.includes("æ²’æœ‰éŒ¢åŒ…") || t.includes("æ–°æ‰‹") || t.includes("metamask")) {
      return "æ–°æ‰‹æµç¨‹ï¼š1) å®‰è£ MetaMask 2) å»ºç«‹éŒ¢åŒ…ä¸¦å‚™ä»½åŠ©è¨˜è© 3) åˆ‡åˆ° BNB Chain 4) å–å¾—å°‘é‡ BNB ç•¶Gas 5) å›ç¥æ®¿æŒ‰ã€Œé€£ç·šéŒ¢åŒ…ã€ã€‚æ²’æœ‰éŒ¢åŒ…ä¹Ÿèƒ½å…ˆç™»è¨˜åé¡èˆ‡å¯«é¡˜æœ›ã€‚";
    }

    if (t.includes("å®‡å®™ç´°åŒ…")) {
      return "å®‡å®™ç´°åŒ…å°±æ˜¯ä½ çš„éŒ¢åŒ…èº«ä»½ã€‚ä½ å¯ä»¥å…ˆæŒ‰ã€Œå®‡å®™ç´°åŒ…ã€å€å¡Šçš„é€£ç·šéŒ¢åŒ…ï¼Œç³»çµ±æœƒé¡¯ç¤ºåœ°å€ã€éˆIDèˆ‡KGENé¤˜é¡ã€‚";
    }

    if (t.includes("å®‡å®™å•†åº—") || t.includes("é–‹åº—")) {
      return "å®‡å®™å•†åº—è®“ä½ æŠŠç¾å¯¦åº—é‹ªè®Šæˆå®‡å®™åº—å¡ï¼Œç”¨ KGEN ç•¶ç´…åˆ©å›é¥‹é¡§å®¢ã€‚ä½ å…ˆå¡«åº—å/ä»‹ç´¹/ç´…åˆ©æ¯”ä¾‹ï¼Œä¿å­˜åº—å¡ï¼ˆæœ¬æ©Ÿï¼‰ï¼Œä¹‹å¾Œå¯åŒ¯å‡ºJSONçµ¦ç¤¾ç¾¤æˆ–æœªä¾†ä¸Šéˆã€‚";
    }

    if (t.includes("é£›ç¢Ÿ") || t.includes("ä¸‹å–®") || t.includes("äº¤æ˜“")) {
      return "é£›ç¢Ÿé§•é§›è‰™æ˜¯ç©å®¶ä»‹é¢ï¼›ç›®å‰æœ¬ç¥æ®¿å…ˆæŠŠåŸºç¤è¨­æ–½ï¼ˆå®¢æœ/é»ç‡ˆ/ç™¼è²¡é‡‘/åé¡/ä¸ƒä»™å¥³/ç´°åŒ…/å•†åº—ï¼‰å®Œæˆã€‚çœŸæ­£çš„è·¨å¸‚å ´äº¤æ˜“å¼•æ“ä½ åœ¨å°ˆæ¡ˆé é–‹ç™¼ï¼Œç­‰äº¤æ˜“å®¤å¼•æ“æä¾›åˆç´„æ¥å£å¾Œï¼Œç¥æ®¿æœƒæ¥å…¥ä¸€éµä¸‹å–®ã€‚";
    }

    return "æ”¶åˆ°ã€‚é€™è£¡æ˜¯äº”æŒ‡å±±æ‚Ÿç©ºè²¡ç¥æ®¿ï¼šå…ˆæŠŠã€é ˜ç™¼è²¡é‡‘ï¼ˆä¸‰è–ç­Šé–€æª»ï¼‰ã€èˆ‡ã€é»ç‡ˆ108KGENã€è·‘é€šï¼Œå†æŠŠç©å®¶é£›ç¢Ÿäº¤æ˜“å®¤æ¥ä¸Šå¼•æ“ã€‚ä½ ä¹Ÿå¯ä»¥å•ï¼šæˆ‘ç¾åœ¨è©²æŒ‰å“ªå€‹éµï¼Ÿ";
  }

  function aiSend() {
    const inp = $("aiInput");
    const out = $("aiOutput");
    if (!inp || !out) return;
    const q = (inp.value || "").trim();
    if (!q) return;
    out.value += `ä½ ï¼š${q}\n`;
    const a = aiReply(q);
    out.value += `å®¢æœï¼š${a}\n\n`;
    out.scrollTop = out.scrollHeight;
    speak(a);
    inp.value = "";
  }

  function aiQuick(text) {
    const out = $("aiOutput");
    if (!out) return;
    out.value += `ä½ ï¼š${text}\n`;
    const a = aiReply(text);
    out.value += `å®¢æœï¼š${a}\n\n`;
    out.scrollTop = out.scrollHeight;
    speak(a);
  }

  // ---- Progress bar (build checklist)
  const BUILD_ITEMS = [
    { id:"infra_buttons",  label:"æŒ‰éµå…¨éƒ¨å¯æŒ‰ï¼ˆæœ‰ logï¼‰", done:true },
    { id:"infra_ai",       label:"AI å®¢æœå¯å›è©±ï¼ˆå«æ–°æ‰‹éŒ¢åŒ…æ•™å­¸ï¼‰", done:true },
    { id:"infra_fairies",  label:"ä¸ƒä»™å¥³ä½å€/è·å¸/è±¡å¾µ + è¨±é¡˜é‚„é¡˜", done:true },
    { id:"infra_seats72",  label:"72 åé¡ç™»è¨˜ï¼ˆæœ¬æ©Ÿå­˜æª”/åŒ¯å‡ºJSONï¼‰", done:true },
    { id:"infra_lamp108",  label:"å…‰æ˜ç‡ˆ 108 KGENï¼ˆä¸Šéˆè½‰å¸³ Treasuryï¼‰", done:true },
    { id:"infra_cups",     label:"ä¸‰è–ç­Šé–€æª»ï¼ˆé ˜ç™¼è²¡é‡‘å‰ç½®ï¼‰", done:true },
    { id:"infra_wallet",   label:"å®‡å®™ç´°åŒ…ï¼ˆéŒ¢åŒ…é€£ç·š/é¤˜é¡é¡¯ç¤ºï¼‰", done:true },
    { id:"infra_shop",     label:"å®‡å®™å•†åº—ï¼ˆåº—å¡æœ¬æ©Ÿä¿å­˜/åŒ¯å‡ºJSONï¼‰", done:true },
    { id:"infra_vitals",   label:"å‘¼å¸/å¿ƒè·³/è¡€å£“é¡¯ç¤ºï¼ˆæœ¬æ©Ÿï¼‰", done:true },
    { id:"infra_chainHook",label:"å¿ƒè‡Ÿåˆç´„æ¥å…¥ï¼ˆå¡«cfgHeartå³å¯ä¸Šéˆé ˜å–ï¼‰", done:false }
  ];

  function renderChecklist() {
    const box = $("buildChecklist");
    if (!box) return;
    box.innerHTML = "";
    let done = 0;
    BUILD_ITEMS.forEach(it => {
      if (it.done) done++;
      const row = document.createElement("div");
      row.className = "checkrow";
      row.innerHTML = `
        <div class="dot ${it.done ? "on":"off"}"></div>
        <div class="label">${it.label}</div>
        <div class="tag">${it.done ? "OK":"WIP"}</div>
      `;
      box.appendChild(row);
    });
    const pct = Math.round(done / BUILD_ITEMS.length * 100);
    if ($("buildPct")) $("buildPct").textContent = `${pct}%`;
    if ($("buildBar")) $("buildBar").style.width = `${pct}%`;
  }

  // ---- Self check
  function selfCheck() {
    const hasEth = !!window.ethereum;
    const hasSpeech = ("speechSynthesis" in window);
    log(`SelfCheck: wallet=${hasEth ? "YES":"NO"}, speechSynthesis=${hasSpeech ? "YES":"NO"}`, "templeLog");
    toast("ç’°å¢ƒæª¢æ¸¬å®Œæˆã€‚éŒ¢åŒ…=" + (hasEth ? "æœ‰" : "ç„¡") + "ï¼ŒèªéŸ³=" + (hasSpeech ? "æœ‰" : "ç„¡"));
  }

  // ---- Bind UI
  function bind() {
    // config defaults
    setIfEmpty("cfgKGEN", DEFAULTS.KGEN);
    setIfEmpty("cfgKUFO", DEFAULTS.KUFO);
    setIfEmpty("cfgTreasury", DEFAULTS.TREASURY);
    setIfEmpty("cfgBank", DEFAULTS.BANK);

    // vitals buttons
    $("btnHeartbeat")?.addEventListener("click", () => { bumpVital("heart"); });
    $("btnBreath")?.addEventListener("click", () => { bumpVital("breath"); });
    $("btnPressure")?.addEventListener("click", () => { bumpVital("pressure"); });

    // cups
    $("btnCup")?.addEventListener("click", () => {
      const s = getCupState();
      const r = rollCups();
      s.last = r;
      if (r === "è–ç­Š") s.wins = Math.min(3, (s.wins||0) + 1);
      else s.wins = 0; // reset on non-holy result
      setCupState(s);
      log(`æ“²ç­Šçµæœï¼š${r}ï¼ˆè–ç­Šç´¯ç©=${s.wins}/3ï¼‰`, "templeLog");
      toast(r === "è–ç­Š" ? "è–ç­Šï¼" : (r === "ç¬‘ç­Š" ? "ç¬‘ç­Šï¼šç¥æ˜åœ¨ç¬‘ï¼Œä½ å†ä¾†" : "é™°ç­Šï¼šæœªå…è¨±ï¼Œé‡æ–°æ“²ç­Š"));
      updateFortuneButton();
    });

    // wallet connect
    $("btnWalletConnect")?.addEventListener("click", connectWallet);
    $("btnWalletConnect2")?.addEventListener("click", connectWallet);

    // fortune claim
    $("btnFortune")?.addEventListener("click", claimFortune);

    // lamp pay
    $("btnLampPay")?.addEventListener("click", payLamp);

    // seats
    $("btnSeatSubmit")?.addEventListener("click", submitSeat);
    $("btnSeatExport")?.addEventListener("click", exportSeats);

    // fairies
    $("btnSaveFairies")?.addEventListener("click", saveWishLocal);
    $("btnExportFairies")?.addEventListener("click", exportWishes);

    // AI chat
    $("btnAiSend")?.addEventListener("click", aiSend);
    $("aiInput")?.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); aiSend(); } });
    $("btnAiQ1")?.addEventListener("click", ()=>aiQuick("æˆ‘è¦é ˜ç™¼è²¡é‡‘æ€éº¼åš"));
    $("btnAiQ2")?.addEventListener("click", ()=>aiQuick("æˆ‘æ²’æœ‰éŒ¢åŒ…æ€éº¼è¾¦"));
    $("btnAiQ3")?.addEventListener("click", ()=>aiQuick("ä¸ƒä»™å¥³ä½å“ªè£¡ï¼Œå„æŒç®¡ä»€éº¼"));

    // shop
    $("btnShopSave")?.addEventListener("click", shopSave);
    $("btnShopExport")?.addEventListener("click", shopExport);
    $("btnShopOpen")?.addEventListener("click", ()=>{ toast("å…ˆå¡«åº—å/ä»‹ç´¹/ç´…åˆ©æ¯”ä¾‹ï¼Œå†æŒ‰ä¿å­˜åº—å¡ã€‚"); });
    $("btnShopHow")?.addEventListener("click", ()=>{ aiQuick("å®‡å®™å•†åº—æ€éº¼é‹ä½œ"); });

    // how-to
    $("btnWalletHowto")?.addEventListener("click", ()=>aiQuick("æˆ‘æ²’æœ‰éŒ¢åŒ…æ€éº¼è¾¦"));

    // nav buttons: scroll within temple
    $("btnGoWallet")?.addEventListener("click", ()=>{ $("walletZone")?.scrollIntoView({behavior:"smooth", block:"start"}); toast("å·²ç§»å‹•åˆ°å®‡å®™ç´°åŒ…ã€‚"); });
    $("btnGoShop")?.addEventListener("click", ()=>{ $("shopZone")?.scrollIntoView({behavior:"smooth", block:"start"}); toast("å·²ç§»å‹•åˆ°å®‡å®™å•†åº—ã€‚"); });

    // selftest
    $("btnSelfTest")?.addEventListener("click", runSelfCheck);

    // clear log
    $("btnClearLog")?.addEventListener("click", ()=>{ if($("templeLog")) $("templeLog").value=""; toast("Log å·²æ¸…ç©º"); });
  }

  // ---- Boot
  function boot() {
    renderChecklist();
    renderVitals("å°šæœªå•Ÿå‹•");
    renderFairiesIntro();
    initSeats();

    // cup init
    setCupState(getCupState());
    updateFortuneButton();

    // AI welcome
    const out = $("aiOutput");
    if (out && !out.value) {
      out.value = "å®¢æœï¼šæ­¡è¿ä¾†åˆ°äº”æŒ‡å±±æ‚Ÿç©ºè²¡ç¥æ®¿ï¼ˆ12345ï¼‰ã€‚\nä½ å¯ä»¥å…ˆå•ï¼šå¦‚ä½•é ˜ç™¼è²¡é‡‘ã€å¦‚ä½•é»ç‡ˆ108KGENã€æˆ‘æ²’æœ‰éŒ¢åŒ…æ€éº¼è¾¦ã€ä¸ƒä»™å¥³ä½å“ªè£¡ã€‚\n\n";
    }

    bind();
    // auto selfcheck once
    setTimeout(runSelfCheck, 450);
    log(`BOOT OK: ${BOOT}`, "templeLog");
  }

  document.addEventListener("DOMContentLoaded", boot);
})();
</script>


<div id="klineHelpScrim" aria-hidden="true"></div>
<div id="klineHelpDrawer" role="dialog" aria-label="AIå®¢æœ">
  <div class="hd">
    <div>
      <div class="title">AI å®¢æœï½œæ‚Ÿç©ºç¥æ®¿æ¥å¾…è™•</div>
      <div class="sub" id="klineHelpSub">æŒ‰ä»»ä½•æŒ‰éµï¼Œé€™è£¡æœƒç”¨äººè©±è§£é‡‹ä½ å‰›å‰›åšäº†ä»€éº¼ï¼Œä»¥åŠä¸‹ä¸€æ­¥ã€‚</div>
    </div>
    <button class="btn" id="klineHelpClose" type="button">é—œé–‰</button>
  </div>
  <div class="body" id="klineHelpBody"></div>
  <div class="actions" id="klineHelpActions"></div>
</div>



<script id="hotfix-v4-5-4">
(() => {
  const BOOT = "v4.5.5-wuzhishan12345-temple-vitals-ai-smarthelp-counter";
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const nowIso = () => new Date().toISOString();
  const log = (msg) => { const box = $("#debugBox"); if (box){ box.textContent += `[${nowIso()}] ${msg}\n`; box.scrollTop = box.scrollHeight; } };

  function bumpVisit() {
    const k = "wuzhishan_visit_count";
    const n = (parseInt(localStorage.getItem(k) || "0", 10) || 0) + 1;
    localStorage.setItem(k, String(n));
    const v = $("#visitLine");
    if (v) v.textContent = `åˆ°è¨ªï¼š${n}`;
  }

  function speak(text) {
    if (!("speechSynthesis" in window)) return;
    try{
      const u = new SpeechSynthesisUtterance(text.replace(/\n+/g, ". "));
      u.lang = "zh-TW";
      u.rate = 1.0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(e){ log("speech_failed"); }
  }

  function setAi(text, say=true) {
    const box = $("#aiReply");
    if (box) { box.textContent = text; box.dataset.last = nowIso(); }
    if (say) speak(text);
  }

  const HELP = {
    welcome:
`æ­¡è¿ä¾†åˆ°äº”æŒ‡å±±æ‚Ÿç©ºè²¡ç¥æ®¿ï¼ˆåº§æ¨™ 12345ï¼‰ã€‚
ä½ ç¾åœ¨åœ¨ v${BOOT}ã€‚

æˆ‘ä¸æ˜¯å•¶ä¸€è²ï¼Œæˆ‘æœƒæŠŠä½ å¾ã€Œæ²’æœ‰éŒ¢åŒ…ã€å¸¶åˆ°ã€Œèƒ½é»ç‡ˆã€èƒ½é ˜ç™¼è²¡é‡‘ã€ã€‚

ä»Šå¤©å…ˆæŠŠç¥æ®¿åŸºç¤è¨­æ–½è£ç’œå¥½ï¼š
1) ç”Ÿå‘½è·¡è±¡ï¼ˆå‘¼å¸ / å¿ƒè·³ / è¡€å£“ï¼‰
2) ä¸‰è–ç¢‘ï¼ˆé ˜ç™¼è²¡é‡‘å‰çš„å„€å¼é©—è­‰ï¼‰
3) é»ç‡ˆï¼ˆ108 KGENï¼‰èˆ‡èªªæ˜
4) å®‡å®™ç´°åŒ…ï¼ˆéŒ¢åŒ…æ•™å­¸ï¼‰èˆ‡å®‡å®™å•†åº—ï¼ˆå•†å®¶ç´…åˆ©å…¥å£ï¼‰

ä½ é»ä»»ä½•æŒ‰éµï¼Œæˆ‘éƒ½æœƒåœ¨é€™è£¡å³æ™‚è§£èªªã€‚`,
    wallet:
`å®‡å®™ç´°åŒ…ï¼ˆéŒ¢åŒ…ï¼‰å¾ 0 é–‹å§‹ï¼š
1) å®‰è£ MetaMaskï¼ˆæˆ– Trust Walletï¼‰
2) åˆ‡åˆ° BNB Chainï¼ˆBSC / BEP20ï¼‰
3) åŒ¯å…¥ KGEN ä»£å¹£åˆç´„ï¼ˆä½ å·²éƒ¨ç½²çš„é‚£å€‹ï¼‰
4) æº–å‚™å°‘é‡ BNB ç•¶ gas

å®Œæˆå¾Œå›ä¾†æŒ‰ã€Œéˆä¸Šãƒ»å¿ƒè‡Ÿã€â†’ é€£ç·šéŒ¢åŒ…ã€‚`,
    shop:
`å®‡å®™å•†åº—æ˜¯ã€Œç¾å¯¦å•†å®¶ Ã— KGEN ç´…åˆ©ã€å…¥å£ã€‚
æœé£¾åº—ã€é£¯åº—ã€é¤é£²éƒ½èƒ½ç”¨ KGEN ç•¶ç´…åˆ©å›é¥‹é¡§å®¢ã€‚
é¡§å®¢å›ç¥æ®¿é»ç‡ˆã€é‚„é¡˜ã€æˆ–é€² KUFO éŠç©ã€‚
é€™è£¡ä¸é™åˆ¶ä½ åªèƒ½äº¤æ˜“é‡‘èå•†å“ã€‚`,
    vitals:
`ç”Ÿå‘½è·¡è±¡ï¼ˆå‘¼å¸ / å¿ƒè·³ / è¡€å£“ï¼‰ï¼š
- ç›®å‰å…ˆåš UI æ¨¡æ“¬ï¼ˆè®“ç¥æ®¿ã€Œæœ‰ç”Ÿå‘½ã€ï¼‰
- å¿ƒè‡Ÿåˆç´„ä¸Šéˆå¾Œï¼šæ”¹æˆè®€å–éˆä¸Šäº‹ä»¶ï¼ˆå¿ƒè·³/ç™¼æ”¾/é»ç‡ˆï¼‰

å¦‚æœä½ å¸Œæœ›ã€Œä¸€é€²é å°±æœ‰è²éŸ³ã€ï¼šæ‰‹æ©Ÿç€è¦½å™¨å¯èƒ½æœƒæ“‹è‡ªå‹•èªéŸ³ï¼Œ
ä½ åªè¦ç¬¬ä¸€æ¬¡è¼•è§¸ç•«é¢ï¼Œæˆ‘å°±èƒ½é–‹å§‹æœ—è®€ã€‚`,
    plaques:
`ä¸‰è–ç¢‘ï¼ˆæ“²ç­Šï¼‰ï¼š
é ˜ç™¼è²¡é‡‘å‰ï¼Œå…ˆé€£çºŒæ“²å‡ºä¸‰æ¬¡ã€Œè–æ¯ã€æ‰æ”¾è¡Œã€‚
æœ¬ç‰ˆå…ˆåšå‰ç«¯å„€å¼ï¼ˆæœ¬æ©Ÿå­˜æª”ï¼‰ï¼Œå¾ŒçºŒæ¥éˆä¸ŠæœƒæŠŠçµæœå¯«å…¥å¿ƒè‡Ÿåˆç´„ã€‚`,
    fortune:
`ç™¼è²¡é‡‘æµç¨‹ï¼š
1) é€£éŒ¢åŒ…ï¼ˆå®‡å®™ç´°åŒ…ï¼‰
2) ä¸‰è–ç¢‘æ”¾è¡Œ
3) ç”±ã€Œå¿ƒè‡Ÿåˆç´„ã€ç™¼æ”¾åˆ°ä½ çš„éŒ¢åŒ…

ç›®å‰é€™ç‰ˆå…ˆæŠŠæµç¨‹èˆ‡ä»‹é¢åšå°ï¼›ç­‰ä½ çµ¦åˆç´„åœ°å€å¾Œï¼Œå°±èƒ½æ¥çœŸå¯¦ç™¼æ”¾ã€‚`,
    lamp:
`é»å…‰æ˜ç‡ˆï¼ˆ108 KGENï¼‰ï¼š
é»ç‡ˆè²»å›ºå®š 108 KGENã€‚
æœªé€£éŒ¢åŒ…ï¼šå…ˆæ•™ä½ é€£ç·šèˆ‡æº–å‚™ KGENã€‚
æ¥ä¸Šéˆå¾Œï¼šé»ç‡ˆæœƒèµ°éˆä¸Šè½‰å¸³ä¸¦ç•™ä¸‹ç´€éŒ„ã€‚`,
    fairies:
`ä¸ƒä»™å¥³ï¼ˆè¨±é¡˜ / é‚„é¡˜ï¼‰ç¯€é»ï¼š
14520 å¤§ä»™å¥³ï¼ˆå·§é›²ï¼‰å¤©æ¨ï¼šé¢¨èª¿é›¨é †ï½œåšç©º
14866 äºŒä»™å¥³ï¼ˆå·§è™¹ï¼‰å¤©ç’‡ï¼šå®¶åº­ç¾æ»¿ï½œåšå¤š
16184 ä¸‰ä»™å¥³ï¼ˆå·§èŠï¼‰å¤©ç’£ï¼šè‚²å­æ”¶é©šï½œåšç©º
16888 å››ä»™å¥³ï¼ˆå·§ä»™ï¼‰å¤©æ¬Šï¼šäº‹æ¥­é‹é€šï½œåšå¤š
17347 äº”ä»™å¥³ï¼ˆå·§è˜­ï¼‰å¤©è¡¡ï¼šé•·å‘½ç™¾æ­²ï½œåšç©º
18056 å…­ä»™å¥³ï¼ˆå·§æ¢…ï¼‰é—“é™½ï¼šèº«é«”å¥åº·ï½œåšå¤š
18459 ä¸ƒä»™å¥³ï¼ˆå·§éˆï¼‰ç‘¤å…‰ï¼šæ„Ÿæƒ…åœ“æ»¿ï½œå¤šå–®é€€

é¸ä¸€ä½ä»™å¥³ï¼Œå°±æ˜¯æŠŠé¡˜æœ›å¯«å…¥å°æ‡‰ç¯€é»ï¼ˆæœ¬æ©Ÿ JSON â†’ ä¹‹å¾Œå¯ä¸Šéˆï¼‰ã€‚`,
    progress:
`å·¥ç¨‹é€²åº¦ï¼š
æŒ‰ã€ŒæŸ¥çœ‹å®Œå·¥æ¸…å–®ã€æœƒæ‰“é–‹é€²åº¦é¢æ¿ã€‚
ä½ å¯ä»¥å‹¾é¸æ¯ä¸€é …ï¼Œé€²åº¦æ¢æœƒæ›´æ–°ã€‚
é€™æ¨£ä½ ä¸ç”¨ä¸€å€‹ä¸€å€‹é»åï¼Œæˆ‘æœƒè‡ªå·±å…ˆè‡ªæª¢ã€‚`
  
  ,
    fortune_gate:
`é ˜ç™¼è²¡é‡‘å‰ç½®æ¢ä»¶ï¼š
1) å…ˆå®Œæˆã€Œä¸‰è–ç¢‘ã€ï¼šåŒä¸€å¤©æœ€å¤šæ“²ç­Š 3 æ¬¡ï¼Œåªè¦å‡ºç¾è‡³å°‘ 1 æ¬¡ã€Œè–ç­Šã€å³é€šé—œã€‚
2) ä¸Šéˆé ˜å–ä»éœ€è¦éŒ¢åŒ…ï¼ˆMetaMask / TrustWalletï¼‰ã€‚

ä½ ç¾åœ¨çœ‹åˆ°çš„æŒ‰éˆ•æœƒä¾é€šé—œç‹€æ…‹è‡ªå‹•è§£é–ã€‚`,
    plaques_holy:
`è–ç­Šï½œä»Šæ—¥é€šé—œã€‚
ä½ å·²å–å¾—ä»Šæ—¥ã€Œä¸‰è–ç¢‘ã€é€šè¡Œã€‚
æ¥ä¸‹ä¾†å¯ä»¥å»é ˜ç™¼è²¡é‡‘ï¼ˆä»å— 1/æ—¥ã€æœˆä¸Šé™ã€500 åç­‰é™åˆ¶ï¼‰ã€‚`,
    plaques_laugh:
`ç¬‘ç­Šï½œæé†’ï¼šåˆ¥æ€¥ã€‚
å¸‚å ´çš„ç¬‘ï¼Œæ˜¯è¦ä½ æ…¢ä¸€æ‹ã€‚
ä½ é‚„æœ‰å‰©ä¸‹çš„ç¢‘å¯ä»¥å†ç«‹ä¸€æ¬¡ã€‚`,
    plaques_yin:
`é™°ç­Šï½œæé†’ï¼šå®ˆå¿ƒã€‚
ä»Šå¤©çš„æ°£è„ˆåä¿å®ˆï¼Œå…ˆè§€æœ›å†å‡ºæ‰‹ã€‚
ä½ ä»å¯å®Œæˆå‰©é¤˜ç¢‘ï¼Œæˆ–æ˜æ—¥å†ä¾†ã€‚`,
    mars_refresh_done:
`å·²åˆ·æ–°å¸­ä½é¡¯ç¤ºã€‚
æ­£å¼å¸­ä½æ†‘è­‰ä»¥ã€Œéˆä¸Šé‚„é¡˜è½‰å¸³ã€ç‚ºæº–ï¼›ç›®å‰å‰ç«¯åªåšå¼•å°èˆ‡è¦–è¦ºåŒ–ã€‚`,
    mars_recorded:
`å·²åœ¨æœ¬æ©Ÿè¨˜éŒ„ +1 å¸­ã€‚
ä¸‹ä¸€æ­¥ï¼šè«‹åœ¨éˆä¸Šå®Œæˆ 5000 KGEN é‚„é¡˜è½‰å¸³åˆ° MARS / KUFO Vaultï¼Œæ‰ç®—çœŸæ­£å…¥å¸­ã€‚`,
    mars_full:
`500 å¸­ä½å·²æ»¿ã€‚
æ­¤æ™‚å¯æ”¹èµ°ä¸€èˆ¬æŒæœ‰åˆ†æ½¤ï¼ˆæˆ–ç­‰å¾…æœªä¾†æ“´åº§ï¼‰ã€‚`,
    copy_mars_done:
`MARS åœ°å€å·²è¤‡è£½ã€‚
è²¼åˆ°éŒ¢åŒ…ã€Œè½‰å¸³ã€å³å¯ã€‚`,
    addr_missing:
`åœ°å€å°šæœªè¨­å®šã€‚
è«‹å…ˆåœ¨ã€Œéˆä¸Šé…ç½®ã€é¢æ¿æŠŠ KUFO / MARS åœ°å€å¡«å¥½ã€‚`,
    fairy_14520:
`å¤§ä»™å¥³ å·§é›²ï¼ˆ14520ï½œå¤©æ¨ï¼‰
ä¸»ç¥ç¦ï¼šé¢¨èª¿é›¨é †
ç¯€å¥æé†’ï¼šåç©ºï¼Œå…ˆå®ˆå¾Œæ”»ã€‚
é¡˜æœ›é©ç”¨ï¼šäº‹æ¥­è½‰æ©Ÿã€å¤©æ°£èˆ‡è¡Œç¨‹ã€é¿éšªä¿å¹³å®‰ã€‚`,
    fairy_14866:
`äºŒä»™å¥³ å·§è™¹ï¼ˆ14866ï½œå¤©ç’‡ï¼‰
ä¸»ç¥ç¦ï¼šå®¶åº­ç¾æ»¿
ç¯€å¥æé†’ï¼šåå¤šï¼Œä½†ä¸è¿½åƒ¹ã€‚
é¡˜æœ›é©ç”¨ï¼šå®¶é‹ã€å’Œè§£ã€é•·æœŸä¿®å¾©ã€‚`,
    fairy_16184:
`ä¸‰ä»™å¥³ å·§èŠï¼ˆ16184ï½œå¤©ç’£ï¼‰
ä¸»ç¥ç¦ï¼šè‚²å­æ”¶é©š
ç¯€å¥æé†’ï¼šåç©ºï¼Œå…ˆæ’é›·ã€‚
é¡˜æœ›é©ç”¨ï¼šå­©å­ã€ç¡çœ ã€ç„¦æ…®èˆ‡é©šåš‡åŒ–è§£ã€‚`,
    fairy_16888:
`å››ä»™å¥³ å·§ä»™ï¼ˆ16888ï½œå¤©æ¬Šï¼‰
ä¸»ç¥ç¦ï¼šäº‹æ¥­é‹é€š
ç¯€å¥æé†’ï¼šåå¤šï¼Œæ­¥æ­¥ç‚ºç‡Ÿã€‚
é¡˜æœ›é©ç”¨ï¼šå‡é·ã€è«‡åˆ¤ã€å°ˆæ¡ˆæ¨é€²ã€‚`,
    fairy_17347:
`äº”ä»™å¥³ å·§è˜­ï¼ˆ17347ï½œå¤©è¡¡ï¼‰
ä¸»ç¥ç¦ï¼šé•·å‘½ç™¾æ­²
ç¯€å¥æé†’ï¼šåç©ºï¼Œå…ˆå®ˆå‘½ã€‚
é¡˜æœ›é©ç”¨ï¼šé«”èƒ½ã€å¾©åŸã€é•·æœŸä¿å¥ã€‚`,
    fairy_18056:
`å…­ä»™å¥³ å·§æ¢…ï¼ˆ18056ï½œé—“é™½ï¼‰
ä¸»ç¥ç¦ï¼šèº«é«”å¥åº·
ç¯€å¥æé†’ï¼šåå¤šï¼Œä½†è¦å®ˆç¯€å¾‹ã€‚
é¡˜æœ›é©ç”¨ï¼šåº·å¾©ã€è¨“ç·´ã€æˆ’å£ç¿’æ…£ã€‚`,
    fairy_18459:
`ä¸ƒä»™å¥³ å·§éˆï¼ˆ18459ï½œç‘¤å…‰ï¼‰
ä¸»ç¥ç¦ï¼šæ„Ÿæƒ…åœ“æ»¿
ç¯€å¥æé†’ï¼šå¤šå–®é€€ï¼ˆä¿æœ¬é€€å ´ï¼‰ã€‚
é¡˜æœ›é©ç”¨ï¼šä¿®å¾©é—œä¿‚ã€å‘Šåˆ¥åŸ·å¿µã€å›åˆ°å¹³è¡¡ã€‚`
};

  function smart(topic) {
    setAi(HELP[topic] || HELP.welcome, true);
    log("smart:" + topic);
  }

  // Inject mini panels if missing
  function ensurePanels() {
    const aiReply = $("#aiReply");
    const hostCard = aiReply ? aiReply.closest(".card") : null;
    if (!hostCard) return;

    const insertAfter = (node) => hostCard.parentNode.insertBefore(node, hostCard.nextSibling);

    if (!$("#vitalsMini")) {
      const wrap = document.createElement("div");
      wrap.className = "card";
      wrap.style.marginTop = "12px";
      wrap.innerHTML = `
        <div class="row" style="justify-content:space-between; align-items:center;">
          <div style="font-weight:900;">ç”Ÿå‘½è·¡è±¡</div>
          <button class="btn ghost" id="btnVitalsMini">è§£èªª</button>
        </div>
        <div id="vitalsMini" class="row" style="gap:10px; flex-wrap:wrap; margin-top:10px;">
          <div class="pill" style="padding:10px 12px;">å‘¼å¸ï¼š<b id="vBreath">ç©©å®š</b></div>
          <div class="pill" style="padding:10px 12px;">å¿ƒè·³ï¼š<b id="vHeart">æ¯å°æ™‚</b></div>
          <div class="pill" style="padding:10px 12px;">è¡€å£“ï¼š<b id="vBP">120/80</b></div>
        </div>
        <div class="small muted" style="margin-top:8px;">æç¤ºï¼šè‹¥æ²’æœ‰ç«‹åˆ»å‡ºè²ï¼Œè«‹å…ˆè¼•è§¸ä¸€æ¬¡ç•«é¢è§£é–èªéŸ³ã€‚</div>
      `;
      insertAfter(wrap);
      $("#btnVitalsMini").addEventListener("click", () => smart("vitals"));
    }

    if (!$("#plaquesStatus")) {
      const wrap = document.createElement("div");
      wrap.className = "card";
      wrap.style.marginTop = "12px";
      wrap.innerHTML = `
        <div class="row" style="justify-content:space-between; align-items:center;">
          <div style="font-weight:900;">ä¸‰è–ç¢‘ï¼ˆé ˜ç™¼è²¡é‡‘å‰ï¼‰</div>
          <button class="btn ghost" id="btnPlaquesHelp">è§£èªª</button>
        </div>
        <div class="small muted" style="margin-top:6px;">é€£çºŒä¸‰æ¬¡è–æ¯æ‰æ”¾è¡Œï¼ˆæœ¬æ©Ÿå„€å¼ç‰ˆï¼‰ã€‚</div>
        <div class="row" style="gap:10px; flex-wrap:wrap; margin-top:10px;">
          <button class="btn btnPlaque">æ“²ç­Š 1</button>
          <button class="btn btnPlaque">æ“²ç­Š 2</button>
          <button class="btn btnPlaque">æ“²ç­Š 3</button>
          <button class="btn ghost" id="btnResetPlaques">é‡ç½®</button>
        </div>
        <div id="plaquesStatus" class="pill" style="margin-top:10px; padding:10px 12px;">ä¸‰è–ç¢‘ï¼š0/3</div>
        <div class="row" style="gap:10px; flex-wrap:wrap; margin-top:10px;">
          <button class="btn" id="btnClaimFortune" disabled>æ”¾è¡Œå¾Œé ˜ç™¼è²¡é‡‘</button>
          <button class="btn ghost" id="btnLamp108">é»ç‡ˆ 108 KGEN</button>
        </div>
      `;
      hostCard.parentNode.insertBefore(wrap, hostCard.nextSibling);
      $("#btnPlaquesHelp").addEventListener("click", () => smart("plaques"));
      $("#btnLamp108").addEventListener("click", () => smart("lamp"));
    }

    if (!$("#btnGoWalletX")) {
      const wrap = document.createElement("div");
      wrap.className = "card";
      wrap.style.marginTop = "12px";
      wrap.innerHTML = `
        <div class="row" style="justify-content:space-between; align-items:center;">
          <div style="font-weight:900;">å®‡å®™ç´°åŒ… & å®‡å®™å•†åº—</div>
          <button class="btn ghost" id="btnShopHelp">è§£èªª</button>
        </div>
        <div class="row" style="gap:10px; flex-wrap:wrap; margin-top:10px;">
          <button class="btn" id="btnGoWalletX">å®‡å®™ç´°åŒ…ï¼ˆéŒ¢åŒ…æ•™å­¸ï¼‰</button>
          <button class="btn" id="btnGoShopX">å®‡å®™å•†åº—ï¼ˆå•†å®¶å…¥å£ï¼‰</button>
          <button class="btn ghost" id="btnFortune">ç™¼è²¡é‡‘æµç¨‹</button>
        </div>
        <div class="small muted" style="margin-top:8px;">å•†å®¶å¯ç”¨ KGEN åšç´…åˆ©å›é¥‹ï¼›é¡§å®¢å›ç¥æ®¿é»ç‡ˆèˆ‡äº’å‹•ã€‚</div>
      `;
      hostCard.parentNode.insertBefore(wrap, hostCard.nextSibling);
      $("#btnShopHelp").addEventListener("click", () => smart("shop"));
      $("#btnGoWalletX").addEventListener("click", () => smart("wallet"));
      $("#btnGoShopX").addEventListener("click", () => smart("shop"));
      $("#btnFortune").addEventListener("click", () => smart("fortune"));
    }
  }

  function initPlaquesLogic() {
  // ä¸‰è–ç¢‘ï¼ˆæ“²ç­Šï¼‰â€” æ¯æ—¥æœ€å¤š 3 æ¬¡ï¼Œåªè¦å‡ºç¾è‡³å°‘ 1 æ¬¡ã€Œè–ç­Šã€å³å¯é€šé—œ
  const key = "WUZHISHAN_PLAQUES_V1";
  const nowDayId = () => Math.floor((Date.now() + 8*3600*1000) / 86400000);

  const defaultState = () => ({
    dayId: nowDayId(),
    throws: 0,
    holy: 0,
    last: "",
    passed: false
  });

  const load = () => {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return defaultState();
      const s = JSON.parse(raw);
      if (!s || typeof s !== "object") return defaultState();
      // reset on new day
      if (s.dayId !== nowDayId()) return defaultState();
      s.passed = (s.holy || 0) >= 1; // pass rule
      return s;
    } catch (_) {
      return defaultState();
    }
  };

  const save = (s) => localStorage.setItem(key, JSON.stringify(s));

  const roll = () => {
    // Simple weighted roll: è– 20%, ç¬‘ 20%, é™° 60%
    const r = Math.random();
    if (r < 0.20) return "è–ç­Š";
    if (r < 0.40) return "ç¬‘ç­Š";
    return "é™°ç­Š";
  };

  const render = () => {
    const s = load();

    const label = document.getElementById("cupStatus");
    if (label) {
      const passText = s.passed ? "âœ… ä»Šæ—¥é€šé—œ" : "â›” å°šæœªé€šé—œ";
      label.textContent = `ä¸‰è–ç¢‘ï¼š${s.throws}/3ï½œä»Šæ—¥è–ç­Š=${s.holy}ï½œ${passText}ï¼ˆ${s.last || "å°šæœªæ“²ç­Š"}ï¼‰`;
    }

    const btns = ["btnCup1", "btnCup2", "btnCup3"].map(id => document.getElementById(id)).filter(Boolean);
    btns.forEach((b, i) => {
      const n = i + 1;
      if (s.throws >= n) {
        b.disabled = true;
        b.textContent = `ç¬¬${n}ç¢‘å·²ç«‹`;
      } else {
        b.disabled = false;
        b.textContent = `ç«‹ç¬¬${n}ç¢‘ï¼ˆæ“²ç­Šï¼‰`;
      }
    });

    // Fortune button gate (front-end)
    const fortuneBtn = document.getElementById("btnFortune");
    if (fortuneBtn) {
      fortuneBtn.disabled = !s.passed;
      fortuneBtn.dataset.topic = "fortune_gate";
    }
  };

  const doThrow = () => {
    const s = load();
    if (s.throws >= 3) return;

    const res = roll();
    s.throws += 1;
    s.last = res;
    if (res === "è–ç­Š") s.holy += 1;

    s.passed = s.holy >= 1;
    save(s);

    // Smart help / toast
    smartHelp(res === "è–ç­Š" ? "plaques_holy" : (res === "ç¬‘ç­Š" ? "plaques_laugh" : "plaques_yin"), {res, state: s});
    render();
  };

  ["btnCup1", "btnCup2", "btnCup3"].forEach((id) => {
    const b = document.getElementById(id);
    if (!b) return;
    b.addEventListener("click", doThrow);
  });

  render();
}

// ===================== MARS Seats (Front-end display) =====================
function initMarsSeats() {
  const SEATS_TOTAL = 500;
  const key = "WUZHISHAN_MARS_SEATS_V1";
  const elRemain = document.getElementById("marsSeatsRemaining");
  const elAddr = document.getElementById("addrMARS");
  const btnCopy = document.getElementById("btnCopyMARS");
  const btnVow = document.getElementById("btnMarsVow5000");
  const btnRef = document.getElementById("btnMarsRefresh");

  const get = () => {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return {count:0};
      const s = JSON.parse(raw);
      if (!s || typeof s.count !== "number") return {count:0};
      return s;
    } catch (_) { return {count:0}; }
  };
  const set = (s) => localStorage.setItem(key, JSON.stringify(s));

  const render = () => {
    const s = get();
    const remain = Math.max(0, SEATS_TOTAL - s.count);
    if (elRemain) elRemain.textContent = String(remain);
    const marsAddr = (window.WUZHISHAN_CFG && (WUZHISHAN_CFG.mars || WUZHISHAN_CFG.kufo)) || "";
    if (elAddr) elAddr.textContent = marsAddr || "ï¼ˆå°šæœªè¨­å®šï¼‰";
  };

  const copyAddr = async () => {
    const marsAddr = (window.WUZHISHAN_CFG && (WUZHISHAN_CFG.mars || WUZHISHAN_CFG.kufo)) || "";
    if (!marsAddr) { smartHelp("addr_missing"); return; }
    try {
      await navigator.clipboard.writeText(marsAddr);
      toast("å·²è¤‡è£½ MARS åœ°å€");
    } catch (_) {
      toast("ç„¡æ³•è‡ªå‹•è¤‡è£½ï¼Œè«‹æ‰‹å‹•é•·æŒ‰è¤‡è£½");
    }
    smartHelp("copy_mars_done");
  };

  const recordSeat = () => {
    const s = get();
    if (s.count >= SEATS_TOTAL) {
      toast("å¸­ä½å·²æ»¿ï¼ˆ500/500ï¼‰");
      smartHelp("mars_full");
      return;
    }
    s.count += 1;
    set(s);
    toast("å·²åœ¨æœ¬æ©Ÿè¨˜éŒ„ï¼š+1 å¸­ï¼ˆæ­£å¼ä»¥éˆä¸Šè½‰å¸³ç‚ºæº–ï¼‰");
    smartHelp("mars_recorded");
    render();
  };

  if (btnCopy) btnCopy.addEventListener("click", copyAddr);
  if (btnVow) btnVow.addEventListener("click", recordSeat);
  if (btnRef) btnRef.addEventListener("click", () => { render(); smartHelp("mars_refresh_done"); });

  render();
}

const progKey = "wuzhishan_build_progress_v455";
  const loadP = () => { try { return JSON.parse(localStorage.getItem(progKey) || "{}") || {}; } catch { return {}; } };
  const saveP = (p) => localStorage.setItem(progKey, JSON.stringify(p));
  const pct = (p) => Math.round(Object.values(p).filter(Boolean).length * 100 / CHECKS.length);

  function updateBar() {
    const p = loadP();
    const bar = $("#buildProgress");
    if (bar) bar.value = pct(p);
    const lab = $("#buildProgressLabel");
    if (lab) lab.textContent = `${pct(p)}%`;
  }
  function renderChecklist() {
    const p = loadP();
    const wrap = $("#buildChecklistList");
    if (!wrap) return;
    wrap.innerHTML = "";
    for (const c of CHECKS) {
      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <input type="checkbox" ${p[c.key] ? "checked":""} data-k="${c.key}">
        <div>
          <div style="font-weight:800;">${c.label}</div>
          <div class="small muted">${c.key}</div>
        </div>
      `;
      wrap.appendChild(row);
    }
    wrap.onchange = (e) => {
      const k = e.target && e.target.dataset ? e.target.dataset.k : null;
      if (!k) return;
      const p2 = loadP();
      p2[k] = !!e.target.checked;
      saveP(p2);
      updateBar();
    };
  }
  function openChecklist() {
    const m = $("#buildChecklistModal");
    if (!m) return;
    m.classList.remove("hidden");
    renderChecklist();
    updateBar();
    smart("progress");
  }
  function closeChecklist() {
    const m = $("#buildChecklistModal");
    if (!m) return;
    m.classList.add("hidden");
  }

  function bindEcho() {
    // existing nav buttons if any
    ["btnGoWallet","btnGoShop","btnShowBuildChecklist"].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      if (id==="btnGoWallet") el.addEventListener("click", () => smart("wallet"));
      if (id==="btnGoShop") el.addEventListener("click", () => smart("shop"));
      if (id==="btnShowBuildChecklist") el.addEventListener("click", openChecklist);
    });

    // fallback
    document.addEventListener("click", (e) => {
      const b = e.target.closest("button");
      if (!b) return;
      const t = (b.textContent || "").trim();
      if (t.includes("å®‡å®™ç´°åŒ…")) return smart("wallet");
      if (t.includes("å®‡å®™å•†åº—")) return smart("shop");
      if (t.includes("é»ç‡ˆ")) return smart("lamp");
      if (t.includes("ç™¼è²¡é‡‘")) return smart("fortune");
      if (t.includes("ä¸ƒä»™å¥³")) return smart("fairies");
      if (t.includes("ç”Ÿå‘½") || t.includes("å‘¼å¸") || t.includes("å¿ƒè·³") || t.includes("è¡€å£“")) return smart("vitals");
      if (t.includes("å®Œå·¥") || t.includes("é€²åº¦")) return smart("progress");
    });
  }

  function applySafeBottom() {
    const main = $("#main") || document.body;
    if (main) main.classList.add("safe-bottom");
  }

  document.addEventListener("DOMContentLoaded", () => {
    bumpVisit();
    applySafeBottom();
    ensurePanels();
    initPlaquesLogic();
    initMarsSeats();
    bindEcho();

    const btn = $("#btnShowBuildChecklist");
    if (btn) btn.addEventListener("click", openChecklist);
    const close = $("#btnCloseBuildChecklist");
    if (close) close.addEventListener("click", closeChecklist);
    const modal = $("#buildChecklistModal");
    if (modal) modal.addEventListener("click", (e) => { if (e.target === modal) closeChecklist(); });

    const markAll = $("#btnMarkAllDone");
    if (markAll) markAll.addEventListener("click", () => {
      const p = {}; CHECKS.forEach(c => p[c.key]=true);
      saveP(p); renderChecklist(); updateBar();
      setAi("å·²å…¨éƒ¨æ¨™è¨˜å®Œæˆï¼ˆæœ¬æ©Ÿï¼‰ã€‚ç­‰ä½ çµ¦æˆ‘éˆä¸Šåœ°å€å¾Œï¼Œæˆ‘æœƒæ”¹æˆè®€éˆä¸Šç‹€æ…‹è‡ªå‹•æ›´æ–°ã€‚", true);
    });
    const reset = $("#btnResetProgress");
    if (reset) reset.addEventListener("click", () => { saveP({}); renderChecklist(); updateBar(); smart("progress"); });

    updateBar();

    // greet: try to speak; may need user gesture on mobile
    setTimeout(() => smart("welcome"), 350);

    log("boot:" + BOOT);
    log("speechSynthesis:" + ("speechSynthesis" in window));
    log("ethereum_injected_now:" + (typeof window.ethereum !== "undefined"));
  });
})();
</script>

<!-- Build Checklist Modal -->
<div id="buildChecklistModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="å®Œå·¥æ¸…å–®">
  <div class="modal-card">
    <div class="modal-head">
      <div class="modal-title">äº”æŒ‡å±±æ‚Ÿç©ºè²¡ç¥æ®¿ï½œå®Œå·¥æ¸…å–®</div>
      <button class="btn ghost" id="btnCloseBuildChecklist">é—œé–‰</button>
    </div>
    <div class="modal-body">
      <div class="small muted">æ­¤æ¸…å–®ç‚ºæœ¬æ©Ÿç´€éŒ„ï¼ˆlocalStorageï¼‰ã€‚æœªä¾†æ¥å¾Œç«¯/éˆä¸Šå¾Œå¯æ”¹ç‚ºå…¨åŸŸã€‚</div>
      <div id="buildChecklistList" class="checklist"></div>
      <div class="row" style="margin-top:12px; gap:10px; flex-wrap:wrap;">
        <button class="btn" id="btnMarkAllDone">å…¨éƒ¨æ¨™è¨˜å®Œæˆ</button>
        <button class="btn ghost" id="btnResetProgress">é‡ç½®é€²åº¦</button>
      </div>
    </div>
  </div>
</div>

</body>

<script>
// === V4.5.3 UX HOTFIX: Smart Help + SelfCheck + Button Echo ===
(function(){
  const $ = (q,el=document)=>el.querySelector(q);
  const $$ = (q,el=document)=>Array.from(el.querySelectorAll(q));

  const scrim = $('#klineHelpScrim');
  const drawer = $('#klineHelpDrawer');
  const body = $('#klineHelpBody');
  const sub = $('#klineHelpSub');
  const actions = $('#klineHelpActions');
  const closeBtn = $('#klineHelpClose');

  function speak(text){
    try{
      if(!window.speechSynthesis) return;
      const sel = window.__kline_tts_mode || 'auto';
      if(sel==='off') return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'zh-TW';
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(e){}
  }

  function openHelp(payload){
    const {title, subtitle, message, ctas=[] , tts=true} = payload||{};
    if(title) drawer.querySelector('.title').textContent = title;
    sub.textContent = subtitle || 'æˆ‘åœ¨ã€‚å‘Šè¨´æˆ‘ä½ æƒ³åšä»€éº¼ï¼Œæˆ‘æœƒå¸¶ä½ ä¸€æ­¥ä¸€æ­¥å®Œæˆã€‚';
    body.textContent = message || '';
    actions.innerHTML = '';
    ctas.forEach(c=>{
      const b=document.createElement('button');
      b.type='button';
      b.className='btn'+(c.primary?' primary':'')+(c.danger?' danger':'');
      b.textContent=c.label;
      b.addEventListener('click', ()=>{ try{c.onClick && c.onClick();}catch(e){} });
      actions.appendChild(b);
    });
    scrim.classList.add('open');
    drawer.classList.add('open');
    if(tts && message) speak(message.replace(/
+/g,' '));
  }
  function closeHelp(){
    scrim.classList.remove('open');
    drawer.classList.remove('open');
  }
  scrim && scrim.addEventListener('click', closeHelp);
  closeBtn && closeBtn.addEventListener('click', closeHelp);

  // Map help topics
  const HELP = {
    heartbeat: {
      title:'å¿ƒè·³ï½œæ‚Ÿç©ºç”Ÿå‘½è·¡è±¡',
      message:'ä½ å‰›æŒ‰çš„æ˜¯ã€Œå¿ƒè·³ã€ã€‚

é€™æ˜¯ç¥æ®¿çš„ç”Ÿå‘½åŸºç¤è¨­æ–½ï¼šç”¨ä¾†ç¢ºèªç³»çµ±æœ‰åœ¨é‹ä½œã€ç‹€æ…‹æœ‰æ›´æ–°ã€‚

ä¸‹ä¸€æ­¥ï¼šå¦‚æœä½ è¦é ˜ç™¼è²¡é‡‘ï¼Œè«‹å…ˆé€£éŒ¢åŒ…ï¼Œç„¶å¾Œå®Œæˆä¸‰è–ç­Šï¼ˆ0/3 æœƒé¡¯ç¤ºåœ¨ç¥æ®¿ï¼‰ã€‚',
      ctas:[
        {label:'å»é€£éŒ¢åŒ…', primary:true, onClick:()=>clickByText('é€£ç·šéŒ¢åŒ…')},
        {label:'çœ‹ä¸‰è–ç­Šè¦å‰‡', onClick:()=>openHelp(HELP.saintcups)},
      ]
    },
    breathe:{
      title:'å‘¼å¸ï½œå®‡å®™ç´°èƒ',
      message:'ä½ æŒ‰çš„æ˜¯ã€Œå‘¼å¸ã€ã€‚

å‘¼å¸ä»£è¡¨ã€Œå®‡å®™ç´°åŒ…ã€é–‹å§‹è¨˜éŒ„ä½ çš„äº’å‹•ï¼šè¨±é¡˜ã€é»ç‡ˆã€é ˜ç™¼è²¡é‡‘ã€ä¸‹å–®æ¡Œå‹•ä½œéƒ½æœƒç•™ä¸‹è¶³è·¡ï¼ˆæœ¬æ©Ÿ/ä¸Šéˆè¦–æ¨¡å¼ï¼‰ã€‚

ä¸‹ä¸€æ­¥ï¼šæƒ³æŠŠè³‡æ–™å¸¶èµ°ï¼Ÿç”¨ã€ŒåŒ¯å‡ºç‹€æ…‹ JSONã€ã€‚',
      ctas:[{label:'åŒ¯å‡ºç‹€æ…‹ JSON', primary:true, onClick:()=>clickByText('åŒ¯å‡ºç‹€æ…‹ JSON')}]
    },
    blood:{
      title:'è¡€å£“ï½œèƒ½é‡å£“åŠ›',
      message:'ä½ æŒ‰çš„æ˜¯ã€Œè¡€å£“ã€ã€‚

è¡€å£“ç”¨ä¾†æé†’ä½ ç›®å‰çš„ã€Œæ§“æ¡¿/æ–¹å‘ç›¤ã€æ˜¯å¦è™•åœ¨å±éšªå€ã€‚
è¦å‰‡ï¼šæœ€å¤§è´è™§ä»¥ ATR14 ç‚ºä¸Šé™ï¼ˆä½ å®šç¾©çš„å®‡å®™é¢¨æ§ï¼‰ã€‚

ä¸‹ä¸€æ­¥ï¼šå…ˆæŠŠæ§“æ¡¿èª¿åˆ° 1x æˆ– 5x åšæ¸¬è©¦ï¼Œå†é€²ä¸‹å–®æ¡Œã€‚',
      ctas:[{label:'å›ä¸‹å–®æ¡Œ', primary:true, onClick:()=>clickByText('ä¸‹å–®æ¡Œ')}]
    },
    saintcups:{
      title:'ä¸‰è–ç­Šï½œé ˜ç™¼è²¡é‡‘é–€æª»',
      message:'é ˜ç™¼è²¡é‡‘ä¹‹å‰ï¼Œéœ€è¦å®Œæˆã€Œä¸‰è–ç­Š 0/3ã€ã€‚

å®ƒæ˜¯é˜²åˆ·æ©Ÿåˆ¶ï¼šæ¯æ¬¡æ“²ç­Šæœƒè¨˜éŒ„åœ¨æœ¬æ©Ÿç‹€æ…‹ï¼›ä¸Šéˆæ¨¡å¼æœƒç”±å¿ƒè‡Ÿåˆç´„é©—è­‰ã€‚

æ²’éŒ¢åŒ…ä¹Ÿèƒ½å…ˆé€›ç¥æ®¿ï¼šä½†è¦ã€Œé ˜ã€æˆ–ã€Œé»ç‡ˆ/é‚„é¡˜ã€å°±éœ€è¦éŒ¢åŒ…ã€‚',
      ctas:[
        {label:'å»æ“²ç­Š', primary:true, onClick:()=>clickByText('æ“²ç­Š')},
        {label:'å»é€£éŒ¢åŒ…', onClick:()=>clickByText('é€£ç·šéŒ¢åŒ…')}
      ]
    },
    lamp:{
      title:'å…‰æ˜ç‡ˆï½œ108 KGEN ä¾›é¤Š',
      message:'ä½ æŒ‰çš„æ˜¯ã€Œé»å…‰æ˜ç‡ˆã€ã€‚

è¦å‰‡ï¼šæ¯æ¬¡é»ç‡ˆæ”¶ 108 KGENï¼ˆè±¡å¾µ 108 åŸå­ï¼‰ã€‚
æœ¬æ©Ÿæ¨¡å¼æœƒå…ˆè¨˜éŒ„é»ç‡ˆè³‡æ–™ï¼›ä¸Šéˆæ¨¡å¼æœƒç”± KUFO ç„¡äººéŠ€è¡Œæ”¶æ¬¾ã€ç•™ä¸‹éˆä¸Šæ”¶æ“šã€‚

ä¸‹ä¸€æ­¥ï¼šè‹¥ä½ é‚„æ²’æœ‰éŒ¢åŒ…ï¼Œæˆ‘å¯ä»¥ä¸€æ­¥ä¸€æ­¥å¸¶ä½ è£ MetaMaskã€‚',
      ctas:[
        {label:'æ–°æ‰‹ï¼šæ²’éŒ¢åŒ…æ€éº¼é–‹å§‹', primary:true, onClick:()=>openHelp(HELP.nowallet)},
        {label:'æˆ‘å·²ç¶“æœ‰éŒ¢åŒ…â†’é€£ç·š', onClick:()=>clickByText('é€£ç·šéŒ¢åŒ…')},
      ]
    },
    nowallet:{
      title:'æ–°æ‰‹å°è¦½ï½œå¾ 0 åˆ°èƒ½ä¸‹å–®',
      message:'æ­¥é©Ÿä¸€ï¼šå®‰è£ MetaMaskï¼ˆChrome æˆ– Appï¼‰ã€‚
æ­¥é©ŸäºŒï¼šåˆ‡åˆ° BNB Chainï¼ˆBSC / BEP20ï¼‰ã€‚
æ­¥é©Ÿä¸‰ï¼šæº–å‚™å°‘é‡ BNB ç•¶ gasã€‚
æ­¥é©Ÿå››ï¼šæŠŠ KGEN ä»£å¹£åˆç´„åŠ å…¥éŒ¢åŒ…ï¼ˆä½ å·²éƒ¨ç½²ï¼‰ã€‚

å®Œæˆå¾Œå›ç¥æ®¿æŒ‰ã€Œé€£ç·šéŒ¢åŒ…ã€ã€‚',
      ctas:[
        {label:'æˆ‘çŸ¥é“äº†ï¼Œå›ç¥æ®¿', primary:true, onClick:()=>closeHelp()}
      ],
      tts:false
    },
    orderdesk:{
      title:'ä¸‹å–®æ¡Œï½œT+2 äº¤æ˜“å®¤',
      message:'ä½ é€²å…¥ã€Œä¸‹å–®æ¡Œã€ã€‚

ç›®å‰ç¥æ®¿æœ‰å…©ç¨®æ¨¡å¼ï¼š
1) æœ¬æ©Ÿæ¨¡æ“¬ï¼šå¯ç·´ç¿’æ§“æ¡¿ã€æ–¹å‘ç›¤ã€åœåˆ©åœæã€T+2 çµç®—æµç¨‹ã€‚
2) ä¸Šéˆæˆäº¤ï¼šéœ€è¦æŠŠäº¤æ˜“å¼•æ“æ¥åˆ°ã€Œå¿ƒè‡Ÿ/ KUFO/ å¤§è…¦ã€ä¸‰å™¨å®˜ï¼Œæ‰æœƒæœ‰éˆä¸Šè¨˜éŒ„èˆ‡çµç®—ã€‚

ä¸‹ä¸€æ­¥ï¼šå…ˆç”¨ 1x èµ°ä¸€ç­†æµç¨‹ï¼Œç¢ºèªä½ çœ‹å¾—æ‡‚é¢¨æ§èˆ‡çµç®—ã€‚',
      ctas:[
        {label:'æ•™æˆ‘è¨­å®šåœæåœåˆ©', primary:true, onClick:()=>openHelp(HELP.risk)},
        {label:'å›é§•é§›è‰™', onClick:()=>clickByText('é§•é§›è‰™')}
      ]
    },
    risk:{
      title:'é¢¨æ§ï½œåœåˆ©åœæèˆ‡ ATR14',
      message:'è¦å‰‡ï¼ˆä½ å®šç¾©ï¼‰ï¼šæœ€å¤§è´è™§ä»¥ Â±ATR14 ç‚ºç•Œã€‚

åœåˆ© / åœæï¼š
- åˆ°åƒ¹å³è¨˜éŒ„ï¼ˆæ¨¡æ“¬ï¼‰æˆ–è§¸ç™¼çµç®—ï¼ˆä¸Šéˆï¼‰ã€‚
- è‹¥çµç®—æ—¥åŒæ™‚è§¸ç™¼åœåˆ©èˆ‡åœæï¼šåˆ¤å®šã€Œä¸ç®—è¼¸è´ã€ã€‚

å»ºè­°ï¼šæ–°æ‰‹å…ˆç”¨ 1xï½5xã€‚',
      ctas:[{label:'å›ä¸‹å–®æ¡Œ', primary:true, onClick:()=>clickByText('ä¸‹å–®æ¡Œ')}]
    },
    zodiac:{
      title:'13 ç”Ÿè‚–ï½œ72 åé¡ç•™å¿µ',
      message:'ä½ é€²å…¥ã€Œ13 ç”Ÿè‚– / å…‰æ˜ç‡ˆã€å€ã€‚

ç”¨é€”ï¼šè§€å…‰å®¢ç•™åã€é»ç‡ˆç•™å¿µã€é‚„é¡˜ç´€éŒ„ã€‚
æ¯ç”Ÿè‚– 72 åé¡ï¼ˆå¯é¸æ ¼â†’å¡«è³‡æ–™â†’é€å‡ºï¼‰ã€‚

ä¸‹ä¸€æ­¥ï¼šæƒ³æŠŠç™»è¨˜è³‡æ–™å¸¶èµ°ï¼ŒæŒ‰ã€ŒåŒ¯å‡ºç‹€æ…‹ JSONã€ã€‚',
      ctas:[{label:'åŒ¯å‡ºç‹€æ…‹ JSON', primary:true, onClick:()=>clickByText('åŒ¯å‡ºç‹€æ…‹ JSON')}]
    },
    fairies:{
      title:'ä¸ƒä»™å¥³ï½œåŒ—æ–—ä¸ƒæ˜Ÿåº§æ¨™ç³»',
      message:'ä¸ƒä»™å¥³ä½åœ¨ã€ŒåŒ—æ–—ä¸ƒæ˜Ÿã€çš„ 7 å€‹åº§æ¨™é»ï¼Œè² è²¬ä¸åŒçš„è¨±é¡˜è·¯å¾‘ï¼š

14520 å¤§ä»™å¥³ å·§é›²ï½œå¤©æ¨ï½œé¢¨èª¿é›¨é †ï¼ˆåšç©ºï¼‰
14866 äºŒä»™å¥³ å·§è™¹ï½œå¤©ç’‡ï½œå®¶åº­ç¾æ»¿ï¼ˆåšå¤šï¼‰
16184 ä¸‰ä»™å¥³ å·§èŠï½œå¤©ç’£ï½œè‚²å­æ”¶é©šï¼ˆåšç©ºï¼‰
16888 å››ä»™å¥³ å·§ä»™ï½œå¤©æ¬Šï½œäº‹æ¥­é‹é€šï¼ˆåšå¤šï¼‰
17347 äº”ä»™å¥³ å·§è˜­ï½œå¤©è¡¡ï½œé•·å‘½ç™¾æ­²ï¼ˆåšç©ºï¼‰
18056 å…­ä»™å¥³ å·§æ¢…ï½œé—“é™½ï½œèº«é«”å¥åº·ï¼ˆåšå¤šï¼‰
18459 ä¸ƒä»™å¥³ å·§éˆï½œç‘¤å…‰ï½œæ„Ÿæƒ…åœ“æ»¿ï¼ˆå¤šå–®é€€ï¼‰

ä½ å¯ä»¥ï¼šé¸ f1ï½f7 â†’ å¯«é¡˜æœ› â†’ å¯«é‚„é¡˜ â†’ åŒ¯å‡º JSON ç•™å¿µã€‚',
      ctas:[{label:'å¸¶æˆ‘å»ä¸ƒä»™å¥³', primary:true, onClick:()=>scrollToText('ä¸ƒä»™å¥³ç³»çµ±')}] ,
      tts:false
    },
    pocket:{
      title:'å®‡å®™ç´°åŒ…ï½œä½ çš„èº«ä»½èˆ‡è¶³è·¡',
      message:'å®‡å®™ç´°åŒ…æ˜¯ã€Œå®¢æˆ¶ã€å…¥å£ï¼š
- è¨˜éŒ„ä½ çš„é»ç‡ˆ/è¨±é¡˜/é‚„é¡˜/ç™¼è²¡é‡‘/ä¸‹å–®æ¡Œæ“ä½œ
- å¯åŒ¯å‡º JSON ç•¶ä½œå®‡å®™è­·ç…§

ä¸‹ä¸€æ­¥ï¼šæŒ‰ã€ŒåŒ¯å‡ºç‹€æ…‹ JSONã€æŠŠè­·ç…§ä¿å­˜ã€‚',
      ctas:[{label:'åŒ¯å‡ºç‹€æ…‹ JSON', primary:true, onClick:()=>clickByText('åŒ¯å‡ºç‹€æ…‹ JSON')}] 
    },
    shop:{
      title:'å®‡å®™å•†åº—ï½œç¾å¯¦å•†åº—ä¸Šéˆç´…åˆ©',
      message:'å®‡å®™å•†åº—æ˜¯ã€Œå®¢æˆ¶é–‹çš„åº—ã€ã€‚
ä½ å¯ä»¥æŠŠç¾å¯¦åº—ï¼ˆæœé£¾/é£¯åº—/é¤é£²ï¼‰æ¥é€²ä¾†ï¼Œç”¨ KGEN ç•¶ç´…åˆ©å›é¥‹æ¶ˆè²»è€…ã€‚

ç›®å‰ï¼šå…ˆå®Œæˆã€Œåº—é‹ªè³‡æ–™ã€èˆ‡ã€Œæ”¶æ¬¾åœ°å€ã€ç™»è¨˜ï¼›æœªä¾†å¯ç”± KUFO èµ°é‡‘æµã€‚',
      ctas:[{label:'é–‹åº—ç™»è¨˜', primary:true, onClick:()=>scrollToText('å®‡å®™å•†åº—')}] ,
      tts:false
    }
  };

  function clickByText(txt){
    const btn = $$('button, a').find(el=> (el.textContent||'').replace(/\s+/g,'').includes(txt.replace(/\s+/g,'')));
    btn && btn.click();
  }
  function scrollToText(txt){
    const el = $$('*').find(n=> (n.childNodes && n.childNodes.length===1 && n.childNodes[0].nodeType===3 && (n.textContent||'').includes(txt)));
    if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
  }

  // Attach help to ALL clickable elements with heuristics
  function topicFor(el){
    const t=(el.getAttribute('data-help')||el.textContent||'').trim();
    if(/å¿ƒè·³/.test(t)) return 'heartbeat';
    if(/å‘¼å¸/.test(t)) return 'breathe';
    if(/è¡€å£“/.test(t)) return 'blood';
    if(/æ“²ç­Š|è–ç­Š|ä¸‰è–/.test(t)) return 'saintcups';
    if(/å…‰æ˜ç‡ˆ|é»ç‡ˆ|108/.test(t)) return 'lamp';
    if(/ä¸‹å–®æ¡Œ|äº¤æ˜“/.test(t)) return 'orderdesk';
    if(/ç”Ÿè‚–/.test(t)) return 'zodiac';
    if(/ä¸ƒä»™å¥³/.test(t)) return 'fairies';
    if(/å®‡å®™ç´°åŒ…/.test(t)) return 'pocket';
    if(/å®‡å®™å•†åº—/.test(t)) return 'shop';
    return null;
  }

  function wireButtons(){
    const clickables = $$('button, a, [role="button"], .btn');
    clickables.forEach(el=>{
      if(el.__kline_wired) return;
      el.__kline_wired = true;
      el.addEventListener('click', ()=>{
        const k = topicFor(el);
        if(k && HELP[k]){
          // tiny delay so original handlers still run
          setTimeout(()=>openHelp(HELP[k]), 30);
        }
      }, true);
    });
  }

  // Selfcheck + auto-fix hints
  function runSelfCheck(){
    const r = {
      ua: navigator.userAgent,
      speechSynthesis: !!window.speechSynthesis,
      speechRecognition: !!(window.SpeechRecognition || window.webkitSpeechRecognition),
      ethereumInjected: !!window.ethereum,
      isMetaMask: !!(window.ethereum && window.ethereum.isMetaMask),
      https: location.protocol === 'https:',
      ok: true,
      issues: []
    };
    if(!r.https) r.issues.push('ç›®å‰ä¸æ˜¯ HTTPSï¼šæŸäº›éŒ¢åŒ…/èªéŸ³åŠŸèƒ½å¯èƒ½è¢«é™åˆ¶ã€‚');
    if(!r.speechSynthesis) r.issues.push('é€™å€‹ç€è¦½å™¨æ²’æœ‰ TTSï¼šæˆ‘æœƒæ”¹ç”¨ã€Œæ–‡å­—å®¢æœã€æç¤ºã€‚');
    if(!r.ethereumInjected) r.issues.push('åµæ¸¬ä¸åˆ°éŒ¢åŒ…æ³¨å…¥ï¼ˆethereum_injected_now=falseï¼‰ï¼šè‹¥ä½ æ˜¯ç”¨ä¸€èˆ¬ Chromeï¼Œè«‹æ”¹ç”¨ MetaMask å…§å»ºç€è¦½å™¨ï¼Œæˆ–åœ¨æ‰‹æ©Ÿå•Ÿç”¨éŒ¢åŒ…ç€è¦½å™¨é–‹å•Ÿç¥æ®¿ã€‚');
    r.ok = r.issues.length===0;
    try{ console.log('[selfcheck]', r); }catch(e){}
    return r;
  }

  // Progress button fix: if a button says æŸ¥çœ‹å®Œå·¥æ¸…å–®, always open help with check list
  function wireProgress(){
    const btn = $$('button').find(b=>(b.textContent||'').includes('æŸ¥çœ‹å®Œå·¥æ¸…å–®'));
    if(!btn || btn.__kline_progress) return;
    btn.__kline_progress = true;
    btn.addEventListener('click', ()=>{
      const sc = runSelfCheck();
      const msg = [
        'å®Œå·¥æ¸…å–®ï¼ˆåŸºç¤è¨­æ–½ï¼‰',
        '1) ç”Ÿå‘½è·¡è±¡ï¼šå¿ƒè·³ / å‘¼å¸ / è¡€å£“ï¼ˆæŒ‰éµæœ‰å›è² + æœ‰è§£èªªï¼‰',
        '2) å®¢æœï¼šæŒ‰éµå³å‡ºç¾ã€Œä¸‹ä¸€æ­¥ã€å¼•å°ï¼ˆæœ¬é¢æ¿ï¼‰',
        '3) ä¸‰è–ç­Šï¼š0/3 â†’ 3/3 å¾Œæ‰å¯é ˜ç™¼è²¡é‡‘ï¼ˆä¸Šéˆéœ€å¿ƒè‡Ÿåˆç´„ï¼‰',
        '4) å…‰æ˜ç‡ˆï¼š108 KGEN æ”¶è²»ï¼ˆä¸Šéˆæ”¶æ¬¾èµ° KUFOï¼‰',
        '5) 13 ç”Ÿè‚–ï¼šæ¯ç”Ÿè‚– 72 åé¡ï¼ˆå¯åŒ¯å‡º JSONï¼‰',
        '6) ä¸ƒä»™å¥³ï¼šf1~f7 è¨±é¡˜/é‚„é¡˜ + åº§æ¨™ä»‹ç´¹',
        '7) å®‡å®™ç´°åŒ…ï¼šè¶³è·¡/è­·ç…§ï¼ˆJSON åŒ¯å‡ºï¼‰',
        '8) å®‡å®™å•†åº—ï¼šåº—é‹ªç™»è¨˜ï¼ˆä¹‹å¾Œæ¥ KUFO é‡‘æµï¼‰',
        '9) éŒ¢åŒ…å°è¦½ï¼šå¾ 0 åˆ°èƒ½é€£ç·š',
        '10) ä¸‹å–®æ¡Œï¼šç›®å‰æ¨¡æ“¬å¯ç”¨ï¼Œä¸Šéˆæˆäº¤å¾…ã€Œäº¤æ˜“å¼•æ“ã€æ¥å™¨å®˜',
        '',
        sc.issues.length?('è‡ªæˆ‘æª¢æ¸¬ï¼š
- '+sc.issues.join('
- ')):'è‡ªæˆ‘æª¢æ¸¬ï¼šç›®å‰æ²’æœ‰åµæ¸¬åˆ°é‡å¤§å•é¡Œã€‚'
      ].join('
');
      openHelp({title:'å®Œå·¥é€²åº¦ï½œäº”æŒ‡å±± 12345', message:msg, ctas:[{label:'é—œé–‰', primary:true, onClick:closeHelp}] , tts:false});
    });
  }

  // Initial
  wireButtons();
  wireProgress();
  const sc = runSelfCheck();
  // Auto show helpful note only when wallet missing
  if(sc.issues.length){
    openHelp({
      title:'è‡ªæˆ‘æª¢æ¸¬ï½œæˆ‘å…ˆæŠŠå•é¡Œè¬›æ¸…æ¥š',
      message: 'æˆ‘å·²å®Œæˆè‡ªæˆ‘æª¢æ¸¬ï¼Œç™¼ç¾ä»¥ä¸‹ç‹€æ…‹ï¼š
- ' + sc.issues.join('
- ') + '

ä½ ä¸ç”¨ä¸€å€‹ä¸€å€‹é»åï¼Œæˆ‘æœƒç”¨ã€ŒæŒ‰éµå›è²å®¢æœã€æŠŠæ¯ä¸€æ­¥å¸¶å®Œã€‚',
      ctas:[
        {label:'æ–°æ‰‹ï¼šæ²’éŒ¢åŒ…æ€éº¼é–‹å§‹', primary:true, onClick:()=>openHelp(HELP.nowallet)},
        {label:'æˆ‘å·²ç¶“æœ‰éŒ¢åŒ…â†’é€£ç·š', onClick:()=>clickByText('é€£ç·šéŒ¢åŒ…')},
        {label:'å…ˆé€›ç¥æ®¿', onClick:()=>closeHelp()},
      ],
      tts:false
    });
  }

  // Observe DOM changes (some UI render later)
  const mo = new MutationObserver(()=>{ wireButtons(); wireProgress(); });
  mo.observe(document.documentElement, {childList:true, subtree:true});

  // expose
  window.__klineHelp = {openHelp, closeHelp, runSelfCheck};
})();
</script>

</html>