<!--
悟空財神廟｜互動循環 FINAL（成交版：可上線、可鏈上還願 transfer）
File: /kline-odyssey/wukong-temple/index.html
Deploy: GitHub Pages
-->
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>悟空財神廟｜Wukong Temple</title>
  <meta name="description" content="悟空財神廟｜互動式遊戲入口：參觀、選擇、體驗，然後離開。" />
</head>

<body>
<div style="max-width:820px;margin:22px auto;padding:16px;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans TC','PingFang TC','Microsoft JhengHei',sans-serif;">

  <div style="margin-bottom:10px;">
    <div style="font-weight:900;font-size:22px;line-height:1.2;">悟空財神廟｜Wukong Temple</div>
    <div style="margin-top:6px;font-weight:800;">#悟空新文 #K線西遊記 #花果山台灣</div>
    <div style="margin-top:8px;">
      <a href="https://klineodyssey.github.io/kline-odyssey/" target="_blank" rel="noopener"
         style="text-decoration:none;font-weight:900;">https://klineodyssey.github.io/kline-odyssey/</a>
    </div>
  </div>

  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="font-weight:900;">規則一句話</div>
    <div style="line-height:1.75;margin-top:6px;">
      這裡是<strong>互動式遊戲入口</strong>：參觀、選擇、體驗，然後離開。<br/>
      不承諾收益、不提供投資建議、不做回報保證。所有鏈上動作必須由你在錢包中按確認。
    </div>
  </div>

  <!-- Visitor Panel -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
      <div style="font-weight:900;">來訪人數（今日 / 總計）</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="btnRefreshStats"
          style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">重新整理</button>
        <button id="btnReHit"
          style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">重新計一次（測試）</button>
      </div>
    </div>
    <div id="visitorInfo" style="margin-top:10px;line-height:1.9;">載入中…</div>
    <div id="visitorHint" style="opacity:.85;margin-top:6px;"></div>
  </div>

  <!-- Wallet Panel -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
      <div style="font-weight:900;">錢包狀態（BSC 主網）</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="btnConnect"
          style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">連線錢包</button>
        <button id="btnSpeak"
          style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">語音客服</button>
        <button id="btnStopSpeak"
          style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">停止</button>
      </div>
    </div>

    <div id="walletInfo" style="margin-top:10px;line-height:1.9;"></div>

    <div style="margin-top:10px;padding:10px;border:1px dashed #111;border-radius:12px;background:#fafafa;line-height:1.8;">
      <div style="font-weight:900;">鏈上驗證（唯一正確）</div>

      <div style="margin-top:8px;">
        <div style="font-weight:900;">Network</div>
        <div style="opacity:.9;">BNB Smart Chain（BSC）</div>
      </div>

      <div style="margin-top:10px;">
        <div style="font-weight:900;">Token Contract（唯一）</div>
        <div style="margin-top:4px;">
          <a id="linkToken" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;"></a>
        </div>
      </div>

      <div style="margin-top:10px;">
        <div style="font-weight:900;">官方交易（PancakeSwap）</div>
        <div style="margin-top:4px;">
          <a id="linkPancake" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;">KGEN / WBNB 交易頁</a>
        </div>
      </div>

      <div style="margin-top:10px;">
        <div style="font-weight:900;">LP Pair（KGEN / WBNB）</div>
        <div style="margin-top:4px;">
          <a id="linkLP" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;"></a>
        </div>
      </div>

      <div style="margin-top:10px;">
        <div style="font-weight:900;">LP 鎖倉（PinkLock）</div>
        <div style="margin-top:4px;">
          <a id="linkPink" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;">點我開啟鎖倉頁（Unlock 倒數）</a>
        </div>
        <div style="opacity:.85;margin-top:6px;line-height:1.65;">
          請只認合約地址，不認名稱。鎖倉屬風險控管與透明化設計，不代表價格或報酬保證。
        </div>
      </div>

      <div style="margin-top:10px;opacity:.85;">本頁不會替你自動出金，所有鏈上動作都必須由你在錢包中按確認。</div>
    </div>

    <div style="margin-top:10px;padding:10px;border:1px dashed #111;border-radius:12px;background:#fafafa;line-height:1.8;">
      <div style="font-weight:900;">地址查驗（BscScan）</div>
      <div style="margin-top:6px;">公益 Treasury：<a id="linkTreasury" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;"></a></div>
      <div style="margin-top:4px;">KUFO 引擎室：<a id="linkKufo" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;"></a></div>
    </div>
  </div>

  <!-- Divination Panel -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
      <div style="font-weight:900;">搏杯（需要連續 3 次聖筊才能領發財金）</div>
      <button id="btnDivination"
        style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">搏杯</button>
    </div>
    <div id="divinationInfo" style="margin-top:10px;line-height:1.9;"></div>
    <div style="opacity:.85;margin-top:6px;">規則：聖筊機率 50%。失敗歸零。連勝達 3 才開啟發財金。</div>
  </div>

  <!-- Address Options -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="font-weight:900;">還願地址（3 選 1）</div>
    <div style="margin-top:8px;line-height:1.8;">
      <div style="opacity:.9;">第三個地址 = 公益 Treasury（同時也是發財金發放池）。</div>

      <div style="display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;">
        <label style="display:flex;gap:10px;align-items:flex-start;">
          <input type="radio" name="vowTarget" value="blackhole" />
          <div>
            <div style="font-weight:900;">往生地址（質能轉換 / 通縮象徵）</div>
            <div style="opacity:.85;line-height:1.65;">
              不可逆。象徵：E=mc^2 質能轉換、W=mgh 位能，m 下降代表通縮象徵。
              這是敘事與透明化，不代表報酬或價格保證。
            </div>
          </div>
        </label>

        <label style="display:flex;gap:10px;align-items:flex-start;">
          <input type="radio" name="vowTarget" value="kufo_engine" checked />
          <div>
            <div style="font-weight:900;">KUFO 引擎室（補油推進）</div>
            <div style="opacity:.85;">敘事核心地址：象徵補油、推進、維運。</div>
          </div>
        </label>

        <label style="display:flex;gap:10px;align-items:flex-start;">
          <input type="radio" name="vowTarget" value="public_good_treasury" />
          <div>
            <div style="font-weight:900;">公益 Treasury（發財金發放池）</div>
            <div style="opacity:.85;">震災、孤兒院、自由民主、花果山孤兒基金池。</div>
          </div>
        </label>
      </div>

      <div style="margin-top:10px;padding:10px;border:1px dashed #111;border-radius:12px;background:#fafafa;line-height:1.8;">
        <div style="font-weight:900;">地址確認</div>
        <pre id="addrPreview" style="white-space:pre-wrap;margin:8px 0 0;"></pre>
      </div>
    </div>
  </div>

  <!-- Amount -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="font-weight:900;">還願數量（KGEN）</div>
    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <input id="inpAmount" value="1" inputmode="decimal"
        style="flex:1;min-width:220px;padding:10px;border:1px solid #111;border-radius:12px;font-weight:900;"
        placeholder="例如：1 或 0.5" />
      <div style="opacity:.85;">提示：你可改數量。</div>
    </div>
  </div>

  <!-- Actions -->
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin:14px 0;">
    <button id="btnVisit"
      style="text-align:left;cursor:pointer;padding:14px;border:1px solid #111;border-radius:14px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">登入參拜</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">本機記錄一次參拜</div>
    </button>

    <a href="/kline-odyssey/bookstore/"
       style="display:block;padding:14px;border:1px solid #111;border-radius:14px;text-decoration:none;background:#fff;">
      <div style="font-weight:900;font-size:16px;">領書｜悟空書城</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">連結到書城／內容兌換</div>
    </a>

    <button id="btnFortune"
      style="text-align:left;cursor:pointer;padding:14px;border:1px solid #111;border-radius:14px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">領發財金（需 3 次聖筊）</div>
      <div id="fortuneGateHint" style="opacity:.85;margin-top:6px;line-height:1.6;">未達門檻：請先搏杯連勝 3 次</div>
    </button>

    <button id="btnVow"
      style="text-align:left;cursor:pointer;padding:14px;border:1px solid #111;border-radius:14px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">還願（鏈上送出交易）</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">由你在錢包確認，把 KGEN 送到選定地址</div>
    </button>

    <button id="btnExit"
      style="text-align:left;cursor:pointer;padding:14px;border:1px solid #111;border-radius:14px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">登出離開</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">本機記錄一次離開</div>
    </button>
  </div>

  <!-- Local Status -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="font-weight:900;">本機紀錄</div>
    <div id="statusText" style="margin-top:8px;line-height:1.9;"></div>
    <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;">
      <button id="btnExport"
        style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">匯出紀錄 JSON</button>
      <button id="btnClear"
        style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">清除本機紀錄</button>
    </div>
    <div id="toast" style="margin-top:10px;font-weight:900;"></div>
  </div>

  <!-- Voice Text -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:14px 0;">
    <div style="font-weight:900;">AI 語音客服（中文）</div>
    <div style="margin-top:8px;line-height:1.85;">
      歡迎來到五指山悟空財神廟。這裡是互動式遊戲入口，不是投資平台。<br/><br/>
      你需要連續三次聖筊，才能領發財金。<br/>
      發財金若要正常發放，必須由發放合約從公益 Treasury 出金。<br/><br/>
      還願地址三選一：<br/>
      往生地址代表質能轉換的象徵敘事，例如 E=mc^2 與 W=mgh，並象徵通縮概念。不可逆。<br/>
      KUFO 引擎室代表補油推進與維運。<br/>
      公益 Treasury 是發財金發放池與公益池。<br/><br/>
      所有鏈上動作，都必須由你在錢包中按確認。本頁不承諾報酬或價格。
    </div>
  </div>

  <div style="margin-top:14px;padding-top:12px;border-top:1px solid #111;line-height:1.8;">
    PrimeForge 以母機之名，開啟金融生命。<br/>
    花果山台灣・信念不滅・市場無界。<br/>
    Where the Market Becomes the Myth.<br/>
    —— 樂天帝 ⌖
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
(() => {
  "use strict";

  // ========= 鎖死地址（唯一正確）=========
  const VOW_ADDR = {
    blackhole: "0x0000000000000000000000000000000000000000",
    kufo_engine: "0xef83804c264B47378FCf150086943B53fB90A90b",
    public_good_treasury: "0xB73D6716005B37BEC742D64482fA26033eE1A4E1"
  };
  const FORTUNE_TREASURY = VOW_ADDR.public_good_treasury;

  // ========= BSC 主網 + KGEN（唯一正確）=========
  const CHAIN_ID_DEC = 56;
  const KGEN_TOKEN = "0xBA3d3810e58735cb6813bC1CDc5458C0d71432Be";
  const KGEN_DECIMALS = 18;

  // 你的鏈上資訊（唯一正確）
  const PANCAKE_SWAP = "https://pancakeswap.finance/swap?outputCurrency=0xBA3d3810e58735cb6813bC1CDc5458C0d71432Be";
  const LP_PAIR = "0xf36640d7327b53ba3d7fcc1d98dfc1b85574b6c2";
  const PINKLOCK = "https://www.pinksale.finance/pinklock/bsc/record/1427003";

  // 發財金發放合約（你若已部署，就填入，會直接啟用成交 claim）
  // 例：const FAUCET_CONTRACT = "0x....";
  const FAUCET_CONTRACT = "";

  // ========= 來訪後端（CountAPI）=========
  const COUNT_NS = "klineodyssey-wukong-temple";
  const dayKey = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `day_${yyyy}${mm}${dd}`;
  };
  const countapi = {
    hit: async (key) => {
      const url = `https://api.countapi.xyz/hit/${encodeURIComponent(COUNT_NS)}/${encodeURIComponent(key)}`;
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error("countapi_hit_failed");
      return await r.json();
    },
    get: async (key) => {
      const url = `https://api.countapi.xyz/get/${encodeURIComponent(COUNT_NS)}/${encodeURIComponent(key)}`;
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error("countapi_get_failed");
      return await r.json();
    }
  };

  // ========= 本機紀錄（可匯出）=========
  const KEY = "klineodyssey_wukongTemple_final";
  const safeParse = (s) => { try { return JSON.parse(s); } catch { return null; } };
  const nowISO = () => new Date().toISOString();
  const defaultState = () => ({
    visitCount: 0,
    exitCount: 0,
    vowCount: 0,
    fortuneCount: 0,
    divinationStreak: 0,
    log: []
  });
  const load = () => {
    const raw = localStorage.getItem(KEY);
    const p = raw ? safeParse(raw) : null;
    return p && typeof p === "object"
      ? { ...defaultState(), ...p, log: Array.isArray(p.log) ? p.log : [] }
      : defaultState();
  };
  const save = (s) => localStorage.setItem(KEY, JSON.stringify(s));
  const pushLog = (s, type, meta = {}) => {
    s.log.push({ type, time: nowISO(), ...meta });
    if (s.log.length > 600) s.log = s.log.slice(-600);
  };
  const downloadJSON = (obj, filename) => {
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };

  // ========= UI refs =========
  const $visitorInfo = document.getElementById("visitorInfo");
  const $visitorHint = document.getElementById("visitorHint");
  const $walletInfo = document.getElementById("walletInfo");
  const $status = document.getElementById("statusText");
  const $toast = document.getElementById("toast");
  const $divInfo = document.getElementById("divinationInfo");
  const $fortuneGateHint = document.getElementById("fortuneGateHint");
  const $addrPreview = document.getElementById("addrPreview");
  const $inpAmount = document.getElementById("inpAmount");

  const $linkToken = document.getElementById("linkToken");
  const $linkTreasury = document.getElementById("linkTreasury");
  const $linkKufo = document.getElementById("linkKufo");
  const $linkPancake = document.getElementById("linkPancake");
  const $linkLP = document.getElementById("linkLP");
  const $linkPink = document.getElementById("linkPink");

  const toast = (msg) => {
    $toast.textContent = msg;
    setTimeout(() => { if ($toast.textContent === msg) $toast.textContent = ""; }, 3200);
  };

  window.addEventListener("error", (e) => toast("JS 錯誤：" + (e.message || "unknown")));
  window.addEventListener("unhandledrejection", (e) => toast("Promise 錯誤：" + (e.reason ? String(e.reason) : "unknown")));

  // ========= Links =========
  const mkBscAddr = (addr) => `https://bscscan.com/address/${addr}`;
  const mkBscToken = (addr) => `https://bscscan.com/token/${addr}`;
  $linkToken.textContent = KGEN_TOKEN;
  $linkToken.href = mkBscToken(KGEN_TOKEN);

  $linkTreasury.textContent = FORTUNE_TREASURY;
  $linkTreasury.href = mkBscAddr(FORTUNE_TREASURY);

  $linkKufo.textContent = VOW_ADDR.kufo_engine;
  $linkKufo.href = mkBscAddr(VOW_ADDR.kufo_engine);

  $linkPancake.href = PANCAKE_SWAP;

  $linkLP.textContent = LP_PAIR;
  $linkLP.href = mkBscAddr(LP_PAIR);

  $linkPink.href = PINKLOCK;

  // ========= Address preview =========
  $addrPreview.textContent =
`blackhole (往生/質能轉換): ${VOW_ADDR.blackhole}
kufo_engine (補油推進): ${VOW_ADDR.kufo_engine}
public_good_treasury (發財金池): ${VOW_ADDR.public_good_treasury}
fortune_treasury: ${FORTUNE_TREASURY}`;

  // ========= Voice客服 =========
  const speakText = (text) => {
    try {
      if (!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "zh-TW";
      u.rate = 1.0;
      window.speechSynthesis.speak(u);
    } catch {}
  };
  const stopSpeak = () => { try { if ("speechSynthesis" in window) window.speechSynthesis.cancel(); } catch {} };

  document.getElementById("btnSpeak").addEventListener("click", () => {
    const s = load();
    const text =
      "歡迎來到五指山悟空財神廟。這裡是互動式遊戲入口，不是投資平台。" +
      "你需要連續三次聖筊，才能領發財金。" +
      "往生地址代表質能轉換的象徵敘事，例如E等於m乘以c平方，以及位能W等於m乘以g乘以h。不可逆。" +
      "KUFO引擎室代表補油推進與維運。公益Treasury是發財金與公益池。" +
      "所有鏈上動作都必須由你在錢包中按確認。本頁不承諾報酬或價格。" +
      "你目前聖筊連勝是 " + (s.divinationStreak || 0) + " 次。";
    speakText(text);
    toast("語音客服已啟動");
  });
  document.getElementById("btnStopSpeak").addEventListener("click", () => {
    stopSpeak();
    toast("已停止語音");
  });

  // ========= Visitors =========
  const renderVisitors = (todayVal, totalVal, note) => {
    $visitorInfo.innerHTML = `
      <div>今日來訪：<strong>${todayVal}</strong></div>
      <div>總來訪：<strong>${totalVal}</strong></div>
    `;
    $visitorHint.textContent = note || "";
  };

  const localVisitorFallback = (doHit) => {
    const kDay = "local_visit_" + dayKey();
    const kTotal = "local_visit_total";
    const get = (k) => Number(localStorage.getItem(k) || "0");
    const set = (k, v) => localStorage.setItem(k, String(v));
    let day = get(kDay);
    let total = get(kTotal);
    if (doHit) { day += 1; total += 1; set(kDay, day); set(kTotal, total); }
    renderVisitors(day, total, "外部統計被阻擋，已改用本機統計 fallback。");
  };

  const refreshVisitors = async (doHit) => {
    try {
      const dk = dayKey();
      let todayVal = 0;
      let totalVal = 0;
      if (doHit) {
        const [t1, t2] = await Promise.all([countapi.hit(dk), countapi.hit("total")]);
        todayVal = t1.value ?? 0;
        totalVal = t2.value ?? 0;
      } else {
        const [g1, g2] = await Promise.all([countapi.get(dk), countapi.get("total")]);
        todayVal = g1.value ?? 0;
        totalVal = g2.value ?? 0;
      }
      renderVisitors(todayVal, totalVal, "來源：CountAPI 後端統計");
    } catch {
      localVisitorFallback(doHit);
    }
  };

  document.getElementById("btnRefreshStats").addEventListener("click", async () => {
    await refreshVisitors(false);
    toast("已更新來訪統計");
  });
  document.getElementById("btnReHit").addEventListener("click", async () => {
    await refreshVisitors(true);
    toast("已重新計一次（測試）");
  });

  // 首次載入：直接 hit（呼吸）
  refreshVisitors(true);

  // ========= Wallet =========
  let provider = null;
  let signer = null;
  let userAddr = null;

  const ERC20_ABI = [
    "function balanceOf(address) view returns (uint256)",
    "function transfer(address to, uint256 amount) returns (bool)"
  ];
  const FAUCET_ABI = [
    "function claim() external",
    "function treasury() view returns (address)",
    "function token() view returns (address)"
  ];

  const ensureChain = async () => {
    if (!window.ethereum) throw new Er
