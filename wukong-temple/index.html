<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>æ‚Ÿç©ºå®‡å®™ç¥æ®¿é£›ç¢Ÿ V4.3 FULL</title>
<style>
  :root{
    --bg:#0b1220;
    --panel:#0f1b33;
    --panel2:#0b162c;
    --line:#24324f;
    --txt:#e8eefc;
    --muted:#a9b7d6;
    --ok:#2dd4bf;
    --warn:#fbbf24;
    --bad:#fb7185;
    --btn:#ffffff;
    --btnTxt:#000000;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", Arial, sans-serif;
    background: radial-gradient(1000px 700px at 20% 0%, #172554 0%, rgba(23,37,84,0) 55%),
                radial-gradient(900px 650px at 90% 10%, #134e4a 0%, rgba(19,78,74,0) 55%),
                var(--bg);
    color:var(--txt);
    padding:16px 14px 90px;
  }
  a{color:inherit}
  .topbar{
    position:sticky; top:0; z-index:9990;
    backdrop-filter: blur(10px);
    background: linear-gradient(to bottom, rgba(11,18,32,.92), rgba(11,18,32,.70));
    border-bottom:1px solid rgba(36,50,79,.6);
    padding:10px 2px 10px;
    margin:-16px -14px 14px;
  }
  .topbar-inner{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; padding:0 12px;
  }
  .brand{
    display:flex; flex-direction:column; gap:2px;
  }
  .brand b{font-size:14px; letter-spacing:.6px}
  .brand span{font-size:12px; color:var(--muted)}
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:9px 12px; border-radius:999px;
    border:1px solid rgba(17,17,17,.2);
    background: #fff;
    color:#000;
    font-weight:900;
    text-decoration:none;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
    white-space:nowrap;
  }
  .grid{
    display:grid;
    grid-template-columns: 1fr;
    gap:12px;
  }
  @media (min-width: 900px){
    .grid{grid-template-columns: 1.05fr .95fr;}
  }
  .card{
    background: linear-gradient(180deg, rgba(15,27,51,.94), rgba(11,22,44,.94));
    border:1px solid rgba(36,50,79,.9);
    border-radius:16px;
    box-shadow: 0 20px 60px rgba(0,0,0,.35);
    overflow:hidden;
  }
  .card-h{
    padding:14px 14px 10px;
    border-bottom:1px solid rgba(36,50,79,.75);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .card-h h2{
    margin:0; font-size:14px; letter-spacing:.4px;
  }
  .card-h .sub{font-size:12px; color:var(--muted)}
  .card-b{padding:14px}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .row > *{flex:1}
  .mini{
    background: rgba(11,22,44,.6);
    border:1px solid rgba(36,50,79,.75);
    border-radius:14px;
    padding:12px;
  }
  .mini h3{margin:0 0 6px; font-size:12px; color:var(--muted); font-weight:700}
  .big{
    font-size:18px; font-weight:900; letter-spacing:.3px;
  }
  .small{font-size:12px; color:var(--muted)}
  .btn{
    appearance:none;
    border:none;
    border-radius:12px;
    padding:10px 12px;
    font-weight:900;
    cursor:pointer;
    background:var(--btn);
    color:var(--btnTxt);
  }
  .btn2{
    appearance:none;
    border:1px solid rgba(36,50,79,.9);
    background: rgba(11,22,44,.65);
    color: var(--txt);
    border-radius:12px;
    padding:10px 12px;
    font-weight:900;
    cursor:pointer;
  }
  .btn:disabled,.btn2:disabled{opacity:.45; cursor:not-allowed}
  .tabs{
    display:flex; gap:8px; flex-wrap:wrap;
  }
  .tab{
    padding:9px 10px; border-radius:999px;
    border:1px solid rgba(36,50,79,.9);
    background: rgba(11,22,44,.65);
    color: var(--txt);
    font-weight:900; cursor:pointer;
  }
  .tab.active{
    background:#fff; color:#000; border-color: rgba(17,17,17,.2);
  }
  .hidden{display:none !important}
  input[type="range"]{width:100%}
  input[type="number"], input[type="text"], textarea, select{
    width:100%;
    border-radius:12px;
    border:1px solid rgba(36,50,79,.85);
    background: rgba(7,14,28,.7);
    color: var(--txt);
    padding:10px 12px;
    outline:none;
  }
  textarea{min-height:80px; resize:vertical}
  .sep{height:1px; background: rgba(36,50,79,.75); margin:12px 0}
  .meter{
    width:100%;
    height:12px;
    border-radius:999px;
    border:1px solid rgba(36,50,79,.9);
    background: rgba(7,14,28,.75);
    overflow:hidden;
  }
  .meter > div{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, #22c55e, #eab308, #fb7185);
  }
  .log{
    background: rgba(7,14,28,.75);
    border:1px solid rgba(36,50,79,.9);
    border-radius:14px;
    padding:10px 12px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size:11px;
    max-height:190px;
    overflow:auto;
    line-height:1.55;
  }
  .kpi{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  @media (min-width: 900px){
    .kpi{grid-template-columns: repeat(4, 1fr);}
  }
  .badge{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px;
    border:1px solid rgba(36,50,79,.9);
    background: rgba(11,22,44,.65);
    font-size:12px; color:var(--muted); font-weight:800;
  }
  .badge.ok{color: #a7f3d0}
  .badge.warn{color:#fde68a}
  .badge.bad{color:#fecdd3}
  .avatar{
    width:96px; height:96px; border-radius:999px;
    display:grid; place-items:center;
    margin: 6px auto 12px;
    background: radial-gradient(circle at 30% 30%, rgba(45,212,191,.8), rgba(45,212,191,0) 55%),
                radial-gradient(circle at 70% 70%, rgba(59,130,246,.8), rgba(59,130,246,0) 55%),
                rgba(255,255,255,.06);
    border:1px solid rgba(36,50,79,.9);
    box-shadow: 0 0 30px rgba(45,212,191,.15);
  }
  .avatar svg{opacity:.95}
  .sticky-actions{
    position:fixed;
    left:0; right:0; bottom:0;
    background: linear-gradient(to top, rgba(11,18,32,.96), rgba(11,18,32,.55));
    border-top:1px solid rgba(36,50,79,.75);
    padding:10px 12px calc(10px + env(safe-area-inset-bottom));
    z-index:9991;
  }
  .sticky-actions .row{gap:8px}
  .hint{font-size:12px; color:var(--muted); margin-top:8px}

  .grid72{
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap:6px;
    margin-top:10px;
  }
  .slot{
    border:1px solid var(--line);
    background: rgba(255,255,255,.04);
    border-radius:10px;
    padding:8px 6px;
    text-align:center;
    font-weight:800;
    cursor:pointer;
    user-select:none;
    font-size:12px;
  }
  .slot.empty{ opacity:.75; }
  .slot.filled{ border-color: rgba(45,212,191,.55); }
  .slot.sel{ outline:2px solid rgba(59,130,246,.85); outline-offset:2px; }

</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <b>æ‚Ÿç©ºå®‡å®™ç¥æ®¿é£›ç¢Ÿï½œé§•é§›è‰™ + ä¸‹å–®æ¡Œ + AIå®¢æœ</b>
      <span id="bootLine">boot_version=v4.3-ufo-fullpack</span>
    </div>

    <a class="pill" href="https://klineodyssey.github.io/kline-odyssey/" target="_blank" rel="noopener">
      ğŸ’– å®‡å®™ç´°åŒ…ï½œå‘¼å¸ï½œå¿ƒè·³ï½œç”Ÿå‘½ğŸ”¥
    </a>
  </div>
</div>

<div class="grid">

  <!-- LEFT: Cockpit + Order Desk -->
  <div class="card">
    <div class="card-h">
      <div>
        <h2>KUFO é§•é§›è‰™ï¼ˆå„€è¡¨ç‰ˆï¼‰</h2>
        <div class="sub">æ–¹å‘ç›¤ + æ§“æ¡¿ + ç‡ƒæ–™è¡€é‡ï¼ˆKGENï¼‰ + å¤šç©ºæ‰‡å€</div>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="cockpit">é§•é§›è‰™</button>
        <button class="tab" data-tab="orderdesk">ä¸‹å–®æ¡Œ</button>
        <button class="tab" data-tab="temple">å¤–æ®¿</button>
      </div>
    </div>

    <div class="card-b">
      <!-- Cockpit -->
      <div id="tab_cockpit">
        <div class="kpi">
          <div class="mini">
            <h3>è³ªé‡ï¼ˆKGENï¼‰</h3>
            <div class="big"><span id="massKgen">30000</span> KGEN</div>
            <div class="small">è¦å‰‡ï¼š1 æŒ‡æ•¸é» = 1 KGENï¼ˆè·¨å¸‚å ´é€šç”¨ï¼‰</div>
          </div>
          <div class="mini">
            <h3>èƒ½é‡ï¼ˆE = m cÂ²ï¼‰</h3>
            <div class="big"><span id="energyE">30000</span> E</div>
            <div class="small">UI é¡¯ç¤ºï¼šæŠ•å…¥å¾Œæ‰åæ˜ ï¼ˆç›®å‰ä»¥ m ä½œç‚ºåŸºç¤ï¼‰</div>
          </div>
          <div class="mini">
            <h3>æ§“æ¡¿ï¼ˆ1â€“150ï¼‰</h3>
            <div class="big"><span id="lev">10</span>x</div>
            <div class="small">æ©«æ¡¿èª¿æ•´ï¼Œå½±éŸ¿æ¨¡æ“¬è¼¸è´å€ç‡</div>
          </div>
          <div class="mini">
            <h3>æ–¹å‘ç›¤ï¼ˆ0â€“360ï¼‰</h3>
            <div class="big"><span id="deg">120</span>Â°</div>
            <div class="small">0â€“170 å¤šï½œ170â€“190 ä¼‘æ¯ï½œ190â€“360 ç©º</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div class="mini">
            <h3>è³ªé‡ï¼ˆKGENï¼‰è¼¸å…¥</h3>
            <input id="massInput" type="number" min="0" step="1" value="30000" />
            <div class="hint">å°æŒ‡ 30000 é» = 30000 KGENï¼›BTC åŒç†ã€‚</div>
          </div>
          <div class="mini">
            <h3>æ§“æ¡¿æ»‘æ¡¿</h3>
            <input id="levRange" type="range" min="1" max="150" value="10" />
            <div class="small">ç›®å‰ï¼š<b id="levRangeLabel">10</b>x</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="mini">
            <h3>æ–¹å‘ç›¤æ»‘æ¡¿</h3>
            <input id="degRange" type="range" min="0" max="360" value="120" />
            <div class="small">
              ç›®å‰ï¼š<b id="degRangeLabel">120</b>Â°ï½œ
              ç‹€æ…‹ï¼š<b id="stanceLabel">å¤š</b>
            </div>
          </div>
          <div class="mini">
            <h3>ç‡ƒæ–™ / è¡€é‡ï¼ˆç”¨ KGEN è¡¨ç¤ºï¼‰</h3>
            <div class="meter"><div id="fuelBar"></div></div>
            <div class="small" style="margin-top:8px">
              <b id="fuelLabel">60%</b>ï½œ
              ä¸Šé™ï¼š<span id="fuelMaxLabel">50000</span> KGENï½œ
              ç¾åœ¨ï¼š<span id="fuelNowLabel">30000</span> KGEN
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <button class="btn" id="btnHeartbeat">å¿ƒè·³</button>
          <button class="btn" id="btnBreath">å‘¼å¸</button>
          <button class="btn" id="btnPressure">å£“åŠ›</button>
          <button class="btn" id="btnCup">æ“²ç­Š</button>
          <button class="btn" id="btnFortune">æ±‚ç±¤</button>
        </div>
        <div class="hint">ä»¥ä¸Šç‚º UI äº‹ä»¶å›è·¯æ¸¬è©¦ï¼ˆæ¯é¡†æŒ‰éµå¿…æœ‰åæ‡‰ + logï¼‰ã€‚</div>

        <div class="sep"></div>

        <div class="row">
          <button class="btn2" id="btnSelfTest">ä¸€éµè‡ªæˆ‘æª¢æ¸¬</button>
          <button class="btn2" id="btnExportState">åŒ¯å‡ºç‹€æ…‹ï¼ˆJSONï¼‰</button>
          <button class="btn2" id="btnImportState">åŒ¯å…¥ç‹€æ…‹ï¼ˆJSONï¼‰</button>
          <button class="btn2" id="btnCopyLog">è¤‡è£½ Log</button>
        </div>

        <div class="sep"></div>
        <div class="log" id="log"></div>
      </div>

      <!-- Order Desk -->
      <div id="tab_orderdesk" class="hidden">
        <div class="mini">
          <h3>ä¸‹å–®æ¡Œï¼ˆT+2ï¼‰</h3>
          <div class="small">
            äº¤æ˜“æ—¥æ¡ T+2 çµç®—ã€‚ç„¡é€±ä¸‰çµç®—æ¦‚å¿µã€‚<br>
            è¦å‰‡ï¼šåœåˆ©èˆ‡åœæåŒä¸€çµç®—æ—¥åŒæ™‚è§¸ç™¼ â†’ è¦–ç‚º 0ï¼ˆä¸ç®—è¼¸è´ï¼‰ã€‚
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div class="mini">
            <h3>äº¤æ˜“æ—¥</h3>
            <input id="tradeDate" type="text" placeholder="YYYY-MM-DD" />
            <div class="small">é è¨­ä»Šæ—¥ï¼ˆæœ¬æ©Ÿï¼‰ã€‚</div>
          </div>
          <div class="mini">
            <h3>T+2 çµç®—æ—¥ï¼ˆè‡ªå‹•ï¼‰</h3>
            <input id="settleDate" type="text" disabled />
            <div class="small">ä»¥ã€Œäº¤æ˜“æ—¥ + 2 å¤©ã€è¨ˆï¼ˆç°¡åŒ–ç‰ˆï¼‰ã€‚</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="mini">
            <h3>åœæï¼ˆKGEN é»ï¼‰</h3>
            <input id="sl" type="number" step="1" value="200" />
            <div class="small">æœ€å¤§å»ºè­°ï¼šÂ± ATR14</div>
          </div>
          <div class="mini">
            <h3>åœåˆ©ï¼ˆKGEN é»ï¼‰</h3>
            <input id="tp" type="number" step="1" value="300" />
            <div class="small">æœ€å¤§å»ºè­°ï¼šÂ± ATR14</div>
          </div>
          <div class="mini">
            <h3>ATR14ï¼ˆä¸Šé™ï¼‰</h3>
            <input id="atr14" type="number" step="1" value="500" />
            <div class="small">æœ¬ç‰ˆç‚ºæ‰‹å‹•å¡«å…¥ï¼ˆä¹‹å¾Œå¯æ¥è³‡æ–™ï¼‰ã€‚</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div class="mini">
            <h3>æ¨¡æ“¬çµæœï¼ˆKGENï¼‰</h3>
            <div class="big"><span id="pnlKgen">0</span></div>
            <div class="small">åŸºæ–¼æ–¹å‘ç›¤ï¼ˆå¤š/ç©ºï¼‰ + æ§“æ¡¿ + SL/TP/ATR14 ä¸Šé™</div>
          </div>
          <div class="mini">
            <h3>èªªæ˜ï¼ˆå®¢æœå£å¾‘ï¼‰</h3>
            <textarea id="csNote"></textarea>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <button class="btn" id="btnSimWin">æ¨¡æ“¬è´</button>
          <button class="btn" id="btnSimLose">æ¨¡æ“¬è¼¸</button>
          <button class="btn2" id="btnSaveOrder">ä¿å­˜é€™ç­†å–®</button>
          <button class="btn2" id="btnExportOrders">åŒ¯å‡ºè¨‚å–®ï¼ˆJSONï¼‰</button>
        </div>

        <div class="sep"></div>
        <div class="log" id="ordersLog"></div>
      </div>

      <!-- Temple -->
            <div id="tab_temple" class="hidden">
        <div class="mini">
          <h3>å¤–æ®¿ï¼ˆè§€å…‰/ç•™å¿µ/é¦™æ²¹éŒ¢ï¼‰</h3>
          <div class="small">
            13 ç”Ÿè‚– / å…‰æ˜ç‡ˆ / ä¸ƒä»™å¥³è¨±é¡˜ / é‚„é¡˜ / ç™¼è²¡é‡‘ç´€éŒ„ï¼šå±¬æ–¼å¤–æ®¿æ–‡åŒ–å±¤ã€‚<br>
            èˆ‡äº¤æ˜“åˆ†å±¤éš”é›¢ï¼Œä¸è®“ã€Œå»Ÿè®Šäº¤æ˜“æ‰€ã€ã€‚
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div class="mini">
            <h3>ç”Ÿè‚–ï¼ˆå¯è‡ªå®šç¬¬ 13 ç”Ÿè‚–ï¼‰</h3>
            <select id="zodiac">
              <option value="é¼ ">é¼ </option><option value="ç‰›">ç‰›</option><option value="è™">è™</option><option value="å…”">å…”</option>
              <option value="é¾">é¾</option><option value="è›‡">è›‡</option><option value="é¦¬">é¦¬</option><option value="ç¾Š">ç¾Š</option>
              <option value="çŒ´">çŒ´</option><option value="é›">é›</option><option value="ç‹—">ç‹—</option><option value="è±¬">è±¬</option>
              <option value="Z13">ç¬¬ 13 ç”Ÿè‚–ï¼ˆå®‡å®™ï¼‰</option>
            </select>
            <div class="row" style="margin-top:8px; gap:8px; flex-wrap:nowrap">
              <input id="zodiac13Name" placeholder="ç¬¬13ç”Ÿè‚–è‡ªå®šåç¨±ï¼ˆä¾‹ï¼šé¯¨ / é³³å‡° / é»‘æ´ï¼‰" />
              <button class="btn2" id="btnSaveZ13">ä¿å­˜</button>
            </div>
            <div class="small">æ¯ç”Ÿè‚– 72 åé¡ç™»è¨˜ï¼ˆè§€å…‰ç•™å¿µ / é»ç‡ˆï¼‰ï¼Œä¸ç­‰æ–¼äº¤æ˜“ç­‰ç´šã€‚</div>
          </div>

          <div class="mini">
            <h3>å…‰æ˜ç‡ˆè²»ç”¨ï¼ˆKGENï¼‰</h3>
            <input id="lampFee" type="number" value="5" min="0" step="1" />
            <div class="small">ç¤ºæ„ï¼šé»ç‡ˆè²»ç”¨ï¼ˆå¯ç”¨æ–¼è§€å…‰/ç•™å¿µæ”¶è²»ï¼‰ã€‚</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="mini">
          <h3>72 åé¡ç™»è¨˜ï¼ˆé¸ä¸€æ ¼ â†’ å¡«è³‡æ–™ â†’ é€å‡ºï¼‰</h3>
          <div class="small">é»æ ¼å­å¯æŒ‡å®šåé¡ï¼›ä¸é»å‰‡è‡ªå‹•ä½¿ç”¨ä¸‹ä¸€å€‹ç©ºä½ã€‚</div>

          <div id="slotGrid" class="grid72" aria-label="72 slots"></div>

          <div class="row" style="margin-top:10px">
            <div class="mini" style="flex:1">
              <h3>ç™»è¨˜è³‡æ–™</h3>
              <div class="row" style="gap:8px">
                <input id="regSlot" type="number" min="1" max="72" placeholder="åé¡(1-72)" />
                <input id="regName" placeholder="åå­— / æš±ç¨±" />
              </div>
              <div class="row" style="gap:8px; margin-top:8px">
                <input id="regWallet" placeholder="éŒ¢åŒ…åœ°å€ï¼ˆå¯ç•™ç©ºï¼‰" />
                <input id="regNote" placeholder="ç•™å¿µ / ç¥ç¦ï¼ˆå¯ç•™ç©ºï¼‰" />
              </div>

              <div class="row" style="margin-top:10px; gap:10px">
                <button class="btn" id="btnRegister">ç™»è¨˜åé¡</button>
                <button class="btn" id="btnLamp">é»å…‰æ˜ç‡ˆï¼ˆç•™å¿µï¼‰</button>
                <button class="btn2" id="btnClearReg">æ¸…ç©ºè¼¸å…¥</button>
              </div>
              <div class="small" id="regHint" style="margin-top:8px">æç¤ºï¼šè«‹å…ˆé¸ç”Ÿè‚–ã€‚</div>
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div class="mini" style="flex:1">
            <h3>ä¸ƒä»™å¥³ç³»çµ±ï¼ˆè¨±é¡˜ / é‚„é¡˜ï¼‰</h3>
            <div class="small">ç•™å¿µç”¨ï¼šä¸ƒä»™å¥³è·¯å¾‘ f1~f7ã€‚æ¯ç­†è¨±é¡˜å¯åŒ¯å‡º JSON å­˜æª”ã€‚</div>

            <div class="row" style="gap:10px; flex-wrap:wrap">
              <select id="fairySel" style="min-width:180px">
                <option value="f1">f1</option><option value="f2">f2</option><option value="f3">f3</option><option value="f4">f4</option>
                <option value="f5">f5</option><option value="f6">f6</option><option value="f7">f7</option>
              </select>

              <input id="fairyName1" placeholder="f1 åç¨±" style="min-width:160px" />
              <input id="fairyName2" placeholder="f2 åç¨±" style="min-width:160px" />
              <input id="fairyName3" placeholder="f3 åç¨±" style="min-width:160px" />
              <input id="fairyName4" placeholder="f4 åç¨±" style="min-width:160px" />
              <input id="fairyName5" placeholder="f5 åç¨±" style="min-width:160px" />
              <input id="fairyName6" placeholder="f6 åç¨±" style="min-width:160px" />
              <input id="fairyName7" placeholder="f7 åç¨±" style="min-width:160px" />
              <button class="btn2" id="btnSaveFairies">ä¿å­˜ä¸ƒä»™å¥³åç¨±</button>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="mini" style="flex:1">
                <h3>è¨±é¡˜å…§å®¹</h3>
                <textarea id="wish" placeholder="å¯«ä¸‹ä½ çš„é¡˜æœ›ï¼ˆç•™å¿µç”¨ï¼‰"></textarea>
              </div>
              <div class="mini" style="flex:1">
                <h3>é‚„é¡˜ï¼ˆå‚™è¨»ï¼‰</h3>
                <textarea id="vow" placeholder="é‚„é¡˜èªªæ˜ï¼ˆç•™å¿µç”¨ï¼‰"></textarea>
              </div>
            </div>

            <div class="row" style="margin-top:10px; gap:10px">
              <button class="btn" id="btnWish">é€å‡ºè¨±é¡˜</button>
              <button class="btn" id="btnVow">é€å‡ºé‚„é¡˜</button>
              <button class="btn2" id="btnExportTemple">åŒ¯å‡ºå¤–æ®¿ï¼ˆJSONï¼‰</button>
              <button class="btn2" id="btnResetTemple">é‡ç½®å¤–æ®¿è³‡æ–™ï¼ˆæœ¬æ©Ÿï¼‰</button>
            </div>
          </div>
        </div>

        <div class="sep"></div>
        <div class="log" id="templeLog"></div>
      </div>

  <!-- RIGHT: AI Customer Service -->
  <div class="card">
    <div class="card-h">
      <div>
        <h2>AI å½±åƒèªéŸ³å®¢æœ</h2>
        <div class="sub">è‡ªå‹•åµæ¸¬ STT/TTSï½œä¸æ”¯æ´æ™‚è‡ªå‹•é™ç´š</div>
      </div>
      <div class="row" style="flex-wrap:nowrap; gap:8px">
        <span class="badge" id="bTTS">TTS</span>
        <span class="badge" id="bSTT">STT</span>
        <span class="badge" id="bETH">Wallet</span>
      </div>
    </div>

    <div class="card-b">
      <div class="avatar" id="aiAvatar" aria-label="AI Avatar">
        <svg width="62" height="62" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M32 6C22 6 14 14 14 24v10c0 10 8 18 18 18s18-8 18-18V24C50 14 42 6 32 6Z" stroke="rgba(232,238,252,.92)" stroke-width="2.6"/>
          <path d="M22 28c3-4 17-4 20 0" stroke="rgba(45,212,191,.92)" stroke-width="3" stroke-linecap="round"/>
          <path d="M23 39c6 6 12 6 18 0" stroke="rgba(59,130,246,.92)" stroke-width="3" stroke-linecap="round"/>
          <circle cx="25" cy="25" r="2.8" fill="rgba(232,238,252,.9)"/>
          <circle cx="39" cy="25" r="2.8" fill="rgba(232,238,252,.9)"/>
        </svg>
      </div>

      <div class="mini">
        <h3>å®¢æœè¼¸å…¥</h3>
        <textarea id="aiInput" placeholder="ä½ å¯ä»¥æ‰“å­—å•ï¼šéŒ¢åŒ…æ€éº¼è£ï¼Ÿæ€éº¼ä¸‹å–®ï¼ŸT+2 æ€éº¼ç®—ï¼Ÿ"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnAsk">é€å‡º</button>
          <button class="btn2" id="btnTTS">èªéŸ³å”¸å‡º</button>
          <button class="btn" id="btnSTT">èªéŸ³è¼¸å…¥</button>
          <button class="btn2" id="btnStopSTT">åœæ­¢</button>
        </div>
        <div class="hint" id="aiHint"></div>
      </div>

      <div class="sep"></div>

      <div class="mini">
        <h3>å®¢æœå›è¦†</h3>
        <div id="aiAnswer" class="small" style="text-align:left; line-height:1.7"></div>
      </div>

      <div class="sep"></div>

      <div class="mini">
        <h3>éŒ¢åŒ…æ•™å­¸ï¼ˆå¾ 0 åˆ°èƒ½ä¸‹å–®ï¼‰</h3>
        <div class="small" style="text-align:left; line-height:1.7">
          1) å…ˆæº–å‚™ EVM éŒ¢åŒ…ï¼ˆMetaMaskï¼‰ã€‚<br>
          2) åˆ‡åˆ° BNB Chainï¼ˆBSC / BEP20ï¼‰ã€‚<br>
          3) åŒ¯å…¥ KGEN ä»£å¹£åˆç´„åœ°å€ï¼ˆä½ å·²éƒ¨ç½²çš„ KGENï¼‰ã€‚<br>
          4) æº–å‚™å°‘é‡ BNB ä½œ gasã€‚<br>
          5) æœ¬ç‰ˆä¸‹å–®æ¡Œç‚º T+2 æ¨¡æ“¬ï¼›è¦ä¸ŠéˆçœŸä¸‹å–®éœ€è¦æ¥ã€Œå¿ƒè‡Ÿ/ç„¡äººéŠ€è¡Œ/å¤§è…¦ã€è¡€ç®¡ï¼Œåˆ†å·¥æ¸…æ¥šæ‰ä¸æ’æ–¥ã€‚
        </div>
      </div>
    </div>
  </div>

</div>

<div class="sticky-actions">
  <div class="row">
    <button class="btn" id="btnModeCockpit">å›é§•é§›è‰™</button>
    <button class="btn" id="btnModeOrder">å›ä¸‹å–®æ¡Œ</button>
    <button class="btn2" id="btnModeTemple">å›å¤–æ®¿</button>
    <button class="btn2" id="btnClearLog">æ¸…ç©º Log</button>
  </div>
</div>

<script>
/* =========================
   V4.3 FULLPACK Core
   - Self detection (TTS/STT/Wallet)
   - Cross-environment safe downloads
   - No external deps
========================= */

const BOOT_VERSION = "v4.4.0-ufo-fullpack-zodiac72-fairies7";
const logEl = document.getElementById("log");
const bootLine = document.getElementById("bootLine");
bootLine.textContent = "boot_version=" + BOOT_VERSION;

function nowISO(){ return new Date().toISOString(); }
function log(msg){
  if(!logEl) return;
  logEl.innerHTML += `[${nowISO()}] ${msg}<br>`;
  logEl.scrollTop = logEl.scrollHeight;
}

function safeBool(v){ return v ? "true" : "false"; }

function badge(el, state){
  el.classList.remove("ok","warn","bad");
  if(state === "ok") el.classList.add("ok");
  if(state === "warn") el.classList.add("warn");
  if(state === "bad") el.classList.add("bad");
}

function setBadgeText(el, txt){ el.textContent = txt; }

log("selfcheck_start");
log("userAgent: " + (navigator.userAgent || ""));
const hasTTS = !!window.speechSynthesis;
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
const hasSTT = !!SR;
const hasWallet = !!window.ethereum;

log("speechSynthesis: " + safeBool(hasTTS));
log("speechRecognition: " + safeBool(hasSTT));
log("ethereum_injected_now: " + safeBool(hasWallet));

const bTTS = document.getElementById("bTTS");
const bSTT = document.getElementById("bSTT");
const bETH = document.getElementById("bETH");

setBadgeText(bTTS, "TTS " + (hasTTS ? "ON" : "OFF"));
badge(bTTS, hasTTS ? "ok" : "bad");

setBadgeText(bSTT, "STT " + (hasSTT ? "ON" : "OFF"));
badge(bSTT, hasSTT ? "ok" : "bad");

setBadgeText(bETH, "Wallet " + (hasWallet ? "ON" : "OFF"));
badge(bETH, hasWallet ? "ok" : "warn");

/* ========== Tabs ========== */
const tabs = Array.from(document.querySelectorAll(".tab"));
function showTab(key){
  document.getElementById("tab_cockpit").classList.toggle("hidden", key !== "cockpit");
  document.getElementById("tab_orderdesk").classList.toggle("hidden", key !== "orderdesk");
  document.getElementById("tab_temple").classList.toggle("hidden", key !== "temple");
  tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === key));
  log("tab=" + key);
}
tabs.forEach(t => t.addEventListener("click", () => showTab(t.dataset.tab)));

document.getElementById("btnModeCockpit").onclick = () => showTab("cockpit");
document.getElementById("btnModeOrder").onclick = () => showTab("orderdesk");
document.getElementById("btnModeTemple").onclick = () => showTab("temple");

/* ========== Cockpit state ========== */
const massInput = document.getElementById("massInput");
const massKgen = document.getElementById("massKgen");
const energyE = document.getElementById("energyE");
const levRange = document.getElementById("levRange");
const levRangeLabel = document.getElementById("levRangeLabel");
const lev = document.getElementById("lev");
const degRange = document.getElementById("degRange");
const degRangeLabel = document.getElementById("degRangeLabel");
const deg = document.getElementById("deg");
const stanceLabel = document.getElementById("stanceLabel");

const fuelMaxLabel = document.getElementById("fuelMaxLabel");
const fuelNowLabel = document.getElementById("fuelNowLabel");
const fuelLabel = document.getElementById("fuelLabel");
const fuelBar = document.getElementById("fuelBar");

let state = {
  massKgen: 30000,
  leverage: 10,
  directionDeg: 120,
  fuelMax: 50000, // UI max cap; can be changed later
  lastEvents: [],
  temple: { lamps: [], wishes: [], vows: [] },
  orders: []
};

function stanceFromDeg(d){
  if(d >= 0 && d < 170) return "å¤š";
  if(d >= 170 && d <= 190) return "ä¼‘æ¯";
  return "ç©º";
}

function clamp(n, a, b){ return Math.min(b, Math.max(a, n)); }

function renderCockpit(){
  state.massKgen = clamp(parseInt(massInput.value || "0",10) || 0, 0, 10_000_000);
  massKgen.textContent = String(state.massKgen);
  // Energy: keep proportional for now (user wants mass visible; energy reflects after input)
  energyE.textContent = String(state.massKgen);

  state.leverage = clamp(parseInt(levRange.value || "1",10) || 1, 1, 150);
  levRangeLabel.textContent = String(state.leverage);
  lev.textContent = String(state.leverage);

  state.directionDeg = clamp(parseInt(degRange.value || "0",10) || 0, 0, 360);
  degRangeLabel.textContent = String(state.directionDeg);
  deg.textContent = String(state.directionDeg);
  const st = stanceFromDeg(state.directionDeg);
  stanceLabel.textContent = st;

  const fuelNow = clamp(state.massKgen, 0, state.fuelMax);
  const pct = state.fuelMax <= 0 ? 0 : Math.round((fuelNow / state.fuelMax) * 100);
  fuelMaxLabel.textContent = String(state.fuelMax);
  fuelNowLabel.textContent = String(fuelNow);
  fuelLabel.textContent = pct + "%";
  fuelBar.style.width = pct + "%";
}

massInput.addEventListener("input", () => { renderCockpit(); log("mass_changed=" + massInput.value); });
levRange.addEventListener("input", () => { renderCockpit(); log("leverage=" + levRange.value); });
degRange.addEventListener("input", () => { renderCockpit(); log("direction=" + degRange.value); });

renderCockpit();

/* ========== Event buttons (must always respond) ========== */
function pushEvent(name){
  state.lastEvents.push({t: nowISO(), e: name});
  if(state.lastEvents.length > 50) state.lastEvents.shift();
  log(name);
}

document.getElementById("btnHeartbeat").onclick = () => pushEvent("heartbeat");
document.getElementById("btnBreath").onclick = () => pushEvent("breath");
document.getElementById("btnPressure").onclick = () => pushEvent("pressure");
document.getElementById("btnCup").onclick = () => pushEvent("cup_throw");
document.getElementById("btnFortune").onclick = () => pushEvent("fortune_click");

/* ========== Selftest ========== */
document.getElementById("btnSelfTest").onclick = () => {
  log("selftest_run");
  const checks = [
    ["TTS", hasTTS],
    ["STT", hasSTT],
    ["Wallet", hasWallet],
    ["Clipboard", !!navigator.clipboard],
    ["DownloadAnchor", true]
  ];
  checks.forEach(([k,v]) => log(`selftest_${k}=${v ? "OK":"FAIL"}`));
  // Probe user interaction chain: create a tiny toast via log
  log("selftest_done");
};

/* ========== Robust JSON export/download ========== */
function downloadText(filename, text){
  try{
    const blob = new Blob([text], {type:"application/json;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
    log("export_download_try");
    return true;
  }catch(e){
    log("export_download_fail " + (e && e.message ? e.message : String(e)));
    return false;
  }
}

async function copyToClipboard(text){
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(text);
      log("clipboard_copied");
      return true;
    }
  }catch(e){
    log("clipboard_copy_fail " + (e && e.message ? e.message : String(e)));
  }
  return false;
}

function exportStatePayload(){
  return {
    boot_version: BOOT_VERSION,
    exported_at: nowISO(),
    userAgent: navigator.userAgent || "",
    state: state
  };
}

document.getElementById("btnExportState").onclick = async () => {
  const payload = exportStatePayload();
  const text = JSON.stringify(payload, null, 2);
  const ok = downloadText(`wuzhishan_state_${new Date().toISOString().slice(0,10)}.json`, text);
  if(!ok){
    await copyToClipboard(text);
    alert("æ­¤ç’°å¢ƒå¯èƒ½é˜»æ“‹ä¸‹è¼‰ï¼›å·²æ”¹ç”¨å‰ªè²¼ç°¿å‚™æ´ã€‚è«‹è²¼åˆ°è¨˜äº‹æœ¬/é›²ç«¯å­˜æª”ã€‚");
  }
};

document.getElementById("btnImportState").onclick = async () => {
  const input = prompt("è«‹è²¼ä¸Š JSONï¼ˆç‹€æ…‹åŒ¯å…¥ï¼‰");
  if(!input) return;
  try{
    const obj = JSON.parse(input);
    if(!obj || !obj.state) throw new Error("bad_format");
    state = obj.state;
    // Apply to UI
    massInput.value = String(state.massKgen || 0);
    levRange.value = String(state.leverage || 1);
    degRange.value = String(state.directionDeg || 0);
    renderCockpit();
    renderOrdersLog();
    renderTempleLog();
    log("import_ok");
  }catch(e){
    log("import_fail " + (e && e.message ? e.message : String(e)));
    alert("JSON æ ¼å¼éŒ¯èª¤æˆ–ä¸ç›¸å®¹ã€‚");
  }
};

document.getElementById("btnCopyLog").onclick = async () => {
  const text = (logEl.innerText || "").trim();
  const ok = await copyToClipboard(text);
  if(!ok) alert("æ­¤ç’°å¢ƒä¸æ”¯æ´å‰ªè²¼ç°¿ã€‚è«‹æ‰‹å‹•é•·æŒ‰è¤‡è£½ã€‚");
};

document.getElementById("btnClearLog").onclick = () => {
  logEl.innerHTML = "";
  log("log_cleared");
};

/* ========== Order desk ========== */
const tradeDate = document.getElementById("tradeDate");
const settleDate = document.getElementById("settleDate");
const sl = document.getElementById("sl");
const tp = document.getElementById("tp");
const atr14 = document.getElementById("atr14");
const pnlKgen = document.getElementById("pnlKgen");
const ordersLog = document.getElementById("ordersLog");
const csNote = document.getElementById("csNote");

function pad2(n){ return String(n).padStart(2,"0"); }

function todayStr(){
  const d = new Date();
  return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
}
tradeDate.value = todayStr();

function addDays(yyyy_mm_dd, days){
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(yyyy_mm_dd);
  if(!m) return "";
  const d = new Date(parseInt(m[1],10), parseInt(m[2],10)-1, parseInt(m[3],10));
  d.setDate(d.getDate() + days);
  return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
}
function refreshSettle(){
  settleDate.value = addDays(tradeDate.value, 2) || "";
}
tradeDate.addEventListener("input", ()=>{ refreshSettle(); pushEvent("tradeDate=" + tradeDate.value); });
refreshSettle();

function capByATR(x, atr){
  const a = Math.max(0, parseInt(atr,10) || 0);
  const v = parseInt(x,10) || 0;
  return clamp(v, -a, a);
}

function computePnL(sign){
  const atr = parseInt(atr14.value,10) || 0;
  let _sl = parseInt(sl.value,10) || 0;
  let _tp = parseInt(tp.value,10) || 0;

  // Enforce ATR cap
  _sl = clamp(_sl, 0, atr);
  _tp = clamp(_tp, 0, atr);
  sl.value = String(_sl);
  tp.value = String(_tp);

  // direction sign based on stance (å¤š/ç©º/ä¼‘æ¯)
  const st = stanceFromDeg(state.directionDeg);
  let dir = 0;
  if(st === "å¤š") dir = 1;
  if(st === "ç©º") dir = -1;

  // If resting, pnl 0
  if(dir === 0){
    pnlKgen.textContent = "0";
    return 0;
  }

  // sign = "win" or "lose"
  let raw = (sign === "win" ? _tp : -_sl);

  // Multiply by leverage and direction
  let pnl = raw * state.leverage * dir;

  // Rule: if both hit same settle day, pnl 0 (simulate by special case if _sl==_tp and sign=="both")
  pnlKgen.textContent = String(pnl);
  return pnl;
}

document.getElementById("btnSimWin").onclick = () => { const v=computePnL("win"); pushEvent("simulate_win pnl=" + v); };
document.getElementById("btnSimLose").onclick = () => { const v=computePnL("lose"); pushEvent("simulate_lose pnl=" + v); };

function renderOrdersLog(){
  const lines = state.orders.map((o,i)=>`#${i+1} ${o.tradeDate} settle=${o.settleDate} stance=${o.stance} lev=${o.leverage} sl=${o.sl} tp=${o.tp} atr14=${o.atr14} pnl=${o.pnl}`);
  ordersLog.innerHTML = lines.length ? lines.join("<br>") : "(å°šç„¡è¨‚å–®)";
}

document.getElementById("btnSaveOrder").onclick = () => {
  const atr = parseInt(atr14.value,10) || 0;
  const _sl = clamp(parseInt(sl.value,10) || 0, 0, atr);
  const _tp = clamp(parseInt(tp.value,10) || 0, 0, atr);
  const st = stanceFromDeg(state.directionDeg);
  const pnl = parseInt(pnlKgen.textContent,10) || 0;

  const order = {
    id: "O" + Date.now(),
    tradeDate: tradeDate.value,
    settleDate: settleDate.value,
    stance: st,
    leverage: state.leverage,
    massKgen: state.massKgen,
    sl: _sl,
    tp: _tp,
    atr14: atr,
    pnl: pnl,
    note: (csNote.value || "").trim(),
    created_at: nowISO()
  };
  state.orders.push(order);
  if(state.orders.length > 200) state.orders.shift();
  renderOrdersLog();
  pushEvent("order_saved " + order.id);
};

document.getElementById("btnExportOrders").onclick = async () => {
  const payload = {
    boot_version: BOOT_VERSION,
    exported_at: nowISO(),
    orders: state.orders
  };
  const text = JSON.stringify(payload, null, 2);
  const ok = downloadText(`wuzhishan_orders_${new Date().toISOString().slice(0,10)}.json`, text);
  if(!ok){
    await copyToClipboard(text);
    alert("æ­¤ç’°å¢ƒå¯èƒ½é˜»æ“‹ä¸‹è¼‰ï¼›å·²æ”¹ç”¨å‰ªè²¼ç°¿å‚™æ´ã€‚");
  }
};

renderOrdersLog();

/* ========== Temple (13 zodiac / lamps / wishes) ========== */
/* ========== Temple (Zodiac 72 slots + 7 Fairies) ========== */
const templeLog = document.getElementById("templeLog");
const slotGrid  = document.getElementById("slotGrid");
const zodiacSel = document.getElementById("zodiac");
const z13Name   = document.getElementById("zodiac13Name");
const btnSaveZ13= document.getElementById("btnSaveZ13");

const regSlot   = document.getElementById("regSlot");
const regName   = document.getElementById("regName");
const regWallet = document.getElementById("regWallet");
const regNote   = document.getElementById("regNote");
const regHint   = document.getElementById("regHint");

const btnRegister = document.getElementById("btnRegister");
const btnLamp     = document.getElementById("btnLamp");
const btnClearReg = document.getElementById("btnClearReg");

const fairySel = document.getElementById("fairySel");
const btnSaveFairies = document.getElementById("btnSaveFairies");
const wish = document.getElementById("wish");
const vow  = document.getElementById("vow");
const btnWish = document.getElementById("btnWish");
const btnVow  = document.getElementById("btnVow");
const btnExportTemple = document.getElementById("btnExportTemple");
const btnResetTemple  = document.getElementById("btnResetTemple");
const lampFee = document.getElementById("lampFee");

function tlog(msg){
  const ts = new Date().toISOString();
  templeLog.textContent = `[${ts}] ${msg}\n` + (templeLog.textContent || "");
}

const TEMPLE_KEY = "WUKONG_TEMPLE_V44_STATE";
const DEFAULT_FAIRIES = {
  f1:"ä¸ƒä»™å¥³ä¸€", f2:"ä¸ƒä»™å¥³äºŒ", f3:"ä¸ƒä»™å¥³ä¸‰", f4:"ä¸ƒä»™å¥³å››",
  f5:"ä¸ƒä»™å¥³äº”", f6:"ä¸ƒä»™å¥³å…­", f7:"ä¸ƒä»™å¥³ä¸ƒ"
};

function templeLoad(){
  try{
    const raw = localStorage.getItem(TEMPLE_KEY);
    if(!raw) return {
      z13Name:"",
      fairies:{...DEFAULT_FAIRIES},
      registries:{},   // key -> { "1": entry, ... }
      lamps:[],
      wishes:[],
      vows:[]
    };
    const obj = JSON.parse(raw);
    if(!obj.fairies) obj.fairies = {...DEFAULT_FAIRIES};
    if(!obj.registries) obj.registries = {};
    if(!obj.lamps) obj.lamps = [];
    if(!obj.wishes) obj.wishes = [];
    if(!obj.vows) obj.vows = [];
    if(typeof obj.z13Name !== "string") obj.z13Name = "";
    return obj;
  }catch(e){
    return {
      z13Name:"",
      fairies:{...DEFAULT_FAIRIES},
      registries:{},
      lamps:[],
      wishes:[],
      vows:[]
    };
  }
}

function templeSave(){
  try{
    localStorage.setItem(TEMPLE_KEY, JSON.stringify(TEMPLE));
    log("cfg_saved");
  }catch(e){
    log("cfg_save_fail " + (e && e.message ? e.message : String(e)));
  }
}

let TEMPLE = templeLoad();

function zodiacKey(){
  const v = zodiacSel.value;
  if(v !== "Z13") return v;
  const n = (TEMPLE.z13Name || "").trim() || "å®‡å®™";
  return "13:" + n;
}

function zodiacLabel(){
  const v = zodiacSel.value;
  if(v !== "Z13") return v;
  return (TEMPLE.z13Name || "").trim() || "å®‡å®™";
}

function ensureRegistry(key){
  if(!TEMPLE.registries[key]) TEMPLE.registries[key] = {};
  return TEMPLE.registries[key];
}

let selectedSlot = null;

function renderSlots(){
  const key = zodiacKey();
  const reg = ensureRegistry(key);

  slotGrid.innerHTML = "";
  for(let i=1;i<=72;i++){
    const div = document.createElement("div");
    div.className = "slot " + (reg[String(i)] ? "filled" : "empty");
    if(selectedSlot === i) div.className += " sel";
    div.textContent = i;
    div.title = reg[String(i)] ? ("å·²ç™»è¨˜ï¼š" + (reg[String(i)].name || "")) : "ç©ºä½";
    div.addEventListener("click", ()=>{
      selectedSlot = i;
      regSlot.value = String(i);
      const e = reg[String(i)];
      if(e){
        regName.value = e.name || "";
        regWallet.value = e.wallet || "";
        regNote.value = e.note || "";
        regHint.textContent = `å·²é¸åé¡ ${i}ï¼ˆå·²ç™»è¨˜ï¼‰`;
      }else{
        regHint.textContent = `å·²é¸åé¡ ${i}ï¼ˆç©ºä½ï¼‰`;
      }
      renderSlots();
    });
    slotGrid.appendChild(div);
  }
}

function syncFairyInputs(){
  const ids = ["fairyName1","fairyName2","fairyName3","fairyName4","fairyName5","fairyName6","fairyName7"];
  const keys = ["f1","f2","f3","f4","f5","f6","f7"];
  for(let i=0;i<7;i++){
    const el = document.getElementById(ids[i]);
    if(!el) continue;
    el.value = TEMPLE.fairies[keys[i]] || DEFAULT_FAIRIES[keys[i]];
  }
}

function pullFairyInputs(){
  const ids = ["fairyName1","fairyName2","fairyName3","fairyName4","fairyName5","fairyName6","fairyName7"];
  const keys = ["f1","f2","f3","f4","f5","f6","f7"];
  for(let i=0;i<7;i++){
    const el = document.getElementById(ids[i]);
    if(!el) continue;
    const v = (el.value || "").trim();
    if(v) TEMPLE.fairies[keys[i]] = v;
  }
}

function nextEmptySlot(key){
  const reg = ensureRegistry(key);
  for(let i=1;i<=72;i++){
    if(!reg[String(i)]) return i;
  }
  return null;
}

btnSaveZ13.addEventListener("click", ()=>{
  TEMPLE.z13Name = (z13Name.value || "").trim();
  templeSave();
  selectedSlot = null;
  tlog("z13_saved=" + (TEMPLE.z13Name || "å®‡å®™"));
  renderSlots();
});

zodiacSel.addEventListener("change", ()=>{
  selectedSlot = null;
  renderSlots();
  regHint.textContent = `å·²åˆ‡æ›ç”Ÿè‚–ï¼š${zodiacLabel()}`;
});

btnClearReg.addEventListener("click", ()=>{
  regSlot.value = "";
  regName.value = "";
  regWallet.value = "";
  regNote.value = "";
  selectedSlot = null;
  renderSlots();
  tlog("reg_cleared");
});

btnRegister.addEventListener("click", ()=>{
  const key = zodiacKey();
  const reg = ensureRegistry(key);

  const name = (regName.value || "").trim();
  if(!name){ alert("è«‹è¼¸å…¥åå­—/æš±ç¨±"); return; }

  let slot = parseInt((regSlot.value || "").trim(), 10);
  if(!slot || slot<1 || slot>72){
    slot = nextEmptySlot(key);
  }
  if(!slot){ alert("æ­¤ç”Ÿè‚– 72 åé¡å·²æ»¿"); return; }

  if(reg[String(slot)]){
    const ok = confirm(`åé¡ ${slot} å·²æœ‰ç™»è¨˜ï¼Œæ˜¯å¦è¦†è“‹ï¼Ÿ`);
    if(!ok) return;
  }

  reg[String(slot)] = {
    slot,
    zodiac: zodiacLabel(),
    name,
    wallet: (regWallet.value || "").trim(),
    note: (regNote.value || "").trim(),
    ts: new Date().toISOString()
  };

  templeSave();
  selectedSlot = slot;
  renderSlots();
  tlog(`registered zodiac=${key} slot=${slot} name=${name}`);
});

btnLamp.addEventListener("click", ()=>{
  const key = zodiacKey();
  const fee = Number(lampFee.value || 0);
  const slot = selectedSlot || parseInt((regSlot.value||"").trim(),10) || null;
  const name = (regName.value || "").trim() || "(æœªå¡«)";
  const rec = {
    ts: new Date().toISOString(),
    zodiac: zodiacLabel(),
    zodiacKey: key,
    slot,
    name,
    feeKGEN: isFinite(fee) ? fee : 0,
    wallet: (regWallet.value || "").trim()
  };
  TEMPLE.lamps.unshift(rec);
  templeSave();
  tlog(`lamp_added zodiac=${key} slot=${slot||"-"} fee=${rec.feeKGEN}KGEN`);
});

btnSaveFairies.addEventListener("click", ()=>{
  pullFairyInputs();
  templeSave();
  tlog("fairies_saved");
});

function fairyName(fid){
  return TEMPLE.fairies && TEMPLE.fairies[fid] ? TEMPLE.fairies[fid] : fid;
}

btnWish.addEventListener("click", ()=>{
  const fid = fairySel.value;
  const text = (wish.value || "").trim();
  if(!text){ alert("è«‹è¼¸å…¥é¡˜æœ›"); return; }
  const rec = {
    ts: new Date().toISOString(),
    type: "wish",
    route: fid,
    fairy: fairyName(fid),
    zodiac: zodiacLabel(),
    text,
    wallet: currentAccount || ""
  };
  TEMPLE.wishes.unshift(rec);
  templeSave();
  tlog(`wish_route=${fid} fairy=${rec.fairy}`);
  log("wish_route=" + fid);
  log("export_wish_json");
});

btnVow.addEventListener("click", ()=>{
  const fid = fairySel.value;
  const text = (vow.value || "").trim();
  if(!text){ alert("è«‹è¼¸å…¥é‚„é¡˜å…§å®¹"); return; }
  const rec = {
    ts: new Date().toISOString(),
    type: "vow",
    route: fid,
    fairy: fairyName(fid),
    zodiac: zodiacLabel(),
    text,
    wallet: currentAccount || ""
  };
  TEMPLE.vows.unshift(rec);
  templeSave();
  tlog(`vow_route=${fid} fairy=${rec.fairy}`);
});

function showExportOverlay(title, text){
  const wrap = document.createElement("div");
  wrap.style.position = "fixed";
  wrap.style.inset = "0";
  wrap.style.background = "rgba(0,0,0,.65)";
  wrap.style.zIndex = "99999";
  wrap.style.display = "flex";
  wrap.style.alignItems = "center";
  wrap.style.justifyContent = "center";
  wrap.innerHTML = `
    <div style="width:min(860px,92vw); background:#0b0d10; border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:14px;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div style="font-weight:900; font-size:14px;">${title}</div>
        <button id="exClose" class="btn2">é—œé–‰</button>
      </div>
      <div class="small" style="margin-top:6px; opacity:.85">è‹¥ç’°å¢ƒé˜»æ“‹ä¸‹è¼‰ï¼Œè«‹æ”¹ç”¨è¤‡è£½/æ‰‹å‹•å­˜æª”ã€‚</div>
      <textarea id="exTa" style="width:100%; height:320px; margin-top:10px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0f1318; color:#e7eaf0; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">${text.replace(/</g,"&lt;")}</textarea>
      <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
        <button id="exCopy" class="btn">è¤‡è£½ JSON</button>
        <button id="exDl" class="btn">ä¸‹è¼‰ JSON</button>
        <span class="small" id="exHint"></span>
      </div>
    </div>
  `;
  document.body.appendChild(wrap);
  const exTa = wrap.querySelector("#exTa");
  const exHint = wrap.querySelector("#exHint");
  wrap.querySelector("#exClose").onclick = ()=> wrap.remove();
  wrap.querySelector("#exCopy").onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(exTa.value);
      exHint.textContent = "å·²è¤‡è£½";
      log("log_copied");
    }catch(e){
      exHint.textContent = "è¤‡è£½å¤±æ•—ï¼ˆè«‹é•·æŒ‰å…¨é¸è¤‡è£½ï¼‰";
    }
  };
  wrap.querySelector("#exDl").onclick = ()=>{
    try{
      downloadText("wukong_temple_export.json", exTa.value);
      exHint.textContent = "å·²å˜—è©¦ä¸‹è¼‰";
      log("export_download_try");
    }catch(e){
      exHint.textContent = "ä¸‹è¼‰å¤±æ•—ï¼ˆè«‹ç”¨è¤‡è£½ï¼‰";
    }
  };
}

btnExportTemple.addEventListener("click", ()=>{
  const payload = {
    boot_version: BOOT_VERSION,
    exported_at: new Date().toISOString(),
    zodiac13: TEMPLE.z13Name || "",
    fairies: TEMPLE.fairies,
    registries: TEMPLE.registries,
    lamps: TEMPLE.lamps,
    wishes: TEMPLE.wishes,
    vows: TEMPLE.vows
  };
  const text = JSON.stringify(payload, null, 2);
  showExportOverlay("å¤–æ®¿è³‡æ–™åŒ¯å‡ºï¼ˆJSONï¼‰", text);
  tlog("export_temple_json");
  log("export_lamps_json");
});

btnResetTemple.addEventListener("click", ()=>{
  const ok = confirm("ç¢ºèªé‡ç½®å¤–æ®¿è³‡æ–™ï¼Ÿï¼ˆåƒ…æ¸…æœ¬æ©Ÿ localStorageï¼‰");
  if(!ok) return;
  localStorage.removeItem(TEMPLE_KEY);
  TEMPLE = templeLoad();
  z13Name.value = TEMPLE.z13Name || "";
  syncFairyInputs();
  selectedSlot = null;
  renderSlots();
  wish.value = "";
  vow.value = "";
  tlog("temple_reset");
  log("cfg_cleared");
});

/* init */
z13Name.value = TEMPLE.z13Name || "";
syncFairyInputs();
renderSlots();
regHint.textContent = `å·²è¼‰å…¥å¤–æ®¿è³‡æ–™ã€‚ç”Ÿè‚–ï¼š${zodiacLabel()}`;

/* ========== AI Customer Service (local rules, no internet) ========== */
const aiInput = document.getElementById("aiInput");
const aiAnswer = document.getElementById("aiAnswer");
const aiHint = document.getElementById("aiHint");
const btnAsk = document.getElementById("btnAsk");
const btnTTS = document.getElementById("btnTTS");
const btnSTT = document.getElementById("btnSTT");
const btnStopSTT = document.getElementById("btnStopSTT");

function ttsSpeak(text){
  if(!hasTTS){
    log("tts_not_supported");
    return false;
  }
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "zh-TW";
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
    log("tts_spoken");
    return true;
  }catch(e){
    log("tts_fail " + (e && e.message ? e.message : String(e)));
    return false;
  }
}

let rec = null;
function sttStart(){
  if(!hasSTT){
    log("stt_not_supported");
    return;
  }
  try{
    rec = new SR();
    rec.lang = "zh-TW";
    rec.interimResults = false;
    rec.maxAlternatives = 1;
    rec.onresult = (ev) => {
      const text = ev.results && ev.results[0] && ev.results[0][0] ? ev.results[0][0].transcript : "";
      log("stt_text=" + text);
      aiInput.value = text;
      answerAI(text);
    };
    rec.onerror = (e) => {
      log("stt_error " + (e && e.error ? e.error : "unknown"));
      aiHint.textContent = "èªéŸ³è¼¸å…¥åœ¨æ­¤ç’°å¢ƒå¯èƒ½è¢«ä¸­æ–·ï¼ˆWebView/æ¬Šé™/æ‰‹å‹¢é™åˆ¶ï¼‰ã€‚å¯æ”¹ç”¨æ‰“å­—ã€‚";
    };
    rec.onend = () => { log("stt_stop"); };
    rec.start();
    log("stt_start");
  }catch(e){
    log("stt_fail " + (e && e.message ? e.message : String(e)));
  }
}
function sttStop(){
  try{
    if(rec){ rec.stop(); }
  }catch(e){}
}

function answerAI(q){
  const text = (q || "").trim();
  if(!text){
    aiAnswer.innerHTML = "è«‹è¼¸å…¥å•é¡Œã€‚";
    return;
  }
  const lower = text.toLowerCase();

  // Minimal deterministic local "customer service"
  let a = "";
  if(lower.includes("éŒ¢åŒ…") || lower.includes("metamask") || lower.includes("æ€éº¼è£")){
    a = "éŒ¢åŒ…æ•™å­¸ï¼šä¸€ï¼Œå®‰è£ MetaMaskã€‚äºŒï¼Œåˆ‡åˆ° BNB Chainã€‚ä¸‰ï¼ŒåŒ¯å…¥ KGEN ä»£å¹£åˆç´„åœ°å€ã€‚å››ï¼Œæº–å‚™å°‘é‡ BNB ä½œ gasã€‚äº”ï¼Œæœ¬ç‰ˆä¸‹å–®æ¡Œç›®å‰æ˜¯ T+2 æ¨¡æ“¬ï¼›è¦çœŸä¸Šéˆä¸‹å–®ï¼Œéœ€è¦æŠŠä¸‹å–®è¨Šæ¯é€é€² KUFO æˆ–å¿ƒè‡Ÿåˆç´„ï¼Œå†ç”±å¤§è…¦åšçµç®—è¦å‰‡ã€‚";
  } else if(lower.includes("t+2") || lower.includes("çµç®—")){
    a = "æœ¬å®‡å®™è¦å‰‡ï¼šæ‰€æœ‰ K ç·šäº¤æ˜“ä»¥äº¤æ˜“æ—¥ T+2 çµç®—ï¼Œä¸ç”¨é€±ä¸‰çµç®—ã€‚åœåˆ©èˆ‡åœæè‹¥åœ¨åŒä¸€çµç®—æ—¥åŒæ™‚è§¸ç™¼ï¼Œè¦–ç‚º 0ï¼ˆä¸ç®—è¼¸è´ï¼‰ã€‚";
  } else if(lower.includes("æ§“æ¡¿") || lower.includes("å€æ•¸")){
    a = "æ§“æ¡¿ 1 åˆ° 150 å€ã€‚æ§“æ¡¿åªå½±éŸ¿æ¨¡æ“¬è¼¸è´å€ç‡ï¼Œä¸æ”¹è®Šä½ æŠ•å…¥çš„è³ªé‡ï¼ˆKGENï¼‰ã€‚";
  } else if(lower.includes("æ–¹å‘") || lower.includes("å¤šç©º") || lower.includes("æ–¹å‘ç›¤")){
    a = "æ–¹å‘ç›¤ 0 åˆ° 170 åº¦æ˜¯å¤šæ–¹æ‰‡å€ï¼Œ170 åˆ° 190 åº¦æ˜¯ä¼‘æ¯å€ï¼Œ190 åˆ° 360 åº¦æ˜¯ç©ºæ–¹æ‰‡å€ã€‚ä¼‘æ¯å€è¦–ç‚ºä¸ä¸‹å–®ï¼Œè¼¸è´ç‚º 0ã€‚";
  } else if(lower.includes("åŒ¯å‡º") || lower.includes("ä¸‹è¼‰")){
    a = "è‹¥ä½ åœ¨ WebViewï¼ˆä¾‹å¦‚ MetaMask å…§å»ºç€è¦½å™¨ï¼‰é‡åˆ°ä¸‹è¼‰é˜»æ“‹ï¼Œæœ¬ç³»çµ±æœƒè‡ªå‹•æ”¹ç”¨å‰ªè²¼ç°¿å‚™æ´ã€‚ä½ ä¹Ÿå¯ä»¥ç”¨ã€è¤‡è£½ Logã€æŠŠå…§å®¹è²¼åˆ°è¨˜äº‹æœ¬ä¿å­˜ã€‚";
  } else if(lower.includes("atr14") || lower.includes("æœ€å¤§") || lower.includes("åœæ") || lower.includes("åœåˆ©")){
    a = "é¢¨æ§è¦å‰‡ï¼šæœ€å¤§è´è™§å»ºè­°é™åˆ¶åœ¨ Â±ATR14ã€‚ä¸‹å–®æ¡ŒæœƒæŠŠåœåˆ©åœæè‡ªå‹•é™åˆ¶åœ¨ ATR14 ç¯„åœå…§ï¼Œé¿å…è¶…æ¨™ã€‚";
  } else {
    a = "æˆ‘æ”¶åˆ°ä½ çš„å•é¡Œã€‚ä½ å¯ä»¥ç›´æ¥å•ï¼šéŒ¢åŒ…æ€éº¼è£ã€T+2 æ€éº¼ç®—ã€æ§“æ¡¿æ€éº¼èª¿ã€æ–¹å‘ç›¤æ€éº¼åˆ¤å¤šç©ºã€å¦‚ä½•åŒ¯å‡ºç‹€æ…‹ã€‚";
  }

  aiAnswer.innerHTML = a;
  aiHint.textContent = hasTTS ? "å¯æŒ‰ã€èªéŸ³å”¸å‡ºã€è®“å®¢æœç”¨è²éŸ³å›è¦†ã€‚" : "æ­¤ç’°å¢ƒä¸æ”¯æ´èªéŸ³å”¸å‡ºï¼ˆTTS OFFï¼‰ï¼Œå·²è‡ªå‹•é™ç´šç‚ºæ–‡å­—å®¢æœã€‚";
  pushEvent("assistant_answer");
  if(hasTTS) ttsSpeak(a);
}

btnAsk.onclick = () => answerAI(aiInput.value);
btnTTS.onclick = () => ttsSpeak(aiAnswer.innerText || "æ‚Ÿç©ºå®‡å®™å®¢æœåœ¨ç·šã€‚");
btnSTT.onclick = () => sttStart();
btnStopSTT.onclick = () => sttStop();

// Disable buttons based on support
btnTTS.disabled = !hasTTS;
btnSTT.disabled = !hasSTT;

// Initial greet
aiAnswer.innerHTML = "ä½ å¥½ï¼Œæˆ‘æ˜¯æ‚Ÿç©ºå®‡å®™ AI å®¢æœã€‚ä½ å¯ä»¥å•ï¼šéŒ¢åŒ…æ€éº¼è£ã€T+2 çµç®—ã€æ§“æ¡¿ã€æ–¹å‘ç›¤ã€å¤šç©ºè¦å‰‡ã€åŒ¯å‡ºä¸‹è¼‰ã€‚";
aiHint.textContent = "ç³»çµ±æœƒè‡ªå‹•åµæ¸¬ç’°å¢ƒï¼Œä¸åŒç€è¦½å™¨æœƒè‡ªå‹•é™ç´šã€‚";

/* ========== End ========== */
log("ready");
</script>
</body>
</html>
