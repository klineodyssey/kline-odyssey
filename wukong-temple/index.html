<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>æ‚Ÿç©ºè²¡ç¥æ®¿ï½œWukong Fortune Temple V2.3</title>
  <meta name="description" content="æ‚Ÿç©ºè²¡ç¥æ®¿ï¼šå‘¼å¸ã€å¿ƒè·³ã€åšæ¯ã€é‚„é¡˜ã€ç™¼è²¡é‡‘ã€æ›¸åŸã€ç”Ÿå‘½é›é€ ã€‚"/>
  <style>
    :root {
      --fg:#111; --bg:#fff; --muted:#666; --card:#fff; --soft:#fafafa;
      --radius:16px;
    }
    body { margin:0; background:var(--bg); color:var(--fg); font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif; }
    a { color:inherit; }
    .wrap { max-width:900px; margin:20px auto; padding:16px; }
    .topbar { position:sticky; top:0; z-index:999; backdrop-filter:saturate(1.2) blur(8px); background:rgba(255,255,255,.92); border-bottom:1px solid #eee; }
    .topbar-inner { max-width:900px; margin:0 auto; padding:10px 16px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .brand { font-weight:900; letter-spacing:.2px; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid var(--fg); border-radius:999px; background:var(--bg); font-weight:900; cursor:pointer; text-decoration:none; }
    .pill:disabled { opacity:.45; cursor:not-allowed; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px; }
    .card { border:1px solid var(--fg); border-radius:var(--radius); background:var(--card); padding:14px; }
    .soft { background:var(--soft); }
    .h1 { font-size:22px; font-weight:900; line-height:1.2; }
    .h2 { font-size:16px; font-weight:900; }
    .muted { color:var(--muted); }
    .mono { font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input, select, textarea {
      width:100%; box-sizing:border-box;
      padding:10px 12px; border:1px solid var(--fg); border-radius:12px; font-weight:700; background:#fff;
    }
    textarea { min-height:96px; resize:vertical; }
    .hr { height:1px; background:#eee; margin:12px 0; }
    .badge { display:inline-block; padding:4px 8px; border:1px solid #111; border-radius:999px; font-weight:900; font-size:12px; }
    .ok { background:#f5fff0; }
    .warn { background:#fff8e6; }
    .err { background:#fff0f0; }
    .btn { width:100%; text-align:left; cursor:pointer; padding:14px; border:1px solid var(--fg); border-radius:14px; background:#fff; }
    .btn:hover { background:#fcfcfc; }
    .two { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:680px) { .two { grid-template-columns:1fr; } }
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; padding:18px; z-index:9999; }
    .modal.open { display:flex; }
    .modal-card { width:min(980px, 100%); max-height:86vh; overflow:auto; border-radius:20px; background:#fff; border:1px solid #111; }
    .modal-head { position:sticky; top:0; background:#fff; border-bottom:1px solid #eee; padding:12px 14px; display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .close { cursor:pointer; padding:10px 12px; border:1px solid #111; border-radius:999px; background:#fff; font-weight:900; }
    .kpi { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    @media (max-width:680px) { .kpi { grid-template-columns:1fr; } }
    .kpi .card { padding:12px; }
    .small { font-size:13px; line-height:1.7; }
    .progress { height:10px; border:1px solid #111; border-radius:999px; overflow:hidden; background:#fff; }
    .progress > div { height:100%; background:#111; width:0%; }
    .toast { font-weight:900; margin-top:10px; }
    .addr2 { word-break:break-all; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div>
        <div class="brand">æ‚Ÿç©ºè²¡ç¥æ®¿ï½œWukong Fortune Temple</div>
        <div class="muted small">V2.3 Â· Build 2026-02-10 19:09:17 +0800</div>
      </div>
      <div class="row">
        <a class="pill" href="https://klineodyssey.github.io/kline-odyssey/" target="_blank" rel="noopener">ğŸŒ å®˜ç¶²</a>
        <button class="pill" id="btnOpenBlueprint">ğŸ—ï¸ å»ºæ®¿è—åœ–</button>
        <button class="pill" id="btnOpenDebug">ğŸ§ª Debug</button>
      </div>
    </div>
  </div>

  <div class="wrap">

    <div class="card">
      <div class="h1">è¦å‰‡ä¸€å¥è©±</div>
      <div class="small" style="margin-top:8px;">
        é€™è£¡æ˜¯äº’å‹•å¼éŠæˆ²å…¥å£ï¼šåƒè§€ã€é¸æ“‡ã€é«”é©—ï¼Œç„¶å¾Œé›¢é–‹ã€‚<br/>
        ä¸æ‰¿è«¾æ”¶ç›Šã€ä¸æä¾›æŠ•è³‡å»ºè­°ã€ä¸åšå›å ±ä¿è­‰ã€‚æ‰€æœ‰éˆä¸Šå‹•ä½œå¿…é ˆç”±ä½ åœ¨éŒ¢åŒ…ä¸­æŒ‰ç¢ºèªã€‚
      </div>
    </div>

    <div class="kpi" style="margin-top:12px;">
      <div class="card soft">
        <div class="h2">ğŸ‘£ ä¾†è¨ªäººæ•¸</div>
        <div id="visitorInfo" class="small" style="margin-top:8px;">è®€å–ä¸­â€¦</div>
        <div class="row" style="margin-top:10px;">
          <button class="pill" id="btnRefreshStats">é‡æ–°æ•´ç†</button>
        </div>
      </div>

      <div class="card soft">
        <div class="h2">ğŸ«€ å¿ƒè·³ / å‘¼å¸</div>
        <div id="heartbeatInfo" class="small" style="margin-top:8px;">å°šæœªåˆå§‹åŒ–</div>
        <div class="row" style="margin-top:10px;">
          <button class="pill" id="btnSpeak">â–¶ï¸ èªéŸ³å®¢æœ</button>
          <button class="pill" id="btnStopSpeak">â¹ï¸ åœæ­¢</button>
        </div>
      </div>

      <div class="card soft">
        <div class="h2">ğŸªª éŒ¢åŒ…ç‹€æ…‹ï¼ˆBSC ä¸»ç¶²ï¼‰</div>
        <div id="walletInfo" class="small" style="margin-top:8px;">æœªé€£ç·š</div>
        <div class="row" style="margin-top:10px;">
          <button class="pill" id="btnConnect">é€£ç·šéŒ¢åŒ…</button>
          <button class="pill" id="btnMic">ğŸ™ï¸ ä¸€å•ä¸€ç­”</button>
          <button class="pill" id="btnMicStop">ğŸ›‘ åœæ­¢è½</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="h2">ğŸ” éˆä¸Šé©—è­‰ï¼ˆBscScanï¼‰</div>
      <div class="small" style="margin-top:8px; line-height:1.9;">
        KGEN Tokenï¼š<a id="linkToken" target="_blank" rel="noopener" class="mono addr2"></a><br/>
        Faucet å¿ƒè‡Ÿï¼š<a id="linkFaucet" target="_blank" rel="noopener" class="mono addr2"></a><br/>
        ç„¡äººéŠ€è¡Œï¼š<a id="linkBank" target="_blank" rel="noopener" class="mono addr2"></a>
      </div>
      <div class="small muted" style="margin-top:8px;">
        æé†’ï¼šè‹¥éŒ¢åŒ…æœå°‹ä¸åˆ° KGENï¼Œè«‹ç”¨ã€Œè‡ªè¨‚ä»£å¹£ Custom Tokenã€è¼¸å…¥åˆç´„åœ°å€åŠ å…¥ã€‚
      </div>
    </div>

    <div class="grid" style="margin-top:12px;">
      <button class="btn" id="btnVisit">
        <div class="h2">ğŸ® ç™»å…¥åƒæ‹œ</div>
        <div class="small muted" style="margin-top:6px;">æœ¬æ©Ÿè¨˜éŒ„ä¸€æ¬¡åƒæ‹œï¼ˆå¯åŒ¯å‡ºï¼‰</div>
      </button>

      <button class="btn" id="btnBobei">
        <div class="h2">ğŸ² åšæ¯ï¼ˆ3 æ¬¡è–ç­Šè§£é–ï¼‰</div>
        <div class="small muted" style="margin-top:6px;">ä¸‰æ¬¡è–ç­Š â†’ è§£é–ã€Œé ˜ç™¼è²¡é‡‘ã€æŒ‰éˆ•</div>
      </button>

      <button class="btn" id="btnFortune" disabled>
        <div class="h2">ğŸ§§ é ˜ç™¼è²¡é‡‘ï¼ˆFaucet åˆç´„ï¼‰</div>
        <div class="small muted" style="margin-top:6px;">éœ€è¦ï¼šå·²é€£ç·šéŒ¢åŒ… + å®Œæˆä¸‰æ¬¡è–ç­Š + åˆç´„å·²éƒ¨ç½²</div>
      </button>

      <button class="btn" id="btnVow">
        <div class="h2">ğŸ™ é‚„é¡˜ï¼ˆé€è‡³ 3 åœ°å€ï¼‰</div>
        <div class="small muted" style="margin-top:6px;">é»‘æ´ï¼ˆç‡’ï¼‰/ ç„¡äººéŠ€è¡Œ / Faucetï¼ˆå›è£œå¿ƒè‡Ÿï¼‰</div>
      </button>

      <a class="btn" href="./bookstore.html">
        <div class="h2">ğŸ“˜ æ‚Ÿç©ºæ›¸åŸ</div>
        <div class="small muted" style="margin-top:6px;">å…§å®¹å…Œæ› / ä¸€éµå¯„ä¿¡</div>
      </a>

      <a class="btn" href="./life-forge.html">
        <div class="h2">ğŸ² ç”Ÿå‘½é›é€ ï¼ˆ12 ç”Ÿè‚–ï¼‰</div>
        <div class="small muted" style="margin-top:6px;">è¼¸å…¥åå­—èˆ‡å¿ƒç‡ â†’ ç”Ÿæˆå¯å†ç¾ DNA JSON</div>
      </a>

      <button class="btn" id="btnExit">
        <div class="h2">ğŸšª ç™»å‡ºé›¢é–‹</div>
        <div class="small muted" style="margin-top:6px;">æœ¬æ©Ÿè¨˜éŒ„ä¸€æ¬¡é›¢é–‹ï¼ˆå¯åŒ¯å‡ºï¼‰</div>
      </button>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="h2">ğŸ¦ é‚„é¡˜åœ°å€ï¼ˆ3 é¸ 1ï¼‰</div>
      <div class="small muted" style="margin-top:6px;">
        1ï¼‰Faucet å¿ƒè‡Ÿï¼šå›è£œè¡€æ¶²å¾ªç’°ï¼ˆç™¼è²¡é‡‘å›æµï¼‰<br/>
        2ï¼‰ç„¡äººéŠ€è¡Œï¼š500å¸­ä½ / 500å¹´ / è¦å‰‡é–åœ¨åˆç´„ï¼ˆå¾ŒçºŒå‡ç´šï¼‰<br/>
        3ï¼‰0x000â€¦0000ï¼šè³ªèƒ½è½‰æ›ï¼ˆç‡’å¹£ï¼Œä¸å¯é€†ï¼‰
      </div>

      <div class="hr"></div>

      <div class="two">
        <div>
          <label class="small"><strong>é¸æ“‡é‚„é¡˜ç›®æ¨™</strong></label>
          <div class="small" style="margin-top:8px;">
            <label style="display:flex; gap:10px; align-items:flex-start; margin:8px 0;">
              <input type="radio" name="vowTarget" value="blackhole"/>
              <div><strong>é»‘æ´ï¼ˆç‡’ï¼‰</strong><div class="muted small">ä¸å¯é€†ï¼Œé€å‡ºå³æ°¸ä¹…å¤±å»ã€‚</div></div>
            </label>
            <label style="display:flex; gap:10px; align-items:flex-start; margin:8px 0;">
              <input type="radio" name="vowTarget" value="bank" checked/>
              <div><strong>ç„¡äººéŠ€è¡Œï¼ˆå¸­ä½/è±ªå®…/ç”Ÿå­˜æ¬Šï¼‰</strong><div class="muted small">5000 KGEN å…¥å£ï¼Œä¹‹å¾Œç”±åˆç´„é©—è­‰ã€‚</div></div>
            </label>
            <label style="display:flex; gap:10px; align-items:flex-start; margin:8px 0;">
              <input type="radio" name="vowTarget" value="faucet"/>
              <div><strong>Faucet å¿ƒè‡Ÿï¼ˆå›è£œï¼‰</strong><div class="muted small">å›è£œå¿ƒè‡Ÿï¼Œè®“ç™¼è²¡é‡‘èƒ½é•·ä¹…è·³å‹•ã€‚</div></div>
            </label>
          </div>
        </div>

        <div>
          <label class="small"><strong>é‚„é¡˜æ•¸é‡ï¼ˆK G E Nï¼‰</strong></label>
          <input id="inpAmount" inputmode="decimal" value="1" placeholder="ä¾‹å¦‚ï¼š1 æˆ– 0.88 æˆ– 5000" style="margin-top:8px;"/>
          <div class="small muted" style="margin-top:8px;">
            æç¤ºï¼š<strong>5000</strong> = è±ªå®…/å¸­ä½å…¥å£ï¼ˆè¦å‰‡ä»¥åˆç´„ç‚ºæº–ï¼‰ã€‚
          </div>
          <div class="card soft" style="margin-top:10px;">
            <div class="h2">åœ°å€é è¦½</div>
            <div id="addrPreview" class="mono small" style="margin-top:8px; white-space:pre-wrap;"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card soft" style="margin-top:12px;">
      <div class="h2">ğŸ’¬ å³æ™‚æ–‡å­—ï¼ˆä½ èªªçš„ / æ‚Ÿç©ºå›çš„ï¼‰</div>
      <div class="two" style="margin-top:10px;">
        <div>
          <div class="small muted">ä½ èªªçš„</div>
          <textarea id="liveUser" placeholder="æŒ‰ã€ä¸€å•ä¸€ç­”ã€å¾Œï¼Œé€™è£¡æœƒå‡ºç¾ä½ çš„å³æ™‚æ–‡å­—"></textarea>
        </div>
        <div>
          <div class="small muted">æ‚Ÿç©ºå›çš„</div>
          <textarea id="liveWukong" placeholder="æ‚Ÿç©ºæœƒç”¨è¦å‰‡åº«å›ä½ ï¼ˆä¸æœƒè‡ªå‹•å‡ºé‡‘ï¼‰"></textarea>
        </div>
      </div>
      <div class="small muted" style="margin-top:8px;">
        æ³¨æ„ï¼šæ‰‹æ©Ÿç€è¦½å™¨å¯èƒ½éœ€è¦æˆæ¬Šéº¥å…‹é¢¨ï¼›è‹¥åœ¨ MetaMask å…§å»ºç€è¦½å™¨ï¼Œè«‹å…è¨±ç¶²ç«™ä½¿ç”¨éº¥å…‹é¢¨ã€‚
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="h2">ğŸ“œ æœ¬æ©Ÿç´€éŒ„</div>
      <div id="statusText" class="small" style="margin-top:8px;">è¼‰å…¥ä¸­â€¦</div>
      <div class="row" style="margin-top:10px;">
        <button class="pill" id="btnExport">â¬‡ï¸ åŒ¯å‡ºç´€éŒ„ JSON</button>
        <button class="pill" id="btnClear">ğŸ§¹ æ¸…é™¤æœ¬æ©Ÿç´€éŒ„</button>
      </div>
      <div id="toast" class="toast"></div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="h2">âŒ– å›ºå®šå°¾æ®µ</div>
      <div class="small" style="margin-top:8px; line-height:1.8;">
        PrimeForge ä»¥æ¯æ©Ÿä¹‹åï¼Œé–‹å•Ÿé‡‘èç”Ÿå‘½ã€‚<br/>
        èŠ±æœå±±å°ç£ãƒ»ä¿¡å¿µä¸æ»…ãƒ»å¸‚å ´ç„¡ç•Œã€‚<br/>
        Where the Market Becomes the Myth.<br/>
        â€”â€” æ¨‚å¤©å¸ âŒ–
      </div>
    </div>

  </div>

  <!-- Blueprint Modal -->
  <div class="modal" id="modalBlueprint" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div class="h2">ğŸ—ï¸ æ‚Ÿç©ºè²¡ç¥æ®¿ï½œå»ºæ®¿è—åœ–ï¼ˆå¯é©—æ”¶ï¼‰</div>
        <button class="close" data-close="modalBlueprint">é—œé–‰</button>
      </div>
      <div style="padding:14px;">
        <div class="card soft">
          <div class="h2">å»ºæ®¿é€²åº¦</div>
          <div class="small muted" style="margin-top:6px;">é€²åº¦ä»¥ç‰ˆæœ¬è™Ÿ+ç™¾åˆ†æ¯”è¡¨ç¤ºã€‚200% ä»£è¡¨å¢å»ºï¼ˆæœˆè€æ®¿/è§£ç±¤/AIæ›´å¼·ï¼‰ã€‚</div>
          <div style="margin-top:10px;">
            <div class="row" style="justify-content:space-between;">
              <div class="badge ok">Version V2.3</div>
              <div class="badge warn" id="progressText">é€²åº¦ï¼š78%</div>
            </div>
            <div class="progress" style="margin-top:10px;"><div id="progressBar"></div></div>
            <div class="small" style="margin-top:10px; line-height:1.8;">
              <strong>å·²å®Œæˆï¼š</strong><br/>
              - ä¾†è¨ªè¨ˆæ•¸ï¼ˆCountAPI + fallbackï¼‰<br/>
              - éŒ¢åŒ…é€£ç·šï¼ˆBSCï¼‰ï¼‹KGENé¤˜é¡æŸ¥è©¢<br/>
              - åœ°å€å…©è¡Œé¡¯ç¤ºï¼ˆä¸å†è¶…å‡ºï¼‰<br/>
              - ä¸€å•ä¸€ç­”ï¼ˆéº¥å…‹é¢¨æ–‡å­— â†’ è¦å‰‡å›è¦† + èªéŸ³ï¼‰<br/>
              - åšæ¯ï¼ˆ3 æ¬¡è–ç­Šé–€æª»ï¼‰<br/>
              - é‚„é¡˜ï¼ˆé»‘æ´ / ç„¡äººéŠ€è¡Œ / Faucetï¼‰<br/>
              - æ›¸åŸå…¥å£ / ç”Ÿå‘½é›é€ å…¥å£ï¼ˆé é¢é€£çµï¼‰<br/><br/>
              <strong>å¾…ä¸Šéˆï¼ˆä¸‹ä¸€æ­¥ï¼‰ï¼š</strong><br/>
              - Faucet å¿ƒè‡Ÿåˆç´„éƒ¨ç½²ï¼ˆigniteAndClaim / heartbeat / æœˆåº¦è–ªæ°´ï¼‰<br/>
              - ç„¡äººéŠ€è¡Œåˆç´„ï¼ˆ500å¸­ä½ + è¦å‰‡é–ï¼‰<br/>
              - äº‹ä»¶ç´¢å¼•ï¼šè·¨å¹´/é™¤å¤•å€’æ•¸ï¼ˆkeeper æˆ–è‡ªå‹•åŒ–ï¼‰<br/>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="h2">å•Ÿå§‹æ—¥æœŸ</div>
          <div class="small" id="startDateText" style="margin-top:6px;"></div>
          <div class="small muted" style="margin-top:6px;">
            å»ºè­°ç”¨ã€Œå‡¡é–“æ™‚é–“ã€é¡¯ç¤ºï¼Œæ—é‚Šè£œå……ã€Œå®‡å®™ç›¸å°æ™‚é–“ã€ï¼ç´¯ç©å¿ƒè·³äº‹ä»¶æ•¸ï¼ˆä¸Šéˆå¾Œå¯è‡ªå‹•çµ±è¨ˆï¼‰ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Debug Modal -->
  <div class="modal" id="modalDebug" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div class="h2">ğŸ§ª Debug Panelï¼ˆæ‰€æœ‰éŒ¯èª¤å¯è¦–åŒ–ï¼‰</div>
        <button class="close" data-close="modalDebug">é—œé–‰</button>
      </div>
      <div style="padding:14px;">
        <div class="card soft">
          <div class="h2">Console</div>
          <pre id="debugLog" class="mono small" style="white-space:pre-wrap; margin-top:10px;"></pre>
        </div>
        <div class="card" style="margin-top:12px;">
          <div class="h2">å¿«é€Ÿæª¢æŸ¥</div>
          <div id="debugChecks" class="small" style="margin-top:10px; line-height:1.9;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ethers v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <script>
  (() => {
    "use strict";

    // ============ å›ºå®šçœŸå€¼ï¼ˆå¯åœ¨éƒ¨ç½²å¾Œåªæ”¹ FAUCET / BANKï¼‰ ============
    const CHAIN_ID_DEC = 56; // BSC mainnet
    const KGEN_TOKEN = "0xBA3d3810e58735cb6813bC1CDc5458C0d71432Be";
    const BANK_CONTRACT = "0xfc522243e988a837700CaD600D6f030f5932681F"; // ä½ éƒ¨ç½²çš„ GalacticBank v7.5.2
    // Faucet å¿ƒè‡Ÿï¼ˆæœªéƒ¨ç½²å‰å¯å…ˆç•™ç©ºï¼›éƒ¨ç½²å¾Œå¡«å…¥åœ°å€ï¼‰
    const FAUCET_CONTRACT = (localStorage.getItem("WUKONG_FAUCET") || "").trim(); // allow override
    // é»‘æ´
    const BLACKHOLE = "0x0000000000000000000000000000000000000000";

    // CountAPI
    const COUNT_NS = "klineodyssey-wukong-temple";
    const dayKey = () => {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `day_${yyyy}${mm}${dd}`;
    };
    const countapi = {
      hit: async (key) => {
        const url = `https://api.countapi.xyz/hit/${encodeURIComponent(COUNT_NS)}/${encodeURIComponent(key)}`;
        const r = await fetch(url);
        if(!r.ok) throw new Error("countapi_hit_failed");
        return await r.json();
      },
      get: async (key) => {
        const url = `https://api.countapi.xyz/get/${encodeURIComponent(COUNT_NS)}/${encodeURIComponent(key)}`;
        const r = await fetch(url);
        if(!r.ok) throw new Error("countapi_get_failed");
        return await r.json();
      }
    };

    // UI
    const $ = (id) => document.getElementById(id);
    const $visitorInfo = $("visitorInfo");
    const $walletInfo  = $("walletInfo");
    const $heartbeatInfo = $("heartbeatInfo");
    const $addrPreview = $("addrPreview");
    const $toast = $("toast");
    const $status = $("statusText");
    const $liveUser = $("liveUser");
    const $liveWukong = $("liveWukong");

    const logLines = [];
    const log = (m) => {
      const line = `[${new Date().toISOString()}] ${m}`;
      logLines.push(line);
      if (logLines.length > 400) logLines.shift();
      $("debugLog").textContent = logLines.join("\n");
      console.log(m);
    };

    const toast = (msg) => {
      $toast.textContent = msg;
      setTimeout(() => { if($toast.textContent===msg) $toast.textContent=""; }, 3200);
    };

    // Links
    const mkBsc = (addr) => `https://bscscan.com/address/${addr}`;
    $("linkToken").textContent = KGEN_TOKEN;
    $("linkToken").href = mkBsc(KGEN_TOKEN);
    $("linkBank").textContent = BANK_CONTRACT;
    $("linkBank").href = mkBsc(BANK_CONTRACT);
    $("linkFaucet").textContent = FAUCET_CONTRACT ? FAUCET_CONTRACT : "ï¼ˆå°šæœªéƒ¨ç½²/æœªè¨­å®šï¼‰";
    $("linkFaucet").href = FAUCET_CONTRACT ? mkBsc(FAUCET_CONTRACT) : "https://bscscan.com";

    const vowAddr = {
      blackhole: BLACKHOLE,
      bank: BANK_CONTRACT,
      faucet: FAUCET_CONTRACT || "(å°šæœªè¨­å®š)"
    };
    const renderAddrPreview = () => {
      $addrPreview.textContent =
`blackhole (ç‡’): ${vowAddr.blackhole}
bank (ç„¡äººéŠ€è¡Œ): ${vowAddr.bank}
faucet (å¿ƒè‡Ÿ): ${vowAddr.faucet}`;
    };
    renderAddrPreview();

    // ============ æœ¬æ©Ÿç´€éŒ„ ============
    const KEY = "klineodyssey_wukongTemple_v2_3";
    const safeParse = (s) => { try { return JSON.parse(s); } catch { return null; } };
    const nowISO = () => new Date().toISOString();
    const defaultState = () => ({
      visitCount:0, exitCount:0, vowCount:0, fortuneCount:0,
      bobeiWins:0, bobeiTries:0,
      log:[]
    });
    const load = () => {
      const raw = localStorage.getItem(KEY);
      const p = raw ? safeParse(raw) : null;
      return p && typeof p==="object"
        ? {...defaultState(), ...p, log:Array.isArray(p.log)?p.log:[]}
        : defaultState();
    };
    const save = (s) => localStorage.setItem(KEY, JSON.stringify(s));
    const pushLog = (s, type, meta={}) => {
      s.log.push({ type, time: nowISO(), ...meta });
      if(s.log.length>600) s.log=s.log.slice(-600);
    };
    const downloadJSON = (obj, filename) => {
      const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href=url; a.download=filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    };
    const renderLocal = () => {
      const s=load();
      $status.innerHTML = `
        <div>ğŸ® åƒæ‹œï¼š<strong>${s.visitCount}</strong> æ¬¡</div>
        <div>ğŸ² åšæ¯ï¼š<strong>${s.bobeiWins}</strong> / 3 è–ç­Šï¼ˆå˜—è©¦ ${s.bobeiTries} æ¬¡ï¼‰</div>
        <div>ğŸ§§ ç™¼è²¡é‡‘ï¼š<strong>${s.fortuneCount}</strong> æ¬¡</div>
        <div>ğŸ™ é‚„é¡˜ï¼š<strong>${s.vowCount}</strong> æ¬¡</div>
        <div>ğŸšª ç™»å‡ºï¼š<strong>${s.exitCount}</strong> æ¬¡</div>
      `;
      // enable fortune button if gate + faucet exists
      const can = (s.bobeiWins>=3) && !!FAUCET_CONTRACT;
      $("btnFortune").disabled = !can;
    };
    renderLocal();

    // ============ Modal ============
    const openModal = (id) => {
      const m = $(id);
      m.classList.add("open");
      m.setAttribute("aria-hidden","false");
    };
    const closeModal = (id) => {
      const m = $(id);
      m.classList.remove("open");
      m.setAttribute("aria-hidden","true");
    };
    $("btnOpenBlueprint").addEventListener("click", () => openModal("modalBlueprint"));
    $("btnOpenDebug").addEventListener("click", () => {
      openModal("modalDebug");
      runDebugChecks();
    });
    document.querySelectorAll("[data-close]").forEach(el => {
      el.addEventListener("click", () => closeModal(el.getAttribute("data-close")));
    });
    document.addEventListener("keydown", (e) => {
      if(e.key==="Escape") {
        closeModal("modalBlueprint"); closeModal("modalDebug");
      }
    });

    // Blueprint info
    const START_DATE = localStorage.getItem("WUKONG_TEMPLE_START") || "2026-02-10";
    $("startDateText").textContent = `å‡¡é–“æ™‚é–“ï¼š${START_DATE}ï¼ˆä½ å¯åœ¨ localStorage è¨­å®š WUKONG_TEMPLE_STARTï¼‰`;
    const progress = 78;
    $("progressText").textContent = `é€²åº¦ï¼š${progress}%`;
    $("progressBar").style.width = `${progress}%`;

    // ============ Visitors ============
    const renderVisitors = (todayVal,totalVal) => {
      $visitorInfo.innerHTML = `
        <div>ğŸ“… ä»Šæ—¥ï¼š<strong>${todayVal}</strong></div>
        <div>ğŸŒ ç¸½è¨ˆï¼š<strong>${totalVal}</strong></div>
        <div class="muted">ï¼ˆæ¯æ¬¡è¼‰å…¥æœ¬é æœƒè‡ªå‹• +1ï¼‰</div>
      `;
    };
    const refreshVisitors = async (doHit) => {
      try {
        const dk=dayKey();
        let todayVal=0, totalVal=0;
        if(doHit) {
          const [t1,t2] = await Promise.all([countapi.hit(dk), countapi.hit("total")]);
          todayVal = t1.value ?? 0;
          totalVal = t2.value ?? 0;
        } else {
          const [g1,g2] = await Promise.all([countapi.get(dk), countapi.get("total")]);
          todayVal = g1.value ?? 0;
          totalVal = g2.value ?? 0;
        }
        renderVisitors(todayVal,totalVal);
      } catch(e) {
        $visitorInfo.innerHTML = `<div class="muted">ä¾†è¨ªçµ±è¨ˆæš«æ™‚ç„¡æ³•å–å¾—ï¼ˆç¶²è·¯æˆ–ç€è¦½å™¨é˜»æ“‹ï¼‰ã€‚</div>`;
        log("Visitor count error: "+String(e));
      }
    };
    $("btnRefreshStats").addEventListener("click", async () => {
      await refreshVisitors(false);
      toast("å·²æ›´æ–°ä¾†è¨ªçµ±è¨ˆ");
    });
    refreshVisitors(true);

    // ============ Voice (TTS) ============
    const speakText = (text) => {
      try {
        if(!("speechSynthesis" in window)) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "zh-TW";
        u.rate = 1.0;
        u.pitch = 1.0;
        window.speechSynthesis.speak(u);
      } catch(e) {
        log("TTS error: "+String(e));
      }
    };
    const stopSpeak = () => {
      try { if("speechSynthesis" in window) window.speechSynthesis.cancel(); } catch {}
    };

    const helpScript = () => {
      const faucetLine = FAUCET_CONTRACT
        ? "ç™¼è²¡é‡‘ç”± Faucet å¿ƒè‡Ÿåˆç´„ç™¼æ”¾ï¼Œæ‰€æœ‰å‡ºé‡‘éƒ½éœ€è¦ä½ åœ¨éŒ¢åŒ…æŒ‰ç¢ºèªã€‚"
        : "ç›®å‰ Faucet å¿ƒè‡Ÿåˆç´„å°šæœªè¨­å®šï¼Œæ‰€ä»¥é ˜ç™¼è²¡é‡‘æŒ‰éˆ•æœƒé–ä½ã€‚";
      return (
        "æ­¡è¿ä¾†åˆ°æ‚Ÿç©ºè²¡ç¥æ®¿ã€‚é€™è£¡æ˜¯äº’å‹•å¼éŠæˆ²å…¥å£ï¼Œä¸æ˜¯æŠ•è³‡å¹³å°ã€‚"+
        faucetLine+
        "å¦‚æœéŒ¢åŒ…æœå°‹ä¸åˆ°KGENï¼Œè«‹ç”¨è‡ªè¨‚ä»£å¹£ï¼Œè¼¸å…¥KGENåˆç´„åœ°å€ã€‚"+
        "é‚„é¡˜æœ‰ä¸‰å€‹åœ°å€ï¼šé»‘æ´ç‡’å¹£ã€ç„¡äººéŠ€è¡Œã€ä»¥åŠFaucetå¿ƒè‡Ÿå›è£œã€‚"+
        "åšæ¯ä¸‰æ¬¡è–ç­Šæœƒè§£é–é ˜ç™¼è²¡é‡‘ã€‚"
      );
    };

    $("btnSpeak").addEventListener("click", () => {
      speakText(helpScript());
      toast("èªéŸ³å®¢æœå·²å•Ÿå‹•");
    });
    $("btnStopSpeak").addEventListener("click", () => {
      stopSpeak(); toast("å·²åœæ­¢èªéŸ³");
    });

    // ============ Speech Recognition (Mic Q&A) ============
    let recog = null;
    const supportsRecog = () => ("webkitSpeechRecognition" in window) || ("SpeechRecognition" in window);
    const buildRecog = () => {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const r = new SR();
      r.lang = "zh-TW";
      r.interimResults = true;
      r.continuous = true;
      return r;
    };

    const ruleReply = (q) => {
      const s = (q||"").toLowerCase();
      if(s.includes("metamask") || s.includes("éŒ¢åŒ…")) {
        return "è«‹ç”¨ MetaMask æˆ–éŒ¢åŒ…å…§å»ºç€è¦½å™¨é–‹å•Ÿæœ¬é ã€‚æŒ‰é€£ç·šéŒ¢åŒ…å¾Œï¼Œåˆ‡åˆ° BSC ä¸»ç¶²ã€‚è‹¥æ‰¾ä¸åˆ° KGENï¼Œè«‹ç”¨è‡ªè¨‚ä»£å¹£è¼¸å…¥åˆç´„åœ°å€ã€‚";
      }
      if(s.includes("kgen") && (s.includes("æ‰¾ä¸åˆ°") || s.includes("æœå°‹"))) {
        return "KGEN éœ€è¦ç”¨è‡ªè¨‚ä»£å¹£åŠ å…¥ï¼šåœ¨ MetaMask é»åŒ¯å…¥ä»£å¹£ï¼Œè²¼ä¸Š KGEN åˆç´„åœ°å€ï¼Œç¢ºèªå¾Œå°±æœƒå‡ºç¾ã€‚";
      }
      if(s.includes("ç™¼è²¡é‡‘") || s.includes("é ˜")) {
        if(!FAUCET_CONTRACT) return "ç›®å‰ Faucet å¿ƒè‡Ÿåˆç´„å°šæœªè¨­å®šï¼Œæ‰€ä»¥é‚„ä¸èƒ½è‡ªå‹•ç™¼æ”¾ã€‚éƒ¨ç½²å¾Œæœƒç”±åˆç´„å‡ºé‡‘ï¼Œä½ åªéœ€è¦åœ¨éŒ¢åŒ…æŒ‰ç¢ºèªã€‚";
        return "é ˜ç™¼è²¡é‡‘æµç¨‹ï¼šå…ˆåšæ¯ä¸‰æ¬¡è–ç­Šè§£é–ï¼Œå†æŒ‰é ˜ç™¼è²¡é‡‘ï¼ŒéŒ¢åŒ…è·³å‡ºäº¤æ˜“ï¼Œä½ æŒ‰ç¢ºèªå¾Œå³å¯éˆä¸Šé©—è­‰ã€‚";
      }
      if(s.includes("é‚„é¡˜") || s.includes("åœ°å€")) {
        return "é‚„é¡˜ä¸‰åœ°å€ï¼šé»‘æ´ç‡’å¹£ä¸å¯é€†ï¼›ç„¡äººéŠ€è¡Œæ˜¯å¸­ä½èˆ‡è¦å‰‡ï¼›Faucet å¿ƒè‡Ÿæ˜¯å›è£œç™¼è²¡é‡‘å¾ªç’°ã€‚é‚„é¡˜å‰è«‹çœ‹åœ°å€é è¦½ï¼Œé¿å…è½‰éŒ¯ã€‚";
      }
      if(s.includes("5000") || s.includes("è±ªå®…") || s.includes("å¸­ä½")) {
        return "5000 KGEN æ˜¯è±ªå®…/å¸­ä½å…¥å£çš„æ¦‚å¿µã€‚å¯¦éš›èªå®šä»¥ç„¡äººéŠ€è¡Œåˆç´„è¦å‰‡ç‚ºæº–ã€‚ä½ å¯ä»¥å…ˆé‚„é¡˜åˆ°ç„¡äººéŠ€è¡Œåœ°å€ï¼Œå¾ŒçºŒä¸Šéˆå¾Œæœƒå¯é©—è­‰ã€‚";
      }
      if(s.includes("github") || s.includes("404")) {
        return "GitHub Pages è‹¥ 404ï¼Œå¸¸è¦‹åŸå› æ˜¯è·¯å¾‘å¤§å°å¯«æˆ–æª”åä¸å°ã€‚è«‹ç¢ºèªæª”æ¡ˆåœ¨æ­£ç¢ºè³‡æ–™å¤¾ã€commit å·²å®Œæˆï¼Œä¸¦ç­‰å¾… Pages é‡æ–°éƒ¨ç½²ã€‚";
      }
      return "æˆ‘è½åˆ°äº†ã€‚ä½ å¯ä»¥å•ï¼šéŒ¢åŒ…æ€éº¼é€£ã€KGEN æ€éº¼åŠ å…¥ã€è‡ªè¨‚ä»£å¹£ã€åšæ¯æ€éº¼è§£é–ã€é‚„é¡˜ä¸‰åœ°å€å·®åˆ¥ã€‚";
    };

    const onFinalText = (text) => {
      $liveUser.value = text;
      const reply = ruleReply(text);
      $liveWukong.value = reply;
      speakText(reply);
    };

    $("btnMic").addEventListener("click", () => {
      try {
        if(!supportsRecog()) {
          toast("æ­¤ç€è¦½å™¨ä¸æ”¯æ´éº¥å…‹é¢¨è¾¨è­˜");
          return;
        }
        if(recog) {
          toast("å·²åœ¨è½"); return;
        }
        recog = buildRecog();
        let lastFinal = "";
        recog.onresult = (ev) => {
          let interim = "";
          let finalText = "";
          for (let i=ev.resultIndex; i<ev.results.length; i++) {
            const res = ev.results[i];
            const t = res[0].transcript;
            if (res.isFinal) finalText += t;
            else interim += t;
          }
          if(interim) $liveUser.value = interim;
          if(finalText && finalText.trim() && finalText !== lastFinal) {
            lastFinal = finalText;
            onFinalText(finalText.trim());
          }
        };
        recog.onerror = (e) => {
          log("Mic error: "+(e && e.error ? e.error : String(e)));
          toast("éº¥å…‹é¢¨éŒ¯èª¤æˆ–æœªæˆæ¬Š");
          try { recog.stop(); } catch {}
          recog = null;
        };
        recog.onend = () => {
          // keep state consistent
        };
        recog.start();
        toast("é–‹å§‹è½ä½ èªªè©±â€¦");
      } catch(e) {
        log("Mic start failed: "+String(e));
        toast("ç„¡æ³•å•Ÿå‹•éº¥å…‹é¢¨");
        recog = null;
      }
    });

    $("btnMicStop").addEventListener("click", () => {
      try {
        if(recog) recog.stop();
      } catch {}
      recog = null;
      toast("å·²åœæ­¢è½");
    });

    // ============ Wallet ============
    let provider=null, signer=null, userAddr=null;
    const ERC20_ABI = [
      "function balanceOf(address) view returns (uint256)",
      "function transfer(address to, uint256 amount) returns (bool)"
    ];
    const FAUCET_ABI = [
      "function igniteAndClaim() external",
      "function canClaim(address user) view returns (bool ok, string reason)"
    ];
    const fmt = (bn) => {
      try { return ethers.utils.formatUnits(bn, 18); } catch { return String(bn); }
    };

    const ensureChain = async () => {
      if(!window.ethereum) throw new Error("no_wallet");
      const wantHex = "0x" + CHAIN_ID_DEC.toString(16);
      const cur = await window.ethereum.request({ method:"eth_chainId" });
      if(cur !== wantHex) {
        await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId: wantHex }] });
      }
    };

    const renderWallet = async () => {
      if(!userAddr) {
        $walletInfo.innerHTML = `<div>æœªé€£ç·š</div><div class="muted">æç¤ºï¼šç”¨ MetaMask / éŒ¢åŒ…ç€è¦½å™¨é–‹å•Ÿã€‚</div>`;
        return;
      }
      const lines=[];
      lines.push(`<div>å·²é€£ç·šï¼š<strong class="mono addr2">${userAddr}</strong></div>`);
      try {
        const token = new ethers.Contract(KGEN_TOKEN, ERC20_ABI, provider);
        const uBal = await token.balanceOf(userAddr);
        lines.push(`<div>K G E N é¤˜é¡ï¼š<strong>${fmt(uBal)}</strong></div>`);
      } catch(e) {
        lines.push(`<div class="muted">KGEN é¤˜é¡è®€å–å¤±æ•—ï¼šè«‹ç¢ºèªåœ¨ BSC ä¸»ç¶²ã€‚</div>`);
        log("balance read error: "+String(e));
      }
      $walletInfo.innerHTML = lines.join("");
    };

    $("btnConnect").addEventListener("click", async () => {
      try {
        if(!window.ethereum) {
          toast("æ‰¾ä¸åˆ°éŒ¢åŒ…ï¼šè«‹ç”¨ MetaMask æˆ–éŒ¢åŒ…ç€è¦½å™¨æ‰“é–‹");
          speakText("æ‰¾ä¸åˆ°éŒ¢åŒ…ã€‚è«‹ç”¨ MetaMask æˆ–éŒ¢åŒ…ç€è¦½å™¨æ‰“é–‹ã€‚");
          return;
        }
        await ensureChain();
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddr = await signer.getAddress();
        toast("éŒ¢åŒ…å·²é€£ç·šï¼ˆBSC ä¸»ç¶²ï¼‰");
        speakText("éŒ¢åŒ…å·²é€£ç·šã€‚");
        await renderWallet();
        runDebugChecks();
      } catch(e) {
        log("connect error: "+String(e));
        toast("é€£ç·šå¤±æ•—æˆ–æœªæˆæ¬Š");
        speakText("é€£ç·šå¤±æ•—æˆ–æœªæˆæ¬Šã€‚");
      }
    });

    // ============ Heartbeat display (offchain timer + future onchain) ============
    const tickHeartbeat = () => {
      const now = new Date();
      const m = now.getMinutes();
      const s = now.getSeconds();
      const nextHour = new Date(now.getTime());
      nextHour.setMinutes(0,0,0);
      nextHour.setHours(now.getHours()+1);
      const ms = nextHour - now;
      const mins = Math.floor(ms/60000);
      const secs = Math.floor((ms%60000)/1000);
      const msg =
        `å¿ƒè·³ï¼šæ¯å°æ™‚æ•´é»ï¼ˆå€’æ•¸ ${mins}åˆ†${secs}ç§’ï¼‰\n`+
        `å‘¼å¸ï¼šæ¯æ—¥ 00:00ï¼ˆUTC+8ï¼‰ä»¥ã€Œå®ˆé–€äººçª—å£ã€è§¸ç™¼ï¼ˆ00:00~00:10ï¼‰\n`+
        `Faucetï¼š${FAUCET_CONTRACT? "å·²è¨­å®š" : "æœªè¨­å®š"}`;
      $heartbeatInfo.textContent = msg;
    };
    tickHeartbeat();
    setInterval(tickHeartbeat, 1000);

    // ============ Actions ============
    $("btnVisit").addEventListener("click", () => {
      const s=load(); s.visitCount++; pushLog(s,"visit"); save(s);
      renderLocal(); toast("å·²è¨˜éŒ„ï¼šç™»å…¥åƒæ‹œ");
      speakText("å·²è¨˜éŒ„åƒæ‹œã€‚");
    });

    $("btnExit").addEventListener("click", () => {
      const s=load(); s.exitCount++; pushLog(s,"exit"); save(s);
      renderLocal(); toast("å·²è¨˜éŒ„ï¼šç™»å‡ºé›¢é–‹");
      speakText("å·²è¨˜éŒ„é›¢é–‹ã€‚");
    });

    $("btnExport").addEventListener("click", () => {
      const s=load();
      downloadJSON(s, `wukong_temple_log_${new Date().toISOString().slice(0,10)}.json`);
      toast("å·²åŒ¯å‡º JSON");
    });

    $("btnClear").addEventListener("click", () => {
      localStorage.removeItem(KEY);
      renderLocal();
      toast("å·²æ¸…é™¤æœ¬æ©Ÿç´€éŒ„");
    });

    // Bobei game: 2 coins, åœ£ç­Š = 1æ­£1å
    const flip = () => Math.random()<0.5 ? "æ­£" : "å";
    const isHoly = (a,b) => (a!==b);
    $("btnBobei").addEventListener("click", () => {
      const a=flip(), b=flip();
      const holy = isHoly(a,b);
      const s=load();
      s.bobeiTries++;
      if(holy) s.bobeiWins = Math.min(3, s.bobeiWins+1);
      else s.bobeiWins = 0; // reset streak
      pushLog(s,"bobei",{a,b,holy,streak:s.bobeiWins});
      save(s);
      renderLocal();
      const msg = holy
        ? `è–ç­Šï¼ˆ${a} / ${b}ï¼‰ã€‚é€£å‹ ${s.bobeiWins} / 3ã€‚`
        : `ç¬‘ç­Šï¼ˆ${a} / ${b}ï¼‰ã€‚é€£å‹æ­¸é›¶ï¼Œé‡æ–°ä¾†ã€‚`;
      toast(msg);
      speakText(msg);
    });

    // Vow / Transfer
    $("btnVow").addEventListener("click", async () => {
      try {
        if(!signer || !userAddr) {
          toast("è«‹å…ˆé€£ç·šéŒ¢åŒ…");
          speakText("è«‹å…ˆé€£ç·šéŒ¢åŒ…ã€‚");
          return;
        }
        const targetKey = (document.querySelector('input[name="vowTarget"]:checked')||{value:"bank"}).value;
        const to = vowAddr[targetKey];
        if(!to || String(to).includes("å°šæœªè¨­å®š")) {
          toast("æ­¤åœ°å€å°šæœªè¨­å®šï¼ˆéœ€è¦éƒ¨ç½²/å¡«å…¥ Faucetï¼‰");
          speakText("æ­¤åœ°å€å°šæœªè¨­å®šã€‚è«‹å…ˆéƒ¨ç½² Faucet å¿ƒè‡Ÿåˆç´„ã€‚");
          return;
        }
        const amt = String($("inpAmount").value||"").trim();
        const n = Number(amt);
        if(!isFinite(n) || n<=0) {
          toast("è«‹è¼¸å…¥æ­£ç¢ºæ•¸é‡");
          return;
        }
        const token = new ethers.Contract(KGEN_TOKEN, ERC20_ABI, signer);
        const value = ethers.utils.parseUnits(amt, 18);
        toast("è«‹åœ¨éŒ¢åŒ…ç¢ºèªäº¤æ˜“â€¦");
        const tx = await token.transfer(to, value);
        const s=load(); s.vowCount++; pushLog(s,"vow",{to,amt,tx:tx.hash}); save(s);
        renderLocal();
        toast("å·²é€å‡ºï¼šå¯ç”¨ tx hash æŸ¥é©—");
        speakText("å·²é€å‡ºé‚„é¡˜äº¤æ˜“ã€‚");
      } catch(e) {
        log("vow error: "+String(e));
        toast("é‚„é¡˜å¤±æ•—æˆ–å–æ¶ˆ");
        speakText("é‚„é¡˜å¤±æ•—æˆ–å·²å–æ¶ˆã€‚");
      }
    });

    // Fortune: call faucet igniteAndClaim()
    $("btnFortune").addEventListener("click", async () => {
      try {
        if(!FAUCET_CONTRACT) {
          toast("Faucet å°šæœªè¨­å®š");
          return;
        }
        if(!signer || !userAddr) {
          toast("è«‹å…ˆé€£ç·šéŒ¢åŒ…");
          return;
        }
        const s=load();
        if(s.bobeiWins<3) {
          toast("éœ€è¦ä¸‰æ¬¡è–ç­Šè§£é–");
          speakText("éœ€è¦ä¸‰æ¬¡è–ç­Šè§£é–ã€‚");
          return;
        }
        const faucet = new ethers.Contract(FAUCET_CONTRACT, FAUCET_ABI, signer);
        // precheck
        try {
          const res = await faucet.canClaim(userAddr);
          if(res && res.ok===false) {
            toast("ç›®å‰ä¸å¯é ˜ï¼š"+res.reason);
          }
        } catch {}
        toast("è«‹åœ¨éŒ¢åŒ…ç¢ºèªé ˜å–â€¦");
        const tx = await faucet.igniteAndClaim();
        s.fortuneCount++; pushLog(s,"fortune",{tx:tx.hash}); save(s);
        renderLocal();
        toast("å·²é€å‡ºé ˜å–äº¤æ˜“ï¼ˆéˆä¸Šå¯é©—è­‰ï¼‰");
        speakText("å·²é€å‡ºé ˜å–äº¤æ˜“ã€‚");
      } catch(e) {
        log("fortune error: "+String(e));
        toast("é ˜å–å¤±æ•—æˆ–å–æ¶ˆ");
        speakText("é ˜å–å¤±æ•—æˆ–å·²å–æ¶ˆã€‚");
      }
    });

    // ============ Debug checks ============
    function runDebugChecks() {
      const checks = [];
      const hasEth = !!window.ethereum;
      checks.push(`<div>éŒ¢åŒ…åµæ¸¬ï¼š${hasEth ? '<span class="badge ok">Yes</span>' : '<span class="badge err">No</span>'}</div>`);
      checks.push(`<div>Faucet è¨­å®šï¼š${FAUCET_CONTRACT ? '<span class="badge ok">Yes</span>' : '<span class="badge warn">No</span>'}</div>`);
      checks.push(`<div>SpeechRecognitionï¼š${supportsRecog() ? '<span class="badge ok">Yes</span>' : '<span class="badge warn">No</span>'}</div>`);
      checks.push(`<div>TTSï¼š${("speechSynthesis" in window) ? '<span class="badge ok">Yes</span>' : '<span class="badge warn">No</span>'}</div>`);
      checks.push(`<div>é€£ç·šåœ°å€ï¼š${userAddr ? '<span class="badge ok">Yes</span>' : '<span class="badge warn">No</span>'}</div>`);
      $("debugChecks").innerHTML = checks.join("");
    }
    window.addEventListener("error", (e) => {
      log("window.error: "+(e && e.message ? e.message : String(e)));
      toast("é é¢éŒ¯èª¤ï¼šè«‹é–‹ Debug æŸ¥çœ‹");
    });
    window.addEventListener("unhandledrejection", (e) => {
      log("unhandled: "+String(e && e.reason ? e.reason : e));
      toast("Promise éŒ¯èª¤ï¼šè«‹é–‹ Debug æŸ¥çœ‹");
    });
    runDebugChecks();

  })();
  </script>
</body>
</html>
