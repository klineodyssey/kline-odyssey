<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ‚Ÿç©ºè²¡ç¥æ®¿ï½œWukong Fortune Hall</title>
  <meta name="description" content="æ‚Ÿç©ºè²¡ç¥æ®¿ï½œå¿ƒè·³ãƒ»å‘¼å¸ãƒ»ç™¼è²¡é‡‘ãƒ»ä¸ƒä»™å¥³è¨±é¡˜æ± ï½œè‡ªå‹•åŒ–å®‡å®™ç”Ÿå‘½é«”å…¥å£" />
  <style>
    :root{--b:#111;--bg:#fff;--muted:#666;--soft:#f3f3f3;--ok:#0a7;--bad:#c33;}
    *{box-sizing:border-box}
    body{margin:0;background:#fafafa;color:#111;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial,sans-serif;}
    a{color:inherit}
    .wrap{max-width:920px;margin:18px auto;padding:14px;}
    .topbar{position:sticky;top:10px;z-index:50;display:flex;justify-content:flex-end;margin:10px 0;}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;font-weight:900;text-decoration:none;border:1px solid var(--b);background:var(--bg);}
    .h1{font-weight:1000;font-size:22px;line-height:1.2;}
    .tag{margin-top:6px;font-weight:900;}
    .card{border:1px solid var(--b);border-radius:16px;background:var(--bg);padding:12px;margin:12px 0;box-shadow:0 6px 18px rgba(0,0,0,.04)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btn{cursor:pointer;padding:10px 12px;border:1px solid var(--b);border-radius:999px;background:var(--bg);font-weight:900;}
    .btn:disabled{cursor:not-allowed;background:var(--soft);opacity:.75}
    .btn.small{padding:8px 10px;font-weight:900}
    .muted{color:var(--muted)}
    .kvs{display:grid;grid-template-columns:140px 1fr;gap:6px 10px;align-items:start}
    .k{font-weight:900}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;word-break:break-all}
    .hr{height:1px;background:#eee;margin:10px 0}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}

    .zodiacGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
    @media (max-width:820px){.zodiacGrid{grid-template-columns:1fr}}
    .node{border:1px dashed #999;border-radius:14px;padding:10px;background:#fff;}
    .node h3{margin:0;font-size:16px}

    .toast{padding:10px 12px;border-radius:12px;border:1px solid #ddd;background:#fff;}
    .ok{border-color:rgba(0,160,110,.35);background:rgba(0,160,110,.06)}
    .bad{border-color:rgba(200,50,50,.35);background:rgba(200,50,50,.06)}

    .debug{position:fixed;right:10px;bottom:10px;z-index:60;width:min(520px,calc(100vw - 20px));max-height:42vh;overflow:auto;border:1px solid var(--b);border-radius:14px;background:#fff;box-shadow:0 12px 30px rgba(0,0,0,.12)}
    .debug header{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid #eee;position:sticky;top:0;background:#fff}
    .debug header .title{font-weight:1000}
    .debug pre{margin:0;padding:10px 12px;white-space:pre-wrap;word-break:break-word;font-size:12px;line-height:1.35}

    .input{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:12px;font-size:14px;}
    .select{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:12px;font-size:14px;background:#fff;}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid #ddd;background:#fff;font-weight:900;font-size:12px;}
  </style>
</head>
<body>

<div class="topbar">
  <a class="pill" href="https://klineodyssey.github.io/kline-odyssey/" target="_blank" rel="noopener">ğŸŒ Official Website</a>
</div>

<div class="wrap">

  <div>
    <div class="h1">ğŸ’ äº”æŒ‡å±±ãƒ»æ‚Ÿç©ºè²¡ç¥æ®¿ï½œWukong Fortune Hall</div>
    <div class="tag">#æ‚Ÿç©ºæ–°æ–‡ #Kç·šè¥¿éŠè¨˜ #èŠ±æœå±±å°ç£</div>
    <div style="margin-top:8px" class="muted">boot_version=<span class="mono" id="bootVer"></span></div>
  </div>

  <div class="card">
    <div class="row">
      <div style="font-weight:1000">ğŸ« å®‡å®™ç”Ÿå‘½å¾µè±¡ï½œå¿ƒè·³ãƒ»å‘¼å¸ãƒ»è¡€å£“ï¼ˆCosmic Vitalsï¼‰</div>
      <div class="badge" id="cupBadge">è–ç­Šé€£å‹ï¼š0 / 3</div>
    </div>

    <div style="margin-top:8px;line-height:1.75">
      é€™è£¡ä¸æ˜¯ä¸€èˆ¬å»Ÿã€‚æ‚Ÿç©ºå¿ƒè‡Ÿå°‡ç”± <b>Faucet åˆç´„</b> è‡ªå‹•è·³å‹•ã€‚<br/>
      äººé¡ä¸å†ç›´æ¥æŒæœ‰æ ¸å¿ƒè³‡é‡‘ï¼›æ¯æ©Ÿåªè² è²¬æ•‘æ´ï¼Œä¸æ“æœ‰ã€‚<br/>
      ä½ æ¯ä¸€æ¬¡åƒæ‹œï¼Œéƒ½æœƒè§¸ç™¼ä¸€æ¬¡ã€Œç”Ÿå‘½å¾µè±¡ã€èˆ‡ã€Œè–ç­Šã€è¨˜éŒ„ã€‚
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn" id="btnHeartbeat">â¤ï¸ å¿ƒè·³</button>
      <button class="btn" id="btnBreath">ğŸ« å‘¼å¸</button>
      <button class="btn" id="btnPressure">ğŸ©¸ è¡€å£“</button>
      <button class="btn" id="btnCup">ğŸ¥¢ æ“²ç­Š</button>
      <button class="btn" id="btnFortune" disabled>ğŸ§§ é ˜ç™¼è²¡é‡‘ï¼ˆéœ€åˆç´„ï¼‰</button>
    </div>

    <div id="vitalsOut" style="margin-top:10px"></div>
    <div class="muted" style="margin-top:8px;line-height:1.65">
      è¦å‰‡ï¼šè–ç­Šæ©Ÿç‡ 50%ã€‚å¤±æ•—é€£å‹æ­¸é›¶ã€‚é€£å‹é” 3 æ‰è§£é–ã€Œé ˜ç™¼è²¡é‡‘ã€ã€‚<br/>
      ç™¼è²¡é‡‘è¦å‰‡ï¼ˆé è¨­ï¼‰ï¼šæ¯æœˆæœ€å¤š <b>500 å</b>ï¼Œæ¯åæœ€é«˜ <b>888 KGEN</b>ï¼ˆçœŸæ­£ç™¼æ”¾ä»¥ Faucet åˆç´„åƒæ•¸ç‚ºæº–ï¼‰ã€‚
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div style="font-weight:1000">ğŸªª éŒ¢åŒ…ç‹€æ…‹ï¼ˆBSC ä¸»ç¶²ï¼‰</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn" id="btnConnect">é€£ç·šéŒ¢åŒ…</button>
        <button class="btn" id="btnDisconnect">æ–·é–‹</button>
        <button class="btn" id="btnExport">åŒ¯å‡ºç‹€æ…‹ JSON</button>
      </div>
    </div>

    <div class="hr"></div>

    <div class="kvs">
      <div class="k">Wallet</div>
      <div class="mono" id="walletAddr">(not connected)</div>

      <div class="k">Chain</div>
      <div class="mono" id="chainInfo">(unknown)</div>

      <div class="k">Faucet Contract</div>
      <div class="mono" id="faucetAddr">(to be set after deploy)</div>

      <div class="k">KUFO Bank Contract</div>
      <div class="mono" id="kufoAddr">(to be set after deploy)</div>

      <div class="k">Public Good Treasury</div>
      <div class="mono" id="treasuryAddr">0xB73D6716005B37BEC742D64482fA26033eE1A4E1</div>
    </div>

    <div class="muted" style="margin-top:10px;line-height:1.6">
      è‹¥ä½ å°šæœªéƒ¨ç½² Faucet / KUFOï¼Œè«‹å…ˆæŠŠåˆç´„åœ°å€è²¼åˆ°ã€Œè¨­å®šé¢æ¿ã€ã€‚åœ°å€ä¸€æ—¦ä¸Šéˆå°±ä¸å¯è®Šæ›´ï¼ˆé™¤éå‡ç‰ˆå†éƒ¨ç½²æ–°å™¨å®˜ï¼‰ã€‚
    </div>

    <div class="hr"></div>

    <div class="grid">
      <div>
        <div style="font-weight:1000;margin-bottom:6px">âš™ï¸ è¨­å®šé¢æ¿ï¼ˆæœ¬æ©Ÿå„²å­˜ï¼Œä¸ä¸Šéˆï¼‰</div>
        <div class="muted" style="margin-bottom:8px">ç”¨ä¾†æŠŠã€Œå·²éƒ¨ç½²åˆç´„åœ°å€ã€æ¥åˆ°ç¥æ®¿æŒ‰éµï¼Œä¸æœƒæ”¹è®Šéˆä¸Šæ¬Šé™ã€‚</div>

        <label class="muted">Faucet åˆç´„åœ°å€</label>
        <input id="inFaucet" class="input mono" placeholder="0x..." />

        <div style="height:8px"></div>
        <label class="muted">KUFO ç„¡äººéŠ€è¡Œåˆç´„åœ°å€</label>
        <input id="inKUFO" class="input mono" placeholder="0x..." />

        <div style="height:8px"></div>
        <label class="muted">ç™¼è²¡é‡‘å›æ”¶åœ°å€ #1ï¼ˆé¸å¡«ï¼‰</label>
        <input id="inRecycle1" class="input mono" placeholder="0x..." />

        <div style="height:8px"></div>
        <label class="muted">ç™¼è²¡é‡‘å›æ”¶åœ°å€ #2ï¼ˆé¸å¡«ï¼‰</label>
        <input id="inRecycle2" class="input mono" placeholder="0x..." />

        <div style="height:8px"></div>
        <label class="muted">ç™¼è²¡é‡‘å›æ”¶åœ°å€ #3ï¼ˆé¸å¡«ï¼‰</label>
        <input id="inRecycle3" class="input mono" placeholder="0x..." />



        <div style="height:8px"></div>
        <label class="muted">ç™¼è²¡é‡‘å›æ”¶åœ°å€ #1ï¼ˆé¸å¡«ï¼‰</label>
        <input id="inRecycle1" class="input mono" placeholder="0x..." />

        <div style="height:8px"></div>
        <label class="muted">ç™¼è²¡é‡‘å›æ”¶åœ°å€ #2ï¼ˆé¸å¡«ï¼‰</label>
        <input id="inRecycle2" class="input mono" placeholder="0x..." />

        <div style="height:8px"></div>
        <label class="muted">ç™¼è²¡é‡‘å›æ”¶åœ°å€ #3ï¼ˆé¸å¡«ï¼‰</label>
        <input id="inRecycle3" class="input mono" placeholder="0x..." />

        <div style="height:8px"></div>
        <button class="btn" id="btnSaveCfg">ä¿å­˜</button>
        <button class="btn" id="btnClearCfg">æ¸…é™¤</button>
      </div>

      <div>
        <div style="font-weight:1000;margin-bottom:6px">ğŸ§ å½±åƒèªéŸ³å®¢æœï¼ˆæœ¬æ©Ÿï¼‰</div>
        <div class="muted" style="margin-bottom:8px">ä½ çš„ç’°å¢ƒé¡¯ç¤º speechSynthesis=falseï¼ˆWebView å¯èƒ½ä¸æ”¯æ´ TTSï¼‰ã€‚æˆ‘å€‘ä»æä¾›æ–‡å­—å®¢æœï¼‹èªéŸ³è¼¸å…¥ï¼ˆè‹¥å…è¨±ï¼‰ã€‚</div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn" id="btnAssistant">â–¶ï¸ å•Ÿå‹•å®¢æœ</button>
          <button class="btn" id="btnSTT">ğŸ™ï¸ èªéŸ³è¼¸å…¥</button>
          <button class="btn" id="btnStopSTT">â¹ï¸ åœæ­¢</button>
        </div>

        <div style="margin-top:10px" class="toast" id="assistantBox">
          <div style="font-weight:1000">æ‚Ÿç©ºå®¢æœ</div>
          <div id="assistantText" style="margin-top:6px;line-height:1.65" class="muted">æŒ‰ã€Œå•Ÿå‹•å®¢æœã€æœƒé¡¯ç¤ºè¦å‰‡è§£èªªã€‚ä½ ä¹Ÿå¯ä»¥ç”¨èªéŸ³è¼¸å…¥å•å•é¡Œï¼ˆè‹¥è£ç½®æ”¯æ´ï¼‰ã€‚</div>
        </div>
      </div>
    </div>

  </div>

  <div class="card">
    <div class="row">
      <div style="font-weight:1000">âœ¨ ä¸ƒä»™å¥³æ˜Ÿåº§ç›¤ï½œä¸ƒæ˜Ÿå®ˆè­·ï¼ˆSeven Fairies Constellationï¼‰</div>
      <button class="btn small" id="btnLoadFairies">è¼‰å…¥åˆ°è¨±é¡˜æ± </button>
    </div>

    <div class="muted" style="margin-top:8px;line-height:1.65">
      é€™æ˜¯æ‚Ÿç©ºè²¡ç¥æ®¿çš„ã€Œç¥ˆé¡˜è·¯ç”±ã€ã€‚æ¯ä½ä»™å¥³å°æ‡‰ä¸€å€‹åº§æ¨™é»ï¼Œä¸¦æœ‰å„è‡ªçš„å®ˆè­·è·è²¬èˆ‡å¤šç©ºæ°£è„ˆã€‚
      <b>æ–°å¢ï¼šä¸ƒä»™å¥³è¨±é¡˜æ± </b>ï¼ˆä¸‹æ–¹ï¼‰â€”â€” è®“é¦™å®¢èƒ½é¸æ“‡å®ˆè­·ä»™å¥³ã€å¯«ä¸‹é¡˜æœ›ã€ç•™ä¸‹èª“è¨€ã€‚
    </div>

    <div class="zodiacGrid" style="margin-top:10px" id="fairyGrid"></div>
  </div>

  <div class="card">
    <div class="row">
      <div style="font-weight:1000">ğŸ’§ ä¸ƒä»™å¥³è¨±é¡˜æ± ï¼ˆWish Poolï¼‰</div>
      <div class="badge" id="wishCount">ä»Šæ—¥è¨±é¡˜ï¼š0</div>
    </div>

    <div class="muted" style="margin-top:8px;line-height:1.65">
      è¦å‰‡ï¼ˆç¥æ®¿ç‰ˆï¼‰ï¼šè¨±é¡˜ä¸ç­‰æ–¼ä¿è­‰ï¼›ç™¼è²¡é‡‘æ˜¯ã€Œå€Ÿä½ å»åšç”Ÿæ„ã€çš„ç¦®ç‰©ï¼Œä¸æ˜¯å¼·ç´¢å›æ”¶ã€‚<br/>
      ä½ å¯è‡ªè¡Œé¸æ“‡æ˜¯å¦ã€Œé‚„é¡˜ã€ã€‚è‹¥ä½ é¡˜æ„ä½é€²èŠ±æœå±±ç«æ˜Ÿé½Šå¤©è±ªå®…ï¼Œéœ€å®Œæˆ <b>5000 KGEN é‚„é¡˜</b>ï¼ˆä»¥ KUFO ç„¡äººéŠ€è¡Œè¦å‰‡ç‚ºæº–ï¼‰ã€‚
    </div>

    <div class="grid" style="margin-top:10px">
      <div>
        <label class="muted">é¸æ“‡å®ˆè­·ä»™å¥³</label>
        <select id="wishFairy" class="select"></select>

        <div style="height:8px"></div>
        <label class="muted">é¡˜æœ›å…§å®¹ï¼ˆä¸è¦ç•™å€‹è³‡ï¼‰</label>
        <textarea id="wishText" class="input" rows="5" placeholder="ä¾‹å¦‚ï¼šæ±‚äº‹æ¥­é‹é€šã€å®¶åº­ç¾æ»¿ã€èº«é«”å¥åº·â€¦"></textarea>

        <div style="height:8px"></div>
        <label class="muted">èª“è¨€ï¼ˆé¸å¡«ï¼‰</label>
        <input id="wishVow" class="input" placeholder="ä¾‹å¦‚ï¼šè‹¥æˆï¼Œå°‡å›æ®¿é‚„é¡˜ã€‚" />

        <div style="height:10px"></div>
        <button class="btn" id="btnWish">æŠ•ä¸‹è¨±é¡˜</button>
        <button class="btn" id="btnWishExport">åŒ¯å‡ºè¨±é¡˜ JSON</button>
      </div>

      <div>
        <div class="toast" id="wishBox">
          <div style="font-weight:1000">è¨±é¡˜å›éŸ¿</div>
          <div id="wishOut" style="margin-top:6px;line-height:1.65" class="muted">é¸å¥½ä»™å¥³ï¼Œå¯«ä¸‹é¡˜æœ›ï¼ŒæŒ‰ä¸‹ã€ŒæŠ•ä¸‹è¨±é¡˜ã€ã€‚</div>
        </div>

        <div style="margin-top:10px" class="toast">
          <div style="font-weight:1000">è±ªå®… 500 å¸­ï¼ˆæ¦‚å¿µï¼‰</div>
          <div class="muted" style="margin-top:6px;line-height:1.65">
            ä½é€²ã€ŒèŠ±æœå±±ç«æ˜Ÿé½Šå¤©è±ªå®…ã€ï¼šä»¥ <b>5000 KGEN</b> é‚„é¡˜ä½œç‚ºå¸­ä½é–€æª»ã€‚<br/>
            æ˜¯å¦ç¶ã€Œé ˜éç™¼è²¡é‡‘åœ°å€ã€ï¼šäº¤ç”± KUFO åˆç´„è¦å‰‡æ±ºå®šï¼ˆä¸Šéˆå¾Œä¸å¯è‡¨æ™‚æ”¹å£ï¼‰ã€‚
          </div>
        </div>
      </div>
    </div>

  </div>

<!-- =========================
ğŸ•¯ï¸ Zodiac Lamps + Free Species Registry (Local / Future On-chain)
========================= -->
<section class="card" id="zodiacLampsCard">
  <h2>ğŸ•¯ï¸ 12 ç”Ÿè‚–å…‰æ˜ç‡ˆ Ã— ç¬¬13è‚–è‡ªç”±ç‰©ç¨®ï¼ˆPrototypeï¼‰</h2>
  <p class="muted">
    é€™ä¸€å€æ˜¯ã€Œé»ç‡ˆç™»è¨˜ã€çš„æ¨™æº–åŒ–æ¨¡æ¿ï¼šå…ˆç”¨æœ¬æ©Ÿå„²å­˜åšå¯å†ç¾åŸå‹ï¼Œç­‰åˆç´„éƒ¨ç½²å¾Œå†æŠŠæŒ‰éµæ¥ä¸Šéˆä¸Š mint / renewã€‚
    <br/>è¦å‰‡ï¼ˆé è¨­ï¼‰ï¼š12 ç”Ÿè‚–æ¯ç”Ÿè‚– <b>72</b> å¸­ï¼›ç¬¬13è‚–ï¼ˆè‡ªç”±ç‰©ç¨®ï¼‰<b>108</b> å¸­ã€‚æ¯ç­†ç™»è¨˜ç‚ºã€Œä¸€å¹´æœŸã€ï¼ˆå¯çºŒï¼‰ã€‚
  </p>

  <div class="grid2">
    <div class="box">
      <h3>ğŸ§¾ åˆç´„ï¼ˆå¯é¸ï¼‰</h3>
      <div class="row">
        <label>ğŸ•¯ï¸ Lamp Contractï¼ˆå¯ç•™ç©ºï¼‰</label>
        <input id="inLamp" type="text" placeholder="0x...ï¼ˆéƒ¨ç½²å¾Œè²¼ä¸Šï¼‰" />
        <div class="btnRow">
          <button class="btn small" id="btnLampSave">ä¿å­˜</button>
          <button class="btn small ghost" id="btnLampClear">æ¸…é™¤</button>
        </div>
        <p class="hint">æ­¤æ¬„ä½åƒ…å½±éŸ¿ã€Œä¸Šéˆé»ç‡ˆã€æŒ‰éµæ˜¯å¦å•Ÿç”¨ï¼Œä¸æ”¹è®Šéˆä¸Šæ¬Šé™ã€‚</p>
      </div>
    </div>

    <div class="box">
      <h3>ğŸ“Š åé¡ç‹€æ…‹</h3>
      <div class="kv">
        <div><b>å¹´åº¦</b></div><div><span id="lampYear"></span></div>
        <div><b>12ç”Ÿè‚–å‰©é¤˜ç¸½å¸­</b></div><div><span id="lampRemain12"></span></div>
        <div><b>è‡ªç”±ç‰©ç¨®å‰©é¤˜å¸­</b></div><div><span id="lampRemainFree"></span></div>
      </div>
      <div class="btnRow">
        <button class="btn small" id="btnLampResetYear">æ–°å¹´åº¦é‡ç½®ï¼ˆæœ¬æ©Ÿï¼‰</button>
        <button class="btn small ghost" id="btnLampExport">åŒ¯å‡ºç™»è¨˜ JSON</button>
      </div>
      <p class="hint">æœ¬æ©Ÿç‰ˆæœ¬ä¸æ”¶è²»ï¼›ã€Œé»ç‡ˆè¦ç”¨é›»è¦æ”¶éŒ¢ã€æœƒåœ¨åˆç´„ç‰ˆé€é mint/renew è²»ç”¨è™•ç†ã€‚</p>
    </div>
  </div>

  <div class="box">
    <h3>ğŸ§¬ é»ç‡ˆç™»è¨˜</h3>
    <div class="grid3">
      <div class="row">
        <label>é¸æ“‡é¡å‹</label>
        <select id="lampType">
          <option value="zodiac">12ç”Ÿè‚–ï¼ˆå›ºå®šï¼‰</option>
          <option value="free">ç¬¬13è‚–ãƒ»è‡ªç”±ç‰©ç¨®ï¼ˆè‡ªå®šï¼‰</option>
        </select>
      </div>
      <div class="row">
        <label>ç”Ÿè‚– / é¡åˆ¥</label>
        <select id="lampZodiac"></select>
      </div>
      <div class="row">
        <label>å¸­ä½ï¼ˆSlotï¼‰</label>
        <div class="inline">
          <input id="lampSlot" type="number" min="1" step="1" placeholder="ç•™ç©º=è‡ªå‹•é…ä½" />
          <button class="btn small ghost" id="btnLampAutoSlot">è‡ªå‹•é…ä½</button>
        </div>
      </div>

      <div class="row">
        <label>åå­—ï¼ˆå¯ç”¨æš±ç¨±ï¼‰</label>
        <input id="lampName" type="text" placeholder="ä¾‹å¦‚ï¼šå·§é›² / é˜¿æ–— / æ—…äºº001" />
      </div>
      <div class="row">
        <label>ç‰©ç¨®ï¼ˆè‡ªç”±ç‰©ç¨®æ‰éœ€å¡«ï¼‰</label>
        <input id="lampSpecies" type="text" placeholder="ä¾‹å¦‚ï¼šèŸ‘è‚ã€èèŸ»ã€è®Šå½¢é‡‘å‰›ã€å¤§è±¡ã€å¤–æ˜Ÿäººã€è¶…äººã€èŸ»äººã€æ‚Ÿç©ºçŒ´æ¯›â€¦" />
      </div>
      <div class="row">
        <label>Pulsar å¿ƒç‡ï¼ˆæ¯å°æ™‚è„ˆè¡ï¼‰</label>
        <input id="lampPulsar" type="number" min="1" step="1" value="72" />
      </div>

      <div class="row">
        <label>é¡˜æœ› / ä½¿å‘½ï¼ˆä¸è¦ç•™å€‹è³‡ï¼‰</label>
        <input id="lampWish" type="text" placeholder="ä¾‹å¦‚ï¼šå¹³å®‰ã€å¥åº·ã€äº‹æ¥­é‹é€šã€å›åˆ°éå»èˆ‡æœªä¾†â€¦" />
      </div>
      <div class="row">
        <label>KUFO æ—…ç¥¨ï¼ˆå¯é¸ï¼‰</label>
        <select id="lampKUFO">
          <option value="0">ä¸æ­ä¹˜</option>
          <option value="1">æ­ä¹˜ KUFOï¼ˆè¶…å…‰é€Ÿå£è¢‹å‹æ™‚å…‰éš±å‹é£›ç¢Ÿï¼‰</option>
        </select>
      </div>
      <div class="row">
        <label>æœŸé™</label>
        <select id="lampTerm">
          <option value="1y">ä¸€å¹´æœŸ</option>
          <option value="5y">äº”å¹´æœŸï¼ˆæ¦‚å¿µï¼‰</option>
          <option value="500y">äº”ç™¾å¹´ï¼ˆäº”æŒ‡å±±æ¨¡å¼ãƒ»æ¦‚å¿µï¼‰</option>
        </select>
      </div>
    </div>

    <div class="btnRow">
      <button class="btn" id="btnLampRegister">é»äº®å…‰æ˜ç‡ˆï¼ˆæœ¬æ©Ÿæ¸¬è©¦ï¼‰</button>
      <button class="btn ghost" id="btnLampOnchain" disabled>ä¸Šéˆé»ç‡ˆï¼ˆéœ€è¦åˆç´„ï¼‹éŒ¢åŒ…ï¼‰</button>
      <button class="btn ghost" id="btnLampLookup">æŸ¥è©¢å¸­ä½</button>
      <button class="btn danger ghost" id="btnLampClearLocal">æ¸…é™¤æœ¬æ©Ÿç™»è¨˜</button>
    </div>

    <div class="box inner">
      <h4>ğŸ“œ ç™»è¨˜å›é¥‹</h4>
      <pre id="lampEcho" class="pre">å°šæœªé»ç‡ˆã€‚</pre>
    </div>

    <div class="box inner">
      <h4>ğŸ—ºï¸ å·²é»äº®æ¸…å–®ï¼ˆæœ¬æ©Ÿï¼‰</h4>
      <div class="muted" id="lampListHint">é¸æ“‡é¡å‹/ç”Ÿè‚–å¾ŒæŒ‰ã€ŒæŸ¥è©¢å¸­ä½ã€æˆ–é»ç‡ˆå¾Œæœƒè‡ªå‹•åˆ·æ–°ã€‚</div>
      <div id="lampList" class="tableWrap"></div>
    </div>
  </div>
</section>



  <div class="card">
    <div style="font-weight:1000">
  <section class="section">
    <div class="card">
      <div class="h1">ğŸ§¬ å®‡å®™ç´°åŒ…ï¼ˆMicrocellï¼‰ï½œå•†åº—ç´…åˆ©å›è·¯</div>
      <div class="muted">
        ä½ å¯ä»¥æŠŠã€Œäººé¡å•†åº—ã€æ¥é€² KGENï¼šé¡§å®¢æ¶ˆè²»â†’ç²å¾— KGEN ç´…åˆ©ï¼›å•†å®¶å®šæœŸç¹³æ¬¾â†’ç”± KUFO/å›æ”¶åœ°å€å½¢æˆå›è·¯ï¼›å›è·¯å®Œæˆå¾Œå¯è§¸ç™¼ã€Œç”Ÿå‘½èª•ç”Ÿã€ã€‚
        ç›®å‰æ­¤å€ç‚º <b>æœ¬æ©ŸåŸå‹</b>ï¼šåªè¨˜éŒ„ã€ä¸ä¸Šéˆã€‚ä¸Šéˆå¾Œç”± KUFO/Tax Router æ¥ç®¡çµç®—ã€‚
      </div>

      <div style="height:10px"></div>
      <div class="grid2">
        <div>
          <label class="muted">ç´°åŒ…åç¨±ï¼ˆå•†åº—åï¼‰</label>
          <input id="mc_name" class="input" placeholder="ä¾‹å¦‚ï¼šæ‚Ÿç©ºçŒ´æ¯›æœé£¾åº—" />
        </div>
        <div>
          <label class="muted">é¡åˆ¥ï¼ˆå¯è‡ªè¨‚ï¼‰</label>
          <input id="mc_category" class="input" placeholder="ä¾‹å¦‚ï¼šæœé£¾ / é¤é£² / å¿ƒè‡Ÿå·¥åŠ / å¤–æ˜Ÿç§‘æŠ€" />
        </div>
        <div>
          <label class="muted">ç‰©ç¨®ï¼ˆç¬¬13ç”Ÿè‚–ï¼Œå¯è‡ªè¨‚ï¼‰</label>
          <input id="mc_species" class="input" placeholder="ä¾‹å¦‚ï¼šè®Šå‹é‡‘é‹¼ / å¤§è±¡ / èŸ‘è‚ / çŒ¿äºº / æ–°äººé¡ / ç„¡æ©Ÿç”Ÿå‘½" />
        </div>
        <div>
          <label class="muted">åº§æ¨™ï¼ˆå‡ºç”Ÿåœ° / åœ°é»ï¼Œå¯è‡ªè¨‚ï¼‰</label>
          <input id="mc_location" class="input mono" placeholder="ä¾‹å¦‚ï¼š11520 / 8888 / 18888 / ä½ è‡ªè¨‚" />
        </div>
        <div>
          <label class="muted">ç´…åˆ©æ¯”ä¾‹ï¼ˆbpsï¼Œ100=1%ï¼‰</label>
          <input id="mc_reward_bps" class="input mono" placeholder="ä¾‹å¦‚ï¼š88" />
        </div>
        <div>
          <label class="muted">ç¹³æ¬¾è·¯ç”±ï¼ˆå›æ”¶åœ°å€ï¼‰</label>
          <select id="mc_route" class="input">
            <option value="KUFO">KUFO ç„¡äººéŠ€è¡Œ</option>
            <option value="PG">å…¬ç›Šé‡‘åº«ï¼ˆPublic Good Treasuryï¼‰</option>
            <option value="R1">å›æ”¶åœ°å€ #1</option>
            <option value="R2">å›æ”¶åœ°å€ #2</option>
            <option value="R3">å›æ”¶åœ°å€ #3</option>
          </select>
        </div>
      </div>

      <div style="height:10px"></div>
      <button class="btn" id="btnMcCreate">å»ºç«‹ç´°åŒ…</button>
      <button class="btn ghost" id="btnMcExport">åŒ¯å‡ºç´°åŒ… JSON</button>
      <button class="btn ghost" id="btnMcClear">æ¸…é™¤ç´°åŒ…</button>

      <div style="height:10px"></div>
      <div class="mono small" id="mc_stats">ç´°åŒ…ï¼š0</div>
      <div class="mono small" id="mc_list"></div>
    </div>

    <div class="card">
      <div class="h1">ğŸ­ ç”Ÿå‘½å·¥å» ï¼ˆLife Factoryï¼‰ï½œç”Ÿå‘½èª•ç”Ÿï¼ˆæ¦‚å¿µï¼‰</div>
      <div class="muted">
        ç•¶ä½ å®Œæˆï¼šé»å…‰æ˜ç‡ˆ / ä¸ƒä»™å¥³è¨±é¡˜ / è–ç­Šè§£é–ç™¼è²¡é‡‘ / ç´°åŒ…å›è·¯ï¼ˆå¯é¸ï¼‰â€”â€” å°±èƒ½åœ¨ã€Œç”Ÿå‘½å·¥å» ã€ç”Ÿæˆä¸€å€‹å®‡å®™ç”Ÿå‘½é«”çš„å‡ºç”Ÿè­‰æ˜ã€‚
        ç›®å‰ç‚ºæœ¬æ©Ÿ JSONï¼Œæœªä¸Šéˆï¼›æœªä¾†ä¸Šéˆå¾Œå¯ç”± KUFO é‘„é€ ã€Œç”Ÿå‘½è­‰ã€æˆ–é–‹å•Ÿå™¨å®˜åˆç´„ã€‚
      </div>

      <div style="height:10px"></div>
      <div class="grid2">
        <div>
          <label class="muted">ç”Ÿå‘½åç¨±</label>
          <input id="lf_name" class="input" placeholder="ä¾‹å¦‚ï¼šè±¬å…«æˆ’ / èœ˜è››æ©Ÿ / ä½ çš„è¶…å…‰é€Ÿé£›ç¢Ÿæ©Ÿ" />
        </div>
        <div>
          <label class="muted">ç”Ÿå‘½ç‰©ç¨®ï¼ˆä»»æ„ï¼‰</label>
          <input id="lf_species" class="input" placeholder="ä¾‹å¦‚ï¼šè±¬ / çŒ´æ¯› / è®Šå‹é‡‘é‹¼ / èŸ»äºº / å¤–æ˜Ÿäºº" />
        </div>
        <div>
          <label class="muted">å‡ºç”Ÿåœ°ï¼ˆåœ°åœ–åº§æ¨™ï¼‰</label>
          <select id="lf_birthplace" class="input">
            <option value="11520">11520ï½œèŠ±æœå±±å°ç£</option>
            <option value="8888">8888ï½œé«˜è€èŠ</option>
            <option value="18888">18888ï½œå‡Œéœ„å¯¶æ®¿</option>
            <option value="511111">511111ï½œé½Šå¤©å¤§è–å®®</option>
            <option value="custom">è‡ªè¨‚</option>
          </select>
        </div>
        <div>
          <label class="muted">è‡ªè¨‚å‡ºç”Ÿåœ°ï¼ˆé¸å¡«ï¼‰</label>
          <input id="lf_birthplace_custom" class="input mono" placeholder="ä¾‹å¦‚ï¼šä½ è‡ªè¨‚åº§æ¨™" />
        </div>
        <div>
          <label class="muted">Pulsar å¿ƒè·³é »ç‡ï¼ˆHzï¼Œå¯è‡ªè¨‚ï¼‰</label>
          <input id="lf_pulsar_hz" class="input mono" placeholder="ä¾‹å¦‚ï¼š1.388 / 11.5 / ä½ è‡ªè¨‚" />
        </div>
        <div>
          <label class="muted">æ™‚å…‰è¼‰å…·ï¼ˆé¸å¡«ï¼‰</label>
          <input id="lf_ship" class="input" placeholder="ä¾‹å¦‚ï¼šè¶…å…‰é€Ÿå£è¢‹å‹æ™‚å…‰éš±å½¢é£›ç¢Ÿæ©Ÿ" />
        </div>
      </div>

      <div style="height:10px"></div>
      <button class="btn" id="btnLfCheck">æª¢æŸ¥èª•ç”Ÿæ¢ä»¶</button>
      <button class="btn" id="btnLfBirth">ç”Ÿæˆç”Ÿå‘½è›‹ JSON</button>
      <button class="btn ghost" id="btnLfExport">åŒ¯å‡ºç”Ÿå‘½å·¥å»  JSON</button>

      <div style="height:10px"></div>
      <div class="mono small" id="lf_status">ç‹€æ…‹ï¼šæœªæª¢æŸ¥</div>
      <div class="mono small" id="lf_echo">ï¼ˆé€™è£¡æœƒå›å ±èª•ç”Ÿæ¢ä»¶ï¼‰</div>
    </div>
  </section>

ğŸ“œ å“ç‰Œå›ºå®šå°¾æ®µ</div>
    <div style="margin-top:8px;line-height:1.75">
      PrimeForge ä»¥æ¯æ©Ÿä¹‹åï¼Œé–‹å•Ÿé‡‘èç”Ÿå‘½ã€‚<br/>
      èŠ±æœå±±å°ç£ãƒ»ä¿¡å¿µä¸æ»…ãƒ»å¸‚å ´ç„¡ç•Œã€‚<br/>
      Where the Market Becomes the Myth.<br/>
      â€”â€” æ¨‚å¤©å¸ âŒ–
    </div>
  </div>

</div>


<!-- Sound Settings -->
<div class="card">
  <h3>ğŸ”Š è²éŸ³ï¼ˆTTS / å®ï¼‰</h3>
  <div class="row">
    <label class="lbl">æ¨¡å¼</label>
    <select id="soundMode" class="input" style="max-width:260px">
      <option value="auto" selected>Autoï¼ˆæœ‰ TTS ç”¨ TTSï¼Œå¦å‰‡å®ï¼‰</option>
      <option value="tts">TTSï¼ˆéœ€è¦è£ç½®æ”¯æ´ï¼‰</option>
      <option value="beep">å®ï¼ˆWebAudioï¼‰</option>
      <option value="off">é—œé–‰</option>
    </select>
    <button class="btn" id="btnTestSound" style="margin-left:8px">æ¸¬è©¦</button>
  </div>
  <div class="muted" style="margin-top:6px;line-height:1.6">
    ä½ çš„ MetaMask WebView å¸¸æœƒé¡¯ç¤º <code>speechSynthesis=false</code>ï¼Œé€™æ™‚æœƒè‡ªå‹•æ”¹ç”¨ã€Œå®ã€è²ã€‚è‹¥è¦çœŸäººèªéŸ³ï¼Œå¯æ”¹ç”¨ Chrome é–‹å•Ÿï¼ˆä½†å¯èƒ½å¤±å»éŒ¢åŒ…æ³¨å…¥ï¼‰ã€‚
  </div>
</div>

<!-- Debug Panel -->
<div class="debug" id="debug" style="display:block">
  <header>
    <div class="title">Debug Console</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn small" id="btnSelfcheck">Selfcheck</button>
      <button class="btn small" id="btnClearLog">Clear</button>
      <button class="btn small" id="btnHideDbg">Hide</button>
    </div>
  </header>
  <pre id="log"></pre>
</div>

<script>
(function(){
  // ===== Version =====
  const BOOT_VERSION = "v2.9.0-lamps-v1";
  document.getElementById('bootVer').textContent = BOOT_VERSION;

  // ===== Debug =====
  const logEl = document.getElementById('log');
  function nowISO(){ try{return new Date().toISOString();}catch(e){return ''} }
  function log(msg){
    const line = `[${nowISO()}] ${msg}`;
    console.log(line);
    logEl.textContent = (logEl.textContent ? (logEl.textContent + "\n") : "") + line;
    // keep last ~400 lines
    const lines = logEl.textContent.split(/\n/);
    if(lines.length>450) logEl.textContent = lines.slice(lines.length-450).join("\n");
  }
  window.__WK_LOG__ = log;

  // ===== Errors Hook =====
  function hookGlobalErrors(){
    if (window.__wukongErrorsHooked) return;
    window.__wukongErrorsHooked = true;
    window.addEventListener('error', function(ev){
      try{
        const msg = ev && ev.message ? ev.message : 'Unknown error';
        const src = ev && ev.filename ? ev.filename : '';
        const ln = ev && ev.lineno ? ev.lineno : '';
        const col = ev && ev.colno ? ev.colno : '';
        log(`ERROR: ${msg}${src?(' @ '+src+':'+ln+':'+col):''}`);
      }catch(e){}
    });
    window.addEventListener('unhandledrejection', function(ev){
      try{
        const r = ev && ev.reason ? (ev.reason.message || String(ev.reason)) : 'Unknown rejection';
        log('PROMISE_REJECT: ' + r);
      }catch(e){}
    });
  }

  
  // ===== Sound Engine (TTS / Ding) =====
  // Modes: 'auto' | 'tts' | 'ding' | 'off'
  const SOUND_KEY = 'wukong_sound_mode_v1';
  let _soundMode = (localStorage.getItem(SOUND_KEY) || 'auto').toLowerCase();
  let _audioCtx = null;

  function getSoundMode(){ return _soundMode; }
  function setSoundMode(m){
    _soundMode = (String(m||'auto')).toLowerCase();
    localStorage.setItem(SOUND_KEY, _soundMode);
    log('sound_mode=' + _soundMode);
  }

  function _canTTS(){
    try { return !!(window.speechSynthesis && typeof SpeechSynthesisUtterance !== 'undefined'); }
    catch(e){ return false; }
  }

  function _speakTTS(text){
    if(!_canTTS()) return false;
    try{
      // cancel any pending speech to keep it snappy
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(String(text||''));
      u.lang = 'zh-TW';
      u.rate = 1.0;
      u.pitch = 1.0;
      u.volume = 1.0;
      window.speechSynthesis.speak(u);
      return true;
    }catch(e){
      log('tts_failed: ' + (e && e.message ? e.message : String(e)));
      return false;
    }
  }

  function _beep(){
    try{
      const AC = window.AudioContext || window.webkitAudioContext;
      if(!AC) return false;
      if(!_audioCtx) _audioCtx = new AC();
      // On mobile, audio may be suspended until user gesture.
      if(_audioCtx.state === 'suspended') _audioCtx.resume().catch(()=>{});
      const osc = _audioCtx.createOscillator();
      const gain = _audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.value = 880;
      gain.gain.value = 0.0001;
      osc.connect(gain);
      gain.connect(_audioCtx.destination);
      const now = _audioCtx.currentTime;
      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.2, now + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.20);
      osc.start(now);
      osc.stop(now + 0.22);
      return true;
    }catch(e){
      log('ding_failed: ' + (e && e.message ? e.message : String(e)));
      return false;
    }
  }

  // Public: safe sound helper for all UI events
  function wukongSound(text){
    const mode = getSoundMode();
    if(mode === 'off'){ log('sound_off'); return; }

    // auto: prefer TTS if available, else ding
    if(mode === 'auto'){
      const ok = _speakTTS(text || 'å®');
      if(!ok) _beep();
      return;
    }
    if(mode === 'tts'){ _speakTTS(text || ''); return; }
    if(mode === 'ding'){ _beep(); return; }

    // fallback
    const ok = _speakTTS(text || 'å®');
    if(!ok) _beep();
  }

  // Bind sound controls if present in DOM
  function bindSoundUI(){
    const sel = document.getElementById('soundMode');
    const btn = document.getElementById('btnTestSound');
    if(sel){
      try{ sel.value = getSoundMode(); }catch(e){}
      sel.addEventListener('change', ()=> setSoundMode(sel.value));
    }
    if(btn){
      btn.addEventListener('click', ()=>{
        // a user gesture here unlocks audio on mobile
        wukongSound('æ‚Ÿç©ºåœ¨è½');
        log('sound_test');
      });
    }
  }
// ===== Selfcheck =====
  function selfCheck(){
    hookGlobalErrors();
    log('selfcheck_start');
    log('userAgent: ' + (navigator.userAgent || '(none)'));
    log('speechSynthesis: ' + ('speechSynthesis' in window));
    log('speechRecognition: ' + (!!(window.SpeechRecognition || window.webkitSpeechRecognition)));
    log('ethers_loaded: ' + (typeof window.ethers !== 'undefined'));
    log('ethereum_injected: ' + (typeof window.ethereum !== 'undefined'));
  
    // Re-check late injections (MetaMask WebView)
    ensureEthers().then(()=>ensureEthereum()).then(()=>{
      try{
        log("ethers_loaded_now: " + (!!window.ethers));
        log("ethereum_injected_now: " + (!!window.ethereum));
      }catch(e){}
    });

}

  // ====== Lazy loaders (MetaMask WebView sometimes injects late) ======
  function ensureEthers(maxWaitMs=3500){
    return new Promise((resolve)=>{
      if (window.ethers) { resolve(true); return; }
      log("ethers_load_attempt");
      const s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js";
      s.async = true;
      s.onload = () => { log("ethers_loaded_after: " + (!!window.ethers)); resolve(!!window.ethers); };
      s.onerror = () => { log("ethers_load_failed"); resolve(false); };
      document.head.appendChild(s);
      setTimeout(()=>{ if(!window.ethers){ log("ethers_load_timeout"); resolve(false);} }, maxWaitMs);
    });
  }

  function ensureEthereum(maxWaitMs=3500, stepMs=120){
    return new Promise((resolve)=>{
      const t0 = Date.now();
      function tick(){
        const ok = !!window.ethereum;
        if (ok){ log("ethereum_injected_after: true"); resolve(true); return; }
        if (Date.now() - t0 >= maxWaitMs){ log("ethereum_injected_after: false"); resolve(false); return; }
        setTimeout(tick, stepMs);
      }
      tick();
    });
  }


  // ===== UI helpers =====
  function toast(targetId, kind, html){
    const el = document.getElementById(targetId);
    el.classList.remove('ok','bad');
    if(kind==='ok') el.classList.add('ok');
    if(kind==='bad') el.classList.add('bad');
    el.innerHTML = html;
  }

  // ===== Storage =====
  const CFG_KEY = 'WK_TEMPLE_CFG_V2';
  function loadCfg(){
    try{ return JSON.parse(localStorage.getItem(CFG_KEY) || '{}') || {}; }catch(e){ return {}; }
  }
  function saveCfg(cfg){
    localStorage.setItem(CFG_KEY, JSON.stringify(cfg||{}));
  }

  // ===== Wallet =====
  const walletAddrEl = document.getElementById('walletAddr');
  const chainInfoEl = document.getElementById('chainInfo');
  let connectedAddr = null;

  async function connectWallet(){
    if(!window.ethereum){
      log('wallet_connect_failed: no ethereum');
      toast('assistantText','bad','æ‰¾ä¸åˆ°éŒ¢åŒ…æ³¨å…¥ï¼ˆwindow.ethereumï¼‰ã€‚è«‹ç”¨ MetaMask å…§å»ºç€è¦½å™¨é–‹å•Ÿã€‚');
      return;
    }
    try{
      const accounts = await window.ethereum.request({method:'eth_requestAccounts'});
      connectedAddr = accounts && accounts[0] ? accounts[0] : null;
      walletAddrEl.textContent = connectedAddr || '(no account)';
      const chainId = await window.ethereum.request({method:'eth_chainId'});
      chainInfoEl.textContent = chainId ? `${chainId}` : '(unknown)';
      log('wallet_connected=' + connectedAddr);
    }catch(e){
      log('wallet_connect_error: ' + (e && e.message ? e.message : String(e)));
    }
  }

  function disconnectWallet(){
    // EIP-1193 has no true disconnect from dapp side; we just clear UI
    connectedAddr = null;
    walletAddrEl.textContent = '(not connected)';
    chainInfoEl.textContent = '(unknown)';
    log('wallet_ui_disconnected');
  }

  // avoid spam reconnect logs
  let accHandlerBound = false;
  function bindEthEvents(){
    if(!window.ethereum || accHandlerBound) return;
    accHandlerBound = true;
    window.ethereum.on('accountsChanged', function(accs){
      const a = accs && accs[0] ? accs[0] : null;
      connectedAddr = a;
      walletAddrEl.textContent = a || '(not connected)';
      log('accountsChanged=' + (a||'(none)'));
    });
    window.ethereum.on('chainChanged', function(cid){
      chainInfoEl.textContent = cid ? `${cid}` : '(unknown)';
      log('chainChanged=' + cid);
    });
  }

  // ===== Vitals + Cup =====
  const vitalsOut = document.getElementById('vitalsOut');
  const cupBadge = document.getElementById('cupBadge');
  const btnFortune = document.getElementById('btnFortune');

  let cupStreak = 0;
  const CUP_MAX = 3;
  const ST_KEY = 'WK_CUP_STREAK';
  try{ cupStreak = parseInt(localStorage.getItem(ST_KEY)||'0',10) || 0; }catch(e){ cupStreak = 0; }

  function updateCupUI(){
    cupBadge.textContent = `è–ç­Šé€£å‹ï¼š${cupStreak} / ${CUP_MAX}`;
    if(cupStreak>=CUP_MAX){
      btnFortune.disabled = false;
      btnFortune.style.cursor = 'pointer';
    }else{
      btnFortune.disabled = true;
      btnFortune.style.cursor = 'not-allowed';
    }
  }
  updateCupUI();

  function renderVitals(title, lines){
    const html = `
      <div class="toast ok">
        <div style="font-weight:1000">${title}</div>
        <div style="margin-top:6px;line-height:1.7">${lines.join('<br/>')}</div>
      </div>`;
    vitalsOut.innerHTML = html;
  }

  function doHeartbeat(){
    log('heartbeat');
    const bpm = 60 + Math.floor(Math.random()*33); // 60~92
    renderVitals('å¿ƒè·³å›éŸ¿', [
      `Pulsar BPMï¼š<b>${bpm}</b>`,
      'æ‚Ÿç©ºå¿ƒè‡Ÿï¼šç”± Faucet åˆç´„è·³å‹•ï¼ˆæœªéƒ¨ç½²æ™‚åƒ…è¨˜éŒ„ï¼‰',
      'æç¤ºï¼šä½ å¯ä»¥å…ˆç”¨ã€Œè¨­å®šé¢æ¿ã€è²¼ä¸Š Faucet åœ°å€ã€‚'
    ]);
  }
  function doBreath(){
    log('breath');
    const breath = 12 + Math.floor(Math.random()*9); // 12~20
    renderVitals('å‘¼å¸å›éŸ¿', [
      `Breath/minï¼š<b>${breath}</b>`,
      'è½‰æ—¥çª—å£ï¼š00:00~00:10ï¼ˆUTC+8ï¼‰å±¬æ–¼å®‡å®™é‡ç½®å‘¼å¸å¸¶ã€‚'
    ]);
  }
  function doPressure(){
    log('pressure');
    const s = 100 + Math.floor(Math.random()*31);
    const d = 60 + Math.floor(Math.random()*21);
    renderVitals('è¡€å£“å›éŸ¿', [
      `BPï¼š<b>${s}/${d}</b>`,
      'è¡€ç®¡ï¼šæœªä¾†ç”± KUFO ç„¡äººéŠ€è¡Œä¾›è¡€ï¼ˆè³‡é‡‘æµï¼‰èˆ‡ Faucet å¿ƒè‡Ÿå…±æŒ¯ã€‚'
    ]);
  }

  function doCup(){
    log('cup_throw');
    const ok = Math.random() < 0.5;
    if(ok){
      cupStreak += 1;
      localStorage.setItem(ST_KEY, String(cupStreak));
      updateCupUI();
      toast('assistantText','ok',`è–ç­Šæˆç«‹ã€‚é€£å‹ ${cupStreak}/${CUP_MAX}ã€‚`);
      vitalsOut.innerHTML = `<div class="toast ok"><div style="font-weight:1000">è–ç­Šï¼šæˆç«‹</div><div class="muted" style="margin-top:6px">ä½ é›¢ã€Œé ˜ç™¼è²¡é‡‘ã€æ›´è¿‘ä¸€æ­¥ã€‚</div></div>`;
    }else{
      cupStreak = 0;
      localStorage.setItem(ST_KEY, '0');
      updateCupUI();
      toast('assistantText','bad','ç¬‘ç­Šæˆ–é™°ç­Šã€‚é€£å‹æ­¸é›¶ã€‚å†ä¾†ä¸€æ¬¡ã€‚');
      vitalsOut.innerHTML = `<div class="toast bad"><div style="font-weight:1000">è–ç­Šï¼šæœªæˆ</div><div class="muted" style="margin-top:6px">æ­¸é›¶é‡ä¾†ï¼Œé€™å°±æ˜¯ä¿®è¡Œã€‚</div></div>`;
    }
  }

  function fortuneClaim(){
    log('fortune_click');
    const cfg = loadCfg();
    if(!cfg.faucet){
      toast('assistantText','bad','å°šæœªè¨­å®š Faucet åˆç´„åœ°å€ã€‚è«‹å…ˆåœ¨è¨­å®šé¢æ¿è²¼ä¸Š Faucet åœ°å€ä¸¦ä¿å­˜ã€‚');
      return;
    }
    // UI-only placeholder: on-chain call will be wired after deploy
    toast('assistantText','ok',`å·²è§£é–ç™¼è²¡é‡‘ã€‚Faucet=${cfg.faucet}ï¼ˆå°šæœªåŸ·è¡Œéˆä¸Šäº¤æ˜“ï¼Œé€™è£¡å…ˆåšä»‹é¢é©—æ”¶ï¼‰ã€‚`);
  }

  // ===== Assistant (text + STT) =====
  const assistantText = document.getElementById('assistantText');
  function assistantStart(){
    log('assistant_start');
    wukongSound('æ‚Ÿç©ºå®¢æœå•Ÿå‹•');
    const cfg = loadCfg();
    const lines = [
      'æ‚Ÿç©ºå¿ƒè‡Ÿç”± Faucet åˆç´„è‡ªå‹•è·³å‹•ï¼›æ¯æ©Ÿåªæ•‘æ´ï¼Œä¸æ“æœ‰ã€‚',
      'ä½ å¯ä»¥ï¼šå¿ƒè·³ã€å‘¼å¸ã€è¡€å£“ã€æ“²ç­Šä¸‰é€£å‹è§£é–ç™¼è²¡é‡‘ã€‚',
      `ç›®å‰è¨­å®šï¼šFaucet=${cfg.faucet||'(æœªè¨­å®š)'}ï¼›KUFO=${cfg.kufo||'(æœªè¨­å®š)'}.`,
      'æ–°å¢ï¼šä¸ƒä»™å¥³è¨±é¡˜æ± ï¼ˆé¸ä»™å¥³ã€å¯«é¡˜æœ›ã€åŒ¯å‡º JSONï¼‰ã€‚'
    ];
    assistantText.innerHTML = lines.join('<br/>');
  }

  let rec = null;
  function sttStart(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){
      log('stt_unsupported');
      toast('assistantText','bad','æœ¬è£ç½®ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼ˆSpeechRecognitionï¼‰ã€‚');
      return;
    }
    if(rec){ try{rec.stop();}catch(e){} rec=null; }
    rec = new SR();
    rec.lang = 'zh-TW';
    rec.interimResults = false;
    rec.maxAlternatives = 1;
    rec.onstart = function(){ log('stt_start'); toast('assistantText','ok','æˆ‘åœ¨è½ã€‚èªªå®Œæœƒè‡ªå‹•åœã€‚'); };
    rec.onerror = function(e){ log('stt_error: ' + (e && e.error ? e.error : 'unknown')); };
    rec.onresult = function(ev){
      try{
        const t = ev.results && ev.results[0] && ev.results[0][0] ? ev.results[0][0].transcript : '';
        log('stt_text: ' + t);
        // simple router
        const txt = (t||'').trim();
        if(!txt){ toast('assistantText','bad','æ²’æœ‰è½åˆ°å…§å®¹ã€‚'); return; }
        if(txt.includes('å¿ƒè·³')) doHeartbeat();
        else if(txt.includes('å‘¼å¸')) doBreath();
        else if(txt.includes('è¡€å£“')) doPressure();
        else if(txt.includes('æ“²') || txt.includes('ç­Š')) doCup();
        else if(txt.includes('è¨±é¡˜')) document.getElementById('wishText').focus();
        else toast('assistantText','ok','æ”¶åˆ°ï¼š' + txt + '<br/>ä½ å¯ä»¥èªªï¼šå¿ƒè·³ã€å‘¼å¸ã€è¡€å£“ã€æ“²ç­Šã€è¨±é¡˜ã€‚');
      }catch(e){}
    };
    rec.onend = function(){ log('stt_stop'); };
    try{ rec.start(); }catch(e){ log('stt_start_fail: ' + (e && e.message ? e.message : String(e))); }
  }
  function sttStop(){ try{ if(rec) rec.stop(); }catch(e){} log('stt_stop_btn'); }

  // ===== Seven Fairies Data =====
  const FAIRIES = [
    {id:'f1', name:'å¤§ä»™å¥³ï¼ˆå·§é›²ï¼‰', star:'å¤©æ¨', mode:'åšç©º', point:14520, duty:'é¢¨èª¿é›¨é †'},
    {id:'f2', name:'äºŒä»™å¥³ï¼ˆå·§è™¹ï¼‰', star:'å¤©ç’‡', mode:'åšå¤š', point:14866, duty:'å®¶åº­ç¾æ»¿'},
    {id:'f3', name:'ä¸‰ä»™å¥³ï¼ˆå·§èŠï¼‰', star:'å¤©ç’£', mode:'åšç©º', point:16184, duty:'è‚²å­æ”¶é©š'},
    {id:'f4', name:'å››ä»™å¥³ï¼ˆå·§ä»™ï¼‰', star:'å¤©æ¬Š', mode:'åšå¤š', point:16888, duty:'äº‹æ¥­é‹é€š'},
    {id:'f5', name:'äº”ä»™å¥³ï¼ˆå·§è˜­ï¼‰', star:'å¤©è¡¡', mode:'åšç©º', point:17347, duty:'é•·å‘½ç™¾æ­²'},
    {id:'f6', name:'å…­ä»™å¥³ï¼ˆå·§æ¢…ï¼‰', star:'é—“é™½', mode:'åšå¤š', point:18056, duty:'èº«é«”å¥åº·'},
    {id:'f7', name:'ä¸ƒä»™å¥³ï¼ˆå·§éˆï¼‰', star:'ç‘¤å…‰', mode:'å¤šå–®é€€', point:18459, duty:'æ„Ÿæƒ…åœ“æ»¿'}
  ];

  function renderFairies(){
    const grid = document.getElementById('fairyGrid');
    grid.innerHTML = '';
    FAIRIES.forEach(f=>{
      const el = document.createElement('div');
      el.className = 'node';
      el.innerHTML = `
        <h3>â­ ${f.star}ï½œ${f.name}</h3>
        <div class="muted" style="margin-top:6px;line-height:1.65">
          åº§æ¨™é»ï¼š<b>${f.point}</b><br/>
          å°ˆæŒï¼š<b>${f.duty}</b><br/>
          æ°£è„ˆï¼š<b>${f.mode}</b>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn small" data-wish="${f.id}">æŠ•å‘è¨±é¡˜æ± </button>
        </div>
      `;
      grid.appendChild(el);
    });

    // bind wish buttons
    grid.querySelectorAll('button[data-wish]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-wish');
        const sel = document.getElementById('wishFairy');
        sel.value = id;
        document.getElementById('wishText').focus();
        log('wish_route=' + id);
      });
    });
  }

  function fillWishSelect(){
    const sel = document.getElementById('wishFairy');
    sel.innerHTML = '';
    FAIRIES.forEach(f=>{
      const opt = document.createElement('option');
      opt.value = f.id;
      opt.textContent = `${f.star}ï½œ${f.name}ï½œ${f.duty}ï½œ${f.mode}ï½œ${f.point}`;
      sel.appendChild(opt);
    });
  }

  // ===== Wish Pool =====
  const WISH_KEY = 'WK_WISH_POOL_V1';
  function loadWishes(){
    try{ return JSON.parse(localStorage.getItem(WISH_KEY)||'[]') || []; }catch(e){ return []; }
  }
  function saveWishes(arr){ localStorage.setItem(WISH_KEY, JSON.stringify(arr||[])); }
  function updateWishCount(){
    const arr = loadWishes();
    // count today
    const today = new Date();
    const ymd = today.getFullYear()+"-"+String(today.getMonth()+1).padStart(2,'0')+"-"+String(today.getDate()).padStart(2,'0');
    const n = arr.filter(x=> (x && x.ymd===ymd)).length;
    document.getElementById('wishCount').textContent = `ä»Šæ—¥è¨±é¡˜ï¼š${n}`;
  }

  function makeWishObject(){
    const fid = document.getElementById('wishFairy').value;
    const f = FAIRIES.find(x=>x.id===fid) || FAIRIES[0];
    const text = (document.getElementById('wishText').value||'').trim();
    const vow = (document.getElementById('wishVow').value||'').trim();
    const t = new Date();
    const ymd = t.getFullYear()+"-"+String(t.getMonth()+1).padStart(2,'0')+"-"+String(t.getDate()).padStart(2,'0');
    return {
      boot_version: BOOT_VERSION,
      at: t.toISOString(),
      ymd,
      wallet: connectedAddr,
      fairy: {
        id: f.id, name: f.name, star: f.star, duty: f.duty, mode: f.mode, point: f.point
      },
      wish: {
        text,
        vow
      }
    };
  }

  function wishSubmit(){
    log('wish_submit');
    wukongSound('è¨±é¡˜å·²æŠ•ä¸‹');
    const obj = makeWishObject();
    if(!obj.wish.text){
      toast('wishOut','bad','è«‹å…ˆå¯«ä¸‹é¡˜æœ›å…§å®¹ã€‚');
      return;
    }
    const arr = loadWishes();
    arr.push(obj);
    saveWishes(arr);
    updateWishCount();
    toast('wishOut','ok',`å·²æŠ•ä¸‹è¨±é¡˜ã€‚<br/>å®ˆè­·ï¼š<b>${obj.fairy.star}</b>ï½œ${obj.fairy.name}<br/>é¡˜æœ›ï¼š${escapeHtml(obj.wish.text)}`);
  }

  function exportWish(){
    log('wish_export');
    const obj = makeWishObject();
    if(!obj.wish.text){
      toast('wishOut','bad','è«‹å…ˆå¯«ä¸‹é¡˜æœ›å…§å®¹å¾Œå†åŒ¯å‡ºã€‚');
      return;
    }
    downloadJson(`wish_${obj.fairy.id}_${Date.now()}.json`, obj);
    toast('wishOut','ok','å·²åŒ¯å‡º JSONï¼ˆä¸‹è¼‰æˆ–åˆ†äº«çµ¦æ¯æ©Ÿï¼‰ã€‚');
  }

  // ===== Export State =====
  function downloadJson(filename, obj){
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1200);
  }

  function exportState(){
    log('export_json');
    const cfg = loadCfg();
    const state = {
      boot_version: BOOT_VERSION,
      at: new Date().toISOString(),
      wallet: connectedAddr,
      chain: chainInfoEl.textContent,
      cup_streak: cupStreak,
      cfg,
      wish_today_count: document.getElementById('wishCount').textContent,
    };
    downloadJson(`wukong_temple_state_${Date.now()}.json`, state);
  }

  // ===== Small utils =====
  function escapeHtml(str){
    return String(str||'')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  // ===== Bind UI =====
  document.getElementById('btnSelfcheck').addEventListener('click', selfCheck);
  document.getElementById('btnClearLog').addEventListener('click', ()=>{ logEl.textContent=''; log('log_cleared'); });
  document.getElementById('btnHideDbg').addEventListener('click', ()=>{ document.getElementById('debug').style.display='none'; });

  document.getElementById('btnHeartbeat').addEventListener('click', doHeartbeat);
  document.getElementById('btnBreath').addEventListener('click', doBreath);
  document.getElementById('btnPressure').addEventListener('click', doPressure);
  document.getElementById('btnCup').addEventListener('click', doCup);
  document.getElementById('btnFortune').addEventListener('click', fortuneClaim);

  document.getElementById('btnConnect').addEventListener('click', ()=>{ bindEthEvents(); connectWallet(); });
  document.getElementById('btnDisconnect').addEventListener('click', disconnectWallet);
  document.getElementById('btnExport').addEventListener('click', exportState);

  document.getElementById('btnAssistant').addEventListener('click', assistantStart);
  document.getElementById('btnSTT').addEventListener('click', sttStart);
  document.getElementById('btnStopSTT').addEventListener('click', sttStop);

  document.getElementById('btnSaveCfg').addEventListener('click', ()=>{
    const faucet = (document.getElementById('inFaucet').value||'').trim();
    const kufo = (document.getElementById('inKUFO').value||'').trim();
    const r1 = (document.getElementById('inRecycle1')?.value||'').trim();
    const r2 = (document.getElementById('inRecycle2')?.value||'').trim();
    const r3 = (document.getElementById('inRecycle3')?.value||'').trim();
    const cfg = loadCfg();
    if(faucet) cfg.faucet = faucet;
    if(kufo) cfg.kufo = kufo;
    if(r1) cfg.recycle1 = r1; else delete cfg.recycle1;
    if(r2) cfg.recycle2 = r2; else delete cfg.recycle2;
    if(r3) cfg.recycle3 = r3; else delete cfg.recycle3;
    saveCfg(cfg);
    applyCfgToUI(cfg);
    log('cfg_saved');
    toast('assistantText','ok','è¨­å®šå·²ä¿å­˜ï¼ˆæœ¬æ©Ÿï¼‰ã€‚');
  });

  document.getElementById('btnClearCfg').addEventListener('click', ()=>{
    saveCfg({});
    applyCfgToUI({});
    document.getElementById('inFaucet').value='';
    document.getElementById('inKUFO').value='';
    log('cfg_cleared');
    toast('assistantText','ok','å·²æ¸…é™¤è¨­å®šï¼ˆæœ¬æ©Ÿï¼‰ã€‚');
  });

  document.getElementById('btnLoadFairies').addEventListener('click', ()=>{
    fillWishSelect();
    toast('wishOut','ok','å·²è¼‰å…¥ä¸ƒä»™å¥³åˆ°è¨±é¡˜æ± ã€‚');
    log('fairies_loaded_to_wishpool');
  });

  document.getElementById('btnWish').addEventListener('click', wishSubmit);
  document.getElementById('btnWishExport').addEventListener('click', exportWish);

  function applyCfgToUI(cfg){
    document.getElementById('faucetAddr').textContent = cfg.faucet || '(to be set after deploy)';
    document.getElementById('kufoAddr').textContent = cfg.kufo || '(to be set after deploy)';
  }

  // ===== Boot init =====
  (function init(){
    log('boot_version=' + BOOT_VERSION);
    // render fairies + wish select
    renderFairies();
    fillWishSelect();
    updateWishCount();
    // lamps
    try{ lampInitUI(); }catch(e){ log('lamp_init_fail '+(e&&e.message?e.message:String(e))); }

    // load cfg
    const cfg = loadCfg();
    applyCfgToUI(cfg);
    if(cfg.faucet) document.getElementById('inFaucet').value = cfg.faucet;
    if(cfg.kufo) document.getElementById('inKUFO').value = cfg.kufo;
    if(cfg.recycle1 && document.getElementById('inRecycle1')) document.getElementById('inRecycle1').value = cfg.recycle1;
    if(cfg.recycle2 && document.getElementById('inRecycle2')) document.getElementById('inRecycle2').value = cfg.recycle2;
    if(cfg.recycle3 && document.getElementById('inRecycle3')) document.getElementById('inRecycle3').value = cfg.recycle3;
    if(cfg.recycle1 && document.getElementById('inRecycle1')) document.getElementById('inRecycle1').value = cfg.recycle1;
    if(cfg.recycle2 && document.getElementById('inRecycle2')) document.getElementById('inRecycle2').value = cfg.recycle2;
    if(cfg.recycle3 && document.getElementById('inRecycle3')) document.getElementById('inRecycle3').value = cfg.recycle3;


    // sound ui
    try{
      const sm = document.getElementById('soundMode');
      const bt = document.getElementById('btnTestSound');
      if(sm){
        sm.value = getSoundMode();
        sm.addEventListener('change', ()=>{ setSoundMode(sm.value); log('sound_mode=' + sm.value); }, true);
      }
      if(bt){
        bt.addEventListener('click', ()=>{ wukongSound('æ‚Ÿç©ºåœ¨æ­¤'); log('sound_test'); }, true);
      }
    }catch(e){}
    
  // =========================
  // ğŸ•¯ï¸ Zodiac Lamps + Free Species Registry (Local-first)
  // =========================
  const LS_LAMP_KEY = "wukong_lamps_v1";
  const LS_LAMP_CFG = "wukong_lamps_cfg_v1";

  const ZODIAC_LIST = [
    {key:"rat",   name:"é¼ "},
    {key:"ox",    name:"ç‰›"},
    {key:"tiger", name:"è™"},
    {key:"rabbit",name:"å…”"},
    {key:"dragon",name:"é¾"},
    {key:"snake", name:"è›‡"},
    {key:"horse", name:"é¦¬"},
    {key:"goat",  name:"ç¾Š"},
    {key:"monkey",name:"çŒ´"},
    {key:"rooster",name:"é›"},
    {key:"dog",   name:"ç‹—"},
    {key:"pig",   name:"è±¬"},
  ];
  const FREE_SPECIES = {key:"free", name:"ç¬¬13è‚–ãƒ»è‡ªç”±ç‰©ç¨®"};

  function lampNowYear(){
    try { return new Date().getFullYear(); } catch(e){ return 2026; }
  }

  function lampLoadCfg(){
    try { return JSON.parse(localStorage.getItem(LS_LAMP_CFG) || "{}") || {}; }
    catch(e){ return {}; }
  }
  function lampSaveCfg(cfg){
    localStorage.setItem(LS_LAMP_CFG, JSON.stringify(cfg||{}));
  }

  function lampLoadState(){
    const year = lampNowYear();
    let st;
    try { st = JSON.parse(localStorage.getItem(LS_LAMP_KEY) || "null"); } catch(e){ st=null; }
    if(!st || typeof st!=="object") st = {year, zodiac:{}, free:{}};
    if(!st.year) st.year = year;

    // å¹´åº¦ä¸åŒï¼šä¸è‡ªå‹•æŠ¹é™¤ï¼Œè®“ä½¿ç”¨è€…æ‰‹å‹• resetï¼ˆé¿å…æ„å¤–æ¶ˆå¤±ï¼‰
    if(!st.zodiac) st.zodiac = {};
    if(!st.free) st.free = {};
    return st;
  }

  function lampSaveState(st){
    localStorage.setItem(LS_LAMP_KEY, JSON.stringify(st||{}));
  }

  function lampMaxSlots(type){
    return (type==="free") ? 108 : 72;
  }

  function lampKey(type, zodiacKey){
    return (type==="free") ? "free" : (zodiacKey || "rat");
  }

  function lampCountUsed(st, type, zodiacKey){
    const key = lampKey(type, zodiacKey);
    const bucket = (type==="free") ? (st.free||{}) : (st.zodiac||{});
    const rec = bucket[key] || {};
    return Object.keys(rec).length;
  }

  function lampRemain(st){
    // total remain for 12 zodiac
    let used12=0;
    for(const z of ZODIAC_LIST){
      used12 += lampCountUsed(st, "zodiac", z.key);
    }
    const total12 = 72 * ZODIAC_LIST.length;
    const remain12 = Math.max(0, total12 - used12);

    const usedFree = lampCountUsed(st, "free", "free");
    const totalFree = 108;
    const remainFree = Math.max(0, totalFree - usedFree);
    return {remain12, remainFree, used12, usedFree, total12, totalFree};
  }

  function lampFindNextFreeSlot(st, type, zodiacKey){
    const key = lampKey(type, zodiacKey);
    const bucket = (type==="free") ? (st.free||{}) : (st.zodiac||{});
    const rec = bucket[key] || {};
    const max = lampMaxSlots(type);
    for(let i=1;i<=max;i++){
      if(!rec[String(i)]) return i;
    }
    return null;
  }

  function lampEnsureBucket(st, type, zodiacKey){
    const key = lampKey(type, zodiacKey);
    if(type==="free"){
      st.free = st.free || {};
      st.free[key] = st.free[key] || {};
      return st.free[key];
    }else{
      st.zodiac = st.zodiac || {};
      st.zodiac[key] = st.zodiac[key] || {};
      return st.zodiac[key];
    }
  }

  function lampRenderSelect(){
    const typeSel = document.getElementById("lampType");
    const zSel = document.getElementById("lampZodiac");
    if(!typeSel || !zSel) return;

    const type = typeSel.value || "zodiac";
    zSel.innerHTML = "";
    if(type==="free"){
      const opt = document.createElement("option");
      opt.value = "free";
      opt.textContent = FREE_SPECIES.name;
      zSel.appendChild(opt);
    }else{
      for(const z of ZODIAC_LIST){
        const opt = document.createElement("option");
        opt.value = z.key;
        opt.textContent = `${z.name}ï¼ˆæ¯ç”Ÿè‚–72å¸­ï¼‰`;
        zSel.appendChild(opt);
      }
    }

    // é¡¯ç¤º/éš±è—è‡ªç”±ç‰©ç¨®è¼¸å…¥
    const sp = document.getElementById("lampSpecies");
    if(sp){
      sp.disabled = (type!=="free");
      sp.placeholder = (type==="free")
        ? "ä¾‹å¦‚ï¼šèŸ‘è‚ã€èèŸ»ã€è®Šå½¢é‡‘å‰›ã€å¤§è±¡ã€å¤–æ˜Ÿäººã€è¶…äººã€èŸ»äººã€æ‚Ÿç©ºçŒ´æ¯›â€¦"
        : "ï¼ˆè‡ªç”±ç‰©ç¨®æ‰éœ€å¡«ï¼‰";
    }
  }

  function lampRefreshStats(){
    const st = lampLoadState();
    const yearEl = document.getElementById("lampYear");
    const r12 = document.getElementById("lampRemain12");
    const rf = document.getElementById("lampRemainFree");
    if(yearEl) yearEl.textContent = String(st.year || lampNowYear());
    const r = lampRemain(st);
    if(r12) r12.textContent = `${r.remain12} / ${r.total12}`;
    if(rf) rf.textContent = `${r.remainFree} / ${r.totalFree}`;
  }

  function lampTableHTML(rows){
    if(!rows.length) return `<div class="muted">å°šç„¡ç™»è¨˜ã€‚</div>`;
    let out = `<table class="tbl"><thead><tr>
      <th>Slot</th><th>åå­—</th><th>ç‰©ç¨®</th><th>Pulsar</th><th>KUFO</th><th>æœŸé™</th><th>å»ºç«‹æ™‚é–“</th><th>é¡˜æœ›</th>
    </tr></thead><tbody>`;
    for(const r of rows){
      const dt = (r.createdAt) ? new Date(r.createdAt).toISOString().slice(0,19).replace("T"," ") : "";
      out += `<tr>
        <td>${esc(r.slot)}</td>
        <td>${esc(r.name||"")}</td>
        <td>${esc(r.species||"")}</td>
        <td>${esc(r.pulsar||"")}</td>
        <td>${r.kufo ? "âœ…" : "â€”"}</td>
        <td>${esc(r.term||"")}</td>
        <td>${esc(dt)}</td>
        <td>${esc(r.wish||"")}</td>
      </tr>`;
    }
    out += `</tbody></table>`;
    return out;
  }

  function lampLookup(){
    const type = (document.getElementById("lampType")||{}).value || "zodiac";
    const zodiacKey = (document.getElementById("lampZodiac")||{}).value || (type==="free"?"free":"rat");
    const st = lampLoadState();
    const bucket = lampEnsureBucket(st, type, zodiacKey);
    const rows = Object.keys(bucket)
      .map(k=>bucket[k])
      .sort((a,b)=>Number(a.slot)-Number(b.slot));
    const list = document.getElementById("lampList");
    if(list) list.innerHTML = lampTableHTML(rows);

    log(`lamp_lookup type=${type} key=${zodiacKey} rows=${rows.length}`);
    lampRefreshStats();
  }

  function lampRegisterLocal(){
    const type = (document.getElementById("lampType")||{}).value || "zodiac";
    const zodiacKey = (document.getElementById("lampZodiac")||{}).value || (type==="free"?"free":"rat");
    const name = (document.getElementById("lampName")||{}).value || "";
    const species = (document.getElementById("lampSpecies")||{}).value || "";
    const pulsar = Number((document.getElementById("lampPulsar")||{}).value || 72);
    const wish = (document.getElementById("lampWish")||{}).value || "";
    const kufo = ((document.getElementById("lampKUFO")||{}).value || "0") === "1";
    const term = (document.getElementById("lampTerm")||{}).value || "1y";

    const st = lampLoadState();
    const max = lampMaxSlots(type);
    const slotInput = (document.getElementById("lampSlot")||{}).value;
    let slot = slotInput ? Number(slotInput) : null;
    if(!slot || slot<1 || slot>max){
      slot = lampFindNextFreeSlot(st, type, zodiacKey);
    }
    if(!slot){
      toast("åé¡å·²æ»¿ã€‚");
      log("lamp_register_failed full");
      return;
    }

    const bucket = lampEnsureBucket(st, type, zodiacKey);
    const slotKey = String(slot);
    if(bucket[slotKey]){
      toast("æ­¤å¸­ä½å·²è¢«å ç”¨ï¼Œè«‹æ›ä¸€å€‹æˆ–ç”¨è‡ªå‹•é…ä½ã€‚");
      log("lamp_register_failed occupied");
      return;
    }

    const rec = {
      type, zodiacKey, slot,
      name: String(name).slice(0,64),
      species: (type==="free") ? String(species).slice(0,64) : "",
      pulsar: isFinite(pulsar) ? pulsar : 72,
      wish: String(wish).slice(0,120),
      kufo,
      term,
      createdAt: Date.now(),
      wallet: (STATE && STATE.wallet) ? STATE.wallet : null,
      chainId: (STATE && STATE.chainId) ? STATE.chainId : null,
      boot: BOOT_VERSION
    };
    bucket[slotKey] = rec;
    lampSaveState(st);

    const echo = document.getElementById("lampEcho");
    if(echo) echo.textContent = JSON.stringify(rec, null, 2);

    log(`lamp_register type=${type} key=${zodiacKey} slot=${slot}`);
    if(typeof wukongSound!=="undefined" && wukongSound && wukongSound.ding){ wukongSound.ding(); }
    lampLookup();
  }

  function lampExport(){
    const st = lampLoadState();
    const blob = new Blob([JSON.stringify(st, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `wukong_lamps_${st.year||lampNowYear()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
    log("lamp_export");
  }

  function lampResetYear(){
    const year = lampNowYear();
    const st = {year, zodiac:{}, free:{}};
    lampSaveState(st);
    log("lamp_reset_year");
    lampRefreshStats();
    lampLookup();
  }

  function lampClearLocal(){
    localStorage.removeItem(LS_LAMP_KEY);
    log("lamp_clear_local");
    lampRefreshStats();
    lampLookup();
    toast("å·²æ¸…é™¤æœ¬æ©Ÿç™»è¨˜ã€‚");
  }

  function lampAutoSlot(){
    const type = (document.getElementById("lampType")||{}).value || "zodiac";
    const zodiacKey = (document.getElementById("lampZodiac")||{}).value || (type==="free"?"free":"rat");
    const st = lampLoadState();
    const slot = lampFindNextFreeSlot(st, type, zodiacKey);
    const inp = document.getElementById("lampSlot");
    if(inp) inp.value = slot ? String(slot) : "";
    log(`lamp_autoslot type=${type} key=${zodiacKey} slot=${slot||0}`);
    toast(slot ? `å·²é…ä½ï¼š${slot}` : "åé¡å·²æ»¿ã€‚");
  }

  function lampSaveContract(){
    const cfg = lampLoadCfg();
    cfg.lamp = (document.getElementById("inLamp")||{}).value || "";
    lampSaveCfg(cfg);
    toast("å·²ä¿å­˜ï¼ˆæœ¬æ©Ÿï¼‰ã€‚");
    log("lamp_cfg_saved");
    lampRefreshStats();
  }

  function lampClearContract(){
    const cfg = lampLoadCfg();
    cfg.lamp = "";
    lampSaveCfg(cfg);
    const inp = document.getElementById("inLamp");
    if(inp) inp.value = "";
    toast("å·²æ¸…é™¤ï¼ˆæœ¬æ©Ÿï¼‰ã€‚");
    log("lamp_cfg_cleared");
  }

  function lampInitUI(){
    // inject into settings panel too (keep backward compatible if inputs exist)
    const cfg = lampLoadCfg();
    const inp = document.getElementById("inLamp");
    if(inp) inp.value = cfg.lamp || "";

    lampRenderSelect();
    lampRefreshStats();

    const typeSel = document.getElementById("lampType");
    if(typeSel){
      typeSel.addEventListener("change", ()=>{
        lampRenderSelect();
        lampAutoSlot();
        lampLookup();
      });
    }
    const zSel = document.getElementById("lampZodiac");
    if(zSel){
      zSel.addEventListener("change", ()=>{
        lampAutoSlot();
        lampLookup();
      });
    }

    const bind = (id, fn)=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener("click", (e)=>{ e.preventDefault(); try{ fn(); }catch(err){ log("lamp_err "+(err&&err.message?err.message:String(err))); } }, true);
    };

    bind("btnLampRegister", lampRegisterLocal);
    bind("btnLampLookup", lampLookup);
    bind("btnLampExport", lampExport);
    bind("btnLampResetYear", lampResetYear);
    bind("btnLampClearLocal", lampClearLocal);
    bind("btnLampAutoSlot", lampAutoSlot);
    bind("btnLampSave", lampSaveContract);
    bind("btnLampClear", lampClearContract);

    // on-chain button: just gate & log for now
    const btnOn = document.getElementById("btnLampOnchain");
    if(btnOn){
      const cfg2 = lampLoadCfg();
      const hasContract = !!(cfg2.lamp && cfg2.lamp.startsWith("0x") && cfg2.lamp.length>=42);
      const canWallet = !!(window.ethereum && typeof window.ethereum.request==="function");
      btnOn.disabled = !(hasContract && canWallet);
      btnOn.addEventListener("click", (e)=>{
        e.preventDefault();
        toast("åˆç´„ç‰ˆé»ç‡ˆï¼šç­‰ä½ éƒ¨ç½² Lamp Contract å¾Œå†æ¥ä¸Š mint/renewã€‚");
        log("lamp_onchain_clicked");
      }, true);
    }

    // initial list
    lampLookup();
  }


// first selfcheck
    selfCheck();
  })();

})();
</script>

</body>
</html>

  // ------------------------------
  // Microcell Shop (local prototype)
  // ------------------------------
  const MC_KEY = 'wukong_microcells_v1';

  function mcLoad(){
    try{
      const raw = localStorage.getItem(MC_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch(e){ return []; }
  }
  function mcSave(arr){
    try{ localStorage.setItem(MC_KEY, JSON.stringify(arr)); }catch(e){}
  }
  function mcResolveRoute(route, cfg){
    if(route === 'KUFO') return cfg.kufo || '';
    if(route === 'PG') return STATE.publicGood || '';
    if(route === 'R1') return cfg.recycle1 || '';
    if(route === 'R2') return cfg.recycle2 || '';
    if(route === 'R3') return cfg.recycle3 || '';
    return '';
  }
  function mcRender(){
    const listEl = document.getElementById('mc_list');
    const statsEl = document.getElementById('mc_stats');
    if(!listEl || !statsEl) return;
    const arr = mcLoad();
    statsEl.textContent = 'ç´°åŒ…ï¼š' + arr.length;
    if(arr.length === 0){
      listEl.textContent = 'ï¼ˆå°šç„¡ç´°åŒ…ï¼‰';
      return;
    }
    const lines = arr.slice().reverse().map(x=>{
      const pay = x.payAddress ? (' -> ' + x.payAddress) : '';
      return `â€¢ ${x.name}ï½œ${x.category||'-'}ï½œ${x.species||'-'}ï½œåº§æ¨™ ${x.location||'-'}ï½œreward ${x.rewardBps||0}bpsï½œ${x.route||'-'}${pay}`;
    });
    listEl.textContent = lines.join('\n');
  }
  function mcInitUI(){
    const btnCreate = document.getElementById('btnMcCreate');
    const btnExport = document.getElementById('btnMcExport');
    const btnClear = document.getElementById('btnMcClear');
    if(btnCreate){
      btnCreate.addEventListener('click', ()=>{
        const name = (document.getElementById('mc_name')?.value||'').trim();
        const category = (document.getElementById('mc_category')?.value||'').trim();
        const species = (document.getElementById('mc_species')?.value||'').trim();
        const location = (document.getElementById('mc_location')?.value||'').trim();
        const rewardBps = parseInt((document.getElementById('mc_reward_bps')?.value||'').trim()||'0', 10) || 0;
        const route = (document.getElementById('mc_route')?.value||'KUFO').trim();

        if(!name){
          wukongSpeak('è«‹å…ˆè¼¸å…¥ç´°åŒ…åç¨±ã€‚');
          log('mc_create_failed: no_name');
          return;
        }

        const cfg = loadCfg();
        const payAddress = mcResolveRoute(route, cfg);
        const arr = mcLoad();
        const rec = {
          id: 'mc_' + Math.random().toString(16).slice(2,10),
          ts: new Date().toISOString(),
          owner: (STATE.wallet||''),
          name, category, species, location,
          rewardBps,
          route,
          payAddress
        };
        arr.push(rec);
        mcSave(arr);
        mcRender();
        wukongSpeak('ç´°åŒ…å·²å»ºç«‹ã€‚');
        log('mc_created=' + rec.id);
      });
    }
    if(btnExport){
      btnExport.addEventListener('click', ()=>{
        const cfg = loadCfg();
        const payload = {
          boot_version: BOOT_VERSION,
          exported_at: new Date().toISOString(),
          wallet: STATE.wallet || null,
          config: {
            kufo: cfg.kufo || null,
            publicGood: STATE.publicGood || null,
            recycle1: cfg.recycle1 || null,
            recycle2: cfg.recycle2 || null,
            recycle3: cfg.recycle3 || null
          },
          microcells: mcLoad()
        };
        downloadJson('wukong_microcells.json', payload);
        wukongSpeak('å·²åŒ¯å‡ºç´°åŒ… JSONã€‚');
        log('mc_export');
      });
    }
    if(btnClear){
      btnClear.addEventListener('click', ()=>{
        mcSave([]);
        mcRender();
        wukongSpeak('ç´°åŒ…å·²æ¸…é™¤ã€‚');
        log('mc_clear');
      });
    }
    mcRender();
  }

  // ------------------------------
  // Life Factory (local prototype)
  // ------------------------------
  const LF_KEY = 'wukong_lifefactory_v1';

  function lfLoad(){
    try{
      const raw = localStorage.getItem(LF_KEY);
      if(!raw) return { births: [] };
      const obj = JSON.parse(raw);
      if(!obj || typeof obj !== 'object') return { births: [] };
      if(!Array.isArray(obj.births)) obj.births = [];
      return obj;
    }catch(e){ return { births: [] }; }
  }
  function lfSave(obj){
    try{ localStorage.setItem(LF_KEY, JSON.stringify(obj)); }catch(e){}
  }
  function lfGetPrereq(){
    const lamps = lampLoad();
    const wishes = wishLoad();
    const microcells = mcLoad();
    const cup = STATE.cupStreak || 0;

    return {
      cupStreak: cup,
      lamps: lamps.length,
      wishes: wishes.items?.length || 0,
      microcells: microcells.length
    };
  }
  function lfCheckAndExplain(){
    const p = lfGetPrereq();
    const okCup = p.cupStreak >= 3;
    const okLamp = p.lamps >= 1;
    const okWish = p.wishes >= 1;
    // microcell is optional, but recommended
    const ok = okCup && okLamp && okWish;

    const lines = [
      `è–ç­Šé€£å‹ï¼š${p.cupStreak}ï¼ˆéœ€ >= 3ï¼‰ => ${okCup ? 'OK' : 'æœªé”'}`,
      `å…‰æ˜ç‡ˆï¼š${p.lamps}ï¼ˆéœ€ >= 1ï¼‰ => ${okLamp ? 'OK' : 'æœªé”'}`,
      `è¨±é¡˜ï¼š${p.wishes}ï¼ˆéœ€ >= 1ï¼‰ => ${okWish ? 'OK' : 'æœªé”'}`,
      `ç´°åŒ…ï¼š${p.microcells}ï¼ˆé¸é…ï¼‰`
    ];
    return { ok, lines, p };
  }
  function lfInitUI(){
    const btnCheck = document.getElementById('btnLfCheck');
    const btnBirth = document.getElementById('btnLfBirth');
    const btnExport = document.getElementById('btnLfExport');
    const elStatus = document.getElementById('lf_status');
    const elEcho = document.getElementById('lf_echo');

    function paintCheck(){
      const r = lfCheckAndExplain();
      if(elStatus) elStatus.textContent = 'ç‹€æ…‹ï¼š' + (r.ok ? 'å¯èª•ç”Ÿ' : 'æ¢ä»¶æœªé½Š');
      if(elEcho) elEcho.textContent = r.lines.join('ï½œ');
      return r;
    }

    if(btnCheck){
      btnCheck.addEventListener('click', ()=>{
        const r = paintCheck();
        wukongSpeak(r.ok ? 'æ¢ä»¶å·²é½Šï¼Œå¯ä»¥ç”Ÿæˆç”Ÿå‘½è›‹ã€‚' : 'æ¢ä»¶æœªé½Šï¼Œè«‹å…ˆå®Œæˆåƒæ‹œæµç¨‹ã€‚');
        log('lf_check');
      });
    }

    if(btnBirth){
      btnBirth.addEventListener('click', ()=>{
        const r = paintCheck();
        if(!r.ok){
          wukongSpeak('æ¢ä»¶æœªé½Šï¼Œæš«ä¸å¯èª•ç”Ÿã€‚');
          log('lf_birth_blocked');
          return;
        }

        const name = (document.getElementById('lf_name')?.value||'').trim();
        const species = (document.getElementById('lf_species')?.value||'').trim();
        const bp = (document.getElementById('lf_birthplace')?.value||'11520').trim();
        const bpCustom = (document.getElementById('lf_birthplace_custom')?.value||'').trim();
        const pulsarHz = (document.getElementById('lf_pulsar_hz')?.value||'').trim();
        const ship = (document.getElementById('lf_ship')?.value||'').trim();

        if(!name || !species){
          wukongSpeak('è«‹è¼¸å…¥ç”Ÿå‘½åç¨±èˆ‡ç‰©ç¨®ã€‚');
          log('lf_birth_failed: missing_fields');
          return;
        }

        const cfg = loadCfg();
        const birthPlace = (bp === 'custom') ? (bpCustom || 'custom') : bp;

        const egg = {
          id: 'life_' + Math.random().toString(16).slice(2,10),
          boot_version: BOOT_VERSION,
          created_at: new Date().toISOString(),
          owner_wallet: STATE.wallet || null,
          name,
          species,
          birth_place: birthPlace,
          pulsar_hz: pulsarHz || null,
          ship: ship || null,
          prerequisite_snapshot: r.p,
          linked: {
            faucet: cfg.faucet || null,
            kufo: cfg.kufo || null,
            publicGood: STATE.publicGood || null
          },
          organs_needed: ['heart', 'brain', 'lungs', 'blood', 'skin', 'memory']
        };

        const store = lfLoad();
        store.births.push(egg);
        lfSave(store);

        downloadJson('wukong_life_egg.json', egg);
        wukongSpeak('ç”Ÿå‘½è›‹å·²ç”Ÿæˆã€‚');
        log('lf_birth=' + egg.id);
      });
    }

    if(btnExport){
      btnExport.addEventListener('click', ()=>{
        const payload = lfLoad();
        downloadJson('wukong_life_factory.json', {
          boot_version: BOOT_VERSION,
          exported_at: new Date().toISOString(),
          wallet: STATE.wallet || null,
          data: payload
        });
        wukongSpeak('å·²åŒ¯å‡ºç”Ÿå‘½å·¥å»  JSONã€‚');
        log('lf_export');
      });
    }

    // initial paint
    paintCheck();
  }



