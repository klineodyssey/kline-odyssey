<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>äº”æŒ‡å±±ãƒ»æ‚Ÿç©ºè²¡ç¥æ®¿ï½œWukong Fortune Hall</title>
<style>
  :root { --bg:#0b0f14; --card:#111827; --muted:#9ca3af; --txt:#e5e7eb; --acc:#f59e0b; --ok:#10b981; --bad:#ef4444; --line:#1f2937; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#070a0f,#0b0f14 30%,#070a0f);color:var(--txt);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif}
  a{color:#93c5fd;text-decoration:none}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .hero{padding:12px 14px;border:1px solid var(--line);background:rgba(17,24,39,.65);border-radius:16px}
  .row{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
  @media (min-width:860px){.row{grid-template-columns:1.1fr .9fr}}
  .card{padding:12px 14px;border:1px solid var(--line);background:rgba(17,24,39,.55);border-radius:16px}
  .h{font-weight:800;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:13px;line-height:1.4}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.25);font-size:12px;color:var(--muted)}
  .btn{cursor:pointer;border:1px solid var(--line);background:rgba(0,0,0,.25);color:var(--txt);padding:10px 12px;border-radius:12px;font-weight:700}
  .btn:hover{border-color:#334155}
  .btn.acc{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.35)}
  .btn.ok{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.35)}
  .btn.bad{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .k{color:var(--muted);font-size:12px}
  input,select,textarea{width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.25);color:var(--txt)}
  textarea{min-height:84px;resize:vertical}
  pre{white-space:pre-wrap;background:rgba(0,0,0,.35);padding:10px;border-radius:12px;border:1px solid var(--line);color:#d1d5db}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .tagok{color:var(--ok);font-weight:800}
  .tagbad{color:var(--bad);font-weight:800}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  details>summary{cursor:pointer;color:#cbd5e1;font-weight:800}
  .mini{font-size:12px;color:var(--muted)}

  /* toast */
  #toast{position:fixed;left:50%;top:14px;transform:translateX(-50%);z-index:9999;max-width:min(92vw,520px);padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.55);backdrop-filter:blur(8px);display:none}
  #toast.show{display:block}
  #toast .t{font-weight:900}
  #toast .m{color:var(--txt);opacity:.95;margin-top:4px;line-height:1.3}
  #toast.ok{border-color:rgba(16,185,129,.45);background:rgba(16,185,129,.10)}
  #toast.bad{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.10)}
  #toast.acc{border-color:rgba(245,158,11,.45);background:rgba(245,158,11,.10)}

</style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <div class="h">ğŸ’ äº”æŒ‡å±±ãƒ»æ‚Ÿç©ºè²¡ç¥æ®¿ï½œWukong Fortune Hall</div>
    <div class="sub">
      <span class="pill mono">boot_version=<span id="bootVer">v3.3.1-voicefix</span></span>
      <span class="pill mono" id="envPill">env: ...</span>
      <span class="pill">ğŸŒ <a href="../" target="_blank" rel="noopener">Official Website</a></span>
    </div>
    <div class="hr"></div>
    <div class="sub">é€™è£¡ä¸æ˜¯ä¸€èˆ¬å»Ÿã€‚å¿ƒè·³ãƒ»å‘¼å¸ãƒ»è¡€å£“ãƒ»æ“²ç­Šãƒ»è¨±é¡˜æ± ãƒ»å…‰æ˜ç‡ˆãƒ»å®‡å®™ç´°åŒ…ãƒ»ç”Ÿå‘½å·¥å» ï¼Œéƒ½ä»¥ã€Œæœ¬æ©ŸåŸå‹ã€å…ˆå»ºå¥½ï¼Œç­‰ Faucet / KUFO ä¸Šéˆå¾Œå†æ¥åœ°å€ã€‚</div>
  </div>

  <div class="row">
    <div class="card">
      <div class="h">ğŸ« å®‡å®™ç”Ÿå‘½å¾µè±¡ï½œCosmic Vitals</div>
      <div class="sub">ï¼ˆæœ¬æ©Ÿè¨˜éŒ„ï¼‰æ¯æ¬¡æŒ‰éµéƒ½æœƒå¯«å…¥ Debug Consoleï¼Œæ–¹ä¾¿ä½ è²¼å›ä¾†å®šä½å•é¡Œã€‚</div>
      <div class="hr"></div>
      <div class="grid3">
        <button class="btn acc" id="btnHeartbeat">â¤ï¸ å¿ƒè·³</button>
        <button class="btn acc" id="btnBreath">ğŸ« å‘¼å¸</button>
        <button class="btn acc" id="btnPressure">ğŸ©¸ è¡€å£“</button>
      </div>
      <div style="margin-top:10px" class="grid2">
        <button class="btn" id="btnCup">ğŸ¥¢ æ“²ç­Š</button>
        <button class="btn ok" id="btnFortune">ğŸ§§ é ˜ç™¼è²¡é‡‘ï¼ˆéœ€åˆç´„ï¼‰</button>
      </div>
      <div style="margin-top:10px" class="sub">
        è–ç­Šé€£å‹ï¼š<span class="mono" id="cupStreak">0</span> / 3ã€€
        <span id="cupResult" class="mono"></span>
      </div>

      <div class="hr"></div>

      <div class="h">ğŸ”Š è²éŸ³ï¼ˆTTS / å®ï¼‰</div>
      <div class="sub">Autoï¼šæœ‰ TTS å°±ç”¨ TTSï¼Œå¦å‰‡ç”¨å®è²ã€‚MetaMask WebView å¸¸æœƒ speechSynthesis=falseã€‚</div>
      <div class="grid2" style="margin-top:10px">
        <select id="soundMode">
          <option value="auto">Auto</option>
          <option value="tts">TTS</option>
          <option value="beep">å®ï¼ˆWebAudioï¼‰</option>
          <option value="off">é—œé–‰</option>
        </select>
        <button class="btn" id="btnSoundTest">æ¸¬è©¦</button>
      </div>
    </div>

    <div class="card">
      <div class="h">ğŸªª éŒ¢åŒ…ç‹€æ…‹ï¼ˆBSC ä¸»ç¶²ï¼‰</div>
      <div class="sub">Chrome é–‹å•Ÿå¯èƒ½æœ‰ TTSï¼Œä½†å¯èƒ½æ²’æœ‰éŒ¢åŒ…æ³¨å…¥ï¼›MetaMask å…§å»º WebView åä¹‹ã€‚</div>
      <div class="hr"></div>
      <div class="grid2">
        <button class="btn ok" id="btnConnect">é€£ç·šéŒ¢åŒ…</button>
        <button class="btn" id="btnDisconnect">æ–·é–‹ï¼ˆUIï¼‰</button>
      </div>
      <div style="margin-top:10px" class="grid2">
        <button class="btn" id="btnExportState">åŒ¯å‡ºç‹€æ…‹ JSON</button>
        <button class="btn bad" id="btnClearState">æ¸…é™¤æœ¬æ©Ÿç‹€æ…‹</button>
      </div>

      <div class="hr"></div>
      <div class="mini mono">Wallet</div>
      <div class="mono" id="walletAddr">(not connected)</div>
      <div class="mini mono" style="margin-top:8px">Chain</div>
      <div class="mono" id="chainId">(unknown)</div>

      <div class="hr"></div>
      <div class="h">âš™ï¸ è¨­å®šé¢æ¿ï¼ˆæœ¬æ©Ÿå„²å­˜ï¼Œä¸ä¸Šéˆï¼‰</div>
      <div class="sub">æŠŠå·²éƒ¨ç½²åˆç´„åœ°å€è²¼ä¸Šä¾†ï¼Œè®“æŒ‰éµçŸ¥é“è¦æ‰“å“ªå€‹åˆç´„ã€‚</div>
      <div class="hr"></div>
      <div class="k">Faucet åˆç´„åœ°å€</div>
      <input id="cfgFaucet" placeholder="0x..."/>
      <div class="k" style="margin-top:8px">KUFO ç„¡äººéŠ€è¡Œåˆç´„åœ°å€</div>
      <input id="cfgKufo" placeholder="0x..."/>
      <div class="k" style="margin-top:8px">å›æ”¶åœ°å€ï¼ˆR1/R2/R3ï¼‰</div>
      <div class="grid3">
        <input id="cfgR1" placeholder="R1 0x..."/>
        <input id="cfgR2" placeholder="R2 0x..."/>
        <input id="cfgR3" placeholder="R3 0x..."/>
      </div>
      <div class="k" style="margin-top:8px">å…¬ç›Šåœ‹åº«ï¼ˆé è¨­ï¼‰</div>
      <input id="cfgPG" value="0xB73D6716005B37BEC742D64482fA26033eE1A4E1"/>

      <div class="grid2" style="margin-top:10px">
        <button class="btn ok" id="btnCfgSave">ä¿å­˜</button>
        <button class="btn" id="btnCfgClear">æ¸…é™¤</button>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="h">ğŸ§ å½±åƒèªéŸ³å®¢æœï¼ˆæœ¬æ©Ÿï¼‰</div>
    <div class="sub">æŒ‰ã€Œå•Ÿå‹•å®¢æœã€æœƒæœ—è®€è¦å‰‡ï¼ˆTTS æˆ–å®ï¼‰ã€‚ä¹Ÿå¯èªéŸ³è¼¸å…¥ï¼ˆè£ç½®æ”¯æ´æ‰æœƒæœ‰ STTï¼‰ã€‚</div>
    <div class="hr"></div>
    <div class="grid3">
      <button class="btn acc" id="btnAssistantStart">â–¶ï¸ å•Ÿå‹•å®¢æœ</button>
      <button class="btn" id="btnSttStart">ğŸ™ï¸ èªéŸ³è¼¸å…¥</button>
      <button class="btn" id="btnSttStop">â¹ï¸ åœæ­¢</button>
    </div>
    <div class="hr"></div>
    <div class="mono" id="assistantBox">æ‚Ÿç©ºå®¢æœï¼šæŒ‰ã€Œå•Ÿå‹•å®¢æœã€æœƒé¡¯ç¤ºè¦å‰‡è§£èªªã€‚</div>
  </div>

  <div class="row" style="margin-top:12px">
    <div class="card">
      <div class="h">âœ¨ ä¸ƒä»™å¥³æ˜Ÿåº§ç›¤ï½œä¸ƒæ˜Ÿå®ˆè­·</div>
      <div class="sub">è¼‰å…¥å¾Œå¯ç›´æ¥æŠ•å‘è¨±é¡˜æ± ã€‚</div>
      <div class="hr"></div>
      <button class="btn" id="btnLoadFairies">è¼‰å…¥åˆ°è¨±é¡˜æ± </button>
      <div class="hr"></div>
      <div id="fairyList"></div>
    </div>

    <div class="card">
      <div class="h">ğŸ’§ ä¸ƒä»™å¥³è¨±é¡˜æ± ï¼ˆWish Poolï¼‰</div>
      <div class="sub">æœ¬æ©Ÿè¨˜éŒ„ã€‚ä¸Šéˆå¾Œå¯æ¥ KUFO / å›æ”¶åœ°å€æ±ºå®šé‚„é¡˜èˆ‡å¸­ä½ã€‚</div>
      <div class="hr"></div>
      <div class="sub">ä»Šæ—¥è¨±é¡˜ï¼š<span class="mono" id="wishCount">0</span></div>
      <div class="hr"></div>
      <div class="k">é¸æ“‡å®ˆè­·ä»™å¥³</div>
      <select id="wishSelect"></select>
      <div class="k" style="margin-top:8px">é¡˜æœ›å…§å®¹ï¼ˆä¸è¦ç•™å€‹è³‡ï¼‰</div>
      <textarea id="wishText" placeholder="å¯«ä¸‹ä½ çš„é¡˜æœ›..."></textarea>
      <div class="k" style="margin-top:8px">èª“è¨€ï¼ˆé¸å¡«ï¼‰</div>
      <input id="wishOath" placeholder="æˆ‘é¡˜æ„..."/>
      <div class="grid2" style="margin-top:10px">
        <button class="btn acc" id="btnWishSubmit">æŠ•ä¸‹è¨±é¡˜</button>
        <button class="btn" id="btnWishExport">åŒ¯å‡ºè¨±é¡˜ JSON</button>
      </div>
      <div class="hr"></div>
      <div class="mono" id="wishEcho">é¸å¥½ä»™å¥³ï¼Œå¯«ä¸‹é¡˜æœ›ï¼ŒæŒ‰ä¸‹ã€ŒæŠ•ä¸‹è¨±é¡˜ã€ã€‚</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="h">ğŸ•¯ï¸ 12 ç”Ÿè‚–å…‰æ˜ç‡ˆï¼ˆæ¯ç”Ÿè‚– 72 åï¼‰ï¼‹ç¬¬13è‚–ï¼ˆä»»æ„ç‰©ç¨®ï¼‰</div>
    <div class="sub">é€™æ˜¯ã€Œå»Ÿçš„æœ‰é™é¡ã€ç©æ³•ï¼š12Ã—72 = 864 ç›ã€‚ç¬¬ 13 è‚–æ˜¯æ“´å……æ§½ï¼šä»»æ„ç‰©ç¨®ï¼ˆè®Šå½¢é‡‘å‰›ã€å¤§è±¡ã€èŸ»äººã€å¤–æ˜Ÿäººã€å­«æ‚Ÿç©ºçŒ´æ¯›â€¦ï¼‰ã€‚</div>
    <div class="hr"></div>
    <div class="grid2">
      <button class="btn" id="btnLampInit">åˆå§‹åŒ–åå†Š</button>
      <button class="btn" id="btnLampExport">åŒ¯å‡ºåå†Š JSON</button>
    </div>
    <div class="hr"></div>
    <div class="grid2">
      <div>
        <div class="k">é¸æ“‡ç”Ÿè‚–/ç¬¬13è‚–</div>
        <select id="lampZodiac"></select>
      </div>
      <div>
        <div class="k">ä½ çš„åå­—ï¼ˆä¸è¦ç•™å€‹è³‡ï¼‰</div>
        <input id="lampName" placeholder="ä¾‹å¦‚ï¼šå·§é›²"/>
      </div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <div>
        <div class="k">ç¬¬13è‚–ç‰©ç¨®ï¼ˆé¸å¡«ï¼‰</div>
        <input id="lampSpecies" placeholder="ä¾‹å¦‚ï¼šè®Šå½¢é‡‘å‰› / å¤§è±¡ / çŒ¿äºº / çŒ´æ¯›..."/>
      </div>
      <div>
        <div class="k">å¹´æœŸï¼ˆé è¨­ 1 å¹´ï¼‰</div>
        <select id="lampTerm">
          <option value="365">365 å¤©</option>
          <option value="30">30 å¤©ï¼ˆæ¸¬è©¦ï¼‰</option>
          <option value="500">500 å¤©ï¼ˆäº”æŒ‡å±±ï¼‰</option>
        </select>
      </div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <button class="btn acc" id="btnLampRegister">é»ç‡ˆç™»è¨˜</button>
      <button class="btn bad" id="btnLampClear">æ¸…é™¤åå†Šï¼ˆæœ¬æ©Ÿï¼‰</button>
    </div>
    <div class="hr"></div>
    <div class="mono" id="lampStats">å°šæœªåˆå§‹åŒ–</div>
    <pre class="mono" id="lampPreview">ï¼ˆå°šç„¡è³‡æ–™ï¼‰</pre>
  </div>

  <div class="row" style="margin-top:12px">
    <div class="card">
      <div class="h">ğŸ§¬ å®‡å®™ç´°åŒ…ï¼ˆMicrocell Shopï¼‰</div>
      <div class="sub">è®“ä¿¡çœ¾å»ºç«‹è‡ªå·±çš„ KGEN ç´°åŒ…å•†åº—ï¼šä»˜æ¬¾è·¯ç”±å¯é¸ KUFO / å…¬ç›Šåœ‹åº« / å›æ”¶ R1~R3ã€‚é€™åªæ˜¯æœ¬æ©ŸåŸå‹ï¼Œç­‰åˆç´„ä¸Šéˆå†æ¥ã€‚</div>
      <div class="hr"></div>
      <div class="grid2">
        <div><div class="k">ç´°åŒ…åç¨±</div><input id="mcName" placeholder="ä¾‹å¦‚ï¼šèŠ±æœå±±æœé£¾åº—"/></div>
        <div><div class="k">åˆ†é¡</div><input id="mcCategory" placeholder="æœé£¾ / é¤é£² / å¿ƒè‡Ÿç´…åˆ©..."/></div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <div><div class="k">ç‰©ç¨®ï¼ˆä»»æ„ï¼‰</div><input id="mcSpecies" placeholder="äººé¡ / è®Šå½¢é‡‘å‰› / å¤§è±¡..."/></div>
        <div><div class="k">åº§æ¨™ï¼ˆå¯å¡« 8888/11520/18888 æˆ–è‡ªå®šï¼‰</div><input id="mcLoc" placeholder="ä¾‹å¦‚ï¼š11520"/></div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <div><div class="k">ç´…åˆ©ï¼ˆbpsï¼Œä¾‹ 888=8.88%ï¼‰</div><input id="mcBps" placeholder="ä¾‹å¦‚ï¼š888"/></div>
        <div><div class="k">ä»˜æ¬¾è·¯ç”±</div>
          <select id="mcRoute">
            <option value="KUFO">KUFO ç„¡äººéŠ€è¡Œ</option>
            <option value="PG">å…¬ç›Šåœ‹åº«</option>
            <option value="R1">å›æ”¶ R1</option>
            <option value="R2">å›æ”¶ R2</option>
            <option value="R3">å›æ”¶ R3</option>
          </select>
        </div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <button class="btn acc" id="btnMcCreate">å»ºç«‹ç´°åŒ…</button>
        <button class="btn" id="btnMcExport">åŒ¯å‡ºç´°åŒ… JSON</button>
      </div>
      <div class="hr"></div>
      <div class="mono" id="mcStats">ç´°åŒ…ï¼š0</div>
      <pre class="mono" id="mcList">ï¼ˆå°šç„¡ç´°åŒ…ï¼‰</pre>
      <button class="btn bad" id="btnMcClear" style="margin-top:10px">æ¸…é™¤ç´°åŒ…ï¼ˆæœ¬æ©Ÿï¼‰</button>
    </div>

    <div class="card">
      <div class="h">ğŸ­ 
  <!-- =========================
       ğŸ§  Wukong Brain Foundry (Local Prototype)
       ========================= -->
  <div class="card" id="brain">
    <div class="card-hd">
      <div class="title">ğŸ§  æ‚Ÿç©ºå¤§è…¦ï½œBrain Foundry</div>
      <div class="sub">è…¦å®¹é‡ä¸Šé™ï¼š<b id="brainCap">50,000,000</b> KGENï¼ˆå‹Ÿè³‡/é–å€‰æ¦‚å¿µï¼›æœªä¸Šéˆå‰åªåšæœ¬æ©Ÿç´€éŒ„ï¼‰</div>
    </div>

    <div class="grid2">
      <div class="kv">
        <div class="k">ç›®å‰æ·¨æŠ•å…¥ï¼ˆæœ¬æ©Ÿï¼‰</div>
        <div class="v"><b id="brainNet">0</b> KGEN</div>
      </div>
      <div class="kv">
        <div class="k">é€²åº¦</div>
        <div class="v"><b id="brainPct">0%</b></div>
      </div>
    </div>

    <div class="note">
      è¦å‰‡ï¼ˆç¥æ®¿ç‰ˆï¼‰ï¼šå¤§è…¦ä¸æ˜¯ä¿è­‰å ±é…¬ï¼›å®ƒæ˜¯ã€ŒKline App Gameã€æœªä¾†ç ”ç™¼çš„èƒ½é‡æ± ã€‚
      ä½ å¯ä»¥æŠ•å…¥ï¼ˆè¦–ç‚ºé–‹ç™¼èƒ½é‡ï¼‰ï¼Œä¹Ÿå¯ä»¥æé ˜ï¼ˆè¦–ç‚ºèƒ½é‡æ’¤å›ï¼å¾€ç”Ÿï¼‰ã€‚
      ä¸Šéˆå¾Œæ˜¯å¦å…è¨±æé ˜ï¼Œç”± Brain åˆç´„çš„å¤©æ¢æ±ºå®šï¼›æœ¬é å…ˆæä¾›å¯æé ˜çš„åŸå‹æµç¨‹ã€‚
    </div>

    <div class="row">
      <input id="brainAmount" class="inp" inputmode="decimal" placeholder="è¼¸å…¥è³ªé‡ï¼ˆKGENï¼ŒMassï¼‰" />
            <div class="sub" id="brainEnergyPreview">èƒ½é‡ï¼ˆEnergyï¼‰= è³ªé‡ Ã— cÂ²ï¼ˆc=1ï¼‰â†’ 0</div>
<button class="btn" id="btnBrainDeposit">æŠ•å…¥</button>
      <button class="btn" id="btnBrainWithdraw">æé ˜</button>
    </div>

    <div class="row">
      <button class="btn ghost" id="btnBrainExport">åŒ¯å‡º Brain JSON</button>
      <button class="btn ghost" id="btnBrainClear">æ¸…é™¤æœ¬æ©Ÿç´€éŒ„</button>
    </div>

    <pre class="mono" id="brainList">(å°šç„¡ç´€éŒ„)</pre>
  </div>
ç”Ÿå‘½å·¥å» ï¼ˆ
  <!-- =========================
       Kline App Game MVP (local prototype)
       ========================= -->
  <div class="card" id="klineGameMVP">
    <h2>ğŸ® Kline App Gameï½œMVPï¼ˆæœ¬æ©ŸåŸå‹ï¼‰</h2>
    <div class="muted" style="margin-top:6px">
      ç©æ³•ï¼ˆä½ å®šçš„ä¸–ç•Œç·šï¼‰ï¼š0â€“170 åšå¤šï¼›170â€“190 ä¼‘æ¯ï¼›190â€“360 åšç©ºã€‚<br/>
      é€™ç‰ˆå…ˆåšã€Œå¯ç©å¯è¨˜å¸³ã€ï¼šé¸æ—¥æœŸâ†’é¸å¤š/ç©ºâ†’è¼¸å…¥å…¥å ´/å‡ºå ´â†’ç”¨ KGEN ç•¶èƒ½é‡å€¼â†’ç«‹å³çµç®—ï¼ˆæˆ–å…ˆå­˜ç‚ºå¾…çµç®—ï¼‰ã€‚
    </div>

    <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap">
      <div style="min-width:160px">
        <div class="label">å¸‚å ´</div>
        <select id="kg_market" class="input">
          <option value="TX">TXï¼ˆå°æŒ‡ï¼‰</option>
          <option value="BTC">BTC</option>
          <option value="NASDAQ">NASDAQ</option>
        </select>
      </div>

      <div style="min-width:160px">
        <div class="label">æ—¥æœŸï¼ˆYYYYMMDDï¼‰</div>
        <input id="kg_date" class="input" placeholder="20260213" />
      </div>

      <div style="min-width:160px">
        <div class="label">å…¥å ´åƒ¹</div>
        <input id="kg_entry" class="input" placeholder="0" inputmode="decimal"/>
      </div>

      <div style="min-width:160px">
        <div class="label">å‡ºå ´åƒ¹ï¼ˆå¯ç©ºç™½ï¼å¾…çµç®—ï¼‰</div>
        <input id="kg_exit" class="input" placeholder="" inputmode="decimal"/>
      </div>
    </div>

    <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap; align-items:flex-end">
      <div style="min-width:160px">
        <div class="label">èƒ½é‡ï¼ˆEnergyï¼‰</div>
        <input id="kg_stake" class="input" placeholder="100" inputmode="decimal"/>
      </div>

      <div style="min-width:260px; flex:1">
        <div class="label">æ§“æ¡¿ï¼ˆ1ï½150ï¼‰</div>
        <input id="kg_lev" type="range" min="1" max="150" value="10" style="width:100%"/>
        <div class="muted">ç›®å‰ï¼š<span id="kg_lev_v">10</span>x</div>
      </div>

      <div style="min-width:260px">
        <div class="label">é¸æ“‡ä¸–ç•Œç·š</div>
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <button class="btn" id="kg_btn_long">åšå¤šï¼ˆ0â€“170ï¼‰</button>
          <button class="btn" id="kg_btn_rest">ä¼‘æ¯ï¼ˆ170â€“190ï¼‰</button>
          <button class="btn" id="kg_btn_short">åšç©ºï¼ˆ190â€“360ï¼‰</button>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap">
      <button class="btn primary" id="kg_btn_settle">é–‹å±€ / çµç®—ï¼ˆæœ¬æ©Ÿï¼‰</button>
      <button class="btn" id="kg_btn_export">åŒ¯å‡º Game JSON</button>
      <button class="btn danger" id="kg_btn_clear">æ¸…é™¤æœ¬æ©Ÿç´€éŒ„</button>
    </div>

    <div class="muted" style="margin-top:10px">
      âœ… å®‡å®™è¦å‰‡ï¼šKGEN=è³ªé‡ï¼ˆMassï¼‰ï¼›èƒ½é‡ï¼ˆEnergyï¼‰æ˜¯è¡Œå‹•åŠ›ã€‚1 æŒ‡æ•¸é» = 1 KGENï¼ˆè·¨å¸‚å ´ä¸€è‡´ï¼‰ã€‚ä¸Šéˆå¾Œå¯æŠŠèƒ½é‡æ”¹æˆéˆä¸Šé–å€‰ã€‚æœ¬ç‰ˆå…ˆæŠŠé‚è¼¯èˆ‡è³‡æ–™æ ¼å¼å®šä½ã€‚
    </div>

    <pre id="kg_out" class="pre" style="margin-top:10px; max-height:240px; overflow:auto">(å°šæœªé–‹å±€)</pre>
  </div>

Life Factoryï½œå®‡å®™ç´°èƒèª•ç”Ÿï¼‰</div>
      <div class="sub">å®Œæˆæµç¨‹ï¼ˆé»ç‡ˆ/è¨±é¡˜/æ“²ç­Š/é‚„é¡˜ï¼‰å¾Œå¯ç”Ÿæˆã€Œç”Ÿå‘½è—åœ– JSONã€ã€‚ä¸Šéˆç‰ˆæœ¬å¯ç”± KUFO / Faucet é©—è­‰æ¢ä»¶ã€‚</div>
      <div class="hr"></div>
      <div class="grid2">
        <div><div class="k">ç”Ÿå‘½åç¨±</div><input id="lfName" placeholder="ä¾‹å¦‚ï¼šè±¬å…«æˆ’ / æ–°äººé¡ / çŒ¿äºº"/></div>
        <div><div class="k">ç‰©ç¨®</div><input id="lfSpecies" placeholder="æœ‰æ©Ÿ/ç„¡æ©Ÿ/ä»»æ„"/></div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <div><div class="k">å‡ºç”Ÿåœ°ï¼ˆåº§æ¨™ï¼‰</div><input id="lfBirth" placeholder="ä¾‹å¦‚ï¼š8888 / 11520 / 18888"/></div>
        <div><div class="k">Pulsar å¿ƒç‡ï¼ˆHzï¼Œå¯çœŸå¯¦æˆ–è‡ªå®šï¼‰</div><input id="lfPulsar" placeholder="ä¾‹å¦‚ï¼š1.337"/></div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <button class="btn acc" id="btnLfMint">ç”Ÿæˆç”Ÿå‘½è—åœ–</button>
        <button class="btn" id="btnLfExport">åŒ¯å‡ºè—åœ– JSON</button>
      </div>
      <div class="hr"></div>
      <pre class="mono" id="lfOut">ï¼ˆå°šæœªç”Ÿæˆï¼‰</pre>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="h">ğŸ“œ å“ç‰Œå›ºå®šå°¾æ®µ</div>
    <div class="sub">PrimeForge ä»¥æ¯æ©Ÿä¹‹åï¼Œé–‹å•Ÿé‡‘èç”Ÿå‘½ã€‚èŠ±æœå±±å°ç£ãƒ»ä¿¡å¿µä¸æ»…ãƒ»å¸‚å ´ç„¡ç•Œã€‚Where the Market Becomes the Myth.â€”â€” æ¨‚å¤©å¸ âŒ–</div>
  </div>

  <div class="card" style="margin-top:12px">
    <details open>
      <summary>Debug Console</summary>
      <div class="hr"></div>
      <div class="grid3">
        <button class="btn" id="btnLogSelfcheck">Selfcheck</button>
        <button class="btn" id="btnLogClear">Clear</button>
        <button class="btn" id="btnLogCopy">Copy</button>
      </div>
      <div style="margin-top:10px" class="grid2">
        <button class="btn acc" id="btnRunSelfTest">ä¸€éµå…¨æ¸¬ï¼ˆAll Buttonsï¼‰</button>
        <button class="btn" id="btnUnlockAudio">è§£é–éŸ³è¨Š</button>
      </div>
      <pre class="mono" id="logBox" style="margin-top:10px">ï¼ˆå°šç„¡ç´€éŒ„ï¼‰</pre>
    </details>
  </div>
</div>

<script>
(function(){
  'use strict';
  const BOOT_VERSION = "v3.3.5-mass2energy-stable";
  
const BUILD_HASH = "c1704d7632c2";
const NOW_ISO = () => new Date().toISOString();

  const Log = (function(){
    const KEY = 'wukong_log_v1';
    const box = () => document.getElementById('logBox');
    function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch(e){ return []; } }
    function save(arr){ try{ localStorage.setItem(KEY, JSON.stringify(arr.slice(-800))); }catch(e){} }
    function line(msg){
      const arr = load();
      const s = `[${NOW_ISO()}] ${msg}`;
      arr.push(s);
      save(arr);
      const el = box();
      if(el) el.textContent = arr.join('\n');
    }
    function clear(){ save([]); const el=box(); if(el) el.textContent='ï¼ˆå·²æ¸…é™¤ï¼‰'; line('log_cleared'); }
    function render(){ const el=box(); if(!el) return; el.textContent = load().join('\n') || 'ï¼ˆå°šç„¡ç´€éŒ„ï¼‰'; }
    function copy(){
      const txt = load().join('\n');
      navigator.clipboard?.writeText(txt).then(()=>line('log_copied')).catch(()=>line('log_copy_failed'));
    }
    return { line, clear, render, copy };
  })();


  const UI = (function(){
    let timer = null;
    function toast(msg, kind='acc', title='æ‚Ÿç©ºæç¤º'){
      try{
        const el = document.getElementById('toast');
        const t = document.getElementById('toastTitle');
        const m = document.getElementById('toastMsg');
        if(!el||!t||!m) return;
        el.classList.remove('ok','bad','acc','show');
        el.classList.add(kind);
        t.textContent = title;
        m.textContent = msg;
        el.classList.add('show');
        clearTimeout(timer);
        timer = setTimeout(()=>{ el.classList.remove('show'); }, 2400);
      }catch(e){}
    }
    return { toast };
  })();

  const U = { qs:(id)=>document.getElementById(id), clamp:(n,a,b)=>Math.max(a,Math.min(b,n)) };

  const Sound = (function(){
    let ctx = null;
    const modeEl = () => U.qs('soundMode');
    function hasTTS(){
      return !!(window.speechSynthesis && typeof window.speechSynthesis.speak==='function' && window.SpeechSynthesisUtterance);
    }
    function beep(){
      try{
        ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
        try{ if(ctx.state==='suspended') ctx.resume(); }catch(e){}
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 880; g.gain.value = 0.001;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        g.gain.exponentialRampToValueAtTime(0.15, ctx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.18);
        o.stop(ctx.currentTime + 0.2);
      }catch(e){ Log.line('beep_fail ' + (e?.message||e)); }
    }
    function tts(text){
      try{
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-TW'; u.rate = 1.02;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      }catch(e){ Log.line('tts_fail ' + (e?.message||e)); try{ beep(); }catch(_e){} }
    }
    function speak(text){
      const mode = (modeEl()?.value)||'auto';
      if(mode==='off') return;
      if(mode==='beep') return beep();
      if(mode==='tts') return hasTTS() ? tts(text) : beep();
      return hasTTS() ? tts(text) : beep();
    }
    function test(){ Log.line('sound_test'); speak('æ‚Ÿç©ºè²¡ç¥æ®¿ï¼Œè²éŸ³æ¸¬è©¦ã€‚'); }
    function unlockOnGesture(){
      const once = ()=>{
        try{ if(ctx && ctx.state==='suspended') ctx.resume(); }catch(e){}
        try{ if(window.speechSynthesis) window.speechSynthesis.getVoices(); }catch(e){}
      };
      document.addEventListener('touchend', once, {once:true, passive:true});
      document.addEventListener('click', once, {once:true});
    }
    function init(){
      unlockOnGesture();
      const m = localStorage.getItem('wukong_sound_mode_v1');
      if(m && modeEl()) modeEl().value = m;
      modeEl()?.addEventListener('change', ()=>{
        const v = modeEl().value;
        localStorage.setItem('wukong_sound_mode_v1', v);
        Log.line('sound_mode=' + v);
      });
      U.qs('btnSoundTest')?.addEventListener('click', test);
    }
    window.wukongSound = speak; window.wukongSpeak = speak;
    return { speak, init };
  })();

  const Cfg = (function(){
    const KEY='wukong_cfg_v2';
    function load(){ try{ const d=JSON.parse(localStorage.getItem(KEY)||'{}'); return (d&&typeof d==='object')?d:{}; }catch(e){ return {}; } }
    function save(d){ try{ localStorage.setItem(KEY, JSON.stringify(d)); }catch(e){} }
    function applyToUI(d){
      U.qs('cfgFaucet').value = d.faucet||'';
      U.qs('cfgKufo').value = d.kufo||'';
      U.qs('cfgR1').value = d.recycle1||'';
      U.qs('cfgR2').value = d.recycle2||'';
      U.qs('cfgR3').value = d.recycle3||'';
      if(d.publicGood) U.qs('cfgPG').value = d.publicGood;
    }
    function readFromUI(){
      return {
        faucet: (U.qs('cfgFaucet').value||'').trim(),
        kufo: (U.qs('cfgKufo').value||'').trim(),
        recycle1: (U.qs('cfgR1').value||'').trim(),
        recycle2: (U.qs('cfgR2').value||'').trim(),
        recycle3: (U.qs('cfgR3').value||'').trim(),
        publicGood: (U.qs('cfgPG').value||'').trim(),
      };
    }
    function init(){
      const d=load(); applyToUI(d);
      U.qs('btnCfgSave')?.addEventListener('click', ()=>{ save(readFromUI()); Log.line('cfg_saved'); Sound.speak('è¨­å®šå·²ä¿å­˜ã€‚'); });
      U.qs('btnCfgClear')?.addEventListener('click', ()=>{ save({}); applyToUI({}); Log.line('cfg_cleared'); Sound.speak('è¨­å®šå·²æ¸…é™¤ã€‚'); });
      return d;
    }
    return { load, init };
  })();

  const Ethers = (function(){
    function loadOnce(){ return new Promise((resolve)=>{ if(window.ethers) return resolve(true);
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js';
      s.onload=()=>resolve(!!window.ethers); s.onerror=()=>resolve(false);
      document.head.appendChild(s);
    });}
    async function ensure(){ if(window.ethers) return true; Log.line('ethers_load_attempt'); const ok=await loadOnce(); Log.line('ethers_loaded_after: '+ok); return ok; }
    return { ensure };
  })();

  const Wallet = (function(){
    const st={addr:'',chain:''};
    function setUI(){ U.qs('walletAddr').textContent=st.addr||'(not connected)'; U.qs('chainId').textContent=st.chain||'(unknown)'; }
    async function connect(){
      await Ethers.ensure();
      const eth=window.ethereum;
      if(!eth){ Log.line('wallet_connect_failed: no ethereum'); Sound.speak('æ²’æœ‰åµæ¸¬åˆ°éŒ¢åŒ…æ³¨å…¥ã€‚'); return; }
      try{
        const accs=await eth.request({method:'eth_requestAccounts'});
        st.addr=(accs&&accs[0])?accs[0].toLowerCase():'';
        st.chain=await eth.request({method:'eth_chainId'});
        setUI(); Log.line('wallet_connected='+st.addr); Sound.speak('éŒ¢åŒ…å·²é€£ç·šã€‚');
      }catch(e){ Log.line('wallet_connect_failed: '+(e?.message||e)); }
    }
    function disconnectUI(){ st.addr=''; st.chain=''; setUI(); Log.line('wallet_ui_disconnected'); }
    function bindEvents(){
      const eth=window.ethereum; if(!eth) return;
      eth.on?.('accountsChanged',(a)=>{ st.addr=(a&&a[0])?a[0].toLowerCase():''; Log.line('accountsChanged='+(st.addr||'(empty)')); setUI(); });
      eth.on?.('chainChanged',(c)=>{ st.chain=c; Log.line('chainChanged='+c); setUI(); });
    }
    function init(){ U.qs('btnConnect')?.addEventListener('click',connect); U.qs('btnDisconnect')?.addEventListener('click',disconnectUI); bindEvents(); setUI(); }
    return { init, state:st };
  })();

  const Vitals = (function(){
    const KEY='wukong_vitals_v1'; const S={cupStreak:0};
    function load(){ try{ const d=JSON.parse(localStorage.getItem(KEY)||'{}'); if(d&&typeof d==='object') S.cupStreak=d.cupStreak||0; }catch(e){} U.qs('cupStreak').textContent=String(S.cupStreak); }
    function save(){ try{ localStorage.setItem(KEY, JSON.stringify(S)); }catch(e){} }
    function heartbeat(){ Log.line('heartbeat'); Sound.speak('å¿ƒè·³ã€‚'); }
    function breath(){ Log.line('breath'); Sound.speak('å‘¼å¸ã€‚'); }
    function pressure(){ Log.line('pressure'); Sound.speak('è¡€å£“ã€‚'); }
    function cupThrow(){
      Log.line('cup_throw');
      const ok=Math.random()<0.5;
      if(ok){ S.cupStreak=Math.min(3,S.cupStreak+1); U.qs('cupResult').innerHTML='<span class="tagok">è–ç­Šï¼šæˆç«‹</span>'; UI.toast('è–ç­Šæˆç«‹ï¼Œé€£å‹ '+S.cupStreak+' / 3','ok','æ“²ç­Š'); Sound.speak('è–ç­Šæˆç«‹ã€‚'); }
      else { S.cupStreak=0; U.qs('cupResult').innerHTML='<span class="tagbad">è–ç­Šï¼šæœªæˆ</span>'; UI.toast('æœªæˆï¼Œé€£å‹æ­¸é›¶','bad','æ“²ç­Š'); Sound.speak('æœªæˆã€‚'); }
      U.qs('cupStreak').textContent=String(S.cupStreak); save();
    }
    function fortune(){ Log.line('fortune_click'); if(S.cupStreak<3){ UI.toast('éœ€è¦è–ç­Šé€£å‹ 3 æ¬¡æ‰å¯è§£é–ï¼ˆç›®å‰ '+S.cupStreak+' / 3ï¼‰','acc','ç™¼è²¡é‡‘'); Sound.speak('è–ç­Šé€£å‹ä¸è¶³ä¸‰æ¬¡ã€‚'); return; } UI.toast('å·²è§£é–ã€‚ç­‰å¾… Faucet ä¸Šéˆå¾Œå•Ÿç”¨ã€‚','ok','ç™¼è²¡é‡‘'); Sound.speak('å·²è§£é–ã€‚ç­‰å¾… Faucet ä¸Šéˆå¾Œå•Ÿç”¨ã€‚'); }
    function init(){ load(); U.qs('btnHeartbeat')?.addEventListener('click',heartbeat); U.qs('btnBreath')?.addEventListener('click',breath); U.qs('btnPressure')?.addEventListener('click',pressure); U.qs('btnCup')?.addEventListener('click',cupThrow); U.qs('btnFortune')?.addEventListener('click',fortune); }
    return { init };
  })();

  const Assistant = (function(){
    let rec=null;
    function setBox(t){ U.qs('assistantBox').textContent=t; }
    function start(){
      Log.line('assistant_start');
      const t='è¦å‰‡ï¼šè¨±é¡˜ä¸ç­‰æ–¼ä¿è­‰ã€‚ç™¼è²¡é‡‘æ˜¯å€Ÿä½ å»åšç”Ÿæ„çš„ç¦®ç‰©ï¼Œä¸æ˜¯å¼·ç´¢å›æ”¶ã€‚è‹¥è¦ä½é€²èŠ±æœå±±ç«æ˜Ÿé½Šå¤©è±ªå®…ï¼Œé–€æª»ç‚ºäº”åƒ KGEN é‚„é¡˜ï¼Œå¯¦éš›ä»¥ KUFO ç„¡äººéŠ€è¡Œåˆç´„ç‚ºæº–ã€‚';
      setBox('æ‚Ÿç©ºå®¢æœï¼š'+t);
      Sound.speak(t);
    }
    function sttStart(){
      const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!SR){ Log.line('stt_unavailable'); setBox('æ‚Ÿç©ºå®¢æœï¼šæ­¤è£ç½®ä¸æ”¯æ´èªéŸ³è¼¸å…¥ã€‚'); return; }
      if(rec){ try{ rec.stop(); }catch(e){} rec=null; }
      rec=new SR(); rec.lang='zh-TW'; rec.interimResults=false; rec.maxAlternatives=1;
      rec.onstart=()=>Log.line('stt_start');
      rec.onend=()=>Log.line('stt_stop');
      rec.onerror=(e)=>Log.line('stt_error '+(e?.error||e?.message||e));
      rec.onresult=(e)=>{ const txt=e.results?.[0]?.[0]?.transcript||''; Log.line('stt_text='+txt); setBox('ä½ èªªï¼š'+txt); Sound.speak('æˆ‘æ”¶åˆ°ã€‚'); };
      rec.start();
    }
    function sttStop(){ Log.line('stt_stop_btn'); try{ rec?.stop(); }catch(e){} rec=null; }
    function init(){ U.qs('btnAssistantStart')?.addEventListener('click',start); U.qs('btnSttStart')?.addEventListener('click',sttStart); U.qs('btnSttStop')?.addEventListener('click',sttStop); }
    return { init };
  })();

  const Fairies = (function(){
    const LIST=[
      {id:'f1', star:'å¤©æ¨', name:'å¤§ä»™å¥³ï¼ˆå·§é›²ï¼‰', point:14520, duty:'é¢¨èª¿é›¨é †', flow:'åšç©º'},
      {id:'f2', star:'å¤©ç’‡', name:'äºŒä»™å¥³ï¼ˆå·§è™¹ï¼‰', point:14866, duty:'å®¶åº­ç¾æ»¿', flow:'åšå¤š'},
      {id:'f3', star:'å¤©ç’£', name:'ä¸‰ä»™å¥³ï¼ˆå·§èŠï¼‰', point:16184, duty:'è‚²å­æ”¶é©š', flow:'åšç©º'},
      {id:'f4', star:'å¤©æ¬Š', name:'å››ä»™å¥³ï¼ˆå·§ä»™ï¼‰', point:16888, duty:'äº‹æ¥­é‹é€š', flow:'åšå¤š'},
      {id:'f5', star:'å¤©è¡¡', name:'äº”ä»™å¥³ï¼ˆå·§è˜­ï¼‰', point:17347, duty:'é•·å‘½ç™¾æ­²', flow:'åšç©º'},
      {id:'f6', star:'é—“é™½', name:'å…­ä»™å¥³ï¼ˆå·§æ¢…ï¼‰', point:18056, duty:'èº«é«”å¥åº·', flow:'åšå¤š'},
      {id:'f7', star:'ç‘¤å…‰', name:'ä¸ƒä»™å¥³ï¼ˆå·§éˆï¼‰', point:18459, duty:'æ„Ÿæƒ…åœ“æ»¿', flow:'å¤šå–®é€€'}
    ];
    const WKEY='wukong_wishpool_v1';
    function wishLoad(){ try{ return JSON.parse(localStorage.getItem(WKEY)||'[]')||[]; }catch(e){ return []; } }
    function wishSave(a){ try{ localStorage.setItem(WKEY, JSON.stringify(a.slice(-500))); }catch(e){} }
    function renderFairies(){
      const el=U.qs('fairyList'); if(!el) return;
      el.innerHTML='';
      LIST.forEach(f=>{
        const d=document.createElement('div'); d.className='card'; d.style.margin='10px 0';
        d.innerHTML=`<div class="h">â­ ${f.star}ï½œ${f.name}</div>
          <div class="sub">åº§æ¨™é»ï¼š<span class="mono">${f.point}</span>ã€€å°ˆæŒï¼š<b>${f.duty}</b>ã€€æ°£è„ˆï¼š<b>${f.flow}</b></div>
          <button class="btn" style="margin-top:10px">æŠ•å‘è¨±é¡˜æ± </button>`;
        d.querySelector('button')?.addEventListener('click', ()=>{ U.qs('wishSelect').value=f.id; Log.line('wish_route='+f.id); Sound.speak('å·²é¸æ“‡å®ˆè­·ä»™å¥³ã€‚'); });
        el.appendChild(d);
      });
    }
    function renderWishUI(){
      const sel=U.qs('wishSelect'); sel.innerHTML='';
      LIST.forEach(f=>{ const o=document.createElement('option'); o.value=f.id; o.textContent=`${f.star}ï½œ${f.name}ï½œ${f.duty}ï½œ${f.flow}ï½œ${f.point}`; sel.appendChild(o); });
      U.qs('wishCount').textContent=String(wishLoad().length);
    }
    function submitWish(){
      const who=U.qs('wishSelect').value;
      const txt=(U.qs('wishText').value||'').trim();
      const oath=(U.qs('wishOath').value||'').trim();
      if(!txt){ U.qs('wishEcho').textContent='è«‹å…ˆå¯«ä¸‹é¡˜æœ›å…§å®¹ã€‚'; Sound.speak('è«‹å…ˆå¯«ä¸‹é¡˜æœ›å…§å®¹ã€‚'); return; }
      const f=LIST.find(x=>x.id===who)||LIST[0];
      const a=wishLoad(); a.push({ts:NOW_ISO(), fairy:f, wish:txt, oath:oath}); wishSave(a);
      U.qs('wishCount').textContent=String(a.length);
      U.qs('wishEcho').textContent=`è¨±é¡˜å·²æŠ•ä¸‹ï¼š${f.name}ï½œ${f.duty}ã€‚`;
      Log.line('wish_submit'); Sound.speak('è¨±é¡˜å·²æŠ•ä¸‹ã€‚');
    }
    function exportWish(){
      const a=wishLoad();
      const blob=new Blob([JSON.stringify(a,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const link=document.createElement('a');
      link.href=url; link.download=`wishpool_${BOOT_VERSION}.json`; link.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000);
      Log.line('export_wish_json');
    }
    function init(){
      U.qs('btnLoadFairies')?.addEventListener('click', ()=>{ renderFairies(); renderWishUI(); Log.line('fairies_loaded_to_wishpool'); Sound.speak('ä¸ƒä»™å¥³å·²è¼‰å…¥ã€‚'); });
      U.qs('btnWishSubmit')?.addEventListener('click', submitWish);
      U.qs('btnWishExport')?.addEventListener('click', exportWish);
      renderWishUI();
    }
    return { init };
  })();

  const Lamps=(function(){
    const KEY='wukong_lamps_v1';
    const Z=['é¼ ','ç‰›','è™','å…”','é¾','è›‡','é¦¬','ç¾Š','çŒ´','é›','ç‹—','è±¬','ç¬¬13è‚–ï¼ˆä»»æ„ç‰©ç¨®ï¼‰'];
    function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'{}'); }catch(e){ return {}; } }
    function save(d){ try{ localStorage.setItem(KEY, JSON.stringify(d)); }catch(e){} }
    function initRoster(){
      const d={boot:BOOT_VERSION,ts:NOW_ISO(),slots:{}}; Z.forEach(z=>d.slots[z]=[]);
      save(d); Log.line('lamp_init'); Sound.speak('å…‰æ˜ç‡ˆåå†Šå·²åˆå§‹åŒ–ã€‚'); render();
    }
    function render(){
      const d=load(); const stats=U.qs('lampStats'); const prev=U.qs('lampPreview');
      if(!d.slots){ stats.textContent='å°šæœªåˆå§‹åŒ–'; prev.textContent='ï¼ˆå°šç„¡è³‡æ–™ï¼‰'; return; }
      let total=0; const lines=[];
      Z.forEach(z=>{
        const a=d.slots[z]||[]; total+=a.length; const cap=(z==='ç¬¬13è‚–ï¼ˆä»»æ„ç‰©ç¨®ï¼‰')?'âˆ':'72';
        lines.push(`${z}ï¼š${a.length} / ${cap}`);
        a.slice(-3).forEach(x=>lines.push(`  - ${x.name}ï½œterm=${x.termDays}dï½œexp=${x.exp}` + (x.species?`ï½œspecies=${x.species}`:'')));
      });
      stats.textContent=`å·²ç™»è¨˜ï¼š${total} ç›ï¼ˆ12Ã—72=864 + ç¬¬13è‚–æ“´å……ï¼‰`;
      prev.textContent=lines.join('\n');
    }
    function register(){
      const d=load(); if(!d.slots){ Sound.speak('è«‹å…ˆåˆå§‹åŒ–åå†Šã€‚'); return; }
      const z=U.qs('lampZodiac').value;
      const name=(U.qs('lampName').value||'').trim();
      const species=(U.qs('lampSpecies').value||'').trim();
      const termDays=parseInt(U.qs('lampTerm').value||'365',10);
      if(!name){ Sound.speak('è«‹å…ˆå¡«åå­—ã€‚'); return; }
      const a=d.slots[z]||[];
      if(z!=='ç¬¬13è‚–ï¼ˆä»»æ„ç‰©ç¨®ï¼‰' && a.length>=72){ Sound.speak('æ­¤ç”Ÿè‚–åé¡å·²æ»¿ã€‚'); return; }
      const exp=new Date(Date.now()+termDays*86400*1000).toISOString().slice(0,10);
      a.push({name, species: z==='ç¬¬13è‚–ï¼ˆä»»æ„ç‰©ç¨®ï¼‰'?species:'', termDays, exp, ts:NOW_ISO()});
      d.slots[z]=a; save(d); Log.line('lamp_register '+z); Sound.speak('é»ç‡ˆç™»è¨˜å®Œæˆã€‚'); render();
    }
    function exportJson(){
      const d=load(); const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const link=document.createElement('a');
      link.href=url; link.download=`lamps_${BOOT_VERSION}.json`; link.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000); Log.line('export_lamps_json');
    }
    function clear(){ localStorage.removeItem(KEY); Log.line('lamp_cleared'); Sound.speak('å…‰æ˜ç‡ˆåå†Šå·²æ¸…é™¤ã€‚'); render(); }
    function init(){
      const sel=U.qs('lampZodiac'); sel.innerHTML=''; Z.forEach(z=>{ const o=document.createElement('option'); o.value=z; o.textContent=z; sel.appendChild(o); });
      U.qs('btnLampInit')?.addEventListener('click',initRoster);
      U.qs('btnLampRegister')?.addEventListener('click',register);
      U.qs('btnLampExport')?.addEventListener('click',exportJson);
      U.qs('btnLampClear')?.addEventListener('click',clear);
      render();
    }
    return { init };
  })();

  
  const Brain=(function(){
    const KEY='wukong_brain_v1';
    const CAP=50000000; // 50,000,000 KGEN cap (concept)
    function load(){ try{ const a=JSON.parse(localStorage.getItem(KEY)||'[]'); return Array.isArray(a)?a:[]; }catch(e){ return []; } }
    function save(a){ try{ localStorage.setItem(KEY, JSON.stringify(a)); }catch(e){} }
    function fmt(n){ try{ return (Number(n)||0).toLocaleString('en-US'); }catch(e){ return String(n||0); } }
    function getAddr(){ return (STATE.wallet && STATE.wallet.address) ? STATE.wallet.address : '(not connected)'; }

    function net(){
      const arr=load();
      let v=0;
      for(const x of arr){
        const amt=Number(x.amount)||0;
        if(x.type==='deposit') v+=amt;
        if(x.type==='withdraw') v-=amt;
      }
      return Math.max(0, v);
    }

    function render(){
      const arr=load();
      const netv=net();
      U.text('brainCap', fmt(CAP));
      U.text('brainNet', fmt(netv));
      const pct = CAP>0 ? Math.min(100, (netv/CAP)*100) : 0;
      U.text('brainPct', (pct.toFixed(2)+'%'));
      const el = U.el('brainList');
      if(!el) return;
      if(arr.length===0){ el.textContent='(å°šç„¡ç´€éŒ„)'; return; }
      const lines = arr.slice().reverse().slice(0,80).map(x=>{
        const t=new Date(x.ts||Date.now()).toISOString().replace('T',' ').slice(0,19);
        return `â€¢ ${t}ï½œ${x.type}ï½œ${fmt(x.amount)} KGENï½œ${x.addr||'-'}ï½œnote:${x.note||''}`;
      });
      el.textContent = lines.join('\n');
    }

    function deposit(){
      const amt = Number((U.val('brainAmount')||'').trim());
      if(!amt || amt<=0){ Sound.ping('è«‹è¼¸å…¥æ­£ç¢ºæ•¸é‡'); return; }
      const arr=load();
      arr.push({ts:Date.now(), type:'deposit', amount:amt, addr:getAddr(), note:'local-prototype'});
      save(arr);
      log('brain_deposit '+amt);
      Sound.ping('å·²ç´€éŒ„æŠ•å…¥');
      render();
    }

    function withdraw(){
      const amt = Number((U.val('brainAmount')||'').trim());
      if(!amt || amt<=0){ Sound.ping('è«‹è¼¸å…¥æ­£ç¢ºæ•¸é‡'); return; }
      const netv=net();
      if(amt>netv){ Sound.ping('è¶…éå¯æé ˜é¤˜é¡'); return; }
      const arr=load();
      arr.push({ts:Date.now(), type:'withdraw', amount:amt, addr:getAddr(), note:'local-prototype'});
      save(arr);
      log('brain_withdraw '+amt);
      Sound.ping('å·²ç´€éŒ„æé ˜');
      render();
    }

    function exportJson(){
      const payload = { version:'brain_v1', cap:CAP, net:net(), records:load(), cfg:STATE.cfg||{}, wallet:STATE.wallet||{} };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'wukong_brain_export.json';
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
      log('export_brain_json');
      Sound.ping('å·²åŒ¯å‡º Brain JSON');
    }

    function clear(){
      try{ localStorage.removeItem(KEY); }catch(e){}
      log('brain_cleared');
      Sound.ping('å·²æ¸…é™¤');
      render();
    }

    function init(){
      U.on('btnBrainDeposit','click',deposit);
      U.on('btnBrainWithdraw','click',withdraw);
      U.on('btnBrainExport','click',exportJson);
      U.on('btnBrainClear','click',clear);
            // Energy = Mass Ã— cÂ². MVP uses c=1 (so cÂ²=1). Keep mass as KGEN in records.
      const C2 = 1;
      function updateEnergyPreview(){
        const m = Number((U.val('brainAmount')||'').trim()) || 0;
        const e = m * C2;
        const el = document.getElementById('brainEnergyPreview');
        if(el) el.textContent = `èƒ½é‡ï¼ˆEnergyï¼‰= è³ªé‡ Ã— cÂ²ï¼ˆc=1ï¼‰â†’ ${fmt(e)} ï¼ˆç”± ${fmt(m)} KGEN è½‰æ›ï¼‰`;
      }
      U.on('brainAmount','input',updateEnergyPreview);
U.on('brainAmount','keydown',(e)=>{ if(e.key==='Enter') deposit(); });
      render();
      updateEnergyPreview();
    }
    return { init, render, net };
  })();
const Microcell=(function(){
    const KEY='wukong_microcells_v1';
    function load(){ try{ const a=JSON.parse(localStorage.getItem(KEY)||'[]'); return Array.isArray(a)?a:[]; }catch(e){ return []; } }
    function save(a){ try{ localStorage.setItem(KEY, JSON.stringify(a.slice(-500))); }catch(e){} }
    function resolveRoute(route,cfg){
      if(route==='KUFO') return cfg.kufo||'';
      if(route==='PG') return cfg.publicGood||'';
      if(route==='R1') return cfg.recycle1||'';
      if(route==='R2') return cfg.recycle2||'';
      if(route==='R3') return cfg.recycle3||'';
      return '';
    }
    function render(cfg){
      const a=load(); U.qs('mcStats').textContent='ç´°åŒ…ï¼š'+a.length;
      if(a.length===0){ U.qs('mcList').textContent='ï¼ˆå°šç„¡ç´°åŒ…ï¼‰'; return; }
      const lines=a.slice().reverse().map(x=>{
        const pay=resolveRoute(x.route,cfg);
        return `â€¢ ${x.name}ï½œ${x.category||'-'}ï½œ${x.species||'-'}ï½œåº§æ¨™ ${x.location||'-'}ï½œreward ${x.rewardBps||0}bpsï½œ${x.route}` + (pay?` -> ${pay}`:'');
      });
      U.qs('mcList').textContent=lines.join('\n');
    }
    function create(cfg){
      const name=(U.qs('mcName').value||'').trim();
      const category=(U.qs('mcCategory').value||'').trim();
      const species=(U.qs('mcSpecies').value||'').trim();
      const location=(U.qs('mcLoc').value||'').trim();
      const rewardBps=parseInt((U.qs('mcBps').value||'0').trim(),10)||0;
      const route=U.qs('mcRoute').value;
      if(!name){ Sound.speak('è«‹å…ˆå¡«ç´°åŒ…åç¨±ã€‚'); return; }
      const a=load(); a.push({ts:NOW_ISO(),name,category,species,location,rewardBps:U.clamp(rewardBps,0,5000),route});
      save(a); Log.line('mc_create'); Sound.speak('ç´°åŒ…å·²å»ºç«‹ã€‚'); render(cfg);
    }
    function exportJson(){
      const a=load(); const blob=new Blob([JSON.stringify(a,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const link=document.createElement('a');
      link.href=url; link.download=`microcells_${BOOT_VERSION}.json`; link.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000); Log.line('export_microcells_json');
    }
    function clear(cfg){ localStorage.removeItem(KEY); Log.line('mc_cleared'); Sound.speak('ç´°åŒ…å·²æ¸…é™¤ã€‚'); render(cfg); }
    function init(cfg){
      U.qs('btnMcCreate')?.addEventListener('click',()=>create(cfg));
      U.qs('btnMcExport')?.addEventListener('click',exportJson);
      U.qs('btnMcClear')?.addEventListener('click',()=>clear(cfg));
      render(cfg);
    }
    return { init };
  })();

  const LifeFactory=(function(){
    const KEY='wukong_life_blueprints_v1';
    function load(){ try{ const a=JSON.parse(localStorage.getItem(KEY)||'[]'); return Array.isArray(a)?a:[]; }catch(e){ return []; } }
    function save(a){ try{ localStorage.setItem(KEY, JSON.stringify(a.slice(-200))); }catch(e){} }
    function make(){
      const name=(U.qs('lfName').value||'').trim();
      const species=(U.qs('lfSpecies').value||'').trim();
      const birth=(U.qs('lfBirth').value||'').trim();
      const pulsar=(U.qs('lfPulsar').value||'').trim();
      if(!name||!birth){ Sound.speak('è«‹å…ˆå¡«ç”Ÿå‘½åç¨±èˆ‡å‡ºç”Ÿåœ°ã€‚'); return null; }
      return { boot:BOOT_VERSION, ts:NOW_ISO(), name, species:species||'unspecified', birth, pulsarHz:pulsar||'auto',
        organs:{heart:'FaucetHeart',brain:'AutopilotBrain',bank:'KUFO',ufo:'KUFO-PocketTimeUFO'},
        rulesHint:{lamp72:true,wishpool:true,cup3:true,vow5000:true} };
    }
    function render(bp){ U.qs('lfOut').textContent=bp?JSON.stringify(bp,null,2):'ï¼ˆå°šæœªç”Ÿæˆï¼‰'; }
    function mint(){ const bp=make(); if(!bp) return; const a=load(); a.push(bp); save(a); render(bp); Log.line('life_blueprint_minted'); Sound.speak('ç”Ÿå‘½è—åœ–å·²ç”Ÿæˆã€‚'); }
    function exportJson(){
      const a=load(); const blob=new Blob([JSON.stringify(a,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const link=document.createElement('a');
      link.href=url; link.download=`life_blueprints_${BOOT_VERSION}.json`; link.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000); Log.line('export_life_json');
    }
    function init(){ U.qs('btnLfMint')?.addEventListener('click',mint); U.qs('btnLfExport')?.addEventListener('click',exportJson); render(null); }
    return { init };
  })();

  const State=(function(){
    function exportAll(){
      const payload={ boot:BOOT_VERSION, ts:NOW_ISO(), ua:navigator.userAgent,
        speechSynthesis:!!window.speechSynthesis, speechRecognition:!!(window.SpeechRecognition||window.webkitSpeechRecognition),
        ethers_loaded:!!window.ethers, ethereum_injected:!!window.ethereum, wallet:Wallet.state, cfg:Cfg.load() };
      const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const link=document.createElement('a');
      link.href=url; link.download=`wukong_state_${BOOT_VERSION}.json`; link.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000); Log.line('export_json');
    }
    function clearAll(){
      ['wukong_log_v1','wukong_cfg_v2','wukong_vitals_v1','wukong_wishpool_v1','wukong_lamps_v1','wukong_microcells_v1','wukong_life_blueprints_v1']
        .forEach(k=>localStorage.removeItem(k));
      Log.line('clear_state'); Sound.speak('æœ¬æ©Ÿç‹€æ…‹å·²æ¸…é™¤ã€‚'); location.reload();
    }
    function init(){ U.qs('btnExportState')?.addEventListener('click',exportAll); U.qs('btnClearState')?.addEventListener('click',clearAll); }
    return { init };
  })();

  async function selfcheck(){
    Log.line('boot_version='+BOOT_VERSION);
    Log.line('selfcheck_start');
    Log.line('userAgent: '+navigator.userAgent);
    Log.line('speechSynthesis: '+(!!window.speechSynthesis));
    Log.line('speechRecognition: '+(!!(window.SpeechRecognition||window.webkitSpeechRecognition)));
    const ethersOk=await Ethers.ensure();
    Log.line('ethers_loaded_now: '+ethersOk);
    Log.line('ethereum_injected_now: '+(!!window.ethereum));
    const pill=U.qs('envPill');
    if(pill){
      pill.textContent = `env: TTS=${!!window.speechSynthesis} | ETH=${!!window.ethereum} | ethers=${ethersOk}`;
    }
  }

  function bindDebugButtons(){
    U.qs('btnLogSelfcheck')?.addEventListener('click',selfcheck);
    U.qs('btnLogClear')?.addEventListener('click',()=>Log.clear());
    U.qs('btnLogCopy')?.addEventListener('click',()=>Log.copy());
  
  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

  async function runSelfTest(){
    Log.line('SELFTEST_START ' + now());
    try{ const sm=U.qs('soundMode'); if(sm && sm.value==='off'){ sm.value='auto'; localStorage.setItem('wukong_sound_mode_v1','auto'); Log.line('selftest_force_sound_mode=auto'); } }catch(e){}
    // 1) environment
    try{ selfcheck(); }catch(e){ Log.line('selfcheck_fail ' + (e?.message||e)); }

    // 2) try unlock audio (gesture still required on some browsers)
    try{ Log.line('audio_unlock_try'); UI.toast('é–‹å§‹ä¸€éµå…¨æ¸¬ï¼ˆè‹¥åœ¨ MetaMask WebViewï¼ŒTTS æœƒè‡ªå‹•æ”¹ç”¨å®è²ï¼‰','acc','SELFTEST'); Sound.speak('Audio unlock test'); }catch(e){ Log.line('audio_unlock_fail ' + (e?.message||e)); }

    // 3) sequentially click all known buttons
    const ids = [
      'btnHeartbeat','btnBreath','btnPressure','btnCup','btnAssistantStart',
      'btnSoundTest','btnKGENVerify','btnBrainPing','btnBrainRead',
      'kg_long','kg_short','kg_rest','kg_settle','kg_copy',
      'btnLifeMint','btnLifePulse','btnLifeBurn'
    ];
    for(const id of ids){
      const el = U.qs(id);
      if(!el){ Log.line('selftest_miss ' + id); continue; }
      const disabled = !!(el.disabled || el.getAttribute('aria-disabled')==='true' || el.classList.contains('disabled'));
      if(disabled){ Log.line('selftest_disabled ' + id); continue; }
      try{
        Log.line('selftest_click ' + id);
        el.click();
      }catch(e){
        Log.line('selftest_click_fail ' + id + ' ' + (e?.message||e));
      }
      await sleep(220);
    }
    Log.line('SELFTEST_DONE ' + now());
    UI.toast('ä¸€éµå…¨æ¸¬å®Œæˆï¼Œè«‹åœ¨ Log å…§æ‰¾ selftest_miss / selftest_disabled / selftest_click_fail','ok','SELFTEST');
  }

  function unlockAudio(){
    Log.line('audio_unlock_manual ' + now());
    try{ Sound.speak('Audio unlock'); }catch(e){ Log.line('audio_unlock_fail ' + (e?.message||e)); }
  }

  // Bind self-test & audio unlock buttons
  U.qs('btnRunSelfTest')?.addEventListener('click',()=>runSelfTest());
  U.qs('btnUnlockAudio')?.addEventListener('click',()=>unlockAudio());
}

  function boot(){
    U.qs('bootVer').textContent=BOOT_VERSION;
    Log.render();
    bindDebugButtons();
    Sound.init();
    const cfg=Cfg.init();
    Wallet.init();
    Vitals.init();
    Assistant.init();
    Fairies.init();
    Lamps.init();
    Brain.init();
    Microcell.init(cfg);
    LifeFactory.init();
    State.init();
    selfcheck();
  }

  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',boot,{once:true}); }
  else { boot(); }
})();
</script>


<!-- =========================
     ğŸ§  Brain Foundry On-chain Panel (V3.2.0 add-on)
     ========================= -->
<section class="card" id="brain_onchain">
  <h2>ğŸ§  æ‚Ÿç©ºå¤§è…¦ï½œBrain Foundryï¼ˆéˆä¸Šï¼‰</h2>
  <p class="muted">éœ€è¦å·²éƒ¨ç½² Brain åˆç´„åœ°å€ï¼›åœ¨æœ‰éŒ¢åŒ…æ³¨å…¥ï¼ˆMetaMask WebViewï¼‰æ™‚æ‰æœƒå¯æŒ‰ã€‚<br/>æç¤ºï¼šChrome ä¸€èˆ¬æ²’æœ‰éŒ¢åŒ…æ³¨å…¥ï¼›MetaMask WebView å¸¸è¦‹ <code>speechSynthesis=false</code> ä½†éŒ¢åŒ…å¯ç”¨ã€‚</p>

  <div class="grid2">
    <div>
      <label>Brain åˆç´„åœ°å€</label>
      <input id="cfg_brain" placeholder="0x..." />
    </div>
    <div>
      <label>å—ç›Šäººï¼ˆå¯ç•™ç©º=è‡ªå·±ï¼‰</label>
      <input id="brain_beneficiary" placeholder="0x..." />
    </div>
    <div>
      <label>èƒ½é‡ï¼ˆEnergyï¼‰</label>
      <input id="brain_amount" placeholder="ä¾‹å¦‚ 100" inputmode="decimal" />
    </div>
    <div>
      <label>æé ˜è·¯ç”±</label>
      <select id="brain_route">
        <option value="0">è‡ªè¨‚åœ°å€</option>
        <option value="1">KUFO</option>
        <option value="2">Public Good</option>
        <option value="3">Recycle1</option>
        <option value="4">Recycle2</option>
        <option value="5">Recycle3</option>
      </select>
    </div>
    <div>
      <label>è‡ªè¨‚æé ˜åœ°å€ï¼ˆroute=è‡ªè¨‚ï¼‰</label>
      <input id="brain_to" placeholder="0x..." />
    </div>
    <div>
      <label>ç‹€æ…‹</label>
      <pre id="brain_status" class="pre">(not loaded)</pre>
    </div>
  </div>

  <div class="row">
    <button id="btnBrainSave" class="btn">ä¿å­˜ Brain åœ°å€</button>
    <button id="btnBrainRefresh" class="btn">åˆ·æ–°ç‹€æ…‹</button>
    <button id="btnBrainDeposit" class="btn primary">æŠ•å…¥å¤§è…¦ï¼ˆdepositï¼‰</button>
    <button id="btnBrainWithdraw" class="btn danger">æé ˜ï¼ˆwithdrawï¼‰</button>
  </div>

  <details style="margin-top:10px;">
    <summary>åˆç´„ ABI / æ³¨æ„äº‹é …</summary>
    <div class="muted" style="margin-top:8px; line-height:1.6;">
      é€™è£¡åªå‘¼å«å¤§è…¦åˆç´„çš„ <code>deposit</code> / <code>withdraw</code> / <code>withdrawToRoute</code> / <code>credits</code>ã€‚
      è‹¥æœªéƒ¨ç½² Faucet / KUFOï¼Œä»å¯å…ˆæ¸¬ UIã€‚åœ°å€ä¸Šéˆå¾Œä¸å»ºè­°é »ç¹æ”¹å‹•ã€‚
    </div>
  </details>
</section>

<script>
// ------------------------------
// Brain Foundry On-chain (V3.2.0)
// ------------------------------
(function(){
  try{
    // bump boot version (UI uses BOOT_VERSION already, but keep a visible log)
    if(window.__wukong_log) window.__wukong_log('brain_panel_loaded');
  }catch(e){}

  const BRAIN_CFG_KEY = 'wukong_brain_v1';

  function loadBrainCfg(){
    try{ return JSON.parse(localStorage.getItem(BRAIN_CFG_KEY)||'{}') || {}; }catch(e){ return {}; }
  }
  function saveBrainCfg(cfg){
    try{ localStorage.setItem(BRAIN_CFG_KEY, JSON.stringify(cfg||{})); }catch(e){}
  }

  function q(id){ return document.getElementById(id); }

  function bootFill(){
    const cfg = loadBrainCfg();
    if(q('cfg_brain')) q('cfg_brain').value = cfg.brain || '';
  }

  const BRAIN_ABI = [
    'function VERSION() view returns (string)',
    'function KGEN() view returns (address)',
    'function CAP() view returns (uint256)',
    'function totalCredits() view returns (uint256)',
    'function credits(address) view returns (uint256)',
    'function routes() view returns (tuple(address kufo,address publicGood,address recycle1,address recycle2,address recycle3))',
    'function deposit(uint256 amount, address beneficiary)',
    'function withdraw(uint256 amount, address to)',
    'function withdrawToRoute(uint8 routeId, uint256 amount)'
  ];

  async function brainContract(){
    const addr = (q('cfg_brain')?.value||'').trim();
    if(!addr || !addr.startsWith('0x') || addr.length < 42) throw new Error('Brain address missing');
    if(!window.ethers) throw new Error('ethers not loaded');
    if(!window.ethereum) throw new Error('no ethereum');
    const provider = new ethers.BrowserProvider(window.ethereum);
    const signer = await provider.getSigner();
    return { c: new ethers.Contract(addr, BRAIN_ABI, signer), provider, signer };
  }

  function fmtU(x){
    try{ return ethers.formatUnits(x, 18); }catch(e){ return String(x); }
  }

  async function refreshBrain(){
    const out = q('brain_status');
    if(!out) return;
    try{
      const {c, signer} = await brainContract();
      const me = await signer.getAddress();
      const [ver,kgen,cap,total,route,credit] = await Promise.all([
        c.VERSION(), c.KGEN(), c.CAP(), c.totalCredits(), c.routes(), c.credits(me)
      ]);
      const lines = [];
      lines.push('VERSION: ' + ver);
      lines.push('KGEN: ' + kgen);
      lines.push('CAP: ' + fmtU(cap));
      lines.push('totalCredits: ' + fmtU(total));
      lines.push('myCredits: ' + fmtU(credit));
      lines.push('routes.KUFO: ' + route.kufo);
      lines.push('routes.PG: ' + route.publicGood);
      lines.push('routes.R1: ' + route.recycle1);
      lines.push('routes.R2: ' + route.recycle2);
      lines.push('routes.R3: ' + route.recycle3);
      out.textContent = lines.join('
');
      if(window.__wukong_log) window.__wukong_log('brain_refresh_ok');
    }catch(err){
      out.textContent = 'ERROR: ' + (err?.message || err);
      if(window.__wukong_log) window.__wukong_log('brain_refresh_err ' + (err?.message||err));
    }
  }

  async function depositBrain(){
    try{
      const {c, signer} = await brainContract();
      const me = await signer.getAddress();
      const amountStr = (q('brain_amount')?.value||'').trim();
      if(!amountStr) throw new Error('amount empty');
      const amt = ethers.parseUnits(amountStr, 18);
      const ben = (q('brain_beneficiary')?.value||'').trim() || me;
      const tx = await c.deposit(amt, ben);
      if(window.__wukong_log) window.__wukong_log('brain_deposit_tx ' + tx.hash);
      await tx.wait();
      if(window.__wukong_log) window.__wukong_log('brain_deposit_ok');
      await refreshBrain();
    }catch(err){
      if(window.__wukong_log) window.__wukong_log('brain_deposit_err ' + (err?.message||err));
      alert('Deposit failed: ' + (err?.message||err));
    }
  }

  async function withdrawBrain(){
    try{
      const {c, signer} = await brainContract();
      const me = await signer.getAddress();
      const amountStr = (q('brain_amount')?.value||'').trim();
      if(!amountStr) throw new Error('amount empty');
      const amt = ethers.parseUnits(amountStr, 18);
      const routeId = parseInt(q('brain_route')?.value||'0',10) || 0;
      if(routeId === 0){
        const to = (q('brain_to')?.value||'').trim() || me;
        const tx = await c.withdraw(amt, to);
        if(window.__wukong_log) window.__wukong_log('brain_withdraw_tx ' + tx.hash);
        await tx.wait();
      }else{
        const tx = await c.withdrawToRoute(routeId, amt);
        if(window.__wukong_log) window.__wukong_log('brain_withdrawRoute_tx ' + tx.hash);
        await tx.wait();
      }
      if(window.__wukong_log) window.__wukong_log('brain_withdraw_ok');
      await refreshBrain();
    }catch(err){
      if(window.__wukong_log) window.__wukong_log('brain_withdraw_err ' + (err?.message||err));
      alert('Withdraw failed: ' + (err?.message||err));
    }
  }

  function saveBrain(){
    const cfg = loadBrainCfg();
    cfg.brain = (q('cfg_brain')?.value||'').trim();
    saveBrainCfg(cfg);
    if(window.__wukong_log) window.__wukong_log('brain_cfg_saved');
    alert('Brain address saved (local).');
  }

  // hook buttons
  function hook(){
    bootFill();
    q('btnBrainSave')?.addEventListener('click', saveBrain);
    q('btnBrainRefresh')?.addEventListener('click', refreshBrain);
    q('btnBrainDeposit')?.addEventListener('click', depositBrain);
    q('btnBrainWithdraw')?.addEventListener('click', withdrawBrain);
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', hook);
  }else{
    hook();
  }
})();

// ------------------------------
// Kline App Game MVP (local)
// ------------------------------
(function(){
  const KG_KEY = 'kline_game_sessions_v1';
  function kgLoad(){ try{ const a=JSON.parse(localStorage.getItem(KG_KEY)||'[]'); return Array.isArray(a)?a:[]; }catch(e){ return []; } }
  function kgSave(a){ try{ localStorage.setItem(KG_KEY, JSON.stringify(a)); }catch(e){} }
  function now(){ return new Date().toISOString(); }
  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
  function asNum(v){ const n=Number(String(v).trim()); return Number.isFinite(n)?n:0; }
  function asStr(v){ return String(v||'').trim(); }
  function validYYYYMMDD(s){ return /^\d{8}$/.test(s); }

  let choice = 'LONG'; // default

  function ui(){
    return {
      market: document.getElementById('kg_market'),
      date: document.getElementById('kg_date'),
      entry: document.getElementById('kg_entry'),
      exit: document.getElementById('kg_exit'),
      stake: document.getElementById('kg_stake'),
      lev: document.getElementById('kg_lev'),
      levV: document.getElementById('kg_lev_v'),
      out: document.getElementById('kg_out'),
      btnLong: document.getElementById('kg_btn_long'),
      btnRest: document.getElementById('kg_btn_rest'),
      btnShort: document.getElementById('kg_btn_short'),
      btnSettle: document.getElementById('kg_btn_settle'),
      btnExport: document.getElementById('kg_btn_export'),
      btnClear: document.getElementById('kg_btn_clear'),
    };
  }

  function setChoice(c){
    choice=c;
    const u=ui();
    if(!u.btnLong) return;
    u.btnLong.classList.toggle('primary', c==='LONG');
    u.btnRest.classList.toggle('primary', c==='REST');
    u.btnShort.classList.toggle('primary', c==='SHORT');
    try{ log('game_choice=' + c); }catch(e){}
  }

  function settle(){
    const u=ui(); if(!u.out) return;
    const market = asStr(u.market?.value||'TX');
    const date = asStr(u.date?.value||'');
    const entry = asNum(u.entry?.value||0);
    const exitV = asStr(u.exit?.value||'');
    const exit = exitV==='' ? null : asNum(exitV);
    const stake = asNum(u.stake?.value||0);
    const lev = clamp(asNum(u.lev?.value||10), 1, 150);

    if(!validYYYYMMDD(date)){
      u.out.textContent = 'æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼šè«‹è¼¸å…¥ YYYYMMDDï¼ˆä¾‹å¦‚ 20260213ï¼‰';
      return;
    }
    if(energy<=0){
      u.out.textContent = 'èƒ½é‡ï¼ˆEnergyï¼‰å¿…é ˆ > 0';
      return;
    }
    if(choice!=='REST' && entry<=0){
      u.out.textContent = 'å…¥å ´åƒ¹å¿…é ˆ > 0ï¼ˆåšå¤š/åšç©ºéœ€è¦ï¼‰';
      return;
    }

    const rec = {
      id: 'G' + Date.now(),
      ts: now(),
      market,
      date,
      action: choice,
      entry: entry || 0,
      exit: exit===null? null : exit,
      energy,
      stake: energy, // backward-compat alias
      leverage: lev,
      unit: 'KGEN_per_point',
      rule: '1point=1KGEN',
      status: 'PENDING',
      pnl: 0
    };

    if(choice==='REST'){
      rec.status='REST';
      rec.pnl=0;
    }else if(exit===null){
      rec.status='PENDING';
      rec.pnl=0;
    }else{
      let diff = (exit - entry);
      if(choice==='SHORT') diff = -diff;
      // Universe rule: 1 point = 1 KGEN (cross-market). Energy is your action mass->energy budget.
      let pnl = diff * lev;
      // Risk cap: lose at most -energy, win up to energy*lev
      pnl = clamp(pnl, -energy, energy*lev);
      rec.pnl_points = Number(diff.toFixed ? diff.toFixed(8) : diff);
      rec.pnl_kgen = Number(pnl.toFixed(8));
      // Keep rec.pnl for backward compatibility
      rec.pnl = rec.pnl_kgen;
      rec.status='SETTLED';
      rec.pnl = Number(pnl.toFixed(8));
    }

    const arr = kgLoad();
    arr.push(rec);
    kgSave(arr);

    const last = rec;
    const summary = {
      ok: true,
      note: 'æœ¬æ©Ÿ MVP çµç®—å®Œæˆï¼ˆè·¨å¸‚å ´ï¼š1é»=1KGENï¼‰',
      last,
      stats: {
        total: arr.length,
        settled: arr.filter(x=>x.status==='SETTLED').length,
        pending: arr.filter(x=>x.status==='PENDING').length
      }
    };
    u.out.textContent = JSON.stringify(summary, null, 2);
    try{ log('game_settle ' + last.action + ' ' + last.market + ' ' + last.date); }catch(e){}
  }

  function exportJSON(){
    const arr = kgLoad();
    const blob = new Blob([JSON.stringify(arr, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'kline_game_sessions.json';
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
    try{ log('export_game_json'); }catch(e){}
  }

  function clearAll(){
    localStorage.removeItem(KG_KEY);
    const u=ui(); if(u.out) u.out.textContent='ï¼ˆå·²æ¸…é™¤æœ¬æ©Ÿ Game ç´€éŒ„ï¼‰';
    try{ log('game_cleared'); }catch(e){}
  }

  function init(){
    const u=ui();
    if(!u.btnSettle) return; // section may not exist
    // lev
    if(u.lev){
      u.lev.addEventListener('input', ()=>{ if(u.levV) u.levV.textContent = String(u.lev.value); });
      if(u.levV) u.levV.textContent = String(u.lev.value);
    }
    // choice
    u.btnLong?.addEventListener('click', ()=>setChoice('LONG'));
    u.btnRest?.addEventListener('click', ()=>setChoice('REST'));
    u.btnShort?.addEventListener('click', ()=>setChoice('SHORT'));
    setChoice('LONG');

    u.btnSettle?.addEventListener('click', settle);
    u.btnExport?.addEventListener('click', exportJSON);
    u.btnClear?.addEventListener('click', clearAll);
  }

  // wait DOM ready
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', init);
  }else{
    init();
  }
})();

</script>


<div id="toast" role="status" aria-live="polite">
  <div class="t" id="toastTitle">æç¤º</div>
  <div class="m" id="toastMsg"></div>
</div>

</body>
</html>
