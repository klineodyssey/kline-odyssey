<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>五指山悟空財神殿 · V4.1 FULLPACK</title>
<style>
/* WuzhiShan V4 Modular */
:root{
  --bg:#0b0f14;
  --card:#111827;
  --card2:#0f172a;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --line:#1f2937;
  --accent:#38bdf8;
  --ok:#34d399;
  --warn:#fbbf24;
  --bad:#fb7185;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC",sans-serif}
a{color:var(--accent);text-decoration:none}
.container{max-width:980px;margin:0 auto;padding:16px}
.header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
.brand{display:flex;flex-direction:column}
.brand .title{font-weight:900;font-size:18px}
.brand .sub{font-size:12px;color:var(--muted)}
.pills{display:flex;flex-wrap:wrap;gap:8px}
.pill{border:1px solid var(--line);background:rgba(255,255,255,0.02);padding:8px 10px;border-radius:999px;font-weight:700;font-size:12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{grid-column:span 12;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border:1px solid var(--line);border-radius:16px;padding:14px}
@media(min-width:860px){
  .card.span6{grid-column:span 6}
  .card.span4{grid-column:span 4}
  .card.span8{grid-column:span 8}
}
.card h2{margin:0 0 8px 0;font-size:16px}
.card p{margin:6px 0;color:var(--muted);line-height:1.4}
.btnrow{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
button,.btn{
  appearance:none;border:1px solid var(--line);
  background:rgba(255,255,255,0.04);
  color:var(--text);padding:10px 12px;border-radius:12px;
  font-weight:800;cursor:pointer;
}
button:hover,.btn:hover{border-color:rgba(56,189,248,0.55)}
button.primary{border-color:rgba(56,189,248,0.6);background:rgba(56,189,248,0.1)}
small{color:var(--muted)}
textarea#logBox{width:100%;height:180px;background:var(--card2);border:1px solid var(--line);border-radius:12px;padding:10px;color:var(--text);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;font-size:12px}
.hr{height:1px;background:var(--line);margin:12px 0}
.kv{display:grid;grid-template-columns:140px 1fr;gap:8px;font-size:13px}
.kv div:nth-child(odd){color:var(--muted)}
.toast{
  position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
  padding:10px 14px;border:1px solid var(--line);border-radius:999px;
  background:rgba(17,24,39,0.95);opacity:0;transition:opacity .25s;
  max-width:92vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.range{width:100%}
.dial{
  width:100%;height:220px;border-radius:16px;border:1px solid var(--line);
  background:radial-gradient(circle at 30% 30%, rgba(56,189,248,0.12), rgba(0,0,0,0));
  display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;
}
.needle{
  width:3px;height:92px;background:var(--accent);border-radius:999px;
  position:absolute;left:50%;top:34px;transform-origin:50% 86px;
}
.dial .label{
  position:absolute;bottom:10px;left:10px;color:var(--muted);font-size:12px
}
.badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;font-weight:800}
.badge.ok{border-color:rgba(52,211,153,0.5);color:var(--ok)}
.badge.warn{border-color:rgba(251,191,36,0.5);color:var(--warn)}
.badge.bad{border-color:rgba(251,113,133,0.5);color:var(--bad)}

</style>
<script>
// WuzhiShan V4 Modular Config
// build: 2026-02-15 15:26:17
// boot_version: v4.0.0-wuzhishan-modular

window.WUZHISHAN_CONFIG = {
  bootVersion: "v4.0.0-wuzhishan-modular",
  chain: {
    name: "BNB Chain (BSC)",
    chainIdHex: "0x38"
  },
  economics: {
    kgenIsMassAndPoint: true,
    pointEqualsKgen: true,
    leverageMin: 1,
    leverageMax: 150,
    seatPriceKgen: 5000
  },
  cockpit: {
    longMinDeg: 0,
    longMaxDeg: 170,
    restMinDeg: 170,
    restMaxDeg: 190,
    shortMinDeg: 190,
    shortMaxDeg: 360
  },
  ui: {
    enableSpeech: true, // will auto-fallback based on env
    enableDownload: true
  }
};

</script>
<script>
// WuzhiShan V4 Modular Utilities (no frameworks)
(function(){
  const pad2 = (n)=> String(n).padStart(2,'0');
  const nowIso = ()=> new Date().toISOString();
  const el = (id)=> document.getElementById(id);

  function log(msg){
    const box = el('logBox');
    const line = `[${nowIso()}] ${msg}`;
    if(box){
      box.value = (box.value ? box.value + "\n" : "") + line;
      box.scrollTop = box.scrollHeight;
    }
    console.log(line);
  }

  function clearLog(){
    const box = el('logBox');
    if(box) box.value = "";
    log("log_cleared");
  }

  function envSelfCheck(){
    const ua = navigator.userAgent || "";
    const speechSynthesisOk = !!window.speechSynthesis && typeof window.SpeechSynthesisUtterance !== "undefined";
    const speechRecognitionOk = !!(window.SpeechRecognition || window.webkitSpeechRecognition);
    const ethereumInjected = !!window.ethereum;
    const ethersLoaded = !!window.ethers;
    log(`boot_version=${(window.WUZHISHAN_CONFIG && window.WUZHISHAN_CONFIG.bootVersion) || "unknown"}`);
    log("selfcheck_start");
    log(`userAgent: ${ua}`);
    log(`speechSynthesis: ${speechSynthesisOk}`);
    log(`speechRecognition: ${speechRecognitionOk}`);
    log(`ethers_loaded_now: ${ethersLoaded}`);
    log(`ethereum_injected_now: ${ethereumInjected}`);
    return {ua, speechSynthesisOk, speechRecognitionOk, ethereumInjected, ethersLoaded};
  }

  function safeSpeak(text){
    const cfg = window.WUZHISHAN_CONFIG;
    const allow = cfg && cfg.ui && cfg.ui.enableSpeech;
    const ok = !!window.speechSynthesis && typeof window.SpeechSynthesisUtterance !== "undefined";
    if(!allow || !ok){
      log("tts_unavailable_fallback_text");
      // fallback: show in a toast-like area
      const t = el('toast');
      if(t){
        t.textContent = text;
        t.style.opacity = "1";
        setTimeout(()=>{ t.style.opacity="0"; }, 2500);
      }
      return;
    }
    try{
      const u = new SpeechSynthesisUtterance(text);
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
      log("tts_speak");
    }catch(e){
      log(`tts_error ${String(e && e.message || e)}`);
    }
  }

  async function connectWallet(){
    if(!window.ethereum){
      log("wallet_connect_failed: no ethereum");
      return null;
    }
    try{
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      const acc = accounts && accounts[0] ? accounts[0] : null;
      if(acc) log(`wallet_connected=${acc.toLowerCase()}`);
      return acc;
    }catch(e){
      log(`wallet_connect_failed: ${String(e && e.message || e)}`);
      return null;
    }
  }

  function downloadText(filename, text){
    log("export_download_try");
    try{
      const blob = new Blob([text], {type: "application/json;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      // Some WebViews block programmatic clicks unless user-initiated; still best effort.
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(()=>URL.revokeObjectURL(url), 5000);
      log(`export_download_ok ${filename}`);
      return true;
    }catch(e){
      log(`export_download_failed ${String(e && e.message || e)}`);
      return false;
    }
  }

  function saveCfg(key, val){
    try{
      localStorage.setItem(key, JSON.stringify(val));
      log("cfg_saved");
    }catch(e){
      log(`cfg_save_failed ${String(e && e.message || e)}`);
    }
  }

  function loadCfg(key, defVal){
    try{
      const s = localStorage.getItem(key);
      return s ? JSON.parse(s) : defVal;
    }catch(e){
      return defVal;
    }
  }

  function clearCfg(){
    try{
      localStorage.clear();
      log("cfg_cleared");
    }catch(e){
      log(`cfg_clear_failed ${String(e && e.message || e)}`);
    }
  }

  window.WUZ = {
    el, log, clearLog, envSelfCheck, safeSpeak,
    connectWallet, downloadText,
    saveCfg, loadCfg, clearCfg,
    pad2
  };
})();
</script>
</head>
<body>
<div class="app">
  <header class="topbar">
    <div class="brand">
      <div class="brand-title">五指山悟空財神殿 · V4.1 FULLPACK</div>
      <div class="brand-sub">外殿（點燈/許願/發財金）｜內艙（駕駛艙/下單桌）｜器官儀表（心臟/大腦/KUFO）</div>
    </div>
    <div class="nav">
      <button class="btn" data-view="home">入口</button>
      <button class="btn" data-view="temple">外殿</button>
      <button class="btn" data-view="cockpit">駕駛艙</button>
      <button class="btn" data-view="orderdesk">下單桌</button>
      <button class="btn" data-view="kufo">豪宅 KUFO</button>
      <button class="btn" data-view="brain">大腦</button>
      <button class="btn" data-view="heart">心臟</button>
      <button class="btn ghost" id="btnSelfCheck">自我檢測</button>
    </div>
  </header>

  <main class="main">
    <section class="view" id="view-home">
<div class="toast" id="toast"></div>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="title">五指山・悟空財神殿（V4 模組宇宙）</div>
      <div class="sub">boot_version: <span id="bootVer"></span> ｜ KGEN = 質量 = 指數點數</div>
    </div>
    <div class="pills">
      <div class="pill">外殿：點燈・許願・留念</div>
      <div class="pill">內艙：飛碟操控・模擬交易</div>
      <div class="pill">豪宅：5000 KGEN 入住・分紅</div>
    </div>
  </div>

<div class="grid">
  <div class="card span6">
    <h2>外殿（觀光・留念）</h2>
    <p>13 生肖 / 光明燈 / 七仙女許願 / 還願 / 發財金。這裡不牽動輸贏，只留紀錄。</p>
    <div class="btnrow">
      <a class="btn primary" href="./temple.html">進入外殿</a>
      <button onclick="WUZ.safeSpeak('外殿啟動。點燈留念，不保證財富。')">殿內口白</button>
    </div>
  </div>

  <div class="card span6">
    <h2>內艙（悟空宇宙神殿飛碟）</h2>
    <p>方向盤 0～360。0～170 多，170～190 休息，190～360 空。槓桿 1～150。燃料/血量以 KGEN 質量顯示。</p>
    <div class="btnrow">
      <a class="btn primary" href="./cockpit.html">進入駕駛艙</a>
      <a class="btn" href="./orderdesk.html">進入下單桌（模擬）</a>
    </div>
  </div>

  <div class="card span4">
    <h2>豪宅席位（股東層）</h2>
    <p>花果山火星・齊天豪宅：5000 KGEN 入住，取得分紅資格。遊戲人人可玩，豪宅是分紅層。</p>
    <div class="btnrow">
      <a class="btn primary" href="./kufo.html">進入豪宅大廳</a>
    </div>
  </div>

  <div class="card span4">
    <h2>大腦（治理・分潤層）</h2>
    <p>分潤、供血、路由、公益比例、庫存狀態。這一頁不做操控，只做透明儀表。</p>
    <div class="btnrow">
      <a class="btn" href="./brain.html">查看大腦儀表</a>
    </div>
  </div>

  <div class="card span4">
    <h2>心臟（發放・心跳）</h2>
    <p>發財金、心跳節律、供血狀態與紀錄。先以模擬為主，鏈上接管再升級。</p>
    <div class="btnrow">
      <a class="btn" href="./heart.html">查看心臟儀表</a>
    </div>
  </div>
</div>

  <div class="card">
    <h2>系統日誌</h2>
    <div class="btnrow">
      <button onclick="WUZ.clearLog()">清空</button>
      <button onclick="WUZ.envSelfCheck()">自我檢測</button>
      <button onclick="(async()=>{await WUZ.connectWallet();})()">連接錢包</button>
      <button onclick="WUZ.downloadText('wuzhishan_log_'+Date.now()+'.txt', document.getElementById('logBox').value)">下載日誌</button>
      <button onclick="WUZ.clearCfg()">清除本機設定</button>
    </div>
    <div class="hr"></div>
    <textarea id="logBox" placeholder="log..."></textarea>
    <p><small>提示：MetaMask WebView 常見 speechSynthesis=false，會自動改用文字提示，不算故障。</small></p>
  </div>
</div>
<script>
  document.getElementById('bootVer').textContent = (window.WUZHISHAN_CONFIG && window.WUZHISHAN_CONFIG.bootVersion) || 'unknown';
  // boot selfcheck
  WUZ.envSelfCheck();
</script>
    </section>
    <section class="view" id="view-temple" style="display:none">
<div class="toast" id="toast"></div>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="title">五指山・悟空財神殿（V4 模組宇宙）</div>
      <div class="sub">boot_version: <span id="bootVer"></span> ｜ KGEN = 質量 = 指數點數</div>
    </div>
    <div class="pills">
      <div class="pill">外殿：點燈・許願・留念</div>
      <div class="pill">內艙：飛碟操控・模擬交易</div>
      <div class="pill">豪宅：5000 KGEN 入住・分紅</div>
    </div>
  </div>

<div class="grid">
  <div class="card span8">
    <h2>外殿：13 生肖・光明燈（留念）</h2>
    <p>點燈會記錄在本機與可匯出 JSON。這是文化留念，不影響交易輸贏。</p>

    <div class="kv">
      <div>選擇生肖</div>
      <div>
        <select id="zodiacSel" style="width:100%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.04);border:1px solid var(--line);color:var(--text)">
          <option value="rat">鼠</option><option value="ox">牛</option><option value="tiger">虎</option><option value="rabbit">兔</option>
          <option value="dragon">龍</option><option value="snake">蛇</option><option value="horse">馬</option><option value="goat">羊</option>
          <option value="monkey" selected>猴</option><option value="rooster">雞</option><option value="dog">狗</option><option value="pig">豬</option>
          <option value="cat">貓（第13生肖）</option>
        </select>
      </div>

      <div>點燈費（KGEN）</div>
      <div><input id="lampFee" type="number" min="0" step="1" value="5" style="width:100%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.04);border:1px solid var(--line);color:var(--text)"/></div>

      <div>留名</div>
      <div><input id="nickname" type="text" placeholder="觀光客暱稱" style="width:100%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.04);border:1px solid var(--line);color:var(--text)"/></div>
    </div>

    <div class="btnrow">
      <button class="primary" onclick="templeLamp()">點光明燈</button>
      <button onclick="exportLamps()">匯出點燈紀錄 JSON</button>
      <a class="btn" href="./index.html">回主殿</a>
    </div>

    <div class="hr"></div>
    <h2>七仙女許願池（不影響輸贏）</h2>
    <p>許願/還願只記錄，不承諾結果。你可以把它當作修行日誌。</p>
    <textarea id="wishText" style="width:100%;height:90px;background:var(--card2);border:1px solid var(--line);border-radius:12px;padding:10px;color:var(--text)" placeholder="寫下你的願望..."></textarea>
    <div class="btnrow">
      <button class="primary" onclick="wishSubmit()">送出許願</button>
      <button onclick="exportWish()">匯出許願紀錄 JSON</button>
    </div>
  </div>

  <div class="card span4">
    <h2>外殿狀態</h2>
    <div id="templeStatus"></div>
  </div>
</div>

<script>
  const LAMPS_KEY = "wuz_lamps_v4";
  const WISH_KEY  = "wuz_wish_v4";

  function render(){
    const lamps = WUZ.loadCfg(LAMPS_KEY, []);
    const wishes = WUZ.loadCfg(WISH_KEY, []);
    const s = document.getElementById('templeStatus');
    s.innerHTML = `
      <div class="kv">
        <div>點燈筆數</div><div>${lamps.length}</div>
        <div>許願筆數</div><div>${wishes.length}</div>
      </div>
      <div class="hr"></div>
      <div class="badge ok">外殿運作正常</div>
    `;
  }

  function templeLamp(){
    const zodiac = document.getElementById('zodiacSel').value;
    const fee = Number(document.getElementById('lampFee').value || 0);
    const nick = (document.getElementById('nickname').value || "").trim();
    const lamps = WUZ.loadCfg(LAMPS_KEY, []);
    lamps.push({ts: Date.now(), zodiac, feeKgen: fee, nickname: nick});
    WUZ.saveCfg(LAMPS_KEY, lamps);
    WUZ.log("lamp_init");
    WUZ.safeSpeak("光明燈已點。留下的是信念，不是保證。");
    render();
  }

  function exportLamps(){
    const lamps = WUZ.loadCfg(LAMPS_KEY, []);
    WUZ.log("export_lamps_json");
    WUZ.downloadText("wuz_lamps_v4_"+Date.now()+".json", JSON.stringify({boot: WUZHISHAN_CONFIG.bootVersion, lamps}, null, 2));
  }

  function wishSubmit(){
    const txt = (document.getElementById('wishText').value || "").trim();
    if(!txt){ WUZ.safeSpeak("請先寫下願望。"); return; }
    const wishes = WUZ.loadCfg(WISH_KEY, []);
    wishes.push({ts: Date.now(), text: txt});
    WUZ.saveCfg(WISH_KEY, wishes);
    document.getElementById('wishText').value = "";
    WUZ.log("wish_submit");
    WUZ.safeSpeak("願望已封存。修行從紀律開始。");
    render();
  }

  function exportWish(){
    const wishes = WUZ.loadCfg(WISH_KEY, []);
    WUZ.log("export_wish_json");
    WUZ.downloadText("wuz_wish_v4_"+Date.now()+".json", JSON.stringify({boot: WUZHISHAN_CONFIG.bootVersion, wishes}, null, 2));
  }

  render();
  WUZ.log("fairies_loaded_to_wishpool");
</script>

  <div class="card">
    <h2>系統日誌</h2>
    <div class="btnrow">
      <button onclick="WUZ.clearLog()">清空</button>
      <button onclick="WUZ.envSelfCheck()">自我檢測</button>
      <button onclick="(async()=>{await WUZ.connectWallet();})()">連接錢包</button>
      <button onclick="WUZ.downloadText('wuzhishan_log_'+Date.now()+'.txt', document.getElementById('logBox').value)">下載日誌</button>
      <button onclick="WUZ.clearCfg()">清除本機設定</button>
    </div>
    <div class="hr"></div>
    <textarea id="logBox" placeholder="log..."></textarea>
    <p><small>提示：MetaMask WebView 常見 speechSynthesis=false，會自動改用文字提示，不算故障。</small></p>
  </div>
</div>
<script>
  document.getElementById('bootVer').textContent = (window.WUZHISHAN_CONFIG && window.WUZHISHAN_CONFIG.bootVersion) || 'unknown';
  // boot selfcheck
  WUZ.envSelfCheck();
</script>
    </section>
    <section class="view" id="view-cockpit" style="display:none">
<div class="toast" id="toast"></div>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="title">五指山・悟空財神殿（V4 模組宇宙）</div>
      <div class="sub">boot_version: <span id="bootVer"></span> ｜ KGEN = 質量 = 指數點數</div>
    </div>
    <div class="pills">
      <div class="pill">外殿：點燈・許願・留念</div>
      <div class="pill">內艙：飛碟操控・模擬交易</div>
      <div class="pill">豪宅：5000 KGEN 入住・分紅</div>
    </div>
  </div>

<div class="grid">
  <div class="card span8">
    <h2>悟空宇宙神殿飛碟（操控艙）</h2>
    <p>KGEN 質量＝燃料/血量。方向盤決定多空扇區。槓桿只影響「做功」顯示（目前為模擬）。</p>

    <div class="kv">
      <div>方向盤（度）</div>
      <div><input class="range" id="dirRange" type="range" min="0" max="360" value="120" oninput="updateDial()"></div>

      <div>槓桿（倍）</div>
      <div><input class="range" id="levRange" type="range" min="1" max="150" value="10" oninput="updateDial()"></div>

      <div>投入質量（KGEN）</div>
      <div><input id="massInput" type="number" min="0" step="1" value="30000" style="width:100%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.04);border:1px solid var(--line);color:var(--text)" oninput="updateDial()"/></div>
    </div>

    <div class="hr"></div>

    <div class="dial" id="dial">
      <div class="needle" id="needle"></div>
      <div class="label" id="zoneLabel"></div>
    </div>

    <div class="btnrow">
      <button class="primary" onclick="heartbeat()">心跳</button>
      <button onclick="breath()">呼吸</button>
      <button onclick="pressure()">壓力</button>
      <button onclick="cupThrow()">杯筊</button>
      <button onclick="fortune()">發財金（模擬）</button>
      <a class="btn" href="./index.html">回主殿</a>
    </div>
  </div>

  <div class="card span4">
    <h2>儀表</h2>
    <div id="meter"></div>
    <div class="hr"></div>
    <button onclick="exportFlight()">匯出航行紀錄 JSON</button>
  </div>
</div>

<script>
  const FLIGHT_KEY="wuz_flight_v4";

  function zoneFromDeg(d){
    const c=WUZHISHAN_CONFIG.cockpit;
    if(d>=c.longMinDeg && d<c.longMaxDeg) return {zone:"LONG", badge:"ok"};
    if(d>=c.restMinDeg && d<=c.restMaxDeg) return {zone:"REST", badge:"warn"};
    return {zone:"SHORT", badge:"bad"};
  }

  function workValue(massKgen, lev){
    // User formula idea (display only):
    // 做功 = (KGEN) * (1點200台幣*槓桿) * (CT)
    // CT as normalized control time / position -> we show CT=1 for now.
    const ct = 1;
    const twdPerPoint = 200;
    return massKgen * (twdPerPoint * lev) * ct;
  }

  function updateDial(){
    const deg = Number(document.getElementById('dirRange').value);
    const lev = Number(document.getElementById('levRange').value);
    const mass = Number(document.getElementById('massInput').value || 0);

    document.getElementById('needle').style.transform = `translateX(-50%) rotate(${deg}deg)`;
    const z = zoneFromDeg(deg);
    document.getElementById('zoneLabel').textContent = `Zone: ${z.zone} ｜ deg=${deg} ｜ lev=${lev}x`;

    const w = workValue(mass, lev);
    const fuel = mass; // fuel=mass for now
    const m = document.getElementById('meter');
    m.innerHTML = `
      <div class="kv">
        <div>燃料/血量（KGEN）</div><div>${fuel.toLocaleString()}</div>
        <div>做功（TWD顯示）</div><div>${w.toLocaleString()}</div>
      </div>
      <div class="hr"></div>
      <div class="badge ${z.badge}">${z.zone}</div>
    `;

    // save last state
    WUZ.saveCfg(FLIGHT_KEY+"_last", {deg, lev, mass});
  }

  function pushEvent(type){
    const ev = {ts: Date.now(), type};
    const log = WUZ.loadCfg(FLIGHT_KEY, []);
    log.push(ev);
    WUZ.saveCfg(FLIGHT_KEY, log);
  }

  function heartbeat(){ WUZ.log("heartbeat"); pushEvent("heartbeat"); WUZ.safeSpeak("心跳。"); }
  function breath(){ WUZ.log("breath"); pushEvent("breath"); }
  function pressure(){ WUZ.log("pressure"); pushEvent("pressure"); }
  function cupThrow(){ WUZ.log("cup_throw"); pushEvent("cup_throw"); }
  function fortune(){ WUZ.log("fortune_click"); pushEvent("fortune_click"); WUZ.safeSpeak("發財金已記錄。"); }

  function exportFlight(){
    const log = WUZ.loadCfg(FLIGHT_KEY, []);
    WUZ.downloadText("wuz_flight_v4_"+Date.now()+".json", JSON.stringify({boot: WUZHISHAN_CONFIG.bootVersion, flight: log}, null, 2));
  }

  // init
  const last = WUZ.loadCfg(FLIGHT_KEY+"_last", {deg:120, lev:10, mass:30000});
  document.getElementById('dirRange').value = last.deg;
  document.getElementById('levRange').value = last.lev;
  document.getElementById('massInput').value = last.mass;
  updateDial();
</script>

  <div class="card">
    <h2>系統日誌</h2>
    <div class="btnrow">
      <button onclick="WUZ.clearLog()">清空</button>
      <button onclick="WUZ.envSelfCheck()">自我檢測</button>
      <button onclick="(async()=>{await WUZ.connectWallet();})()">連接錢包</button>
      <button onclick="WUZ.downloadText('wuzhishan_log_'+Date.now()+'.txt', document.getElementById('logBox').value)">下載日誌</button>
      <button onclick="WUZ.clearCfg()">清除本機設定</button>
    </div>
    <div class="hr"></div>
    <textarea id="logBox" placeholder="log..."></textarea>
    <p><small>提示：MetaMask WebView 常見 speechSynthesis=false，會自動改用文字提示，不算故障。</small></p>
  </div>
</div>
<script>
  document.getElementById('bootVer').textContent = (window.WUZHISHAN_CONFIG && window.WUZHISHAN_CONFIG.bootVersion) || 'unknown';
  // boot selfcheck
  WUZ.envSelfCheck();
</script>
    </section>
    <section class="view" id="view-orderdesk" style="display:none">
<div class="toast" id="toast"></div>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="title">五指山・悟空財神殿（V4 模組宇宙）</div>
      <div class="sub">boot_version: <span id="bootVer"></span> ｜ KGEN = 質量 = 指數點數</div>
    </div>
    <div class="pills">
      <div class="pill">外殿：點燈・許願・留念</div>
      <div class="pill">內艙：飛碟操控・模擬交易</div>
      <div class="pill">豪宅：5000 KGEN 入住・分紅</div>
    </div>
  </div>

<div class="grid">
  <div class="card span8">
    <h2>下單桌（T+2 模擬）</h2>
    <p>目前不做即時鏈上下單。你用「神算天機」決策，這裡負責紀錄：日期、方向、槓桿、停利/停損、ATR14 上限。</p>

    <div class="kv">
      <div>交易日</div>
      <div><input id="tradeDate" type="date" style="width:100%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.04);border:1px solid var(--line);color:var(--text)"/></div>

      <div>方向</div>
      <div>
        <select id="sideSel" style="width:100%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.04);border:1px solid var(--line);color:var(--text)">
          <option value="LONG">多</option>
          <option value="REST">休息</option>
          <option value="SHORT">空</option>
        </select>
      </div>

      <div>槓桿</div>
      <div><input id="lev" type="number" min="1" max="150" value="10" style="width:100%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.04);border:1px solid var(--line);color:var(--text)"/></div>

      <div>投入（KGEN）</div>
      <div><input id="mass" type="number" min="0" step="1" value="1000" style="width:100%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.04);border:1px solid var(--line);color:var(--text)"/></div>

      <div>ATR14（點）</div>
      <div><input id="atr" type="number" min="1" step="1" value="144" style="width:100%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.04);border:1px solid var(--line);color:var(--text)"/></div>

      <div>停損（點）</div>
      <div><input id="sl" type="number" min="0" step="1" value="72" style="width:100%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.04);border:1px solid var(--line);color:var(--text)"/></div>

      <div>停利（點）</div>
      <div><input id="tp" type="number" min="0" step="1" value="72" style="width:100%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.04);border:1px solid var(--line);color:var(--text)"/></div>
    </div>

    <div class="btnrow">
      <button class="primary" onclick="submitOrder()">送出（模擬）</button>
      <button onclick="exportOrders()">匯出下單紀錄 JSON</button>
      <a class="btn" href="./index.html">回主殿</a>
    </div>

    <div class="hr"></div>
    <div id="ruleBox" class="card" style="background:rgba(255,255,255,0.02)">
      <h2>規則（可讀客服版）</h2>
      <p>1) 全市場統一：沒有週三結算，採交易日 T+2 結算。</p>
      <p>2) 最大贏虧限制：±ATR14 點（預設 144）。</p>
      <p>3) 若停利與停損在同一結算日同時觸發：記為 0（不算輸贏）。</p>
    </div>
  </div>

  <div class="card span4">
    <h2>下單狀態</h2>
    <div id="orderStatus"></div>
  </div>
</div>

<script>
  const ORDERS_KEY="wuz_orders_v4";

  function submitOrder(){
    const date = document.getElementById('tradeDate').value;
    const side = document.getElementById('sideSel').value;
    const lev = Number(document.getElementById('lev').value||1);
    const mass = Number(document.getElementById('mass').value||0);
    const atr = Number(document.getElementById('atr').value||144);
    const sl = Number(document.getElementById('sl').value||0);
    const tp = Number(document.getElementById('tp').value||0);

    if(!date){ WUZ.safeSpeak("請選擇交易日。"); return; }

    // validations
    const max = atr;
    const sl2 = Math.min(sl, max);
    const tp2 = Math.min(tp, max);

    const o = {ts: Date.now(), date, side, lev, mass, atr14: atr, sl: sl2, tp: tp2, settle: "T+2"};
    const orders = WUZ.loadCfg(ORDERS_KEY, []);
    orders.push(o);
    WUZ.saveCfg(ORDERS_KEY, orders);

    WUZ.log("order_submit");
    WUZ.safeSpeak("下單已封存。記住，交易是修行。");
    render();
  }

  function exportOrders(){
    const orders = WUZ.loadCfg(ORDERS_KEY, []);
    WUZ.downloadText("wuz_orders_v4_"+Date.now()+".json", JSON.stringify({boot: WUZHISHAN_CONFIG.bootVersion, orders}, null, 2));
  }

  function render(){
    const orders = WUZ.loadCfg(ORDERS_KEY, []);
    const s = document.getElementById('orderStatus');
    s.innerHTML = `
      <div class="kv">
        <div>紀錄筆數</div><div>${orders.length}</div>
        <div>結算規則</div><div>T+2</div>
      </div>
      <div class="hr"></div>
      <div class="badge ok">模擬下單正常</div>
    `;
  }
  // init date to today
  const d = new Date();
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  document.getElementById('tradeDate').value = `${yyyy}-${mm}-${dd}`;
  render();
</script>

  <div class="card">
    <h2>系統日誌</h2>
    <div class="btnrow">
      <button onclick="WUZ.clearLog()">清空</button>
      <button onclick="WUZ.envSelfCheck()">自我檢測</button>
      <button onclick="(async()=>{await WUZ.connectWallet();})()">連接錢包</button>
      <button onclick="WUZ.downloadText('wuzhishan_log_'+Date.now()+'.txt', document.getElementById('logBox').value)">下載日誌</button>
      <button onclick="WUZ.clearCfg()">清除本機設定</button>
    </div>
    <div class="hr"></div>
    <textarea id="logBox" placeholder="log..."></textarea>
    <p><small>提示：MetaMask WebView 常見 speechSynthesis=false，會自動改用文字提示，不算故障。</small></p>
  </div>
</div>
<script>
  document.getElementById('bootVer').textContent = (window.WUZHISHAN_CONFIG && window.WUZHISHAN_CONFIG.bootVersion) || 'unknown';
  // boot selfcheck
  WUZ.envSelfCheck();
</script>
    </section>
    <section class="view" id="view-kufo" style="display:none">
<div class="toast" id="toast"></div>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="title">五指山・悟空財神殿（V4 模組宇宙）</div>
      <div class="sub">boot_version: <span id="bootVer"></span> ｜ KGEN = 質量 = 指數點數</div>
    </div>
    <div class="pills">
      <div class="pill">外殿：點燈・許願・留念</div>
      <div class="pill">內艙：飛碟操控・模擬交易</div>
      <div class="pill">豪宅：5000 KGEN 入住・分紅</div>
    </div>
  </div>

<div class="grid">
  <div class="card span8">
    <h2>花果山火星・齊天豪宅（席位）</h2>
    <p>豪宅不是遊戲門票，而是分紅資格層。入住門檻：<b>5000 KGEN</b>（可調整，但建議鎖定後不改）。</p>

    <div class="kv">
      <div>席位價格</div><div><span id="seatPrice"></span> KGEN</div>
      <div>我的席位狀態</div><div id="seatStatus">未連接錢包</div>
      <div>分紅說明</div><div>豪宅層可分配宇宙回流收益（不保證、需透明規則）。</div>
    </div>

    <div class="btnrow">
      <button class="primary" onclick="buySeatMock()">繳 5000 KGEN 入住（模擬）</button>
      <button onclick="exportSeats()">匯出席位紀錄 JSON</button>
      <a class="btn" href="./index.html">回主殿</a>
    </div>

    <div class="hr"></div>
    <h2>客服指引（新手）</h2>
    <p>1) 若你沒有錢包：先安裝 MetaMask 或 Trust Wallet。</p>
    <p>2) 選擇鏈：BNB Chain（BSC / BEP20）。</p>
    <p>3) 取得 KGEN：透過 LP 或轉帳取得（注意鏈必須一致）。</p>
  </div>

  <div class="card span4">
    <h2>豪宅狀態</h2>
    <div id="kufoStatus"></div>
    <div class="hr"></div>
    <button onclick="(async()=>{const a=await WUZ.connectWallet(); if(a) render(a);})()">連接錢包並更新</button>
  </div>
</div>

<script>
  const SEATS_KEY="wuz_seats_v4";
  document.getElementById('seatPrice').textContent = WUZHISHAN_CONFIG.economics.seatPriceKgen;

  function buySeatMock(){
    // mock: mark local seat for current address (or anonymous)
    const addr = (window.__wuz_addr || "anonymous");
    const seats = WUZ.loadCfg(SEATS_KEY, {});
    seats[addr.toLowerCase()] = {ts: Date.now(), paidKgen: WUZHISHAN_CONFIG.economics.seatPriceKgen, status:"ACTIVE"};
    WUZ.saveCfg(SEATS_KEY, seats);
    WUZ.log("kufo_seat_buy_mock");
    WUZ.safeSpeak("豪宅席位已記錄。分紅是資格，不是承諾。");
    render(addr);
  }

  function exportSeats(){
    const seats = WUZ.loadCfg(SEATS_KEY, {});
    WUZ.downloadText("wuz_seats_v4_"+Date.now()+".json", JSON.stringify({boot: WUZHISHAN_CONFIG.bootVersion, seats}, null, 2));
  }

  async function render(addr){
    window.__wuz_addr = addr;
    const seats = WUZ.loadCfg(SEATS_KEY, {});
    const s = seats[(addr||"").toLowerCase()];
    document.getElementById('seatStatus').textContent = s ? "已入住（模擬）" : "未入住（模擬）";
    document.getElementById('kufoStatus').innerHTML = `
      <div class="kv">
        <div>地址</div><div>${addr}</div>
        <div>席位</div><div>${s? "ACTIVE" : "NONE"}</div>
      </div>
    `;
  }

  // auto render anonymous
  render("anonymous");
</script>

  <div class="card">
    <h2>系統日誌</h2>
    <div class="btnrow">
      <button onclick="WUZ.clearLog()">清空</button>
      <button onclick="WUZ.envSelfCheck()">自我檢測</button>
      <button onclick="(async()=>{await WUZ.connectWallet();})()">連接錢包</button>
      <button onclick="WUZ.downloadText('wuzhishan_log_'+Date.now()+'.txt', document.getElementById('logBox').value)">下載日誌</button>
      <button onclick="WUZ.clearCfg()">清除本機設定</button>
    </div>
    <div class="hr"></div>
    <textarea id="logBox" placeholder="log..."></textarea>
    <p><small>提示：MetaMask WebView 常見 speechSynthesis=false，會自動改用文字提示，不算故障。</small></p>
  </div>
</div>
<script>
  document.getElementById('bootVer').textContent = (window.WUZHISHAN_CONFIG && window.WUZHISHAN_CONFIG.bootVersion) || 'unknown';
  // boot selfcheck
  WUZ.envSelfCheck();
</script>
    </section>
    <section class="view" id="view-brain" style="display:none">
<div class="toast" id="toast"></div>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="title">五指山・悟空財神殿（V4 模組宇宙）</div>
      <div class="sub">boot_version: <span id="bootVer"></span> ｜ KGEN = 質量 = 指數點數</div>
    </div>
    <div class="pills">
      <div class="pill">外殿：點燈・許願・留念</div>
      <div class="pill">內艙：飛碟操控・模擬交易</div>
      <div class="pill">豪宅：5000 KGEN 入住・分紅</div>
    </div>
  </div>

<div class="grid">
  <div class="card span8">
    <h2>大腦儀表（治理/分潤）</h2>
    <p>這一頁不直接操控交易，只呈現透明資訊與路由規則（目前以模擬資料展示，鏈上接管後改讀合約）。</p>

    <div class="kv" id="brainKv"></div>

    <div class="btnrow">
      <button onclick="brainRefresh()">刷新</button>
      <button onclick="exportBrain()">匯出大腦狀態 JSON</button>
      <a class="btn" href="./index.html">回主殿</a>
    </div>

    <div class="hr"></div>
    <h2>分潤原則（你已定義）</h2>
    <p>profit 來源：外部真實轉入的 KGEN（稅收/收入/回流）。</p>
    <p>分配：90% 回到持有人/計畫池，10% 進 GalacticBank（宇宙國庫）。</p>
  </div>

  <div class="card span4">
    <h2>提示</h2>
    <p>大腦不要跟駕駛艙重複。駕駛艙只管操控；大腦只管分潤與路由。</p>
    <div class="badge ok">分層完成</div>
  </div>
</div>

<script>
  const BRAIN_KEY="wuz_brain_v4";

  function brainRefresh(){
    const state = {
      ts: Date.now(),
      profitKgen: 0,
      split: {toHoldersBps: 9000, toBankBps: 1000},
      routes: {bank: "KGEN_GalacticBank_V7.5.2", kufo: "KUFO_UnmannedBank", heart: "KGEN_FortuneFaucet"},
      note: "目前為模擬儀表。鏈上接管後由合約讀取。"
    };
    WUZ.saveCfg(BRAIN_KEY, state);
    render();
    WUZ.log("brain_refresh");
  }

  function render(){
    const s = WUZ.loadCfg(BRAIN_KEY, null) || {};
    const kv = document.getElementById('brainKv');
    kv.innerHTML = `
      <div>profit（KGEN）</div><div>${(s.profitKgen||0).toLocaleString()}</div>
      <div>分潤</div><div>90% / 10%（國庫）</div>
      <div>路由</div><div>bank / kufo / heart</div>
      <div>備註</div><div>${s.note||""}</div>
    `;
  }

  function exportBrain(){
    const s = WUZ.loadCfg(BRAIN_KEY, {});
    WUZ.downloadText("wuz_brain_v4_"+Date.now()+".json", JSON.stringify({boot: WUZHISHAN_CONFIG.bootVersion, brain: s}, null, 2));
  }

  brainRefresh();
</script>

  <div class="card">
    <h2>系統日誌</h2>
    <div class="btnrow">
      <button onclick="WUZ.clearLog()">清空</button>
      <button onclick="WUZ.envSelfCheck()">自我檢測</button>
      <button onclick="(async()=>{await WUZ.connectWallet();})()">連接錢包</button>
      <button onclick="WUZ.downloadText('wuzhishan_log_'+Date.now()+'.txt', document.getElementById('logBox').value)">下載日誌</button>
      <button onclick="WUZ.clearCfg()">清除本機設定</button>
    </div>
    <div class="hr"></div>
    <textarea id="logBox" placeholder="log..."></textarea>
    <p><small>提示：MetaMask WebView 常見 speechSynthesis=false，會自動改用文字提示，不算故障。</small></p>
  </div>
</div>
<script>
  document.getElementById('bootVer').textContent = (window.WUZHISHAN_CONFIG && window.WUZHISHAN_CONFIG.bootVersion) || 'unknown';
  // boot selfcheck
  WUZ.envSelfCheck();
</script>
    </section>
    <section class="view" id="view-heart" style="display:none">
<div class="toast" id="toast"></div>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="title">五指山・悟空財神殿（V4 模組宇宙）</div>
      <div class="sub">boot_version: <span id="bootVer"></span> ｜ KGEN = 質量 = 指數點數</div>
    </div>
    <div class="pills">
      <div class="pill">外殿：點燈・許願・留念</div>
      <div class="pill">內艙：飛碟操控・模擬交易</div>
      <div class="pill">豪宅：5000 KGEN 入住・分紅</div>
    </div>
  </div>

<div class="grid">
  <div class="card span8">
    <h2>心臟儀表（發財金/心跳）</h2>
    <p>心臟只做發放與節律紀錄，不做交易結算。這樣才不會「器官反噬」。</p>

    <div class="btnrow">
      <button class="primary" onclick="heartBeat()">心跳</button>
      <button onclick="ignite()">點火</button>
      <button onclick="fortune()">發放發財金（模擬）</button>
      <button onclick="exportHeart()">匯出心臟紀錄 JSON</button>
      <a class="btn" href="./index.html">回主殿</a>
    </div>

    <div class="hr"></div>
    <div id="heartStatus"></div>
  </div>

  <div class="card span4">
    <h2>說明</h2>
    <p>你要的「質量→能量」顯示，可以在心臟頁呈現轉換，但帳務仍以 KGEN 質量為準。</p>
    <div class="badge warn">帳務以質量為準</div>
  </div>
</div>

<script>
  const HEART_KEY="wuz_heart_v4";

  function push(t){
    const log = WUZ.loadCfg(HEART_KEY, []);
    log.push({ts: Date.now(), type:t});
    WUZ.saveCfg(HEART_KEY, log);
    render();
  }

  function heartBeat(){ WUZ.log("heartbeat"); push("heartbeat"); WUZ.safeSpeak("心跳。"); }
  function ignite(){ WUZ.log("ignite"); push("ignite"); WUZ.safeSpeak("點火。"); }
  function fortune(){ WUZ.log("fortune_click"); push("fortune"); WUZ.safeSpeak("發財金已記錄。"); }

  function render(){
    const log = WUZ.loadCfg(HEART_KEY, []);
    const last = log[log.length-1];
    document.getElementById('heartStatus').innerHTML = `
      <div class="kv">
        <div>事件筆數</div><div>${log.length}</div>
        <div>最近事件</div><div>${last? last.type : "-"}</div>
      </div>
      <div class="hr"></div>
      <div class="badge ok">心臟運作正常（模擬）</div>
    `;
  }

  function exportHeart(){
    const log = WUZ.loadCfg(HEART_KEY, []);
    WUZ.downloadText("wuz_heart_v4_"+Date.now()+".json", JSON.stringify({boot: WUZHISHAN_CONFIG.bootVersion, heart: log}, null, 2));
  }

  render();
</script>

  <div class="card">
    <h2>系統日誌</h2>
    <div class="btnrow">
      <button onclick="WUZ.clearLog()">清空</button>
      <button onclick="WUZ.envSelfCheck()">自我檢測</button>
      <button onclick="(async()=>{await WUZ.connectWallet();})()">連接錢包</button>
      <button onclick="WUZ.downloadText('wuzhishan_log_'+Date.now()+'.txt', document.getElementById('logBox').value)">下載日誌</button>
      <button onclick="WUZ.clearCfg()">清除本機設定</button>
    </div>
    <div class="hr"></div>
    <textarea id="logBox" placeholder="log..."></textarea>
    <p><small>提示：MetaMask WebView 常見 speechSynthesis=false，會自動改用文字提示，不算故障。</small></p>
  </div>
</div>
<script>
  document.getElementById('bootVer').textContent = (window.WUZHISHAN_CONFIG && window.WUZHISHAN_CONFIG.bootVersion) || 'unknown';
  // boot selfcheck
  WUZ.envSelfCheck();
</script>
    </section>
  </main>

  <footer class="footer">
    <div>boot_version=v4.1-fullpack</div>
  </footer>
</div>

<script>
(function(){
  const log = (window.PF && window.PF.log) ? window.PF.log : function(){};
  function show(view){
    document.querySelectorAll('.view').forEach(v=>v.style.display='none');
    const el=document.getElementById('view-'+view);
    if(el) el.style.display='';
    log('nav_view='+view);
  }
  document.querySelectorAll('[data-view]').forEach(btn=>{
    btn.addEventListener('click', ()=>show(btn.getAttribute('data-view')));
  });
  document.getElementById('btnSelfCheck')?.addEventListener('click', ()=>{
    try{
      window.PF?.selfcheck?.run?.();
    }catch(e){
      console.warn(e);
    }
  });
  show('home');
  window.PF = window.PF || {};
  window.PF.nav = {show};
})();
</script>

</body>
</html>
