<!--
æ‚Ÿç©ºè²¡ç¥å»Ÿï½œäº’å‹•å¾ªç’° V0.5ï¼ˆA è·¯ç·šï¼šå…¥å£æ°¸é å¯ç”¨ + Web3åŠ æˆï¼‰
File: /kline-odyssey/wukong-temple/index.html
Deploy: GitHub Pages

A-Design:
- å‡¡äººå±¤ï¼ˆä¸ç”¨éŒ¢åŒ…ä¹Ÿèƒ½å‹•ï¼‰ï¼šä¾†è¨ªçµ±è¨ˆã€ææ¯ã€ä¸‰è–ç­Šé–€æª»ã€å®¢æœã€åŒ¯å‡ºç´€éŒ„ã€å¿ƒè·³
- Web3 å±¤ï¼ˆæœ‰éŒ¢åŒ…æ‰é–‹ï¼‰ï¼šKGEN é¤˜é¡è®€å–ã€é‚„é¡˜è½‰å¸³ã€ï¼ˆè‹¥éƒ¨ç½²ï¼‰ç™¼è²¡é‡‘ claim()

éˆä¸Šè³‡è¨Šï¼ˆä½ å·²ä¸Šéˆï¼‰
- Network: BSC Mainnet (56)
- Token: KGEN (KLINE GENESIS) 0xBA3d3810e58735cb6813bC1CDc5458C0d71432Be
- LP Pair: 0xf36640d7327b53ba3d7fcc1d98dfc1b85574b6c2
- Vow addresses:
  - Blackhole: 0x0000000000000000000000000000000000000000
  - KUFO Engine: 0xef83804c264B47378FCf150086943B53fB90A90b
  - Public Good Treasury (Fortune Pool): 0xB73D6716005B37BEC742D64482fA26033eE1A4E1
-->

<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ‚Ÿç©ºè²¡ç¥å»Ÿï½œWukong Temple</title>
  <meta name="description" content="æ‚Ÿç©ºè²¡ç¥å»Ÿï½œäº’å‹•å¼éŠæˆ²å…¥å£ï¼šåƒè§€ã€é¸æ“‡ã€é«”é©—ï¼Œç„¶å¾Œé›¢é–‹ã€‚" />
</head>

<body>
<div style="max-width:820px;margin:22px auto;padding:16px;">

  <!-- Header -->
  <div style="margin-bottom:10px;">
    <div style="font-weight:900;font-size:22px;line-height:1.2;">ğŸ’ æ‚Ÿç©ºè²¡ç¥å»Ÿï½œWukong Temple</div>
    <div style="margin-top:6px;font-weight:800;">#æ‚Ÿç©ºæ–°æ–‡ #Kç·šè¥¿éŠè¨˜ #èŠ±æœå±±å°ç£</div>
    <div style="margin-top:8px;">
      <a href="https://klineodyssey.github.io/kline-odyssey/" target="_blank" rel="noopener"
         style="text-decoration:none;font-weight:900;">https://klineodyssey.github.io/kline-odyssey/</a>
    </div>
    <div id="envHint" style="margin-top:8px;opacity:.9;line-height:1.7;"></div>
  </div>

  <!-- Rule -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="font-weight:900;">è¦å‰‡ä¸€å¥è©±</div>
    <div style="line-height:1.8;margin-top:6px;">
      é€™è£¡æ˜¯<strong>äº’å‹•å¼éŠæˆ²å…¥å£</strong>ï¼šåƒè§€ã€é¸æ“‡ã€é«”é©—ï¼Œç„¶å¾Œé›¢é–‹ã€‚<br/>
      ä¸æ‰¿è«¾æ”¶ç›Šã€ä¸æä¾›æŠ•è³‡å»ºè­°ã€ä¸åšå›å ±ä¿è­‰ã€‚æ‰€æœ‰éˆä¸Šå‹•ä½œå¿…é ˆç”±ä½ åœ¨éŒ¢åŒ…ä¸­æŒ‰ç¢ºèªã€‚
    </div>
  </div>

  <!-- Live Pulse -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="font-weight:900;">ğŸ«€ ç”Ÿå‘½é«”å¾µï¼ˆAutopilot Pulseï¼‰</div>
    <div id="pulseInfo" style="margin-top:8px;line-height:1.9;"></div>
    <div style="opacity:.85;margin-top:6px;">
      èªªæ˜ï¼šæœ¬é è¼‰å…¥å³ã€Œå‘¼å¸+1ã€ï¼Œæ¯å°æ™‚è‡ªå‹•ã€Œå¿ƒè·³å›å ±ã€ã€‚å³ä½¿æ²’æœ‰éŒ¢åŒ…ä¹Ÿä¸€å®šæœƒå‹•ã€‚
    </div>
  </div>

  <!-- Visitors -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
      <div style="font-weight:900;">ğŸ‘£ ä¾†è¨ªäººæ•¸ï¼ˆä»Šæ—¥ / ç¸½è¨ˆï¼‰</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="btnRefreshStats"
          style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
          é‡æ–°æ•´ç†
        </button>
        <button id="btnReHit"
          style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
          å†å‘¼å¸ä¸€æ¬¡ï¼ˆæ¸¬è©¦ï¼‰
        </button>
      </div>
    </div>
    <div id="visitorInfo" style="margin-top:10px;line-height:1.9;">è¼‰å…¥ä¸­â€¦</div>
    <div id="visitorHint" style="opacity:.85;margin-top:6px;"></div>
  </div>

  <!-- Divination -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
      <div style="font-weight:900;">ğŸ¥¢ ææ¯ï¼ˆé€£çºŒ 3 æ¬¡è–ç­Šæ‰é–‹å•Ÿé ˜ç™¼è²¡é‡‘ï¼‰</div>
      <button id="btnDivination"
        style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
        ææ¯
      </button>
    </div>
    <div id="divinationInfo" style="margin-top:10px;line-height:1.9;"></div>
    <div style="opacity:.85;margin-top:6px;">
      è¦å‰‡ï¼šè–ç­Šæ©Ÿç‡ 50%ã€‚å¤±æ•—æ­¸é›¶ã€‚é€£å‹é” 3 æ‰é–‹å•Ÿã€Œé ˜ç™¼è²¡é‡‘ã€æŒ‰éˆ•ã€‚
    </div>
  </div>

  <!-- Wallet / Web3 -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
      <div style="font-weight:900;">ğŸªª Web3 éŒ¢åŒ…å±¤ï¼ˆBSC ä¸»ç¶²ï¼‰</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="btnConnect"
          style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
          é€£ç·šéŒ¢åŒ…
        </button>
        <button id="btnSpeak"
          style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
          â–¶ï¸ èªéŸ³å®¢æœ
        </button>
        <button id="btnStopSpeak"
          style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
          â¹ï¸ åœæ­¢
        </button>
      </div>
    </div>

    <div id="walletInfo" style="margin-top:10px;line-height:1.9;"></div>

    <div style="margin-top:10px;padding:10px;border:1px dashed #111;border-radius:12px;background:#fafafa;line-height:1.85;">
      <div style="font-weight:900;">ğŸ” éˆä¸Šé©—è­‰ï¼ˆBscScan / PancakeSwapï¼‰</div>
      <div style="margin-top:6px;">KGENï¼ˆKLINE GENESISï¼‰ï¼š
        <a id="linkToken" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;"></a>
      </div>
      <div style="margin-top:4px;">PancakeSwapï¼š
        <a id="linkSwap" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;">KGEN / WBNB äº¤æ˜“é </a>
      </div>
      <div style="margin-top:4px;">LP Pairï¼š
        <a id="linkLP" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;"></a>
      </div>
      <div style="margin-top:4px;">å…¬ç›Š Treasuryï¼ˆç™¼è²¡é‡‘æ± ï¼‰ï¼š
        <a id="linkTreasury" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;"></a>
      </div>
      <div style="margin-top:4px;">KUFO å¼•æ“å®¤ï¼š
        <a id="linkKufo" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;"></a>
      </div>
      <div style="margin-top:6px;opacity:.85;">
        æœ¬é ä¸æœƒæ›¿ä½ è‡ªå‹•å‡ºé‡‘ï¼Œæ‰€æœ‰éˆä¸Šå‹•ä½œéƒ½å¿…é ˆç”±ä½ åœ¨éŒ¢åŒ…ä¸­æŒ‰ç¢ºèªã€‚
      </div>
    </div>
  </div>

  <!-- Vow addresses -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="font-weight:900;">ğŸ¦ é‚„é¡˜åœ°å€ï¼ˆ3 é¸ 1ï¼‰</div>
    <div style="margin-top:8px;line-height:1.8;">
      <div style="opacity:.9;">ç¬¬ä¸‰å€‹åœ°å€ = å…¬ç›Š Treasuryï¼ˆåŒæ™‚ä¹Ÿæ˜¯ç™¼è²¡é‡‘ç™¼æ”¾æ± ï¼‰ã€‚</div>

      <div style="display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;">
        <label style="display:flex;gap:10px;align-items:flex-start;">
          <input type="radio" name="vowTarget" value="blackhole" />
          <div>
            <div style="font-weight:900;">å¾€ç”Ÿåœ°å€ï¼ˆBlackhole / 0x000â€¦0000ï¼‰</div>
            <div style="opacity:.85;">
              è³ªèƒ½è½‰æ›è±¡å¾µï¼šE=mc^2ã€ä½èƒ½ w=mghï¼›ã€Œè³ªé‡ m ä¸‹é™ã€è±¡å¾µé€šç¸®ï¼Œä½èƒ½çµæ§‹æ”¹è®Šå¸¶ä¾†åƒ¹æ ¼å ´é‡æ–°åˆ†é…ã€‚
            </div>
          </div>
        </label>

        <label style="display:flex;gap:10px;align-items:flex-start;">
          <input type="radio" name="vowTarget" value="kufo_engine" checked />
          <div>
            <div style="font-weight:900;">KUFO å¼•æ“å®¤ï¼ˆEngine Roomï¼‰</div>
            <div style="opacity:.85;">è£œæ²¹æ¨é€²ï¼šå›è£œæ•˜äº‹æ ¸å¿ƒå‹•èƒ½ï¼ˆå¼•æ“ç‡ƒæ–™ï¼‰ã€‚</div>
          </div>
        </label>

        <label style="display:flex;gap:10px;align-items:flex-start;">
          <input type="radio" name="vowTarget" value="public_good_treasury" />
          <div>
            <div style="font-weight:900;">å…¬ç›Š Treasuryï¼ˆç™¼è²¡é‡‘ç™¼æ”¾æ± ï¼‰</div>
            <div style="opacity:.85;">éœ‡ç½ã€å­¤å…’é™¢ã€è‡ªç”±æ°‘ä¸»ã€èŠ±æœå±±å­¤å…’åŸºé‡‘æ± ï¼ˆåŒæ™‚ä¹Ÿæ˜¯å‡ºé‡‘æ± ï¼‰ã€‚</div>
          </div>
        </label>
      </div>

      <div style="margin-top:10px;padding:10px;border:1px dashed #111;border-radius:12px;background:#fafafa;line-height:1.8;">
        <div style="font-weight:900;">åœ°å€ç¢ºèª</div>
        <pre id="addrPreview" style="white-space:pre-wrap;margin:8px 0 0;"></pre>
      </div>
    </div>
  </div>

  <!-- Amount -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="font-weight:900;">ğŸ§® é‚„é¡˜æ•¸é‡ï¼ˆKGENï¼‰</div>
    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <input id="inpAmount" value="1" inputmode="decimal"
        style="flex:1;min-width:220px;padding:10px;border:1px solid #111;border-radius:12px;font-weight:900;"
        placeholder="ä¾‹å¦‚ï¼š1 æˆ– 0.5" />
      <div style="opacity:.85;">æç¤ºï¼šä½ å¯æ”¹æ•¸é‡ã€‚</div>
    </div>
  </div>

  <!-- Actions -->
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;margin:14px 0;">

    <button id="btnVisit"
      style="text-align:left;cursor:pointer;padding:14px;border:1px solid #111;border-radius:14px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">ğŸ® ç™»å…¥åƒæ‹œ</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">æœ¬æ©Ÿè¨˜éŒ„ä¸€æ¬¡åƒæ‹œï¼ˆæ°¸é æœƒå‹•ï¼‰</div>
    </button>

    <a href="/kline-odyssey/bookstore/"
       style="display:block;padding:14px;border:1px solid #111;border-radius:14px;text-decoration:none;background:#fff;">
      <div style="font-weight:900;font-size:16px;">ğŸ“˜ é ˜æ›¸ï½œæ‚Ÿç©ºæ›¸åŸ</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">/kline-odyssey/bookstore/</div>
    </a>

    <button id="btnFortune"
      style="text-align:left;cursor:pointer;padding:14px;border:1px solid #111;border-radius:14px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">ğŸ§§ é ˜ç™¼è²¡é‡‘ï¼ˆéœ€ 3 æ¬¡è–ç­Šï¼‰</div>
      <div id="fortuneGateHint" style="opacity:.85;margin-top:6px;line-height:1.6;"></div>
    </button>

    <button id="btnVow"
      style="text-align:left;cursor:pointer;padding:14px;border:1px solid #111;border-radius:14px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">ğŸ™ é‚„é¡˜ï¼ˆéˆä¸Šé€å‡º KGENï¼‰</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">æœ‰éŒ¢åŒ…æ‰æœƒé€äº¤æ˜“ï¼›æ²’éŒ¢åŒ…ä¹Ÿæœƒæç¤ºã€‚</div>
    </button>

    <button id="btnExit"
      style="text-align:left;cursor:pointer;padding:14px;border:1px solid #111;border-radius:14px;background:#fff;">
      <div style="font-weight:900;font-size:16px;">ğŸšª ç™»å‡ºé›¢é–‹</div>
      <div style="opacity:.85;margin-top:6px;line-height:1.6;">æœ¬æ©Ÿè¨˜éŒ„ä¸€æ¬¡é›¢é–‹</div>
    </button>

  </div>

  <!-- Local status -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="font-weight:900;">ğŸ“œ æœ¬æ©Ÿç´€éŒ„ï¼ˆå¯åŒ¯å‡ºï¼‰</div>
    <div id="statusText" style="margin-top:8px;line-height:1.9;"></div>
    <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;">
      <button id="btnExport"
        style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
        â¬‡ï¸ åŒ¯å‡ºç´€éŒ„ JSON
      </button>
      <button id="btnClear"
        style="cursor:pointer;padding:10px 12px;border:1px solid #111;border-radius:999px;background:#fff;font-weight:900;">
        ğŸ§¹ æ¸…é™¤æœ¬æ©Ÿç´€éŒ„
      </button>
    </div>
    <div id="toast" style="margin-top:10px;font-weight:900;"></div>
  </div>

  <!-- Debug -->
  <div style="border:1px solid #111;border-radius:14px;padding:12px;background:#fff;margin:12px 0;">
    <div style="font-weight:900;">ğŸ§ª Debugï¼ˆé‡åˆ°ã€Œéƒ½æ²’åæ‡‰ã€å…ˆçœ‹é€™è£¡ï¼‰</div>
    <div id="debugBox" style="margin-top:8px;white-space:pre-wrap;line-height:1.7;"></div>
    <div style="opacity:.85;margin-top:6px;">
      åªè¦é€™è£¡æœ‰æ–‡å­—ï¼Œå°±ä»£è¡¨ JS æœ‰åœ¨è·‘ï¼›å¦‚æœå…¨ç©ºï¼Œè¡¨ç¤ºä½ è²¼çš„æª”æ¡ˆè¢«æˆªæ–·æˆ– script æ²’è¼‰å…¥ã€‚
    </div>
  </div>

  <!-- Footer -->
  <div style="margin-top:14px;padding-top:12px;border-top:1px solid #111;line-height:1.8;">
    PrimeForge ä»¥æ¯æ©Ÿä¹‹åï¼Œé–‹å•Ÿé‡‘èç”Ÿå‘½ã€‚<br/>
    èŠ±æœå±±å°ç£ãƒ»ä¿¡å¿µä¸æ»…ãƒ»å¸‚å ´ç„¡ç•Œã€‚<br/>
    Where the Market Becomes the Myth.<br/>
    â€”â€” æ¨‚å¤©å¸ âŒ–
  </div>

</div>

<!-- ethers v5 (Web3 helper) -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
(() => {
  "use strict";

  // =========================
  // Autopilot: constants (LOCKED)
  // =========================
  const VOW_ADDR = {
    blackhole: "0x0000000000000000000000000000000000000000",
    kufo_engine: "0xef83804c264B47378FCf150086943B53fB90A90b",
    public_good_treasury: "0xB73D6716005B37BEC742D64482fA26033eE1A4E1"
  };
  const FORTUNE_TREASURY = VOW_ADDR.public_good_treasury;

  const CHAIN_ID_DEC = 56; // BSC mainnet
  const KGEN_TOKEN   = "0xBA3d3810e58735cb6813bC1CDc5458C0d71432Be"; // KGEN (KLINE GENESIS)
  const KGEN_DECIMALS = 18;
  const LP_PAIR = "0xf36640d7327b53ba3d7fcc1d98dfc1b85574b6c2";

  // å°šæœªéƒ¨ç½²ç™¼æ”¾åˆç´„å°±ç•™ç©ºï¼›ç•™ç©ºä¹Ÿä¸æœƒæ­»
  const FAUCET_CONTRACT = ""; // ä¾‹å¦‚ï¼š"0x...."

  // CountAPI (backend-less counter for GitHub Pages)
  const COUNT_NS = "klineodyssey-wukong-temple";
  const dayKey = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `day_${yyyy}${mm}${dd}`;
  };

  // Local storage keys
  const KEY = "klineodyssey_wukongTemple_v0_5";
  const PULSE_KEY = "klineodyssey_wukongTemple_pulse_v0_5";

  // =========================
  // Utils
  // =========================
  const $ = (id) => document.getElementById(id);
  const safeParse = (s) => { try { return JSON.parse(s); } catch { return null; } };
  const nowISO = () => new Date().toISOString();
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  const debug = (msg) => {
    const box = $("debugBox");
    if (!box) return;
    const t = `[${new Date().toLocaleString()}] ${msg}\n`;
    box.textContent = (box.textContent || "") + t;
  };

  const toast = (msg) => {
    const el = $("toast");
    if (!el) return;
    el.textContent = msg;
    setTimeout(() => { if (el.textContent === msg) el.textContent = ""; }, 3000);
  };

  const isInApp = () => {
    const ua = navigator.userAgent || "";
    const hit = /(FBAN|FBAV|Instagram|Line|MicroMessenger|WebView)/i.test(ua);
    return hit;
  };

  // =========================
  // CountAPI + fallback
  // =========================
  const countapi = {
    hit: async (key) => {
      const url = `https://api.countapi.xyz/hit/${encodeURIComponent(COUNT_NS)}/${encodeURIComponent(key)}`;
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error("countapi_hit_failed");
      return await r.json();
    },
    get: async (key) => {
      const url = `https://api.countapi.xyz/get/${encodeURIComponent(COUNT_NS)}/${encodeURIComponent(key)}`;
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error("countapi_get_failed");
      return await r.json();
    }
  };

  const renderVisitors = (todayVal, totalVal, note) => {
    $("visitorInfo").innerHTML = `
      <div>ğŸ“… ä»Šæ—¥ä¾†è¨ªï¼š<strong>${todayVal}</strong></div>
      <div>ğŸŒ ç¸½ä¾†è¨ªï¼š<strong>${totalVal}</strong></div>
    `;
    $("visitorHint").textContent = note || "";
  };

  const localVisitorFallback = (doHit) => {
    const kDay = "local_visit_" + dayKey();
    const kTotal = "local_visit_total";
    const get = (k) => Number(localStorage.getItem(k) || "0");
    const set = (k, v) => localStorage.setItem(k, String(v));
    let day = get(kDay);
    let total = get(kTotal);
    if (doHit) { day += 1; total += 1; set(kDay, day); set(kTotal, total); }
    renderVisitors(day, total, "ï¼ˆæç¤ºï¼šå¤–éƒ¨çµ±è¨ˆè¢«é˜»æ“‹ï¼Œå·²æ”¹ç”¨æœ¬æ©Ÿçµ±è¨ˆ fallbackã€‚ï¼‰");
  };

  const refreshVisitors = async (doHit) => {
    try {
      const dk = dayKey();
      if (doHit) {
        const [t1, t2] = await Promise.all([countapi.hit(dk), countapi.hit("total")]);
        renderVisitors(t1.value ?? 0, t2.value ?? 0, "ï¼ˆä¾†æºï¼šCountAPI å¾Œç«¯çµ±è¨ˆï¼‰");
      } else {
        const [g1, g2] = await Promise.all([countapi.get(dk), countapi.get("total")]);
        renderVisitors(g1.value ?? 0, g2.value ?? 0, "ï¼ˆä¾†æºï¼šCountAPI å¾Œç«¯çµ±è¨ˆï¼‰");
      }
    } catch (e) {
      debug("Visitors: CountAPI failed -> fallback");
      localVisitorFallback(doHit);
    }
  };

  // =========================
  // Local state (always alive)
  // =========================
  const defaultState = () => ({
    visitCount: 0,
    exitCount: 0,
    vowCount: 0,
    fortuneCount: 0,
    divinationStreak: 0,
    log: []
  });

  const load = () => {
    const raw = localStorage.getItem(KEY);
    const p = raw ? safeParse(raw) : null;
    return p && typeof p === "object"
      ? { ...defaultState(), ...p, log: Array.isArray(p.log) ? p.log : [] }
      : defaultState();
  };

  const save = (s) => localStorage.setItem(KEY, JSON.stringify(s));

  const pushLog = (s, type, meta = {}) => {
    s.log.push({ type, time: nowISO(), ...meta });
    if (s.log.length > 500) s.log = s.log.slice(-500);
  };

  const renderLocal = () => {
    const s = load();
    $("statusText").innerHTML = `
      <div>ğŸ® åƒæ‹œï¼š<strong>${s.visitCount}</strong> æ¬¡</div>
      <div>ğŸ¥¢ è–ç­Šé€£å‹ï¼š<strong>${s.divinationStreak}</strong> æ¬¡ï¼ˆéœ€ 3 æ¬¡ï¼‰</div>
      <div>ğŸ§§ ç™¼è²¡é‡‘ï¼ˆæŒ‰éˆ•è§¸ç™¼ï¼‰ï¼š<strong>${s.fortuneCount}</strong> æ¬¡</div>
      <div>ğŸ™ é‚„é¡˜ï¼ˆæŒ‰éˆ•è§¸ç™¼ï¼‰ï¼š<strong>${s.vowCount}</strong> æ¬¡</div>
      <div>ğŸšª ç™»å‡ºï¼š<strong>${s.exitCount}</strong> æ¬¡</div>
      <div style="margin-top:8px;opacity:.85;">ï¼ˆæœ¬æ©Ÿç´€éŒ„æ°¸é å¯ç”¨ï¼›éˆä¸Šäº¤æ˜“ç”±éŒ¢åŒ…ç¢ºèªã€‚ï¼‰</div>
    `;
  };

  // =========================
  // Divination gate (3 yes in a row)
  // =========================
  const NEED = 3;

  const renderDivination = () => {
    const s = load();
    const n = s.divinationStreak || 0;
    const left = Math.max(0, NEED - n);
    $("divinationInfo").innerHTML = `
      <div>ç›®å‰é€£çºŒè–ç­Šï¼š<strong>${n}</strong> æ¬¡</div>
      <div>é ˜ç™¼è²¡é‡‘é–€æª»ï¼š<strong>${NEED}</strong> æ¬¡</div>
      <div style="margin-top:6px;opacity:.85;">${left === 0 ? "âœ… å·²é”é–€æª»ï¼šå¯ä»¥æŒ‰ã€Œé ˜ç™¼è²¡é‡‘ã€" : `è·é›¢é–€æª»ï¼šé‚„å·® ${left} æ¬¡`}</div>
    `;

    const gate = $("fortuneGateHint");
    const btn = $("btnFortune");

    if (left === 0) {
      gate.textContent = FAUCET_CONTRACT
        ? "å·²é”é–€æª»ï¼šå¯é ˜ç™¼è²¡é‡‘ï¼ˆæœƒå‘¼å«ç™¼æ”¾åˆç´„ claimï¼‰"
        : "å·²é”é–€æª»ï¼šä½†å°šæœªéƒ¨ç½²ç™¼æ”¾åˆç´„ï¼ˆç›®å‰åªæœƒæç¤ºï¼Œä¸æœƒå‡å‡ºé‡‘ï¼‰";
      btn.style.opacity = "1";
    } else {
      gate.textContent = "æœªé”é–€æª»ï¼šè«‹å…ˆææ¯é€£å‹ 3 æ¬¡";
      btn.style.opacity = "0.75";
    }
  };

  const chance = (p) => Math.random() < p;

  $("btnDivination").addEventListener("click", () => {
    const s = load();
    const ok = chance(0.5);
    if (ok) {
      s.divinationStreak = (s.divinationStreak || 0) + 1;
      pushLog(s, "divination_yes", { streak: s.divinationStreak });
      toast(`ğŸ¥¢ è–ç­Š +1ï¼ˆé€£å‹ ${s.divinationStreak}ï¼‰`);
    } else {
      pushLog(s, "divination_no", { streak_before: s.divinationStreak || 0 });
      s.divinationStreak = 0;
      toast("ğŸ¥¢ éè–ç­Šï¼ˆæ­¸é›¶ï¼‰");
    }
    save(s);
    renderDivination();
    renderLocal();
  });

  // =========================
  // Voiceå®¢æœ (works even without wallet)
  // =========================
  const speakText = (text) => {
    try {
      if (!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "zh-TW";
      u.rate = 1.0;
      window.speechSynthesis.speak(u);
    } catch {}
  };
  const stopSpeak = () => { try { if ("speechSynthesis" in window) window.speechSynthesis.cancel(); } catch {} };

  $("btnSpeak").addEventListener("click", () => {
    const s = load();
    const text =
      "æ­¡è¿ä¾†åˆ°äº”æŒ‡å±±æ‚Ÿç©ºè²¡ç¥å»Ÿã€‚é€™è£¡æ˜¯äº’å‹•å¼éŠæˆ²å…¥å£ï¼Œä¸æ˜¯æŠ•è³‡å¹³å°ã€‚"+
      "ä½ éœ€è¦é€£çºŒä¸‰æ¬¡è–ç­Šï¼Œæ‰èƒ½é ˜ç™¼è²¡é‡‘ã€‚"+
      "é‚„é¡˜æ˜¯æ„Ÿæ©ï¼Œä¹Ÿæ˜¯è£œæ²¹ã€‚ä½ å¯ä»¥é¸ï¼šå¾€ç”Ÿåœ°å€ã€KUFO å¼•æ“å®¤ã€æˆ–å›è£œå…¬ç›Š Treasuryã€‚"+
      `ä½ ç›®å‰è–ç­Šé€£å‹æ˜¯ ${s.divinationStreak || 0} æ¬¡ã€‚`;
    speakText(text);
    toast("ğŸ§ èªéŸ³å®¢æœå·²å•Ÿå‹•");
  });

  $("btnStopSpeak").addEventListener("click", () => {
    stopSpeak();
    toast("â¹ï¸ å·²åœæ­¢èªéŸ³");
  });

  // =========================
  // Web3 (only if wallet exists)
  // =========================
  let provider = null;
  let signer = null;
  let userAddr = null;

  const ERC20_ABI = [
    "function balanceOf(address) view returns (uint256)",
    "function transfer(address to, uint256 amount) returns (bool)"
  ];

  const FAUCET_ABI = [
    "function claim() external",
    "function treasury() view returns (address)",
    "function token() view returns (address)"
  ];

  const fmt = (bn) => {
    try { return ethers.utils.formatUnits(bn, KGEN_DECIMALS); } catch { return String(bn); }
  };

  const ensureChain = async () => {
    if (!window.ethereum) throw new Error("no_wallet");
    const wantHex = "0x" + CHAIN_ID_DEC.toString(16);
    const cur = await window.ethereum.request({ method: "eth_chainId" });
    if (cur !== wantHex) {
      await window.ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: wantHex }] });
    }
  };

  const renderWallet = async () => {
    if (!userAddr) {
      const tip = window.ethereum
        ? "æç¤ºï¼šæŒ‰ã€Œé€£ç·šéŒ¢åŒ…ã€å³å¯é–‹å•Ÿéˆä¸Šäº’å‹•ã€‚"
        : "æç¤ºï¼šä½ ç¾åœ¨å¯èƒ½ç”¨ FB/LINE å…§å»ºç€è¦½å™¨ï¼Œé€šå¸¸æ²’æœ‰éŒ¢åŒ…æ³¨å…¥ã€‚è«‹ç”¨ MetaMask/TrustWallet å…§å»ºç€è¦½å™¨é–‹å•Ÿã€‚";
      $("walletInfo").innerHTML = `<div>æœªé€£ç·š</div><div style="opacity:.85;">${tip}</div>`;
      return;
    }

    const lines = [];
    lines.push(`<div>å·²é€£ç·šï¼š<strong>${userAddr}</strong></div>`);
    try {
      const token = new ethers.Contract(KGEN_TOKEN, ERC20_ABI, provider);
      const [uBal, tBal] = await Promise.all([
        token.balanceOf(userAddr),
        token.balanceOf(FORTUNE_TREASURY)
      ]);
      lines.push(`<div>KGENï¼ˆKLINE GENESISï¼‰é¤˜é¡ï¼ˆä½ ï¼‰ï¼š<strong>${fmt(uBal)}</strong></div>`);
      lines.push(`<div>KGENï¼ˆKLINE GENESISï¼‰é¤˜é¡ï¼ˆå…¬ç›Š Treasuryï¼‰ï¼š<strong>${fmt(tBal)}</strong></div>`);
      lines.push(`<div style="opacity:.85;margin-top:6px;">ï¼ˆéˆä¸Šå¯é©—è­‰ï¼šä¸æ˜¯è¨˜å¿µå¹£æ­»é ã€‚ï¼‰</div>`);
    } catch (e) {
      debug("Wallet read failed: " + (e && e.message ? e.message : String(e)));
      lines.push(`<div style="opacity:.85;">è®€å–é¤˜é¡å¤±æ•—ï¼šè«‹ç¢ºèªå·²åˆ‡åˆ° BSC ä¸»ç¶²ã€‚</div>`);
    }
    $("walletInfo").innerHTML = lines.join("");
  };

  $("btnConnect").addEventListener("click", async () => {
    try {
      if (!window.ethereum) {
        toast("æ‰¾ä¸åˆ°éŒ¢åŒ…ï¼šè«‹ç”¨ MetaMask / Trust Wallet å…§å»ºç€è¦½å™¨é–‹å•Ÿ");
        debug("No window.ethereum detected");
        return;
      }
      await ensureChain();
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      userAddr = await signer.getAddress();
      toast("âœ… éŒ¢åŒ…å·²é€£ç·šï¼ˆBSC ä¸»ç¶²ï¼‰");
      debug("Wallet connected: " + userAddr);
      await renderWallet();
    } catch (e) {
      debug("Connect failed: " + (e && e.message ? e.message : String(e)));
      toast("é€£ç·šå¤±æ•—æˆ–æœªæˆæ¬Š");
    }
  });

  const getSelectedVowKey = () => {
    const el = document.querySelector('input[name="vowTarget"]:checked');
    return el ? el.value : "kufo_engine";
  };

  // Vow transfer
  $("btnVow").addEventListener("click", async () => {
    const s = load();
    s.vowCount += 1;
    pushLog(s, "vow_click", { addr: userAddr || null });
    save(s);
    renderLocal();

    if (!window.ethereum) { toast("ä½ ç¾åœ¨æ²’æœ‰éŒ¢åŒ…ç’°å¢ƒï¼ˆè«‹ç”¨éŒ¢åŒ…ç€è¦½å™¨é–‹å•Ÿï¼‰"); return; }
    if (!signer || !userAddr) { toast("è«‹å…ˆé€£ç·šéŒ¢åŒ…"); return; }

    const amtStr = String(($("inpAmount").value || "1")).trim();
    if (!amtStr || isNaN(Number(amtStr)) || Number(amtStr) <= 0) { toast("è«‹è¼¸å…¥æ­£ç¢ºæ•¸é‡"); return; }

    const key = getSelectedVowKey();
    const to = VOW_ADDR[key];
    try {
      await ensureChain();
      const token = new ethers.Contract(KGEN_TOKEN, ERC20_ABI, signer);
      const amount = ethers.utils.parseUnits(amtStr, KGEN_DECIMALS);
      const tx = await token.transfer(to, amount);
      toast("ğŸ™ å·²é€å‡ºé‚„é¡˜äº¤æ˜“ï¼ˆè«‹åˆ°éŒ¢åŒ…ç¢ºèª/ç­‰å¾…ä¸Šéˆï¼‰");
      pushLog(s, "vow_tx", { from: userAddr, to_key: key, to, amount: amtStr, hash: tx.hash });
      save(s);
      debug("Vow tx: " + tx.hash);
      await renderWallet();
    } catch (e) {
      debug("Vow failed: " + (e && e.message ? e.message : String(e)));
      toast("é‚„é¡˜å¤±æ•—ï¼ˆå¯èƒ½é¤˜é¡ä¸è¶³ã€æœªæˆæ¬Šã€æˆ–éˆä¸å°ï¼‰");
    }
  });

  // Fortune claim (only if 3 streak and faucet exists)
  $("btnFortune").addEventListener("click", async () => {
    const s = load();
    s.fortuneCount += 1;
    pushLog(s, "fortune_click", { addr: userAddr || null, streak: s.divinationStreak || 0 });
    save(s);
    renderLocal();

    if ((s.divinationStreak || 0) < NEED) {
      toast("æœªé”é–€æª»ï¼šè«‹å…ˆææ¯é€£å‹ 3 æ¬¡");
      return;
    }

    if (!FAUCET_CONTRACT) {
      toast("å·²é”é–€æª»ï¼Œä½†å°šæœªéƒ¨ç½²ç™¼æ”¾åˆç´„ï¼ˆæœ¬é ä¸åšå‡å‡ºé‡‘ï¼‰");
      return;
    }

    if (!window.ethereum) { toast("ä½ ç¾åœ¨æ²’æœ‰éŒ¢åŒ…ç’°å¢ƒï¼ˆè«‹ç”¨éŒ¢åŒ…ç€è¦½å™¨é–‹å•Ÿï¼‰"); return; }
    if (!signer || !userAddr) { toast("è«‹å…ˆé€£ç·šéŒ¢åŒ…"); return; }

    try {
      await ensureChain();
      const faucet = new ethers.Contract(FAUCET_CONTRACT, FAUCET_ABI, signer);
      const tx = await faucet.claim();
      toast("ğŸ§§ å·²é€å‡ºç™¼æ”¾äº¤æ˜“ï¼ˆè«‹åˆ°éŒ¢åŒ…ç¢ºèª/ç­‰å¾…ä¸Šéˆï¼‰");
      pushLog(s, "fortune_claim_tx", { hash: tx.hash });
      save(s);
      debug("Claim tx: " + tx.hash);
      await renderWallet();
    } catch (e) {
      debug("Claim failed: " + (e && e.message ? e.message : String(e)));
      toast("ç™¼æ”¾å¤±æ•—ï¼ˆåˆç´„/æ¬Šé™/éˆè¨­å®šå¯èƒ½ä¸ç¬¦ï¼‰");
    }
  });

  // Visit / Exit (always alive)
  $("btnVisit").addEventListener("click", () => {
    const s = load();
    s.visitCount += 1;
    pushLog(s, "visit", { addr: userAddr || null });
    save(s);
    renderLocal();
    toast("âœ… å·²åƒæ‹œï¼ˆæœ¬æ©Ÿå·²è¨˜éŒ„ï¼‰");
  });

  $("btnExit").addEventListener("click", () => {
    const s = load();
    s.exitCount += 1;
    pushLog(s, "exit", { addr: userAddr || null });
    save(s);
    renderLocal();
    toast("ğŸšª å·²ç™»å‡ºï¼ˆæœ¬æ©Ÿå·²è¨˜éŒ„ï¼‰");
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  // Export / Clear
  $("btnExport").addEventListener("click", () => {
    const s = load();
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    const filename = `wukong-temple-log_${yyyy}${mm}${dd}.json`;
    const blob = new Blob([JSON.stringify(s, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast("â¬‡ï¸ å·²åŒ¯å‡º JSON");
  });

  $("btnClear").addEventListener("click", () => {
    const ok = confirm("ç¢ºå®šæ¸…é™¤æœ¬æ©Ÿç´€éŒ„ï¼Ÿåªæœƒæ¸…ä½ çš„ç€è¦½å™¨ã€‚");
    if (!ok) return;
    localStorage.removeItem(KEY);
    renderLocal();
    renderDivination();
    toast("ğŸ§¹ å·²æ¸…é™¤æœ¬æ©Ÿç´€éŒ„");
  });

  // Visitor buttons
  $("btnRefreshStats").addEventListener("click", async () => {
    await refreshVisitors(false);
    toast("å·²æ›´æ–°ä¾†è¨ªçµ±è¨ˆ");
  });
  $("btnReHit").addEventListener("click", async () => {
    await refreshVisitors(true);
    toast("å·²å†å‘¼å¸ä¸€æ¬¡ï¼ˆæ¸¬è©¦ï¼‰");
  });

  // =========================
  // Autopilot pulse: breath + heartbeat
  // =========================
  const pulseDefault = () => ({
    bootCount: 0,
    lastBootAt: null,
    heartbeatCount: 0,
    lastHeartbeatAt: null
  });

  const pulseLoad = () => {
    const raw = localStorage.getItem(PULSE_KEY);
    const p = raw ? safeParse(raw) : null;
    return p && typeof p === "object" ? { ...pulseDefault(), ...p } : pulseDefault();
  };

  const pulseSave = (p) => localStorage.setItem(PULSE_KEY, JSON.stringify(p));

  const renderPulse = () => {
    const p = pulseLoad();
    $("pulseInfo").innerHTML = `
      <div>å‘¼å¸ï¼ˆBoot/Loadï¼‰ï¼š<strong>${p.bootCount}</strong> æ¬¡</div>
      <div>ä¸Šæ¬¡å‘¼å¸ï¼š<strong>${p.lastBootAt || "-"}</strong></div>
      <div>å¿ƒè·³ï¼ˆHourlyï¼‰ï¼š<strong>${p.heartbeatCount}</strong> æ¬¡</div>
      <div>ä¸Šæ¬¡å¿ƒè·³ï¼š<strong>${p.lastHeartbeatAt || "-"}</strong></div>
    `;
  };

  const doBreath = () => {
    const p = pulseLoad();
    p.bootCount += 1;
    p.lastBootAt = nowISO();
    pulseSave(p);
    renderPulse();
  };

  const doHeartbeat = () => {
    const p = pulseLoad();
    p.heartbeatCount += 1;
    p.lastHeartbeatAt = nowISO();
    pulseSave(p);
    renderPulse();
  };

  // =========================
  // Init: links, previews, environment hints
  // =========================
  $("addrPreview").textContent =
`blackhole (å¾€ç”Ÿ): ${VOW_ADDR.blackhole}
kufo_engine: ${VOW_ADDR.kufo_engine}
public_good_treasury (ç™¼è²¡é‡‘æ± ): ${VOW_ADDR.public_good_treasury}
fortune_treasury: ${FORTUNE_TREASURY}`;

  const mkBscAddr = (addr) => `https://bscscan.com/address/${addr}`;
  const mkBscToken = (addr) => `https://bscscan.com/token/${addr}`;

  $("linkToken").textContent = KGEN_TOKEN;
  $("linkToken").href = mkBscToken(KGEN_TOKEN);

  $("linkSwap").href = `https://pancakeswap.finance/swap?outputCurrency=${KGEN_TOKEN}`;

  $("linkLP").textContent = LP_PAIR;
  $("linkLP").href = mkBscAddr(LP_PAIR);

  $("linkTreasury").textContent = FORTUNE_TREASURY;
  $("linkTreasury").href = mkBscAddr(FORTUNE_TREASURY);

  $("linkKufo").textContent = VOW_ADDR.kufo_engine;
  $("linkKufo").href = mkBscAddr(VOW_ADDR.kufo_engine);

  // Environment hint
  const env = $("envHint");
  const inapp = isInApp();
  if (inapp) {
    env.innerHTML =
      `âš ï¸ ä½ å¯èƒ½æ­£åœ¨ç”¨ã€Œç¤¾ç¾¤å…§å»ºç€è¦½å™¨ã€ï¼ˆFB/LINE/IGï¼‰ã€‚<br/>`+
      `ä¾†è¨ªã€ææ¯ã€ç´€éŒ„éƒ½æœƒæ­£å¸¸é‹ä½œï¼›ä½† Web3 éŒ¢åŒ…åŠŸèƒ½é€šå¸¸ä¸æœƒæ³¨å…¥ã€‚<br/>`+
      `è¦éˆä¸Šäº’å‹•è«‹ç”¨ MetaMask / Trust Wallet å…§å»ºç€è¦½å™¨é–‹å•Ÿæ­¤é ã€‚`;
  } else {
    env.innerHTML = `âœ… å…¥å£å±¤å·²å•Ÿå‹•ï¼šä¸ç”¨éŒ¢åŒ…ä¹Ÿæœƒæ­£å¸¸é‹ä½œï¼›æœ‰éŒ¢åŒ…å†é–‹å•Ÿéˆä¸Šäº’å‹•ã€‚`;
  }

  // =========================
  // Boot sequence (Autopilot)
  // =========================
  debug("Boot: V0.5 loaded");

  doBreath();                 // local breath counter
  refreshVisitors(true);      // global breath (+1)

  renderLocal();
  renderDivination();
  renderWallet();
  renderPulse();

  // Heartbeat: every hour (plus immediate warm-up after 2 sec)
  setTimeout(() => { doHeartbeat(); debug("Heartbeat: warm-up"); }, 2000);

  setInterval(async () => {
    doHeartbeat();
    debug("Heartbeat: hourly tick");
    // optional: refresh stats without increment
    await refreshVisitors(false);
  }, 60 * 60 * 1000);

})();
</script>

</body>
</html>
