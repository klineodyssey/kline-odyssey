<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>五指山・悟空財神殿</title>
  <meta name="description" content="五指山・悟空財神殿｜互動式遊戲入口：參觀、選擇、體驗，然後離開。" />
  <style>
    :root { --bd:#111; --bg:#fff; --soft:#f3f3f3; }
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial; background:#fff; color:#111; }
    .wrap { max-width:920px; margin:18px auto; padding:16px; }
    .card { border:1px solid var(--bd); border-radius:16px; padding:14px; background:var(--bg); }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn { cursor:pointer; padding:10px 14px; border:1px solid var(--bd); border-radius:999px; background:var(--bg); font-weight:900; }
    .btn:disabled { cursor:not-allowed; background:var(--soft); }
    .dash { margin-top:8px; min-height:46px; padding:10px; border:1px dashed var(--bd); border-radius:12px; background:#fff; white-space:pre-wrap; }
    .hint { opacity:.82; font-size:12px; line-height:1.5; }
    .mono { font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .addr { word-break:break-all; }
    #dbgPanel {
      position:fixed; right:14px; top:14px; z-index:99999;
      width:min(440px, 92vw); background:rgba(0,0,0,.86); color:#fff;
      border-radius:14px; padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.35);
      font-size:12px; line-height:1.4; display:none;
    }
    #dbgPanel pre {
      margin:10px 0 0 0; white-space:pre-wrap; word-break:break-word;
      max-height:44vh; overflow:auto; background:rgba(255,255,255,.06);
      padding:10px; border-radius:12px;
    }
    #dbgPanel button { border:0; border-radius:10px; padding:6px 10px; font-weight:900; cursor:pointer; }
    .tag { display:inline-block; padding:6px 10px; border:1px solid #111; border-radius:999px; font-weight:900; }
    .grid { display:grid; gap:10px; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); }
    .zbtn { text-align:center; padding:10px; border:1px solid #111; border-radius:14px; font-weight:900; background:#fff; cursor:pointer; }
    .zbtn:hover { background:#f6f6f6; }
  </style>
</head>
<body>

<div style="position:sticky; top:10px; z-index:9999; display:flex; justify-content:flex-end; margin:10px 0;">
  <a href="https://klineodyssey.github.io/kline-odyssey/"
     target="_blank" rel="noopener"
     style="display:inline-flex; align-items:center; gap:8px;
            padding:10px 14px; border-radius:999px;
            font-weight:900; text-decoration:none;
            border:1px solid #111; background:#fff;">
    Official Website
  </a>
</div>

<div class="wrap">
  <div style="margin-bottom:12px;">
    <div style="font-weight:900;font-size:22px;line-height:1.2;">五指山・悟空財神殿</div>
    <div style="margin-top:6px;" class="row">
      <span class="tag">#K線西遊記</span>
      <span class="tag">#花果山台灣</span>
      <span class="tag">#悟空心跳</span>
    </div>
    <div class="hint" style="margin-top:8px;">
      Version：<b class="mono" id="verText"></b>
      Build：<span class="mono" id="buildText"></span>
    </div>
    <div class="row" style="margin-top:10px;">
      <button id="btnToggleDebug" class="btn">Debug</button>
      <button id="btnSelfCheck" class="btn">SelfCheck</button>
      <button id="btnGuide" class="btn">新手導覽</button>
    </div>
  </div>

  <div class="card">
    <div style="font-weight:900;">宇宙生命徵象（Cosmic Vitals）</div>
    <div class="hint" style="margin-top:6px;">
      規則：聖筊機率 50%。失敗歸零。連勝達 3 才開啟領發財金按鈕（若合約未接上仍會顯示未啟用）。
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="btnHeartbeat" class="btn">心跳</button>
      <button id="btnBreath" class="btn">呼吸</button>
      <button id="btnPressure" class="btn">血壓</button>
      <button id="btnDivination" class="btn">擲筊（50%）</button>
      <button id="btnFortune" class="btn" disabled>領發財金（需合約）</button>
    </div>

    <div id="vitalsInfo" style="margin-top:10px;line-height:1.9;"></div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div style="font-weight:900;">12 生肖分殿（入口 V1.0）</div>
    <div class="hint" style="margin-top:6px;">
      目前先做入口與席位規格。合約掛載（各分殿 Faucet/Bank）等你部署後再填入地址。
    </div>
    <div class="grid" style="margin-top:10px;" id="zodiacGrid"></div>
    <div id="zodiacInfo" class="dash"></div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
      <div style="font-weight:900;">錢包狀態（BSC 主網）</div>
      <div class="row">
        <button id="btnConnect" class="btn">連線錢包</button>
        <button id="btnSpeak" class="btn">語音客服</button>
        <button id="btnStopSpeak" class="btn">停止</button>
      </div>
    </div>

    <div style="margin-top:10px;border:1px solid #111;border-radius:16px;padding:12px;background:#fafafa;">
      <div style="font-weight:900;">即時文字（AI 說話字幕）</div>
      <div id="aiCaption" class="dash"></div>

      <div style="margin-top:10px;font-weight:900;">即時文字（你的麥克風轉文字）</div>
      <div id="userTranscript" class="dash"></div>

      <div class="row" style="margin-top:10px;">
        <button id="btnMic" class="btn">開始說話</button>
        <button id="btnStopMic" class="btn">停止聽你</button>
        <button id="btnAutoStart" class="btn">一鍵啟動（語音＋字幕）</button>
      </div>

      <div class="hint" style="margin-top:8px;">
        第一次請按「一鍵啟動」或任意按鍵，避免瀏覽器禁止自動播報。
      </div>
    </div>

    <div id="walletInfo" style="margin-top:10px;line-height:1.9;"></div>

    <div style="margin-top:10px;padding:10px;border:1px dashed #111;border-radius:12px;background:#fafafa;line-height:1.8;">
      <div style="font-weight:900;">鏈上驗證（BscScan / PancakeSwap / PinkLock）</div>

      <div style="margin-top:6px;">
        KGEN Token：
        <a id="linkToken" class="addr" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;"></a>
      </div>

      <div style="margin-top:4px;">
        PancakeSwap：
        <a id="linkSwap" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;">KGEN / WBNB</a>
      </div>

      <div style="margin-top:4px;">
        LP Pair：
        <a id="linkLP" class="addr" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;"></a>
      </div>

      <div style="margin-top:4px;">
        PinkLock：
        <a id="linkPink" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;">查看鎖倉</a>
      </div>

      <div id="envHint" class="hint" style="margin-top:8px;"></div>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div style="font-weight:900;">參拜紀錄（本機 localStorage）</div>
    <div class="row" style="margin-top:10px;">
      <button id="btnVisit" class="btn">登入參拜</button>
      <button id="btnExit" class="btn">登出離開</button>
      <button id="btnExport" class="btn">匯出 JSON</button>
      <button id="btnClear" class="btn">清除紀錄</button>
    </div>
    <div id="localInfo" style="margin-top:10px;line-height:1.9;"></div>

    <div style="margin-top:10px;border-top:1px solid #111;padding-top:10px;">
      <div style="font-weight:900;">來訪統計（CountAPI / fallback）</div>
      <div class="row" style="margin-top:8px;">
        <button id="btnRefreshStats" class="btn">更新統計</button>
        <button id="btnReHit" class="btn">再呼吸一次（測試 hit）</button>
      </div>
      <div id="visitorInfo" style="margin-top:10px;line-height:1.9;"></div>
      <div id="visitorHint" class="hint" style="margin-top:6px;"></div>
    </div>
  </div>

  <div style="margin-top:14px;padding-top:12px;border-top:1px solid #111;line-height:1.8;">
    PrimeForge 以母機之名，開啟金融生命。<br/>
    花果山台灣・信念不滅・市場無界。<br/>
    Where the Market Becomes the Myth.<br/>
    —— 樂天帝 ⌖
  </div>
</div>

<div id="dbgPanel">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
    <div style="font-weight:900">Wukong Debug</div>
    <div class="row" style="gap:8px;">
      <button id="dbgCopy">Copy</button>
      <button id="dbgDownload">Download</button>
      <button id="dbgClose">Close</button>
    </div>
  </div>
  <pre id="dbgLog"></pre>
</div>

<script>
/* ========= CONFIG：先把這裡填好 ========= */
const CONFIG = {
  VERSION: "v2.7.0-zodiac-v1",
  BUILD: new Date().toISOString(),

  CHAIN_ID_DEC: 56,

  KGEN_TOKEN: "0xBA3d3810e58735cb6813bC1CDc5458C0d71432Be",
  KGEN_DECIMALS: 18,

  LP_PAIR: "0xf36640d7327b53ba3d7fcc1d98dfc1b85574b6c2",
  PINKLOCK_URL: "https://www.pinksale.finance/pinklock/bsc/record/1427003",

  // 目前未啟用就留空字串
  FAUCET_CONTRACT: "",
  BANK_CONTRACT: ""
};
</script>

<!-- ethers：優先載入本地（同資料夾放 ethers-5.7.2.umd.min.js），沒有就走 CDN -->
<script>
(function loadEthers(){
  const local = document.createElement("script");
  local.src = "./ethers-5.7.2.umd.min.js";
  local.onload = () => window.__ethersReady = true;
  local.onerror = () => {
    const cdn = document.createElement("script");
    cdn.src = "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js";
    cdn.onload = () => window.__ethersReady = true;
    document.head.appendChild(cdn);
  };
  document.head.appendChild(local);
})();
</script>

<script>
(() => {
  "use strict";
  const $ = (id) => document.getElementById(id);

  $("verText").textContent = CONFIG.VERSION;
  $("buildText").textContent = CONFIG.BUILD;

  const dbg = {
    lines: [],
    log: (msg) => {
      const ts = new Date().toISOString();
      dbg.lines.push(`[${ts}] ${msg}`);
      if (dbg.lines.length > 800) dbg.lines = dbg.lines.slice(-800);
      $("dbgLog").textContent = dbg.lines.join("\n");
    },
    show: () => $("dbgPanel").style.display = "block",
    hide: () => $("dbgPanel").style.display = "none"
  };

  window.addEventListener("error", (ev) => {
    dbg.log("ERROR: " + (ev.message || "unknown") + " @" + (ev.filename || "") + ":" + (ev.lineno || ""));
  });
  window.addEventListener("unhandledrejection", (ev) => {
    const r = ev && ev.reason ? (ev.reason.message || String(ev.reason)) : "Unknown rejection";
    dbg.log("PROMISE_REJECT: " + r);
  });

  $("btnToggleDebug").addEventListener("click", () => {
    const show = $("dbgPanel").style.display !== "block";
    if (show) dbg.show(); else dbg.hide();
  });
  $("dbgClose").addEventListener("click", () => dbg.hide());
  $("dbgCopy").addEventListener("click", async () => {
    try { await navigator.clipboard.writeText($("dbgLog").textContent || ""); } catch {}
  });
  $("dbgDownload").addEventListener("click", () => {
    const txt = $("dbgLog").textContent || "";
    const blob = new Blob([txt], {type:"text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "wukong_debug_" + new Date().toISOString().replace(/[:.]/g,"-") + ".txt";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1200);
  });

  const toast = (msg) => {
    const el = document.createElement("div");
    el.textContent = msg;
    el.style.cssText = "position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:999px;font-weight:900;z-index:99999;max-width:92vw;text-align:center;";
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 1600);
  };

  const safeParse = (s) => { try { return JSON.parse(s); } catch { return null; } };
  const nowISO = () => new Date().toISOString();
  const fmtAddr = (a) => a ? (a.slice(0, 6) + "…" + a.slice(-4)) : "";
  const fmt = (n) => { try { return new Intl.NumberFormat("en-US", { maximumFractionDigits: 4 }).format(n); } catch { return String(n); } };

  /* ====== 12 生肖入口 V1.0 ====== */
  const ZODIAC = [
    { key:"rat",  zh:"鼠", name:"探路殿", desc:"訊號先行，先看再動" },
    { key:"ox",   zh:"牛", name:"守樞殿", desc:"守位耐心，先立樁" },
    { key:"tiger",zh:"虎", name:"破關殿", desc:"破關確認，才給加速" },
    { key:"rabbit",zh:"兔",name:"回撤殿", desc:"拉回承接，不追價" },
    { key:"dragon",zh:"龍",name:"天命殿", desc:"大週期切換觀測" },
    { key:"snake",zh:"蛇", name:"釣魚殿", desc:"盤整假突破辨識" },
    { key:"horse",zh:"馬", name:"衝鋒殿", desc:"趨勢加速與節奏" },
    { key:"goat", zh:"羊", name:"修補殿", desc:"回補與風控修補" },
    { key:"monkey",zh:"猴",name:"悟空主殿",desc:"造盤節奏核心" },
    { key:"rooster",zh:"雞",name:"報曉殿",desc:"開盤訊號與晨鐘" },
    { key:"dog",  zh:"狗", name:"守門殿", desc:"停損紀律，守門不破" },
    { key:"pig",  zh:"豬", name:"伏筆殿", desc:"潛伏警示，請勿模仿" }
  ];

  const zodiacGrid = $("zodiacGrid");
  const zodiacInfo = $("zodiacInfo");
  const renderZodiacInfo = (z) => {
    zodiacInfo.textContent =
      `你選擇：${z.zh}｜${z.name}\n` +
      `說明：${z.desc}\n` +
      `狀態：入口啟用；合約掛載待部署\n` +
      `席位：預留 72（V1.0 資料結構）`;
  };

  ZODIAC.forEach(z => {
    const b = document.createElement("button");
    b.className = "zbtn";
    b.textContent = `${z.zh} ${z.name}`;
    b.addEventListener("click", () => {
      renderZodiacInfo(z);
      dbg.log("zodiac_select=" + z.key);
    });
    zodiacGrid.appendChild(b);
  });
  renderZodiacInfo(ZODIAC[8]);

  /* ====== localStorage state ====== */
  const KEY = "klineodyssey_wukongTemple_state_v0_7";
  const load = () => {
    const s = safeParse(localStorage.getItem(KEY) || "");
    const base = { visitCount:0, exitCount:0, divinationStreak:0, vitals:{heartbeat:0, breath:0, pressure:0}, logs:[] };
    return Object.assign(base, s || {});
  };
  const save = (s) => localStorage.setItem(KEY, JSON.stringify(s));
  const pushLog = (s, type, data) => {
    s.logs = s.logs || [];
    s.logs.push({ t: nowISO(), type, data: data || {} });
    if (s.logs.length > 400) s.logs = s.logs.slice(-400);
  };

  const renderLocal = () => {
    const s = load();
    $("localInfo").innerHTML =
      "<div>參拜次數：<strong>" + s.visitCount + "</strong></div>" +
      "<div>離開次數：<strong>" + s.exitCount + "</strong></div>" +
      "<div>聖筊連勝：<strong>" + s.divinationStreak + "</strong></div>";
    $("btnFortune").disabled = (s.divinationStreak || 0) < 3;
  };

  const renderVitals = () => {
    const s = load();
    $("vitalsInfo").innerHTML =
      "<div>心跳次數：<strong>" + (s.vitals.heartbeat || 0) + "</strong></div>" +
      "<div>呼吸次數：<strong>" + (s.vitals.breath || 0) + "</strong></div>" +
      "<div>血壓次數：<strong>" + (s.vitals.pressure || 0) + "</strong></div>" +
      "<div style='margin-top:8px;'>聖筊連勝：<strong>" + (s.divinationStreak || 0) + "</strong></div>";
  };

  const doHeartbeat = () => { const s=load(); s.vitals.heartbeat=(s.vitals.heartbeat||0)+1; pushLog(s,"heartbeat",{n:s.vitals.heartbeat}); save(s); renderVitals(); };
  const doBreath   = () => { const s=load(); s.vitals.breath=(s.vitals.breath||0)+1; pushLog(s,"breath",{n:s.vitals.breath}); save(s); renderVitals(); };
  const doPressure = () => { const s=load(); s.vitals.pressure=(s.vitals.pressure||0)+1; pushLog(s,"pressure",{n:s.vitals.pressure}); save(s); renderVitals(); };

  $("btnHeartbeat").addEventListener("click", () => { doHeartbeat(); toast("心跳已記錄"); dbg.log("heartbeat_click"); });
  $("btnBreath").addEventListener("click", () => { doBreath(); toast("呼吸已記錄"); dbg.log("breath_click"); });
  $("btnPressure").addEventListener("click", () => { doPressure(); toast("血壓已記錄"); dbg.log("pressure_click"); });

  $("btnDivination").addEventListener("click", () => {
    const s = load();
    const ok = Math.random() < 0.5;
    if (ok) { s.divinationStreak = (s.divinationStreak || 0) + 1; pushLog(s,"divination_yes",{streak:s.divinationStreak}); toast("聖筊"); }
    else { s.divinationStreak = 0; pushLog(s,"divination_no",{}); toast("陰筊"); }
    save(s);
    renderVitals();
    renderLocal();
    dbg.log("divination_" + (ok ? "yes" : "no") + "_streak=" + (load().divinationStreak || 0));
  });

  $("btnFortune").addEventListener("click", () => {
    const s = load();
    if ((s.divinationStreak || 0) < 3) { toast("聖筊連勝未達 3"); dbg.log("fortune_block_streak"); return; }
    if (!CONFIG.FAUCET_CONTRACT) { toast("發財金尚未啟用（合約未接）"); dbg.log("fortune_block_no_contract"); return; }
    toast("發財金合約已接，但此版尚未實作領取交易");
    dbg.log("fortune_stub");
  });

  $("btnVisit").addEventListener("click", () => { const s=load(); s.visitCount += 1; pushLog(s,"visit",{}); save(s); renderLocal(); toast("已記錄參拜"); dbg.log("visit"); });
  $("btnExit").addEventListener("click", () => { const s=load(); s.exitCount += 1; pushLog(s,"exit",{}); save(s); renderLocal(); toast("已記錄離開"); dbg.log("exit"); });

  const downloadJSON = (obj, filename) => {
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1200);
  };

  $("btnExport").addEventListener("click", () => { downloadJSON(load(), "wukong_temple_log_" + nowISO().replace(/[:.]/g,"-") + ".json"); toast("已匯出 JSON"); dbg.log("export_json"); });
  $("btnClear").addEventListener("click", () => {
    if (!confirm("確定清除本機紀錄？")) return;
    localStorage.removeItem(KEY);
    renderLocal(); renderVitals();
    toast("已清除");
    dbg.log("clear_state");
  });

  /* ====== CountAPI visitors (with fallback) ====== */
  const COUNT_NS = "klineodyssey-wukong-temple";
  const dayKey = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return "day_" + yyyy + mm + dd;
  };

  const countapi = {
    _timeout: (ms) => new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")), ms)),
    _lsKey: (key) => "wukong_count_" + key,
    _lsHit: (key) => {
      const k = countapi._lsKey(key);
      const v = Number(localStorage.getItem(k) || "0") + 1;
      localStorage.setItem(k, String(v));
      return { value: v, _fallback: "localStorage" };
    },
    _lsGet: (key) => {
      const k = countapi._lsKey(key);
      const v = Number(localStorage.getItem(k) || "0");
      return { value: v, _fallback: "localStorage" };
    },
    hit: async (key) => {
      const url = "https://api.countapi.xyz/hit/" + encodeURIComponent(COUNT_NS) + "/" + encodeURIComponent(key);
      try {
        const r = await Promise.race([fetch(url, { cache: "no-store" }), countapi._timeout(4500)]);
        if (!r.ok) throw new Error("countapi_hit_failed_" + r.status);
        const ct = (r.headers.get("content-type") || "").toLowerCase();
        if (!ct.includes("application/json")) throw new Error("countapi_hit_bad_content_type");
        return await r.json();
      } catch {
        return countapi._lsHit(key);
      }
    },
    get: async (key) => {
      const url = "https://api.countapi.xyz/get/" + encodeURIComponent(COUNT_NS) + "/" + encodeURIComponent(key);
      try {
        const r = await Promise.race([fetch(url, { cache: "no-store" }), countapi._timeout(4500)]);
        if (!r.ok) throw new Error("countapi_get_failed_" + r.status);
        const ct = (r.headers.get("content-type") || "").toLowerCase();
        if (!ct.includes("application/json")) throw new Error("countapi_get_bad_content_type");
        return await r.json();
      } catch {
        return countapi._lsGet(key);
      }
    }
  };

  const renderVisitors = (todayVal, totalVal, note) => {
    $("visitorInfo").innerHTML =
      "<div>今日來訪：<strong>" + todayVal + "</strong></div>" +
      "<div>總來訪：<strong>" + totalVal + "</strong></div>";
    $("visitorHint").textContent = note || "";
  };

  const refreshVisitors = async (doHit) => {
    try {
      const dk = dayKey();
      let todayVal = 0, totalVal = 0;
      if (doHit) {
        const t1 = await countapi.hit(dk);
        const t2 = await countapi.hit("total");
        todayVal = t1.value || 0;
        totalVal = t2.value || 0;
      } else {
        const g1 = await countapi.get(dk);
        const g2 = await countapi.get("total");
        todayVal = g1.value || 0;
        totalVal = g2.value || 0;
      }
      renderVisitors(todayVal, totalVal, "CountAPI 後端統計；若被阻擋則改用本機統計");
    } catch {
      renderVisitors(0, 0, "統計讀取失敗");
    }
  };

  $("btnRefreshStats").addEventListener("click", async () => { await refreshVisitors(false); toast("已更新統計"); dbg.log("stats_refresh"); });
  $("btnReHit").addEventListener("click", async () => { await refreshVisitors(true); toast("已再呼吸一次"); dbg.log("stats_hit"); });

  /* ====== Web3 + links ====== */
  const mkBscAddr  = (addr) => "https://bscscan.com/address/" + addr;
  const mkBscToken = (addr) => "https://bscscan.com/token/" + addr;

  $("linkToken").textContent = CONFIG.KGEN_TOKEN;
  $("linkToken").href = mkBscToken(CONFIG.KGEN_TOKEN);
  $("linkSwap").href  = "https://pancakeswap.finance/swap?outputCurrency=" + CONFIG.KGEN_TOKEN;
  $("linkLP").textContent = CONFIG.LP_PAIR;
  $("linkLP").href = mkBscAddr(CONFIG.LP_PAIR);
  $("linkPink").href = CONFIG.PINKLOCK_URL;

  const renderEnv = () => {
    const env = [];
    env.push("Version: " + CONFIG.VERSION);
    env.push("BSC ChainId: " + CONFIG.CHAIN_ID_DEC);
    env.push("Web3: " + (window.ethereum ? "OK" : "NO"));
    env.push("Ethers: " + ((typeof window.ethers !== "undefined") ? "OK" : "MISSING"));
    env.push("Faucet: " + (CONFIG.FAUCET_CONTRACT || "NOT_SET"));
    env.push("Bank: " + (CONFIG.BANK_CONTRACT || "NOT_SET"));
    $("envHint").textContent = env.join(" | ");
  };

  let provider = null, signer = null, userAddr = null;

  const ensureChain = async () => {
    const hex = "0x" + CONFIG.CHAIN_ID_DEC.toString(16);
    const curr = await window.ethereum.request({ method: "eth_chainId" });
    if (curr === hex) return;
    await window.ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: hex }] });
  };

  const renderWallet = async () => {
    const lines = [];
    if (!window.ethereum) {
      lines.push("<div>錢包：<strong>未偵測到</strong></div>");
      $("walletInfo").innerHTML = lines.join("");
      return;
    }
    if (!provider || !signer) {
      lines.push("<div>錢包：<strong>尚未連線</strong></div>");
      $("walletInfo").innerHTML = lines.join("");
      return;
    }
    lines.push("<div>錢包：<strong>" + fmtAddr(userAddr) + "</strong></div>");

    try {
      if (typeof window.ethers === "undefined") throw new Error("ethers_missing");
      const erc20Abi = ["function balanceOf(address) view returns (uint256)"];
      const kgen = new window.ethers.Contract(CONFIG.KGEN_TOKEN, erc20Abi, provider);
      const bal = await kgen.balanceOf(userAddr);
      const human = Number(window.ethers.utils.formatUnits(bal, CONFIG.KGEN_DECIMALS));
      lines.push("<div>KGEN 餘額：<strong>" + fmt(human) + "</strong></div>");
    } catch (e) {
      lines.push("<div class='hint'>餘額讀取失敗：請確認 ethers 有載入，並在 BSC 主網。</div>");
      dbg.log("renderWallet_fail: " + (e && e.message ? e.message : String(e)));
    }

    $("walletInfo").innerHTML = lines.join("");
  };

  $("btnConnect").addEventListener("click", async () => {
    try {
      if (!window.ethereum) { toast("找不到錢包"); dbg.log("connect_no_wallet"); return; }
      await ensureChain();
      if (typeof window.ethers === "undefined") { toast("ethers 尚未載入"); dbg.log("ethers_missing_on_connect"); return; }
      provider = new window.ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      userAddr = await signer.getAddress();
      toast("錢包已連線（BSC 主網）");
      dbg.log("wallet_connected=" + userAddr);
      await renderWallet();
    } catch (e) {
      toast("連線失敗或未授權");
      dbg.log("wallet_connect_fail: " + (e && e.message ? e.message : String(e)));
    }
  });

  /* ====== Voice (browser TTS + STT) ====== */
  const setAICaption = (t) => $("aiCaption").textContent = t || "";
  const setUserTranscript = (t) => $("userTranscript").textContent = t || "";

  const speakText = (text) => {
    try {
      if (!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "zh-TW";
      u.rate = 1.0;
      setAICaption("");
      u.onend = () => setAICaption(text);
      window.speechSynthesis.speak(u);
    } catch (e) {
      dbg.log("speakText_fail: " + (e && e.message ? e.message : String(e)));
    }
  };
  const stopSpeak = () => { try { window.speechSynthesis.cancel(); } catch {} };

  const startAssistant = () => {
    const s = load();
    const streak = s.divinationStreak || 0;
    const all =
      "歡迎來到五指山悟空財神殿。這裡是互動式遊戲入口，不是投資平台。" +
      "你目前聖筊連勝是 " + streak + " 次。" +
      "本殿以合約心臟跳動：Faucet心臟負責發財金與心跳事件；無人銀行負責五千K G E N入住與席位登記；黑洞負責燒幣質能轉換。" +
      "每日零點到零點十分是宇宙轉日窗口。每小時會有一次心跳事件。";
    speakText(all);
    toast("語音客服啟動");
    dbg.log("assistant_start");
  };

  $("btnSpeak").addEventListener("click", startAssistant);
  $("btnAutoStart").addEventListener("click", startAssistant);
  $("btnStopSpeak").addEventListener("click", () => { stopSpeak(); toast("已停止語音"); dbg.log("tts_stop"); });

  $("btnGuide").addEventListener("click", () => {
    const t =
      "你現在在悟空財神殿。這裡是互動式遊戲入口，不是投資平台。" +
      "先按連線錢包並切到BSC主網。擲筊連勝三次才會開啟領取。12生肖分殿目前是入口版，合約掛載等待部署。";
    speakText(t);
    setAICaption(t);
    dbg.log("guide_play");
  });

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null;

  const startMic = () => {
    if (!SR) {
      setUserTranscript("此瀏覽器不支援麥克風轉文字（建議用 Chrome / Edge）。");
      toast("不支援麥克風轉文字");
      dbg.log("stt_not_supported");
      return;
    }
    rec = new SR();
    rec.lang = "zh-TW";
    rec.interimResults = true;
    rec.continuous = true;
    let finalText = "";
    setUserTranscript("");
    rec.onresult = (ev) => {
      let interim = "";
      for (let i = ev.resultIndex; i < ev.results.length; i++) {
        const res = ev.results[i];
        const t = (res[0] && res[0].transcript) ? res[0].transcript : "";
        if (res.isFinal) finalText += t;
        else interim += t;
      }
      setUserTranscript((finalText + interim).trim());
    };
    rec.onerror = (e) => {
      toast("麥克風錯誤或未授權");
      dbg.log("stt_error: " + (e && e.error ? e.error : "unknown"));
    };
    try { rec.start(); toast("開始聽你"); dbg.log("stt_start"); } catch { toast("無法啟動麥克風"); }
  };
  const stopMic = () => { try { rec && rec.stop(); } catch {} rec = null; toast("已停止聽你"); dbg.log("stt_stop"); };

  $("btnMic").addEventListener("click", startMic);
  $("btnStopMic").addEventListener("click", stopMic);

  /* ====== SelfCheck ====== */
  $("btnSelfCheck").addEventListener("click", () => {
    dbg.log("selfcheck_start");
    dbg.log("userAgent: " + (navigator.userAgent || ""));
    dbg.log("speechSynthesis: " + ("speechSynthesis" in window));
    dbg.log("speechRecognition: " + (!!SR));
    dbg.log("ethers_loaded: " + (typeof window.ethers !== "undefined"));
    dbg.log("ethereum_injected: " + (typeof window.ethereum !== "undefined"));
    toast("SelfCheck 已寫入 Debug");
    dbg.show();
  });

  /* ====== Boot ====== */
  setInterval(doHeartbeat, 60 * 60 * 1000);

  (async () => {
    dbg.log("boot_version=" + CONFIG.VERSION);
    renderEnv();
    await refreshVisitors(true);
    renderLocal();
    renderVitals();
    await renderWallet();
  })();
})();
</script>

</body>
</html>
